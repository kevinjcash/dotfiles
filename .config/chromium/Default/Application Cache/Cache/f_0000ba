/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
var goog=goog||{};goog.userAgent=goog.userAgent||{};goog.global=this;goog.string=goog.string||{};goog.string.contains=function(a,e){return a.indexOf(e)!==-1};goog.userAgent.ASSUME_IE=!1;goog.userAgent.ASSUME_GECKO=!1;goog.userAgent.ASSUME_WEBKIT=!1;goog.userAgent.ASSUME_MOBILE_WEBKIT=!1;goog.userAgent.ASSUME_OPERA=!1;goog.userAgent.BROWSER_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_GECKO||goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_OPERA;
goog.userAgent.getUserAgentString=function(){return goog.global.navigator?goog.global.navigator.userAgent:null};goog.userAgent.getNavigator=function(){return goog.global.navigator};
goog.userAgent.init_=function(){goog.userAgent.detectedOpera_=!1;goog.userAgent.detectedIe_=!1;goog.userAgent.detectedWebkit_=!1;goog.userAgent.detectedMobile_=!1;goog.userAgent.detectedGecko_=!1;var a;if(!goog.userAgent.BROWSER_KNOWN_&&(a=goog.userAgent.getUserAgentString())){var e=goog.userAgent.getNavigator();if(a.indexOf("Opera")===0)goog.userAgent.detectedOpera_=!0,goog.userAgent.ENGINE="Opera";if(!goog.userAgent.detectedOpera_&&a.indexOf("MSIE")!==-1)goog.userAgent.detectedIe_=!0,goog.userAgent.ENGINE=
"IE";if(!goog.userAgent.detectedOpera_&&a.indexOf("WebKit")!==-1)goog.userAgent.detectedWebkit_=!0,goog.userAgent.ENGINE="WebKit";if(goog.userAgent.detectedWebkit_&&a.indexOf("Mobile")!==-1)goog.userAgent.detectedMobile_=!0;if(!goog.userAgent.detectedOpera_&&!goog.userAgent.detectedWebkit_&&e.product==="Gecko")goog.userAgent.detectedGecko_=!0,goog.userAgent.ENGINE="Gecko"}};goog.userAgent.BROWSER_KNOWN_||goog.userAgent.init_();
goog.userAgent.OPERA=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_OPERA:goog.userAgent.detectedOpera_;goog.userAgent.IE=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_IE:goog.userAgent.detectedIe_;goog.userAgent.GECKO=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_GECKO:goog.userAgent.detectedGecko_;goog.userAgent.WEBKIT=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_MOBILE_WEBKIT:goog.userAgent.detectedWebkit_;
goog.userAgent.MOBILE=goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.detectedMobile_;goog.userAgent.SAFARI=goog.userAgent.WEBKIT;goog.userAgent.determinePlatform_=function(){var a=goog.userAgent.getNavigator();return a&&a.platform||""};goog.userAgent.PLATFORM=goog.userAgent.determinePlatform_();goog.userAgent.ASSUME_MAC=!1;goog.userAgent.ASSUME_WINDOWS=!1;goog.userAgent.ASSUME_LINUX=!1;goog.userAgent.ASSUME_X11=!1;
goog.userAgent.PLATFORM_KNOWN_=goog.userAgent.ASSUME_MAC||goog.userAgent.ASSUME_WINDOWS||goog.userAgent.ASSUME_LINUX||goog.userAgent.ASSUME_X11;
goog.userAgent.initPlatform_=function(){goog.userAgent.OS="";if(goog.string.contains(goog.userAgent.PLATFORM,"Mac"))goog.userAgent.detectedMac_=!0,goog.userAgent.OS="Mac";if(goog.string.contains(goog.userAgent.PLATFORM,"Win"))goog.userAgent.detectedWindows_=!0,goog.userAgent.OS="Windows";if(goog.string.contains(goog.userAgent.PLATFORM,"Linux"))goog.userAgent.detectedLinux_=!0,goog.userAgent.OS="Linux";if(goog.userAgent.getNavigator()&&goog.string.contains(goog.userAgent.getNavigator().appVersion||
"","X11"))goog.userAgent.detectedX11_=!0,goog.userAgent.OS="X11"};goog.userAgent.PLATFORM_KNOWN_||goog.userAgent.initPlatform_();goog.userAgent.MAC=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_MAC:goog.userAgent.detectedMac_;goog.userAgent.WINDOWS=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_WINDOWS:goog.userAgent.detectedWindows_;goog.userAgent.LINUX=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_LINUX:goog.userAgent.detectedLinux_;
goog.userAgent.X11=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_X11:goog.userAgent.detectedX11_;
goog.userAgent.determineVersion_=function(){var a="",e;goog.userAgent.OPERA&&goog.global.opera?(a=goog.global.opera.version,a=typeof a==="function"?a():a):(goog.userAgent.GECKO?e=/rv\:([^\);]+)(\)|;)/:goog.userAgent.IE?e=/MSIE\s+([^\);]+)(\)|;)/:goog.userAgent.WEBKIT&&(e=/WebKit\/(\S+)/),e&&(a=(a=e.exec(goog.userAgent.getUserAgentString()))?a[1]:""));return goog.userAgent.IE&&(e=goog.userAgent.getDocumentMode_(),e>parseFloat(a))?String(e):a};
goog.userAgent.getDocumentMode_=function(){var a=goog.global.document;return a?a.documentMode:void 0};goog.userAgent.VERSION=goog.userAgent.determineVersion_();goog.userAgent.isDocumentModeCache_={};goog.userAgent.isDocumentMode=function(a){return goog.userAgent.isDocumentModeCache_[a]||(goog.userAgent.isDocumentModeCache_[a]=goog.userAgent.IE&&document.documentMode&&document.documentMode>=a)};goog.userAgent.product=goog.userAgent.product||{};goog.userAgent.product.ASSUME_FIREFOX=!1;
goog.userAgent.product.ASSUME_CAMINO=!1;goog.userAgent.product.ASSUME_IPHONE=!1;goog.userAgent.product.ASSUME_IPAD=!1;goog.userAgent.product.ASSUME_ANDROID=!1;goog.userAgent.product.ASSUME_CHROME=!1;goog.userAgent.product.ASSUME_SAFARI=!1;
goog.userAgent.product.PRODUCT_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_OPERA||goog.userAgent.product.ASSUME_FIREFOX||goog.userAgent.product.ASSUME_CAMINO||goog.userAgent.product.ASSUME_IPHONE||goog.userAgent.product.ASSUME_IPAD||goog.userAgent.product.ASSUME_ANDROID||goog.userAgent.product.ASSUME_CHROME||goog.userAgent.product.ASSUME_SAFARI;
goog.userAgent.product.init_=function(){goog.userAgent.product.BROWSER_NAME="";goog.userAgent.product.detectedFirefox_=!1;goog.userAgent.product.detectedCamino_=!1;goog.userAgent.product.detectedIphone_=!1;goog.userAgent.product.detectedIpad_=!1;goog.userAgent.product.detectedAndroid_=!1;goog.userAgent.product.detectedChrome_=!1;goog.userAgent.product.detectedSafari_=!1;var a=goog.userAgent.getUserAgentString();if(a)if(a.indexOf("iPhone")!==-1||a.indexOf("iPod")!==-1)goog.userAgent.product.detectedIphone_=
!0,goog.userAgent.product.BROWSER_NAME="iPhone";else if(a.indexOf("iPad")!==-1)goog.userAgent.product.detectedIpad_=!0,goog.userAgent.product.BROWSER_NAME="iPad";else if(a.indexOf("Android")!==-1)goog.userAgent.product.detectedAndroid_=!0,goog.userAgent.product.BROWSER_NAME="Android";else if(a.indexOf("Chrome")!==-1)goog.userAgent.product.detectedChrome_=!0,goog.userAgent.product.BROWSER_NAME="Chrome";else if(a.indexOf("Safari")!==-1)goog.userAgent.product.detectedSafari_=!0,goog.userAgent.product.BROWSER_NAME=
"Safari";else if(a.indexOf("MSIE")!==-1)goog.userAgent.product.detectedIe_=!0,goog.userAgent.product.BROWSER_NAME="IE";else if(a.indexOf("Camino")!==-1)goog.userAgent.product.detectedCamino_=!0,goog.userAgent.product.BROWSER_NAME="Camino";else if(a.indexOf("Firefox")!==-1)goog.userAgent.product.detectedFirefox_=!0,goog.userAgent.product.BROWSER_NAME="Firefox"};goog.userAgent.product.PRODUCT_KNOWN_||goog.userAgent.product.init_();goog.userAgent.product.OPERA=goog.userAgent.OPERA;
goog.userAgent.product.IE=goog.userAgent.IE;goog.userAgent.product.FIREFOX=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_FIREFOX:goog.userAgent.product.detectedFirefox_;goog.userAgent.product.CAMINO=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CAMINO:goog.userAgent.product.detectedCamino_;goog.userAgent.product.IPHONE=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPHONE:goog.userAgent.product.detectedIphone_;
goog.userAgent.product.IPAD=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPAD:goog.userAgent.product.detectedIpad_;goog.userAgent.product.ANDROID=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_ANDROID:goog.userAgent.product.detectedAndroid_;goog.userAgent.product.CHROME=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CHROME:goog.userAgent.product.detectedChrome_;
goog.userAgent.product.SAFARI=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_SAFARI:goog.userAgent.product.detectedSafari_;goog.userAgent.platform=goog.userAgent.platform||{};goog.userAgent.platform.determineVersion_=function(){var a;if(goog.userAgent.WINDOWS)return a=/Windows NT ([0-9.]+)/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[1]:"0";else if(goog.userAgent.MAC)return a=/10[_.][0-9_.]+/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[0].replace(/_/g,"."):"10";return""};
goog.userAgent.platform.VERSION=goog.userAgent.platform.determineVersion_();
goog.userAgent.product.determineVersion_=function(){var a="",e,d;if(goog.userAgent.product.FIREFOX)e=/Firefox\/([0-9.]+)/;else if(goog.userAgent.product.IE||goog.userAgent.product.OPERA)return goog.userAgent.VERSION;else goog.userAgent.product.CHROME?e=/Chrome\/([0-9.]+)/:goog.userAgent.product.SAFARI?e=/Version\/([0-9.]+)/:goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD?(e=/Version\/(\S+).*Mobile\/(\S+)/,d=!0):goog.userAgent.product.ANDROID?e=/Android\s+([0-9.]+)(?:.*Version\/([0-9.]+))?/:
goog.userAgent.product.CAMINO&&(e=/Camino\/([0-9.]+)/);e&&(a=(a=e.exec(goog.userAgent.getUserAgentString()))?d?a[1]+"."+a[2]:a[2]||a[1]:"");return a};goog.userAgent.product.VERSION=goog.userAgent.product.determineVersion_();var GoogleUserAgent=function(){return{browserName:goog.userAgent.product.BROWSER_NAME,osName:goog.userAgent.OS,engineName:goog.userAgent.ENGINE,browserVersionString:goog.userAgent.product.VERSION,engineVersionString:goog.userAgent.VERSION,isMobile:goog.userAgent.MOBILE}}();
function AppCacheEventProvider(a){function e(){g=!1;j=-1;q.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(q.resolve,q.reject)}function d(a,d,f){function j(){o.callEventListeners(a,d)}q.then(j,j);f&&(g=!0,q=jQuery.Deferred())}function l(a){g&&e();d("checking",a,!1)}function f(a){g&&e();j+=1;if(a.total!==void 0&&a.loaded!==void 0)q.resolve(a.total+1),o.callEventListeners("progress",a);else{var d=function(){a.loaded=j;return function(d){a.total=d===-1?-1:d-1;o.callEventListeners("progress",
a)}}();q.then(d,d)}}var o=ListenerManager(),j=-1,g=!0,q;q=jQuery.Deferred();(function(){typeof a.addEventListener==="function"&&(a.addEventListener("error",function(a){d("error",a,!0)}),a.addEventListener("cached",function(a){d("cached",a,!0)}),a.addEventListener("noupdate",function(a){d("noupdate",a,!0)}),a.addEventListener("updateready",function(a){d("updateready",a,!0)}),a.addEventListener("downloading",function(a){d("downloading",a,!1)}),a.addEventListener("checking",l,!1),a.addEventListener("progress",
f,!1))})();var p={status:0,abort:a.abort,update:a.update,swapCache:a.swapCache,addEventListener:o.addEventListener,removeEventListener:o.removeEventListener};$.extend(p,CreateAppCacheConstants());return p}function CreateAppCacheConstants(){var a={};["CHECKING","DOWNLOADING","IDLE","OBSOLETE","UNCACHED","UPDATEREADY"].forEach(function(e){a[e]=window.applicationCache[e]});return a}
var KindleAppCacheEventHandler=function(){function a(){s={timer:_metricsManager.createTimer(),loaded:0,total:0}}function e(){a()}function d(){KindleHostDeviceDetector.isNetworkAvailableSync()?(w.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserFailed",{breakdown:["Browser"]}):v.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RetryFailed",{breakdown:["Browser"]}):s.timer.emit("KindleApp:AppCacheError:FirstTime",{breakdown:["Browser"]}),s.timer.emit("KindleApp:AppCacheError",
{submetrics:[{name:"progress",value:s.total}],breakdown:["Browser"]}),KindleHostDeviceDetector.isiOS_4x()&&s.loaded===s.total&&v.getValue()>=1?(g(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),w.increment(),_metricsManager.emit("KindleApp:AppCacheError:SafariRebootPrompt",{breakdown:["Browser"]})):(g(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),v.increment(),_metricsManager.emit("KindleApp:AppCacheError:RetryPrompt",{breakdown:["Browser"]})),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&
t==="CHECKING"&&window.localStorage.getItem("cached")&&(_metricsManager.emit("KindleApp:AppCacheError:OnlineInstafail",{breakdown:["Browser"]}),window.localStorage.setItem("cached",0),KindleHostDeviceDetector.isiOSAppMode()&&(_metricsManager.emit("KindleApp::iOSAppModeAppCacheFix"),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register())),t=""):g(Kindle.APP_CACHE.CACHE_DONE)}function l(c){s===null&&a();g(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:c.total?c.loaded+1/
c.total+1:0});t="";s.loaded=c.loaded+1;s.total=c.total+1}function f(){w.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserSucess",{breakdown:["Browser"]}):v.getValue()>0&&_metricsManager.emit("KindleApp:AppCacheError:RetrySucess",{breakdown:["Browser"]});v.reset();w.reset()}function o(){t="";g(Kindle.APP_CACHE.CACHE_DONE);f();s.timer.emit("KindleApp:AppCacheUpdate",{submetrics:[{name:"progress",value:s.loaded}],breakdown:["Browser"]})}function j(){t="";g(Kindle.APP_CACHE.CACHE_CACHED);
window.localStorage.getItem("cached")||window.localStorage.setItem("cached",1);f();s&&s.loaded&&s.timer.emit("KindleApp:AppCacheSuccess",{submetrics:[{name:"progress",value:s.loaded}],breakdown:["Browser"]})}function g(a,k){k||(k={});n=a;p.callEventListeners(a,k)}var q,p=ListenerManager(),t="",s=null,v,w,n;return{initialize:function(a,k,n){_metricsManager=k;typeof Kindle==="undefined"&&(Kindle=n);v=LocalStorageCounter("AppCacheRetryCount");w=LocalStorageCounter("AppCacheBrowserRestartCount");q=a;
t=["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][q.status];try{q.addEventListener("checking",e,!1),q.addEventListener("error",d,!1),q.addEventListener("progress",l,!1),q.addEventListener("cached",j,!1),q.addEventListener("noupdate",j,!1),q.addEventListener("updateready",o,!1)}catch(g){}},getCacheStatus:function(){return n},removeEventListener:function(a,k){p.removeEventListener(a,k)},addEventListener:function(a,k,d){p.addEventListener(a,k,d)}}}(),KindleAppCacheManager=function(){function a(a){if(KindleHostDeviceDetector.isiOS_4x()||
KindleHostDeviceDetector.isFirefox())a=AppCacheEventProvider(a);try{KindleAppCacheEventHandler.initialize(a,o,j),d.resolve(KindleAppCacheEventHandler)}catch(f){d.reject()}}function e(g,e){o=g;j=e;d=$.Deferred();f?l||(l=$(document.createElement("iframe")).attr("seamless",!0).css("display","none").css("visibility","hidden").attr("src",KINDLE_APPCACHER_SRC)[0],$(document.body).append($(l)),KindleDebug.log("AppCacheIframe created")):a(window.applicationCache);return d.promise()}var d,l,f,o,j;return{initialize:function(a){var d=
[KindleModuleManager.METRICS_MANAGER,KindleModuleManager.CONSTANTS];(f=KindleHostDeviceDetector.isFirefox()&&window.applicationCache.status!==window.applicationCache.UNCACHED)&&d.push(a);KindleModuleManager.define(Kindle.MODULE.APPCACHE_EVENTHANDLER,d,e)},connectIframeAppCache:a}}();
function KindleAppFactory(){function a(){return!!G}function e(){return window.self!==window.top&&!G}function d(){X||(X=l(T.KINDLE_READER_ID,KINDLE_READER_SRC,"#"+T.KINDLE_READER_CONTAINER_ID))}function l(b,a,y){if(!KindleHostDeviceDetector.isMetro()&&a[0]==="."){var c=Kindle.top.location.href;c.slice(-1)!=="/"&&(c=c.slice(0,c.lastIndexOf("/")+1));a=c+a.slice(2)}b=$(document.createElement("iframe")).attr("id",b).attr("seamless","seamless").addClass(pa);KindleHostDeviceDetector.isIE()||b.attr("src",
a);$(y).append(b);KindleHostDeviceDetector.isIE()&&b[0].contentWindow.location.replace(a);return b}function f(b){if(b)b.readerClass?x.readerClass=b.readerClass:delete x.readerClass,b.readerAppBar?x.readerAppBar=b.readerAppBar:delete x.readerAppBar,b.cacheSample?x.cacheSample=b.cacheSample:delete x.cacheSample,b.returnToLibrary?x.returnToLibrary=b.returnToLibrary:delete x.returnToLibrary,b.position?(x.position=Number(b.position),delete x.location):b.location?(x.location=Number(b.location),delete x.position):
(delete x.position,delete x.location),x.asin=b.asin,b.isSample!==void 0?x.isSample=b.isSample?!0:!1:delete x.isSample,b.hostStorage===!0?x.contentProvider=s(x.asin):delete x.contentProvider;x.closeButton=e()?Kindle.Reader.CloseButtonNone:Kindle.Reader.CloseButtonAuto;x.standAlone=Z===void 0;x.asin&&C&&(C.openBook(x),X&&X.focus(),x.standAlone&&$("#"+T.KINDLE_READER_CONTAINER_ID).removeClass("hidden"))}function o(b){x.asin=void 0;window.localStorage.setItem(V,"");Kindle.URL.removeASIN();C&&(C.unloadReader(),
C=null);$("#"+T.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();X=void 0;b&&(da=b);if(U)U.onReaderClose()}function j(){ea=setTimeout(function(){$("#"+T.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function g(){Z||(Z=l(T.KINDLE_LIBRARY_ID,KINDLE_LIBRARY_SRC,"#"+T.KINDLE_LIBRARY_CONTAINER_ID));ea&&(clearTimeout(ea),ea=void 0);$("#"+T.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");Z&&Z.focus()}function q(){da&&(KindleMetricsManager.endMetrics(da),da=null);d()}function p(){C&&C.unloadReader();
KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).done(function(b){b.persistDB()})}function t(){var b,a=!0;KindleHostDeviceDetector.isCookieEnabled()?KindleHostDeviceDetector.isLocalStorageEnabled()||(b=KINDLE_NO_LOCAL_STORAGE_SRC,a=!1):(b=KINDLE_NO_COOKIE_SRC,a=!1);a||(b=$(document.createElement("iframe")).attr("src",b).addClass(pa).attr("seamless","seamless"),$("body").append(b));return a}function s(b){return RemoteContentCache.create({asin:b,contentProvider:G.contentProvider,contentRemover:G.deleteBookContent})}
function v(){function b(y){KindleAppCacheEventHandler.addEventListener(y,function(){if(KindleHostDeviceDetector.isOnline())switch(y){case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:G.onAppCacheStatus("error");a=!1;break;case Kindle.APP_CACHE.CACHE_PROGRESS:a||(G.onAppCacheStatus("incomplete"),a=!0);break;case Kindle.APP_CACHE.CACHE_DONE:case Kindle.APP_CACHE.CACHE_CACHED:G.onAppCacheStatus("success");if(window.applicationCache.status===window.applicationCache.UPDATEREADY)G.onAppCacheUpdateReady();a=!1}})}
var a=!1;b(Kindle.APP_CACHE.CACHE_NEEDS_RETRY);b(Kindle.APP_CACHE.CACHE_PROGRESS);b(Kindle.APP_CACHE.CACHE_DONE);b(Kindle.APP_CACHE.CACHE_CACHED)}function w(){KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseI18NSupported(Y,x.language)?n("langSupport"):KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseVersionNonSupported(Y)&&n();KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseCountryNotSupported(Y,x.language,x.ip).done(function(b){b&&n("countryBlk")})}function n(b){if(G){var a=
Kindle.URL.getBasePathURL();a.indexOf("k4w")===-1&&(a=Kindle.URL.getHostURL()+"/");var y=KINDLE_UPGRADE_SRC.substr(1+KINDLE_UPGRADE_SRC.indexOf("/")),c=x.language||KindleHostDeviceDetector.getBrowserLanguage();a+=y+"?language="+c;a+=b?"&type="+b:"";G.showWebPage({url:a})}}function c(b,a){var y=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(c){KindleHostDeviceDetector.isOnline()?c.getOwnedContent(b,a).then(y.resolve,y.reject):y.reject("offline")},
y.reject);return y.promise()}function k(){return{setLoginParameters:function(a){b(a)},setFocusToReader:function(){C&&C.setFocus()},showAppbar:function(){C&&C.setToolbarVisible(!0)},hideAppbar:function(){C&&C.setToolbarVisible(!1)},toggleAppbar:function(){C&&C.toggleToolbar()},openBook:function(b){x.asin&&(o(),d());f(b)},goTo:function(b){C&&(b.position>=0?C.goToPosition(b.position):b.location>=0&&C.goToLocation(b.location))},deregister:function(){return aa(!1,!0)},clearDatabases:function(){return KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).pipe(function(b){return b.clear()})},
clearLocalStorage:function(){window.localStorage.clear();return $.Deferred().resolve({success:!0}).promise()},sendMetrics:function(b){b.metrics.method?KindleMetricsManager.emit(b.metrics.method,b.metrics):KindleMetricsManager.emit(b.metrics)},sendMetricsNow:function(b){b.metrics.method?KindleMetricsManager.emitNow(b.metrics.method,b.metrics):KindleMetricsManager.emitNow(b.metrics)},getOwnedContent:function(b){return c(b&&b.lastSyncTime||null,b&&b.reason||null)},requestDeviceName:function(){KindleDebug.warn("requestDeviceName not implemented yet (waiting for new service api)")},
requestDownloadedBookList:function(){return D()},getDownloadedBookInfo:function(b){return F(b)},downloadBook:function(b){B(b)},cancelBookDownload:function(){C&&C.cancelBookDownload()},removeBook:function(b){var a=$.Deferred();C?C.removeBook(b,a.resolve,a.reject):a.reject();return a.promise()},removeBookOwnership:function(b){return K(b)},getSearchContext:function(b){return C?C.getSearchContext(b):$.Deferred().reject()},requestOemAssociateId:function(b){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(y){y.getOemAssociateId(b).then(a.resolve,
a.reject)},a.reject);return a.promise()},getTodoItems:function(b){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(y){y.getTodoItems(b).then(a.resolve,a.reject)},a.reject);return a.promise()},removeTodoItems:function(b){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(y){y.removeTodoItems(b).then(a.resolve,a.reject)},a.reject);return a.promise()},uploadSnapshot:function(b){var a=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(y){y.uploadSnapshot(b).then(a.resolve,a.reject)},a.reject);return a.promise()},getSearchIndex:function(b){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.getSearchIndexInfo(b)})},getSelectedText:function(b){return C.getSelectedText(b)},hideContextMenu:function(){C.hideContextMenu()},setServiceHost:function(b){KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).done(function(a){a.setServiceHost(b)})},
uploadJournal:function(){return KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).pipe(function(b){return b.uploadJournal()})},setStoreCookies:function(b){var a=$.Deferred();try{for(var y=0;y<b.length;y++)document.cookie=b[y].value;setTimeout(a.resolve,0);return a.promise()}catch(c){return a.reject(c)}},updateAppCache:function(){window.applicationCache.update()},getTOSParams:function(b){var a=$.Deferred(),b=b||{};b.width=b.hasTouch?1366:2560;b.height=b.hasTouch?768:1440;b.dpi=b.hasTouch?
148:72;return a.resolve({cachePollAttemptInterval:18E5,cachePollWaitAfterSuccess:432E5,width:b.width,height:b.height,dpi:b.dpi}).promise()},moveAsinToHost:function(b){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.moveBook(b)})},notifyMigrationStatus:function(b){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.notifyMigrationStatus(b)})},convertPositions:function(b){if(C)return C.convertPositions(b)},
updateAnnotations:function(b){if(C)return C.updateAnnotations(b)},updateReaderChrome:function(b){if(C)return C.updateReaderChrome(b)},pingNA:function(){return KindleNetwork.pingNA()},getUrlForPfm:function(b){var a=new $.Deferred,y="";b&&b.method&&b.pfm&&Kindle.PFMLinks[b.pfm]&&(y=Kindle.PFMLinks[b.pfm][b.method]);return a.resolve({url:y})}}}function K(b){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.removeOwnership(b.asin,b.contentType)})}function D(){var b=
jQuery.Deferred();KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(a){(a=a[KindleModuleManager.DB_CLIENT].getAppDb())&&a.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(b.resolve,b.reject)},b.reject);return b.promise()}function F(b){function a(c){var h,m,Q={asin:b.asin};c.context=c.context||{};c.metadata=c.metadata||{};for(h in b)h!=="asin"&&b.hasOwnProperty(h)&&(m=c[h]||c.context[h]||c.metadata[h],m!==void 0&&(Q[h]=m));y.resolve(Q)}var y=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(c){c.getBookDb().BookInfoDB(b.asin).getBookInfo().then(a,y.reject)},y.reject);return y.promise()}function B(b){function a(){G.onBookDownloadComplete({asin:b.asin})}function y(a){G.onBookDownloadFailed({asin:b.asin,error:a})}function c(a){if(a!==b.prevPct)b.prevPct=a,G.onBookDownloadProgress({asin:b.asin,pct:a})}if(C){if(b.hostStorage===!0)b.contentProvider=s(b.asin);b.prevPct=0;C.downloadBook(b,c,a,y)}}function I(){f()}function z(b){var a=
b&&b.canOpen,y=b&&b.errorCode,b=b&&b.subErrorCode;KindleTOS.setOpenBookReady();ba();a?($("#"+T.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),j()):A();if(U)U.onReaderOpenStatus(a,y,b)}function A(b){o(b);g()}function E(b){var a;a={asin:x.asin,type:"reader"};if(x.isSample!==void 0)a.isSample=x.isSample;(b||KindleHostDeviceDetector.isiOS())&&window.localStorage.setItem(V,JSON.stringify(a))}function b(b){var a={hostApp:u(),hostVersion:Y,loginParams:b};KindleModuleManager.define(Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,
[],function(){return a})}function h(b){function a(){Kindle.URL.addSavedStateToQueryParameters();window.location.reload(!0)}switch(b.newState){case Kindle.Service.AuthOK:fa.resolve();break;case Kindle.Service.AuthError:b.prevState===Kindle.Service.AuthOK?aa(!0):ga();break;case Kindle.Service.AuthUserMismatch:KindleMetricsManager.emitNow("Service::ClientHashMismatch",{breakdown:["Browser"]});qa().always(a);break;case Kindle.Service.AuthTokenMismatch:a()}}function u(){return G?{onServiceAuthState:G.onServiceAuthState,
getRequestSigningHeaders:G.getRequestSigningHeaders}:{onServiceAuthState:h,getRequestSigningHeaders:function(){KindleDebug.error("Non-Embedded applications do not use signed request headers.")}}}function J(){KindleModuleManager.define(Kindle.MODULE.APPLICATION_ARGS,[],x);KindleStreamingReaderClient.initialize();KindleDBClient.initialize();if(!G){var a={};a.srsBasePath=x.srsBasePath;b(a)}KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize());
var y=KindleHostDeviceDetector.getDeviceType()+":"+KindleHostDeviceDetector.getDevicePlatform(),c=KindleUserAgentMetricsInfo.browserWithVersionString();G&&KindleHostDeviceDetector.isMetro()&&(ContentMigration.initialize(),c=Y);KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(b){var a={version:"1.0",clientName:x.kcrFree?Kindle.ClientName.KCRFree:KindleHostDeviceDetector.getClientName(),devicePlatform:y},b={uploadCallback:KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadMetrics,
platformContext:a,dbClient:b,logger:KindleDebug,isOnline:KindleHostDeviceDetector.isOnline,isNumber:isNumber,persistMetrics:!0};KindleMetricsManager.initialize(b);KindleMetricsManager.setBreakdown("Version",KindleVersion.getMetricsVersionString());KindleMetricsManager.setBreakdown("Browser",c);ha()&&KindleMetricsManager.setBreakdown("Partner",ha());R=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);G&&R.emit("zzz::HostVersion_"+Y+"_kcr@"+KindleVersion.getMetricsVersionString())}).fail(function(){KindleDebug.error("metricsManagerInitializeError: Can not initialize metrics manager")})}
function m(b,a){var y=R.startMetrics("Store::TOSOpen"),a=$.extend({storeStartTime:Date.now()},a),c=b===W.LIBRARY?U&&U.onStoreOpenStatus:C&&C.onStoreOpenStatus;ia||(ia=!0,KindleTOS.open(a).then(function(a){c&&c(Kindle.STORE.OPEN_STORE);a?window.localStorage.removeItem(V):(b!==W.LIBRARY&&(o(),d()),j(),ba(),b!==W.BOOKEXTRAS?KindleTOS.setStoreClosedCallback(M):KindleTOS.setStoreClosedCallback(P));R.endMetrics(y);ia=!1},function(){c&&c(Kindle.STORE.GENERIC_ERROR);R.modifyMetricsMethod(y,"Store::TOSOpenFail");
R.endMetrics(y);ia=!1}))}function r(){var b=!!x.storePath;return!e()&&(KindleHostDeviceDetector.isiOS()||b)}function N(b,a){var y=b===W.LIBRARY?U&&U.onStoreOpenStatus:C&&C.onStoreOpenStatus;if(!KindleHostDeviceDetector.isOnline()&&y)y(Kindle.STORE.OFFLINE_ERROR);else if(r())m(b,a);else{var c,h;a.asin?(c="http://www.amazon.com/dp/"+a.asin+"/ref=kcr_store_sample",window.localStorage.removeItem(V)):(c=a.isSourceEmptyLibBtn?"/ref=kcr_store_emptylib_desktop":"/ref=kcr_store_libbutton_desktop",h=a.kids?
Kindle.STORE.CHILDRENS_NODE:a.comix?Kindle.STORE.COMICS_NODE:Kindle.STORE.KINDLE_NODE,c="http://www.amazon.com/b"+c+"?_encoding=UTF8&node="+h);(h=ha())&&(c+="&tag="+h);ja(c,e());y&&y(Kindle.STORE.OPEN_STORE)}}function O(b){b=Kindle.URL.getBaseURL()+"?asin="+b.asin;ja(b,e())}function M(){H()}function P(){ka(0);var b=window.localStorage.getItem(V);if(b)try{if(b=JSON.parse(b),b.type==="store"&&b.asin){L(b.asin,!1);return}}catch(a){H()}H()}function H(){x.asin?(d(),ka(1E3)):(g(),U&&U.libraryUpdateNeeded())}
function L(b,a){var y=R.startMetrics("BEX::Open"),c=C&&C.onBookExtrasOpenStatus;ka(100);la||(C&&C.pauseReader(),la=!0,KindleBEX.open(b,!!a).then(function(){var h=null;c&&c(Kindle.BOOKEXTRAS.OPEN_BEX);a||(o(),d());C&&C.pauseReader();$("#"+T.KINDLE_READER_CONTAINER_ID).addClass("hidden");ba();la=!1;h={asin:b,type:"reader"};window.localStorage.setItem(V,JSON.stringify(h));R.increaseSubCounter(y,"Open",1);R.endMetrics(y)},function(){c&&(C.resumeReader(),c(Kindle.BOOKEXTRAS.GENERIC_ERROR));ba();la=!1;
R.increaseSubCounter(y,"OpenFail",1);R.endMetrics(y)}))}function S(b){ka(0);N(W.BOOKEXTRAS,{asin:b})}function Q(b){x.asin===void 0&&f({asin:b});C&&C.resumeReader();$("#"+T.KINDLE_READER_CONTAINER_ID).removeClass("hidden");X&&X.focus()}function y(b){var a=R.startMetrics("BEX::Opened");R.increaseSubCounter(a,b,1);R.endMetrics(a)}function ka(b){ma=setTimeout(function(){ca&&($("body").append(ca),ca=null);var b=$("#loading_spinner"),a=$(window).width(),y=parseInt(b.css("width"),10),c=$(window).height(),
h=parseInt(b.css("height"),10);b.css("top",(c-h)/2+"px").css("left",(a-y)/2+"px").show()},b)}function ba(){ma&&clearTimeout(ma);var b=$("#loading_spinner").detach();b.length&&!ca&&(ca=b)}function ja(b,a){G?KindleDebug.error("Tried to go to a different URL when we are hosted"):a?window.open(b):window.location=b}function ga(){return KindleRegistrationHandler.register()}function aa(b,a){return KindleRegistrationHandler.deregister(b,a).then(function(){if(G&&G.onDeregister)G.onDeregister(!0)},function(){if(G&&
G.onDeregister)G.onDeregister(!1)})}function qa(){window.localStorage.clear();return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).clear()}function ha(){return x.tag}var T={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},W={LIBRARY:"fromLibrary",
READER:"fromReader",BOOKEXTRAS:"fromBookExtras"},na,pa="KindleIFrame",V="last_app_activity",X,Z,x={},C=null,U=null,da,ia=!1,la=!1,ea,ma,ca,R,oa,Y,G,fa,ra=!1;return{initialize:function(){if(!ra){ra=!0;KindleHostDeviceDetector.isiOSAppMode()||(Kindle.URL.normalizeQueryString(),x=$.extend({},Kindle.URL.getFragIdParameters(),Kindle.URL.getQueryParameters()));ba();na=[Kindle.MODULE.APPCACHE_EVENTHANDLER,KindleModuleManager.RESOURCE_BUNDLE,KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,
KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.CONSTANTS,KindleModuleManager.NETWORK,KindleModuleManager.JOURNAL_MANAGER];KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle);KindleModuleManager.registerModule(KindleModuleManager.RESOURCE_BUNDLE,ResourceBundle);KindleModuleManager.registerModule(KindleModuleManager.NETWORK,KindleNetwork);KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,KindleMetricsManager);ResourceBundle.setStringIDMode(!!x.stringIDMode);
ResourceBundle.setLanguageCultureAndRegion(x.language,x.region);fa=new jQuery.Deferred;KindleAppCacheManager.initialize(fa);KindleTemplateManager.initialize();KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad");if(KindleHostDeviceDetector.isiOS_7x())window.onresize=function(){window.scrollTo(0,0)},$("body").addClass("ios7");if(KindleHostDeviceDetector.isSafari(6.1))$(document).on("mousewheel",function(){});if(t()){window.onbeforeunload=p;if(x.host){if(!KindleHostDeviceDetector.isMetro()||
!/^(ms-appx:\/\/)?amznmobilellc.kindleforwindows8$/.test(x.host)){console.error("unknown embedded host: "+x.host);return}oa=x.host;Y=x.hostVersion;G=ReaderHostInterfaceFactory(k(),oa);KindleModuleManager.define(KindleModuleManager.EMBEDDED_HOSTINTERFACE,[],G);Kindle.URL.removeQueryParameter("host");w();G.onReaderLoaded({readerVersion:KindleVersion.getVersionString(),sendCrashWVMetricsVersions:[]});v();KindleHostDeviceDetector.isMetro()&&KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(b){b[KindleModuleManager.DB_CLIENT].enableFullDb().then(function(){KindleDebug.log("In metro mode, enabling full database")},
function(){KindleDebug.error("In metro mode, was not able to enable full database.")})})}if(x.ref_)if(Kindle.RefTag.isRWISRefTag(x.ref_)){var b=x.ref_;Kindle.URL.addToSavedSiteState(x);Kindle.URL.removeAllQueryParameters();KindleBanner.showRWISBanner(b)}else Kindle.URL.addToSavedSiteState({ref_:x.ref_}),Kindle.URL.removeQueryParameter("ref_");x.tag&&(Kindle.URL.addToSavedSiteState({tag:x.tag}),Kindle.URL.removeQueryParameter("tag"));if(x.kcrFree&&!x.asin)x.asin=Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED;
J();x.storePath&&KindleTOS.setStoreURL(decodeURIComponent(x.storePath));KindleTOS.setOpenBookCallback(f);KindleTOS.setStoreClosedCallback(M);KindleBEX.setBookExtrasStoreOpenCallback(S);KindleBEX.setBookExtrasClosedCallback(Q);KindleBEX.setBookExtrasLogMetricCallback(y);KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(b){return!!x.kcrFree||b.authenticate()}).pipe(function(){var b,a,y;if(!G){y="library";if(x.hasOwnProperty("library"))window.localStorage.removeItem(V),
Kindle.URL.removeQueryParameter("library");else if(x.asin)y="book";else if(x.clear)Kindle.URL.removeQueryParameter("clear");else if(a=window.localStorage.getItem(V))try{b=JSON.parse(a);if(b.isSample!==void 0)x.isSample=b.isSample;if(b.type==="reader")y="book",x.asin=b.asin}catch(c){x.asin=a}y==="library"&&g()}d();b=KindleHostDeviceDetector.isInAppMode()?"inApp":"inBrowser";a=x.asin?"inReader":"inLibrary";y=KindleHostDeviceDetector.isOnline()?"online":"offline";b={submetrics:[{name:b,value:1},{name:a,
value:1},{name:y,value:1}],breakdown:["Browser","Partner"]};KindleMetricsManager.emit("App::Open",b);e()&&KindleMetricsManager.emit("App::Open::Embedded",b);x.kcrFree&&(b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).getAuthenticationState(),KindleMetricsManager.emit("App::Open::"+b))});(G||x.kcrFree)&&fa.resolve();KindleChromeInstaller.initialize()}}},registerEventCallback:function(b,a){var y=[],c;for(c in Kindle.APP_CACHE)y.push(Kindle.APP_CACHE[c]);y.indexOf(b)>=0&&KindleAppCacheEventHandler.addEventListener(b,
a)},getSharedModuleSync:function(b){na.indexOf(b)===-1&&KindleDebug.error(b+"is not a shared module");return KindleModuleManager.getModuleSync(b)},getSharedModules:function(){return KindleModuleManager.getModuleList(na)},getAppInterfaceForReader:function(){function b(a){setTimeout(function(){o(a);d()},0)}return G?{onReaderReady:I,closeReader:function(a){G.onBookClose();b(a)},onStartReadingStatus:function(a){G.onBookOpenStatus(a);(!a||!a.canOpen)&&b()},onRendererLoaded:E,openBookExtras:L,openStore:function(b){G.onOpenStore({origin:W.READER,
asin:b})},pinBookToStart:function(b){G.pinBookToStart(b)},onReaderTapped:function(){G.onReaderTapped()},onUserAction:function(){G.onUserAction()},hideAppBar:function(){G.hideAppBar()},onBookDownloadComplete:function(b){G.onBookDownloadComplete(b)},searchContent:function(b){G.searchContent(b)},showAnnotations:function(b){G.showAnnotations(b)},isHostControlled:a,isEmbeddedInWebsite:e}:{onReaderReady:I,closeReader:A,onStartReadingStatus:z,onRendererLoaded:E,openBookExtras:L,openStore:function(b){N(W.READER,
{asin:b})},openFullKCR:O,register:ga,deregister:aa,pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},onBookDownloadComplete:function(){},searchContent:function(){},showAnnotations:function(){},isHostControlled:a,isEmbeddedInWebsite:e}},setReaderInterface:function(b){KindleInterfaces.assertImplements(b,KindleInterfaces.IKindleReader);C=b},getAppInterfaceForLibrary:function(){return{openExternalLink:function(b){ja(b,!0)},storeIsTOS:r,openStore:function(b){N(W.LIBRARY,
b)},openBook:f,onLibraryLoaded:q,getQueryParameters:function(){return x},register:ga,deregister:aa}},setLibraryInterface:function(b){KindleInterfaces.assertImplements(b,KindleInterfaces.IKindleLibrary);U=b},cleanupForNextUser:qa,register:ga,deregister:aa,getQueryParams:function(){return x},gotoURL:ja,isHostControlled:a,isEmbeddedInWebsite:e,getEmbeddorHostname:function(){return oa},getPartnerTag:ha}}var KindleApp=KindleAppFactory();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleBanner=function(){function a(){if(f){var a=window.innerHeight||document.body.clientHeight||document.documentElement.clientHeight;a-=$("#"+d.KINDLE_BANNER_CONTAINER_ID).height();a={height:a};$("."+d.KINDLE_APP_CONTAINER).css(a)}}function e(j,e){if(!f){f=!0;$("."+d.KINDLE_BANNER_CONTAINER_ID).css("display","block");$("#kindleApp_Banner_text").html(j||"");for(var p in e)window.document.getElementById(p).addEventListener("click",e[p],!0);p={top:$("#"+d.KINDLE_BANNER_CONTAINER_ID).height()+"px"};
$("."+d.KINDLE_APP_CONTAINER).css(p);a();window.addEventListener("resize",a)}}var d={KINDLE_APP_CONTAINER:"KindleAppContainer",KINDLE_BANNER_CONTAINER_ID:"KindleBannerContainer"},l,f=!1,o={rwis:4,next_available:5},j={rwis:1};return{showRWISBanner:function(g){if(!o.rwis||!j.rwis?0:LocalStorageCounter("kcrNotification."+o.rwis).getValue()<j.rwis){l||(l=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));var q;KindleHostDeviceDetector.isiPad()?g=ResourceBundle.getLocalizedString("k_banner_RWIS_message_ipad",
{getIPadAppStart:'<a id="kindleApp_Banner_appslink" href="https://itunes.apple.com/us/app/id302584613" target="_blank">',getIPadAppEnd:"</a>"}):(q=ResourceBundle.getLocalizedString(KindleHostDeviceDetector.isMacintosh()?"k_banner_bookmark_command_mac":"k_banner_bookmark_command"),g=ResourceBundle.getLocalizedString("k_banner_RWIS_message_desktop",{bookmarkCommand:q,getAppStart:'<a id="kindleApp_Banner_appslink" href="http://www.amazon.com/gp/feature.html/ref='+g+'?ie=UTF8&docId=1000493771" target="_blank">',
getAppEnd:"</a>"}));e(g,{kindleApp_Banner_close:function(){f&&(window.removeEventListener("resize",a),$("."+d.KINDLE_BANNER_CONTAINER_ID).css("display","none"),$("."+d.KINDLE_APP_CONTAINER).css({top:"0px",height:"100%"}),f=!1);o.rwis&&j.rwis&&LocalStorageCounter("kcrNotification."+o.rwis).increment();l.emit("Banner::RWIS::Close")},kindleApp_Banner_appslink:function(){l.emit("Banner::RWIS::GetAppLink")}});l.emit("Banner::RWIS::Show")}}}}(),KindleBEX=function(){function a(a){t&&$("#"+g.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();
var c=new Date;t=$(document.createElement("iframe")).attr("id",g.KINDLE_BOOK_EXTRAS_ID+c.getTime()).attr("src",a).attr("seamless","seamless").addClass(q);$("#"+g.KINDLE_BOOK_EXTRAS_CONTAINER_ID).append(t)}function e(){$("#"+g.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();t=null;w&&w(v)}function d(){clearTimeout(s);$("#"+g.KINDLE_BOOK_EXTRAS_CONTAINER_ID).removeClass("hidden");p.resolve(!1)}function l(){e()}function f(a){n&&n(a)}function o(a){c&&c("BookExtras::"+a)}function j(a){switch(a){case 0:p.reject();
e();break;case 1:p.reject();e();break;case 4:window.localStorage.setItem(Kindle.BOOKEXTRAS.APP_CACHED,!0);break;case 5:KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().updateBookExtras(v,Kindle.BOOKEXTRAS.BEX_CACHED,function(){})}}var g={KINDLE_BOOK_EXTRAS_ID:"bex",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},q="KindleIFrame",p,t,s,v,w,n,c;return{open:function(c){p=new $.Deferred;v=c;BexBrowserHost=new BexK4WBrowserHost({},{onBookExtrasReady:d,closeBookExtras:l,
openStoreFromBex:f,logMetric:o,logBexStatus:j});s=setTimeout(function(){p.reject();e()},15E3);a(Kindle.BOOKEXTRAS.BEX_URL+v+"?ua=4");KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$(t).bind("orientationchange",BexBrowserHost.onOrientationChanged);return p.promise()},setBookExtrasStoreOpenCallback:function(a){n=a},setBookExtrasClosedCallback:function(a){w=a},setBookExtrasLogMetricCallback:function(a){c=a}}}(),KindleBuildInfo=function(){function a(a,l,f){var o=$.Deferred();$.getJSON(e,
Math.floor(Math.random()*1E9),function(j){j=j[a];f(j)?o.resolve(j):o.reject(l)}).error(function(){o.reject(l)});return o.promise()}var e="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return a("filecount",-1,function(a){return typeof a==="number"&&a>1})}}}(),KindleMetricsManager=function(){function a(){return(new Date).getTime()}function e(){if(D.length>0){var b=D;D=[];p().insertList(b).fail(function(){Array.prototype.push.apply(b,D);D=b})}}function d(){J&&m<=
Date.now()+r||(clearTimeout(J),J=setTimeout(function(){J=null;d();q()},r),m=Date.now()+r)}function l(b){if($.isArray(b))return b;var a;if(b){a=[];for(var c in b)a.push(b[c])}return a}function f(a){var c=a[b.FIELD_SUB_TIMERS];if(c)for(var h in c);a[b.FIELD_SUB_TIMERS]=l(a[b.FIELD_SUB_TIMERS]);a[b.FIELD_SUB_COUNTERS]=l(a[b.FIELD_SUB_COUNTERS])}function o(b){for(var a=new jQuery.Deferred,c=0;c<b.length;c++)f(b[c]);b.length>0&&p()?p().insertList(b).then(function(){a.resolve(b)},function(){g(b).then(function(){a.resolve(b)},
function(){Array.prototype.push.apply(D,b);a.reject(b)})}):(Array.prototype.push.apply(D,b),a.resolve(b));return a.promise()}function j(a,c,h){var m=B[a];(a=m[b.FIELD_SUB_COUNTERS])||(a=m[b.FIELD_SUB_COUNTERS]={});m=a[c];m||(m=a[c]={},m[b.FIELD_NAME]=c,m[b.FIELD_COUNT]=0,h&&(typeof h==="string"&&(h=[h]),m[b.FIELD_BREAK_DOWN]=h));return m}function g(b){var a=new jQuery.Deferred,c=/exception/i;z()?I(E.devicePlatform,E.clientName,E.version,E.breakdownDeclarations,b).then(function(h){h.Output.metricProcessCount&&
h.Output.metricProcessCount>0||h.Output.__type&&h.Output.__type.match(c)?a.resolve(b):a.reject(b)},function(){a.reject(b)}):a.reject(b);return a.promise()}function q(){var b,a=new jQuery.Deferred;if(z()){if(!p())return a.reject(),a.promise();p().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:k,params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:k,params:[]}]).done(function(c){if(c[0]&&c[0].length>0){b=c[0];for(c=0;c<b.length;c++){var h=b[c];if(h.breakDown)h.breakdown=
h.breakDown,delete h.breakDown}g(b).done(a.resolve).fail(function(){p()&&p().insertList(b);a.reject()})}}).fail(function(){a.reject()})}else a.reject();return a.promise()}function p(){try{if(K)return K.getAppDb().getTable(k)}catch(b){}return null}function t(a){function c(a,h){var m={};m[b.FIELD_NAME]=h.name;m[b.FIELD_COUNT]=h.value;var Q=s(h.breakdown);Q.length>0&&(m[b.FIELD_BREAK_DOWN]=Q);a[b.FIELD_SUB_COUNTERS]||(a[b.FIELD_SUB_COUNTERS]=[]);a[b.FIELD_SUB_COUNTERS].push(m)}if(!(typeof a==="object"&&
typeof a.name==="string"&&typeof a.params==="undefined"||typeof a.params==="object"))return null;var h={},m=a.name,a=$.extend({},a.params);h[b.FIELD_METHOD]=m;h[b.FIELD_TIME]=0;if(a){if(a.time>=0&&A(a.time))h[b.FIELD_TIME]=a.time;if(a.submetrics){if(!$.isArray(a.submetrics))a.submetrics=[a.submetrics];for(m=0;m<a.submetrics.length;m++)c(h,a.submetrics[m])}m=s(a.breakdown);m.length>0&&(h[b.FIELD_BREAK_DOWN]=m)}return h}function s(b){var a=[];if(b===void 0)return a;$.isArray(b)||(b=[b]);for(var c=0;c<
b.length;c++)typeof b[c]==="string"&&(h.indexOf(b[c]),a.push(b[c]));return a}function v(b){b||(b={});if(!b.startTime)b.startTime=a();A(b.startTime);this.params=b}function w(a,c){return a=$.map(a,function(a){a[b.FIELD_TIME]=c;return a})}function n(b){if(typeof b[0]==="string"){var a={};a.name=b[0];if(b[1])a.params=b[1];b=[a]}else b=$.isArray(b[0])?b[0]:[];return $.map(b,t)}function c(){}var k="metrics",K=null,D=[],F=0,B={},I,z=function(){return navigator.onLine},A=isNumber,E={breakdownDeclarations:{}},
b={FIELD_METHOD:"method",FIELD_NAME:"name",FIELD_TIME:"time",FIELD_SUB_TIMERS:"timers",FIELD_SUB_COUNTERS:"counters",FIELD_BREAK_DOWN:"breakDown",FIELD_TIMER_START:"timerStart",FIELD_COUNT:"count",FIELD_VALUE:"value"},h=["Browser","Version","Partner","ProcessorClass","ViewState","SystemLanguage","Online","CloudItemsCount","LocalItemsCount","HostVersion","PFM","CrashLocation"],u=Object.freeze({Short:3E4,Default:3E5,Min:1E4,Max:6E5}),J=null,m=0,r=u.Default;v.prototype.elapsed=function(){var b=0;A(this._elapsed)?
b=this._elapsed:A(this.params.startTime)&&(b=a()-this.params.startTime);return b};v.prototype.stop=function(){this._elapsed=a()-this.params.startTime;return this};v.prototype.emit=function(){var b=this.elapsed(),a=n(arguments),a=w(a,b);return o(a).fail(c)};v.prototype.emitNow=function(){var b=this.elapsed(),a=n(arguments),a=w(a,b);return g(a).fail(c)};return{modifyMetricsMethod:function(a,c){B[a]&&(B[a][b.FIELD_METHOD]=c)},startMetrics:function(c,h){var m={};m[b.FIELD_METHOD]=c;m[b.FIELD_TIMER_START]=
a();h&&h.breakdown&&(m[b.FIELD_BREAK_DOWN]=s(h.breakdown));F++;B[F]=m;return F},endMetrics:function(c){var h;(h=B[c])&&h[b.FIELD_TIMER_START]?(h[b.FIELD_TIME]=a()-h[b.FIELD_TIMER_START],delete h[b.FIELD_TIMER_START],h=o([h]),delete B[c]):h=(new jQuery.Deferred).reject().promise();return h},cancelMetrics:function(b){delete B[b]},startSubTimer:function(c,h,m){var u=B[c];(c=u[b.FIELD_SUB_TIMERS])||(c=u[b.FIELD_SUB_TIMERS]={});u=c[h];u||(u=c[h]={},u[b.FIELD_NAME]=h,u[b.FIELD_COUNT]=0,u[b.FIELD_TIME]=
0,m=s(m),m.length>0&&(u[b.FIELD_BREAK_DOWN]=m));u[b.FIELD_TIMER_START]||(u[b.FIELD_TIMER_START]=a())},endSubTimer:function(c,h){var m=B[c][b.FIELD_SUB_TIMERS][h];m[b.FIELD_TIMER_START]!==void 0&&(m[b.FIELD_COUNT]+=1,m[b.FIELD_TIME]+=a()-m[b.FIELD_TIMER_START],delete m[b.FIELD_TIMER_START])},setSubCounter:function(a,c,h,m){a=j(a,c,m);A(h)||(h=1);a[b.FIELD_COUNT]=h},increaseSubCounter:function(a,c,h,m){a=j(a,c,m);A(h)||(h=1);a[b.FIELD_COUNT]+=h},initialize:function(b){I=b.uploadCallback;E=$.extend(E,
b.platformContext);K=b.dbClient;z=b.isOnline||z;A=b.isNumber;b.persistMetrics&&(e(),d())},uploadMetrics:q,setMetricsUploadInterval:function(b){var a=r;u.Min<b&&b<u.Max||(b=r);b!==r&&(r=b,d());return a},UploadInterval:u,setBreakdown:function(b,a){$.isArray(a)&&(a=a.join(":"));typeof a==="string"&&h.indexOf(b)>-1&&(E.breakdownDeclarations[b]=a)},clearBreakdowns:function(){E.breakdownDeclarations={}},replaceBreakdowns:function(b){E.breakdownDeclarations=b},createTimer:function(){return new v},emitNow:function(){var b=
n(arguments);return g(b).fail(c)},emit:function(){var b=n(arguments);return o(b).fail(c)}}}(),KindleNetwork=function(){function a(){return q=navigator.onLine}function e(){a()===!1?d(!1):$.ajax("/service/web/reader/ping")}function d(a){j&&(window.clearTimeout(j),j=0);g=Date.now();a!==o&&(o=a,f.callEventListeners(a?"online":"offline"));l()}function l(){f.hasEventListener(o?"offline":"online")?j||(j=window.setTimeout(e,o?9E5:18E4)):j&&(window.clearTimeout(j),j=0)}var f=new ListenerManager,o=!0,j,g=0,
q;return{pingNA:function(){var a=new $.Deferred;$.ajax("https://read.amazon.com").then(function(d,j,f){a.resolve(f&&f.status!==0)},function(){a.resolve(!1)});return a.promise()},initialize:function(){$(document).ajaxComplete(function(a,f){d(!!f.status)});document.body.addEventListener("offline",e);document.body.addEventListener("online",e);d(a())},addEventListener:function(a,d){f.addEventListener(a,d);l()},removeEventListener:function(a,d){f.removeEventListener(a,d);l()},isOnline:function(f){q!==
a()&&d(q);f=Number(f);return Date.now()-g<(f>=0?f:Infinity)?o:q===!1?!1:null}}}();Kindle.RefTag=function(){return{isRWISRefTag:function(a){return a&&a.indexOf("kcr_rwis_")===0}}}();
var KindleRegistrationHandler=function(){function a(){var a=e(Kindle.URL.getBaseURL()),f=d.US;f+="?openid.assoc_handle=amzn_kweb";f+="&openid.return_to="+encodeURIComponent(a);f+="&openid.mode=logout";f+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";(a=Kindle.URL.getSiteState())&&(f+="&"+a);KindleApp.gotoURL(f)}function e(a){var f=d.US;f+="?openid.assoc_handle=amzn_kweb";f+="&openid.return_to="+encodeURIComponent(a);f+="&openid.mode=checkid_setup";f+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";
f+="&openid.identity=";f+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";f+="&openid.claimed_id=";f+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";f+="&pageId=amzn_kcr";(a=Kindle.URL.getSiteState())&&(f+="&"+a);return f}var d={US:"https://www.amazon.com/ap/signin"};return{register:function(){KindleApp.gotoURL(e(Kindle.URL.getBaseURL()))},deregister:function(d,f){function e(){var a=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(k){k.uploadJournal().then(a.resolve,
a.resolve)});return a.promise()}function j(){var a=new jQuery.Deferred;n.getAppDb().getPinnedSessionIds().done(function(k){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(k).then(a.resolve,a.reject)});return a.promise()}function g(){function a(){s.uploadMetrics().then(p,p)}v.then(a,a)}function q(){t.reject()}function p(){f?KindleApp.cleanupForNextUser().then(function(){KindleDebug.log("db & localStorage cleared.");KindleApp.isHostControlled()||a();t.resolve()},
function(){KindleDebug.log("Failed to clear db/localStorage");KindleApp.isHostControlled()||a();t.resolve()},function(a){t.notify(a)}):(window.localStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG),n.getAppDb().clearDeviceToken().then(a,a),t.resolve())}var t=new jQuery.Deferred,s=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),v,w=s.createTimer();v=f?w.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Intentional"}]):w.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Unintentional"}]);
var n=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);d?p():$.when(e(),j()).then(g,q);return t.promise()}}}(),KindleStreamingReaderClient=function(){function a(b){var a,b=b||{};a=(b.srsHostName||"")+("/"+(b.srsBasePath||"service")+"/")+"web/";F=a+"content/";b.useSignedServiceRequests&&(a+="device/");D=a+"reader/";B=a+"register/";I=D+"setOfflineStatus/";z=D+"deregisterSessions/";A=D}function e(){E=!0}function d(b){var a={prevState:N,newState:b};if(b===Kindle.Service.AuthOK&&(a.eid=
J,m))a.deviceName=m;N=b;r.onServiceAuthState(a)}function l(b,a,c){function m(){d(Kindle.Service.AuthError);u.reject(b,a,c)}if(b.status===K){var u=$.Deferred();h=null;M.clearDeviceToken().then(m,m);return u.promise()}else return $.Deferred().reject(b,a,c)}function f(b,a){return $.ajax({url:b,dataType:"json",beforeSend:function(b){b.setRequestHeader("x-amzn-sessionid",a);return!0}}).pipe(null,l)}function o(){var b=$.cookie("session-id"),a=function(){var b=B+"getDeviceToken",a=KindleHostDeviceDetector.getDeviceType();
b+="?serialNumber="+(P||a)+"&deviceType="+a;return encodeURI(b)}(),c=O.createTimer();return f(a,b).pipe(function(b,a,h){a=jQuery.Deferred();b.deviceSessionToken?a.resolve(b):(a.reject(h,"failed"),c.emit("Service::GetDeviceTokenCallBrokenResult"));c.emit("Service::GetDeviceTokenCall");return a.promise()}).fail(function(){c.emitNow("Service::GetDeviceTokenCallFail")})}function j(b,a){return{url:b,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(a)}}function g(b){function a(){KindleDebug.error("Failed to sign SRS request.");
return $.Deferred().reject()}function c(b){var h;h=/\/web.*$/.exec(b.url);return!h?a():r.getRequestSigningHeaders({path:h[0],verb:b.type||"GET",data:b.data||""}).pipe(function(a){b.beforeSend=function(b){$.each(a,function(a,c){b.setRequestHeader(a,c)});return!0};return $.Deferred().resolve(b)},a)}function m(b){return h?(b.beforeSend=function(b){b.setRequestHeader("X-ADP-Session-Token",h);return!0},$.Deferred().resolve(b)):(KindleDebug.error("Device Token must be loaded in order to make an authenticated request. Cancelling request."),
d(Kindle.Service.AuthError),$.Deferred().reject())}w();return(H?c(b):m(b)).pipe($.ajax).pipe(null,l)}function q(b){b.beforeSend=function(b){b.setRequestHeader("Amzn-Device-Type",KindleHostDeviceDetector.getDeviceType());return!0};return $.ajax(b)}function p(b){function a(){g(m).done(h.resolve).fail(function(b){KindleHostDeviceDetector.isiOSAppMode()&&b.status===0&&k.emit("KindleApp::iOSAppModeStatusCodeIsZero")}).fail(function(b,c,m){b.status!==K&&(c!=="timeout"&&u-- >0?(setTimeout(a,r),r*=2):h.reject(b,
c,m))})}var c=b.url,h=$.Deferred(),m={url:c,dataType:"json"},u=1,r=50;a();var k=O.createTimer();h.done(function(){k.emit(b.metricId)});h.fail(function(){k.emitNow(b.metricId+"Fail")});return h.promise()}function t(b){function a(){q(m).done(h.resolve).fail(function(b,c,m){b.status!==K&&c!=="timeout"&&u-- >0?(setTimeout(a,r),r*=2):h.reject(b,c,m)})}var c=b.url,h=$.Deferred(),m={url:c,dataType:"json"},u=1,r=50;a();var k=O.createTimer();h.done(function(){k.emit(b.metricId)});h.fail(function(){k.emitNow(b.metricId+
"Fail")});return h.promise()}function s(){function b(a,c,m){function y(){(!a||a.status!==K)&&d(Kindle.Service.AuthError);n.reject(a,c,m)}h=null;M.clearDeviceToken().then(y,y)}function a(){N!==Kindle.Service.AuthOK&&d(Kindle.Service.AuthOK);n.resolve(h)}function c(r){if(u&&u!==r.clientHashId)d(Kindle.Service.AuthUserMismatch);else{h=r.deviceSessionToken;u=r.clientHashId;J=r.eid;if(r.deviceName)m=r.deviceName;jQuery.when(M.setDeviceToken(r.deviceSessionToken),M.setUserHashId(r.clientHashId),M.setEID(r.eid)).then(a,
b)}}function r(){o().then(c,b)}function k(b){u=b[Kindle.Service.UserHashIdKey];J=b[Kindle.Service.EidKey];b[Kindle.Service.DeviceTokenKey]?(h=b[Kindle.Service.DeviceTokenKey],a()):r()}var n=$.Deferred();h?n.resolve(h):M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(k,r);return n.promise()}function v(){var b=$.Deferred();M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(function(a){u=
a[Kindle.Service.UserHashIdKey];J=a[Kindle.Service.EidKey];a[Kindle.Service.DeviceTokenKey]?(h=a[Kindle.Service.DeviceTokenKey],b.resolve(!0)):b.resolve(!1)},function(){b.resolve(!1)});return b.promise()}function w(){function b(){d(Kindle.Service.AuthTokenMismatch);a.reject()}var a=$.Deferred();if(!h)return a.resolve();var c=O.createTimer();M.getDeviceToken().done(function(m){m!==h?c.emit("Service::CheckTokenConsistencyMismatch",{breakdown:["Browser"]}).always(b):a.resolve()}).fail(function(){E||
c.emit("Service::CheckTokenConsistencyFail",{breakdown:["Browser"]}).always(b)});return a.promise()}function n(b){return b&&(b==="only"||N!==Kindle.Service.AuthOK)}function c(b,a){var c=D+b+"?asin="+a.asin+"&kindleSessionId="+a.kindleSessionId;return a.position&&a.position>0?(c+="&lastPageRead="+a.position+"&localTimeOffset="+a.localTimeOffset+"&countryCode="+a.countryCode,c+="&positionType="+a.positionType,c=encodeURI(c)+(!a.refEmId?"":"&guid="+encodeURIComponent(a.refEmId))):encodeURI(c)}function k(b,
a,c,h,m){function u(b,a,c,h,m,y){return{Operation:y?"uploadMetricsExternal":"uploadMetrics",Input:{devicePlatform:b,clientName:a,version:c,metricBreakdown:h,metrics:m}}}var r;return function(){function k(b,a,c){var h=$.Deferred();return c.responseText.indexOf("UploadMetricsResponse")===-1?h.reject():h.resolve(b,a,c)}var d=Kindle.Service.AuthOK===N&&(H||$.cookie("at-main")),n=D+"uploadMetrics";return d?(r=u(b,a,c,h,m,!1),g(j(n,r)).pipe(k)):$.Deferred().reject()}().pipe(null,function(){var k=F+"uploadMetrics";
r=u(b,a,c,h,m,!0);return q(j(k,r))}).done(function(){var b;if(b=L||window.localStorage.getItem("QAMetricsURL"))b={url:b,type:"POST",dataType:"json",processData:!1,headers:{Source:window.location.href},contentType:"application/json",data:JSON.stringify(r)},$.ajax(b).fail(function(b){b.status&&KindleDebug.warn("Failed to echo metrics to the QA ingester service; statusCode="+b.statusCode)})})}var K=403,D,F,B,I,z,A,E=!1,b,h,u,J,m,r,N,O,M,P,H,L;a();$.ajaxSetup({headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},
timeout:6E4});var S={getAuthenticationState:function(){return N},authenticate:function(){if(N===Kindle.Service.AuthOK)return $.Deferred().resolve();else if(H)return $.Deferred().reject();return s()},checkTokenConsistency:w,deregisterSessions:function(b){return p({metricId:"Service::DeregisterSessionsCall",url:function(b){b=z+"?sessions="+b.join();return encodeURI(b)}(b)})},doneReading:function(b){return p({metricId:"Service::DoneReadingCall",url:c("doneReading",b)})},getAnnotations:function(b,a){var c=
D+"getAnnotations?asin="+encodeURIComponent(b)+(!a?"":"&guid="+encodeURIComponent(a));return p({metricId:"Service::GetAnnotationsCall",url:c})},getEID:function(){function b(){return $.Deferred().resolve(J)}function a(){var c=O.createTimer();return o().fail(function(){c.emitNow("Service::GetEIDTokenCallFail")}).pipe(function(a){J=a.eid;c.emit("Service::GetEIDTokenCallSuccess");return M.setEID(a.eid).pipe(b,b)},null)}return J?b():M.getEID().pipe(null,a)},getFileUrl:function(b){var a=n(b.kcrFree),c=
{metricId:"Service::GetFileUrlCall",url:function(){var c=a?F:D;c+="getFileUrl?asin="+b.asin+"&contentVersion="+b.contentVersion+"&formatVersion="+b.formatVersion;c+=b.kindleSessionId?"&kindleSessionId="+b.kindleSessionId:"";c+=b.isSample?"&isSample="+b.isSample:"";c+=b.skeletonIds?"&skeletonIds="+b.skeletonIds.join(","):"";c+=b.fragmentIds?"&fragmentIds="+b.fragmentIds.join(","):"";c+=b.glyphIds?"&glyphIds="+b.glyphIds.join(","):"";c+=b.resourceIds?"&resourceIds="+b.resourceIds.join(","):"";c+=b.locationMapIds?
"&locationMapIds="+b.locationMapIds.join(","):"";c+=b.basePath?"&basePath="+b.basePath:"";c+=b.useNewPath?"&useNewPath="+b.useNewPath:"";c+=b.useProdBucket?"&useProdBucket="+b.useProdBucket:"";return encodeURI(c)}()};return(a?t:p)(c)},getLPR:function(b,a){var c=D+"getLPR?asin="+encodeURIComponent(b)+(!a?"":"&guid="+encodeURIComponent(a));return p({metricId:"Service::GetLPRCall",url:c})},getOemAssociateId:function(b){var b={Operation:"getAssociateId",Input:{deviceType:b.deviceType,deviceParameters:{eid:b.eid,
oemPartnerName:b.oemPartnerName,oemDealGuid:b.oemDealGuid}}},a=D+"getAssociateId",c=O.createTimer();return g(j(a,b)).then(function(b){c.emit("Service::OemAssociateIdSuccess");(!b||!b.Output||!b.Output.associateId)&&c.emit("Service::OemAssociateIdEmpty")},function(){c.emit("Service::OemAssociateIdFailure")})},getOwnedContent:function(b,a){return p({metricId:"Service::GetOwnedContentCall",url:function(){var c="";b&&(c="?lastSyncTime="+encodeURIComponent(b));a&&(c?c+="&":c="?",c+="reason="+encodeURIComponent(a));
return D+"getOwnedContent"+c}()})},getPFM:function(){return p({metricId:"Service::GetPFMCall",url:D+"getPFM"})},getTodoItems:function(b){var a=b.reason,c=b.versionNumber,b=A+"getTodoListItems?maxNumItems="+(b.maxNumItems||b.count);a&&(b+="&reason="+a);c&&(b+="&softwareRev="+c);b=encodeURI(b);return p({metricId:"Service::GetTodoItemCall",url:b})},getSearchIndexInfo:function(b){var a=n(b.kcrFree),c=a?F:D;c+="getSearchIndex?asin="+encodeURIComponent(b.asin)+"&formatVersion="+encodeURIComponent(b.formatVersion)+
"&contentVersion="+encodeURIComponent(b.contentVersion);return(a?t:p)({url:c,metricId:"Service::GetSearchIndex"})},getWordDefinition:function(b){var a=Kindle.Service.AuthOK===N,b={metricId:"Service::GetWordDefinitionCall",url:encodeURI((a?D:F)+"getWordDefinition?word="+b)};return(a?p:t)(b)},removeTodoItems:function(b){if(b.length!==1)return $.Deferred().reject("Must be one item").promise();var b=b[0],a=A+"removeTodoListItem";a+="?type="+b.type+"&action="+b.action+"&key="+b.key+"&completeStatus="+
(b.completeStatus||b.complete_status)+"&failureCode="+(b.failureCode||b.failure_code||"");a=encodeURI(a);return p({metricId:"Service::RemoveTodoItemsCall",url:a})},resetLPR:function(b){return p({metricId:"Service::ResetLPRCall",url:c("resetLPR",b)})},removeOwnership:function(b,a){return p({metricId:"Service::RemoveOwnershipCall",url:D+"removeOwnership?asin="+b+"&contentType="+a})},setOfflineStatus:function(b){return p({metricId:"Service::SetOfflineStatusCall",url:encodeURI(I+"?asin="+b.asin+"&kindleSessionId="+
b.kindleSessionId+"&offline="+(b.isOffline?"true":"false"))})},setServiceHost:function(b){a({useSignedServiceRequests:H,srsHostName:b})},startReading:function(a){var c=n(a.kcrFree),h={metricId:"Service::StartReadingServiceCall",url:function(){var h=c?F:D;h+="startReading?asin="+a.asin;h+=a.basePath?"&basePath="+a.basePath:"";h+=a.useNewPath?"&useNewPath="+a.useNewPath:"";h+=a.useProdBucket?"&useProdBucket="+a.useProdBucket:"";h+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";h+=a.contentVersion?
"&contentVersion="+a.contentVersion:"";h+=a.formatVersion?"&formatVersion="+a.formatVersion:"";h+=a.isSample!==void 0?"&isSample="+(a.isSample?"true":"false"):"";b&&(h+="&clientVersion="+b);return encodeURI(h)}()};return(c?t:p)(h)},stillReading:function(b){return p({metricId:"Service::StillReadingCall",url:c("stillReading",b)})},updateAnnotations:function(b,a){var c=D+"updateAnnotations",h={Operation:"updateAnnotations",Input:{annotations:b,localTimeOffset:a}},m=O.createTimer();return g(j(c,h)).then(function(){m.emit("Service::UpdateAnnotationsCall")},
function(){m.emitNow("Service::UpdateAnnotationsCallFail")})},uploadMetrics:k,uploadSnapshot:function(b){b=A+"uploadSnapshot?snapshot="+encodeURIComponent(b.response);return p({metricId:"Service::UploadSnapshotCall",url:b})},whenOnline:function(){var b=jQuery.Deferred();if(KindleNetwork.isOnline())b.resolve();else{var a=function(){KindleNetwork.removeEventListener("online",a);b.resolve()};KindleNetwork.addEventListener("online",a)}return b.promise()}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.SERVICE_CLIENT,
[Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,KindleModuleManager.METRICS_MANAGER,Kindle.MODULE.DB_CLIENT],function(c,h,m){var u=jQuery.Deferred();O=h;M=m.getAppDb();var k,n;r=c.hostApp;if(c.loginParams)P=c.loginParams.dsn,H=!!c.loginParams.useSignedServiceRequests,L=c.loginParams.qaMetricsUrl,k=c.loginParams.hostName,n=c.loginParams.srsBasePath;b=KindleApp.isHostControlled()?KindleVersion.parseVersionString(c.hostVersion):KindleVersion.getVersionNumber();KindleNetwork.initialize();window.addEventListener("beforeunload",
e,!1);H?M.getUserHashId().always(function(b){b&&c.loginParams.clientHashId&&b!==c.loginParams.clientHashId?d(Kindle.Service.AuthUserMismatch):d(Kindle.Service.AuthOK);a({useSignedServiceRequests:!0,srsHostName:k,srsBasePath:n});u.resolve(S)}):(n&&a({srsBasePath:n}),v().then(function(b){d(b?Kindle.Service.AuthOK:Kindle.Service.NotAuth);u.resolve(S)},u.reject));return u});KindleModuleManager.define(Kindle.MODULE.METRICS_UPLOADER,[],function(){return{uploadMetrics:k}})}}}(),KindleTOS=function(){function a(){var b=
"https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+B+"/BrowserHost-min.js",a=$.Deferred();if(typeof BrowserHostAPI!=="undefined")return a.resolve().promise();$.getScript(b,function(){typeof BrowserHostAPI!=="undefined"?a.resolve():a.reject()});return a.promise()}function e(){var b=new jQuery.Deferred,a={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:KindleHostDeviceDetector.getDeviceType(),bhv:B};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(c){c.getEID().then(function(c){a.eid=
c;b.resolve("?"+$.param(a))},function(){KindleDebug.error("Couldn't fetch EID.");b.reject("?"+$.param(a))})},function(){KindleDebug.error("SRS not loaded");b.reject("?"+$.param(a))});return b.promise()}function d(){function b(a){var c=k?"&asin="+encodeURIComponent(k):"",a=F+a+c+"&ref_="+(k?"kcr_store_sample":D?"kcr_store_emptylib_ipad":"kcr_store_libbutton_ipad"),c=KindleApp.getPartnerTag();a+=c?"&tag="+c:"";t&&$("#"+s.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();c=new Date;t=$(document.createElement("iframe")).attr("id",
s.KINDLE_STORE_ID+c.getTime()).attr("src",a).attr("seamless","seamless").addClass(v);$("#"+s.KINDLE_STORE_CONTAINER_ID).append(t)}e().then(b,b)}function l(){$("#"+s.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();A=t=null;E=!0;z&&z()}function f(){var b=$.Deferred();a().then(function(){var a={hostVersion:w,storeStartTime:K,deviceType:KindleHostDeviceDetector.getDeviceType()};BrowserHost=new K4WBrowserHost(a,{pageReady:o,closeStore:j,openBook:g,bookStatus:q,openInExternalBrowser:p});b.resolve()},
b.reject);return b.promise()}function o(){clearTimeout(n);$("#"+s.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");c.resolve(!1)}function j(){l()}function g(a){if(E){E=!1;var c=a.type,a=a.asin;if(I)switch(c){case b.EBOOK:I({asin:a,isSample:!1});l();break;case b.SAMPLE:I({asin:a,isSample:!0}),A=a,$("#"+s.KINDLE_STORE_CONTAINER_ID).hide(),z&&z()}}}function q(b){return{id:b,status:1,percentDownloaded:1}}function p(b){clearTimeout(n);c.resolve(!0);var a=document.createElement("a");a.href=b;a.target="_blank";
b=document.createEvent("MouseEvents");b.initEvent("click",!0,!0);a.dispatchEvent(b)}var t,s={KINDLE_STORE_ID:"store",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},v="KindleIFrame",w=3,n,c,k,K,D,F="https://www.amazon.com/gp/kindle/kcp/tos.html",B="015",I,z,A,E=!0,b={EBOOK:"EBOK",SAMPLE:"EBSP"};return{open:function(b){c=$.Deferred();k=b.asin;K=b.storeStartTime;D=b.isSourceEmptyLibBtn;if(k&&k===A&&t)return $("#"+s.KINDLE_STORE_CONTAINER_ID).show(),c.resolve(!1),c.promise();f().then(function(){n=
setTimeout(function(){c.reject();l()},3E4);d()},c.reject);return c.promise()},setOpenBookCallback:function(b){I=b},setStoreClosedCallback:function(b){z=b},setOpenBookReady:function(){E=!0},setStoreURL:function(b){F=b}}}(),KindleUpgradeDeviceDetector=function(){function a(a,d,l){a=KindleVersion.parseVersionString(a);return KindleVersion.parseVersionString(d)<=a&&a<=KindleVersion.parseVersionString(l)}return{isMetroUpdateRequiredBecauseVersionNonSupported:function(e){if(!KindleHostDeviceDetector.isMetro())return!1;
var d=!!KindleHostDeviceDetector.isOnline();return e&&d?a(e,"0.0.0.0","1.1.3.1"):!1},isMetroUpdateRequiredBecauseI18NSupported:function(e,d){if(!KindleHostDeviceDetector.isMetro())return!1;var l=!!KindleHostDeviceDetector.isOnline();return["de","es","it","fr","pt"].indexOf((d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2))>-1&&e&&l?a(e,"1.0.2.0","1.0.2.99"):!1},isMetroUpdateRequiredBecauseCountryNotSupported:function(e,d,l){var f=jQuery.Deferred(),o=!!KindleHostDeviceDetector.isOnline(),
d=(d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2);if(!KindleHostDeviceDetector.isMetro()||!o||!a(e,"1.0.2.0","1.0.2.99"))return f.resolve(!1).promise();e="/kcrservice/checkBLCountry?lang="+d;l&&(e+="&ip="+l);$.ajax({url:e,dataType:"json"}).then(function(a){f.resolve(a?a.value:!1)},function(){f.resolve(!1)});return f.promise()}}}();
Kindle.URL=function(){function a(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname}function e(a){for(var d={},a=a.split("&"),n=0;n<a.length;n++){var c;c=a[n].split("=");var k=c[0],f="";c.length>1&&(f=c[1]);c={key:k,value:f};c.key&&(d[c.key]=decodeURIComponent(c.value))}return d}function d(a){var d=a;a.indexOf("?")===0&&a.length>1&&(d=a.substring(1));return d}function l(a){var d="";a&&(d+="?"+a);return d}function f(a){var d={},n;for(n in a)p.indexOf(n)>
-1&&(d[n]=a[n]);return d}function o(a){var d=g();d.hasOwnProperty(a)&&delete d[a];a=$.param(d);a=l(a);j(a)}function j(a){a=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+a+window.location.hash;if(window.history.replaceState)try{window.history.replaceState(document.title,document.title,a)}catch(d){}}function g(){var a={},j=window.location.search;j&&(a=d(j),a=e(a));return a=f(a)}function q(){var a=g(),d=a[t];if(d){var d=decodeURIComponent(d),d=e(d),
n;for(n in d)a[n]=d[n];delete a[t]}return a}var p=["basePath","srsBasePath","useNewPath","key","bucket","version","maxDBSize","useProdBucket","ref_","siteState","kcrFree","autoHide","tag","language","stringIDMode","region","host","hostVersion","clear","asin","library","ip","rwis"],t="siteState",s;return{normalizeQueryString:function(){var a=q(),a=$.param(a),a=l(a);j(a)},removeQueryParameter:o,removeAllQueryParameters:function(){var a=g(),d;for(d in a)a.hasOwnProperty(d)&&o(d)},removeASIN:function(){o("asin")},
addSavedStateToQueryParameters:function(){var a=q();if(s)for(var d in s)a[d]=s[d];a=$.param(a);a=l(a);j(a)},getQueryParameters:g,getFragIdParameters:function(){var a={};window.location.hash.length>0&&window.location.hash.substring(1).split("&").forEach(function(d){d=d.split("=");d.length===2&&(a[d[0]]=decodeURIComponent(d[1]))});return a=f(a)},getBaseURL:a,getHostURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port},getBasePathURL:function(){return a().replace(/[^\/]*\.html$/,
"")},getLandingPageURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port+"/about"},getSiteState:function(){var a="",f=window.location.search,f=f||"",n;for(n in s)f&&(f+="&"),f+=n+"="+s[n];f&&(f=d(f),n=encodeURIComponent(f),a+=t+"="+n);return a},addToSavedSiteState:function(a){s||(s={});for(var d in a)s[d]=a[d]}}}();
var ResourceBundle=function(a,e){function d(a){if(j[a])return a;if(a.length===2)return s[a];var d=s[a.substr(0,2).toLowerCase()];if(d)return d;KindleDebug.error("No strings for lanuguage: "+a);return"en-US"}function l(a){a=a.toUpperCase();g[a]?t=a:KindleDebug.error("No formats for region: "+a)}function f(a,d){function f(a,c){var n=d[c];delete d[c];return n}for(var n=/\$\{([A-Za-z0-9_]+)\}/g,d=$.extend({},d),j;n.exec(a)&&j!==a;)j=a,a=a.replace(n,f);return a}function o(a){return a.substr(3,2).toUpperCase()}
var j=a,g=e,q=!1,p="en-US",t="US",s={de:"de-DE",en:"en-US",es:"es-ES",fr:"fr-FR",it:"it-IT",pt:"pt-BR"},v=function(a,d){if(q)return a;if(j[d])return j[d][a]},w={en:["the ","a ","an "],de:["die ","der ","das ","des ","dem ","den ","ein ","eine ","einer ","einem ","einen "],es:["el ","la ","los ","las ","un ","una ","unos ","unas "],pt:["o ","a ","os ","as ","um ","uma ","uns ","umas "],fr:["le ","la ","l'","les ","un ","une ","des "],it:["il ","lo ","la ","l'","i ","gli ","le ","un ","uno ","una ",
"un'"]},n={da:["og","i","jeg","det","at","en","den","til","er","som","p\u00e5","de","med","han","af","for"],de:["der","die","das","des","dem","den","ein","eine","einer","einem","einen","dies","diese","diesem","diesem","diesen","dieser","dieses","ich","du","er","sie","es","wir","ihr","sie","Sie","als","an","ans","auch","auf","aufs","aus","bei","fuer","f\u00fcr","nicht","nur","oder","so","und","um","ums","vom","von","in","im"],en:["the","a","an","this","that","these","those","i","you","she","he","it",
"we","they","as","like","at","to","also","on","of","by","for","not","only","or","so","and","about","from","in"],es:["el","la","los","las","un","una","unos","unas","del","al","este","ese","aquel","estos","esos","aquellos","esta","esa","aquella","estas","esas","aquellas","yo","t\u00fa","tus","vos","usted","\u00e9l","ella","ello","nosotros","nosotras","vosotros","vosotras","ustedes","ellos","ellas","en","y","o","a","por","no","ni","desde","e"],fi:["olla","olen","olet","on","olemme","olette","ovat","ole",
"se","sen","sit\u00e4","siin\u00e4","siit\u00e4","siihen","sill\u00e4","silt\u00e4","sille","sin\u00e4","siksi","kanssa"],fr:["le","la","l'","les","un","une","des","du","de","au","aux","ce","cet","cette","ces","je","tu","elle","il","on","nous","vous","elles","ils","comme","\u00e0","aussi","sur","par","pour","ne","n\u2019","pas","ou","or","donc","et","dans"],hu:["a","az","egy","be","ki","le","fel","meg","el","\u00e1t","r\u00e1","ide","oda","sz\u00e9t","\u00f6ssze","vissza","de","h\u00e1t","\u00e9s",
"vagy","hogy","van","lesz","volt","csak","nem","igen","mint","\u00e9n","te","\u00f5","mi","ti","\u00f5k","\u00f6n"],it:["il","lo","la","l'","i","gli","le","un","uno","una","un'","del","dello","della","dell'","dei","degli","degl'","delle","questo","questa","questi","queste","quello","quella","quelli","codesto","codesta","codesti","codeste","io","noi","tu","voi","egli","esso","essi","ella","essa","esse","ad","al","allo","agli","all","agl","alla","alle","con","col","coi","da","dal","dallo","dai","dagli",
"dall","dagl","dalla","dalle","di","del","dello","dei","degli","dell","degl","della","delle","in","nel","nello","nei","nell","negl","nella","nelle","su","sul","sullo","sui","sugli","sull","sugl","sulla","sulle","per","ed","anche","non","a","e","o"],nl:["de","en","van","ik","te","dat","die","in","een","hij","het","niet","zijn","is","was","op","aan","met","als","voor","had","er"],no:["at","en","et","den","til","er","p\u00e5","med","han","av","var","ved","fra","bli","ble","blei","blitt","v\u00e6re",
"kom","for","\u00e5","blir","v\u00e6rt","v\u00e6re","d\u00e5","ein","eit","eitt","vere","vore","verte","vort","varte","vart"],pt:["o","a","os","as","um","uma","uns","umas","esta","estes","estas","aquele","aquela","aqueles","aqueles","aquelas","isto","aquilo","eu","voc\u00ea","ele","ela","n\u00f3s","v\u00f3s","voc\u00eas","eles","elas","de","a","e","em","para","n\u00e3o","no","na","por","como","ou"],ro:["o","unui","unei","unor","cel","cea","cei","cele","celui","celei","celor","al","a","ai","ale","pe",
"la","\u00een","f\u0103r\u0103","sub","despre","c\u0103tre","cu","de","din","l\u00e2ng\u0103","spre","ca","sunt","s","e\u015fti","este","e","suntem","sunte\u0163i","eram","erai","era","era\u0163i","erau","fiu","fii","fie","fim","fi\u0163i","fi","fiind","fost"],sv:["och","det","att","i","en","jag","hon","som","han","p\u00e5","den","med","var","sig","f\u00f6r","s\u00e5","till","\u00e4r","men","ett","om","hade","de","av"],tr:["acaba","altm\u00fd\u00fe","alt\u00fd","ama","bana","baz\u00fd","belki","ben",
"benden","beni","benim","be\u00fe","bin","bir","biri","birka\u00e7","birkez","bir\u00feey","bir\u00feeyi","biz","bizden","bizi","bizim","bu","buna","bunda","bundan","bunu","bunun","da","daha","dahi","de","defa","diye","doksan","dokuz","d\u00f6rt","elli","en","gibi","hem","hep","hepsi","her","hi\u00e7","iki","ile","INSERmi","ise","i\u00e7in","katrilyon","kez","ki","kim","kimden","kime","kimi","k\u00fdrk","milyar","milyon","mu","m\u00fc","m\u00fd","nas\u00fdl","ne","neden","nerde","nerede","nereye",
"niye","ni\u00e7in","on","ona","ondan","onlar","onlardan","onlari","onlar\u00fdn","onu","otuz","sanki","sekiz","seksen","sen","senden","seni","senin","siz","sizden","sizi","sizin","trilyon","t\u00fcm","ve","veya","ya","yani","yedi","yetmi\u00fe","yirmi","y\u00fcz","\u00e7ok","\u00e7\u00fcnk\u00fc","\u00fc\u00e7","\u00feey","\u00feeyden","\u00feeyi","\u00feeyler","\u00feu","\u00feuna","\u00feunda","\u00feundan","\u00feunu"]};return{setLanguageCultureAndRegion:function(a,k){a&&(p=d(a));k?l(k):!k&&a&&
a.length>=5&&l(o(a))},getFormatRegion:function(){return t},getLanguage:function(){return p},getLocalizedString:function(a,k,n){var j=p;n&&(j=d(n));n=v(a,j);typeof n!=="string"&&(j!=="en_US"&&(n=v(a,"en_US")),n||(n=a));k&&(n=f(n,k));return n},getLocalizedTime:function(a){return $.format.date(a,g[t].k_format_time)},getLocalizedDate:function(a){return $.format.date(a,g[t].k_format_date)},getLocalizedDateTime:function(a){return $.format.date(a,g[t].k_format_date_time)},getLocalizedArticles:function(){return w[p.substr(0,
2).toLowerCase()]},getLocalizedSearchStopWords:function(a){a=a||p.substr(0,2).toLowerCase();return n[a]},setStringIDMode:function(a){q=!!a},languageCultureNameToRegion:o}}(Kindle.strings,Kindle.formats);
BexBrowserHostSerializer={postObjectToHost:function(a,e){window.parent.postMessage({method:a,param:e},"*")},postObjectToBookExtras:function(a,e){var d={method:a,param:e};$('iframe[id^="bex"]')[0].contentWindow.postMessage(d,"*")},receiveMessage:function(a){if(a.origin.match(/\.amazon\.com:?\d*$/)&&BexBrowserHost[a.data.method])BexBrowserHost[a.data.method](a.data.param)}};window.addEventListener("message",BexBrowserHostSerializer.receiveMessage,!1);
BexK4WBrowserHost=function(){return function(a,e){this.onBookExtrasReady=function(){e.onBookExtrasReady()};this.closeBookExtras=function(){e.closeBookExtras()};this.openStoreFromBex=function(a){e.openStoreFromBex(a)};this.logMetric=function(a){e.logMetric(a)};this.logBexStatus=function(a){e.logBexStatus(a)};this.onOrientationChanged=function(){setTimeout(function(){BexBrowserHostSerializer.postObjectToBookExtras("onOrientationChanged",{screenWidth:Kindle.top.innerWidth,screenHeight:Kindle.top.innerHeight})},
500)}}}();
BexBrowserHost=function(){return function(){this.pageReady=function(){BexBrowserHostSerializer.postObjectToHost("onBookExtrasReady")};this.closeBookExtras=function(){BexBrowserHostSerializer.postObjectToHost("closeBookExtras")};this.openStoreFromBex=function(a){BexBrowserHostSerializer.postObjectToHost("openStoreFromBex",a)};this.logMetric=function(a){BexBrowserHostSerializer.postObjectToHost("logMetric",a)};this.logBexStatus=function(a){BexBrowserHostSerializer.postObjectToHost("logBexStatus",a)};
this.onOrientationChanged=function(){}}}();
var KindleO_Aaa=function(){function a(a){for(var d=[],c,k,j,g,e,l,q=0;q<a.length;)j=a.charCodeAt(q++)&255,c=a.charCodeAt(q++),g=c&255,k=a.charCodeAt(q++),e=k&255,l=j>>2,j=(j&3)<<4|g>>4,g=(g&15)<<2|e>>6,e&=63,isNaN(c)?g=e=64:isNaN(k)&&(e=64),d.push(f.charAt(l)+f.charAt(j)+f.charAt(g)+f.charAt(e));return d.join("")}function e(a){for(var d=[],c,k,f,j,g,e=0;e<a.length;)c=o[a.charCodeAt(e++)],k=o[a.charCodeAt(e++)],j=o[a.charCodeAt(e++)],g=o[a.charCodeAt(e++)],c=c<<2|k>>4,k=(k&15)<<4|j>>2,f=(j&3)<<6|g,
d.push(String.fromCharCode(c)),j!==64&&d.push(String.fromCharCode(k)),g!==64&&d.push(String.fromCharCode(f));return d.join("")}function d(a,d){var c=[];c.length=256;for(var k=0;k<256;k++)c[k]=k;for(var f=0,j,k=0;k<256;k++)f=f+c[k]+d[k%d.length]&255,j=c[k],c[k]=c[f],c[f]=j;for(var f=k=0,g=[],e=0;e<a.length;e++)k=k+1&255,f=f+c[k]&255,j=c[k],c[k]=c[f],c[f]=j,g.push(String.fromCharCode(a.charCodeAt(e)^c[c[k]+c[f]&255]));return g.join("")}function l(a,d){for(var c="",f=d?q:g,j=f.length,e=0;e<a;e++)c+=
f.charAt(Math.floor(Math.random()*j));return c}for(var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=[],j=0;j<f.length;j+=1)o[f.charCodeAt(j)]=j;for(var g="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",q=g+"                                             ",p=[],t=0;t<10;t++)p[t]=l(15,!1);var s=["p","span","div","em","i","strong","b","a","big","small"],v=!1;return{iToStr:function(a,d,c){var f=new Image;f.onload=function(){var a=
KindleHostDeviceDetector.isIE(),c=f.height,j=f.width,e=document.createElement("canvas").getContext("2d");e.drawImage(f,0,0);for(var g,q,l,p,b,h="",u=0,J,m=0;m<c;){g=e.getImageData(0,m,j,1);u=0;for(J=g.data.length-4;u<J;){q=g.data[u++]&7;l=g.data[u++]&3;p=g.data[u++]&7;u++;b=q*32+l*8+p;if(a){var r=void 0,r=0;b>=65&&b<=90||b>=50&&b<=55||b===0?r=b:(r=q>=2?-1:1,r=(q+r+8)%8*32+(l+r+4)%4*8+(p+r+8)%8);r>=65&&r<=90||r>=50&&r<=55||(r=0);b=r}if(b===0)break;h+=String.fromCharCode(b)}if(b===0)break;m++}d(h)};
f.onerror=function(){c()};f.src=a},o_aaa:a,o_aag:e,o_aac:function(f,n){var c;c=f.replace(/\x0d\x0a/g,"\n");for(var k=[],g=0;g<c.length;g++){var e=c.charCodeAt(g);e<128?k.push(String.fromCharCode(e)):(e>127&&e<2048?k.push(String.fromCharCode(e>>6|192)):(k.push(String.fromCharCode(e>>12|224)),k.push(String.fromCharCode(e>>6&63|128))),k.push(String.fromCharCode(e&63|128)))}c=k.join("");k=n;k+="00000000000000000000000000000000".substring(0,32-k.length);g=[];for(j=0;j<k.length;j+=2)g.push(parseInt(k.substring(j,
j+2),16));return a(d(c,g))},o_aad:function(a,f){for(var c=e(a),j=[],g=0;g<f.length;g++)j.push(f.charCodeAt(g));for(var c=d(c,j),j=[],g=0,q,l,p;g<c.length;)q=c.charCodeAt(g),q<128?(j.push(String.fromCharCode(q)),g++):q>191&&q<224?(l=c.charCodeAt(g+1),j.push(String.fromCharCode((q&31)<<6|l&63)),g+=2):(l=c.charCodeAt(g+1),p=c.charCodeAt(g+2),j.push(String.fromCharCode((q&15)<<12|(l&63)<<6|p&63)),g+=3);return j.join("")},o_aae:function(a){var d;if(!v){for(d=0;d<10;d++)$(p[d]).addClass("noDisplay");v=
!0}var c=$(a).html(),f=!1,j="",g=0;for(d=0;d<c.length;d++)if(c[d]===">")f=!1;else if(c[d]==="<")f=!0;else if(d%60===7&&!f){j+=c.substring(g,d);var g=d,e=s[Math.floor(Math.random()*s.length)];j+="<"+e+' class="'+p[Math.floor(Math.random()*p.length)]+'">'+l(30,!0)+"</"+e+">"}j+=c.substring(g,c.length);$(a).html(j)},o_aaf:function(a){a:{for(var d=0;d<p.length;d++)if(p[d]===a){a=!0;break a}a=!1}return a}}}(),KindleAppDb=function(a){function e(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}
function d(a){var d=new jQuery.Deferred;o.getRecord("keyValue",{key:a}).then(function(a){a&&a.length>0&&d.resolve(a[0].value);d.reject()},d.reject);return d.promise()}function l(a,d){return o.upsertRecord("keyValue",{value:d},{key:a})}function f(a){return o.deleteRecord("keyValue",{key:a})}var o=a;a.updateBookData=function(a,d,f){var l,t,s=[],v=[];for(l in a)v.push(a[l].asin),s.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a[l].asin}]});for(l in d)a=d[l],s.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,
tableName:"bookdata",params:[a,{asin:a.asin}]});t=s.length;f&&s.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(f)},{key:"synctime"}]});return o.batchTransaction(s).pipe(function(){function a(){return t}return v.length<1||!e()?(new jQuery.Deferred).resolve(t):e().deleteBooksData(v).pipe(a,a)})};a.getAllBooks=function(){return o.getRecord("bookdata")};a.getAllBooksForContentType=function(a){return o.getRecord("bookdata",{contentType:a})};a.getBook=function(a,
d){o.getRecord("bookdata",{asin:a}).done(function(a){d(a.length>0?a[0]:{})})};a.getBookDataLastSyncTime=function(a){d("synctime").done(function(d){a(d?d:Kindle.DB.NEVER)}).fail(function(){a(Kindle.DB.NEVER)})};a.updateLastPositionRead=function(a,d,f,e){o.updateRecord("bookdata",{lastPositionRead:d,lastTimeRead:f},{asin:a}).fail(e)};a.updateLastFPRSyncTime=function(a,d,f){o.updateRecord("bookdata",{lastFPRSyncTime:d},{asin:a}).fail(f)};a.updateLastReadTime=function(a,d,f,e){o.upsertRecord("bookdata",
{lastTimeRead:d,lastFPRSyncTime:f},{asin:a}).fail(e)};a.updateMaxPosition=function(a,d,f){o.updateRecord("bookdata",{maxPosition:d},{asin:a}).fail(f)};a.getBookExtras=function(a,d){var f=window.localStorage.getItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+a),f=[{isAvailable:parseInt(f,10),asin:a}];d(f)};a.updateBookExtras=function(a,d){window.localStorage.setItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+a,d)};a.getDeviceToken=function(){return d(Kindle.Service.DeviceTokenKey)};a.setDeviceToken=function(a){return l(Kindle.Service.DeviceTokenKey,
a)};a.clearDeviceToken=function(){return f(Kindle.Service.DeviceTokenKey)};a.getUserHashId=function(){return d(Kindle.Service.UserHashIdKey)};a.setUserHashId=function(a){return l(Kindle.Service.UserHashIdKey,a)};a.clearUserHashId=function(){return f(Kindle.Service.UserHashIdKey)};a.getEID=function(){return d(Kindle.Service.EidKey)};a.setEID=function(a){return l(Kindle.Service.EidKey,a)};a.clearEID=function(){return f(Kindle.Service.EidKey)};a.getValueForKey=d;a.setValueForKey=l;a.removeValueForKey=
f;a.getValuesForKeys=function(a){for(var d=[],f=new jQuery.Deferred,e=0;e<a.length;e++)d.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"keyValue",params:[{key:a[e]}]});o.batchTransaction(d).then(function(a){for(var d,e={},g=0;g<a.length;g++)if(a[g]&&a[g].length)d=a[g][0],e[d.key]=d.value;f.resolve(e)},f.reject);return f.promise()};a.getCachedAsins=function(a,d){function f(d){var e,g=[];for(e=0;e<d.length;e++)a.indexOf(d[e].cacheState)>=0&&g.push(d[e]);l.resolve(g)}var l=jQuery.Deferred();
if(e()){var o={asin:!0,cacheState:!0,cachedSize:!0,context:!!d};e().getRecord("bookinfo",null,o).then(a?f:l.resolve,l.reject)}else l.resolve([]);return l.promise()};a.getCachedCovers=function(){function a(f){var e,j={};for(e=0;e<f.length;e++)j[f[e].asin]=f[e].coverData;d.resolve(j)}var d=new jQuery.Deferred;e()?e().getRecord("covers",null).then(a,d.reject):a([]);return d.promise()};a.getBookCachedState=function(a){return e()?e().getRecord("bookinfo",{asin:a},{cacheState:!0}):(a=new jQuery.Deferred,
a.resolve([]),a.promise())};a.getPinnedSessionIds=function(){function a(d){var e,g=[];if(d)for(e=0;e<d.length;e++)g.push(d[e].context.kindleSessionId);f.resolve(g)}function d(){f.resolve([])}var f=new jQuery.Deferred;e()?e().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{context:!0}).then(a,d):f.resolve([]);return f.promise()};return a},KindleBookDb=function(a){function e(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;
case "desktop":return 5E8;default:return 5E8}}function d(a,c){var d={},f;for(f in a)a.hasOwnProperty(f)&&!c[f]&&(d[f]=a[f]);d=JSON.stringify(d);return d==="{}"?"":d}function l(a,c){if(c){var d=JSON.parse(c),f;for(f in d)d.hasOwnProperty(f)&&(a[f]=d[f])}return a}function f(a,c,d,f,m,r){var e=(new Date).getTime();z.getRecord(a,{asin:d,id:{operator:Kindle.DB.IN_ARRAY,values:f}}).then(function(a){c(a,e,m)},function(a){r(a)})}function o(a,c,d,f,m,r){(new Date).getTime();var e=0,k,g=[],n;for(n in f)k=c(d,
f[n]),e+=k.size,g.push(k);z.insertList(a,g).then(function(){(new Date).getTime();m(e)},function(a){r(a)})}function j(a,c,d,f){var m=KindleMetricsProfiler("getIds:"+a);z.getPieceIds(a,c).then(function(a){m.addCount(c,a.length);m.endTimer();m.log();d(a)},function(a){f(a)})}function g(a,c,d){(new Date).getTime();var c=[],f=0,m;for(m in a){var r=a[m],e=r.id;f+=r.piece.length+r.metadata.length;c[e]=l({fragmentData:r.piece,fragmentMetadata:JSON.parse(r.metadata)},r.other)}(new Date).getTime();d(c);(new Date).getTime()}
function q(a,c){var f=c.fragmentData,e=JSON.stringify(c.fragmentMetadata),m=d(c,{fragmentData:1,fragmentMetadata:1});return{asin:a,id:c.fragmentMetadata.id,size:f.length+e.length+m.length,piece:f,metadata:e,other:m}}function p(a,c,d){(new Date).getTime();var c=[],f;for(f in a){var m=a[f];c[m.id]=l({skeletonData:m.piece,skeletonMetadata:JSON.parse(m.metadata)},m.other)}(new Date).getTime();d(c)}function t(a,c){var f=c.skeletonData,e=JSON.stringify(c.skeletonMetadata),m=d(c,{skeletonData:1,skeletonMetadata:1});
return{asin:a,id:c.skeletonMetadata.id,size:f.length+e.length+m.length,piece:f,metadata:e,other:m}}function s(a,c,d){(new Date).getTime();var c=[],f=0,m;for(m in a){var e=a[m],k=e.id;f+=e.piece.length+e.metadata.length;c[k]=l({glyphData:JSON.parse(e.piece),glyphFragmentMetadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();d(c);(new Date).getTime()}function v(a,c){var f=JSON.stringify(c.glyphData),e=JSON.stringify(c.glyphFragmentMetadata),m=d(c,{glyphData:1,glyphFragmentMetadata:1});return{asin:a,
id:c.glyphFragmentMetadata.id,size:f.length+e.length+m.length,piece:f,metadata:e,other:m}}function w(a,c,d){(new Date).getTime();var c=[],f=0,m;for(m in a){var e=a[m],k=e.id;f+=e.piece.length+e.metadata.length;c[k]=l({data:JSON.parse(e.piece),metadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();d(c);(new Date).getTime()}function n(a,c){var f=JSON.stringify(c.data),e=JSON.stringify(c.metadata),m=d(c,{data:1,metadata:1});return{asin:a,id:c.metadata.id,size:f.length+e.length+m.length,piece:f,
metadata:e,other:m}}function c(a,c,d){(new Date).getTime();var c=[],f=0,m;for(m in a){var e=a[m],k=e.id;f+=e.piece.length+e.metadata.length;c[k]=l({locations:JSON.parse(e.piece),metadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();d(c);(new Date).getTime()}function k(a,c){var f=JSON.stringify(c.locations),e=JSON.stringify(c.metadata),m=d(c,{locations:1,metadata:1});return{asin:a,id:c.metadata.id,size:f.length+e.length+m.length,piece:f,metadata:e,other:m}}function K(a){return z.dbDeleteBooksData(a)}
function D(a){return z.dbGetBookStatistics(a)}function F(){var a=new jQuery.Deferred;z.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(c){var d=0,f;for(f in c)d+=c[f].cachedSize;a.resolve(d)},function(){a.reject()});return a.promise()}function B(){var a=new jQuery.Deferred;F().then(function(c){c=e()-1E6-c*2.4;c=Math.round(c/2.4);a.resolve(c)},function(){a.resolve(0)});return a.promise()}function I(b){function d(){var a=new jQuery.Deferred;B().then(function(b){l=
b;a.resolve(b)},function(){l=0;a.resolve()});return a.promise()}var e=0,l=0;return{getFragments:function(a){var c=new jQuery.Deferred;f("fragments",g,b,a,c.resolve,c.reject);return c.promise()},putFragments:function(a){var c=new jQuery.Deferred;o("fragments",q,b,a,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getFragmentIds:function(){var a=new jQuery.Deferred;j("fragments",b,a.resolve,a.reject);return a.promise()},getSkeletons:function(a){var c=new jQuery.Deferred;f("skeleton",p,b,
a,c.resolve,c.reject);return c.promise()},putSkeletons:function(a){var c=new jQuery.Deferred;o("skeleton",t,b,a,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getSkeletonIds:function(){var a=new jQuery.Deferred;j("skeleton",b,a.resolve,a.reject);return a.promise()},getGlyphs:function(a){var c=new jQuery.Deferred;f("glyphs",s,b,a,c.resolve,c.reject);return c.promise()},putGlyphs:function(a){var c=new jQuery.Deferred;o("glyphs",v,b,a,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},
getGlyphIds:function(){var a=new jQuery.Deferred;j("glyphs",b,a.resolve,a.reject);return a.promise()},getResources:function(a){var c=new jQuery.Deferred;f("resources",w,b,a,c.resolve,c.reject);return c.promise()},putResources:function(a){var c=new jQuery.Deferred;o("resources",n,b,a,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getResourceIds:function(){var a=new jQuery.Deferred;j("resources",b,a.resolve,a.reject);return a.promise()},getLocationMaps:function(a){var d=new jQuery.Deferred;
f("locations",c,b,a,d.resolve,d.reject);return d.promise()},putLocationMaps:function(a){var c=new jQuery.Deferred;o("locations",k,b,a,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getLocationMapIds:function(){var a=new jQuery.Deferred;j("locations",b,a.resolve,a.reject);return a.promise()},getAnnotations:function(){return z.getRecord("annotationsCache",{asin:b},{annotationsData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].annotationsData})},putAnnotations:function(a){return z.insertRecord("annotationsCache",
{asin:b,annotationsData:a})},getBookInfo:function(){var a=new jQuery.Deferred;z.getRecord("bookinfo",{asin:b}).then(function(b){b.length===1?(e=b[0].cachedSize||0,a.resolve(b[0])):a.reject()},a.reject);return a.promise()},insertBookInfo:function(a){a=$.extend(!0,{},a,{asin:b,openTime:(new Date).getTime()});return z.insertRecord("bookinfo",a)},updateBookInfo:function(a){a=$.extend({openTime:Date.now()},a);return z.updateRecord("bookinfo",a,{asin:b})},getBookStatistics:function(){var a=new jQuery.Deferred;
D(b).then(function(c){c.totalSize!==c.cachedSize?(e=c.cachedSize=c.totalSize,z.updateRecord("bookinfo",{cachedSize:e},{asin:b}).then(function(){a.resolve(c)},a.reject)):a.resolve(c)},a.reject);return a.promise()},getCacheQuota:function(){return{cachedSize:e,cacheQuota:l}},computeCacheQuota:function(){return d().promise()},deleteOldestBookData:function(b){return a.deleteOldestBookData(b)},deleteBooksData:function(b){return a.deleteBooksData(b)},deleteSearchIndex:function(){return z.deleteRecord("searchIndex",
{asin:b})},getPageNumbers:function(){return z.getRecord("pageNumberCache",{asin:b},{pageNumberData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].pageNumberData})},putPageNumbers:function(a){return z.insertRecord("pageNumberCache",{asin:b,pageNumberData:a})},getSearchIndex:function(){return z.getSearchIndexData(b)},putSearchIndex:function(a){return z.putSearchIndexData(b,a)},reserveStorage:function(a){function b(){h=setTimeout(function(){h=null;z.dropTable(d)},1E3)}function c(){var a=new ArrayBuffer(f*
1024),a=new Blob([a]);z.insertRecord(d,{asin:"0000000000",id:e,data:a}).then(function(){h&&(clearTimeout(h),--e>0?(b(),c()):z.dropTable(d))},function(){h&&(clearTimeout(h),z.dropTable(d))})}var d="reservedStorage",f=100,e=a*1024/f,h;b();c()},getFilteredSearchIndexAsins:function(a){var b=$.Deferred();z.getRecord("searchIndex",{asin:{operator:Kindle.DB.IN_ARRAY,values:a}},{asin:!0}).then(function(a){a=a.map(function(a){return a.asin}).sort().filter(function(a,b,c){return b===0||c[b-1]!==c[b]});b.resolve(a)},
b.reject);return b.promise()}}}var z=a,A=null,E=0;a.deleteBooksData=K;a.deleteOtherBooksData=function(a){for(var c=new jQuery.Deferred,d=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers","searchIndex","pageNumberCache"],f=[],e=0;e<d.length;e++)f.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:d[e],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]}}]});z.batchTransaction(f).then(function(){c.resolve()},function(a){c.reject(a)});return c.promise()};a.deleteOldestBookData=
function(a){function c(){A.resolve(arguments);A=null}function d(){A.reject(arguments);A=null}function f(e){function k(a){for(var b=function(){return a&&a.length>0?e.filter(function(b){return a.indexOf(b.asin)>=0}):e}(),c=b[0],d=1;d<b.length;d++)b[d].openTime<c.openTime&&(c=b[d]);return c.asin}function g(){K([k()]).then(c,d)}if(!e||e.length===0)KindleHostDeviceDetector.isIE()&&E===0?(c(),E++):(KindleDebug.warn("trying to delete oldest asin, but got no list of books"),E=0,d());else{E=0;var n=e.map(function(a){return a.asin});
I(a).getFilteredSearchIndexAsins(n).done(function(a){a&&a.length>0?I(k(a)).deleteSearchIndex().then(c,d):g()}).fail(g)}}A||(A=new jQuery.Deferred,z.getOldBookList(a).then(f,d));return A};a.getBookStatistics=D;a.updateBookInfos=function(a){var c=[],d;for(d in a){var f={},e;for(e in a[d])f[e]=a[d][e];c.push({operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[f,{asin:d}]})}return z.batchTransaction(c)};a.BookInfoDB=I;return a},KindleDBClient=function(){function a(){if(!D)throw{name:"databaseInitializationError",
message:"Please call initialize function first"};}function e(a){var b=$.extend({appDb:B},a);k.callEventListeners(a.type,b)}function d(a){var b=$.extend({bookDb:I},a);k.callEventListeners(a.type,b)}function l(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject,b.notify):b.resolve();return b.promise()}function f(a){if(F)return F.promise();F=new jQuery.Deferred;H.initDfd=new jQuery.Deferred;var b=KindleStubDBWrapper(O);s(!1);b.createTables(M,H.version).then(function(){j(b);
KindleAppDb(b);H.wrapper=b;H.initDfd.resolve(b);z=B=b;D=!0;F.resolve(a)},function(a){F.reject(a)});return F.promise()}function o(){function a(){++e===f&&(z=null,KindleStubDBWrapper(O).dropTables(),c.resolve())}function b(d){return function(b){var f=[],e;for(e in b)f.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:d,params:[b[e],b[e]]});B.batchTransaction(f).then(a,c.reject)}}var c=new jQuery.Deferred;if(!z)return c.resolve(),c.promise();var d=z.getTableNames(),f=d.length,e=0,h;for(h in d)z.getRecord(d[h]).then(b(d[h]),
c.reject);return c.promise()}function j(a){function b(c){return{tableName:c,insertRecord:function(b){return a.insertRecord(c,b)},insertList:function(b){return a.insertList(c,b)},updateRecord:function(b,d){return a.updateRecord(c,b,d)},getRecord:function(b,d){return a.getRecord(c,b,d)},deleteRecord:function(b){return a.deleteRecord(c,b)},batchTransaction:function(b){var d;for(d=0;d<b.length;d++)b[d].tableName=c;return a.batchTransaction(b)}}}var c=a.getTableNames(),d,f;for(f in c)d=c[f],P[d]=b(d);
a.getTable=function(a){return P[a]}}function g(a){a.onversionchange=function(){H.handle&&H.handle.close();L.handle&&L.handle.close();setTimeout(function(){function a(){window.location.reload(!0)}_metricsManager.emitNow("App::DatabaseGoneOnVersionZero",{breakdown:["Browser"]}).then(a,a)},500)}}function q(){function a(){j(b);KindleAppDb(b);H.wrapper=b;H.initDfd.resolve(b)}var b={};if(!H.initDfd)H.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(H),b.flavor=
"websql",b.openDatabase().then(function(b){H.handle=b;a();window.localStorage.setItem("haveDB","1")},H.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(H),b.flavor="IndexedDB",b.openDatabase().done(function(b){g(b);H.handle=b;window.localStorage.setItem("haveDB","1");a()}).fail(H.initDfd.reject)):f(this);return H.initDfd.promise()}function p(){function a(){j(b);KindleBookDb(b);L.wrapper=b;L.initDfd.resolve(b)}var b={};if(!L.initDfd){L.initDfd=new jQuery.Deferred;
try{KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(L),b.openDatabase().then(function(c){L.handle=c;a(b)},L.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(L),b.openDatabase().done(function(b){g(b);L.handle=b;a()}).fail(L.initDfd.reject)):L.initDfd.reject("nodb")}catch(c){L.initDfd.reject()}}return L.initDfd.promise()}function t(){if(KindleHostDeviceDetector.isChromeApp())return!0;if((KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&
window.localStorage.getItem("haveDB"))return!0;var a=window.localStorage.getItem("booksdb");if(a==="true")return!0;else if(a==="false")return!1}function s(a){window.localStorage.setItem("booksdb",a?"true":"false")}function v(){var a;a=new jQuery.Deferred;if(I)return a.resolve(I),a.promise();var b;b=!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0;if(!b)return a.reject(),
a.promise();L.initDfd=null;p().then(function(b){I=b;s(!0);a.resolve(I)},function(){s(!1);a.reject()});return a.promise()}function w(){var a;a=new jQuery.Deferred;if(B&&B!==z)return a.resolve(B).promise();H.initDfd=null;q().then(function(b){B=b;a.resolve(B)},function(){a.reject()});return a.promise()}function n(){function a(){B=z;window.localStorage.removeItem("haveDB");E=A.memAppDb}function b(){E=A.dbBookDb}function c(d){return o().pipe(function(){B=d;z=null;window.localStorage.removeItem(O);E=A.dbAppDb;
return v().pipe(b)},a)}var d;switch(E){case A.dbBookDb:d=$.Deferred().resolve();break;case A.dbAppDb:d=v().pipe(b);break;case A.memAppDb:d=w().pipe(c,a)}return d.promise()}function c(){function a(b,c){B=b;E=(I=c)?A.dbBookDb:A.dbAppDb;D=!0;K.resolve(S)}function b(c){$.when(t()?p():null).then(function(b){E=A.dbBookDb;a(c,b)},function(){E=A.dbAppDb;a(c,null)})}function c(){E=A.memAppDb;f(S).done(K.resolve)}if(!K)K=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()?
window.localStorage.getItem("haveDB"):1)?q().then(b,c):(E=A.memAppDb,f(S).done(K.resolve));return K.promise()}var k=ListenerManager(),K=null,D=!1,F=null,B=null,I=null,z=null,A={none:"none",memAppDb:"memAppDb",dbAppDb:"dbAppDb",dbBookDb:"dbBookDb"},E=A.none,b=Kindle.DB.TEXT_TYPE,h=Kindle.DB.NUMBER_TYPE,u=Kindle.DB.OBJECT_TYPE,J=Kindle.DB.BLOB_TYPE,m=Kindle.DB.ALLOW_NULL,r=Kindle.DB.PRIMARY_KEY,N=Kindle.DB.PIECE_ID_TYPE,O="app_db_storage",M={bookdata:{asin:b|r,contentType:b|m,title:b|m,authors:u|m,
purchaseDate:h|m,maxPosition:h|m,lastTimeRead:h|m,lastPositionRead:h|m,lastFPRSyncTime:h|m},keyValue:{key:b|r,value:b|m},metrics:{method:b,time:h,timers:u|m,counters:u|m,breakDown:u|m},journal:{id:Kindle.DB.AUTO_INCREMENT,entry:u}},b={bookinfo:{asin:b|r,cacheState:b|Kindle.DB.SECONDARY_KEY,cachedSize:h|m,openTime:h,context:u,metadata:u,manifest:u,fragmap:u},skeleton:{asin:b|r,id:h|r|N,size:h,piece:b,metadata:b,other:b},fragments:{asin:b|r,id:h|r|N,size:h,piece:b,metadata:b,other:b},glyphs:{asin:b|
r,id:h|r|N,size:h,piece:b,metadata:b,other:b},resources:{asin:b|r,id:h|r|N,size:h,piece:b,metadata:b,other:b},locations:{asin:b|r,id:h|r|N,size:h,piece:b,metadata:b,other:b},annotationsCache:{asin:b|r,annotationsData:u},covers:{asin:b|r,coverData:b},searchIndex:{asin:b|r,component:b|r,data:J},pageNumberCache:{asin:b|r,pageNumberData:u},reservedStorage:{asin:b|r,id:b|r,data:J}},P={},H={shortName:"K4W",version:2,displayName:"Kindle Cloud Reader",defaultSize:5E6,initDfd:null,wrapper:null,handle:null,
tables:M,versionUpdate:[{version:2,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["contentType"]},{version:2,tableName:"bookdata",operation:Kindle.DB.UPDATE_RECORD_OPERATION,params:[{contentType:"EBOK"}]}]},L={shortName:"K4Wbooks",version:7,displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,handle:null,tables:b,versionUpdate:[{version:4,tableName:"bookinfo",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["manifest"]},{version:5,tableName:"searchIndex",
operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[b.searchIndex]},{version:6,tableName:"pageNumberCache",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[b.pageNumberCache]},{version:7,tableName:"reservedStorage",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[b.reservedStorage]}]},S={enableFullDb:function(){return n(this)},getAppDb:function(){a();return B},getBookDb:function(){a();return I},bookDbEnabled:t,persistDB:function(){B&&B.persist&&B.persist();I&&I.persist&&I.persist()},clear:function(a,
b){function c(){H.wrapper=null;B=H.initDfd=null;L.wrapper=null;z=I=L.initDfd=null;D=!1;F=_initializeFullDeferred=null;d.resolve()}var d=new jQuery.Deferred;(function(){function a(b){b=Number(b)||0;d.notify({clearDbAttempts:b});return H.wrapper.setValueForKey("clearDbAttempts",b+1)}return H.wrapper.getValueForKey("clearDbAttempts").pipe(a,a)})().always(function(){l(H).then(function(){l(L).then(c,d.reject)},d.reject,d.notify)});d.then(a,b);return d.promise()},addEventListener:function(a,b){B&&B.addEventListener&&
B.addEventListener(a,e);I&&I.addEventListener&&I.addEventListener(a,d);k.addEventListener(a,b)},removeEventListener:function(a,b){k.removeEventListener(a,b)}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.DB_CLIENT,[Kindle.MODULE.APPLICATION_ARGS],c)}}}();
function KindleIDBWrapper(a){function e(a,b){b=b||{};b.type=b.type||a;N.callEventListeners(a,b)}function d(a){if(!r[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function l(){var a=[],b;for(b in r)a.push(b);return a}function f(a,b,c){if(r[a].info[b]&Kindle.DB.PIECE_ID_TYPE){for(a=""+c;a.length<h;)a="0"+a;return a}else return c}function o(a,c){if(a&&c){d(c);var e=r[c],h="";if(e.genKeyPath)for(var e=e.keyList,m=0;m<e.length;++m){if(a[e[m]]===void 0){h=void 0;break}h+=
f(c,e[m],a[e[m]]);m<e.length-1&&(h+=b)}else h=a[e.keyPath];return h}}function j(a,c,d){for(var e="",h,m,k=0;k<c.length;++k){h=c[k];m=d[h];if(!m)break;m=m.hasOwnProperty(Kindle.DB.OPERATOR)?m[Kindle.DB.VALUES][0]:m;e+=f(a,h,m);k<c.length-1&&(e+=b)}return e}function g(a,c,d){var e="",h,m,k;for(k=0;k<c.length;++k){m=c[k];h=d[m];if(!h)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(h.hasOwnProperty(Kindle.DB.OPERATOR)){var g=h[Kindle.DB.VALUES][h[Kindle.DB.VALUES].length-
1];if(typeof g==="number")h=h[Kindle.DB.VALUES][h[Kindle.DB.VALUES].length-1];else if(typeof g==="string")h=g;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}e+=f(a,m,h);k<c.length-1&&(e+=b)}return e}function q(a,b){for(var c=Date.now()-2E3,d=0;d<P.length;d++)if(P[d].id===a){P[d].time<c&&KindleDebug.log("Long write: "+(Date.now()-P[d].time));P.splice(d,1);break}P.length===0&&(clearInterval(S),S=null);H&&(H=!1,e(Kindle.ERROR.DB_LINGERING_WRITE,
{stalled:!1,writeOk:b}))}function p(){var a=Date.now()-5E3;P.some(function(b){return b.time<a&&!b.warned})&&(P.forEach(function(a){a.warned=!0}),H=!0,e(Kindle.ERROR.DB_LINGERING_WRITE,{stalled:!0}))}function t(a,b,c){var d,f=new jQuery.Deferred,e=new jQuery.Deferred,h=$.makeArray(a),k;c===M?(S||(S=setInterval(p,5E3)),P.push({id:++L,time:Date.now(),warned:H}),k=L):k=0;var g=k;try{d=m.transaction(h,c)}catch(n){return f.reject().promise()}d.oncomplete=function(){g&&q(g,!0);e.then(f.resolve,f.reject)};
d.onerror=function(a){g&&q(g,!1);f.reject(a)};d.onabort=function(){g&&q(g,!1);f.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(d,a,e);return f.promise()}function s(a,b,c){function d(){++f===e&&n.resolve(l)}for(var f=0,e=c.length,h=r[b].tableInfo,m=r[b].keyPath,k=r[b].genKeyPath,g=r[b].autoInc,n=new jQuery.Deferred,j,l=[],u=0;u<c.length;u++){for(var q in c[u])j=h[q],j&Kindle.DB.TEXT_TYPE?c[u][q]=typeof c[u][q]==="string"?c[u][q]:String(c[u][q]):j&Kindle.DB.NUMBER_TYPE&&(c[u][q]=
typeof c[u][q]==="number"?c[u][q]:Number(c[u][q]));!g&&!c[u][m]?(j=k?o(c[u],b):m,j=a.put(c[u],j)):j=g?a.add(c[u]):a.put(c[u]);j.onsuccess=d;j.onerror=n.reject;l.push(c[u])}return n.promise()}function v(a,b){if(!a||!b)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};d(a);return t(a,function(a,c,d){a=a.objectStore(c);s(a,c,b).then(d.resolve,d.reject)},M)}function w(a,b,c){function f(a,b){return a-b}d(b);var e=c?$.extend(!0,{},c):c,h,m=r[b].tableInfo,
k=r[b].keyPath,c=r[b].keyList,n=r[b].autoInc,u=new jQuery.Deferred,l=!1,q;if(e)for(var p in e){var J=e[p];if(J){var t=m[p],J=J.hasOwnProperty(Kindle.DB.OPERATOR);if(t&Kindle.DB.TEXT_TYPE)if(J){for(var K in e[p][Kindle.DB.VALUES])t=e[p][Kindle.DB.VALUES][K],e[p][Kindle.DB.VALUES][K]=typeof t==="string"?t:String(t);e[p][Kindle.DB.VALUES].sort()}else typeof e[p]!=="string"&&(e[p]=String(e[p]));else if(t&Kindle.DB.NUMBER_TYPE)if(J){for(var D in e[p][Kindle.DB.VALUES])t=e[p][Kindle.DB.VALUES][D],e[p][Kindle.DB.VALUES][D]=
typeof t==="number"?t:Number(t);e[p][Kindle.DB.VALUES].sort(f)}else typeof e[p]!=="number"&&(e[p]=Number(e[p]));!l&&J&&(l=!0)}}!l&&e&&(e[k]?h=e[k]:n||(h=o(e,b)));if(h)q=a.get(h),q.onsuccess=function(a){(a=a.target.result)?u.resolve([a]):u.resolve([])},q.onerror=u.reject;else{var s=[],B;if(e){h=!0;for(var F in c)if(!e[c[F]]){h=!1;break}if(h)h=j(b,c,e),b=g(b,c,e),b=IDBKeyRange.bound(h,b,!1,!1),q=a.openCursor(b);else{F={};for(var v in c)if(e[c[v]]){B=c[v];F[B]=e[B];break}if(!B){for(var z in e)if(e[z].hasOwnProperty(Kindle.DB.OPERATOR)){B=
z;F[z]=e[z];break}B||(B=Object.keys(e)[0])}F[B]&&F[B].hasOwnProperty(Kindle.DB.OPERATOR)?(h=j(b,[B],F),b=g(b,[B],F),b=IDBKeyRange.bound(h,b,!1,!1)):b=IDBKeyRange.only(e[B]);try{q=a.index(B).openCursor(b)}catch(A){q=a.openCursor()}}}else q=a.openCursor();q.onerror=u.reject;q.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in e){var d=e[c];if(d){if(d.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=$.inArray(a.value[c],d[Kindle.DB.VALUES])!==-1,d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=
!b}else d!==a.value[c]&&(b=!1);if(!b)break}}b&&s.push(a.value);a["continue"]()}else u.resolve(s)}}return u.promise()}function n(a,b,c){var d=c[0],c=c[1],e=new jQuery.Deferred;w(a,b,c).then(function(c){if(c.length>0){for(var f in c)c[f]=$.extend(c[f],d);s(a,b,c).then(e.resolve,e.reject)}else e.resolve(c)},e.reject);return e.promise()}function c(a,b,c){return t(a,function(a,d,e){a=a.objectStore(d);n(a,d,[b,c]).then(e.resolve,e.reject)},M)}function k(a,b,c){var d=new jQuery.Deferred;n(a,b,c).then(function(e){e.length===
0?(c[0]=$.extend(c[0],c[1]),s(a,b,[c[0]]).then(d.resolve,d.reject)):d.resolve(e)},d.reject);return d.promise()}function K(a,b,c){return w(a,b,c[0])}function D(a,b,c){return t(a,function(a,d,e){a=a.objectStore(d);K(a,d,[b]).then(function(a){if(c)for(var b in a)for(var d in a[b])d in c||delete a[b][d];e.resolve(a)},e.reject)},O)}function F(a,b,c){function d(c){function h(){return function(){++m===c.length&&e.resolve()}}var m=0;if(c.length===0)e.resolve();else for(var k in c){var g=o(c[k],b);f=a["delete"](g);
f.onsuccess=h(g,c[k]);f.onerror=e.reject}}var c=c[0],e=new jQuery.Deferred,f;c?w(a,b,c).then(d,e.reject):(f=a.clear(),f.onsuccess=e.resolve,f.onerror=e.reject);return e.promise()}function B(a){for(var b=new jQuery.Deferred,c=m.transaction(a,M),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}function I(){var b=new jQuery.Deferred;m.onversionchange=function(){m.close();m=void 0};m.close();var c=window.indexedDB.deleteDatabase(a.shortName);
c.onsuccess=function(){b.resolve()};c.onerror=function(){b.reject()};c.onblocked=function(){b.notify({blocked:!0})};return b.promise()}function z(){return A(function(a){return a.value})}function A(a){return t("bookinfo",function(b,c,d){var e=[],b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=a(b);c&&e.push(c);b["continue"]()}else d.resolve(e)};b.onerror=d.reject},O)}function E(a){function b(a){k.reject(a)}function c(a){k.reject(a)}function d(a){if(a=a.target.result)a["delete"](),
a["continue"]()}function e(){}var f=l(),h,k,g,n,j,q,p,J;k=new jQuery.Deferred;q=m.transaction(f,M);q.oncomplete=function(){k.resolve()};q.onerror=b;q.onabort=b;for(g=0;g<a.length;++g){n=a[g];j=o({asin:n,id:0},"skeleton");J=o({asin:n,id:u},"skeleton");J=IDBKeyRange.bound(j,J);for(j=0;j<f.length;j++)h=r[f[j]],p=q.objectStore(f[j]),h.genKeyPath?(h=p.openCursor(J),h.onsuccess=d):(h=p["delete"](n),h.onsuccess=e),h.onerror=c}return k.promise()}var b=String.fromCharCode(31),h=8,u="99999999",J=a,m=null,r=
{},N=ListenerManager(),O=IDBTransaction.READ_ONLY||"readonly",M=IDBTransaction.READ_WRITE||"readwrite",P=[],H=!1,L=1,S=null,Q={};Q[Kindle.DB.INSERT_LIST_OPERATION]=s;Q[Kindle.DB.UPDATE_RECORD_OPERATION]=n;Q[Kindle.DB.UPSERT_RECORD_OPERATION]=k;Q[Kindle.DB.DELETE_RECORD_OPERATION]=F;Q[Kindle.DB.GET_RECORD_OPERATION]=K;Q[Kindle.DB.CREATE_TABLE_OPERATION]=function(){KindleDebug.error("Illegal function: doCreateTable")};if(!function(a){var c,d;for(d in a){c=d;var e=!0,f=!1,h=void 0,m=[],k=[],g="",n=[],
u=a[d],j=void 0;for(j in u){h=u[j];if(h&Kindle.DB.AUTO_INCREMENT||h&Kindle.DB.PRIMARY_KEY)f?e=!1:(f=!!(h&Kindle.DB.AUTO_INCREMENT))||m.push(j);h&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&n.push({name:j,keyPath:j,unique:!1,multientry:!1})}if(e){for(var h=!1,l=0;l<m.length;++l)g+=m[l],k[l]=u[j],l<m.length-1&&(g+=b,h=!0);m.length===0&&(f=!0);r[c]={info:u,keyList:m,keyPath:g?g:void 0,genKeyPath:h,genKeyTypes:k,indexes:n,autoInc:f,tableInfo:u}}c=e;if(c&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0}(a.tables))throw Error("Invalid table description for "+
a.shortName);return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){var a=new jQuery.Deferred,b;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;b=window.indexedDB.open(J.shortName,J.version);b.onsuccess=function(b){m=b.target.result;a.resolve(m)};b.onerror=function(b){a.reject(b)};b.onupgradeneeded=function(a){var c;
a:{c=J.tables;var a=a.target.result,d,e,f;f=a.objectStoreNames;for(d=0;d<f.length;d++)e=f[d],c.hasOwnProperty(e)||a.deleteObjectStore(e);for(e in c)if($.inArray(e,f)===-1){var h=a;d=e;if(r[d]===void 0)d=Kindle.DB.CONSTRAINT_ERR;else{var m={autoIncrement:r[d].autoInc};if(!m.autoIncrement&&!r[d].genKeyPath)m.keyPath=r[d].keyPath;var h=h.createObjectStore(d,m),k=m=void 0;for(k in r[d].indexes)m=r[d].indexes[k],h.createIndex(m.name,m.keyPath,{unique:m.unique});d=null}if(d&Kindle.DB.CONSTRAINT_ERR){c=
!1;break a}}c=!0}c||b.abort()};return a.promise()},dropTable:function(a){return B([a])},dropTables:function(){function a(){z().then(b,h)}function b(a){function c(){e(a).then(f,h)}a.length===0?f():d(a).then(c,h)}function d(a){function b(){++f===a.length&&e.resolve()}for(var e=new jQuery.Deferred,f=0,h=0;h<a.length;h++)c("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[h].asin}).then(b,e.reject);return e.promise()}function e(a){function b(){++d===a.length&&c.resolve()}for(var c=new jQuery.Deferred,
d=0,f=0;f<a.length;f++)E([a[f].asin]).then(b,c.reject);return c.promise()}function f(){B($.makeArray(m.objectStoreNames)).then(k.resolve,h)}function h(){KindleDebug.error("Error occured signing out");k.reject()}var k;if(window.indexedDB.deleteDatabase)return I();k=new jQuery.Deferred;m.name==="K4Wbooks"?$.when(B(["annotationsCache"]),B(["pageNumberCache"])).then(a,h):f();return k.promise()},getTableNames:l,insertRecord:function(a,b){return v(a,[b])},insertList:v,upsertRecord:function(a,b,c){return t(a,
function(a,d,e){a=a.objectStore(d);k(a,d,[b,c]).then(e.resolve,e.reject)},M)},updateRecord:c,getRecord:D,deleteRecord:function(a,b){return t(a,function(a,c,d){a=a.objectStore(c);F(a,c,[b]).then(d.resolve,d.reject)},M)},batchTransaction:function(a){if(!a||a.length===0){var b=new jQuery.Deferred;b.resolve([]);return b.promise()}var b=[],c=!0,e=[],f=0,h;for(h in a)$.inArray(a[h].tableName,b)===-1&&(d(a[h].tableName),b.push(a[h].tableName)),c&&a[h].operation!==Kindle.DB.GET_RECORD_OPERATION&&(c=!1);return t(b,
function(b,c,h){function m(b){return function(c){e[b]=c;++f===a.length?h.resolve(e):g()}}function k(){b.abort();h.reject()}function g(){(n=a[u])||h.reject();d(n.tableName);Q[n.operation](b.objectStore(n.tableName),n.tableName,n.params).then(m(u),k);++u}var n,u=0;g();return h.promise()},c?O:M)},getPieceIds:function(a,c){d(a);return t(a,function(d,e,f){var h=[],m,d=d.objectStore(a),e=o({asin:c,id:0},a);m=o({asin:c,id:u},a);e=IDBKeyRange.bound(e,m);d=d.openCursor(e);d.onsuccess=function(a){var c;(a=
a.target.result)?(c=a.key.split(b),c=parseInt(c[1],10),h.push(c),a["continue"]()):f.resolve(h)};d.onerror=f.reject},O)},getOldBookList:function(a){return A(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function b(a){f.reject(a)}function c(a){f.reject(a)}function d(a){k[a]={count:0,size:0};return function(b){(b=b.target.result)?(k[a].count++,k[a].size+=b.value.size,b["continue"]()):k.totalSize+=k[a].size}}var e=[];
$.each(l(),function(a,b){r[b]&&r[b].info.size&&e.push(b)});e.push("bookinfo");var f,h,k,g,n,j;f=new jQuery.Deferred;k={totalSize:0,cacheState:"",cachedSize:0};g=m.transaction(e,O);g.oncomplete=function(){f.resolve(k)};g.onerror=b;g.onabort=b;h=o({asin:a,id:0},e[0]);j=o({asin:a,id:u},e[0]);j=IDBKeyRange.bound(h,j);for(h=0;h<e.length-1;h++)k[e[h]]={count:0,size:0},n=g.objectStore(e[h]),n=n.openCursor(j),n.onsuccess=d(e[h]),n.onerror=c;n=g.objectStore("bookinfo");n=n.get(a);n.onsuccess=function(a){if(a=
a.target.result)k.cacheState=a.cacheState,k.cachedSize=a.cachedSize||0};n.onerror=c;return f.promise()},dbDeleteBooksData:E,getSearchIndexData:function(a){var b=$.Deferred(),c=KindleMetricsProfiler("retrieve db search index");D("searchIndex",{asin:a}).then(function(a){if(!a||!a.length)b.reject();else{var d={};a.forEach(function(a){d[a.component]=a.data});c.endTimer();c.log();b.resolve(d)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),d=KindleMetricsProfiler("save db search index"),
e=[];e.push({asin:a,component:"positions",data:b.positions});e.push({asin:a,component:"words",data:b.words});e.push({asin:a,component:"properties",data:b.properties});v("searchIndex",e).always(function(){d.endTimer();d.log();c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){return t("journal",function(b,c,d){b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=b.value,e;for(e in a)if(c.type===a[e].type&&(c.guid||c.refEmId)===(a[e].guid||a[e].refEmId)&&
c.start===a[e].start&&c.end===a[e].end&&c.position===a[e].position&&c.modifiedTimestamp===a[e].modifiedTimestamp&&c.asin===a[e].asin){delete a[e];b["delete"]();break}b["continue"]()}else d.resolve()};b.onerror=d.reject},M)},addEventListener:N.addEventListener,removeEventListener:N.removeEventListener}}
function KindleSqlWrapper(a,e){function d(a){if(!A[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function l(a,c){var d=new jQuery.Deferred,e=[];z[c?"readTransaction":"transaction"](function(c){a(c,e)},function(a){d.reject(a)},function(){d.resolve(e)});return d.promise()}function f(){var a=[],c;for(c in A)a.push(c);return a}function o(a,c,d){var e=[],f,k;for(k in a)f=c[k],f!==void 0?a[k]&Kindle.DB.OBJECT_TYPE?e.push(JSON.stringify(f)):a[k]&Kindle.DB.BLOB_TYPE?
e.push(I(f)):e.push(f):d&&!(a[k]&Kindle.DB.AUTO_INCREMENT)&&e.push(null);return e}function j(a,c){var d="",e,f;for(f in a)if(e=c[f])if(d+=(d?" AND ":"")+f,e.hasOwnProperty(Kindle.DB.OPERATOR))switch(e[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:d+=" != ?";break;case Kindle.DB.IN_ARRAY:d+=" IN (?";for(var k=1;k<e[Kindle.DB.VALUES].length;k++)d+=", ?";d+=")"}else d+=" = ?";return d}function g(a){var c="";a&Kindle.DB.TEXT_TYPE||a&Kindle.DB.OBJECT_TYPE||a&Kindle.DB.BLOB_TYPE?c+="TEXT ":a&Kindle.DB.AUTO_INCREMENT?
c+="INTEGER PRIMARY KEY AUTOINCREMENT ":a&Kindle.DB.NUMBER_TYPE&&(c+="INTEGER ");!(a&Kindle.DB.PRIMARY_KEY)&&!(a&Kindle.DB.ALLOW_NULL)&&(c+="NOT NULL ");return c}function q(a,c){var d="DELETE FROM "+a;c&&(d+=" WHERE "+j(A[a],c));return d+";"}function p(a,c,d){if(d===void 0)d="*";else{var e=A[a],f="",k;for(k in e)d[k]&&(f+=(f?", ":"")+k);d=f}d="SELECT "+d+" FROM "+a;c&&(d+=" WHERE "+j(A[a],c));return d+";"}function t(a,c){d(a);if($.isArray(c)){if(c.length===0)return(new jQuery.Deferred).resolve().promise()}else return(new jQuery.Deferred).reject().promise();
return l(function(d){s(d,a,[c])},!1)}function s(a,c,d,e,f){var d=d[0],k,e=A[c],f="INSERT OR "+(f?"IGNORE":"REPLACE")+" INTO "+c+" (",g="",n="";for(k in e)e[k]&Kindle.DB.AUTO_INCREMENT||(g+=(g?", ":"")+k,n+=(n?", ":"")+"?");f+=g+") VALUES ("+n+");";k=f;c=A[c];for(f=0;f<d.length;f++)e=o(c,d[f],!0),a.executeSql(k,e)}function v(a,c,d,e,f){var e=d[0],d=d[1],k=A[c],g=A[c],n="",l;for(l in g)e[l]!==void 0&&(n+=(n?", ":"")+l+" = ?");c="UPDATE "+(f?"OR IGNORE ":"")+c+" SET "+n;d&&(c+=" WHERE "+j(g,d));c+=";";
e=o(k,e);d&&(e=e.concat(o(k,d)));a.executeSql(c,e)}function w(a,c,d){v(a,c,d,[],!0);s(a,c,[[$.extend({},d[0],d[1])]],[],!0)}function n(a,c){var d={},e,f,k;for(k in a)if(e=c[k],e!==void 0&&e!==null){f=a[k];var g=d,n=k;if(f&Kindle.DB.OBJECT_TYPE)e=JSON.parse(e);else if(f&Kindle.DB.BLOB_TYPE){f=e;e=f.slice(1);f.charAt(0)==="x"&&(e=KindleO_Aaa.o_aag(e));f=new ArrayBuffer(e.length);for(var j=new Uint8Array(f),l=0;l<e.length;l++)j[l]=e.charCodeAt(l);e=f}g[n]=e}return d}function c(a,c,e){d(a);return l(function(d,
f){K(d,a,[c,e],f)},!0)}function k(a){var c=[],d;if(a)for(var e in a)d=a[e],d.hasOwnProperty(Kindle.DB.VALUES)?c=c.concat(d[Kindle.DB.VALUES]):c.push(d);return c}function K(a,c,d,e){var f=d[0],g=A[c];a.executeSql(p(c,f,d[1]),k(f),function(a,b){if(b.rows.length>0)for(var c=0;c<b.rows.length;c++)e.push(n(g,b.rows.item(c)))})}function D(a,c,d){d=d[0];a.executeSql(q(c,d),k(d))}function F(a){return l(function(c,d){for(var e,f=0;f<a.length;f++)if(e=E[a[f].operation])d[f]=[],e(c,a[f].tableName,a[f].params,
d[f])},!1)}function B(a){var c,d=[];for(c in a)d.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:c,params:[a[c]]});return F(d)}function I(a){a=function(a){var b;b=a instanceof ArrayBuffer||Object.prototype.toString.call(a)==="[object ArrayBuffer]";if(!b)throw"[KindleSqlWrapper binaryToString] Unknown data type passed. Expect ArrayBuffer.";var c,d;if(KindleHostDeviceDetector.hasArrayLikeApply())try{var e=a.byteLength;b=e;for(c=[];b>=0;){var f=e-b,k=a.slice(f,Math.min(f+1E4,e));d=new Uint8Array(k);
c.push(String.fromCharCode.apply(null,d));b-=1E4}}catch(g){c=null}if(!c){c=[];d=new Uint8Array(a);for(a=0;a<d.length;a++)c.push(String.fromCharCode(d[a]))}return c.join("")}(a);return a.match(/\x00/g)?"x"+KindleO_Aaa.o_aaa(a):"t"+a}var z=null,A={},E={};E[Kindle.DB.INSERT_LIST_OPERATION]=s;E[Kindle.DB.UPDATE_RECORD_OPERATION]=v;E[Kindle.DB.UPSERT_RECORD_OPERATION]=w;E[Kindle.DB.DELETE_RECORD_OPERATION]=D;E[Kindle.DB.GET_RECORD_OPERATION]=K;E[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,c,d){var d=
d[0],e="CREATE TABLE IF NOT EXISTS "+c+"(",f="",k,n=!0,j;for(j in d)n?n=!1:e+=", ",e+=j+" ",k=d[j],e+=g(k),k&Kindle.DB.PRIMARY_KEY&&(f+=f?", ":" PRIMARY KEY (",f+=j);f&&(e+=", "+f+")");e+=");";A[c]=d;a.executeSql(e,[])};E[Kindle.DB.ALTER_TABLE_OPERATION]=function(a,c,d){var e=A[c],f,k;f="";for(var n=0;n<d.length;n++)f=d[n],k=e[f]|Kindle.DB.ALLOW_NULL,f="ALTER TABLE "+c+" ADD COLUMN "+f+" ",f+=g(k),f+=";",a.executeSql(f,[])};return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},
openDatabase:function(){var b=new jQuery.Deferred,c=a.defaultSize;e!==void 0&&c>e*1E6&&(c=_maxDbSize*1E6);try{z=openDatabase(a.shortName,"",a.displayName,c)}catch(d){try{z=openDatabase(a.shortName,"",a.displayName,5E6)}catch(f){return b.reject(f)}}var k=parseInt(z.version,10)||z.version;KindleHostDeviceDetector.isiOS_4x()||z.changeVersion(k,a.version);B(a.tables).done(function(){var c=a.versionUpdate,d=[];if(c&&c.length)for(var e=0;e<c.length;e++)c[e].version>k&&d.push({operation:c[e].operation,tableName:c[e].tableName,
params:c[e].params});F(d).then(b.resolve(z),b.reject)}).fail(b.reject);return b.promise()},dropTables:function(){return l(function(a){for(var c in A)a.executeSql("DROP TABLE IF EXISTS "+c+";")},!1)},getTableNames:f,insertRecord:function(a,c){return t(a,[c])},insertList:t,upsertRecord:function(a,c,e){d(a);return l(function(d){w(d,a,[c,e])},!1)},updateRecord:function(a,c,e){d(a);return l(function(d){v(d,a,[c,e])},!1)},getRecord:c,deleteRecord:function(a,c){d(a);return l(function(d){D(d,a,[c])},!1)},
batchTransaction:F,getPieceIds:function(a,d){var e=new jQuery.Deferred;c(a,{asin:d},{id:!0}).then(function(a){var b=[],c;for(c in a)b.push(a[c].id);e.resolve(b)},e.reject);return e.promise()},getOldBookList:function(a){var d=new jQuery.Deferred;c("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===0?d.reject():d.resolve(a)},d.reject);return d.promise()},
dbGetBookStatistics:function(a){var c=new jQuery.Deferred,d=[];$.each(f(),function(a,b){A[b]&&A[b].size&&d.push(b)});for(var e={totalSize:0,cacheState:"",cachedSize:0},k,g=[],n=0;n<d.length;n++)g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:d[n],params:[{asin:a},{size:!0}]});g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});F(g).then(function(a){for(var b=0;b<d.length;b++){var f=a[b],g=0,n=void 0;for(n in f)g+=f[n].size;
k={count:f.length,size:g};e[d[b]]=k;e.totalSize+=k.size}e.cacheState=a[a.length-1][0].cacheState;e.cachedSize=a[a.length-1][0].cachedSize||0;c.resolve(e)},function(){c.resolve(e)});return c.promise()},dbDeleteBooksData:function(a){var c,d,e,k=[];e=f();for(d=0;d<a.length;++d)for(c=0;c<e.length;++c)k.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:e[c],params:[{asin:a[d]}]});return F(k)},getSearchIndexData:function(a){var d=$.Deferred();c("searchIndex",{asin:a}).then(function(a){if(!a||
!a.length)d.reject();else{var b={},c={};a.forEach(function(a){b[a.component]=a.data});c.positions=b.positions;c.words=b.words;c.properties=b.properties;d.resolve(c)}},d.reject);return d.promise()},putSearchIndexData:function(a,c){var d=$.Deferred(),e=[];e.push({asin:a,component:"positions",data:c.positions});e.push({asin:a,component:"words",data:c.words});e.push({asin:a,component:"properties",data:c.properties});t("searchIndex",e).always(function(){d.resolve(c)});return d.promise()},deleteJournalEntries:function(a){var c=
[],d;for(d in a)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[d].id}]});return F(c)}}}
function KindleStubDBWrapper(a){function e(a){if(!t[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function d(a,c){var d=c[0],f,g,j,l;for(l in d){f={};j=a;g=f;var q;q=j;var o=d[l];e(q);var p=t[q],w=!0,b=void 0,h=void 0;for(h in p.info)if(b=p.info[h],o[h])if(b&Kindle.DB.AUTO_INCREMENT)w=!1;else{switch(typeof o[h]){case "number":w=b&Kindle.DB.NUMBER_TYPE;break;case "string":w=b&Kindle.DB.TEXT_TYPE;break;case "object":w=b&Kindle.DB.OBJECT_TYPE}if(!w)break}else if(b&
Kindle.DB.AUTO_INCREMENT)v[q]++,o[h]=v[q];else if(!(b&Kindle.DB.ALLOW_NULL)||b&Kindle.DB.PRIMARY_KEY)w=!1;q=w?null:Kindle.DB.CONSTRAINT_ERR;w=p=o=void 0;if(q===null){w=t[j].keyList;p=s[j];for(j=0;j<w.length-1;j++)o=w[j],p[o]||(p[o]={}),p=p[g];g.container=p;g.key=w[w.length-1]}g=q;if(g===null)j=d[l][f.key],f.container[j]?g=Kindle.DB.CONSTRAINT_ERR:f.container[j]=d[l];else{g=Kindle.DB.CONSTRAINT_ERR;break}}return g}function l(a,c){var e=new jQuery.Deferred,f=d(a,[c]);f?e.reject(f):e.resolve();return e.promise()}
function f(a,c){e(a);var d=t[a].keyList,f=s[a],g,j,l={};for(g=0;g<d.length;g++)if(j=d[g],c[j])if(g===d.length-1){l.key=c[j];break}else f[c[j]]||(s[c[j]]={}),f=s[c[j]],delete c[j];else break;if(g<d.length-1)throw"unsupported use case for in-memory DB!!";l.container=f;l.selection=c;return l}function o(a,c){var d=c[0],e=null,g=f(a,c[1]);g.container&&g.key&&g.container[g.key]?$.extend(g.container[g.key],d):e=Kindle.DB.CONSTRAINT_ERR;return e}function j(a,c){$.extend(c[0],c[1]);var e=d(a,[[c[0]]]);e===
Kindle.DB.CONSTRAINT_ERR&&(e=o(a,c));return e}function g(a,c,d){var c=c[0],e=t[a],g=s[a],j,l;if(c){if(a=f(a,c),g=a.container)if(a.key)g[a.key]&&d.push(g[a.key]);else for(j in a=a.selection,e=!0,g){for(l in a)if(g[j][l]!==c[l]){e=!1;break}e&&d.push(g[j])}}else if(e.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(j in g)d.push(g[j]);return null}function q(a,c){var d=c[0],e,g=s[a],j,l,q;if(d){if(e=f(a,d),g=e.container)if(e.key)delete g[e.key];else for(j in e=e.selection,q=
!0,g){for(l in e)if(g[j][l]!==d[l]){q=!1;break}q&&delete g[j]}}else s[a]={};return null}function p(a){var c=new jQuery.Deferred,d,e=[],f;for(f in a)if(d=a[f],e[f]=[],d=w[d.operation](d.tableName,d.params,e[f]))break;d===null?c.resolve(e):c.reject(d);return c.promise()}var t={},s={},v={},w={};w[Kindle.DB.INSERT_LIST_OPERATION]=d;w[Kindle.DB.UPDATE_RECORD_OPERATION]=o;w[Kindle.DB.UPSERT_RECORD_OPERATION]=j;w[Kindle.DB.DELETE_RECORD_OPERATION]=q;w[Kindle.DB.GET_RECORD_OPERATION]=g;w[Kindle.DB.CREATE_TABLE_OPERATION]=
function(a,c){var d=!0,e=!1,f,g=[],j=0,l=c[0],q;for(q in l)if(f=l[q],f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)e?d=!1:(e=f&Kindle.DB.AUTO_INCREMENT,g.push(q));if(d){if(g.length===0)g.push("id"),l.id=Kindle.DB.AUTO_INCREMENT,e=!0;t[a]={info:l,keyList:g};(f=s[a])||(s[a]={});if(e){for(var o in f)j=Math.max(j,parseInt(o,10));v[a]=j}}return d?null:Kindle.DB.CONSTRAINT_ERR};(function(){var d;try{d=JSON.parse(window.localStorage.getItem(a))}catch(c){}d&&typeof d==="object"&&(s=d)})();return{persist:function(){var d=
null;try{window.localStorage.setItem(a,JSON.stringify(s))}catch(c){d=Kindle.DB.QUOTA_ERR}return d},createTables:function(a){var c,d,e;c=new jQuery.Deferred;e=[];for(d in a)e.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:d,params:[a[d]]});p(e).then(c.resolve,c.reject);return c.promise()},dropTables:function(){s={};t={};v={};window.localStorage.setItem(a,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var a=[],c;for(c in t)a.push(c);return a},insertRecord:function(a,
c){return l(a,[c])},insertList:l,upsertRecord:function(a,c,d){var e=new jQuery.Deferred;(a=j(a,[c,d]))?e.reject(a):e.resolve();return e.promise()},updateRecord:function(a,c,d){var e=new jQuery.Deferred;(a=o(a,[c,d]))?e.reject(a):e.resolve();return e.promise()},getRecord:function(a,c){var d=new jQuery.Deferred,e=[],f=g(a,[c],e);f?d.reject(f):d.resolve(e);return d.promise()},deleteRecord:function(a,c){var d=new jQuery.Deferred,e=q(a,[c]);e?d.reject(e):d.resolve();return d.promise()},batchTransaction:p,
deleteJournalEntries:function(a){var c=[],d;for(d in a)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[d].id}]});return p(c)}}}
var BookChunk=function(){var a=Object.freeze?function(a){return Object.freeze(a)}:function(a){return a},e=["fragment","glyph","skeleton","resource","locationMap"],d={};e.forEach(function(a){d[a]={}});d.resource.huge=!0;var l={types:a(e),properties:a(d),getId:function(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};e.forEach(function(a){l[a.toUpperCase()+"_TYPE"]=a});return a(l)}(),RemoteContentCache=function(){return{create:function(a){function e(a){j=a;if(!d||d.state!=="pending")d=$.Deferred();d.resolve(j)}var d=$.Deferred(),l=a.asin,f=a.contentProvider,o=a.contentRemover,j,g={};BookChunk.types.forEach(function(a){g[a]={getChunks:function(d,e,g){f("getChunks",l,a,d).then(e,g)},putChunks:function(d,e,g){var j={};d.forEach(function(a,
d){j[d]=a});f("putChunks",l,a,j).then(e,g)},getCachedIds:function(d,e){f("getChunkIds",l,a).then(d,e)}}});g.queryBookinfo=function(){return f("getBookinfo",l).pipe(function(a){e(a);return a})};g.getBookinfo=function(){return d.promise()};g.putBookinfo=function(a){e(a);return f("putBookinfo",l,a)};g.updateBookinfo=function(a){if(!j)return $.Deferred().reject("bad state");$.extend(j,a);return f("updateBookinfo",l,a)};g.getAnnotations=function(){return f("getAnnotations",l)};g.putAnnotations=function(a){return f("putAnnotations",
l,a)};g.getPageNumbers=function(){return f("getPageNumbers",l)};g.putPageNumbers=function(a){return f("putPageNumbers",l,a)};g.computeQuota=function(){return $.Deferred().resolve(0)};g.getBookStatistics=function(){return $.Deferred().reject()};g.checkCache=function(){return!0};g.deleteOldestBook=function(a,d){d()};g.deleteBooksData=function(){j=void 0;d.state()!=="pending"&&(d=$.Deferred());return o({asin:l})};g.downloadSearchIndex=function(a){return f("getSearchIndexReader",l,a)};g.initMetadata=
function(a){return f("initMetadata",l,a)};return g}}}(),ContentMigration=function(){function a(a){function d(e){var g="get"+(e.substr(0,1).toUpperCase()+e.substr(1))+"Ids";return a.source[g]().pipe(function(d){function g(){var k=d.splice(0,100);if(k.length===0)j.then(c.resolve,c.reject);else{var l="get"+(e.substr(0,1).toUpperCase()+e.substr(1))+"s",k=a.source[l](k);$.when(k,j).then(function(c){var d={};c.forEach(function(a,c){d[c]=a});j=a.target("putChunksNonT",a.asin,e,d);setTimeout(g,100)},c.reject)}}
var j=$.Deferred().resolve(),c=$.Deferred();g();return c.promise()})}function e(){var a=BookChunk.types[l++];a?d(a).then(e,g.reject):g.resolve()}var g=$.Deferred(),l=0,p=a.timer.createSubTimer("chunks");e();g.done(function(){p.endTimer()});return g.promise()}function e(a){var d=$.Deferred(),e=a.timer.createSubTimer("annotations");a.source.getAnnotations().then(function(e){a.target("putAnnotations",a.asin,e).then(d.resolve,d.reject)},d.reject);d.done(function(){e.endTimer()});return d.promise()}function d(a){var d=
$.Deferred(),e=a.timer.createSubTimer("pageNumbers");a.source.getPageNumbers().then(function(e){a.target("putPageNumbers",a.asin,e).then(d.resolve,d.reject)},d.reject);d.done(function(){e.endTimer()});return d.promise()}function l(a){var d=$.Deferred(),e=a.timer.createSubTimer("bookinfo");a.source.getBookInfo().then(function(e){a.target("putBookinfo",a.asin,e).then(d.resolve,d.reject)},d.reject);d.done(function(){e.endTimer()});return d.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,
[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(f,o){return{moveBook:function(j){var g=$.Deferred(),q=f.getBookDb();if(!j)return g.reject("Need ASIN as param").promise();var p={timer:KindleMetricsProfiler("Migrate "+j),asin:j,target:o.contentProvider,source:q.BookInfoDB(j)},j=$.when(a(p),e(p),d(p),l(p));j.then(function(){p.timer.endTimer();p.timer.log()});j.then(g.resolve,g.reject);return g.promise()},notifyMigrationStatus:function(a){var d=$.Deferred();if(!a||!a.status)return d.reject("Need param.status as param").promise();
a.status==="done"?f.getBookDb().dropTables().then(d.resolve,d.reject):d.reject("this status is not handled");return d.promise()}}})}}}();function AssertionError(a){Error.call(this,a)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function a(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:a,useCSSRegions:function(){return a()}}}(),
KindleHostDeviceDetector=function(){function a(){return navigator.platform.indexOf("iPad")!==-1}function e(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function d(){return a()||e()||o()}function l(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function f(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function o(){return navigator.userAgent.indexOf("Cloud9")!==-1}function j(){return navigator.userAgent.indexOf("MSAppHost")!==
-1}function g(){return j()&&q()}function q(){return!!/arm/i.test(navigator.cpuClass)}function p(){return f()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function t(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function s(){return"standalone"in navigator&&navigator.standalone}function v(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function w(){return window.navigator.msMaxTouchPoints>=
1}return{isiOS:d,isiPad:a,isiPhone:e,isiOS_4x:function(){return(a()||e())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(a()||e())&&parseInt(l(),10)>=5},isiOS_7x:function(){return(a()||e())&&parseInt(l(),10)===7},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:f,hasHangingDbPrompt:function(){if(!f())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:function(a){var c=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!c?!1:!a?!0:Number(c[1])>=Number(a)},isMetro:j,isMetroArm:g,isMetroSnappedView:function(){return j()&&window.outerWidth===320},isIE:t,isIE10:function(){return t()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return t()&&navigator.userAgent.indexOf("Trident/7.0")!==-1},isArm:q,isCloud9:o,isTablet:function(){return a()||j()},isOnline:p,isNetworkAvailable:function(){if(!p())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},
timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!p())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome},isiOSAppMode:s,isChromeApp:v,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return s()||v()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!==
"undefined"},isLocalStorageEnabled:function(){if(!window.localStorage)return!1;try{window.localStorage.setItem("testLocalStorage","1"),window.localStorage.removeItem("testLocalStorage")}catch(a){return!1}return!0},hasArrayLikeApply:function(){return!d()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:w,isTouchDevice:function(){return d()||
w()},getDevicePlatform:function(){return a()?"iPad":e()?"iPhone":o()?"otter":g()?"metroArm":j()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return a()&&KindleHostPadDetector.isPad1(s())||g()},getDeviceType:function(){return j()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return j()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:l,getOSMinorVersion:function(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},
getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(a){if(window.localStorage.getItem("definitelyNotPad1"))return!1;var e=0,d=1E3,l=0,f;for(i=0;i<3;i++)f=SunSpiderBenchmark.get3DSpeed(),f>e?e=f:f<d&&(d=f),l+=f;e=l/3;if(e>=200&&a)return!0;if(e>=100&&!a)return!0;window.localStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function a(a,d){for(var l in d)if(d.hasOwnProperty(l)&&typeof a[l]!==typeof d[l])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:a,assertImplements:function(e,
d){a(e,d)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function a(a){var d=[],e;for(e in a){var f=a[e].entry;f.guid=f.guid||f.refEmId;delete f.refEmId;f&&d.push(f)}return d}function e(a){var d=[],e;for(e in a)d.push({entry:a[e]});return o.getAppDb().getTable(f).insertList(d)}function d(d){function e(){var v;l<d.length?(s=Math.min(l+100,d.length),v=Array.prototype.slice.call(d,l,s),l=s,j.updateAnnotations(a(v),KindleLocale.getLocalTimeOffset()).then(function(){o.getAppDb().deleteJournalEntries(v).then(e,
f.reject)},f.reject)):f.resolve()}var f=new jQuery.Deferred,l=0,s;e();return f.promise()}function l(){var a=new jQuery.Deferred;o.getAppDb().getTable(f).getRecord().then(function(e){e.length>0?d(e).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var f="journal",o=null,j=null;return{initialize:function(){var a=new jQuery.Deferred,d=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(e){j=e[KindleModuleManager.SERVICE_CLIENT];
o=e[KindleModuleManager.DB_CLIENT];a.resolve(d)},a.reject);return a.promise()},saveToJournal:function(a){var d=new jQuery.Deferred;e(a).then(function(){l().then(d.resolve,d.resolve)},d.reject);return d.promise()},uploadJournal:l}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")},setDeviceToken:function(a){window.localStorage.setItem("kindleDeviceToken",
a)},clearDeviceTokenFromStorage:function(){window.localStorage.removeItem("kindleDeviceToken")}}}(),KindleLocale=function(){var a=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return a},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=function(a){function e(a){for(var d=0,e=0;e<a.length;e+=1)d+=a[e].end-a[e].start;return d}var d={};d.name=a;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var a=this.runs[this.runs.length-
1];if(a.end===null)a.end=(new Date).getTime()};d.addCount=function(a,d){if(this.counters===null)this.counters={};this.counters[a]===void 0?this.counters[a]=d:this.counters[a]+=d};d.createSubTimer=function(a){if(this.subTimers===null)this.subTimers={};this.subTimers[a]===void 0?this.subTimers[a]=KindleMetricsProfiler(a):this.subTimers[a].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[a]};d.log=function(){this.logAsPercentageOfTime("",e(this.runs))};d.logAsPercentageOfTime=function(a,
d){var o=a+":"+this.name,j;e(this.runs);for(j in this.counters);for(j in this.subTimers)this.subTimers[j].logAsPercentageOfTime(o,d)};return d};
function KindleModuleManagerFactory(){function a(a,d){if(w[a])throw"Duplicate registration of module "+a;if(!d)throw"Module is not initialized with an object "+a;w[a]=d;n[a].resolve(d)}function e(a){if(w.hasOwnProperty(a))throw"Duplicate registration of module "+a;w[a]=void 0}function d(c,d){n[c]||(n[c]=new jQuery.Deferred);a(c,d)}function l(c,d){e(c);n[c]||(n[c]=new jQuery.Deferred);d(n[c]);n[c].done(function(d){a(c,d)})}function f(a,d){l(a,function(a){d.done(a.resolve).fail(a.reject)})}function o(a){n[a]||
(n[a]=new jQuery.Deferred);return n[a].promise()}function j(a){if(!w[a])throw"Trying to get uninitialized module "+a;return w[a]}function g(a){return w.hasOwnProperty(a)}function q(a,d){w[a]=d}function p(a){var d=w[a];return{done:function(a){a(d)},fail:function(){},when:function(a){a(d)}}}function t(a){for(var d={},e=0;e<a.length;e++)d[name]=w[a];return{done:function(a){a(d)},fail:function(){},when:function(a){a(d)}}}function s(){w={}}var v={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network"},w={},n={};return{CONSTANTS:v.CONSTANTS,DB_CLIENT:v.DB_CLIENT,RESOURCE_BUNDLE:v.RESOURCE_BUNDLE,METRICS_MANAGER:v.METRICS_MANAGER,SERVICE_CLIENT:v.SERVICE_CLIENT,APP_REGISTRATION:v.APP_REGISTRATION,JOURNAL_MANAGER:v.JOURNAL_MANAGER,
BOOK_METADATA:v.BOOK_METADATA,BOOK_FRAGMAP:v.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:v.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:v.CONTENT_MIGRATION,NETWORK:v.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var e in a)d(e,a[e])},registerModuleWithInitializer:l,registerModuleWithDeferred:f,detachModule:function(a){var d=w[a],e=n[a];e&&!e.isResolved()&&e.reject("canceled");delete w[a];delete n[a];return d},getModule:o,getModuleList:function(a){var d=new jQuery.Deferred,
e,f=[];for(e=0;e<a.length;e++)f.push(o(a[e]));$.when.apply($,f).done(function(){var e,f={};for(e=0;e<a.length;e++)f[a[e]]=arguments[e];d.resolve(f)}).fail(d.reject);return d.promise()},getModuleSync:j,isModuleInitialized:function(a){return w[a]!==void 0},isModuleRegistered:g,switchToTestMode:function(){this.registerModuleTest=q;this.getModule=p;this.getModuleSync=j;this.getModuleList=t;this.clear=s;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(a,
d,e){if(!g(a)){var j=[],l=$.Deferred();f(a,l);d&&d.length&&d.forEach(function(a){j.push(a&&$.isFunction(a.promise)?a:o(a))});$.when.apply($,j).then(function(){var a;typeof e==="function"?(a=$.makeArray(arguments),a=e.apply(e,a)):a=e;a&&$.isFunction(a.promise)?a.then(l.resolve,function(){l.reject()}):l.resolve(a)},function(){l.reject()})}},require:function(a,d){$.isArray(a)||(a=[a]);var e,f,g=[];a.forEach(function(a){g.push(a&&$.isFunction(a.promise)?a:o(a))});d||(f=$.Deferred(),e=f.promise());$.when.apply($,
g).then(function(){var a=$.makeArray(arguments);d?d.apply(d,a):f.resolve.apply(f,a)},function(){d&&f.reject()});return e}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var a=new jQuery.Deferred;$.get("/remote/store").then(function(e){(e=e.url)?a.resolve(e):a.reject()},a.reject);return a.promise()},uploadFeedback:function(a){if(!a)return(new $.Deferred.reject).promise();var e=KindleLibrarySetting.getSettings(),e={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,
AppCached:!!window.localStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:e.sortParam,LibraryView:e.viewState};return function(a){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(e){try{var f=e.getAppDb(),o=f.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),
j=f.getAllBooks();a.info.OfflineStorageEnabled=!!e.bookDbEnabled();return $.when(o,j)}catch(g){return $.Deferred.reject()}}).pipe(function(e,f){$.extend(a.info,{TotalBookCount:f.length,TotalBookDownloaded:e.length})}).pipe(function(){return a},function(){return $.Deferred().resolve(a)})}({version:KindleVersion.getVersionString(),message:a.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:e}).pipe(function(a){a={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",
data:JSON.stringify(a)};return $.ajax(a)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(a){return ResourceBundle.getLocalizedString(a)})}}}(),KindleUserAgentMetricsInfo=function(){function a(){function a(){var d=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(d)return d[1]}var e;if(!(e=function(){var a;if(["ipad","iphone"].indexOf(d)!==-1&&(d="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var f;
KindleHostDeviceDetector.isIE()&&(f=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");e=f||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return e}var e,d,l,f,o,j={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!e){d=GoogleUserAgent.browserName.toLowerCase();l=a();a:{if(l){var g=/^0*([0-9]+)/.exec(l);if(g&&g.length>=2){f=parseInt(g[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+l)}f=
void 0}o="undefined"===typeof f?"other":j[d]?[d,f].join("@"):"other";e=!0}return o}}}(),KindleVersion=function(){var a=null,e=null;return{getMetricsVersionString:function(){e||(e=parseInt("010600527".slice(0,2),10),e+=".",e+=parseInt("010600527".slice(2,4),10),e+=".",e+=parseInt("010600527".slice(4,6),10));return e},getVersionString:function(){a||(a=parseInt("010600527".slice(0,2),10),a+=".",a+=parseInt("010600527".slice(2,4),10),a+=".",a+=parseInt("010600527".slice(4,6),10),a+=".",a+=parseInt("010600527".slice(6),
10));return a},getVersionNumber:function(){return Number("010600527")},parseVersionString:function(a){return a&&(a=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(a))?Number(a[1])*1E7+Number(a[2])*1E5+Number(a[3])*1E3+Number(a[4]):NaN}}}(),KindleChromeInstaller=function(){function a(){function a(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(a,250)},function(a){KindleDebug.error(a)})}function e(){return window.chrome&&
Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}return{install:function(){e()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&e()){var d=document.createElement("button");d.id="inlineInstallProxy";d.style.display="none";$(d).click(a);$("body").append(d)}}}}(),KindleFirefoxInstaller=function(){function a(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}
function e(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();var d=$.Deferred(),e=navigator.mozApps.getInstalled();e.onsuccess=function(){var f=!1,o=a();e.result.forEach(function(a){a.manifestURL===o&&(f=!0)});d.resolve(f)};e.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);d.reject()};return d.promise()}return{install:function(){var d=$.Deferred();e().done(function(e){e?d.reject():(e=navigator.mozApps.install(a()),
e.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");d.resolve()},e.onerror=function(){KindleDebug.error("Firefox App failed to install.");d.reject()})}).fail(d.reject);return d.promise()}}}();
EmbeddedReaderAPI={setLoginParameters:function(){},setFocusToReader:function(){},showAppbar:function(){},hideAppbar:function(){},toggleAppbar:function(){},sendMetrics:function(){},sendMetricsNow:function(){},deregister:function(){},clearDatabases:function(){},clearLocalStorage:function(){},openBook:function(){},goTo:function(){},downloadBook:function(){},requestDownloadedBookList:function(){},cancelBookDownload:function(){},removeBook:function(){},removeBookOwnership:function(){},getSearchContext:function(){},
requestOemAssociateId:function(){},getTodoItems:function(){},removeTodoItems:function(){},uploadSnapshot:function(){},getSearchIndex:function(){},getDownloadedBookInfo:function(){},requestDeviceName:function(){},getSelectedText:function(){},hideContextMenu:function(){},setStoreCookies:function(){},setServiceHost:function(){},uploadJournal:function(){},getTOSParams:function(){},moveAsinToHost:function(){},notifyMigrationStatus:function(){},updateAppCache:function(){},convertPositions:function(){},
updateAnnotations:function(){}};
ReaderHostAPI={onReaderLoaded:function(){},onAppCacheStatus:function(){},onAppCacheUpdateReady:function(){},onBookOpenStatus:function(){},onBookClose:function(){},onOpenStore:function(){},onServiceAuthState:function(){},pinBookToStart:function(){},onBookDownloadComplete:function(){},onBookDownloadFailed:function(){},onBookDownloadProgress:function(){},onDeregister:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},showWebPage:function(){},getRequestSigningHeaders:$.rpc.fn(),
contentProvider:$.rpc.fn({timeout:9E4}),deleteBookContent:$.rpc.fn(),searchContent:function(){},showAnnotations:function(){}};function ReaderHostInterfaceFactory(a,e){KindleInterfaces.assertImplements(a,EmbeddedReaderAPI);return $.rpc({name:"KCR",iRemote:ReaderHostAPI,local:a,channelId:"reader",target:window.parent,remoteDomain:e})};
