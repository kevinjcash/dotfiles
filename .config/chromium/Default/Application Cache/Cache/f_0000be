/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
(function(){var f=Handlebars.template,h=Handlebars.templates=Handlebars.templates||{};h.KindleLibraryAppCacheFailDialog=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j=c.helperMissing,k=this.escapeExpression;d+='<div id=\'kindle_dialog_appCacheFail\'>\n    <div class="box-top">&nbsp;</div>\n    <div class="content-container">\n        <div id="content">\n            <h2> ';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_title_text",a):
j.call(e,"str","k_dialog_appCache_title_text",a)))+"</h2>\n            <p> ";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_message_text",a):j.call(e,"str","k_dialog_appCache_message_text",a)))+' </p>\n            <div id="appCacheDialogFail_toggler" class="toggler"> \n                <span id="appCacheDialogFail_arrow" class="kindleLibrary_arrowClosed">\n                </span>\n                <span class = "boldText"> \n                  ';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,
"k_dialog_appCache_readmore_text",a):j.call(e,"str","k_dialog_appCache_readmore_text",a)))+" \n                </span>\n            </div>\n            <br/>\n            <div id=\"appCacheDialogFail_content\" style='display:none'>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_step1_text",a):j.call(e,"str","k_dialog_appCache_step1_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};d+=k((b=c.str,
b?b.call(e,"k_dialog_appCache_instruction1_text",a):j.call(e,"str","k_dialog_appCache_instruction1_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_step2_text",a):j.call(e,"str","k_dialog_appCache_step2_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_instruction2_text",a):j.call(e,"str","k_dialog_appCache_instruction2_text",a)))+
"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_step3_text",a):j.call(e,"str","k_dialog_appCache_step3_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_instruction3_text",a):j.call(e,"str","k_dialog_appCache_instruction3_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};d+=k((b=
c.str,b?b.call(e,"k_dialog_appCache_step4_text",a):j.call(e,"str","k_dialog_appCache_step4_text",a)))+"</span> <span class='appCacheFail_field'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_instruction4_text",a):j.call(e,"str","k_dialog_appCache_instruction4_text",a)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_step5_text",a):j.call(e,"str","k_dialog_appCache_step5_text",a)))+"</span> <span class='appCacheFail_field'>";
a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_instruction5_text",a):j.call(e,"str","k_dialog_appCache_instruction5_text",a)))+'</span><br/><br/>\n           </div>\n        </div>\n    </div>\n    <div class="box-bottom">\n        <p>\n            <span class="primary_btn" id="kindle_appCacheDialog_button">';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_dialog_appCache_button_text",a):j.call(e,"str","k_dialog_appCache_button_text",a)))+"</span>\n        </p>\n    </div>\n</div>";
return d});h.KindleLibraryBookContainer=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b=this.escapeExpression;d+='<div id="';(a=c.asin)?a=a.call(e,{hash:{},data:g}):(a=e.asin,a=typeof a==="function"?a.apply(e):a);d+=b(a)+'" class="book_container">\n    <div class="book_cover">\n        <img class="book_image book_click_area" src="';(a=c.src)?a=a.call(e,{hash:{},data:g}):(a=e.src,a=typeof a==="function"?a.apply(e):a);d+=b(a)+'" title="';(a=c.title)?a=a.call(e,
{hash:{},data:g}):(a=e.title,a=typeof a==="function"?a.apply(e):a);d+=b(a)+'">\n        <div class="alt_title book_click_area"></div>\n    </div>\n    <div class="book_details">\n        <div class="book_title book_click_area">';(a=c.title)?a=a.call(e,{hash:{},data:g}):(a=e.title,a=typeof a==="function"?a.apply(e):a);d+=b(a)+'</div>\n        <div class="book_author book_click_area">';(a=c.author)?a=a.call(e,{hash:{},data:g}):(a=e.author,a=typeof a==="function"?a.apply(e):a);d+=b(a)+"</div>\n    </div>\n</div>";
return d});h.KindleLibraryControlBar=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j,a=c.helperMissing,k=this.escapeExpression;d+='<div id="view_sort_size_controls">\n    <div id="view_toggle">\n        <div id="view_buttons">\n            <div id="view_grid" class="btn_set btn_set_left" value="grid" title=\'';j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_grid_button",j):a.call(e,"str","k_L_toolbar_grid_button",j)))+'\'>\n                <div id="view_grid_icon" value="grid"></div>\n            </div>\n            <div id="view_list" class="btn_set btn_set_right" value="list" title=\'';
j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_list_button",j):a.call(e,"str","k_L_toolbar_list_button",j)))+'\'>\n                <div id="view_list_icon" value="list"></div>\n            </div>\n        </div>\n    </div>\n    <div id="view_sort">\n        <div id="kindleLibrary_button_sort" class="btn_set btn_set_left btn_set_right" title=\'';j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_sort_button",j):a.call(e,"str","k_L_toolbar_sort_button",j)))+'\'>\n            <div id="kindleLibrary_button_sort_label" style="display: inline">';
(j=c.sortParam)?j=j.call(e,{hash:{},data:g}):(j=e.sortParam,j=typeof j==="function"?j.apply(e):j);d+=k(j)+'</div>\n            <div id="kindleLibrary_button_sort_arrow"></div>\n        </div>\n    </div>\n    <div id="view_state">\n       <div id="view_state_buttons">\n        <div id="view_cloud"      class="btn_set btn_set_left" value="cloud"\n        title=\'';j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_cloud_button",j):a.call(e,"str","k_L_toolbar_cloud_button",j)))+"'>";j={hash:{},
data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_cloud_label",j):a.call(e,"str","k_L_toolbar_cloud_label",j)))+'</div>\n        <div id="view_downloaded" class="btn_set btn_set_right"\n        value="downloaded" title=\'';j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_downloaded_button",j):a.call(e,"str","k_L_toolbar_downloaded_button",j)))+"'>";j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_downloaded_label",j):a.call(e,"str","k_L_toolbar_downloaded_label",j)))+'</div>\n       </div>\n       <div id="cache_state">\n            <div id="cache_icon">\n                <div id="kindleLibrary_cache_spinner" class="spinner">\n                    <div class="bar1"></div>\n                    <div class="bar2"></div>\n                    <div class="bar3"></div>\n                    <div class="bar4"></div>\n                    <div class="bar5"></div>\n                    <div class="bar6"></div>\n                    <div class="bar7"></div>\n                    <div class="bar8"></div>\n                    <div class="bar9"></div>\n                    <div class="bar10"></div>\n                    <div class="bar11"></div>\n                    <div class="bar12"></div>\n                </div>\n                <div id="cache_image"></div>\n            </div>\n            <span id="cache_message">';
j={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_caching",j):a.call(e,"str","k_L_caching",j)))+"</span>\n       </div>\n    </div>\n</div>";return d});h.KindleLibraryFeedbackDialog=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j=c.helperMissing,k=this.escapeExpression;d+='<form id="KindleLibrary_feedback_container">\n    <p id="kindle_feedback_title_text" class="kindle_dialog_title_text">';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_provide_feedback_title",
a):j.call(e,"str","k_provide_feedback_title",a)))+'</p>\n    <p id="kindle_feedback_message_text" class="kindle_dialog_text">';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_provide_feedback_text",a):j.call(e,"str","k_provide_feedback_text",a)))+'</p>\n    <textarea id="kindleLibrary_feedback_area"></textarea>\n    <div id="kindleLibrary_feedback_status"></div>\n</form>';return d});h.KindleLibraryHeaderBar=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",
b,j=c.helperMissing,k=this.escapeExpression;d+="<div id='page_header'>\n    <div id='kindleLibrary_kindleLogo'></div>\n    <div id='header_left' class='libraryControls'>\n\n        <div\n            id='kindleLibrary_button_sync'\n            class='header_bar_icon'\n            btnLbl='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_sync_button",a):j.call(e,"str","k_L_toolbar_sync_button",a)))+"'\n            title='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_sync_button_tooltip",
a):j.call(e,"str","k_L_toolbar_sync_button_tooltip",a)))+"'\n        ></div>\n\n        <div\n            id='kindleLibrary_button_manage'\n            class='header_bar_icon'\n            btnLbl='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_manage_button",a):j.call(e,"str","k_L_toolbar_manage_button",a)))+"'\n            title='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_manage_button_tooltip",a):j.call(e,"str","k_L_toolbar_manage_button_tooltip",a)))+"'\n        ></div>\n\n    </div>\n\n    <div id='kindleLibrary_search' class='search libraryControls'>\n\n        <div\n            id='kindleLibrary_button_search'\n            class='search header_bar_icon large'\n            btnLbl='";
a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_search_button",a):j.call(e,"str","k_L_toolbar_search_button",a)))+"'\n            title='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_search_button_tooltip",a):j.call(e,"str","k_L_toolbar_search_button_tooltip",a)))+"'\n        ></div>\n\n        <input\n            id='kindleLibrary_bar_search'\n            disabled='disabled'\n            class='search'/>\n\n        <div\n            id='kindleLibrary_clear_search'\n            class='search'\n        ></div>\n\n    </div>\n\n   <div id='header_right' class='libraryControls'>\n        <div\n            class='kbtn header_bar_icon'\n            id='kindleLibrary_button_store'\n            btnLbl='";
a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_store_button",a):j.call(e,"str","k_L_toolbar_store_button",a)))+"'\n            title='";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_store_button_tooltip",a):j.call(e,"str","k_L_toolbar_store_button_tooltip",a)))+"'\n        >\n                ";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_toolbar_store_button",a):j.call(e,"str","k_L_toolbar_store_button",a)))+"\n        </div>\n    </div>\n\n    <div id='header_center'></div>\n</div>";
return d});h.KindleLibraryHomeScreenPopup=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleAddToHomeScreen" class=\'ui-corner-all\'>\n    <div class="addToHomeIcon"></div>\n    <div class="arrow"></div>\n    <div class="addToHomeText"></div>\n</div>'});h.KindleLibraryImageSlider=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,a=c.helperMissing,j=this.escapeExpression;d+='<div id="scaleHolder">\n<div class="kindleLibrary_scaleHolder" style="position: absolute" /> \n    <div id="view_scale">\n        <div id="kindleLibrary_coverImage_slider"\n        title=\'';
g={hash:{},data:g};d+=j((b=c.str,b?b.call(e,"k_L_toolbar_cover_slider",g):a.call(e,"str","k_L_toolbar_cover_slider",g)))+"'>\n        </div>\n    </div>\n</div>";return d});h.KindleLibraryMessagePane=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j=c.helperMissing,k=this.escapeExpression;d+='<div id=\'empty_library_messages\'>\n\t<div id="empty-lib-box"> \n\t\t<div id="empty-lib-msg"> \n\t\t\t<p class="title"> ';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,
"k_empty_library_title",a):j.call(e,"str","k_empty_library_title",a)))+' </p>\n\t\t\t<p class="main"></p> \n\t\t\t<p class="free">';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_empty_library_free",a):j.call(e,"str","k_empty_library_free",a)))+' </p> \n\t\t\t<p class="legal">';a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_empty_library_legal",a):j.call(e,"str","k_empty_library_legal",a)))+' </p> \n\t\t</div> \n\t\t<div id="empty-lib-booksImg"></div>\n\t</div>\n    <div id="empty_search_box">\n        <div id="empty_search_text"></div>\n        <div id="empty_search_detail"></div>\n    </div>\n</div>';
return d});h.KindleLibraryNoDownloadedMessage=f(function(d,e,c,a,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j=c.helperMissing,k=this.escapeExpression;d+="<div id='kindleLibrary_noDownloadedMessage_div' class='kindleLibrary_noDownloadsMsg'>\n    <div class='kindleLibrary_noDownloadedTitle'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_noDownloadedBooks_title",a):j.call(e,"str","k_noDownloadedBooks_title",a)))+'</div>\n    <div class="kindleLibrary_noDownloadedToggle"> \n    \t<span class="kindleLibrary_noDownloadedArrow kindleLibrary_arrowClosed">\n\t\t</span>\n\t\t<span class="download-hdr"> \n\t\t\t';
a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_noDownloadedBooks_showmore",a):j.call(e,"str","k_noDownloadedBooks_showmore",a)))+" \n\t\t</span>\n    </div>\n    <div class='kindleLibrary_noDownloadedContent' style='display:none'>\n\t\t<span class=\"download-txt\">\n\t\t\t";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_noDownloadedBooks_msg",a):j.call(e,"str","k_noDownloadedBooks_msg",a)))+"\n\t\t</span>\n\t</div>\n</div>";return d});h.KindleLibraryProgressDialog=f(function(d,e,c,a,g){this.compilerInfo=
[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",b,j=c.helperMissing,k=this.escapeExpression;d+="<div id='kindleLibrary_dialog_progress'>\n    <p id='kindleLibrary_dialog_progressTitle' class='kindle_dialog_title_text'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_progress_dialog_title",a):j.call(e,"str","k_L_progress_dialog_title",a)))+"</p>\n    <p id='kindleLibrary_dialog_progressMessage' class='kindle_dialog_text'>";a={hash:{},data:g};d+=k((b=c.str,b?b.call(e,"k_L_progress_dialog_message",
a):j.call(e,"str","k_L_progress_dialog_message",a)))+"</p>\n\t<div id='kindleLibrary_progressbar_div'></div>\n</div>";return d});h.KindleLibraryScrollBar=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleLibrarySliderBar">\n    <a id="kindleLibrarySliderUpArrow" class="library_slider_arrow"></a>\n    <div id="KindleLibrarySliderContainer">\n        <div id="KindleLibrarySliderDiv">\n            <div id="KindleLibraryProgress"></div>\n        </div>\n    </div>\n    <a id="kindleLibrarySliderDownArrow" class="library_slider_arrow"></a>\n</div>'})})();
function KindleModuleManagerFactory(){function f(a,b){if(q[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;q[a]=b;o[a].resolve(b)}function h(a){if(q.hasOwnProperty(a))throw"Duplicate registration of module "+a;q[a]=void 0}function d(a,b){o[a]||(o[a]=new jQuery.Deferred);f(a,b)}function e(a,b){h(a);o[a]||(o[a]=new jQuery.Deferred);b(o[a]);o[a].done(function(b){f(a,b)})}function c(a,b){e(a,function(a){b.done(a.resolve).fail(a.reject)})}function a(a){o[a]||
(o[a]=new jQuery.Deferred);return o[a].promise()}function g(a){if(!q[a])throw"Trying to get uninitialized module "+a;return q[a]}function b(a){return q.hasOwnProperty(a)}function j(a,b){q[a]=b}function k(a){var b=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function p(a){for(var b={},c=0;c<a.length;c++)b[name]=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function m(){q={}}var n={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network"},q={},o={};return{CONSTANTS:n.CONSTANTS,DB_CLIENT:n.DB_CLIENT,RESOURCE_BUNDLE:n.RESOURCE_BUNDLE,METRICS_MANAGER:n.METRICS_MANAGER,SERVICE_CLIENT:n.SERVICE_CLIENT,APP_REGISTRATION:n.APP_REGISTRATION,JOURNAL_MANAGER:n.JOURNAL_MANAGER,
BOOK_METADATA:n.BOOK_METADATA,BOOK_FRAGMAP:n.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:n.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:n.CONTENT_MIGRATION,NETWORK:n.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var b in a)d(b,a[b])},registerModuleWithInitializer:e,registerModuleWithDeferred:c,detachModule:function(a){var b=q[a],c=o[a];c&&!c.isResolved()&&c.reject("canceled");delete q[a];delete o[a];return b},getModule:a,getModuleList:function(b){var c=new jQuery.Deferred,
d,e=[];for(d=0;d<b.length;d++)e.push(a(b[d]));$.when.apply($,e).done(function(){var a,d={};for(a=0;a<b.length;a++)d[b[a]]=arguments[a];c.resolve(d)}).fail(c.reject);return c.promise()},getModuleSync:g,isModuleInitialized:function(a){return q[a]!==void 0},isModuleRegistered:b,switchToTestMode:function(){this.registerModuleTest=j;this.getModule=k;this.getModuleSync=g;this.getModuleList=p;this.clear=m;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(d,
e,g){if(!b(d)){var j=[],k=$.Deferred();c(d,k);e&&e.length&&e.forEach(function(b){j.push(b&&$.isFunction(b.promise)?b:a(b))});$.when.apply($,j).then(function(){var a;typeof g==="function"?(a=$.makeArray(arguments),a=g.apply(g,a)):a=g;a&&$.isFunction(a.promise)?a.then(k.resolve,function(){k.reject()}):k.resolve(a)},function(){k.reject()})}},require:function(b,c){$.isArray(b)||(b=[b]);var d,e,g=[];b.forEach(function(b){g.push(b&&$.isFunction(b.promise)?b:a(b))});c||(e=$.Deferred(),d=e.promise());$.when.apply($,
g).then(function(){var a=$.makeArray(arguments);c?c.apply(c,a):e.resolve.apply(e,a)},function(){c&&e.reject()});return d}}}
var KindleModuleManager=KindleModuleManagerFactory(),BookChunk=function(){var f=Object.freeze?function(c){return Object.freeze(c)}:function(c){return c},h=["fragment","glyph","skeleton","resource","locationMap"],d={};h.forEach(function(c){d[c]={}});d.resource.huge=!0;var e={types:f(h),properties:f(d),getId:function(c){if(c.fragmentMetadata!==void 0)return c.fragmentMetadata.id;else if(c.skeletonMetadata!==void 0)return c.skeletonMetadata.id;else if(c.glyphFragmentMetadata!==void 0)return c.glyphFragmentMetadata.id;
else if(c.metadata!==void 0)return c.metadata.id;else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};h.forEach(function(c){e[c.toUpperCase()+"_TYPE"]=c});return f(e)}(),BookDownloadController=function(){return{create:function(f){function h(){function a(b){if(k[b].waiting)return k[b].waiting=!1,k[b].downloading=!0,k[b].start(),!0}var b=!1,c=!1,d=!1;BookChunk.types.forEach(function(a){b=b||k[a].downloading;d=d||k[a].waiting});m.forEach(function(a){b=b||k[a].downloading;
c=c||k[a].waiting});d?BookChunk.types.some(a):!b&&!c?(KindleDebug.log("done downloading"),j.resolve()):!b&&c&&m.some(a)}function d(a,b){var d=new $.Deferred;if(k[a].remaining<=0)return c(a),d.resolve();var j=f.downloaders[a];j.addEventListener("onProgress",e);j.addEventListener("onCompleted",function(a){c(a);d.resolve()});j.addEventListener("onFailed",function(a,b,c){k[a].waiting=!1;g(b,c);d.reject()});j.start(b,f.fast);k[a].remaining=j.getNumIds();p=p-b+j.getNumIds();return d.promise()}function e(a,
b){if(b!==k[a].remaining){k[a].remaining=b;var c=0;BookChunk.types.forEach(function(a){c+=k[a].remaining});m.forEach(function(a){c+=k[a].remaining});j.notify(c,p)}}function c(a){k[a].downloading=!1;k[a].waiting=!1;h()}function a(a){function c(){KindleDebug.log("Finished downloading sidecar: "+a);k[g].downloading=!1;e(g,0);h()}function d(b){KindleDebug.error("Error downloading sidecar '"+a+"': "+b);k[g].downloading=!1;e(g,0);h()}var g="SC:"+a;m.push(g);k[g]={downloading:!1,waiting:!0,remaining:b};
k[g].start=function(){KindleDebug.log("Downloading sidecar: "+a);f.sidecarManager.download(a).then(c,d)}}function g(a,b){a=a||Kindle.ERROR.CANCELLED;BookChunk.types.forEach(function(a){if(k[a].downloading)f.downloaders[a].cancel(),k[a].downloading=!1});j.reject(a,b)}var b=10,j=$.Deferred(),k={},p=0,m=[];BookChunk.types.forEach(function(a){k[a]={downloading:!1,waiting:!1,remaining:0}});return{startDownload:function(){var c=f.downloadingContentProvider;$.when(c.getBookinfo(),c.computeCacheQuota(),KindleModuleManager.getModule(Kindle.MODULE.SidecarManager)).done(function(c){var e=
c.context.cacheState||c.cacheState;if(e===Kindle.BookInfo.CachedState.CACHED||e===Kindle.BookInfo.CachedState.PINNED)j.resolve();else{var g={skeleton:(Number(c.fragmap.fragmentMetadata.numberOfSkeletons)||1)-1,fragment:Number(c.fragmap.fragmentMetadata.numberOfFragments)-1,glyph:(Number(c.metadata.numOfGlyphFragments)||0)-1,resource:c.manifest&&c.manifest.resourceManifest?Number(Math.max.apply(Math,Object.keys(c.manifest.resourceManifest))):-1,locationMap:c.metadata.locationsInfo&&c.metadata.locationsInfo.numOfLocations?
Math.floor((Number(c.metadata.locationsInfo.numOfLocations)-1)/Number(c.metadata.locationsInfo.mapSize)):-1};BookChunk.types.forEach(function(a){k[a].waiting=!0;k[a].remaining=g[a]+1;k[a].start=function(){d(a,g[a])};p+=g[a]});p+=Object.keys(f.sidecarManager.names).length*b;Object.keys(f.sidecarManager.names).forEach(a);h()}})},failDownload:g,cancelDownload:g,pauseDownload:function(){BookChunk.types.forEach(function(a){k[a].downloading&&f.downloaders[a].pause()})},resumeDownload:function(){BookChunk.types.forEach(function(a){k[a].downloading&&
f.downloaders[a].resume()})},whenDownloadComplete:function(){return j.promise()}}}}}();
function KindleBookDownloaderFactory(f){var h=5E3,d=0,e=1E3,c=$.Deferred().resolve(),a={};f.downloader=a;a.type=f.type;a.cache=f.cache;a.throttle=f.throttle;a.readAheadActive=!1;a.readAheadPauseCount=0;a.dbPutter=f.dbPutter;a.dbGetIdList=f.dbGetIdList;a.dbOosHandler=f.dbOosHandler;a.dbCheckCache=f.dbCheckCache;a.dbIsCached=f.dbIsCached;a.dbIsOos=f.dbIsOos;a.netGetter=f.netGetter;a.urlGetter=f.urlGetter;a.fileGetter=f.fileGetter;a.fileProgress=f.fileProgress;a.downloadError=f.downloadError;a.isIdRequired=
f.isIdRequired||function(){return!0};a.numIds=0;a.pauseReadAhead=function(){this.readAheadPauseCount++};a.resumeReadAhead=function(){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount)};a.setNextId=function(a){if(a!==void 0&&this.readAheadActive)this.nextReadAheadId=a};a.removeIdFromReadAhead=function(a){if(this.readAheadActive){var b;for(b=0;b<this.readAheadIds.length;b++)if(this.readAheadIds[b]===a){this.readAheadIds.splice(b,1);break}for(b=0;b<this.readAheadUrls.length;b++)if(this.readAheadUrls[b].id===
a){this.readAheadUrls.splice(b,1);break}}};a.readAheadOne=function(a){function b(){return!m.readAheadActive||m.readAheadGeneration!==a?!1:!0}function d(){b()&&(m.numReadAheadNetRequests--,m.readAheadUrls.length===0?m.numReadAheadNetRequests===0&&setTimeout(function(){m.getReadAheadUrls(a)},m.interReadWait):setTimeout(function(){m.readAheadOne(a)},m.interReadWait))}function e(a,c){if(b()){if(c==="timeout")m.numReadAhead>1&&m.numReadAhead--;else if(c==="error"&&KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()===
!1){m.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.OFFLINE);m.readAheadActive=!1;return}d()}}function f(a){function e(){b()&&(m.readAheadRemaining--,m.fileProgress(m.readAheadRemaining),d())}function g(a){function k(){m.readAheadActive&&(KindleHostDeviceDetector.isIE()||m.dbPutter(n,e,l),e());c.resolve()}function l(){if(m.readAheadActive)m.readAheadActive=!1,m.dbIsOos();c.reject()}b()&&(a=a||{},!(a.code===Kindle.DB.CONSTRAINT_ERR||a.message==="constraint failed")&&a.code===Kindle.DB.QUOTA_ERR?
c.state()==="pending"?c.then(k):(c=new $.Deferred,m.dbCheckCache(),m.dbOosHandler(k,l)):d())}if(b()){var k=BookChunk.getId(a),n=[];n[k]=a;$.when(c).then(function(){m.dbPutter(n,e,g)})}}var m=this;if(b())if(m.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){m.readAheadOne(a)},m.startReadWait);else if(m.readAheadUrls.length===0&&m.numReadAheadNetRequests===0)m.getReadAheadUrls(a);else for(;m.numReadAheadNetRequests<m.numReadAhead&&m.readAheadUrls.length>0;){m.numReadAheadNetRequests++;
var n=m.readAheadUrls.shift();m.fileGetter(n,f,e)}};a.getReadAheadUrls=function(a){function b(b){d.readAheadUrls=b;setTimeout(function(){d.readAheadActive&&d.readAheadOne(a)},d.interReadWait)}function c(){d.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.NO_URL)}var d=this;if(a===this.readAheadGeneration&&this.readAheadActive)if(d.dbCheckCache()){d.readAheadStillAlive++;for(var e=[],f=0;f<d.readAheadIds.length&&d.readAheadIds[f]<d.nextReadAheadId;)f++;f===d.readAheadIds.length&&(f=0);e=d.readAheadIds.splice(f,
d.numReadAheadUrls);e.length===0?d.refreshReadAheadList(a):(d.nextReadAheadId=f<d.readAheadIds.length?d.readAheadIds[f]:0,d.urlGetter(e,b,c))}else d.readAheadActive=!1};a.refreshReadAheadList=function(c){function b(b){function d(){e.readAheadActive&&e.getReadAheadUrls(c)}if(e.readAheadActive){var j=f.createSubTimer("success");e.readAheadStillAlive++;var o,l=[];for(o in b)l[b[o]]=!0;e.readAheadIds=[];for(o=0;o<=e.maxReadAheadId;o++)!l[o]&&a.isIdRequired(o)&&e.readAheadIds.push(o);j.addCount("needed",
e.readAheadIds.length);j.addCount("total",e.maxReadAheadId+1);j.endTimer();f.endTimer();f.log();if(e.readAheadIds.length>0){if(e.readAheadRemaining=e.readAheadIds.length,e.readAheadRemaining!==e.readAheadRemainingPrev)e.readAheadRemainingPrev=e.readAheadRemaining,setTimeout(d,e.startReadWait)}else e.readAheadActive=!1,e.dbIsCached()}}function d(){f.endTimer();e.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var e=this;if(c===this.readAheadGeneration){var f;this.readAheadActive&&(f=KindleMetricsProfiler("bookDownloader.getIdList"),
this.dbGetIdList(b,d))}};a.readAheadWatchdog=function(){var a=this;if(this.readAheadActive){if(this.readAheadStillAlive===0&&(this.readAheadPauseCount===0||this.readAheadGeneration===0))this.readAheadGeneration++,this.readAheadRemaining<this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=3E4,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?
(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){a.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};a.startReadAhead=function(c,b){var j=this,k=h;if(this.cache){this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=c;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.watchDogTimeout=3E4;
for(var f=this.numIds=0;f<=c;f++)a.isIdRequired(f)&&this.numIds++;this.readAheadRemaining=this.numIds+1;this.readAheadRemainingPrev=this.readAheadRemaining+1;this.generationReadAheadRemaining=this.numIds+2;b?(this.startReadWait=this.interReadWait=k=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=h,this.interReadWait=d,this.startReadWait=e,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);if(this.throttle)this.numReadAhead=1,this.numReadAheadUrls=5;this.debugCounter=
15;setTimeout(function(){j.readAheadWatchdog()},k)}else this.readAheadActive=!1};a.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};a.setReadAheadTimersForTestMode=function(){e=d=h=0};return a}
function KindleReaderBookInfoProviderFactory(){var f="book_context",h="book_metaData",d="book_manifest",e="book_key",c="book_fragmap",a="book_ok_to_download",g="book_skeleton_builder",b="book_resource_urls";return{BookInfo:function(j,k){function p(a,b){V&&V(b-a,b)}function m(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(I).then(function(b){s.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:I,coverData:b}).then(a.resolve,a.reject)},
a.reject);return a.promise()}function n(a){function b(){var c=s.getModuleSync(f);x.updateBookinfo({cacheState:a,context:c}).then(d.resolve,d.reject)}function c(){d.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.CACHED_STATE)}var d=new jQuery.Deferred;C().done(function(){var e;s.isModuleInitialized(f)?(e=s.getModuleSync(f),e.isSample?b():(e={asin:I,kindleSessionId:e.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},s.getModuleSync(s.SERVICE_CLIENT).setOfflineStatus(e).then(b,c))):d.reject()});
return d.promise()}function q(){ba&&(ba.endTimer(),ba.log(),ba=null);var a=N!==L&&N!==Kindle.BookInfo.CachedState.PINNED?n(L):!0;$.when(a).then(function(){m().then(O.resolve,O.resolve)},function(a){a===Kindle.ERROR.NETWORK?O.reject(a,Kindle.ERROR_CODE.CACHED_STATE):O.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});x.getBookStatistics().then(function(a){Q&&(a.fragments!==void 0&&(y.increaseSubCounter(Q,"fragmentCount",a.fragments.count),y.increaseSubCounter(Q,"fragmentsSize",a.fragments.size)),a.glyphs!==
void 0&&(y.increaseSubCounter(Q,"glyphCount",a.glyphs.count),y.increaseSubCounter(Q,"glyphsSize",a.glyphs.size)),y.endMetrics(Q))},function(){Q&&y.endMetrics(Q)})}function o(){function a(){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);q()}function b(a){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);O.reject(a)}function c(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&
(a.stalled?A.downloadController.pauseDownload():A.downloadController.resumeDownload())}A.downloadController?(KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c),A.downloadController.startDownload(),A.downloadController.whenDownloadComplete().then(a,b,[p,O.progress])):T?b():O.reject(Kindle.CACHING.DISABLED)}function l(){if(!s.isModuleRegistered(c)){y.startSubTimer(D,"getFragMap");var a=J.getFragmap();a.done(function(){y.endSubTimer(D,"getFragMap")});
s.registerModuleWithDeferred(c,a)}return s.getModule(c)}function r(a){var b;a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),ga=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,b,256),KindleCompression.lzAddNumbersToDictionary(b,256),P=KindleCompression.lzGetDecompressionDictionary(b))}function t(){function a(b){J.getMetadata().then(function(a){y.endSubTimer(D,
"getMetadata");r(a);b.resolve(a)},b.reject)}s.isModuleRegistered(h)||(y.startSubTimer(D,"getMetadata"),s.registerModuleWithInitializer(h,a));return s.getModule(h)}function u(){if(!s.isModuleRegistered(d)){y.startSubTimer(D,"getManifest");var a=J.getManifest();a.done(function(){y.endSubTimer(D,"getManifest")});s.registerModuleWithDeferred(d,a)}return s.getModule(d)}function H(){var a,b;b={resource:{isIdRequired:function(b){return b in a}}};var c={bookinfo:F,moduleManager:s,contentCache:x,kcrFree:j.kcrFree};
R=s.getModuleSync(Kindle.MODULE.SidecarManager).create(c);J=NetworkContentProvider.create({context:s.getModuleSync(f),asin:I});u().done(function(b){a=b.resourceManifest||{}});T?(b={asin:I,source:J,cache:x,tweaks:b,readAheadAgressively:Z,sidecarManager:R},A=K=DownloadingContentProvider.create(b),window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(y.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):
(A=J,window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(y.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED)));v();G()}function v(){function a(b){s.getModuleList([h,d]).done(function(a){a=KindleBookSkeletonBuilderFactory(A[BookChunk.SKELETON_TYPE],A[BookChunk.RESOURCE_TYPE],a[d],ga);y.endSubTimer(D,"getSkeletonBuilder");b.resolve(a)}).fail(b.fail)}s.isModuleRegistered(g)||(y.startSubTimer(D,
"getSkeletonBuilder"),s.registerModuleWithInitializer(g,a))}function G(){function a(b){s.getModule(d).done(function(a){a=KindleBookResourceUrlTranslator(A[BookChunk.RESOURCE_TYPE],a);y.endSubTimer(D,"getResourceUrlTranslator");b.resolve(a)}).fail(b.fail)}s.isModuleRegistered(b)||(y.startSubTimer(D,"getResourceUrlTranslator"),s.registerModuleWithInitializer(b,a))}function C(){function a(b){var g=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){N=b.cacheState;if(N===Kindle.BookInfo.CachedState.PINNING)L=
Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(N)&&s.registerModule(e,!0)}b.context!==void 0&&s.registerModule(f,b.context);b.metadata!==void 0&&(r(b.metadata),s.registerModule(h,b.metadata));b.manifest!==void 0?s.registerModule(d,b.manifest):s.registerModule(d,{});b.fragmap!==void 0&&s.registerModule(c,b.fragmap);W.resolve(g)}function b(a){function c(){window.location.reload(!0)}a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&y.emit("App::DatabaseGoneOnGetBookInfo",
{breakdown:["Browser"]}).then(c,c);W.resolve()}if(!W){W=new jQuery.Deferred;if(j.contentProvider)x=j.contentProvider;else{var g=s.getModuleSync(s.DB_CLIENT);g.getBookDb()&&(g=g.getBookDb().BookInfoDB(I),x=DatabaseContentCache.create({bookinfoDb:g,asin:I}))}x?x.queryBookinfo().then(a,b):(T=!1,b())}return W.promise()}function w(){Q=y.startMetrics("BookDownload::Reading",{breakdown:["Browser"]});s.getModuleList([f,h,d,c,a]).done(function(a){var b=$.extend({},a[f]);delete b.kindleSessionId;a={metadata:a[h],
manifest:a[d],fragmap:a[c],context:b,cacheState:ia};T?(K.putBookinfo(a),window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(y.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(y.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED))})}
function B(k){function n(a){var j,l=new jQuery.Deferred,k=y.createTimer();if(a)N=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.FORCE_DELETE;else if(N===Kindle.BookInfo.CachedState.PINNED)ia=N=Kindle.BookInfo.CachedState.PINNING,L=Kindle.BookInfo.CachedState.PINNED,j=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(N===Kindle.BookInfo.CachedState.CACHED)N=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.CONTENT_UPGRADE;(x?x.deleteBooksData():$.Deferred().resolve()).fail(l.reject).done(function(){s.detachModule(e);
s.detachModule(c);s.detachModule(h);s.detachModule(d);s.detachModule(f);s.detachModule(g);s.detachModule(b);r=null;k.emit(a?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");l.resolve(j)});return l.promise()}function m(b){function g(){var k;if(b.downloadRestrictionReason)E=b.downloadRestrictionReason.reasonCode,S=b,U.reject(F);else{k=v.createSubTimer("finishStartReading");j.contentProvider&&j.contentProvider.initMetadata({version:b.contentVersion,acr:b.formatVersion});if(s.isModuleInitialized(f)){var n=
s.getModuleSync(f),m=!1;if(n.contentVersion===b.contentVersion&&n.lastPageReadData&&b.lastPageReadData&&n.lastPageReadData.position!==b.lastPageReadData.position)n.lastPageReadData=b.lastPageReadData,m=!0;if(n.isOwned===void 0)n.isOwned=b.isOwned!==void 0?b.isOwned:!0,m=!0;if(n.contentType===void 0)n.contentType=b.contentType||(n.isSample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK),m=!0;m&&x.updateBookinfo({context:n});n.kindleSessionId=b.kindleSessionId;S=n}else S=b,s.registerModule(f,b);
if(b.contentType===Kindle.CONTENT_TYPE.EBSP)!ca&&!b.isOwned&&(T=!1,x=null),s.isModuleInitialized(e)||s.registerModule(e,!0);else if(j.isSample){k.endTimer();v.endTimer();v.log();E=Kindle.ERROR.UNKNOWN_ERR;U.reject(F);return}b.contentChecksum&&!s.isModuleInitialized(e)&&s.registerModule(e,b.contentChecksum);r||(H(),w());$.when(t(),u(),l()).done(function(){k.endTimer();k=v.createSubTimer("resolve");U.resolve(F);k.endTimer();v.endTimer();v.log()}).fail(function(){E=Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
U.reject(F)});R.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))});s.getModuleList([f,h,d,c,a]).done(o).fail(O.reject)}}X=!0;J.endTimer();y.endSubTimer(D,"StartReading");var k=r&&b.contentVersion&&b.contentVersion!==r.context.contentVersion,p=r&&b.formatVersion&&b.formatVersion!==r.context.formatVersion,q=b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,q=q===Kindle.ERROR.CONTENT_LOAN_ENDED||
q===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;M=k||p;k||p||q?n(q).then(g,function(a){E=a;U.reject(F)}):g()}function p(a){X=!1;y.endSubTimer(D,"StartReading");r?(S=r.context,U.resolve(F)):(E=a,U.reject(F));Kindle.BookInfo.CachedState.isFullyDownloaded(N)?(R.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))}),O.resolve()):O.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.START_READING)}function q(a){B.endTimer();
r=a;y.endSubTimer(D,"CheckDB");y.startMetrics("Reader::StartReading");J=v.createSubTimer("startReading");a=$.extend({asin:I},j);if(r&&r.context&&N===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=r.context.kindleSessionId;y.startSubTimer(D,"StartReading");z=aa(a);r&&H();z.then(m,p)}var r,v,B,J,z;O=new jQuery.Deferred;D=k;v=KindleMetricsProfiler("bookInfo.startReading");B=v.createSubTimer("getInfoFromDB");y.startSubTimer(D,"CheckDB");if(j.kcrFree==="only")j.isSample=!0;j.isSample&&!ca?(T=!1,
q(null)):C().done(q);return U.promise()}var z={DISABLED:"Book::Caching::Disabled",ENABLED:"Book::Caching::Enabled"},J=null,x=null,K=null,R=null,A=null,Q,U=$.Deferred(),F,I=j.asin,ca=j.cacheSample,s=k||KindleModuleManager,y=s.getModuleSync(s.METRICS_MANAGER),M,da=null,Y=null,W=null,N=null,ga=null,P=null,T=!0,O=null,V=null,L=Kindle.BookInfo.CachedState.CACHED,Z=!1,ia=Kindle.BookInfo.CachedState.PARTIAL,ba=null,D=null,X,E,S,aa=function(a){var b=new jQuery.Deferred;s.getModuleSync(s.SERVICE_CLIENT).startReading(a).pipe(function(b){var c=
b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,d=[Kindle.ERROR.CONTENT_LOANED,Kindle.ERROR.CONTENT_LOAN_ENDED,Kindle.ERROR.CONTENT_LICENSE_EXCEEDED,Kindle.ERROR.CONTENT_RENTAL_EXPIRED,Kindle.ERROR.SESSION_LIMIT_EXCEEDED];return a.kcrFree&&b&&b.contentType!==Kindle.CONTENT_TYPE.EBSP&&d.indexOf(c)>=0?(a.isSample=!0,s.getModuleSync(s.SERVICE_CLIENT).startReading(a)):b}).pipe(function(c){if(j.basePath)c.basePath=j.basePath;if(j.useNewPath)c.useNewPath=j.useNewPath;if(j.useProdBucket)c.useProdBucket=
j.useProdBucket;var d=c.isSample||!1;if(c.isOwned===void 0)c.isOwned=!d;if(c.contentType===void 0)c.contentType=d?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK;if(a.kcrFree)c.kcrFree=!0;b.resolve(c)},function(){b.reject("timeout")});return b.promise()};return F={getBookInfoDfd:function(){return U.promise()},getAsin:function(){return I},getRefEmId:function(){var a=s.getModuleSync(h);return a.refEmId||a.referenceEmbeddedId||a.guid},isOpenedOnline:function(){return X},getOpenError:function(){return E},
getContext:function(){return S},startReading:function(b,c){s.registerModuleWithDeferred(a,c);return B(b)},doneReading:function(){A.close()},getImageBaseUrl:function(){return s.getModuleSync(f).imageBaseUrl+"/"},getKindleSessionId:function(){return s.getModuleSync(f).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){s.getModule(c).then(a,b)},15)},getBookType:function(){return s.getModuleSync(c).fragmentMetadata.bookType},getBookSkeleton:function(a,b,c){s.getModule(g).then(function(d){d.buildSkeleton(c).then(a,
b)},b)},getBookFragments:function(a,b,c){A[BookChunk.FRAGMENT_TYPE].getChunks(c,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,ga);if(b.paraData!==void 0&&typeof b.paraData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.paraData,P,256);b.paraData=JSON.parse(c)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,c){A[BookChunk.GLYPH_TYPE].getChunks(c,
function(b){if(b.glyphFragmentMetadata.compression===1||typeof b.glyphData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,P,256);b.glyphData=JSON.parse(c);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return s.getModule(h).then(a,b)},getResourceUrls:function(a,c,d){s.getModule(b).then(function(b){b.getResourceUrls(d,a,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return s.getModuleSync(f).lastPageReadData||{}},getLocationConverter:function(){function a(b){var c=
jQuery.Deferred();A[BookChunk.LOCATIONMAP_TYPE].getChunks([b],c.resolve,c.reject);return c}if(da===null){var b={},d=s.getModuleSync(c),e=s.getModuleSync(h);b.locationsInfo=e.locationsInfo;b.minPosition=d.fragmentArray[0].cPos;b.maxPosition=d.fragmentArray[d.fragmentArray.length-1].ePos;b.mapGetter=a;da=KindleUserLocationConverter.getLocationConverter(d.fragmentMetadata.bookType,b)}return da},getPageNumberConverter:function(){return Y},hasCover:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?
s.getModule(d).then(function(a){a=a.coverResource;c.resolve(a!==void 0&&a!==null)},c.reject):c.resolve(!1);return c.promise().then(a,b)},getCoverUrl:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?s.getModule(d).then(function(a){a=a.coverResource;a!==void 0&&a!==null&&A[BookChunk.RESOURCE_TYPE].getChunks(a,function(a){c.resolve(a.data)},c.reject)},c.reject):c.resolve(null);return c.promise().then(a,b)},getCachedAnnotations:function(){return!x?$.Deferred().reject():x.getAnnotations()},
cacheAnnotations:function(a){return!x?$.Deferred().reject():x.putAnnotations(a)},getCachedPageNumbers:function(){return!x?$.Deferred().reject():x.getPageNumbers()},cachePageNumbers:function(a){return!x?$.Deferred().reject():x.putPageNumbers(a)},getBookPositions:function(){var a=new jQuery.Deferred;s.getModule(h).then(function(b){var c=KindleModuleManager.getModuleSync(f);a.resolve({toc:b.positions.toc,srl:c.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},getSearchIndex:function(){return R.getSearchIndex()},
startDownloading:function(b,c){[Kindle.MODULE.SidecarManager,Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager].forEach(function(a){s.isModuleRegistered(a)||(KindleDebug.log("Copying registration of "+a),s.registerModule(a,KindleModuleManager.getModuleSync(a)))});KindleReaderAnnotationManager.clear();L=Kindle.BookInfo.CachedState.PINNED;Z=!0;s.registerModuleWithDeferred(a,c);var d=B(b);O.always(KindleReaderAnnotationManager.clear);return d},cancelDownloading:function(){A.downloadController&&
A.downloadController.failDownload(Kindle.ERROR.CANCELLED)},pauseDownloading:function(){K&&K.downloadController.pauseDownload()},resumeDownloading:function(){K&&K.downloadController.resumeDownload()},getDownloadComplete:function(a){V=a;return O.promise()},isBookDownloaded:function(){return N===Kindle.BookInfo.CachedState.CACHED||N===Kindle.BookInfo.CachedState.PINNED},setCachedState:n,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(s.getModule(h),x.computeQuota()).then(function(b,c){a.resolve({bookSize:b.bookSize,
quota:c})},a.reject);return a.promise()},isUpdated:function(){return!!M}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookSkeletonBuilderFactory(f,h,d,e){function c(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,d){return(c=b[c||d])?'url("'+c+'")':c===null?"none":a}));return a}function a(a,b,c,d){a=a.includes;if(a!==void 0){for(var e,g=0;g<a.length;g++){var f=d[a[g]],l=b[f.metadata.id];if(l.type==="text/css")e=e||{},e[l.name]=f.data}if(e)c.skeletonData=c.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,c){return(b=e[b||c])?'<style type="text/css">'+b+"</style>":a})}}function g(b,d,e,g){if(e!==null){var f=b.resourceManifest,b=b.skeletonManifest[d.skeletonMetadata.id],h;for(h in e){var o=e[h],l=f[o.metadata.id].includes;if(l!==void 0){for(var r={},t=0;t<l.length;t++){var u=e[l[t]];r[f[l[t]].name]=u===void 0?null:u.data}o.data=c(o.data,r)}}a(b,f,d,e);e=b.depends;if(e!==void 0){h=[];for(b=0;b<e.length;b++)o=f[e[b]],o.resInfo!==void 0&&h.push(o.resInfo);d.resourceInfo=h}}g.resolve(d)}var b=
{};b.skeletonManager=f;b.resourceManger=h;b.manifest=d;b.dictionary=e;b.buildSkeleton=function(a){function b(a){a.data=c(a.data,a.resList);r[a.metadata.id]=a;h++;l!==null&&h>=f&&g(t,l,r,d)}var d=new jQuery.Deferred,e=this.dictionary,f=0,h=0,o=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[a]!==void 0&&this.manifest.skeletonManifest[a].depends!==null)o=this.manifest.skeletonManifest[a].depends.slice(),f=o.length;var l=null,r=null,t=this.manifest;this.skeletonManager.getChunks([a],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,e),delete a.skeletonMetadata.compression;h>=f?g(t,a,r,d):l=a},d.reject);f>0&&(r={},this.resourceManger.getChunks(o,b,d.reject));return d.promise()};return b}
var KindleCompression=function(){function f(b,c,d){var e,d=d>0?d:a;for(e in c)c[e]>=d&&(d=c[e]+1);e=d;for(var g in b)for(var d=b[g],j=2;j<=d.length;j++){var l=d.substr(0,j);c.hasOwnProperty(l)||(c[l]=e++)}return c}function h(c,d){var f,n=a;f="";for(var h=0;h<d.length;){var o=d.charAt(h);h++;o.charCodeAt(0)<=e?c.hasOwnProperty(f+o)?f+=o:(f.length>0&&n<g&&(c[f+o]=n,n++,n===b&&(n=j)),f=o):f=""}return c}function d(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=h({},defaultDictionaryString);
return defaultDictionary}var e=9983,c=e+1,a=c+100+1,g=65533,b=55295,j=57344;return{lzCompress:function(d){var f={},m=[],n,h=a,o,l,r;o=n="";for(var t=0;t<d.length;){var u=d.charAt(t);t++;if(u.charCodeAt(0)<=e){for(;o.length>0;){l=Math.min(100,o.length);r=o.substr(0,l);o=o.substr(l);m.push(c+l);for(l=0;l<r.length;l++)m.push(r.charCodeAt(l))}f.hasOwnProperty(n+u)?n+=u:(n.length>0&&(m.push(n.length===1?n.charCodeAt(0):f[n]),h<g&&(f[n+u]=h,h++,h===b&&(h=j))),n=u)}else n.length>0&&(m.push(n.length===1?
n.charCodeAt(0):f[n]),n=""),o+=u}for(n.length>0&&m.push(n.length===1?n.charCodeAt(0):f[n]);o.length>0;){l=Math.min(100,o.length);r=o.substr(0,l);o=o.substr(l);m.push(c+l);for(l=0;l<r.length;l++)m.push(r.charCodeAt(l))}for(i=0;i<m.length;i++)m[i]=String.fromCharCode(m[i]);return m.join("")},lzExpand:function(d){for(var f={},h=[],n,q=a,o="",l,r=0;r<d.length;){n=d.charCodeAt(r);r++;if(n<=e)n=String.fromCharCode(n);else if(n>=a)(n=f[n])||(n=o+l);else{o=n-c;h.push(d.substr(r,o));r+=o;o="";continue}h.push(n);
l=n.charAt(0);q<g&&o.length>0&&(f[q]=o+l,q++,q===b&&(q=j));o=n}return h.join("")},lzBuildDictionary:h,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:f,lzAddNumbersToDictionary:function(a,b){for(var c=[],d=100;d<1E3;d++)c.push(""+d);return f(c,a,b)},lzCompressWithStaticDictionary:function(a,b){if(b===void 0||b==={})b=d();var g=[],j,f,h,l;f=j="";for(var r=0;r<a.length;){var t=a.charAt(r);r++;if(t.charCodeAt(0)<=e){for(;f.length>0;){h=Math.min(100,
f.length);l=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<l.length;h++)g.push(l.charCodeAt(h))}b.hasOwnProperty(j+t)?j+=t:(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]),j=t)}else j.length>0&&(g.push(j.length===1?j.charCodeAt(0):b[j]),j=""),f+=t}for(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]);f.length>0;){h=Math.min(100,f.length);l=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<l.length;h++)g.push(l.charCodeAt(h))}for(i=0;i<g.length;i++)g[i]=String.fromCharCode(g[i]);return g.join("")},
lzExpandWithStaticDictionary:function(b,g,j){if(g===void 0||g===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){d();defaultDeDictionary=[];for(var f in defaultDictionary)defaultDeDictionary[defaultDictionary[f]]=f}g=defaultDeDictionary}f=e;var h=a;j!==void 0&&(f=j-1,h=j);for(var j=[],o=0;o<b.length;){var l=b.charCodeAt(o);o++;l<=f?j.push(String.fromCharCode(l)):l>=h?j.push(g[l]):(l-=c,j.push(b.substr(o,l)),o+=l)}return j.join("")}}}(),ContentMigration=function(){function f(c){function a(a){var b=
"get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"Ids";return c.source[b]().pipe(function(b){function d(){var j=b.splice(0,100);if(j.length===0)e.then(g.resolve,g.reject);else{var f="get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"s",j=c.source[f](j);$.when(j,e).then(function(b){var g={};b.forEach(function(a,b){g[b]=a});e=c.target("putChunksNonT",c.asin,a,g);setTimeout(d,100)},g.reject)}}var e=$.Deferred().resolve(),g=$.Deferred();d();return g.promise()})}function d(){var c=BookChunk.types[e++];c?
a(c).then(d,b.reject):b.resolve()}var b=$.Deferred(),e=0,f=c.timer.createSubTimer("chunks");d();b.done(function(){f.endTimer()});return b.promise()}function h(c){var a=$.Deferred(),d=c.timer.createSubTimer("annotations");c.source.getAnnotations().then(function(b){c.target("putAnnotations",c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}function d(c){var a=$.Deferred(),d=c.timer.createSubTimer("pageNumbers");c.source.getPageNumbers().then(function(b){c.target("putPageNumbers",
c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}function e(c){var a=$.Deferred(),d=c.timer.createSubTimer("bookinfo");c.source.getBookInfo().then(function(b){c.target("putBookinfo",c.asin,b).then(a.resolve,a.reject)},a.reject);a.done(function(){d.endTimer()});return a.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,
a){return{moveBook:function(g){var b=$.Deferred(),j=c.getBookDb();if(!g)return b.reject("Need ASIN as param").promise();var k={timer:KindleMetricsProfiler("Migrate "+g),asin:g,target:a.contentProvider,source:j.BookInfoDB(g)},g=$.when(f(k),h(k),d(k),e(k));g.then(function(){k.timer.endTimer();k.timer.log()});g.then(b.resolve,b.reject);return b.promise()},notifyMigrationStatus:function(a){var b=$.Deferred();if(!a||!a.status)return b.reject("Need param.status as param").promise();a.status==="done"?c.getBookDb().dropTables().then(b.resolve,
b.reject):b.reject("this status is not handled");return b.promise()}}})}}}(),DatabaseContentCache=function(){return{create:function(f){var h=$.Deferred(),d=f.bookinfoDb,e={};BookChunk.types.forEach(function(c){var a=c.substr(0,1).toUpperCase()+c.substr(1);e[c]={getChunks:function(c,b,e){d["get"+a+"s"](c).then(b,e)},putChunks:function(c,b,e){d["put"+a+"s"](c).then(b,e)},getCachedIds:function(c,b){d["get"+a+"Ids"]().then(c,b)}}});e.queryBookinfo=function(){return d.getBookInfo().pipe(function(c){h.resolve(c);
return c})};e.getBookinfo=function(){return h.promise()};e.putBookinfo=function(c){h.resolve(c);return d.insertBookInfo(c)};e.updateBookinfo=d.updateBookInfo;e.getAnnotations=d.getAnnotations;e.putAnnotations=d.putAnnotations;e.getPageNumbers=d.getPageNumbers;e.putPageNumbers=d.putPageNumbers;e.getSearchIndex=d.getSearchIndex;e.putSearchIndex=d.putSearchIndex;e.computeQuota=function(){return d.computeCacheQuota()};e.getBookStatistics=d.getBookStatistics;e.checkCache=function(){var c=d.getCacheQuota();
return c.cachedSize<=c.cacheQuota};e.deleteOldestBook=function(c,a){d.deleteOldestBookData(f.asin).then(c,a)};e.deleteBooksData=function(){bookInfo=void 0;h.state()!=="pending"&&(h=$.Deferred());return d.deleteBooksData([f.asin])};return e}}}(),DownloadingContentProvider=function(){function f(d){function e(d,e,f){function h(a){var c;if(!b){for(c in a)e(a[c]),g.removeId(c);var d=[],j;for(j=0;j<t.length;j++)c=t[j],a[c]===void 0&&d.push(c);t=d;d.length>0?r(d):l()}}function n(){b||r(t)}function q(c){function d(){b||
e(c)}if(!b){var g=BookChunk.getId(c);if(a){var j=[];j[g]=c;a.putChunks(j,d,d);--u===0&&l()}else e(c)}}function o(a,d,e,g){var j;b||(Object.prototype.toString.call(g)==="[object Array]"?(j=g,g="list"):j=[g],v[g]=v[g]+1||1,v[g]<=2?c.getChunks(j,q,o):(f(a,d,e),--u===0&&l()))}function l(){g.setNextId(H);setTimeout(flowControl.resume,0)}function r(a){u=a.length;c.getChunks(a,q,o)}Object.prototype.toString.call(d)!=="[object Array]"&&(d=[d]);var t=d.slice(0),u=0,H=Math.max.apply(Math,t)+1,v=[];a?(flowControl.pause(),
a.getChunks(d,h,n)):r(d)}var c,a,g,b=!1;c=d.source;a=d.cache;g=d.downloader;flowControl=d.flowControl;return{getChunks:e,getPieces:function(a,b,c){return e(a,b,c)},close:function(){b=!0}}}function h(d,e){var c=KindleBookDownloaderFactory({type:e,cache:!0,throttle:BookChunk.properties[e].huge,netGetter:d.source[e].getChunks,urlGetter:d.source[e].getUrls,fileGetter:d.source[e].getChunkFromUrl,dbPutter:d.cache[e].putChunks,dbGetIdList:d.cache[e].getCachedIds,dbCheckCache:d.cache.checkCache,dbOosHandler:d.cache.deleteOldestBook,
fileProgress:function(c){a.callEventListeners("onProgress",e,c)},dbIsCached:function(){a.callEventListeners("onCompleted",e)},dbIsOos:function(){a.callEventListeners("onFailed",e,Kindle.ERROR.OUT_OF_SPACE)},downloadError:function(c,b){a.callEventListeners("onFailed",e,c,b)},isIdRequired:d.tweaks&&d.tweaks[e]&&d.tweaks[e].isIdRequired}),a=ListenerManager();return{start:function(a,b){c.startReadAhead(a,b)},cancel:function(){c.cancelReadAhead()},pause:function(){c.pauseReadAhead()},resume:function(){c.resumeReadAhead()},
setNextId:function(a){c.setNextId(a)},removeId:function(a){c.removeIdFromReadAhead(a)},getNumIds:function(){return c.numIds},addEventListener:function(c,b){a.addEventListener(c,b)}}}return{create:function(d){var e={},c={},a={},g={},b={pause:function(){g.pauseDownload()},resume:function(){g.resumeDownload()}};BookChunk.types.forEach(function(a){c[a]=h(d,a);e[a]=f({type:a,source:d.source[a],cache:d.cache[a],downloader:c[a],flowControl:b})});a={downloadingContentProvider:e,fast:d.readAheadAgressively,
downloaders:c,sidecarManager:d.sidecarManager};g=BookDownloadController.create(a);e.queryBookinfo=d.cache.queryBookinfo;e.getBookinfo=d.cache.getBookinfo;e.putBookinfo=d.cache.putBookinfo;e.computeCacheQuota=d.cache.computeQuota;e.downloadController={startDownload:g.startDownload,failDownload:g.failDownload,cancelDownload:g.failDownload,pauseDownload:g.pauseDownload,resumeDownload:g.resumeDownload,whenDownloadComplete:g.whenDownloadComplete};e.close=function(){d.source.close();g.failDownload();BookChunk.types.forEach(function(a){e[a].close()})};
return e}}}(),KindleO_Aaa=function(){function f(a){for(var b=[],d,e,g,j,f,k,h=0;h<a.length;)g=a.charCodeAt(h++)&255,d=a.charCodeAt(h++),j=d&255,e=a.charCodeAt(h++),f=e&255,k=g>>2,g=(g&3)<<4|j>>4,j=(j&15)<<2|f>>6,f&=63,isNaN(d)?j=f=64:isNaN(e)&&(f=64),b.push(c.charAt(k)+c.charAt(g)+c.charAt(j)+c.charAt(f));return b.join("")}function h(b){for(var c=[],d,e,g,j,f,k=0;k<b.length;)d=a[b.charCodeAt(k++)],e=a[b.charCodeAt(k++)],j=a[b.charCodeAt(k++)],f=a[b.charCodeAt(k++)],d=d<<2|e>>4,e=(e&15)<<4|j>>2,g=
(j&3)<<6|f,c.push(String.fromCharCode(d)),j!==64&&c.push(String.fromCharCode(e)),f!==64&&c.push(String.fromCharCode(g));return c.join("")}function d(a,b){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var e=0,g,d=0;d<256;d++)e=e+c[d]+b[d%b.length]&255,g=c[d],c[d]=c[e],c[e]=g;for(var e=d=0,j=[],f=0;f<a.length;f++)d=d+1&255,e=e+c[d]&255,g=c[d],c[d]=c[e],c[e]=g,j.push(String.fromCharCode(a.charCodeAt(f)^c[c[d]+c[e]&255]));return j.join("")}function e(a,c){for(var d="",e=c?j:b,g=e.length,f=0;f<
a;f++)d+=e.charAt(Math.floor(Math.random()*g));return d}for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=[],g=0;g<c.length;g+=1)a[c.charCodeAt(g)]=g;for(var b="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",j=b+"                                             ",k=[],p=0;p<10;p++)k[p]=e(15,!1);var m=["p","span","div","em","i","strong","b","a","big","small"],n=!1;return{iToStr:function(a,b,c){var d=new Image;d.onload=
function(){var a=KindleHostDeviceDetector.isIE(),c=d.height,e=d.width,g=document.createElement("canvas").getContext("2d");g.drawImage(d,0,0);for(var j,f,l,k,h,n="",m=0,q,p=0;p<c;){j=g.getImageData(0,p,e,1);m=0;for(q=j.data.length-4;m<q;){f=j.data[m++]&7;l=j.data[m++]&3;k=j.data[m++]&7;m++;h=f*32+l*8+k;if(a){var A=void 0,A=0;h>=65&&h<=90||h>=50&&h<=55||h===0?A=h:(A=f>=2?-1:1,A=(f+A+8)%8*32+(l+A+4)%4*8+(k+A+8)%8);A>=65&&A<=90||A>=50&&A<=55||(A=0);h=A}if(h===0)break;n+=String.fromCharCode(h)}if(h===
0)break;p++}b(n)};d.onerror=function(){c()};d.src=a},o_aaa:f,o_aag:h,o_aac:function(a,b){var c;c=a.replace(/\x0d\x0a/g,"\n");for(var e=[],j=0;j<c.length;j++){var k=c.charCodeAt(j);k<128?e.push(String.fromCharCode(k)):(k>127&&k<2048?e.push(String.fromCharCode(k>>6|192)):(e.push(String.fromCharCode(k>>12|224)),e.push(String.fromCharCode(k>>6&63|128))),e.push(String.fromCharCode(k&63|128)))}c=e.join("");e=b;e+="00000000000000000000000000000000".substring(0,32-e.length);j=[];for(g=0;g<e.length;g+=2)j.push(parseInt(e.substring(g,
g+2),16));return f(d(c,j))},o_aad:function(a,b){for(var c=h(a),e=[],g=0;g<b.length;g++)e.push(b.charCodeAt(g));for(var c=d(c,e),e=[],g=0,j,f,k;g<c.length;)j=c.charCodeAt(g),j<128?(e.push(String.fromCharCode(j)),g++):j>191&&j<224?(f=c.charCodeAt(g+1),e.push(String.fromCharCode((j&31)<<6|f&63)),g+=2):(f=c.charCodeAt(g+1),k=c.charCodeAt(g+2),e.push(String.fromCharCode((j&15)<<12|(f&63)<<6|k&63)),g+=3);return e.join("")},o_aae:function(a){var b;if(!n){for(b=0;b<10;b++)$(k[b]).addClass("noDisplay");n=
!0}var c=$(a).html(),d=!1,g="",j=0;for(b=0;b<c.length;b++)if(c[b]===">")d=!1;else if(c[b]==="<")d=!0;else if(b%60===7&&!d){g+=c.substring(j,b);var j=b,f=m[Math.floor(Math.random()*m.length)];g+="<"+f+' class="'+k[Math.floor(Math.random()*k.length)]+'">'+e(30,!0)+"</"+f+">"}g+=c.substring(j,c.length);$(a).html(g)},o_aaf:function(a){a:{for(var b=0;b<k.length;b++)if(k[b]===a){a=!0;break a}a=!1}return a}}}(),KindleReaderAnnotationManager=function(){function f(a,b){return a.start-b.start}function h(a){for(var b=
0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function d(a){function b(){e(a).then(d.resolve,d.reject)}function c(){q(a).then(b,d.reject)}var d=new jQuery.Deferred;d.then(function(){for(var b=0;b<a.length;b++)s.emit(g(a[b]))},function(){for(var b=0;b<a.length;b++)s.emit(g(a[b],"Fail"))});k(a);for(var j=0;j<a.length;j++){if(a[j].asin===void 0||a[j].refEmId===void 0||a[j].start===void 0||a[j].type===void 0)return s.emit(g(a[j],"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),
d.reject().promise();if(a[j].note)a[j].note=l(a[j].note)}M.acquire().done(function(){y=Date.now();ca.saveToJournal(a).then(c,d.reject);d.then(M.release,M.release)});return d.promise()}function e(a){function b(){for(var e,g=!1,j,k=0;k<a.length;k++)j=a[k],e=c(j.type,j.start),j.action===w?e===-1&&(F.push(j),g=!0):j.action===B?e!==-1&&(F.splice(e,1),F.push(j),g=!0):j.action===z&&e!==-1&&F.splice(e,1);g&&F.sort(f);d.resolve();R.cacheAnnotations(F)}var d=new jQuery.Deferred;t().then(b,b);return d.promise()}
function c(a,b){for(var c in F){var d=F[c];if(d.type===a&&d.start===b)return c}return-1}function a(a,b){return F[c(a,Number(b))]||null}function g(a,b){var c="Reader::"+x[a.action]+x[a.type];b&&(c+=b);return c}function b(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=A,a[c].refEmId=Q,a[c].action=w,a[c].modifiedTimestamp=b;return a}function j(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=z,a[c].modifiedTimestamp=b;return a}function k(a){for(var b=0;b<a.length;b++)a[b].positionType=
U;return a}function p(a){b(a);return d(a)}function m(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=B,a[c].modifiedTimestamp=b;return d(a)}function n(a){j(a);return d(a)}function q(a){function b(){function e(a){f.context=a;b()}for(var g,j,f;d<a.length&&!(a[d].action===w&&(a[d].type===v||a[d].type===C));)++d;if(d<a.length){f=a[d++];switch(f.type){case v:g=f.position;j=f.position+J;break;case C:g=f.start,j=f.end}o(g,j).then(e,b)}else c.resolve()}var c=new jQuery.Deferred,d=0;b();return c.promise()}
function o(a,b){da===null&&(da=KindleRenderer.createWordIterator());return da.getText(a,b)}function l(a){a.length>Kindle.opt.maxNoteChars&&(s.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function r(a,c,e,g){var f=KindleReaderAnnotationManager.getAnnotationsInRange(a,c,C),k=f.length,l={type:C,start:a,position:e,end:c},h=[];g&&h.push.apply(h,b([{type:G,start:c,position:e,end:c,note:g}]));if(f.length===1&&a>=
f[0].start&&c<=f[0].end){if(h.length===0)return(new jQuery.Deferred).resolve([f[0]])}else{if(k>0)l.start=Math.min(a,f[0].start),l.end=Math.max(c,f[k-1].end),h.push.apply(h,j(f));h.push.apply(h,b([l]))}return d(h)}function t(){var a=new jQuery.Deferred;R.getCachedAnnotations().then(function(b){b&&b.length!==void 0&&(F=b,h(F));a.resolve()},a.reject);return a.promise()}function u(){function a(){c.resolve()}function b(){c.resolve()}var c=new jQuery.Deferred;I.getAnnotations(A,Q).then(function(c){F=c.annotations;
h(F);R.cacheAnnotations(F).then(a,b)},c.reject);return c.promise()}function H(){function a(){t().then(c.reject,c.reject)}function b(){u().then(c.resolve,a)}var c=new jQuery.Deferred;ca.uploadJournal().then(b,b);return c.promise()}var v="kindle.bookmark",G="kindle.note",C="kindle.highlight",w="create",B="modify",z="delete",J=100,x={};x[v]="Bookmark";x[G]="Note";x[C]="Highlight";x[w]="Create";x[B]="Modify";x[z]="Delete";var K,R=null,A=null,Q=null,U=null,F=null,I=null,ca=null,s,y=Date.now(),M=Lock(),
da=null;return{BOOKMARK:v,NOTE:G,NOTE_ICON:"kindle.note.icon",HIGHLIGHT:C,POPULAR_HIGHLIGHT:"kindle.popular",getLastUpdateTime:function(){return y},deferredInitialize:function(a,b){function c(){K.resolve(e)}function d(a){I=a[b.SERVICE_CLIENT];ca=a[b.JOURNAL_MANAGER];s=a[b.METRICS_MANAGER];H().then(c,c)}var e,g;K||(b=b||KindleModuleManager,K=$.Deferred(),e=this,g=[b.SERVICE_CLIENT,b.JOURNAL_MANAGER,b.METRICS_MANAGER],F=[],a.then(function(a){R=a;A=R.getAsin();Q=R.getRefEmId();U=R.getBookType();R.getContext().isOwned?
b.getModuleList(g).then(d,K.reject):K.reject()},K.reject));return K.promise()},clear:function(){var a=K;K=null;F=[];A=Q=U=null;a&&a.reject()},getAnnotation:a,getAllAnnotations:function(){return F.slice()},getAnnotationsInRange:function(a,b,c){var d=[],e;for(e in F){var g=F[e];(g.start<=b&&g.end>=a||g.start>=a&&g.start<=b)&&(!c||c===g.type)&&d.push(g)}return d},createBookmark:function(a){return p([{type:v,start:a,position:a,end:a,context:""}])},createNote:r,modifyNote:function(b,c,d){var e=new jQuery.Deferred;
(b=a(G,b))?(b.note=d,b.position=c,m([b]).then(e.resolve,e.reject)):e.reject();return e.promise()},createHighlight:function(a,b,c){return r(a,b,c,null)},deleteAnnotations:n,getContext:o,updateAnnotations:function(a){for(var b,c=[],d=[],e=[],g=[],j=0;j<a.length;j++)switch(b=a[j],b.action){case w:c.push(b);break;case B:e.push(b);break;case z:d.push(b)}c.length>0&&g.push(p(c));e.length>0&&g.push(m(e));d.length>0&&g.push(n(d));return $.when.apply($,g)}}}(),NetworkContentProvider=function(){var f=3E4;return{create:function(h){function d(a,
b){var c=new jQuery.Deferred;$.jsonp({url:a,callback:b,cache:!0,timeout:f,error:function(a,b){c.reject(a,b)},success:function(a){c.resolve(a)}});return c.promise()}function e(a,b,c){function e(a,b,c){var d,g;if(a&&a.length)for(d=0;d<a.length;d++)g=b+a[d].id,c(a[d].signedUrl,g,a[d].id)}e(a.skeletonUrls,"loadSkeleton",function(a,e,g){d(a,e).then(function(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.skeletonData,j);a.skeletonData=c;delete a.skeletonMetadata.encryption}b(a)},
function(a,b){c(null,b,null,g)})});e(a.fragmentUrls,"loadFragment",function(a,e,g){d(a,e).then(function(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.fragmentData,j);a.fragmentData=c;delete a.fragmentMetadata.encryption}b(a)},function(a,b){c(null,b,null,g)})});e(a.glyphUrls,"loadGlyphFragment",function(a,e,g){d(a,e).then(function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=g;b(a)},function(a,b){c(null,b,null,g)})});e(a.resourceUrls,
"loadResource",function(a,e,g){d(a,e).then(b,function(a,b){c(null,b,null,g)})});e(a.locationMapUrls,"loadMobiLocationMap",function(a,e,g){d(a,e).then(b,function(a,b){c(null,b,null,g)})})}function c(a,c){var d={asin:h.asin,contentVersion:b.contentVersion,formatVersion:b.formatVersion,isSample:b.isSample};if(b.kindleSessionId)d.kindleSessionId=b.kindleSessionId;if(b.basePath)d.basePath=b.basePath;if(b.useNewPath)d.useNewPath=b.useNewPath;if(b.useProdBucket)d.useProdBucket=b.useProdBucket;if(b.kcrFree)d.kcrFree=
!0;d[a+"Ids"]=c;return g.getFileUrl(d)}function a(a,b,d,g){Object.prototype.toString.call(b)!=="[object Array]"&&(b=[b]);c(a,b).then(function(a){k||e(a,d,g)},function(a,c,d){g(a,c,d,b)})}var g,b,j,k=!1;b=h.context;j=b.contentChecksum;g=KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT);var p={};BookChunk.types.forEach(function(b){p[b]={getChunks:function(c,d,e){a(b,c,d,e)},getUrls:function(a,d,e){c(b,a).then(function(a){d(a[b+"Urls"])},e)},getChunkFromUrl:function(a,c,d){var g={};g[b+
"Urls"]=[a];e(g,c,d)}}});p.getFragmap=function(){var a=$.Deferred();d(b.fragmentMapUrl,"loadFragmap").then(function(b){a.resolve(b)},function(b,c){a.reject(c)});return a.promise()};p.getMetadata=function(){var a=$.Deferred();d(b.metadataUrl,"loadMetadata").then(function(b){a.resolve(b)},function(b,c){a.reject(c)});return a.promise()};p.getManifest=function(){function a(b){e.resolve(b)}function c(){e.resolve({})}var e=$.Deferred();b.manifestUrl?d(b.manifestUrl,"loadManifest").then(a,c):e.resolve({});
return e.promise()};p.close=function(){k=!0};return p}}}(),RemoteContentCache=function(){return{create:function(f){function h(a){g=a;if(!d||d.state!=="pending")d=$.Deferred();d.resolve(g)}var d=$.Deferred(),e=f.asin,c=f.contentProvider,a=f.contentRemover,g,b={};BookChunk.types.forEach(function(a){b[a]={getChunks:function(b,d,g){c("getChunks",e,a,b).then(d,g)},putChunks:function(b,d,g){var f={};b.forEach(function(a,b){f[b]=a});c("putChunks",e,a,f).then(d,g)},getCachedIds:function(b,d){c("getChunkIds",
e,a).then(b,d)}}});b.queryBookinfo=function(){return c("getBookinfo",e).pipe(function(a){h(a);return a})};b.getBookinfo=function(){return d.promise()};b.putBookinfo=function(a){h(a);return c("putBookinfo",e,a)};b.updateBookinfo=function(a){if(!g)return $.Deferred().reject("bad state");$.extend(g,a);return c("updateBookinfo",e,a)};b.getAnnotations=function(){return c("getAnnotations",e)};b.putAnnotations=function(a){return c("putAnnotations",e,a)};b.getPageNumbers=function(){return c("getPageNumbers",
e)};b.putPageNumbers=function(a){return c("putPageNumbers",e,a)};b.computeQuota=function(){return $.Deferred().resolve(0)};b.getBookStatistics=function(){return $.Deferred().reject()};b.checkCache=function(){return!0};b.deleteOldestBook=function(a,b){b()};b.deleteBooksData=function(){g=void 0;d.state()!=="pending"&&(d=$.Deferred());return a({asin:e})};b.downloadSearchIndex=function(a){return c("getSearchIndexReader",e,a)};b.initMetadata=function(a){return c("initMetadata",e,a)};return b}}}();
function KindleBookResourceUrlTranslator(f,h){var d={};d.resourceManger=f;d.resourceManifest=h.resourceManifest;d.reverseLookup={};for(var e in d.resourceManifest)d.reverseLookup[d.resourceManifest[e].name]=e;d.getResourceUrls=function(c,a,d){function b(b){var c={};c[m[b.metadata.id].name]=b.data;a(c)}for(var e=[],f=0;f<c.length;f++){var h=this.reverseLookup[c[f]];h!==void 0&&e.push(h)}var m=this.resourceManifest;e.length!==c.length&&d();e.length>0?this.resourceManger.getChunks(e,b,d):a({})};return d}
(function(){function f(a){function b(e){for(var g={},f,j=0;j<e.length;j++)if(f=e[j].filename,f.endsWith(m.words))g.words=e[j].data;else if(f.endsWith(m.properties))g.properties=e[j].data;else if(f.endsWith(m.positions))g.positions=e[j].data;g.asin=a.asin;d.endTimer();d.log();c.notify("finished");c.resolve(g)}var c=new $.Deferred,d=KindleMetricsProfiler("unzip search index");if(a.length>1)return KindleDebug.error("Cannot Unzip: We have too many array buffers"),c.reject("Index too large");KindleZip.unzip(a[0]).pipe(b,
b);return c.promise()}function h(a,b){for(var c=KindleMetricsProfiler("decrypt search index"),d=b.decryptionIV,e=b.decryptionKey,g=[],f,j=0;j<a.length;j++)f=KindleCrypto.decrypt(a[j],e,d),f=f.buffer,g.push(f);g.asin=b.asin;c.endTimer();c.log();return g}function d(b){function c(a){function d(){w.endTimer();A.push(z.response);K+=J;K<R?(x-=Date.now(),x<k?J*=2:x>p&&(J/=2),h()):(B.endTimer(),B.log(),Q.resolve(A,m))}function e(a){a.lengthComputable?(a=Math.floor(100*a.loaded/a.total),a!==q&&(q=a)):KindleDebug.log("progress unknown")}
function g(){KindleDebug.error("An error occurred while transferring the file.");Q.reject("failed")}function f(){KindleDebug.error("The transfer has been canceled by the user.");Q.reject("cancelled")}function h(){x=Date.now();w=B.createSubTimer("@"+K);var a=Math.min(K+J-1,R);z=new XMLHttpRequest;z.open("GET",C);z.setRequestHeader("Range","bytes="+K+"-"+a);z.responseType="arraybuffer";z.addEventListener("progress",e,!1);z.addEventListener("load",d,!1);z.addEventListener("error",g,!1);z.addEventListener("abort",
f,!1);z.send(null)}var m=a;if(m.s3Url===null)return $.Deferred().reject(Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE);m.asin=b.asin;var q=-1,C=m.s3Url.replace(/http:\/\//,"https://"),w,B=KindleMetricsProfiler("download search index"),z,J=j,x,K=0,R=m.indexSize-1,A=[],Q=$.Deferred();h();return Q}return KindleHostDeviceDetector.isOnline()?a.getSearchIndexInfo(b).pipe(c,function(a){return a.status===0?$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE):$.Deferred().reject(Kindle.ERROR.SITB_COMMON_ERROR)}):$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE)}
function e(a){function c(b){return!a.contentCache?$.Deferred().resolve(b):a.contentCache.putSearchIndex(b)}if(!KindleDeviceCapabilities.searchInTheBook())return $.Deferred().reject("Unsupported OS");if(b[a.asin])return b[a.asin];b={};b[a.asin]=(!a.contentCache?$.Deferred().reject("no db"):a.contentCache.getSearchIndex()).pipe(null,function(){return d(a).pipe(h).pipe(f).pipe(c)}).pipe(g.openSearchIndex);return b[a.asin]}function c(a){return a.contentCache.downloadSearchIndex({asin:a.asin})}var a,g,
b={},j=16777216,k=1E4,p=2E4,m={words:".words",positions:".positions",properties:".properties"};KindleModuleManager.define(Kindle.MODULE.SearchIndexManager,[Kindle.MODULE.SERVICE_CLIENT,Kindle.MODULE.DB_CLIENT,"SearchIndexParser"],function(b,d,f){a=b;g=f;return{getSearchIndex:KindleHostDeviceDetector.isMetro()?c:e}})})();
(function(){function f(d){function e(){return KindleDebug.assert.apply(KindleDebug,arguments)}function c(){return KindleDebug.log.apply(KindleDebug,arguments)}function a(){return $.Deferred().reject.apply($,arguments)}function g(a){for(var a=new Uint8Array(d[a]),b=[],c=0;c<a.byteLength;c++)b.push(String.fromCharCode(a[c]));a=b.join("");return $.Deferred().resolve(a)}function b(b,c,d,g,f){b=b.cloneStream();b.seek(c);return b.readAsync(d).pipe(function(c){function d(){switch(g){case 1:return j.readByte()+
f;case 2:return j.readInt16()+f;case 3:return(j.readByte()<<16)+j.readUInt16()+f;case 4:return j.readInt32()+f;default:e("Got unexpected bytes-per-entity:"+g)}}try{for(var j=c,c=[];j.unconsumedBufferLength>0;)c.push(d());j.close();b.close();return c}catch(k){return b.close(),a(k)}},b.close)}function f(a,c){var d=a.directory.BytesPerEntity;return b(a.positionsStream,a.directory.Positions.offset+c.o*d,c.n*d,d,a.directory.MinimumTitleEntityValue)}var k={magicLength:4,magic:"AZSA",headerOffset:-28,directoryOffset:-24,
stringEntries:["Magic","WhereIndexed","IndexerHelperClassName"],wordsFilename:"index.words",positionsFilename:"index.positions",propertiesFilename:"index.properties"},p=$.Deferred();(function(b){var c,d,e,g=b.positionsStream,f=Math.min(g.size,Math.abs(k.headerOffset));g.seek(Math.max(0,g.size+k.headerOffset));return b.positionsStream.readAsync(f).pipe(function(c){try{var g=c.readInt32();d=c.readInt32();e=c.readInt32();c.close();if(g!==b.positionsStream.size)return a("bad header size");b.positionsStream.seek(d);
return b.positionsStream.readAsync(e)}catch(f){return a(f)}}).pipe(function(d){try{c={Magic:{offset:0,length:k.magicLength,isString:!0}};for(var e,g,f,j;d.unconsumedBufferLength>0;)if(e=d.readInt32(),g=d.readInt32(),f=d.readByte(),j=d.readString(f),c[j]={offset:e,length:g},k.stringEntries.indexOf(j)>=0)c[j].isString=!0;d.close();var h=c.SearchBoundaryPositions.offset;b.positionsStream.seek(0);return b.positionsStream.readAsync(h)}catch(l){return a(l)}}).pipe(function(d){function e(a){for(var b=Object.keys(c),
d=0;d<b.length;++d)if(c[b[d]].offset===a)return b[d]}try{for(var g,f=0;d.unconsumedBufferLength>0;){g=e(f);if(!g)return d.close(),a("Can't read directory entries");f+=c[g].length;if(c[g].isString)c[g]=d.readString(c[g].length);else if(c[g].length===1)c[g]=d.readByte();else if(c[g].length===4)c[g]=d.readInt32();else return d.close(),a("Bad size for numeric entry")}d.close();if(c.Magic!==k.magic)return a("bad magic");b.directory=c;return b}catch(j){return a(j)}})})({getPositionsForWord:function(a){var b=
$.Deferred(),d=this.wordList[a],e={word:a,searchBoundaryPositions:this.searchBoundaryPositions,positions:[]};d?f(this,d).pipe(function(d){c('Word "'+a+'" has '+d.length+" occurances");e.positions=d;b.resolve(e)},function(){b.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)}):b.resolve(e);return b.promise()},getProperty:function(a){return this.properties[a]},close:function(){this.positionsStream=null},positionsStream:new h(d.positions)}).pipe(function(a){return g("words").pipe(function(b){var c={};b.split("\n").forEach(function(a){a=
a.split(":");c[a[2]]={o:a[0],n:a[1]}});a.wordList=c;return a})}).pipe(function(a){return g("properties").pipe(function(b){var c={},d=/(.*?)=(.*)/;b.split("\n").forEach(function(a){a&&(a=d.exec(a),a.length===3&&(c[a[1]]=a[2]))});a.properties=c;return a})}).pipe(function(a){return b(a.positionsStream,a.directory.SearchBoundaryPositions.offset,a.directory.SearchBoundaryPositions.length,a.directory.BytesPerEntity,a.directory.MinimumTitleEntityValue).pipe(function(b){a.searchBoundaryPositions=b;return a})}).pipe(p.resolve,
function(){p.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)});return p.promise()}var h;KindleModuleManager.define("SearchIndexParser",["SearchIndexUtilities"],function(d){h=d.Stream;return{openSearchIndex:f}})})();
(function(){function f(d){if(!(this instanceof f)){var e=Object.create(f.prototype);return f.apply(e,arguments)}this.bytes=new Uint8Array(d);this.position=0;this.size=this.bytes.length;return this}function h(d,e,c){if(!(this instanceof h)){var a=Object.create(h.prototype);return h.apply(a,arguments)}this.uBytes=d.bytes;this.bytes=new Int8Array(this.uBytes);this.base=e!==void 0?e:0;this.position=0;this.unconsumedBufferLength=this.size=c!==void 0?c:this.uBytes.length-this.base;return this}if(!Uint8Array.prototype.subarray)Uint8Array.prototype.subarray=
function(d,e){for(var d=d===void 0?0:d,e=e===void 0||e>copy.length?copy.length:e,c=new Uint8Array(e-d),a=0;a<c.length;a++)c[a]=this[a+d];return c};f.prototype.seek=function(d){this.position=Math.min(Math.max(d,0),this.size)};f.prototype.readAsync=function(d){return $.Deferred().resolve(new h(this,this.position,Math.min(d,this.size-this.position)))};f.prototype.cloneStream=function(){var d=new f(this.bytes);d.position=this.position;return d};f.prototype.close=function(){this.bytes=null};h.prototype.seek=
function(d){this.position=Math.min(Math.max(d,0),this.size);this.unconsumedBufferLength=this.size-this.position};h.prototype.getPosition=function(){return this.position};h.prototype.readByte=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var d=this.uBytes[this.base+this.position];this.position++;this.unconsumedBufferLength--;return d};h.prototype.readInt8=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var d=this.bytes[this.base+this.position];this.position++;
this.unconsumedBufferLength--;return d};h.prototype.readInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var d=this.base+this.position,d=(this.bytes[d]<<8)+this.uBytes[d+1];this.position+=2;this.unconsumedBufferLength-=2;return d};h.prototype.readUInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var d=this.base+this.position,d=(this.uBytes[d]<<8)+this.uBytes[d+1];this.position+=2;this.unconsumedBufferLength-=2;return d};h.prototype.readInt32=
function(){return(this.readInt16()<<16)+this.readUInt16()};h.prototype.readUInt32=function(){return(this.readUInt16()<<16)+this.readUInt16()};h.prototype.readString=function(d){if(this.unconsumedBufferLength<d)throw Error("Out of data");var e=this.base+this.position,c;try{c=String.fromCharCode.apply(null,this.uBytes.subarray(e,e+d))}catch(a){c=[];for(var g=e;g<e+d;g++)c.push(String.fromCharCode(this.uBytes[g]));c=c.join("")}this.position+=d;this.unconsumedBufferLength-=d;return c};h.prototype.close=
function(){this.unconsumedBufferLength=0;this.uBytes=this.bytes=null};KindleModuleManager.define("SearchIndexUtilities",null,{Stream:f,Buffer:h})})();
(function(){function f(e){function c(){if(!b)if(l.seek(0),g=l.readInt16(),g!==1)KindleDebug.warn("Unsupported page numbering file format version "+g);else if(f=l.readInt16(),f===0)KindleDebug.log("PageNumbers File for this book is revoked by the service"),b=Kindle.ERROR.PN_REVOKED;else{k=[];for(var a=0;a<f;a++)k[a]=l.readUInt32();a=l.readUInt32();b=a>0?l.readString(a):"";p=[];q=[];m=[];n=[]}}function a(a){c();var b;a>=f||a<=-1?(KindleDebug.log("The requested page numbering edition at index "+a+" is out of bounds for the available count of editions "+
f),b=!1):b=!0;if(b&&!n[a])if(l.seek(k[a]),b=l.readInt16(),b!==1)KindleDebug.log("Unsupported edition pagination format "+b+" for edition "+a);else{b=l.readInt16();var d=l.readInt16(),e=l.readInt16();if(e>32)KindleDebug.log("Unsupported pagination format position width "+e+" for edition "+a);else{var g;b>0&&(g=l.readString(b));p[a]=parseInt(l.getPosition(),10);q[a]=d;m[a]=e;n[a]=g;return!0}}}var g,b,f,k,p,m,n,q,o=[],e=new d(e),l=new h(e,0,e.size);return{getHeaderMetadata:function(){c();return b},getEditionMetadata:function(b){return a(b)?
n[b]:!1},getOrdinalPagePositions:function(b){a(b);var c=q[b],d=m[b]/8;o.length=c+1;l.seek(p[b]);for(b=1;b<=c;b++){var e=d===2?l.readUInt16():d===4?l.readUInt32():0;o[b]=parseInt(e,10)}for(c=1;c<o.length;c++)o[c-1]>o[c]&&KindleDebug.log("Invalid position value at index "+c+": "+o[c]+", previous position: "+o[c-1]);return o},getEditionCount:function(){return f},getTotalPageCount:function(a){return q[a]}}}var h,d;KindleModuleManager.define("BinaryPageLabelSidecarReader",["SearchIndexUtilities"],function(e){h=
e.Buffer;d=e.Stream;return{openReader:f}})})();
var PageLabelIndexer=function(){return{create:function(f,h){function d(b){var c=0,d;for(d in a)a[d].getPageLabelType()===b&&a[d].getEndingOrdinalPageNumber()>c&&(c=a[d].getEndingOrdinalPageNumber());return c}function e(c){var d,e;c<1||c>b?e=void 0:(e=PageNumberUtilities.binarySearchPosition(g,c),e=a[g[e]]);e&&(c-=e.getStartingOrdinalPageNumber(),c=e.getStartingPageLabel()+c,d=e.getPageLabelAtSeriesIndex(c));return d}var c="",a,g,b;if(f==="")KindleDebug.log("pageLabelIndexString cannot be blank, pageLabelIndexString = "+c);
else if(h<0)KindleDebug.log("TotalPages cannot be less than 0, total pages = "+h);else{c=f.toString();b=h;var j=0,k=null;for(a={};j<c.length;){if(c.charAt(j)!=="("){KindleDebug.log("Each page number scheme must start with '('; was given: "+c.substring(j));return}var p=c.indexOf(")",j);if(p<0)break;j=c.substring(j+1,p);j=PageLabelSeq.create(j);k!==null&&k.setEndingOrdinalPageNumber(j.getStartingOrdinalPageNumber()-1);k=a[parseInt(j.getStartingOrdinalPageNumber(),10)]=j;j=p+1;j<c.length&&c.charAt(j)===
","&&j++}k.setEndingOrdinalPageNumber(h);g=[];var c=0,m;for(m in a)a.hasOwnProperty(m)&&(g[c]=a[m].getStartingOrdinalPageNumber(),c++);g.sort(function(a,b){return a-b});return{getLabelSequences:function(){return a},getOrdinalPageForPageLabelText:function(b){var c=null,d=0,e;for(e in a){var g=a[e];if(g.isLabeled()){g.getStartingOrdinalPageNumber()<=d&&(c=null);var f=g.getOrdinalPageForPageLabelText(b);f>=0&&(c=g,d=f)}}return c===null||d>h?0:d},getPageLabelTextForOrdinalPage:e,getHighestPageLabel:function(){var a=
d("a");a===0&&(a=d("r"));var b="";a>0&&(b=e(a));return b},getPageNumberRanges:function(){var b={},c;for(c in a){var d={},e=a[c];d.minPage=e.getStartingPageLabel();d.maxPage=e.getEndingPageLabel();e=PageLabelType[e.getPageLabelType()];b[e]=d}return b}}}}}}(),PageLabelSeq=function(){return{create:function(f){function h(){return c}function d(){return a}function e(){return a+j-c}var c,a,g,b,j,f=f.split(",");j=c=parseInt(f[0],10);g=f[1].charAt(0);if(g===null)console.error("Unknown Page Numbering scheme");
else return a=0,b=null,g==="c"?(b=f[2].split("|"),a=1):g!=="i"?a=parseInt(f[2],10):f[2]&&(a=parseInt(f[2],10)),{getStartingPageLabel:d,getStartingOrdinalPageNumber:h,getPageLabelType:function(){return g},getEndingPageLabel:e,getDisplayPageRange:function(){return[a,e()]},getEndingOrdinalPageNumber:function(){return j},setEndingOrdinalPageNumber:function(a){j<c&&console.error("ending ordinal page number must be >= than starting ordinal page number,endingOrdinalPageNumber  = "+j+", startingOrdinalPageNumber = "+
c);j=a},isLabeled:function(){return g!=="i"},getPageLabelAtSeriesIndex:function(a){var c;g==="a"?c=a.toString():g==="r"?c=PageNumberUtilities.toRomanNumeral(a).toString().toLowerCase():g==="i"?c="":g==="c"&&(a-=1,c=a<b.length?b[a]:"");return c},getOrdinalPageForPageLabelText:function(d){var e=0,f=!1;if(g==="a")try{e=parseInt(d,10),f=e>=a}catch(j){e=0,f=!1}g==="r"&&PageNumberUtilities.isValidRomanNumeral(d)&&(e=PageNumberUtilities.parseRomanNumeral(d),f=e>=a);g==="c"&&b!==null&&(b[d]&&(e=b[d]+1),e>
0&&(f=!0));return!f?-1:c+(e-a)}}}}}(),PageNumberProvider=function(){return{create:function(f){var h=!1,d,e=[],c=-1,a=0;if(f){e=f.oPNToPosition;a=f.totalPages;d=PageLabelIndexer.create(f.pageMapString,a);var f=d.getLabelSequences(),g=a=null,b;for(b in f){if(f[b]===null){KindleDebug.log("Page number sidecar edition doesn't contain a valid page label index");return}a===null&&(a=f[b]);g=f[b]}h=!0;c=a.getStartingOrdinalPageNumber();g.getEndingOrdinalPageNumber()}return{arePageNumbersAvailable:function(){return h},
pageNumberFromPosition:function(a){var b;if(a>=e[c]){a=PageNumberUtilities.binarySearchPosition(e,a);a<c&&(a=c);var g;a>=1&&(g=d.getPageLabelTextForOrdinalPage(a));b=g}return b},positionFromPageNumber:function(a){var b=d.getOrdinalPageForPageLabelText(a);b<=0&&parseInt(a,10);if(b<=0)return-1;b>=e.length&&(b=e.length-1);return e[b]},getMaxPageNumberLabel:function(){return d.getHighestPageLabel()},getPageNumberRanges:function(){return d.getPageNumberRanges()}}}}}();
(function(){function f(a){function c(){e.endTimer();f.emit("Service::GetPageNumber");j.resolve(h.response)}function d(){KindleDebug.error("An error occurred while transferring the file.");j.reject(Kindle.ERROR.PN_DOWNLOAD_FAIL)}var e,f,j,h;return function(a){j=$.Deferred();h=new XMLHttpRequest;h.open("GET",a);h.responseType="arraybuffer";h.addEventListener("load",c,!1);h.addEventListener("error",d,!1);e=b.createSubTimer("download page numbers");f=g.createTimer();h.send(null);return j.promise()}(a)}
function h(a){var b=$.Deferred();a.getCachedPageNumbers().then(function(a){a?b.resolve(a):b.reject()},b.reject);return b.promise()}function d(a){var b=a.getContext().pageNumberUrl;return!b?(g.emit("PageNumber::Unavailable"),$.Deferred().resolve()):h(a).pipe(null,function(){return f(b).pipe(c).done(a.cachePageNumbers)}).pipe(function(a){g.emit("PageNumber::Success");return a},function(a){a===Kindle.ERROR.PN_DOWNLOAD_FAIL&&g.emit("PageNumber::DownloadFailure");g.emit("PageNumber::Fail")})}function e(a){var c=
a.getAsin();if(!j[c]){if(!KindleDeviceCapabilities.showPageNumbers())return $.Deferred().reject("Unsupported OS");b=KindleMetricsProfiler("get page numbers");j={};j[c]=d(a).pipe(function(a){var c;a&&(c=PageNumberProvider.create(a));b.endTimer();b.log();return c})}return j[c]}function c(c){function d(a){a===Kindle.ERROR.PN_REVOKED?g.emit("PageNumber::RevokedData"):g.emit("PageNumber::CorruptData");return $.Deferred().reject()}var e=g.createTimer(),f=b.createSubTimer("parse page number file"),c=a.openReader(c),
j=c.getHeaderMetadata();if(j){if(j===Kindle.ERROR.PN_REVOKED)return d(Kindle.ERROR.PN_REVOKED)}else return KindleDebug.log("Corrupt Header Data for Page Number."),d();if(!JSON.parse(j).fileRevisionId)return KindleDebug.log("Page number sidecar header doesn't contain appropriate metadata (missing fileRevisionId)."),d();if(c.getEditionCount()>0){j=c.getEditionMetadata(0);if(!j)return KindleDebug.log("Edition Header corrupted for Page Number."),d();j=JSON.parse(j);if(!j.pageMap)return KindleDebug.log("Page number sidecar edition doesn't contain appropriate metadata (missing pageMap)."),
d();c={oPNToPosition:c.getOrdinalPagePositions(0),pageMapString:j.pageMap,totalPages:c.getTotalPageCount(0)};e.emit("PageNumber::FileParse");f.endTimer();return c}else return d()}var a,g,b,j={};KindleModuleManager.define(Kindle.MODULE.PageNumberManager,[Kindle.MODULE.DB_CLIENT,Kindle.MODULE.METRICS_MANAGER,"BinaryPageLabelSidecarReader"],function(b,c,d){g=c;a=d;return{getPageNumbers:e}})})();
var PageLabelType={r:"roman",a:"arabic",c:"custom",i:"insert"},PageNumberUtilities=function(){var f={M:1E3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},h=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];return{toRomanNumeral:function(d){for(var e="",d=parseInt(d,10),c=0;c<h.length;c++)for(var a=h[c];d>=f[a];)e+=a,d-=f[a];return e},parseRomanNumeral:function(d){for(var d=d.toUpperCase(),e=0,c=0;c<d.length-1;)f[d.charAt(c)]<f[d.charAt(c+1)]?e-=f[d.charAt(c)]:e+=f[d.charAt(c)],
c++;e+=f[d[c]];return e},binarySearchPosition:function(d,e){for(var c=0,a=d.length-1,g;c<=a;)if(g=Math.floor((c+a)/2),d[g]<e)c=g+1;else if(d[g]>e)a=g-1;else return g;return a>=0?a:c},isValidRomanNumeral:function(d){return/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/.exec(d.toString().toUpperCase())?!0:!1}}}();
(function(){function f(a){function g(){return KindleReaderAnnotationManager.deferredInitialize(a.bookinfo.getBookInfoDfd(),a.moduleManager)}function b(){var b;return a.bookinfo.getBookInfoDfd().pipe(function(a){b=a;return b.getMetadata()}).pipe(function(c){var d=b.getContext(),g=b.getAsin();return c.headerMetadata&&(c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.COMIC||c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.CHILDREN)?$.Deferred().resolve():e.getSearchIndex({asin:g,
formatVersion:d.formatVersion,contentVersion:d.contentVersion,contentCache:a.contentCache,kcrFree:a.kcrFree})})}function f(){return a.bookinfo.getBookInfoDfd().pipe(c.getPageNumbers)}return{names:Object.freeze(d),getAnnotations:g,getSearchIndex:b,getPageNumbers:f,download:function(a){switch(a){case "annotations":return g();case "searchIndex":return b();case "pageNumbers":return f();default:return $.Deferred().reject("Unknown sidecar")}}}}var h={annotations:{},pageNumbers:{},searchIndex:{}},d={};Object.keys(h).forEach(function(a){h[a].name=
a;d[a]=a});var e,c;KindleModuleManager.define(Kindle.MODULE.SidecarManager,[Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager],function(a,d){e=a;c=d;return{create:f}})})();function AssertionError(f){Error.call(this,f)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleAuthor=function(){var f=["phd","md","sir"];return{getDisplayableString:function(h){for(var d="",e=h.length,c=0;c<e;c++){for(var a=h[c].split(","),g=[],b=[],j=0;j<a.length;j++){var k=$.trim(a[j]);f.indexOf(k.toLowerCase())>-1?g.push(k):b.unshift(k)}if(b.length===2){d+=b[0]+" "+b[1];for(a=0;a<g.length;a++)d+=", ",d+=g[a]}else d+=h[c];e>1&&(c===e-2?d+=" and ":c<e-2&&(d+=", "))}return d},getLegacyDisplayableString:function(f){for(var d="",e=f.length,c=0;c<e;c++)d+=f[c],c<e-1&&(d+="; ");return d}}}(),
KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function f(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:f,useCSSRegions:function(){return f()}}}(),KindleHostDeviceDetector=
function(){function f(){return navigator.platform.indexOf("iPad")!==-1}function h(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function d(){return f()||h()||a()}function e(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function a(){return navigator.userAgent.indexOf("Cloud9")!==-1}function g(){return navigator.userAgent.indexOf("MSAppHost")!==
-1}function b(){return g()&&j()}function j(){return!!/arm/i.test(navigator.cpuClass)}function k(){return c()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function p(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function m(){return"standalone"in navigator&&navigator.standalone}function n(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function q(){return window.navigator.msMaxTouchPoints>=
1}return{isiOS:d,isiPad:f,isiPhone:h,isiOS_4x:function(){return(f()||h())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(f()||h())&&parseInt(e(),10)>=5},isiOS_7x:function(){return(f()||h())&&parseInt(e(),10)===7},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:c,hasHangingDbPrompt:function(){if(!c())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:function(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!b?!1:!a?!0:Number(b[1])>=Number(a)},isMetro:g,isMetroArm:b,isMetroSnappedView:function(){return g()&&window.outerWidth===320},isIE:p,isIE10:function(){return p()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return p()&&navigator.userAgent.indexOf("Trident/7.0")!==-1},isArm:j,isCloud9:a,isTablet:function(){return f()||g()},isOnline:k,isNetworkAvailable:function(){if(!k())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},
timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!k())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome},isiOSAppMode:m,isChromeApp:n,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return m()||n()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!==
"undefined"},isLocalStorageEnabled:function(){if(!window.localStorage)return!1;try{window.localStorage.setItem("testLocalStorage","1"),window.localStorage.removeItem("testLocalStorage")}catch(a){return!1}return!0},hasArrayLikeApply:function(){return!d()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:q,isTouchDevice:function(){return d()||
q()},getDevicePlatform:function(){return f()?"iPad":h()?"iPhone":a()?"otter":b()?"metroArm":g()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return f()&&KindleHostPadDetector.isPad1(m())||b()},getDeviceType:function(){return g()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return g()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:e,getOSMinorVersion:function(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},
getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(f){if(window.localStorage.getItem("definitelyNotPad1"))return!1;var h=0,d=1E3,e=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>h?h=c:c<d&&(d=c),e+=c;h=e/3;if(h>=200&&f)return!0;if(h>=100&&!f)return!0;window.localStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function f(f,d){for(var e in d)if(d.hasOwnProperty(e)&&typeof f[e]!==typeof d[e])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:f,assertImplements:function(h,
d){f(h,d)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function f(a){var c=[],d;for(d in a){var e=a[d].entry;e.guid=e.guid||e.refEmId;delete e.refEmId;e&&c.push(e)}return c}function h(b){var d=[],e;for(e in b)d.push({entry:b[e]});return a.getAppDb().getTable(c).insertList(d)}function d(b){function c(){var n;e<b.length?(h=Math.min(e+100,b.length),n=Array.prototype.slice.call(b,e,h),e=h,g.updateAnnotations(f(n),KindleLocale.getLocalTimeOffset()).then(function(){a.getAppDb().deleteJournalEntries(n).then(c,
d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,e=0,h;c();return d.promise()}function e(){var b=new jQuery.Deferred;a.getAppDb().getTable(c).getRecord().then(function(a){a.length>0?d(a).then(b.resolve,b.reject):b.resolve()},b.reject);return b.promise()}var c="journal",a=null,g=null;return{initialize:function(){var b=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(d){g=d[KindleModuleManager.SERVICE_CLIENT];
a=d[KindleModuleManager.DB_CLIENT];b.resolve(c)},b.reject);return b.promise()},saveToJournal:function(a){var c=new jQuery.Deferred;h(a).then(function(){e().then(c.resolve,c.resolve)},c.reject);return c.promise()},uploadJournal:e}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")},setDeviceToken:function(f){window.localStorage.setItem("kindleDeviceToken",
f)},clearDeviceTokenFromStorage:function(){window.localStorage.removeItem("kindleDeviceToken")}}}(),KindleLocale=function(){var f=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return f},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=function(f){function h(d){for(var c=0,a=0;a<d.length;a+=1)c+=d[a].end-d[a].start;return c}var d={};d.name=f;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var d=this.runs[this.runs.length-
1];if(d.end===null)d.end=(new Date).getTime()};d.addCount=function(d,c){if(this.counters===null)this.counters={};this.counters[d]===void 0?this.counters[d]=c:this.counters[d]+=c};d.createSubTimer=function(d){if(this.subTimers===null)this.subTimers={};this.subTimers[d]===void 0?this.subTimers[d]=KindleMetricsProfiler(d):this.subTimers[d].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[d]};d.log=function(){this.logAsPercentageOfTime("",h(this.runs))};d.logAsPercentageOfTime=function(d,
c){var a=d+":"+this.name,g;h(this.runs);for(g in this.counters);for(g in this.subTimers)this.subTimers[g].logAsPercentageOfTime(a,c)};return d},KindleRemoteClient=function(){return{getStoreURL:function(){var f=new jQuery.Deferred;$.get("/remote/store").then(function(h){(h=h.url)?f.resolve(h):f.reject()},f.reject);return f.promise()},uploadFeedback:function(f){if(!f)return(new $.Deferred.reject).promise();var h=KindleLibrarySetting.getSettings(),h={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),
UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,AppCached:!!window.localStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:h.sortParam,LibraryView:h.viewState};return function(d){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(e){try{var c=
e.getAppDb(),a=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),g=c.getAllBooks();d.info.OfflineStorageEnabled=!!e.bookDbEnabled();return $.when(a,g)}catch(b){return $.Deferred.reject()}}).pipe(function(e,c){$.extend(d.info,{TotalBookCount:c.length,TotalBookDownloaded:e.length})}).pipe(function(){return d},function(){return $.Deferred().resolve(d)})}({version:KindleVersion.getVersionString(),message:f.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:h}).pipe(function(d){d=
{url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(d)};return $.ajax(d)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(f){return ResourceBundle.getLocalizedString(f)})}}}(),KindleUserAgentMetricsInfo=function(){function f(){function a(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(b)return b[1]}var c;if(!(c=function(){var a;if(["ipad","iphone"].indexOf(d)!==-1&&(d="ios",
(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var e;KindleHostDeviceDetector.isIE()&&(e=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");c=e||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return c}var h,d,e,c,a,g={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!h){d=GoogleUserAgent.browserName.toLowerCase();e=f();a:{if(e){var b=/^0*([0-9]+)/.exec(e);if(b&&b.length>=
2){c=parseInt(b[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+e)}c=void 0}a="undefined"===typeof c?"other":g[d]?[d,c].join("@"):"other";h=!0}return a}}}(),KindleVersion=function(){var f=null,h=null;return{getMetricsVersionString:function(){h||(h=parseInt("010600527".slice(0,2),10),h+=".",h+=parseInt("010600527".slice(2,4),10),h+=".",h+=parseInt("010600527".slice(4,6),10));return h},getVersionString:function(){f||(f=parseInt("010600527".slice(0,2),10),f+=".",f+=parseInt("010600527".slice(2,
4),10),f+=".",f+=parseInt("010600527".slice(4,6),10),f+=".",f+=parseInt("010600527".slice(6),10));return f},getVersionNumber:function(){return Number("010600527")},parseVersionString:function(d){return d&&(d=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(d))?Number(d[1])*1E7+Number(d[2])*1E5+Number(d[3])*1E3+Number(d[4]):NaN}}}(),KindleChromeInstaller=function(){function f(){function d(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");
setTimeout(d,250)},function(d){KindleDebug.error(d)})}function h(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}return{install:function(){h()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&h()){var d=document.createElement("button");d.id="inlineInstallProxy";d.style.display="none";$(d).click(f);$("body").append(d)}}}}(),
KindleFirefoxInstaller=function(){function f(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function h(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();var d=$.Deferred(),e=navigator.mozApps.getInstalled();e.onsuccess=function(){var c=!1,a=f();e.result.forEach(function(d){d.manifestURL===a&&(c=!0)});d.resolve(c)};e.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);d.reject()};return d.promise()}return{install:function(){var d=
$.Deferred();h().done(function(e){e?d.reject():(e=navigator.mozApps.install(f()),e.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");d.resolve()},e.onerror=function(){KindleDebug.error("Firefox App failed to install.");d.reject()})}).fail(d.reject);return d.promise()}}}(),KindleLibrary=function(){function f(){KindleLibraryHomeScreenPopup.show();KindleLibraryControlBar.setCacheDone()}function h(a){KindleSpinner.hide();a===Kindle.STORE.OFFLINE_ERROR?M(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED):
a===Kindle.STORE.GENERIC_ERROR&&M(Kindle.ERROR.STORE_OPEN_FAILED)}function d(){O||(KindleHostDeviceDetector.isiOS()?KindleLibraryHeaderBar.dismissKeyboard():KindleLibraryHeaderBar.deactivateSearch());return!1}function e(){var a={breakdown:["Browser"]};window.localStorage.getItem(Kindle.App.LIBRARY_FAIL_FLAG)?E.emit("Library::OpenLibraryFail",a):window.localStorage.setItem(Kindle.App.LIBRARY_FAIL_FLAG,"true");L=E.startMetrics("Library::OpenLibrary",a);KindleSpinner.show();KindleLibrarySetting.initialize();
V=KindleHostDeviceDetector.isiPad();I().getBookDataLastSyncTime(m);c();w();B();t();u();KindleLibrarySetting.getLastLibraryView()==="downloaded"&&(KindleLibraryScrollPane.setView("downloaded"),KindleLibrarySetting.setLibraryView("downloaded"));!V&&!KindleHostDeviceDetector.isIE()&&z();KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",Kindle.top.document).bind("orientationchange.library",b):$(window).resize(b);$(window).keydown(j);$(window).keyup(k);KindleHostDeviceDetector.isiOS()?$("#page_body").bind("touchstart",
d):$("#page_body").bind("click",d);KindleHostDeviceDetector.isiOS_7x()&&$("body").addClass("ios7");KindleHostDeviceDetector.isiOS()||$(window).focus(function(){S.checkTokenConsistency()});KindleOffline.isEnabled()?I().getCachedAsins(void 0).then(function(a){var b,c,d={};d[Kindle.BookInfo.CachedState.CACHED]=0;d[Kindle.BookInfo.CachedState.PINNED]=0;for(b in a)c=a[b],d[c.cacheState]++;d[Kindle.BookInfo.CachedState.CACHED]&&E.increaseSubCounter(L,"booksCached",d[Kindle.BookInfo.CachedState.CACHED]);
d[Kindle.BookInfo.CachedState.PINNED]&&E.increaseSubCounter(L,"booksPinned",d[Kindle.BookInfo.CachedState.PINNED])}):E.increaseSubCounter(L,"noOffline",1)}function c(){KindleLibrarySearch.initialize(function(){var a=new jQuery.Deferred;KindleHostDeviceDetector.isOnline()?a.resolve(P):I().getCachedAsins("pinned").done(function(b){var c=[],d;for(d in P)b.indexOf(P[d].asin)<0&&c.push(P[d]);a.resolve(c)});return a.promise()},function(a,b){var c=KindleLibraryScrollPane.displayBooks(a,b);c===0?KindleLibraryMessagePane.showEmptySearchMessage(!KindleHostDeviceDetector.isOnline()):
c>0&&KindleLibraryMessagePane.hideEmptySearchMessage()})}function a(){KindleLibraryHeaderBar.setSyncButtonDisabled(!0);KindleSpinner.show();I().getBookDataLastSyncTime(m)}function g(){aa=!0;a()}function b(){T?ia=!0:(KindleLibraryContextMenu&&KindleLibraryContextMenu.hide(),KindleLibraryScrollPane.resizeScrollPane())}function j(a){if(!T)switch(a.which){case 38:KindleLibraryScrollBar.moveStart(!0);break;case 40:KindleLibraryScrollBar.moveStart(!1)}}function k(a){if(!T)switch(a.which){case 33:KindleLibraryScrollBar.movePage(!0);
break;case 34:KindleLibraryScrollBar.movePage(!1);break;case 27:KindleLibraryHeaderBar.deactivateSearch(!0);break;default:KindleLibraryScrollBar.moveEnd()}}function p(a){aa?(r(),KindleHostDeviceDetector.isOnline()?M(Kindle.ERROR.SYNC_FAILED):M(Kindle.ERROR.SYNC_FAILED_OFFLINE)):a?I().getAllBooks().done(l):KindleMessageDialog.showError(Kindle.ERROR.LIBRARY_LOAD_FAILED,function(){m(Kindle.DB.NEVER)},ResourceBundle.getLocalizedString("k_dialog_message_retryButton_text"))}function m(a){var b=a===Kindle.DB.NEVER?
null:a;KindleHostDeviceDetector.isOnline()?(L&&b!==null&&E.modifyMetricsMethod(L,"Library::OpenLibraryCached"),S.getOwnedContent(b,aa?"Customer":b?"KindleForegrounded":"Registration").then(function(a){aa=!1;ba.getBookDb()&&a.asinsToAdd&&!$.isEmptyObject(a.asinsToAdd)&&n(a.asinsToAdd);I().updateBookData(a.asinsToRemove,a.asinsToAdd,a.syncTime).then(o,q)},function(){p(b!==null)})):(L&&E.modifyMetricsMethod(L,"Library::OpenLibraryOffline"),p(b!==null))}function n(a){I().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED,
!0).then(function(b){if(b.length>0){var c={};b.forEach(function(b){if(a[b.asin]&&a[b.asin].contentType===Kindle.CONTENT_TYPE.EBOK&&b.context.contentType===Kindle.CONTENT_TYPE.EBSP){var d=b.context;d.contentType=a[b.asin].contentType;c[b.asin]={cacheState:b.cacheState===Kindle.BookInfo.CachedState.PINNED?Kindle.BookInfo.CachedState.PINNING:Kindle.BookInfo.CachedState.PARTIAL,cachedSize:null,context:d}}});$.isEmptyObject(c)||ba.getBookDb().updateBookInfos(c)}},function(){})}function q(){KindleLibraryHeaderBar.setSyncButtonDisabled(!1)}
function o(a){aa&&a===0?r():I().getAllBooks().done(function(b){var c=[];b.forEach(function(a,b,d){if(a.title===void 0||a.authors===void 0)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a.asin}]}),delete d[b]});c.length>0&&I().batchTransaction(c);l(b,a===0)})}function l(a,b){var c=P[0];P=a;for(var d in P)if(P[d].lastTimeRead===void 0)P[d].lastTimeRead=-1;d=KindleLibrarySetting.getLastSortParam();KindleLibrarySort.sortBookList(P,d);KindleLibrarySetting.setSortParam(d);
d=P[0];b&&c&&d&&c.asin===d.asin?O&&R(O):(KindleLibraryScrollPane.setLayout(KindleLibrarySetting.getLastLayoutView()),A());r();L&&(E.increaseSubCounter(L,KindleLibrarySetting.getLastLayoutView(),1),E.increaseSubCounter(L,KindleLibrarySetting.getLastLibraryView(),1),E.increaseSubCounter(L,"bookCount",P.length),E.endMetrics(L),L=void 0)}function r(){aa=!1;O=void 0;KindleSpinner.hide();KindleLibraryHeaderBar.setSyncButtonDisabled(!1);X.onLibraryLoaded();window.localStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG)}
function t(){var a=KindleLibrarySetting.getSettings();KindleLibraryScrollPane.initialize(a,F,H,v,G)}function u(){KindleLibraryMessagePane.initialize(function(a){$("#message_container").append(a)},function(){U({isSourceEmptyLibBtn:!0})})}function H(a,b){function c(a,b){return F(a.asin,b)}function d(a){var b={asin:a.asin,basePath:ea.basePath,useNewPath:ea.useNewPath,useProdBucket:ea.useProdBucket},c=E.startMetrics("Library::SaveBook",{breakdown:["Browser"]});I().getBookDataLastSyncTime(m);KindleOffline.pinBook(b,
M).then(function(){E.endMetrics(c);R(a.asin)},function(){E.cancelMetrics(c)})}function e(a){KindleOffline.removeBook({asin:a.asin},function(){R(a.asin)},function(a){M(a===Kindle.ERROR.NETWORK?Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE)})}function g(a){E.emit("Library::RemoveOwnershipDialog::Shown");(function(){var b=$.Deferred();KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt_title"),ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt",
{bookTitle:a.title}),null,null,[{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete_cancel"),callback:b.reject},{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete"),callback:b.resolve}]);return b.promise()})().done(function(){E.emit("Library::RemoveOwnershipDialog::Initiated");S.removeOwnership(a.asin,a.contentType).done(function(){var b=[];b.push({asin:a.asin});I().updateBookData(b,[]).done(o)}).fail(function(){M(Kindle.ERROR.REVOKE_FAILED)})}).fail(function(){E.emit("Library::RemoveOwnershipDialog::Cancelled")})}
O||I().getBookCachedState(a.asin).done(function(f){var j=KindleOffline.isEnabled()?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED,h=KindlePopupMenu.ITEM_ENABLED,k=KindlePopupMenu.ITEM_HIDDEN,j=KindleHostDeviceDetector.isOnline()?j:KindlePopupMenu.ITEM_DISABLED,l=Kindle.CONTENT_TYPE.EBSP===a.contentType,m="unknown";if(f&&f.length>0)m=f[0].cacheState;switch(m){case Kindle.BookInfo.CachedState.PINNED:f=[h,k,j,k,l?h:k];break;case Kindle.BookInfo.CachedState.CACHED:f=[h,j,j,k,l?h:k];break;
default:f=[h,k,k,j,l?h:k]}KindleLibraryContextMenu.show(a,f,b,[c,d,e,d,g])})}function v(a,b,c){V||(c>=a?$("#slide_container").removeClass("scrollbar_shown"):($("#slide_container").addClass("scrollbar_shown"),KindleLibraryScrollBar.updateValueRange(a,b,c)))}function G(a){KindleLibraryScrollBar.updateValue(a)}function C(){KindleLibrarySettingsMenu.show(X.openExternalLink)}function w(){var a=KindleLibraryHeaderBar,b={},c={},d=KindleLibrarySearch;b[a.EVENT_SYNC_CLICKED]=g;b[a.EVENT_MANAGE_CLICKED]=C;
b[a.EVENT_STORE_CLICKED]=function(){U({})};c[a.SEARCH_CALLBACK.ENABLE]=function(){var a=!KindleHostDeviceDetector.isOnline()?"downloaded":"cloud";KindleLibraryControlBar.hideViewTabs();KindleLibraryScrollPane.setView(a)};c[a.SEARCH_CALLBACK.SEARCH]=KindleUtils.debounce(function(a){d.search(a)},200);c[a.SEARCH_CALLBACK.DISABLE]=function(){KindleLibraryScrollPane.setView(KindleLibrarySetting.getLastLibraryView());KindleLibraryControlBar.showViewTabs()};a.initialize(function(a){$("body").append(a);fa.resolve()},
b,c)}function B(){var a=KindleLibraryControlBar;a.setRetryCallback(N);a.setAppCacheStatusGetter(D.getSharedModuleSync(Kindle.MODULE.APPCACHE_EVENTHANDLER).getCacheStatus);var b={};b[a.EVENT_LIBRARY_SORT_CLICKED]=Y;b[a.EVENT_LIBRARY_LAYOUT_CLICKED]=W;b[a.EVENT_LIBRARY_IMAGE_CHANGING]=x;b[a.EVENT_LIBRARY_IMAGE_CHANGED]=K;b[a.EVENT_LIBRARY_VIEW_CLICKED]=Q;a.initialize(function(a){$("#page_body_content_containers").prepend(a)},KindleLibrarySetting.getSettings(),b)}function z(){KindleLibraryScrollBar.initialize(function(a){$("#slide_container").append(a)},
J)}function J(a,b){KindleLibraryScrollPane.setScrollValue(a,b)}function x(a,b){KindleLibraryScrollPane.updateCoverSize(b.value,!1)}function K(a,b){var c=b.value;KindleLibrarySetting.setCoverSize(c);KindleLibraryScrollPane.updateCoverSize(c,!0)}function R(a){I().getBookCachedState(a).done(function(b){KindleLibraryScrollPane.updateBookCacheState(a,b.length>0?b[0].cacheState:"");I().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():
KindleLibraryNoDownloadedMessage.hide()})})}function A(){I().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){KindleLibraryScrollPane.setBookData(P,a);P.length===0?KindleLibraryMessagePane.showEmptyLibraryMessage():(KindleLibraryMessagePane.hideEmptyLibraryMessage(),$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():KindleLibraryNoDownloadedMessage.hide())})}function Q(a){function b(){KindleLibraryScrollPane.setView(a);KindleLibrarySetting.setLibraryView(a);KindleLibraryControlBar.setViewState(a)}
a!==KindleLibrarySetting.getLastLibraryView()&&(!KindleHostDeviceDetector.isOnline()&&a==="cloud"?M(Kindle.ERROR.BOOK_NOT_AVAILABLE):a==="downloaded"&&!KindleOffline.isEnabled()?KindleHostDeviceDetector.isFirefox()?KindleOffline.enableOfflineMessage().done(b):KindleOffline.firstRunMessage().done(b):b())}function U(a){KindleSpinner.show();d();X.openStore(a)}function F(a,b){a!==null&&!T&&(Z=b,KindleHostDeviceDetector.isOnline()?ca(a):I().getBookCachedState(a).done(function(b){b.length>0&&Kindle.BookInfo.CachedState.isMaybeDownloaded(b[0].cacheState)?
ca(a):(E.emit("Library::OpenBookNotAvailable"),M(Kindle.ERROR.BOOK_NOT_AVAILABLE),Z&&Z())}))}function I(){return ba.getAppDb()}function ca(a){O=a;X.openBook({asin:a})}function s(){KindleLibraryHeaderBar.deactivateSearch(!0);Z&&Z()}function y(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.allowTouchEvents();ia&&(KindleLibraryScrollPane.resizeScrollPane(),ia=!1);a();T=!1}function M(a,b){a===Kindle.ERROR.CONTENT_RENTAL_EXPIRED?ga():(b&&(a={name:a,code:b}),KindleMessageDialog.showError(a))}
function da(a,b,c){a?(T=!0,KindleSpinner.hide(),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents(),setTimeout(s,500)):(M(b,c),Z&&Z(),y())}function Y(){var a;a=KindleHostDeviceDetector.isiOS()?"up":"down";KindleLibrarySortMenu.show(a,function(a){if(a!==KindleLibrarySetting.getLastSortParam())document.getElementById("kindleLibrary_button_sort_label").innerHTML=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(a)),P.length>0?(KindleLibrarySort.sortBookList(P,
a),KindleLibrarySetting.setSortParam(a),A()):KindleLibrarySetting.setSortParam(a)})}function W(a){KindleLibraryScrollPane.setLayout(a);KindleLibrarySetting.setLayoutView(a)}function N(){E.emit("KindleApp:AppCacheError:RetryClicked",{breakdown:["Browser"]});KindleLibraryAppCacheFailDialog.hasBeenShownThisSession()?(KindleLibraryAppCacheFailDialog.open(),E.emit("KindleApp:AppCacheError:RetryClickedAfterRebootDialogShown",{breakdown:["Browser"]})):Kindle.top.location.reload(!1)}function ga(){var a=!0;
E.emit("Library::Rentals:ExpiredDialogShown");var b=function(){var b=O;return function(){a&&(a=!1,E.emit("Library::Rentals:BuyOrRentAgainClicked"));if(b!==void 0){var c="https://www.amazon.com/dp/"+b+"/ref=kcr_store_expired";KindleHostDeviceDetector.isiPad()?(c+="_ipad",X.openExternalLink(c)):(c+="_desktop",Kindle.top.location=c)}else KindleDebug.error("no asin selected for BuyOrRentAgainClicked")}}();KindleMessageDialog.showError(Kindle.ERROR.CONTENT_RENTAL_EXPIRED,function(){a&&(a=!1,E.emit("Library::Rentals:DismissClicked"))},
ResourceBundle.getLocalizedString("k_dialog_rental_expired_dismiss_button_text"),[{buttonText:ResourceBundle.getLocalizedString("k_common_cancel_button")},{buttonText:ResourceBundle.getLocalizedString("k_dialog_rental_expired_extend_button_text"),callback:b}])}var P=[],T=!1,O,V,L,Z,ia=!1,ba=null,D,X,E,S,aa=!1,ea,fa;return{initialize:function(){fa||(fa=jQuery.Deferred());D=window.parent.KindleApp;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();D&&($("body").bind("touchmove.elastic",
KindleIOSScrollStopper.stopScroll),X=D.getAppInterfaceForLibrary(),Kindle=D.getSharedModuleSync(KindleModuleManager.CONSTANTS),ResourceBundle=D.getSharedModuleSync(KindleModuleManager.RESOURCE_BUNDLE),KindleTemplateManager.initialize(),D.setLibraryInterface({onReaderOpenStatus:da,onReaderClose:y,onStoreOpenStatus:h,libraryUpdateNeeded:a}),D.registerEventCallback(Kindle.APP_CACHE.CACHE_PROGRESS,function(a){KindleLibraryControlBar.setCacheProgress(a.progressRatio)}),D.registerEventCallback(Kindle.APP_CACHE.CACHE_CACHED,
f),D.registerEventCallback(Kindle.APP_CACHE.CACHE_DONE,f),D.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_RETRY,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),D.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),D.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryAppCacheFailDialog.open()}),D.getSharedModules().done(function(a){KindleModuleManager.registerModuleList(a);
KindleOffline.isFirstTime()&&!D.getQueryParams().asin&&KindleOffline.firstRunMessage();!KindleOffline.isFirstTime()&&!window.localStorage.getItem("haveDB")&&KindleHostDeviceDetector.isFirefox()&&KindleOffline.enableOfflineMessage();E=a[KindleModuleManager.METRICS_MANAGER];ba=a[KindleModuleManager.DB_CLIENT];S=a[KindleModuleManager.SERVICE_CLIENT];e()}),KindleHostDeviceDetector.isIE()&&document.body.addEventListener("MSHoldVisual",function(a){a.preventDefault()},!1),$("body").bind("contextmenu",function(a){a.preventDefault()}),
X&&(ea=X.getQueryParameters()))},registerControlHotkey:function(a,b,c){$(document).keydown(function(d){if(d.keyCode===a.charCodeAt(0)&&(d.ctrlKey||d.metaKey)&&!d.shiftKey)return d.preventDefault(),b.apply(this,c),!1})},register:function(a,b){return X.register(a,b)},deregister:function(a,b){return X.deregister(a,b)},onStoreLinkClicked:function(a){var b={};b[a]=!0;U(b);KindleNotificationDialog.hide();return!1}}}(),KindleX=KindleLibrary,KindleLibraryBookCover=function(){function f(){b||(b=KindleHostDeviceDetector.isiPad()?
c:e);return b}function h(a){g||(g=d,g=g.replace("{width}",f().width),g=g.replace("{height}",f().height));var b=g;return b=b.replace("{asin}",a)}var d="/cover/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",e={width:255,height:255},c={width:255,height:255},a=null,g=null,b=null;return{getBookCoverUrl:function(b){a||(a="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",a=a.replace("{width}",f().width),a=a.replace("{height}",f().height));var c=
a;return c=c.replace("{asin}",b)},getOfflineCover:function(a){var a=h(a),b=$.Deferred(),c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=function(){var a=c.response,d,e;if(a){if(KindleHostDeviceDetector.hasArrayLikeApply())try{d=[],e=new Uint8Array(a),d.push(String.fromCharCode.apply(null,e))}catch(g){d=null}if(!d){d=[];e=new Uint8Array(a);for(a=0;a<e.length;a++)d.push(String.fromCharCode(e[a]))}d="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(d.join(""));b.resolve(d)}else b.reject()};
c.onerror=function(){b.reject(c)};c.send();return b.promise()}}}(),KindleLibraryScroller=function(){function f(f,d){var e=new iScroll(f,d),c=e._momentum;e._momentum=function(a,d,b,e,f){a=a===0?0:Math.max(25,Math.abs(a))*(a<0?-1:1);return c(a,d,b,e,f)};return e}return{createScrollerObject:function(h,d){return new f(h,d)}}}(),KindleLibraryScrollPane=function(){function f(){I=!0;M&&j()}function h(){for(var a=0;a<ja;a++){var b=ea[a],d=aa[fa+a],e=S[d].find(".book_image");b.height!==1&&b.width!==1?(e.attr("src",
b.src),b.width>b.height&&e.removeClass("book_image").addClass("book_image_wide")):Y&&(e.attr("src",B),b=S[d].find(".book_title").text(),d=S[d].find(".alt_title"),d.text(b),d.show())}fa+=ja;fa>=aa.length-1?(ea=[],aa=[],fa=0):c();k()}function d(a){return function(){var b=fa+ja-1;a>=fa&&a<=b&&(la++,la===ja&&(clearTimeout(ma),h()))}}function e(){h()}function c(){la=0;ma=setTimeout(e,U);ja=Math.min(R,aa.length-fa);for(var a=0;a<ja;a++){var b=fa+a,c=aa[b];ea[a]||(ea[a]=new Image);b=d(b);ea[a].onload=b;
ea[a].onerror=b;ea[a].src=E[c]||KindleLibraryBookCover.getBookCoverUrl(c)}}function a(a,b){var c=a.find("."+K);c.click(function(){var c=a.find(".book_image, .book_image_wide");!Z&&!KindleLibraryContextMenu.isVisible()&&(Z=!0,c.addClass("opening"),ia(b.asin,function(){c.removeClass("opening");Z=!1}));return!1});var d=a.find(".book_image, .book_image_wide");Y?(a.tapHold(function(a){ba(b,[a.x,a.y-100]);W._unbind("touchmove");W._unbind("touchend");W._unbind("touchcancel")}),c.activate(function(){d.addClass("opening");
setTimeout(function(){d.removeClass("opening")},Q)})):(c.bind("contextmenu",function(a){ha&&clearTimeout(ha);ba(b,[a.pageX,a.pageY]);a.preventDefault()}),c.mousedown(function(a){d.addClass("held");if(!ha)ka.x=a.pageX,ka.y=a.pageY,ha=setTimeout(function(){ba(b,[ka.x,ka.y]);clearTimeout(ha);ha=null},A)}),c.mouseup(function(){clearTimeout(ha);d.removeClass("held");ha=null;return!0}),c.mouseout(function(){clearTimeout(ha);d.removeClass("held");ha=null;return!1}),c.mousemove(function(a){ka.x=a.pageX;ka.y=
a.pageY}));return a}function g(a,b){var c=S[a];if(c)switch(c.removeClass("book_is_pinned book_is_cached"),b){case Kindle.BookInfo.CachedState.PINNED:c.addClass("book_is_pinned");break;case Kindle.BookInfo.CachedState.CACHED:c.addClass("book_is_cached")}}function b(){W&&(W.destroy(),W=null);var b=$("<div>").attr("id",J),d,e,f;for(f in M){d=M[f].asin;if(S[M[f].asin])e=S[M[f].asin];else{e=M[f];var j=KindleUXComponentManager.renderTemplate(C,{asin:e.asin,title:e.title,author:KindleAuthor.getDisplayableString(e.authors),
src:w}),h=j,k=void 0;e.contentType==="EBSP"&&(k="<div class='"+x+" "+K+"'>"+ResourceBundle.getLocalizedString(F)+"</div>",h.addClass("sample"),h.find(".book_cover").append("<div class='book_image_container'>"+k+"</div>"),h.find(".book_image").appendTo(h.find(".book_image_container")),h.find(".book_details").append(k));j=a(j,e);S[e.asin]=j;aa.push(e.asin);e=j}M[f].contentType===Kindle.CONTENT_TYPE.EBOK&&e.find("."+x).remove();g(d,da[d]);b.append(e)}c();l(b);$("#"+J).replaceWith(b);O=0;q()}function j(){E?
b():KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getCachedCovers().done(function(a){E=a;b()})}function k(){(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&ca==="grid"?$(".book_image_container ."+x).each(function(){var a=this.nextElementSibling;this.parentElement.style.width=$(a).hasClass("book_image_wide")?"auto":a.clientWidth+"px"}):KindleHostDeviceDetector.isiOS()&&$(".book_image_container ."+x).each(function(){var a=this.nextElementSibling;
a.style.display="block";setTimeout(function(){a.style.display="inline-block"},0)})}function p(){KindleHostDeviceDetector.isFirefox()&&$(".book_image_container ."+x).each(function(){this.parentElement.style.width="auto"})}function m(){N=r*s;y.grid_style_container.style.height=N+t+"px";y.grid_style_bookCover.style.width=N+"px";y.grid_style_bookCover.style.height=N+"px";y.grid_style_pinned.style.backgroundPosition="center "+(N+3)+"px";y.grid_style_sample_font.style.fontSize=s*v+"px";y.grid_style_sample_font.style.lineHeight=
N*0.14+"px"}function n(a,b){var c=-b*G;ga&&(c=V.scrollTop()+c,c=Math.min(c,ga-V.height()),c=Math.max(c,0),o(c,!0),X(c))}function q(){Y?W?W.refresh():W=KindleLibraryScroller.createScrollerObject("titles_container",{hScroll:!1,lockDirection:!1,hScrollbar:!1,vScrollbar:!1}):(ca==="grid"?(P=N+t,T=Math.floor(V.width()/(N+u)),y.grid_style_container.style.width=100/T+"%"):(P=H,T=1),o(Math.floor(O/T)*P,!1),ga=V[0].scrollHeight,D(ga,V.scrollTop(),V.height()));k()}function o(a,b){V.scrollTop(a);b&&(O=Math.round(a/
P)*T)}function l(a){KindleHostDeviceDetector.isIE()&&a.addClass("ie_scrollable")}var r=21.25,t=100,u=20,H=86,v=1.6,G=75,C="KindleLibraryBookContainer",w="./images/override/library/img_alt_cover.png",B="./images/override/library/blank_cover.png",z="book_highlightsearch",J="titles_inner_wrapper",x="book_sample_badge",K="book_click_area",R=30,A=1E3,Q=500,U=6E4,F="k_L_sample_badge_text",I,ca,s,y,M,da,Y,W,N,ga,P,T,O=0,V,L,Z,ia,ba,D,X,E,S={},aa=[],ea=[],fa=0,la=0,ja=0,ma,ha=null,ka={x:0,y:0};return{initialize:function(a,
b,c,d,e){ca=a.layoutState;s=a.coverSize;Y=KindleHostDeviceDetector.isiOS();Z=!1;ia=b;ba=c;D=d;X=e;V=$("#titles_container");L=$("#slide_container");a=document.styleSheets[2].cssRules;if(a===void 0)a=document.styleSheets[2].rules;y={};for(b=0;b<a.length;b++){c=a[b];if(c.selectorText===".grid_container .book_container")y.grid_style_container=c;if(c.selectorText===".grid_container .book_cover")y.grid_style_bookCover=c;if(c.selectorText===".grid_container .book_is_pinned")y.grid_style_pinned=c;if(c.selectorText===
".grid_container .book_sample_badge")y.grid_style_sample_font=c}L.mousewheel(n);l(V);Y||m();KindleUXComponentManager.initializeTemplate(C,f)},setBookData:function(a,b){M=a;da={};for(var c in b)da[b[c].asin]=b[c].cacheState;I&&j()},updateCoverSize:function(a,b){!Y&&!b&&(s=a,m(),q())},setLayout:function(a){ca=a;L.removeClass("grid_container list_container").addClass(a+"_container");a==="list"&&p();q()},setView:function(a){a==="downloaded"?L.addClass("download_view"):L.removeClass("download_view");q()},
setScrollValue:o,updateBookCacheState:g,resizeScrollPane:function(){q()},displayBooks:function(b,c){function d(a,b){var c=[],e=[],g={};if(c=b.match(a)){for(var f=c.length,j=0;j<f;j++)g[c[j]]=c[j];for(j in g)e.push(RegExp(g[j],"g"));return e.sort().reverse()}else return e}function e(a,b){for(var c=a,d=b.length,g=0;g<d;g++)c=c.replace(b[g],'<span class="'+z+'">'+b[g].source+"</span>");return c}var g=b.length,f=0;if(g===0)return f;var j=KindleHostDeviceDetector.isOnline(),h=$("#"+J),k=c.source==="(?:)"||
!c.source;h.empty();for(var m=document.createDocumentFragment(),n=0;n<g;n++){var p,o,r,x=b[n];(j||da[x.asin])&&f++;k?p=S[x.asin]:(p=S[x.asin].clone(),o=d(c,x.title),o=e(x.title,o),r=d(c,x.displayableAuthorsString),r=e(x.displayableAuthorsString,r),p.find(".book_title").html(o),p.find(".book_author").html(r));p=a(p,x);m.appendChild(p[0])}h.append(m);l(h);q();return f}}}(),KindleLibrarySearch=function(){var f,h,d,e=-1,c;return{search:function(a){function g(){var a=j,d=b,g=[],n=e,q=e,o=e,l,r=0,t;for(t in d){l=
d[t];if(!l.displayableAuthorsString)l.displayableAuthorsString=KindleAuthor.getDisplayableString(l.authors);a.source?(o=l.asin.toLowerCase()===c.toLowerCase()?1:e,n=l.title.search(a),q=l.displayableAuthorsString.search(a)):n=0;n!==e||q!==e||o!==e?(l.hidden=!1,g[r]=l,r++):l.hidden=!0}b={set:g,queryPattern:a};_displayBooksCallback(b.set,b.queryPattern);f=b.set;h=j}var b;c=a.replace(RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&");c=$.trim(c);var j=RegExp(c,"gi");if(!h||!(h.source&&c===h.source))f&&
h&&h.source&&c.search(h)===0?(b=f,g()):d().done(function(a){b=a;g()})},initialize:function(a,c){d=a;_displayBooksCallback=c}}}(),KindleLibrarySetting=function(){function f(a){a in o||(o[a]=window.localStorage.getItem(a));return o[a]}function h(a,b){o[a]=b;return window.localStorage.setItem(a,b)}function d(){return f(p)}function e(a){h(p,a)}function c(){return f(n)}function a(a){h(n,a)}function g(){return f(q)}function b(a){h(q,a)}function j(){return f(m)}function k(a){h(m,a)}var p="last_layout_view",
m="last_opened_view",n="last_sort_param",q="last_cover_size",o={};return{initialize:function(){var f=d(),h=c(),m=g(),n=j();f||e("grid");h||a("recent");m||b(9);KindleHostDeviceDetector.isOnline()?n||k("cloud"):k("downloaded")},getLastLayoutView:d,setLayoutView:e,getLastSortParam:c,setSortParam:a,getLastCoverSize:g,setCoverSize:b,getLastLibraryView:j,setLibraryView:k,getSettings:function(){var a={};a.layoutState=d();a.viewState=j();a.coverSize=g();a.sortParam=c();return a}}}(),KindleLibrarySort=function(){function f(c){if(!c.sortTitle){var a=
c.title.trim(),a=KindleStringUtilities.replaceAccentedChars(a).replace(/[^A-Za-z0-9 ]/g,""),a=a.toLowerCase();a:for(var d=ResourceBundle.getLocalizedArticles(),b,e=0;e<d.length;e++)if(b=d[e],a.indexOf(b)===0){a=a.substring(b.length);break a}c.sortTitle=a}}function h(c,a){return c.sortTitle<a.sortTitle?-1:c.sortTitle>a.sortTitle?1:0}function d(c,a){var d=(a.lastTimeRead>0?a.lastTimeRead:a.purchaseDate)-(c.lastTimeRead>0?c.lastTimeRead:c.purchaseDate);return d===0?h(c,a):d}function e(c,a){for(var d=
0,b=0;b<c.authors.length&&b<a.authors.length&&d===0;b++){var e=c.authors[b].toLowerCase(),f=a.authors[b].toLowerCase();e<f?d=-1:e>f&&(d=1)}d===0&&(d=c.authors.length-a.authors.length);return d===0?h(c,a):d}return{SORT_BY_AUTHOR:"author",SORT_BY_TITLE:"title",SORT_BY_RECENT:"recent",SORT_BY_AUTHOR_LABEL:"k_L_sort_author_label",SORT_BY_TITLE_LABEL:"k_L_sort_title_label",SORT_BY_RECENT_LABEL:"k_L_sort_recent_label",sortBookList:function(c,a){for(var g in c)f(c[g]);switch(a){case "title":c.sort(h);break;
case "author":c.sort(e);break;case "recent":c.sort(d);break;default:KindleDebug.error("Trying to sort by invalid type "+a)}},compareBooks:function(c,a,g){f(c);f(a);var b;switch(g){case "recent":b=d(c,a);break;case "title":b=h(c,a);break;case "author":b=e(c,a);break;default:KindleDebug.error("Trying to compare by invalid type "+g)}return b},getLabel:function(c){switch(c){case "title":return"k_L_sort_title_label";case "author":return"k_L_sort_author_label";case "recent":return"k_L_sort_recent_label";
default:return"Invalid Sort Type"}}}}(),KindleCrypto=function(){return{decrypt:function(f,h,d){h=CryptoJS.enc.Base64.parse(h);d=CryptoJS.enc.Base64.parse(d);f=new Uint8Array(f);f=CryptoJS.lib.WordArray.create(f);f=CryptoJS.lib.CipherParams.create({ciphertext:f,algorithm:CryptoJS.algo.AES,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.PKCS5});return function(d){for(var c=d.words,a=d.sigBytes,g=new Uint8Array(a),b=0;b<a;b++)d=c[b>>>2]>>>24-b%4*8&255,g[b]=d;return g}(CryptoJS.AES.decrypt(f,h,{iv:d}))}}}(),
KindleZip=function(){if(zip.workerScriptsPath==="")zip.workerScriptsPath="./js/Worker/";zip.useWebWorkers=KindleHostDeviceDetector.areWebWorkersSupported()&&!KindleHostDeviceDetector.isiOS();if(!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(f,h){for(var d=new Uint8Array(this),f=f===void 0?0:f,h=h===void 0?d.length:h,e=new ArrayBuffer(h-f),c=new Uint8Array(e),a=0;a<c.length;a++)c[a]=d[a+f];return e};return{unzip:function(f){var h=$.Deferred(),d=[],f=new zip.ArrayBufferReader(f);
zip.createReader(f,function(e){e.getEntries(function(c){function a(a){return function(b){g++;d.push({filename:c[a].filename,data:b});g===c.length&&e.close(function(){h.resolve(d)})}}for(var g=0,b=0;b<c.length;b++)c[b].getData(new zip.ArrayBufferWriter,a(b))})},function(d){KindleDebug.error("createReader failed when trying to unzip: "+d);h.reject(d)});return h.promise()}}}(),KindleErrorMap=function(){var f,h;return{getErrorText:function(d){if(!f)f={},f[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",
text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='"+Kindle.ExternalLinks.HelpIncreaseOfflineStorage+"' target='_blank'>",linkEnd:"</a>"}},f[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"},f[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",text:"k_L_openBookLoadFailure_Text"},f[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"},f[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",
text:"k_L_removeBookNetworkError_Text"},f[Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED]={title:"k_bookextras_open_failed_Error_Title",text:"k_bookextras_open_failed_Error_Text"},f[Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR]={title:"k_bookextras_offline_cache_failed_Error_Title",text:"k_bookextras_offline_cache_failed_Error_Text"},f[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"},f[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",
text:"k_L_openBookContentLoanEndedError_Text"},f[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]={title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"},f[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"},f[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"},f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=
{title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"},f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}},f[Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED]={title:"k_L_openBookAsinNotSpecified_Title",text:"k_L_openBookAsinNotSpecified_Text"},f[Kindle.ERROR.GEOLOCATION_NOT_ALLOWED]=
{title:"k_L_openBookGeoLocationNotAllowed_Title",text:"k_L_openBookGeoLocationNotAllowed_Text"},f[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"},f[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"},f[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"},f[Kindle.ERROR.REVOKE_FAILED]={title:"k_L_revokeFailed_Title",
text:"k_L_revokeFailed_Text"},f[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"},f[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"},f[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"},f[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"},f[Kindle.ERROR.SYNC_FAILED_OFFLINE]=
{title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"},f[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"},f[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"},f[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"},f[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"},
f[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}},f[Kindle.ERROR.SITB_OFFLINE]={title:"k_R_sitb_error_offline_title",text:"k_R_sitb_error_offline_message"},f[Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED]={title:"k_R_sitb_error_language_not_supported_title",text:"k_R_sitb_error_language_not_supported_message"},f[Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE]={title:"k_R_sitb_error_index_not_available_title",
text:"k_R_sitb_error_index_not_available_message"},f[Kindle.ERROR.SITB_COMMON_ERROR]={title:"k_R_sitb_error_common_title",text:"k_R_sitb_error_common_message"},f[Kindle.ERROR.SITB_LANGUAGE_UNDEFINED]={title:"k_R_sitb_error_language_undefined_title",text:"k_R_sitb_error_language_undefined_message"},h={},h[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO,h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO;KindleHostDeviceDetector.isMetro()&&(d=h[d]||
d);(d=f[d])||(d=f[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(d.title,d.titleParams),text:ResourceBundle.getLocalizedString(d.text,d.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(f){f.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(f,h,d){if(!f.length)return 0;for(var e=f.length-1,c=0,a=0,g=null,b=0;c<=e;)if(a=Math.floor((c+e)/2),g=f[a],b=0,d===void 0?g>h?b=1:g<h&&(b=-1):b=d(h,g),b>0)e=a-1;else if(b<0)c=a+1;else return a;
return a===0||b<0?a:a-1},first:function(f){return f[0]},last:function(f){return f[f.length-1]}}}(),KindleOffline=function(){function f(a){var b=new jQuery.Deferred;setTimeout(b.resolve,a);return b.promise()}function h(a,b,d){if(a.indexOf(c)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var e=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),f=e.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(a){a?(e.increaseSubCounter(f,
"Continue",1),e.endMetrics(f),e=null,b()):(e.increaseSubCounter(f,"Cancel",1),e.endMetrics(f),e=null,d())})}else b()}function d(a,b){if(b){var c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),d="BookDownload::Fail::"+b,e=d;switch(a){case Kindle.ERROR.CANCELLED:e+="::Cancelled";break;case Kindle.ERROR.OUT_OF_SPACE:e+="::DBFull";break;case Kindle.ERROR.UNKNOWN_DB_ERROR:e+="::UnknownDBError";break;case Kindle.ERROR.NETWORK:e+="::Network";break;case Kindle.ERROR.TIMEOUT:e+="::Timeout";
break;default:e+="::Unknown"}c.emit([{name:d,params:{breakdown:["Browser"]}},{name:e,params:{breakdown:["Browser"]}}])}}function e(){return window.localStorage.getItem("haveRun")?!1:!0}var c="topaz",a=null;return{isFirstTime:e,isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var a=new jQuery.Deferred;KindleFirstRunDialog.open({continueCB:function(){KindleHostDeviceDetector.isIE()||KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,
a.reject);window.localStorage.setItem(Kindle.App.HAVE_RUN,"true")},onDialogOpenCB:function(){KindleHostDeviceDetector.isIE()&&KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(function(){a.resolve();var b=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();b&&e()&&b.BookInfoDB().reserveStorage(10)},a.reject)}});return a.promise()},enableOfflineMessage:function(){var a=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(a.resolve,
a.reject);setTimeout(function(){a.isRejected()&&KindleEnableOfflineDialog.open()},500);return a.promise()},pinBook:function(a,b){function c(a){if(a.type===Kindle.ERROR.DB_LINGERING_WRITE)if(a.stalled)KindleFirefoxPromptingDialog.open(),l.getModuleSync(l.METRICS_MANAGER).emit("Pinning::FirefoxPrompting::Open");else{KindleFirefoxPromptingDialog.close();var b="Pinning::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";l.getModuleSync(l.METRICS_MANAGER).emit(b)}}function e(){l.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);l.getModuleSync(l.METRICS_MANAGER).cancelMetrics(t);r.cancelDownloading();KindleLibraryProgressDialog.close();q.reject()}function p(){l.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);l.getModuleSync(l.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.updateValue(100);$.when(o,f(200)).then(function(){KindleLibraryProgressDialog.close();q.resolve()})}function m(a,e){l.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);l.getModuleSync(l.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.close();a&&a.getOpenError&&(a=a.getOpenError());a!==Kindle.ERROR.CANCELLED&&b(a,e);d(a,"Library");q.reject(a)}function n(){function a(b,c){KindleLibraryProgressDialog.updateValue(Math.round(100*Math.min(b,c)/Math.max(1,c)))}r.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?m(Kindle.ERROR.OUT_OF_SPACE):r.getBookInfoDfd().then(function(){var b=r.getBookType();h(b,function(){l.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);u.resolve(!0);r.getDownloadComplete(a).then(p,m)},function(){u.reject();e()})})})}var q,o,l,r,t,u;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();l=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(b){l.registerModuleList(b);t=l.getModuleSync(l.METRICS_MANAGER).startMetrics("Pin");r=KindleReaderBookInfoProvider.BookInfo(a,l);o=f(1500);u=new jQuery.Deferred;KindleLibraryProgressDialog.open(e);
r.startDownloading(t,u).then(n,m)});return q.promise()},downloadBook:function(c,b,e,h){function p(){l.getModuleSync(l.METRICS_MANAGER).endMetrics(r);$.when(o,f(200)).then(function(){q.resolve();e()})}function m(a){l.getModuleSync(l.METRICS_MANAGER).cancelMetrics(r);a&&a.getOpenError&&(a=a.getOpenError());if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;var b=KindleErrorMap.getErrorText(a);b.code=a;h(b)}d(a,
"Library");q.reject(a)}function n(){function c(a,d){b(Math.round(100*Math.min(a,d)/Math.max(1,d)))}a.getSizeInfo().then(function(b){b.quota>0&&b.bookSize*1.53>b.quota?m(Kindle.ERROR.OUT_OF_SPACE):(t.resolve(!0),a.getDownloadComplete(c).then(p,m))})}var q,o,l,r,t;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();l=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(b){l.registerModuleList(b);
r=l.getModuleSync(l.METRICS_MANAGER).startMetrics("Pin");a=KindleReaderBookInfoProvider.BookInfo(c,l);o=f(1500);t=new jQuery.Deferred;a.startDownloading(r,t).then(n,m)});return q.promise()},removeBook:function(a,b,c){function d(a){q.endMetrics(o);c(a)}function e(){q.endMetrics(o);b()}function f(b){b.cacheState!==Kindle.BookInfo.CachedState.PINNED||b.context.isSample?b=!0:KindleHostDeviceDetector.isOnline()?(b={asin:a.asin,kindleSessionId:b.context.kindleSessionId,isOffline:!1},b=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(b)):
b=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return b}var h,q,o;q=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);o=q.startMetrics("Unpin");h=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();h.getRecord("bookinfo",{asin:a.asin},{cacheState:!0,context:!0}).then(function(b){b&&b.length>0?$.when(f(b[0])).fail(d).done(function(){h.deleteBooksData([a.asin]).then(e,d)}):e()},d)},cancelBookDownload:function(){a.cancelDownloading()},sendDownloadFailMetric:d}}(),
KindleStringUtilities=function(){var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},h=RegExp("["+Object.keys(f).join("")+"]","g"),d={"\u2019":"'","\uff07":"'","'":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u0100":"a","\u0101":"a","\u0102":"a","\u0103":"a","\u0104":"a","\u0105":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e",
"\u00ca":"e","\u00cb":"e","\u0112":"e","\u0113":"e","\u0114":"e","\u0115":"e","\u0116":"e","\u0117":"e","\u0118":"e","\u0119":"e","\u011a":"e","\u011b":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u0128":"i","\u0129":"i","\u012a":"i","\u012b":"i","\u012c":"i","\u012d":"i","\u012e":"i","\u012f":"i","\u0130":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00d2":"o","\u00d3":"o","\u00d4":"o","\u00d5":"o","\u00d6":"o",
"\u014c":"o","\u014d":"o","\u014e":"o","\u014f":"o","\u0150":"o","\u0151":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u","\u00da":"u","\u00db":"u","\u00dc":"u","\u0168":"u","\u0169":"u","\u016a":"u","\u016b":"u","\u016c":"u","\u016d":"u","\u016e":"u","\u016f":"u","\u0170":"u","\u0171":"u","\u0172":"u","\u0173":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0176":"y","\u0177":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u0106":"c","\u0107":"c","\u0108":"c","\u0109":"c","\u010a":"c",
"\u010b":"c","\u010c":"c","\u010d":"c","\u00d0":"d","\u010e":"d","\u010f":"d","\u00f0":"d","\u011c":"g","\u011d":"g","\u011e":"g","\u011f":"g","\u0120":"g","\u0121":"g","\u0122":"g","\u0123":"g","\u0124":"h","\u0125":"h","\u0134":"j","\u0135":"j","\u0136":"k","\u0137":"k","\u0139":"l","\u013a":"l","\u013b":"l","\u013c":"l","\u013d":"l","\u013e":"l","\u00f1":"n","\u00d1":"n","\u0143":"n","\u0144":"n","\u0145":"n","\u0146":"n","\u0147":"n","\u0148":"n","\u0154":"r","\u0155":"r","\u0156":"r","\u0157":"r",
"\u0158":"r","\u0159":"r","\u015a":"s","\u015b":"s","\u015c":"s","\u015d":"s","\u015e":"s","\u015f":"s","\u0160":"s","\u0161":"s","\u0162":"t","\u0163":"t","\u0164":"t","\u0165":"t","\u0174":"w","\u0175":"w","\u0179":"z","\u017a":"z","\u017b":"z","\u017c":"z","\u017d":"z","\u017e":"z","\u00df":"s","\u00e6":"a","\u00c6":"a","\u00de":"t","\u00fe":"t","\u00d8":"o","\u00f8":"o"};return{replaceAccentedChars:function(e){return e=e.replace(/[^A-Za-z0-9 ]/g,function(c){return d[c]||c})},escapeForHTML:function(d){return d.replace(h,
function(c){return f[c]})}}}(),KindleTouchEventsToggler=function(){function f(b){if(g)for(var c=$(":hasTouchEvent"),d=0;d<c.length;d++){var e=c[d];if((!b||!b(e))&&e._listeners)for(var f=e._listeners.slice(0),h=0;h<f.length;h++){var q=f[h][0];if(q==="touchstart"||q==="touchmove"||q==="touchend")q={element:e,type:q,func:f[h][1],useCapture:f[h][2]},a.push(q),e.removeEventListener(q.type,q.func,q.useCapture)}}}function h(){if(g){for(var b=0;b<a.length;b++){var c=a[b];c.element.addEventListener(c.type,
c.func,c.useCapture)}a=[]}}var d=null,e=null,c=!1,a=[],g=!1;return{initialize:function(){if(!c)d=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);d.apply(this,arguments)},e=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(b,c){try{return typeof b==="function"&&typeof c==="function"?b===c:b.handleEvent===c.handleEvent}catch(d){}return!1}
if(this._listeners)for(var c=0;c<this._listeners.length;++c)if(this._listeners[c][0]===arguments[0]&&a(this._listeners[c][1],arguments[1])){this._listeners.splice(c,1);break}e.apply(this,arguments)},g=c=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var c=0;c<a._listeners.length;c++){var d=a._listeners[c][0];if(d==="touchstart"||d==="touchmove"||d==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(c){var b=0;
$(":hasListeners").each(function(a,c){for(var d=c._listeners.slice(0),e=0;e<d.length;e++)c.removeEventListener(d[e][0],d[e][1]),b++});HTMLElement.prototype.addEventListener=d;HTMLElement.prototype.removeEventListener=e;a=[];c=!1}},on:h,off:f,disallowTouchEvents:function(){g=!0;f();g=!1},allowTouchEvents:function(){g=!0;h()},isRequired:function(){return KindleHostDeviceDetector.isiOS()}}}();
(function(f){var h=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];f.each(h,function(d,e){f.fn[e]=function(c,a){a=a||{};return e==="tap"?KindleHostDeviceDetector.isTouchDevice()?c?gt(this).on(e,c,f.extend(a,{expire:700,moveThreshold:10})):this.trigger(e):c?this.click(c):this.trigger("click"):c?gt(this).on(e,c,a):this.trigger(e)};f.attrFn[e]=!0});f.each(h,function(d,e){var c="unbind"+e.slice(0,1).toUpperCase()+e.slice(1);f.fn[c]=function(a){return e==="tap"&&!KindleHostDeviceDetector.isTouchDevice()?
a?this.unbind("click",a):this.unbind("click"):gt(this).off(e,a)};f.attrFn[c]=!0})})(jQuery);
var KindleUXComponentManager=function(){function f(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function h(a,b,c){g(a,function(){var d;d=$(Handlebars.templates[a](c));k[a]={component:d};b(d)})}function d(a){a.stopPropagation()}function e(a,b,e,g){var j=k[a];j.callbacks=e;if(e.onInitializationDone)e.onInitializationDone(b);
if(e.getDialogSettings)j.dialogSettings=e.getDialogSettings();if(j.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=m;else if(KindleHostDeviceDetector.isMetro()){if(a=q,j.dialogSettings.dialogClass="wide-dialog",!g)j.dialogSettings.k4w_transparent_modal_overlay=!1}else a=n;j.dialogSettings.width=a}j.dialogSettings.modal&&b.keydown(d).keyup(d);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=j.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(j.dialogSettings);
j.component=b;if(!g&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var h=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",h)})}b.bind("dialogopen",function(){f(j)});b.bind("dialogclose",function(){if(j.callbacks.onDialogClose)j.callbacks.onDialogClose(j.component);j.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();j.dialogSettings.modal&&o&&o(!0);j.callbacks.beforeDialogClose&&
j.callbacks.beforeDialogClose(j.component)});c(j)}function c(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(p):$("body").removeClass(p),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&o&&o(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function a(a){k[a]&&k[a].component.dialog("isOpen")&&k[a].component.dialog("close")}function g(a,c){b(a).then(function(){j[a]||
c()},function(){KindleDebug.error("Template "+a+" is missing")})}function b(a){var b=$.Deferred();(a=Handlebars.templates[a])?b.resolve(a):b.reject();return b.promise()}function j(a){return!!Handlebars.templates[a]}var k=[],p="transparent_overlay",m=475,n=400,q="100%",o;return{initializeTemplate:g,hasTemplate:j,renderTemplate:function(a,b){if(!Handlebars.templates[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $(Handlebars.templates[a](b))},
initializeComponent:h,openDialog:function(a,b,d){var f=k[a];f?c(f):f!==null&&(k[a]=null,h(a,function(c){e(a,c,b)},d))},closeDialog:a,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(a){var b=k[a.componentName];b?(a.buttonID||KindlePopupMenu.updatePosition(a.componentName,a.position),a.enabledFlags&&KindlePopupMenu.updateMenu(b.component,a.enabledFlags,a.componentName),c(b)):(a.doneCallback=function(b,c){a.enabledFlags&&KindlePopupMenu.updateMenu(b,a.enabledFlags,
a.componentName);k[a.componentName]={component:b};e(a.componentName,b,c,!0)},KindlePopupMenu.initialize(a))},updateMenu:function(a,b){var c=k[a];c&&KindlePopupMenu.updateMenu(c.component,b,a)},hideMenu:a,registerKeyEventsEnabledCallback:function(a){o=a}}}(),KindleDialogOverlay=function(){return{showOverlay:function(f){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;");(function(){var h=f.component.dialog("option",
"position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){f.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});f.component.dialog("option","position",h)})})();(function(){f.callbacks.onOverlayClicked&&$(".ui-widget-overlay-kcr-ios-hack").tap(function(f){f.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),
KindleEnableOfflineDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleEnableOfflineDialog",d={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},e={DIALOG:"kindle_dialog_enableOffline",CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},c={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},a,g={getDialogSettings:function(){return{autoOpen:!1,
width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(b){a=b;var g,h;KindleHostDeviceDetector.isFirefox()&&(g=ResourceBundle.getLocalizedString(d.OFFLINE_TITLE),h=ResourceBundle.getLocalizedString(d.FIREFOX_MSG,{linkStart:"<a href='"+Kindle.ExternalLinks.HelpOfflineReading+"' target='_blank'>",linkEnd:"</a>"}));b={title:g,topInstruction:h,topInstructionClass:void 0};a.find("#"+c.TITLE).html(b.title);a.find("#"+c.TOP_MSG).html(b.topInstruction);
b.topInstructionClass&&a.find("#"+c.TOP_MSG).addClass(b.topInstructionClass);b=a.find("#"+e.BUTTON);b.html(ResourceBundle.getLocalizedString(d.BUTTON_TEXT));b.one("click",f)},onDialogOpen:function(){var a=$("#"+e.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};return{open:function(){KindleUXComponentManager.openDialog(h,g)},close:function(){KindleUXComponentManager.closeDialog(h)}}}(),KindleFirefoxPromptingDialog=
function(){function f(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.closeDialog(h)}var h="KindleFirefoxPromptingDialog",d={MESSAGE:"k_dialog_ffPrompting_Text"},e={DIALOG:"kindle_dialog_ffPrompting",IMAGE:"ffPrompting_img",MESSAGE:"kindle_dialog_ffPrompting_text"},c,a={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(a){var b={linkStart:"<a href='"+Kindle.ExternalLinks.HelpIncreaseOfflineStorage+
"' target='_blank'>",linkEnd:"</a>"};c=a;a=ResourceBundle.getLocalizedString(d.MESSAGE,b);c.find("#"+e.MESSAGE).html(a);c.dialog("option","buttons",{Close:f})}};return{open:function(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.openDialog(h,a)},close:f}}(),KindleFirstRunDialog=function(){function f(){KindleUXComponentManager.closeDialog(c);k&&k()}function h(a){return ResourceBundle.getLocalizedString(a)}function d(){var b,c,d,e;KindleHostDeviceDetector.isChromeApp()?(c=
h(a.CHROME_APP_TITLE),d=h(a.CHROME_APP_MSG)):KindleHostDeviceDetector.isChrome()?(e="continue",c=h(a.OFFLINE_TITLE),d=h(a.CHROME_MSG)):KindleHostDeviceDetector.isiOS()?(b="ipad_prompt",c=h(a.OFFLINE_TITLE),d=h(a.IOS_PROMPT_MSG)):KindleHostDeviceDetector.isFirefox()?(e="ff_prompt",c=h(a.OFFLINE_TITLE),d=h(a.FIREFOX_MSG)):KindleHostDeviceDetector.isIE()?(e=KindleHostDeviceDetector.isIE11()?"ie11_prompt":"ie10_prompt",c=h(a.OFFLINE_TITLE),d=h(a.IE_PROMPT_MSG)):(b="safari_prompt",c=h(a.OFFLINE_TITLE),
d=h(a.SAFARI_PROMPT_MSG));return{topImgClass:b,title:c,topInstruction:d,bottomImgClass:e,topInstructionClass:void 0}}function e(){KindleUXComponentManager.closeDialog(c)}var c="KindleFirstRunDialog",a={BUTTON_TEXT:"k_dialog_firstRun_button_text",BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",
OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg",IE_PROMPT_MSG:"k_dialog_firstRun_ie_prompt_msg"},g={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",
CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},b={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},j,k,p,m={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(c){function j(){KindleChromeInstaller.install();e()}p=c;c=d();p.find("#"+b.TITLE).html(c.title);p.find("#"+b.TOP_MSG).html(c.topInstruction);c.topImgClass&&p.find("#"+b.TOP_IMG).addClass(c.topImgClass);
c.bottomImgClass&&p.find("#"+b.BOTTOM_IMG).addClass(c.bottomImgClass);c.topInstructionClass&&p.find("#"+b.TOP_MSG).addClass(c.topInstructionClass);c=p.find("#"+g.BUTTON);c.html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT));c.one("click",f);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(c.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(a.BUTTON_TEXT_CHROME)),c=p.find("#"+g.CRX_BUTTON),c.removeClass("disabled").html(ResourceBundle.getLocalizedString(a.CRX_BUTTON_TEXT)),
c.unbind("click"),c.one("click",j),c.show())},onDialogOpen:function(){var a=$("#"+g.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content");j&&j()},onDialogClose:function(){}};return{open:function(a){k=a&&a.continueCB;j=a&&a.onDialogOpenCB;KindleUXComponentManager.openDialog(c,m)},close:e}}(),KindleMessageDialog=function(){function f(a){if((a.keyCode||a.which)===27)return j(),a.stopImmediatePropagation(),!1}
var h={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},d={dismiss:"k_dialog_message_dismissButton_text"},e,c,a,g,b,j=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},k={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(e){function k(a){return function(){j();"function"===typeof a.callback&&a.callback()}}var p={};if(b)for(var o=0;o<b.length;o++){var l=
b[o];p[l.buttonText]=k(l)}else g=g?g:ResourceBundle.getLocalizedString(d.dismiss),p[g]=j;e.dialog("option","buttons",p);e.find("#"+h.TITLE_ID).empty().append(a);e.find("#"+h.TEXT_ID).empty().append(c);if(KindleHostDeviceDetector.isMetro())$(".ui-dialog").on("keydown",f)},beforeDialogClose:function(){KindleHostDeviceDetector.isMetro()&&$(".ui-dialog").off("keydown")},onDialogClose:function(){e&&e()}},p=function(d,f,j,h,l){a=d;c=f;e=j;g=h;b=l;KindleUXComponentManager.openDialog("KindleMessageDialog",
k)};return{open:p,close:j,showError:function(a,b,c,d){var e=a;if(a&&a.name)e=a.name;e=KindleErrorMap.getErrorText(e);a&&a.code&&(e.text+=" ["+a.code+"]");p(e.title,e.text,b,c,d)}}}(),KindleNotificationDialog=function(){function f(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");a.removeClass(k.SHOWN);setTimeout(function(){a.remove()},
o)}function h(a){function c(d){var e,f,g,j;if(e=b[d.optionProperty])if(typeof e==="string"?f=e:(f=e.id,g=e.localizationParams,j=e.htmlClass),e=ResourceBundle.getLocalizedString(f,g))d=$(d.tag).addClass(d.htmlClass).html(e),j&&d.addClass(j),a.find("."+k.CONTAINER).append(d)}a.find("."+k.CONTAINER).empty();c(k.PRETITLE);c(k.TITLE);c(k.BODY);c(k.LEGAL)}function d(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),e=0,f=0;b.targetAlignment==="right"?(e=d.offset().left+d.outerWidth(),
e-=a.outerWidth()):(e=d.offset().left+d.outerWidth()/2,e-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();e+a.outerWidth()>b&&(e=b-a.outerWidth());e<0&&(e=0)})();(function(){var a=b.targetBeakOffset||0;f=d.offset().left-e+d.outerWidth()/2+a})();a.css("left",e+"px");c.css("left",f+"px")}function e(a){function c(){d(a,b);KindleHostDeviceDetector.isiOS()&&a.show();j=null}function e(){j?clearTimeout(j):KindleHostDeviceDetector.isiOS()&&a.hide();j=setTimeout(c,l)}function g(){u=!0;t&&H.increment();
f(a)}var j;$(window).bind("touchstart.notification mousedown.notification",function(a){(!a.srcElement||!a.srcElement.id||!b.clickIdsToIgnore||!b.clickIdsToIgnore[a.srcElement.id])&&setTimeout(g,q)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",e):$(window).bind("resize.notification",e);setTimeout(g,n)}function c(a){e(a);$("body").append(a);d(a,b);setTimeout(function(){u||(a.addClass(k.SHOWN),setTimeout(function(){t=!0},m))},p)}function a(a){h(a);
c(a)}function g(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);r.resolve(a)}var b={},j={},
k={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},p=2E3,m=1E3,n=2E4,q=250,o=3E3,l=100,r=null,t=!1,u=!1,H;return{show:function(c){b=$.extend({},j,c);H=
LocalStorageCounter("kcrNotifications."+b.notificationId);c=b.notificationCount|1;H.getValue()<c&&(r||(r=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",g)),r.done(a))},hide:function(){var a=$("#kindleNotification");f(a)}}}(),KindlePopupMenu=function(){function f(a){var c=KindleUXComponentManager.renderTemplate(j),d=c.find(p),e=G[a].menuItems,f=!0,g,k=q;if(G[a].isAppBarMenu){k+=" "+l;var m=G[a].title;if(m){var o=document.createElement("div"),m=document.createTextNode(m);
o.appendChild(m);o.setAttribute("class",r);d.append(o)}}for(var n in e)g=$(document.createElement("div")).addClass(k).addClass(t).text(e[n].content).attr("id",e[n].elementId),f&&(g.addClass(u),f=!1),g.tap(h(g,e[n].clickHandler)),KindleEventBroker.subscribe(e[n].elementId,e[n].clickHandler),d.append(g);g.addClass(H);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(a)});G[a].doneCallback(c,
b(a))}function h(a,b){return function(){a.hasClass(t)&&b()}}function d(a,b,c){var d=[];b?(b=$("#"+b),c==="down"?(c=b.offset(),b=c.top+b.outerHeight(),d[0]=KindleHostDeviceDetector.isMetro()?c.left+23:c.left,d[1]=KindleHostDeviceDetector.isMetro()?b+10:b):(d[0]="right",d[1]="bottom")):d=c;a.dialog("option","position",d)}function e(){w&&(w.removeClass(v),w=null)}function c(a,b,c){var a=a.find(p).children(),d=b;do{if(c==="next")d?(d=d.next(),d.length<=0&&(d=a.first())):d=a.first();else if(c==="prev")d?
(d=d.prev(),d.length<=0&&(d=a.last())):d=a.last();else break;if(d===b)break}while(!d.hasClass(t));return d}function a(a,b){d(a,G[b].buttonID,G[b].position);$(".ui-dialog").on("keydown",function(d){var f=d.keyCode||d.which;KindleEventUtil.preventKeyScroll(d);switch(f){case 38:w&&w.removeClass(v);w=c(a,w,"prev");w.addClass(v);d.stopPropagation();break;case 40:w&&w.removeClass(v);w=c(a,w,"next");w.addClass(v);d.stopPropagation();break;case 13:w&&(d.stopPropagation(),w.removeClass(v),d=w.attr("id"),KindleEventBroker.fire(d),
e());break;case 9:e();C&&KindleUXComponentManager.hideMenu(b);break;case 27:e(),KindleUXComponentManager.hideMenu(b),d.preventDefault(),d.stopPropagation()}});a.find(p).children().each(function(a,b){$(b).on("mouseover",function(a){a=$(a.currentTarget);a.hasClass(t)&&(w?w!==a&&(w.removeClass(v),w=a,a.addClass(v)):(w=a,w.addClass(v)))})})}function g(a){$(".ui-dialog").off("keydown");a.find(p).children().each(function(a,b){$(b).off("mouseover")})}function b(b){return{getDialogSettings:function(){var a=
G[b],c=k;a.isAppBarMenu&&(c+=" "+o);a.buttonID&&(c+=" "+(a.position==="down"?m:n));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){a(c,b)},beforeDialogClose:function(a){g(a,b)},onDialogOpen:function(){C=!0},onDialogClose:function(){C=!1},onOverlayClicked:function(){C&&KindleUXComponentManager.hideMenu(b);e()}}}var j="KindlePopupMenu",k="kindle_menu",p="#kindle_menu_border",m="down_menu",n=
"up_menu",q="kindle_menu_button",o="kindle_appbar_menu",l="appbar_menu_button",r="appbar_menu_title",t="button_enabled",u="ui-corner-top",H="ui-corner-bottom",v="selected",G={},C=!1,w=null;return{MENU_POSITION_CONSTANTS:{APPBAR_MENU_MARGIN_PX:5,APPBAR_HEIGHT_PX:102,APPBAR_HEIGHT_SNAPVIEW_PX:70},ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a){G[a.componentName]={menuItems:a.menuItems,doneCallback:a.doneCallback,buttonID:a.buttonID,position:a.position,title:a.title,isAppBarMenu:a.isAppBarMenu};
KindleUXComponentManager.hasTemplate(j)?f(a.componentName):KindleUXComponentManager.initializeTemplate(j,function(){f(a.componentName)})},updateMenu:function(a,b,c){for(var d,e,f=0;f<b.length;f++)b[f]!==2&&(d===void 0&&(d=f),e=f);var g=G[c].isAppBarMenu;a.find("."+q).each(function(a){var c=q;if(g||$(this).hasClass(l))c+=" "+l;$(this).attr("class",c);switch(b[a]){case 0:$(this).addClass(t);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===d&&$(this).addClass(u);
a===e&&$(this).addClass(H)})},updatePosition:function(a,b){G[a].position=b}}}(),KindlePromptDialog=function(){var f={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},h={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},d,e,c,a=function(){c="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},g=function(){c="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},b={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(f.CANCEL_BUTTON_STRING_ID)]=
g;b[ResourceBundle.getLocalizedString(f.OK_BUTTON_STRING_ID)]=a;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(e);a.find("#"+h.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){d(c)}};return{open:function(a,f){d=f;c=!1;e=a;KindleUXComponentManager.openDialog("KindlePromptDialog",b)}}}(),KindleSigningOutDialog=function(){var f={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",f)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSpinner=function(){function f(){c||(c=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(d,h));return c.promise()}function h(a){e=a;c.resolve()}var d="KindleSpinner",e,c;return{show:function(){var a=f();$.when(a).then(function(){$("body").append(e);var a=window.innerWidth>
1?window.innerWidth:window.outerWidth,b=parseInt(e.css("width"),10),c=window.innerHeight>1?window.innerHeight:window.outerHeight,d=parseInt(e.css("height"),10);e.css("top",(c-d)/2+"px").css("left",(a-b)/2+"px")})},hide:function(){var a=f();$.when(a).then(function(){$("#loading_spinner").detach()})}}}(),KindleUnoptimizedFormatDialog=function(){var f={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",
STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},h={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},d,e,c,a=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},g=function(){e=!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},b={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID)]=a;b[ResourceBundle.getLocalizedString(f.CONTINUE_BUTTON_STRING_ID)]=
g;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=KindleHostDeviceDetector.isMetro()?f.METRO_TEXT_LABEL_STRING_ID:f.TEXT_LABEL_STRING_ID,b=ResourceBundle.getLocalizedString(b,{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});a.find("#"+h.TEXT_LABEL_ID).empty().append(b);$(a[0].parentNode).find(".ui-button-text").first().text(c)},onDialogClose:function(){d(e)}};return{open:function(a){c=
ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID);d=a;e=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",b)},openPinning:function(a){c=ResourceBundle.getLocalizedString(f.STOP_BUTTON_STRING_ID);d=a;e=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",b)}}}(),KindleLibraryAppCacheFailDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleLibraryAppCacheFailDialog",d={DIALOG:"kindle_dialog_appCacheFail",IMG_ARROW_ID:"appCacheDialogFail_arrow",
CONTENT_TEXT_ID:"appCacheDialogFail_content",TOGGLER_ID:"appCacheDialogFail_toggler",BUTTON:"kindle_appCacheDialog_button"},e=!1,c=!1,a,g={onDialogOpen:function(a){var c=$("#"+d.DIALOG);c.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");c.removeClass("ui-dialog-content ui-widget-content");e=!0;a.dialog("option","position","center")},getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:626,position:"center",k4w_transparent_modal_overlay:!0}},
onInitializationDone:function(b){a=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);b.find("#"+d.BUTTON).bind("click",f);var e=b.find("#"+d.TOGGLER_ID),g=b.find("#"+d.IMG_ARROW_ID),h=b.find("#"+d.CONTENT_TEXT_ID);e.tap(function(){h.slideToggle("fast",function(){b.dialog("option","position","center")});g.hasClass("kindleLibrary_arrowClosed")?g.switchClass("kindleLibrary_arrowClosed","kindleLibrary_arrowOpen",0):g.switchClass("kindleLibrary_arrowOpen","kindleLibrary_arrowClosed",
0);c||a.emit("KindleApp:AppCacheError:BrowserRebootPrompt:ExpandClicked",{breakdown:["Browser"]});c=!0})}};return{hasBeenShownThisSession:function(){return e},open:function(){KindleUXComponentManager.openDialog(h,g)},close:f}}(),KindleLibraryContextMenu=function(){function f(a){return function(){d();a(c)}}function h(c){function d(a,b,c){return{elementId:a,content:b,clickHandler:c}}a={};var e=0,h;for(h in b)a[b[h]]=d(b[h],ResourceBundle.getLocalizedString(g[h]),f(c[e])),e++}function d(){KindleUXComponentManager.hideMenu(e)}
var e="KindleLibraryContextMenu",c,a,g={ITEM_OPEN_BOOK:"k_L_context_read",ITEM_PIN:"k_L_context_pin",ITEM_REMOVE:"k_L_context_remove",ITEM_DOWNLOAD_PIN:"k_L_context_download_pin",ITEM_REVOKE_SAMPLE:"k_L_context_revoke_sample"},b={ITEM_OPEN_BOOK:"kindleLibrary_contextMenuItem_open_book",ITEM_PIN:"kindleLibrary_contextMenuItem_pin",ITEM_REMOVE:"kindleLibrary_contextMenuItem_remove",ITEM_DOWNLOAD_PIN:"kindleLibrary_contextMenuItem_download_pin",ITEM_REVOKE_SAMPLE:"kindleLibrary_contextMenuItem_revoke"};
return{isVisible:function(){return KindleUXComponentManager.isVisible(e)},show:function(b,d,f,g){c=b;a=null;h(g);KindleUXComponentManager.showMenu({componentName:e,menuItems:a,buttonID:null,position:f,title:null,isAppBarMenu:!1,enabledFlags:d})},hide:d}}(),KindleLibraryControlBar=function(){function f(a,b){var c=B.find("#"+a).children(),d,e;for(d=0;d<c.length;d++)e=c[d].id,e===b?$(c[d]).addClass(C.ACTIVE):$(c[d]).removeClass(C.ACTIVE)}function h(a,b,c){var d=a.find("#"+b);d.tap(function(){if(c)return c(d[0]),
!1})}function d(d){B=d;B.find("#view_"+k).addClass(C.ACTIVE);B.find("#view_"+p).addClass(C.ACTIVE);var m=b[q],n=b[t],u=b[o];h(d,v.VIEW_GRID_ID,function(a){f(v.LAYOUT_BUTTONS_ID,v.VIEW_GRID_ID);z&&z.show();m(a.getAttribute("value"))});h(d,v.VIEW_LIST_ID,function(a){f(v.LAYOUT_BUTTONS_ID,v.VIEW_LIST_ID);z&&z.hide();m(a.getAttribute("value"))});h(d,v.SORT_BUTTON_ID,function(){u()});$.each(v.VIEW,function(a,b){h(d,b,function(a){!KindleHostDeviceDetector.isOnline()&&a.id===v.VIEW.CLOUD_ID||!KindleOffline.isEnabled()&&
a.id===v.VIEW.DOWNLOAD_ID||f(v.VIEW_BUTTONS_ID,a.id);n(a.getAttribute("value"))})});switch(H()){case Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART:c();break;case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:c();break;case Kindle.APP_CACHE.CACHE_PROGRESS:e(J);break;case Kindle.APP_CACHE.CACHE_CACHED:a();break;case Kindle.APP_CACHE.CACHE_DONE:a()}if(KindleHostDeviceDetector.isiOS())g(d);else{z=KindleLibraryImageSlider;var w={};w[z.EVENT_LIBRARY_IMAGE_CHANGING]=b[l];w[z.EVENT_LIBRARY_IMAGE_CHANGED]=b[r];z.initialize(function(a){a.insertAfter(B.find("#"+
v.VIEW_TOGGLE_ID));g(d)},j,k,w)}}function e(a){J=a;B&&B.addClass(C.CACHING)}function c(){if(B){B.removeClass(C.CACHE_SUCCESS).addClass(C.CACHE_ERROR);var a=KindleHostDeviceDetector.isiPad()?G.CACHE_ERROR_MESSAGE_PAD:G.CACHE_ERROR_MESSAGE;B.find("#"+v.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(a)).tap(u)}}function a(){B&&(B.find("#"+v.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(G.CACHE_DONE_MESSAGE)),B.removeClass(C.CACHE_ERROR).addClass(C.CACHE_SUCCESS),setTimeout(function(){B.removeClass(C.CACHING)},
w))}var g,b,j,k,p,m,n=0,q=n++,o=n++,l=n++,r=n++,t=n++,u,H,v={VIEW_GRID_ID:"view_grid",VIEW_LIST_ID:"view_list",SORT_BUTTON_ID:"kindleLibrary_button_sort",VIEW:{DOWNLOAD_ID:"view_downloaded",CLOUD_ID:"view_cloud"},VIEW_BUTTONS_ID:"view_state_buttons",CONTAINER_ID:"view_sort_size_controls",LAYOUT_BUTTONS_ID:"view_buttons",SORT_BUTTONS_ID:"view_sort",VIEW_TOGGLE_ID:"view_toggle",MESSAGE_ID:"cache_message"},G={CACHE_MESSAGE:"k_L_caching",CACHE_DONE_MESSAGE:"k_L_cached",CACHE_ERROR_MESSAGE:"k_L_cacheError",
CACHE_ERROR_MESSAGE_PAD:"k_L_cacheError_pad"},C={ACTIVE:"btn_set_active",CACHING:"caching",CACHE_ERROR:"cacheError",CACHE_SUCCESS:"cacheSuccess"},w=3E3,B,z,J=1;return{EVENT_LIBRARY_LAYOUT_CLICKED:q,EVENT_LIBRARY_SORT_CLICKED:o,EVENT_LIBRARY_IMAGE_CHANGING:l,EVENT_LIBRARY_IMAGE_CHANGED:r,EVENT_LIBRARY_VIEW_CLICKED:t,CONTAINER_HEIGHT:45,initialize:function(a,c,e){g=a;b=e;j=c.coverSize;k=c.layoutState;p=c.viewState;m=c.sortParam;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);
a=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(m));KindleUXComponentManager.initializeComponent("KindleLibraryControlBar",d,{sortParam:a})},setViewState:function(a){p=a;f(v.VIEW_BUTTONS_ID,"view_"+a)},setCacheProgress:e,setCacheNeedsRetry:c,setCacheDone:a,setRetryCallback:function(a){u=a},setAppCacheStatusGetter:function(a){H=a},hideViewTabs:function(){$("#page_body").addClass("search_mode",200)},showViewTabs:function(){$("#page_body").removeClass("search_mode",200)}}}(),KindleLibraryFeedbackDialog=
function(){function f(){KindleUXComponentManager.closeDialog(d)}function h(){var b=g.find("#"+c).val();if($.trim(b)){g.find("#"+c);var e=g.find("#"+a);e.addClass("sending").removeClass("success error");e.html(ResourceBundle.getLocalizedString("k_provide_feedback_sending"));KindleRemoteClient.uploadFeedback({text:b}).then(function(){e.removeClass("sending error").addClass("success");e.html(ResourceBundle.getLocalizedString("k_provide_feedback_success"));setTimeout(function(){KindleUXComponentManager.closeDialog(d)},
1500)},function(){e.removeClass("success sending").addClass("error");e.html(ResourceBundle.getLocalizedString("k_provide_feedback_error"))})}}var d="KindleLibraryFeedbackDialog",e={DIALOG_SEND_FEEDBACK_BTN_ID:"k_send_feedback_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},c="kindleLibrary_feedback_area",a="kindleLibrary_feedback_status",g,b=function(a){a.which===27&&f()},j={onInitializationDone:function(a){g=a;a.click(function(a){a.stopPropagation()});KindleTouchEventsToggler.isRequired()&&
(g.find("#"+c).focus(function(){KindleTouchEventsToggler.off()}),g.find("#"+c).blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=f;a[ResourceBundle.getLocalizedString(e.DIALOG_SEND_FEEDBACK_BTN_ID)]=h;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){g.find("#"+a).html("");g.find("#"+c).val("");KindleHostDeviceDetector.isiOS()&&
g.find("#"+c).attr("tabindex","-1");g.find("#"+c).off("keydown",b);g.find("#"+c).on("keydown",b)}};return{show:function(){KindleUXComponentManager.openDialog(d,j)}}}(),KindleLibraryHeaderBar=function(){function f(a,b){a.find("#"+l[b]).tap(function(){var a=w[r[b]];a&&a();return!1})}function h(b){B=b;z=$(b.find("#"+l.SYNC_BUTTON_ID)[0]);var c=w[r.SYNC_BUTTON_ID];w[r.SYNC_BUTTON_ID]=function(){J||c()};b.find(":not(.search)").click(function(){v&&a(!0)});var e=b.find("#"+l.SEARCH_BAR_ID),j=b.find("#"+
l.CLEAR_BUTTON_ID);e.keydown(function(a){a.keyCode===13&&a.preventDefault()});KindleLibrary.registerControlHotkey("F",d);e.keyup(function(){var a=e.attr("value");if(H[u.SEARCH]&&(!KindleHostDeviceDetector.isArm()||a.length>1||a.length===0))H[u.SEARCH](a);a&&!G?j.fadeIn(200):!a&&G&&j.fadeOut(420);G=a});w[r.CLEAR_BUTTON_ID]=g;b.find("#"+l.SEARCH_BUTTON_ID).click(d);b.find("#"+l.CLEAR_BUTTON_ID).click(g);for(var h in l)l[h]===l.SEARCH_BUTTON_ID||l[h]===l.SEARCH_BAR_ID||l[h]===l.CLEAR_BUTTON_ID||f(b,
h);KindleTouchEventsToggler.isRequired()&&(e.focus(function(){KindleTouchEventsToggler.off(function(a){return a&&a.tagName==="BODY"?!1:!0})}),e.blur(function(){KindleTouchEventsToggler.on()}));C(b)}function d(){v?a(!0):e()}function e(){if(!x){x=!0;var a=$("#"+l.SEARCH_BAR_ID),b=$("#"+l.SEARCH_BUTTON_ID);v=!0;if(H[u.ENABLE])H[u.ENABLE]();a.attr("value","");a.show();a.prop("disabled",!1);a.focus();a.css("opacity",100);a.hide();b.fadeOut(150,function(){b.removeClass("header_bar_icon large");b.addClass("small");
b.fadeIn(100);a.fadeIn(420,function(){x=!1;a.focus()})})}}function c(){if(KindleHostDeviceDetector.isiOS()){var a=$("#"+l.SEARCH_BUTTON_ID),b=$("#"+l.SEARCH_BAR_ID);b.detach();a.after(b)}}function a(a){if(v&&!x){var b=$("#"+l.SEARCH_BAR_ID);if(!b.val().trim()||a){var d=$("#"+l.SEARCH_BUTTON_ID);x=!0;c();b.blur();v=!1;g();if(H[u.DISABLE])H[u.DISABLE]();b.fadeOut(333,function(){b.attr("disabled","disabled");b.css("opacity",0);d.hide();d.removeClass("small");d.addClass("header_bar_icon large");d.fadeIn(150,
function(){x=!1})})}}}function g(){$("#"+l.SEARCH_BAR_ID).attr("value","");G="";$("#"+l.CLEAR_BUTTON_ID).fadeOut(420);v&&$("#"+l.SEARCH_BAR_ID).focus();if(H[u.SEARCH])H[u.SEARCH]("")}var b=0,j=b++,k=b++,p=b++,m=b++,n=b++,q=b++,o=b++,l={KINDLE_LOGO_ID:"kindleLibrary_kindleLogo",SEARCH_BUTTON_ID:"kindleLibrary_button_search",SYNC_BUTTON_ID:"kindleLibrary_button_sync",MANAGE_BUTTON_ID:"kindleLibrary_button_manage",STORE_BUTTON_ID:"kindleLibrary_button_store",SEARCH_BAR_ID:"kindleLibrary_bar_search",
CLEAR_BUTTON_ID:"kindleLibrary_clear_search"},r={KINDLE_LOGO_ID:j,SEARCH_BUTTON_ID:k,SEARCH_BAR_ID:p,CLEAR_BUTTON_ID:m,SYNC_BUTTON_ID:n,MANAGE_BUTTON_ID:q,STORE_BUTTON_ID:o},b=0,m=b++,t=b++,b=b++,u={ENABLE:m,SEARCH:t,DISABLE:b},H,v=!1,G="",C,w,B,z,J=!1,x=!1;return{EVENT_LOGO_CLICKED:j,EVENT_SEARCH_CLICKED:k,EVENT_BAR_CLICKED:p,EVENT_SYNC_CLICKED:n,EVENT_MANAGE_CLICKED:q,EVENT_STORE_CLICKED:o,SEARCH_CALLBACK:u,initialize:function(a,b,c){C=a;w=b;H=c;KindleUXComponentManager.initializeComponent("KindleLibraryHeaderBar",
h)},setSyncButtonDisabled:function(a){B&&(a?z.addClass("disabled"):z.removeClass("disabled"),J=a)},activateSearch:e,deactivateSearch:a,dismissKeyboard:function(){v&&($("#"+l.SEARCH_BAR_ID).attr("value")===""?a():c())},clearSearch:g}}(),KindleLibraryHomeScreenPopup=function(){function f(b){var f=$(document.createElement("span")).addClass(d.STRONG_TEXT_CLASS).text(ResourceBundle.getLocalizedString(e.STRONG_TEXT_ID)).context.outerHTML;b.find("."+d.TEXT_CLASS).append(ResourceBundle.getLocalizedString(e.TEXT_ID,
{addToHomeText:f}));$("body").append(b);KindleHostDeviceDetector.isiOS_7x()&&$("#"+d.POPUP_ID).addClass(d.IOS7);setTimeout(function(){b.addClass(h);b.tap(function(){KindleHostDeviceDetector.isiOS_5xOrGreater()&&KindleLibraryHeaderBar.deactivateSearch();b.removeClass(h)});setTimeout(function(){b.removeClass(h)},a);setTimeout(function(){b.remove()},g)},c)}var h="shown",d={IMAGE_CLASS:"addToHomeActionIcon",TEXT_CLASS:"addToHomeText",STRONG_TEXT_CLASS:"addToHomeStrongText",POPUP_ID:"kindleAddToHomeScreen",
IOS7:"ios7"},e={TEXT_ID:"k_addToHomeScreen_text",STRONG_TEXT_ID:"k_addToHomeScreen_strong_text"},c=5E3,a=14E3,g=17E3,b;return{show:function(){!b&&KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isInAppMode()&&(b=!0,KindleUXComponentManager.initializeComponent("KindleLibraryHomeScreenPopup",f))}}}(),KindleLibraryImageSlider=function(){function f(){k&&k.hide()}function h(g){k=g;var h=c[b],q=c[j],o=k.find("#"+p.IMAGE_SLIDER_ID);o.slider({range:"min",value:d,max:12,min:6,step:1,animate:!0,
slide:h,change:q});o.find(".ui-slider-handle").removeAttr("href");o.find(".ui-slider-handle").attr("id",p.IMAGE_SLIDER_HANDLE_ID);e==="list"&&f();a(g)}var d,e,c,a,g=0,b=g++,j=g++,k,p={IMAGE_SLIDER_ID:"kindleLibrary_coverImage_slider",IMAGE_SLIDER_HANDLE_ID:"kindleLibrary_coverImage_slider_handle"};return{EVENT_LIBRARY_IMAGE_CHANGING:b,EVENT_LIBRARY_IMAGE_CHANGED:j,initialize:function(b,f,g,j){a=b;e=g;c=j;d=f;KindleUXComponentManager.initializeComponent("KindleLibraryImageSlider",h)},show:function(){k&&
k.show()},hide:f}}(),KindleLibraryMessagePane=function(){function f(b){g=!1;b.find(h.EMPTY_LIBRARY_MESSAGE).tap(function(){a();return!0});var f=ResourceBundle.getLocalizedString(e.EMPTY_SEARCH_MSG);b.find("#"+h.EMPTY_SEARCH_TEXT).text(f);f=ResourceBundle.getLocalizedString(e.EMPTY_SEARCH_OFFLINE);b.find("#"+h.EMPTY_SEARCH_DETAIL).text(f);f=$(document.createElement("span")).addClass(d.EMPTY_LIBRARY_STORENAME).text(ResourceBundle.getLocalizedString(e.EMPTY_LIBRARY_storeName)).wrap("<div>").parent().html();
f=ResourceBundle.getLocalizedString(e.EMPTY_LIBRARY_MSG,{storeName:f});b.find(h.EMPTY_LIBRARY_MAIN).html(f);c(b)}var h={EMPTY_LIBRARY_MESSAGE:"#empty-lib-box",EMPTY_LIBRARY_MAIN:"#empty-lib-box p.main",EMPTY_SEARCH_BOX:"#empty_search_box",EMPTY_SEARCH_TEXT:"#empty_search_text",EMPTY_SEARCH_DETAIL:"#empty_search_detail"},d={EMPTY_LIBRARY_STORENAME:"store-name"},e={EMPTY_SEARCH_MSG:"k_empty_search_msg",EMPTY_SEARCH_OFFLINE:"k_empty_search_offline",EMPTY_LIBRARY_MSG:"k_empty_library_main",EMPTY_LIBRARY_storeName:"k_empty_library_store_name"},
c,a,g;return{initialize:function(b,d){c=b;a=d;KindleUXComponentManager.initializeComponent("KindleLibraryMessagePane",f)},showEmptyLibraryMessage:function(){g||($("#page_body_content_containers").hide(),$(h.EMPTY_LIBRARY_MESSAGE).show(),g=!0)},hideEmptyLibraryMessage:function(){g&&($("#page_body_content_containers").show(),$(h.EMPTY_LIBRARY_MESSAGE).hide(),g=!1)},showEmptySearchMessage:function(a){g||($("#page_body_content_containers").hide(),$(h.EMPTY_SEARCH_BOX).show(),$(h.EMPTY_SEARCH_TEXT).show(),
a?$(h.EMPTY_SEARCH_DETAIL).show():$(h.EMPTY_SEARCH_DETAIL).hide(),g=!0)},hideEmptySearchMessage:function(){g&&($("#page_body_content_containers").show(),$(h.EMPTY_SEARCH_BOX).hide(),$(h.EMPTY_SEARCH_TEXT).hide(),$(h.EMPTY_SEARCH_DETAIL).hide(),g=!1)}}}(),KindleLibraryNoDownloadedMessage=function(){function f(f){c=f;var f=c.find("."+e.TOGGLER_CLASS),b=c.find("."+e.IMG_ARROW_CLASS),j=c.find("."+e.CONTENT_TEXT_CLASS);f.tap(function(){j.slideToggle("fast");b.hasClass(h)?b.switchClass(h,d,0):b.switchClass(d,
h,0)});a.resolve()}var h="kindleLibrary_arrowClosed",d="kindleLibrary_arrowOpen",e={TOGGLER_CLASS:"kindleLibrary_noDownloadedToggle",CONTENT_TEXT_CLASS:"kindleLibrary_noDownloadedContent",IMG_ARROW_CLASS:"kindleLibrary_noDownloadedArrow"},c,a;return{show:function(){a||(a=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleLibraryNoDownloadedMessage",f));a.promise().then(function(){$("#kindleLibrary_noDownloadsMsg").length<=0&&$("#titles_container").append(c)})},hide:function(){a&&
c.detach()}}}(),KindleLibraryProgressDialog=function(){function f(){KindleUXComponentManager.closeDialog(d);a()}function h(a){g&&a>=0&&a<=100&&g.find("#"+c.PROGRESS_DIV_ID).slider("option","value",a)}var d="KindleLibraryProgressDialog",e={DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},c={PROGRESS_DIV_ID:"kindleLibrary_progressbar_div"},a,g,b={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,
k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){h(0)},onInitializationDone:function(a){g=a;g.find("#"+c.PROGRESS_DIV_ID).slider({range:"min",value:0,disabled:!0,max:100,min:0,step:1,animate:!0});g.find(".ui-slider-range").addClass("ui-corner-all")}};return{open:function(c){a=c;KindleUXComponentManager.openDialog(d,b)},close:function(){KindleUXComponentManager.closeDialog(d)},updateValue:h}}(),KindleLibraryScrollBar=function(){function f(a){u=a;g(u.find("#"+p.UP_ARROW_ID),!0);g(u.find("#"+
p.DOWN_ARROW_ID),!1);C&&k();r(u)}function h(a,b){w=z-b.value;t(w,!1)}function d(a,b){w=z-b.value;t(w,!0)}function e(a){w=a;u.find("#"+p.PROGRESS_ID).slider("option","value",z-a)}function c(a){a=w+a;a=Math.min(a,z);a=Math.max(a,0);e(a);t(a,!0)}function a(){u.find("#"+p.PROGRESS_ID).slider({orientation:"vertical",animate:!0,slide:h,stop:d});u.find("."+m).removeAttr("href");u.find("."+m).attr("id",p.SLIDER_HANDLE_ID);u.find("#"+p.SLIDER_CONTAINER_ID).tap(function(a){w=a.clientY<a.currentTarget.offsetHeight/
2?0:z;e(w);t(w,!0)});H=!0}function g(a,c){a.bind({mousedown:function(){b(c)},mouseup:j,mouseleave:j})}function b(a){j();var b=a?-n:n;c(b);G=0;v=setInterval(function(){G++;G>=o&&c(b)},q)}function j(){clearInterval(v)}function k(){H||a();var b=u.find("#"+p.SLIDER_CONTAINER_ID).height(),b=Math.max(b*B/C,l);u.find("#"+p.SLIDER_DIV_ID).css({top:b/2+"px",bottom:b/2+"px"});z=C-B;u.find("#"+p.PROGRESS_ID).slider("option","min",0).slider("option","max",z);e(w);u.find("."+m).css({"margin-bottom":-b/2+"px",
height:b+"px"})}var p={SLIDER_CONTAINER_ID:"KindleLibrarySliderContainer",SLIDER_DIV_ID:"KindleLibrarySliderDiv",SLIDER_HANDLE_ID:"kindleLibrarySliderHandle",PROGRESS_ID:"KindleLibraryProgress",UP_ARROW_ID:"kindleLibrarySliderUpArrow",DOWN_ARROW_ID:"kindleLibrarySliderDownArrow"},m="ui-slider-handle",n=80,q=100,o=5,l=20,r,t,u,H,v,G,C,w,B,z;return{initialize:function(a,b){r=a;t=b;KindleUXComponentManager.initializeComponent("KindleLibraryScrollBar",f)},updateValueRange:function(a,b,c){C=a;w=b;B=c;
u&&k()},updateValue:function(a){w=a;u&&e(a)},moveStart:b,moveEnd:j,movePage:function(a){c(a?-B:B)}}}(),KindleLibrarySettingsMenu=function(){function f(){c();KindleSigningOutDialog.show();KindleX.deregister(null,!0).progress(function(a){a&&(a.clearDbAttempts>=1?(KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.PREV_SIGNOUT_FAILED_TITLE),ResourceBundle.getLocalizedString(g.PREV_SIGNOUT_FAILED_TEXT),null,null,[{buttonText:ResourceBundle.getLocalizedString(g.OK_ID)},{buttonText:ResourceBundle.getLocalizedString(g.HELP_ID),
callback:function(){window.open(Kindle.ExternalLinks.HelpTroubleshooting)}}]),KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).emit("Library::SignOut::PrevAttemptFailed",{breakdown:["Browser"]})):a.blocked&&KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.DB_BLOCKED_TITLE),ResourceBundle.getLocalizedString(g.DB_BLOCKED_TEXT)))}).fail(function(){KindleSigningOutDialog.hide();KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.OFFLINE_LOGOUT_TITLE),ResourceBundle.getLocalizedString(g.OFFLINE_LOGOUT_TEXT))})}
function h(){c();KindleLibraryFeedbackDialog.show()}function d(){function a(b,c,d){return{elementId:b,content:c,clickHandler:d}}var c={};c.ITEM_HELP=a(b.ITEM_HELP,ResourceBundle.getLocalizedString(g.HELP_ID),e(j.HELP_LINK));c.ITEM_TERMS=a(b.ITEM_TERMS,ResourceBundle.getLocalizedString(g.TERM_OF_USE_ID),e(j.TERM_OF_USE_LINK));c.ITEM_LEGAL=a(b.ITEM_LEGAL,ResourceBundle.getLocalizedString(g.LEGAL_NOTICE_ID),e(j.LEGAL_NOTICE_LINK));c.ITEM_PRIVACY=a(b.ITEM_PRIVACY,ResourceBundle.getLocalizedString(g.PRIVACY_ID),
e(j.PRIVACY_LINK));c.ITEM_CONTACT_US=a(b.ITEM_CONTACT_US,ResourceBundle.getLocalizedString(g.CONTACT_US_ID),h);c.ITEM_DEREGISTER=a(b.ITEM_DEREGISTER,ResourceBundle.getLocalizedString(g.DEREGISTER_ID),f);return c}function e(a){return function(){c();k(a)}}function c(){KindleUXComponentManager.hideMenu(a)}var a="KindleLibrarySettingsMenu",g={OK_ID:"k_common_confirm_button",HELP_ID:"k_L_help",TERM_OF_USE_ID:"k_L_terms_of_use",LEGAL_NOTICE_ID:"k_L_legal_notices",PRIVACY_ID:"k_L_privacy",DEREGISTER_ID:"k_L_deregister_title",
CONTACT_US_ID:"k_L_contact_us",OFFLINE_LOGOUT_TITLE:"k_dialog_offlineLogout_Title",OFFLINE_LOGOUT_TEXT:"k_dialog_offlineLogout_Text",DB_BLOCKED_TITLE:"k_dialog_dbBlocked_Title",DB_BLOCKED_TEXT:"k_dialog_dbBlocked_Text",PREV_SIGNOUT_FAILED_TITLE:"k_dialog_prevSignOutFailed_Title",PREV_SIGNOUT_FAILED_TEXT:"k_dialog_prevSignOutFailed_Text"},b={ITEM_HELP:"kindleLibrary_settingsMenu_item_help",ITEM_TERMS:"kindleLibrary_settingsMenu_item_terms",ITEM_LEGAL:"kindleLibrary_settingsMenu_item_legal",ITEM_PRIVACY:"kindleLibrary_settingsMenu_item_privacy",
ITEM_CONTACT_US:"kindleLibrary_settingsMenu_item_contactUs",ITEM_DEREGISTER:"kindleLibrary_settingsMenu_item_signOut"},j={HELP_LINK:"http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200701430",TERM_OF_USE_LINK:"http://www.amazon.com/kindleterms",LEGAL_NOTICE_LINK:"http://www.amazon.com/gp/help/customer/display.html/ref=kcr_legalnotices_menu?nodeId=200701450",PRIVACY_LINK:"http://www.amazon.com/privacy"},k;return{show:function(b){k=b;b={componentName:a,menuItems:d(),buttonID:"kindleLibrary_button_manage",
position:"down",title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(b)},hide:c}}(),KindleLibrarySortMenu=function(){function f(e){function c(a,b,c){return{elementId:a,content:b,clickHandler:c}}var a={};a.ITEM_SORT_RECENT=c(d.ITEM_SORT_RECENT,ResourceBundle.getLocalizedString(h.SORT_RECENT),function(){KindleLibrarySortMenu.hide();e("recent")});a.ITEM_SORT_AUTHOR=c(d.ITEM_SORT_AUTHOR,ResourceBundle.getLocalizedString(h.SORT_AUTHOR),function(){KindleLibrarySortMenu.hide();
e("author")});a.ITEM_SORT_TITLE=c(d.ITEM_SORT_TITLE,ResourceBundle.getLocalizedString(h.SORT_TITLE),function(){KindleLibrarySortMenu.hide();e("title")});return a}var h={SORT_RECENT:"k_L_sort_recent",SORT_AUTHOR:"k_L_sort_author",SORT_TITLE:"k_L_sort_title"},d={ITEM_SORT_RECENT:"kindleLibrary_sortMenuItem_sortByRecent",ITEM_SORT_AUTHOR:"kindleLibrary_sortMenuItem_sortByAuthor",ITEM_SORT_TITLE:"kindleLibrary_sortMenuItem_sortByTitle"};return{show:function(d,c){var a={componentName:"KindleLibrarySortMenu",
menuItems:f(c),buttonID:"kindleLibrary_button_sort",position:d,title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(a)},hide:function(){KindleUXComponentManager.hideMenu("KindleLibrarySortMenu")}}}();
