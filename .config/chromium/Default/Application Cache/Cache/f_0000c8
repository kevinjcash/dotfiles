/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function KindleModuleManagerFactory(){function h(a,b){if(q[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;q[a]=b;n[a].resolve(b)}function j(a){if(q.hasOwnProperty(a))throw"Duplicate registration of module "+a;q[a]=void 0}function e(a,b){n[a]||(n[a]=new jQuery.Deferred);h(a,b)}function d(a,b){j(a);n[a]||(n[a]=new jQuery.Deferred);b(n[a]);n[a].done(function(b){h(a,b)})}function c(a,b){d(a,function(a){b.done(a.resolve).fail(a.reject)})}function b(a){n[a]||
(n[a]=new jQuery.Deferred);return n[a].promise()}function g(a){if(!q[a])throw"Trying to get uninitialized module "+a;return q[a]}function a(a){return q.hasOwnProperty(a)}function f(a,b){q[a]=b}function k(a){var b=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function m(a){for(var b={},c=0;c<a.length;c++)b[name]=q[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function l(){q={}}var o={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network"},q={},n={};return{CONSTANTS:o.CONSTANTS,DB_CLIENT:o.DB_CLIENT,RESOURCE_BUNDLE:o.RESOURCE_BUNDLE,METRICS_MANAGER:o.METRICS_MANAGER,SERVICE_CLIENT:o.SERVICE_CLIENT,APP_REGISTRATION:o.APP_REGISTRATION,JOURNAL_MANAGER:o.JOURNAL_MANAGER,
BOOK_METADATA:o.BOOK_METADATA,BOOK_FRAGMAP:o.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:o.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:o.CONTENT_MIGRATION,NETWORK:o.NETWORK,ERROR_CODE_CANCEL:"canceled",registerModule:e,registerModuleList:function(a){for(var b in a)e(b,a[b])},registerModuleWithInitializer:d,registerModuleWithDeferred:c,detachModule:function(a){var b=q[a],c=n[a];c&&!c.isResolved()&&c.reject("canceled");delete q[a];delete n[a];return b},getModule:b,getModuleList:function(a){var c=new jQuery.Deferred,
f,g=[];for(f=0;f<a.length;f++)g.push(b(a[f]));$.when.apply($,g).done(function(){var b,f={};for(b=0;b<a.length;b++)f[a[b]]=arguments[b];c.resolve(f)}).fail(c.reject);return c.promise()},getModuleSync:g,isModuleInitialized:function(a){return q[a]!==void 0},isModuleRegistered:a,switchToTestMode:function(){this.registerModuleTest=f;this.getModule=k;this.getModuleSync=g;this.getModuleList=m;this.clear=l;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},define:function(f,
g,d){if(!a(f)){var k=[],e=$.Deferred();c(f,e);g&&g.length&&g.forEach(function(a){k.push(a&&$.isFunction(a.promise)?a:b(a))});$.when.apply($,k).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(e.resolve,function(){e.reject()}):e.resolve(a)},function(){e.reject()})}},require:function(a,c){$.isArray(a)||(a=[a]);var f,g,d=[];a.forEach(function(a){d.push(a&&$.isFunction(a.promise)?a:b(a))});c||(g=$.Deferred(),f=g.promise());$.when.apply($,
d).then(function(){var a=$.makeArray(arguments);c?c.apply(c,a):g.resolve.apply(g,a)},function(){c&&g.reject()});return f}}}var KindleModuleManager=KindleModuleManagerFactory();
(function(h,j,e){h.fn.jScrollPane=function(d){function c(b,c){function a(c){var g,d,k,n,l,u=!1,r=!1;E=c;if(P===e)n=b.scrollTop(),l=b.scrollLeft(),b.css({overflow:"hidden",padding:0}),S=b.innerWidth()+ya,T=b.innerHeight(),b.width(S),P=h('<div class="jspPane" />').css("padding",cb).append(b.children()),Q=h('<div class="jspContainer" />').css({width:S+"px",height:T+"px"}).append(P).appendTo(b);else{b.css("width","");u=E.stickToBottom&&I();r=E.stickToRight&&L();if(k=b.innerWidth()+ya!=S||b.outerHeight()!=
T)S=b.innerWidth()+ya,T=b.innerHeight(),Q.css({width:S+"px",height:T+"px"});if(!k&&db==Y&&P.outerHeight()==W){b.width(S);return}db=Y;P.css("width","");b.width(S);Q.find(">.jspVerticalBar,>.jspHorizontalBar").remove().end()}P.css("overflow","auto");Y=c.contentWidth?c.contentWidth:P[0].scrollWidth;W=P[0].scrollHeight;P.css("overflow","");ia=Y/S;ba=W/T;na=ba>1;ha=ia>1;if(!ha&&!na)b.removeClass("jspScrollable"),P.css({top:0,width:Q.width()-ya}),Q.unbind(eb),P.find(":input,a").unbind("focus.jsp"),b.attr("tabindex",
"-1").removeAttr("tabindex").unbind("keydown.jsp keypress.jsp"),t();else{b.addClass("jspScrollable");if(c=E.maintainPosition&&(fa||ea))g=B(),d=v();f();m();o();c&&(A(r?Y-S:g,!1),F(u?W-T:d,!1));M();D();C();E.enableKeyboardNavigation&&H();E.clickOnTrack&&s();J();E.hijackInternalLinks&&O()}E.autoReinitialise&&!Ea?Ea=setInterval(function(){a(E)},E.autoReinitialiseDelay):!E.autoReinitialise&&Ea&&clearInterval(Ea);n&&b.scrollTop(0)&&F(n,!1);l&&b.scrollLeft(0)&&A(l,!1);b.trigger("jsp-initialised",[ha||na])}
function f(){na&&(Q.append(h('<div class="jspVerticalBar" />').append(h('<div class="jspCap jspCapTop" />'),h('<div class="jspTrack" />').append(h('<div class="jspDrag" />').append(h('<div class="jspDragTop" />'),h('<div class="jspDragBottom" />'))),h('<div class="jspCap jspCapBottom" />'))),sa=Q.find(">.jspVerticalBar"),ra=sa.find(">.jspTrack"),ma=ra.find(">.jspDrag"),E.showArrows&&(Ma=h('<a class="jspArrow jspArrowUp" />').bind("mousedown.jsp",n(0,-1)).bind("click.jsp",K),Na=h('<a class="jspArrow jspArrowDown" />').bind("mousedown.jsp",
n(0,1)).bind("click.jsp",K),E.arrowScrollOnHover&&(Ma.bind("mouseover.jsp",n(0,-1,Ma)),Na.bind("mouseover.jsp",n(0,1,Na))),q(ra,E.verticalArrowPositions,Ma,Na)),ca=T,Q.find(">.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow").each(function(){ca-=h(this).outerHeight()}),ma.hover(function(){ma.addClass("jspHover")},function(){ma.removeClass("jspHover")}).bind("mousedown.jsp",function(a){h("html").bind("dragstart.jsp selectstart.jsp",K);ma.addClass("jspActive");var b=a.pageY-ma.position().top;
h("html").bind("mousemove.jsp",function(a){z(a.pageY-b,!1)}).bind("mouseup.jsp mouseleave.jsp",u);return!1}),d())}function d(){ra.height(ca+"px");fa=0;fb=E.verticalGutter+ra.outerWidth();P.width(S-fb-ya);try{sa.position().left===0&&P.css("margin-left",fb+"px")}catch(a){}}function m(){ha&&(Q.append(h('<div class="jspHorizontalBar" />').append(h('<div class="jspCap jspCapLeft" />'),h('<div class="jspTrack" />').append(h('<div class="jspDrag" />').append(h('<div class="jspDragLeft" />'),h('<div class="jspDragRight" />'))),
h('<div class="jspCap jspCapRight" />'))),Sa=Q.find(">.jspHorizontalBar"),wa=Sa.find(">.jspTrack"),Z=wa.find(">.jspDrag"),E.showArrows&&(Oa=h('<a class="jspArrow jspArrowLeft" />').bind("mousedown.jsp",n(-1,0)).bind("click.jsp",K),Fa=h('<a class="jspArrow jspArrowRight" />').bind("mousedown.jsp",n(1,0)).bind("click.jsp",K),E.arrowScrollOnHover&&(Oa.bind("mouseover.jsp",n(-1,0,Oa)),Fa.bind("mouseover.jsp",n(1,0,Fa))),q(wa,E.horizontalArrowPositions,Oa,Fa)),Z.hover(function(){Z.addClass("jspHover")},
function(){Z.removeClass("jspHover")}).bind("mousedown.jsp",function(a){h("html").bind("dragstart.jsp selectstart.jsp",K);Z.addClass("jspActive");var b=a.pageX-Z.position().left;h("html").bind("mousemove.jsp",function(a){y(a.pageX-b,!1)}).bind("mouseup.jsp mouseleave.jsp",u);return!1}),Aa=Q.innerWidth(),l())}function l(){Q.find(">.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow").each(function(){Aa-=h(this).outerWidth()});wa.width(Aa+"px");ea=0}function o(){if(ha&&na){var a=wa.outerHeight(),
b=ra.outerWidth();ca-=a;h(Sa).find(">.jspCap:visible,>.jspArrow").each(function(){Aa+=h(this).outerWidth()});Aa-=b;T-=b;S-=a;wa.parent().append(h('<div class="jspCorner" />').css("width",a+"px"));d();l()}ha&&P.width(Q.outerWidth()-ya+"px");W=P.outerHeight();ba=W/T;if(ha){za=Math.ceil(1/ia*Aa);if(za>E.horizontalDragMaxWidth)za=E.horizontalDragMaxWidth;else if(za<E.horizontalDragMinWidth)za=E.horizontalDragMinWidth;Z.width(za+"px");ja=Aa-za;G(ea)}if(na){oa=Math.ceil(1/ba*ca);if(oa>E.verticalDragMaxHeight)oa=
E.verticalDragMaxHeight;else if(oa<E.verticalDragMinHeight)oa=E.verticalDragMinHeight;ma.height(oa+"px");pa=ca-oa;w(fa)}}function q(a,b,c,f){var g="before",d="after";b=="os"&&(b=/Mac/.test(navigator.platform)?"after":"split");b==g?d=b:b==d&&(g=b,b=c,c=f,f=b);a[g](c)[d](f)}function n(a,b,c){return function(){r(a,b,this,c);this.blur();return!1}}function r(a,b,c,f){var c=h(c).addClass("jspActive"),g,d,k=!0,e=function(){a!==0&&N.scrollByX(a*E.arrowButtonSpeed);b!==0&&N.scrollByY(b*E.arrowButtonSpeed);
d=setTimeout(e,k?E.initialDelay:E.arrowRepeatFreq);k=!1};e();g=f?"mouseout.jsp":"mouseup.jsp";f=f||h("html");f.bind(g,function(){c.removeClass("jspActive");d&&clearTimeout(d);d=null;f.unbind(g)})}function s(){t();na&&ra.bind("mousedown.jsp",function(a){if(a.originalTarget===e||a.originalTarget==a.currentTarget){var b=h(this),c=b.offset(),f=a.pageY-c.top-fa,g,d=!0,k=function(){var c=b.offset(),c=a.pageY-c.top-oa/2,e=T*E.scrollPagePercent,n=pa*e/(W-T);if(f<0)fa-n>c?N.scrollByY(-e):z(c);else if(f>0)fa+
n<c?N.scrollByY(e):z(c);else{m();return}g=setTimeout(k,d?E.initialDelay:E.trackClickRepeatFreq);d=!1},m=function(){g&&clearTimeout(g);g=null;h(document).unbind("mouseup.jsp",m)};k();h(document).bind("mouseup.jsp",m);return!1}});ha&&wa.bind("mousedown.jsp",function(a){if(a.originalTarget===e||a.originalTarget==a.currentTarget){var b=h(this),c=b.offset(),f=a.pageX-c.left-ea,g,d=!0,k=function(){var c=b.offset(),c=a.pageX-c.left-za/2,e=S*E.scrollPagePercent,n=ja*e/(Y-S);if(f<0)ea-n>c?N.scrollByX(-e):
y(c);else if(f>0)ea+n<c?N.scrollByX(e):y(c);else{m();return}g=setTimeout(k,d?E.initialDelay:E.trackClickRepeatFreq);d=!1},m=function(){g&&clearTimeout(g);g=null;h(document).unbind("mouseup.jsp",m)};k();h(document).bind("mouseup.jsp",m);return!1}})}function t(){wa&&wa.unbind("mousedown.jsp");ra&&ra.unbind("mousedown.jsp")}function u(){h("html").unbind("dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp");ma&&ma.removeClass("jspActive");Z&&Z.removeClass("jspActive")}function z(a,
b){if(na){a<0?a=0:a>pa&&(a=pa);if(b===e)b=E.animateScroll;b?N.animate(ma,"top",a,w):(ma.css("top",a),w(a))}}function w(a){if(a===e)a=ma.position().top;Q.scrollTop(0);fa=a;var c=fa===0,f=fa==pa,a=-(a/pa)*(W-T);if(Ga!=c||Ta!=f)Ga=c,Ta=f,b.trigger("jsp-arrow-change",[Ga,Ta,Ha,Ua]);E.showArrows&&(Ma[c?"addClass":"removeClass"]("jspDisabled"),Na[f?"addClass":"removeClass"]("jspDisabled"));P.css("top",a);b.trigger("jsp-scroll-y",[-a,c,f]).trigger("scroll")}function y(a,b){if(ha){a<0?a=0:a>ja&&(a=ja);if(b===
e)b=E.animateScroll;b?N.animate(Z,"left",a,G):(Z.css("left",a),G(a))}}function G(a){if(a===e)a=Z.position().left;Q.scrollTop(0);ea=a;var c=ea===0,f=ea==ja,a=-(a/ja)*(Y-S);if(Ha!=c||Ua!=f)Ha=c,Ua=f,b.trigger("jsp-arrow-change",[Ga,Ta,Ha,Ua]);E.showArrows&&(Oa[c?"addClass":"removeClass"]("jspDisabled"),Fa[f?"addClass":"removeClass"]("jspDisabled"));P.css("left",a);b.trigger("jsp-scroll-x",[-a,c,f]).trigger("scroll")}function F(a,b){z(a/(W-T)*pa,b)}function A(a,b){y(a/(Y-S)*ja,b)}function x(a,b,c){var f,
g,d=0,k=0,e,m,n;try{f=h(a)}catch(l){return}g=f.outerHeight();a=f.outerWidth();Q.scrollTop(0);for(Q.scrollLeft(0);!f.is(".jspPane");)if(d+=f.position().top,k+=f.position().left,f=f.offsetParent(),/^body|html$/i.test(f[0].nodeName))return;f=v();e=f+T;d<f||b?m=d-E.verticalGutter:d+g>e&&(m=d-T+g+E.verticalGutter);m&&F(m,c);d=B();m=d+S;k<d||b?n=k-E.horizontalGutter:k+a>m&&(n=k-S+a+E.horizontalGutter);n&&A(n,c)}function B(){return-P.position().left}function v(){return-P.position().top}function I(){var a=
W-T;return a>20&&a-v()<10}function L(){var a=Y-S;return a>20&&a-B()<10}function D(){Q.unbind(eb).bind(eb,function(a,b,c,f){a=ea;b=fa;N.scrollBy(c*E.mouseWheelSpeed,-f*E.mouseWheelSpeed,!1);return a==ea&&b==fa})}function K(){return!1}function M(){P.find(":input,a").unbind("focus.jsp").bind("focus.jsp",function(a){x(a.target,!1)})}function H(){function a(){var b=ea,g=fa;switch(c){case 40:N.scrollByY(E.keyboardSpeed,!1);break;case 38:N.scrollByY(-E.keyboardSpeed,!1);break;case 34:case 32:N.scrollByY(T*
E.scrollPagePercent,!1);break;case 33:N.scrollByY(-T*E.scrollPagePercent,!1);break;case 39:N.scrollByX(E.keyboardSpeed,!1);break;case 37:N.scrollByX(-E.keyboardSpeed,!1)}return f=b!=ea||g!=fa}var c,f,g=[];ha&&g.push(Sa[0]);na&&g.push(sa[0]);P.focus(function(){b.focus()});b.attr("tabindex",0).unbind("keydown.jsp keypress.jsp").bind("keydown.jsp",function(b){if(!(b.target!==this&&(!g.length||!h(b.target).closest(g).length))){var d=ea,k=fa;switch(b.keyCode){case 40:case 38:case 34:case 32:case 33:case 39:case 37:c=
b.keyCode;a();break;case 35:F(W-T);c=null;break;case 36:F(0),c=null}f=b.keyCode==c&&d!=ea||k!=fa;return!f}}).bind("keypress.jsp",function(b){b.keyCode==c&&a();return!f});E.hideFocus?(b.css("outline","none"),"hideFocus"in Q[0]&&b.attr("hideFocus",!0)):(b.css("outline",""),"hideFocus"in Q[0]&&b.attr("hideFocus",!1))}function J(){if(location.hash&&location.hash.length>1){var a,b,c=escape(location.hash.substr(1));try{a=h("#"+c+', a[name="'+c+'"]')}catch(f){return}a.length&&P.find(c)&&(Q.scrollTop()===
0?b=setInterval(function(){Q.scrollTop()>0&&(x(a,!0),h(document).scrollTop(Q.position().top),clearInterval(b))},50):(x(a,!0),h(document).scrollTop(Q.position().top)))}}function O(){h(document.body).data("jspHijack")||(h(document.body).data("jspHijack",!0),h(document.body).delegate("a[href*=#]","click",function(a){var b=this.href.substr(0,this.href.indexOf("#")),c=location.href,f;location.href.indexOf("#")!==-1&&(c=location.href.substr(0,location.href.indexOf("#")));if(b===c){b=escape(this.href.substr(this.href.indexOf("#")+
1));try{f=h("#"+b+', a[name="'+b+'"]')}catch(g){return}if(f.length){b=f.closest(".jspScrollable");b.data("jsp").scrollToElement(f,!0);if(b[0].scrollIntoView)c=h(j).scrollTop(),f=f.offset().top,(f<c||f>c+h(j).height())&&b[0].scrollIntoView();a.preventDefault()}}}))}function C(){var a,b,c,f,g,d=!1;Q.unbind("touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick MSPointerDown.jsp MSPointerMove.jsp MSPointerUp.jsp MSPointerCancel.jsp").bind("touchstart.jsp MSPointerDown.jsp",function(k){k=k.originalEvent.touches?
k.originalEvent.touches[0]:k.originalEvent;a=B();b=v();c=k.pageX;f=k.pageY;g=!1;d=!0}).bind("touchmove.jsp MSPointerMove.jsp",function(k){if(d){var e=ea,m=fa,k=k.originalEvent.touches?k.originalEvent.touches[0]:k.originalEvent;N.scrollTo(a+c-k.pageX,b+f-k.pageY);g=g||Math.abs(c-k.pageX)>5||Math.abs(f-k.pageY)>5;return e==ea&&m==fa}}).bind("touchend.jsp MSPointerUp.jsp MSPointerCancel.jsp",function(){d=!1}).bind("click.jsp-touchclick",function(){if(g)return g=!1})}var E,N=this,P,S,T,Q,Y,W,ia,ba,na,
ha,ma,pa,fa,Z,ja,ea,sa,ra,fb,ca,oa,Ma,Na,Sa,wa,Aa,za,Oa,Fa,Ea,cb,ya,db,Ga=!0,Ha=!0,Ta=!1,Ua=!1,Va=b.clone(!1,!1).empty(),eb=h.fn.mwheelIntent?"mwheelIntent.jsp":"mousewheel.jsp";cb=b.css("paddingTop")+" "+b.css("paddingRight")+" "+b.css("paddingBottom")+" "+b.css("paddingLeft");ya=(parseInt(b.css("paddingLeft"),10)||0)+(parseInt(b.css("paddingRight"),10)||0);h.extend(N,{reinitialise:function(b){b=h.extend({},E,b);a(b)},scrollToElement:function(a,b,c){x(a,b,c)},scrollTo:function(a,b,c){A(a,c);F(b,
c)},scrollToX:function(a,b){A(a,b)},scrollToY:function(a,b){F(a,b)},scrollToPercentX:function(a,b){A(a*(Y-S),b)},scrollToPercentY:function(a,b){F(a*(W-T),b)},scrollBy:function(a,b,c){N.scrollByX(a,c);N.scrollByY(b,c)},scrollByX:function(a,b){var c=(B()+Math[a<0?"floor":"ceil"](a))/(Y-S);y(c*ja,b)},scrollByY:function(a,b){var c=(v()+Math[a<0?"floor":"ceil"](a))/(W-T);z(c*pa,b)},positionDragX:function(a,b){y(a,b)},positionDragY:function(a,b){z(a,b)},animate:function(a,b,c,f){var g={};g[b]=c;a.animate(g,
{duration:E.animateDuration,easing:E.animateEase,queue:!1,step:f})},getContentPositionX:function(){return B()},getContentPositionY:function(){return v()},getContentWidth:function(){return Y},getContentHeight:function(){return W},getPercentScrolledX:function(){return B()/(Y-S)},getPercentScrolledY:function(){return v()/(W-T)},getIsScrollableH:function(){return ha},getIsScrollableV:function(){return na},getContentPane:function(){return P},scrollToBottom:function(a){z(pa,a)},hijackInternalLinks:h.noop,
destroy:function(){var a=v(),c=B();b.removeClass("jspScrollable").unbind(".jsp");b.replaceWith(Va.append(P.children()));Va.scrollTop(a);Va.scrollLeft(c);Ea&&clearInterval(Ea)}});a(c)}d=h.extend({},h.fn.jScrollPane.defaults,d);h.each(["mouseWheelSpeed","arrowButtonSpeed","trackClickSpeed","keyboardSpeed"],function(){d[this]=d[this]||d.speed});return this.each(function(){var b=h(this),g=b.data("jsp");g?g.reinitialise(d):(g=new c(b,d),b.data("jsp",g))})};h.fn.jScrollPane.defaults={showArrows:!1,maintainPosition:!0,
stickToBottom:!1,stickToRight:!1,clickOnTrack:!0,autoReinitialise:!1,autoReinitialiseDelay:500,verticalDragMinHeight:0,verticalDragMaxHeight:99999,horizontalDragMinWidth:0,horizontalDragMaxWidth:99999,contentWidth:e,animateScroll:!1,animateDuration:300,animateEase:"linear",hijackInternalLinks:!1,verticalGutter:4,horizontalGutter:4,mouseWheelSpeed:0,arrowButtonSpeed:0,arrowRepeatFreq:50,arrowScrollOnHover:!1,trackClickSpeed:0,trackClickRepeatFreq:70,verticalArrowPositions:"split",horizontalArrowPositions:"split",
enableKeyboardNavigation:!0,hideFocus:!1,keyboardSpeed:0,initialDelay:300,speed:30,scrollPagePercent:0.8}})(jQuery,this);
(function(){var h=Handlebars.template,j=Handlebars.templates=Handlebars.templates||{};j["Embedded/KindleReaderHeaderBar"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div id=\"kindleReader_kindleLogo_embedded\" class=\"kindleReader_kindleLogo\"\n            tabindex = 1;\n            data-action='reader_open_full_kcr'\n            title='";b=
{hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_embedded_logo_tooltip",b):f.call(d,"str","k_R_embedded_logo_tooltip",b)))+"'\n        ></div>\n\n        <div class=\"readerControls\">\n\n            <div\n                id='kindleReader_button_goto'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):f.call(d,"str","k_R_menuButton_goto_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_goto'\n            ></div>\n\n            <div\n                id='kindleReader_button_controlPanel'\n                class='header_bar_icon disabled'\n                title='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):f.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_settings'\n            ></div>\n\n            <div\n                id='kindleReader_bookmark'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):f.call(d,"str","k_R_menuButton_bookmark_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_bookmark'\n            ></div>\n\n            <div\n                id='kindleReader_button_note'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):f.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_notes'\n            ></div>\n        </div>\n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n            <div id='kindleReader_sitb' class='disabled'>\n                <div id='kindleReader_input_sitb'>\n                    <input id='kindleReader_input_sitb_box' type='text' tabindex = 1 />\n                    <div id='kindleReader_input_sitb_clear'></div>\n                </div>\n                <button id='kindleReader_button_sitb' class='header_bar_button' tabindex = 1 value='' data-action='reader_search'/>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j.KindleAnnotationComponentFactory=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=this.escapeExpression,k=c.helperMissing;e+="<div id='";(b=c.id)?b=b.call(d,{hash:{},data:g}):(b=d.id,b=typeof b==="function"?b.apply(d):b);e+=f(b)+'\' class="kindleReader_annotation_pane_notes clearfix" >\n    <p class="kindleReader_annotation_pane_notes_context">     \n    </p>\n    <p>\n    <textarea\n        id="kindleReader_annotation_pane_edit_textArea"\n        rows="10"\n        maxlength="';
(b=c.maxNoteChars)?b=b.call(d,{hash:{},data:g}):(b=d.maxNoteChars,b=typeof b==="function"?b.apply(d):b);e+=f(b)+'"\n        >';(b=c.context)?b=b.call(d,{hash:{},data:g}):(b=d.context,b=typeof b==="function"?b.apply(d):b);e+=f(b)+'</textarea>\n    </p>\n    <div class="kindleReader_annotation_pane_notes_metadata_container clearfix">\n        <div class="kindleReader_annotation_pane_icon"></div>\n        <label class="kindleReader_annotation_pane_notes_pageLabel">';(b=c.pageLabel)?b=b.call(d,{hash:{},
data:g}):(b=d.pageLabel,b=typeof b==="function"?b.apply(d):b);e+=f(b)+'</label>\n        <input type="hidden" name="kindleReader_annotation_pane_notes_start" value=';(b=c.start)?b=b.call(d,{hash:{},data:g}):(b=d.start,b=typeof b==="function"?b.apply(d):b);e+=f(b)+'/>\n        \n        <span class="kindleReader_annotation_pane_notes_trashcan kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_delete",a):k.call(d,"str","k_R_annotation_pane_delete",
a)))+"'></span>\n        <span class=\"kindleReader_annotation_pane_notes_goto kindleReader_annotation_pane_action_btn\" title='";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_goto",a):k.call(d,"str","k_R_annotation_pane_goto",a)))+"'></span>\n        <span class=\"kindleReader_annotation_pane_notes_edit kindleReader_annotation_pane_action_btn\" title='";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_edit",a):k.call(d,"str","k_R_annotation_pane_edit",a)))+"'></span>\n        <div class=\"kindleReader_annotation_pane_notes_save kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn\" title='";
a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_save",a):k.call(d,"str","k_R_annotation_pane_save",a)))+"'>";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_dialog_editNote_save",a):k.call(d,"str","k_R_dialog_editNote_save",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_cancel kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_cancel",a):k.call(d,"str",
"k_R_annotation_pane_cancel",a)))+"'>";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_dialog_editNote_cancel",a):k.call(d,"str","k_R_dialog_editNote_cancel",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_yes kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_delete",a):k.call(d,"str","k_R_annotation_pane_delete",a)))+"'>";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_yes",
a):k.call(d,"str","k_R_annotation_pane_yes",a)))+'</div>\n        <div class="kindleReader_annotation_pane_notes_no kindleReader_annotation_pane_notes_button kindleReader_annotation_pane_action_btn" title=\'';a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_dont_delete",a):k.call(d,"str","k_R_annotation_pane_dont_delete",a)))+"'>";a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_no",a):k.call(d,"str","k_R_annotation_pane_no",a)))+'</div>\n        <span class="kindleReader_annotation_notes_delete_confirm">';
a={hash:{},data:g};e+=f((b=c.str,b?b.call(d,"k_R_annotation_pane_delete_confirm",a):k.call(d,"str","k_R_annotation_pane_delete_confirm",a)))+'</span>\n    </div>\n        \n\n</div>\n<div class="kindleReader_annotation_pane_notes_divider_top"></div>\n<div class="kindleReader_annotation_pane_notes_divider_bottom"></div>';return e});j.KindleImageViewer=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];c=c||e.helpers;g=g||{};e="";b=this.escapeExpression;e+='<div class="imageViewerBackdrop">\n    <img class="imageViewerImage" src=';
(c=c.imageSource)?c=c.call(d,{hash:{},data:g}):(c=d.imageSource,c=typeof c==="function"?c.apply(d):c);e+=b(c)+"></img>\n</div>";return e});j.KindleReaderAnnotationsPane=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+='<div id="kindleReader_annotations_pane">\n    <div id="kindleReader_annotations_pane_header">\n        <div id="kindleReader_annotations_pane_title">';b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,
"k_R_dialog_annotation_pane_title",b):f.call(d,"str","k_R_dialog_annotation_pane_title",b)))+'</div>\n    </div>\n    <div id="kindleReader_annotations_pane_scrollWrapper">\n        <div id="kindleReader_annotations_pane_container"></div>\n    </div>\n    <div id="kindleReader_annotations_pane_notes_empty">';b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_annotation_pane_empty_note",b):f.call(d,"str","k_R_annotation_pane_empty_note",b)))+"</div>\n</div>";return e});j.KindleReaderBookmarkOverlay=
h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'bookmark_overlay_div\' class="immersive_slide_area" data-action="reader_bookmark" ></div>'});j.KindleReaderBuyButton=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,b=c.helperMissing,f=this.escapeExpression;e+='<div id="kindleReader_Buy_Full_Button" tabindex="2" data-action=\'reader_buy_full_book\'>\n\t';g={hash:{},data:g};e+=f((a=c.str,a?a.call(d,"k_endOfSample_buy_button",g):b.call(d,
"str","k_endOfSample_buy_button",g)))+"\n</div>";return e});j.KindleReaderContextMenu=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_menu_contextMenu">\n    <div id="kindle_menu_border">\n    </div>\n</div>'});j.KindleReaderContextMenuDictionary=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a=this.escapeExpression;e+='<div class="dictionary"> \n    <div class="term"> \n        <span class="entry">';(b=c.entry)?b=b.call(d,
{hash:{},data:g}):(b=d.entry,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'</span><span class="audio" id="dictionary_audio"></span><span class="pronunciation">';(b=c.pronunciation)?b=b.call(d,{hash:{},data:g}):(b=d.pronunciation,b=typeof b==="function"?b.apply(d):b);if(b||b===0)e+=b;e+='</span><br/>\n    </div> \n    <div class="definition">';(b=c.definition)?b=b.call(d,{hash:{},data:g}):(b=d.definition,b=typeof b==="function"?b.apply(d):b);if(b||b===0)e+=b;e+='</div>  \n    <div class="reference"><a class="view_full_link" href="';
(b=c.view_full_url)?b=b.call(d,{hash:{},data:g}):(b=d.view_full_url,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'" target="_blank"><span class="view_full">';(b=c.view_full)?b=b.call(d,{hash:{},data:g}):(b=d.view_full,b=typeof b==="function"?b.apply(d):b);e+=a(b)+'</span><span class="view_full_logo"></span></a></div>\n</div>';return e});j.KindleReaderEditNoteDialog=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a=this.escapeExpression,f=c.helperMissing;
e+='<div id="kindleReader_dialog_editNote">\n    <label id="kindleReader_dialog_editNote_title" class="kindle_dialog_title_text"></label>\n    <p>\n    <textarea\n        id="kindleReader_dialog_editNote_noteText"\n        cols="60"\n        rows="10"\n        maxlength="';(b=c.maxNoteChars)?b=b.call(d,{hash:{},data:g}):(b=d.maxNoteChars,b=typeof b==="function"?b.apply(d):b);e+=a(b)+"\"\n        placeholder='";g={hash:{},data:g};e+=a((b=c.str,b?b.call(d,"k_R_dialog_editNote_placeholder",g):f.call(d,
"str","k_R_dialog_editNote_placeholder",g)))+"'\n        ></textarea>\n    </p>\n</div>";return e});j.KindleReaderEmbeddedError=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_embeddedError">\n    <div id="kindleReader_embeddedError_icon"></div>\n    <div id="kindleReader_embeddedError_text"></div>\n</div>'});j.KindleReaderGoToDialog=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;
e+="<div id='kindleReader_dialog_goto'>\n    <label id='kindleReader_dialog_gotoTitle' class='kindle_dialog_title_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location_title",b):f.call(d,"str","k_R_goto_menu_goto_location_title",b)))+"</label>\n\t<p>\n\t    <div id='kindleReader_dialog_gotoLabel' for='kindleReader_dialog_gotoField'  class='kindle_dialog_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_message",b):f.call(d,"str","k_R_goto_menu_goto_message",
b)))+"</div>\n        <div class=\"goto_from\">\n            <input type='number' name='name' size='7' id='kindleReader_dialog_gotoField'>\n        </div>\n        <div id='kindleReader_dialog_gotoLocation' for='kindleReader_dialog_gotoField' class='kindle_dialog_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location",b):f.call(d,"str","k_R_goto_menu_goto_location",b)))+"</div>\n    </p>\n</div>";return e});j.KindleReaderGoToPageDialog=h(function(e,d,c,b,g){this.compilerInfo=
[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto_page'>\n    <label id='kindleReader_dialog_gotoPageTitle' class='kindle_dialog_title_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_title",b):f.call(d,"str","k_R_goto_menu_goto_page_title",b)))+"</label>\n\t<p>\n\t    <div id='kindleReader_dialog_gotoPageLabel' for='kindleReader_dialog_gotoPageField'  class='kindle_dialog_text'>";b={hash:{},
data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_message",b):f.call(d,"str","k_R_goto_menu_goto_page_message",b)))+"</div>\n        <div class=\"goto_from\">\n            <input type='text' name='name' size='7' id='kindleReader_dialog_gotoPageField'>\n        </div>\n        <div id='kindleReader_dialog_gotoPage' for='kindleReader_dialog_gotoPageField'  class='kindle_dialog_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page",b):f.call(d,"str","k_R_goto_menu_goto_page",
b)))+"</div>\n    </p>\n</div>";return e});j.KindleReaderHeaderBar=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div class=\"kindleReader_kindleLogo\" />\n        <div class=\"readerControls\">\n            <div\n                id='kindleReader_button_close'\n                class='kbtn header_bar_icon'\n                title='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):f.call(d,"str","k_R_toolbar_library_button_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_close'\n            ></div>\n\n            <div\n                id='kindleReader_button_goto'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):f.call(d,"str","k_R_menuButton_goto_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_show_goto'\n            ></div>\n\n            <div\n                id='kindleReader_button_controlPanel'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):f.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_show_settings'\n            ></div>\n\n            <div\n                id='kindleReader_bookmark'\n                class='header_bar_icon disabled'\n                title='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):f.call(d,"str","k_R_menuButton_bookmark_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_bookmark'\n            ></div>\n\n            <div\n                id='kindleReader_button_note'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):f.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",
b)))+"'\n                tabindex = 1;\n                data-action='reader_show_notes'\n            ></div>\n\n            <div\n                id='kindleReader_button_sync'\n                class='header_bar_icon disabled'\n                title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync_tooltip",b):f.call(d,"str","k_R_menuButton_sync_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_sync'\n            ></div>\n        </div>\n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n            <div id='kindleReader_sitb' class='disabled'>\n                <div id='kindleReader_input_sitb'>\n                    <input id='kindleReader_input_sitb_box' type='text' tabindex = 1 />\n                    <div id='kindleReader_input_sitb_clear'></div>\n                </div>\n                <button id='kindleReader_button_sitb' class='header_bar_button' tabindex = 1 value='' data-action='reader_search'/>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j.KindleReaderImmersiveModeExit=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return"<div class='immersive_exit header'></div>\n<div class='immersive_exit footer'></div>"});j.KindleReaderLocationBar=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,b=c.helperMissing,f=this.escapeExpression;e+="<div id='kindleReader_footer' class=\"immersive_slide_area\">\n    <div id=\"kindleReader_footer_readerControls_left\">\n        <div\n            id='kindleReader_button_back'\n            tabindex = 1;\n            class='disabled'\n            title='";
g={hash:{},data:g};e+=f((a=c.str,a?a.call(d,"k_R_menuButton_back_tooltip",g):b.call(d,"str","k_R_menuButton_back_tooltip",g)))+"'\n            data-action='reader_back'\n        ></div>\n    </div>\n\n    <div id=\"kindleReader_footer_readerControls_middle\">\n\t    <div id='kindleReader_progressbar_div'></div>\n\t    <div id='kindleReader_footer_message' class='message'></div>\n        <div id='kindleReader_download_progress' class='kindleReader_footer_fading message'>\n            <span id=\"kindleReader_checkmark\"></span>\n            <span id=\"kindleReader_download_progress_message\"></span>\n        </div>\n    </div>\n\n    <div id=\"kindleReader_footer_readerControls_right\"/>\n\n    <div id='kindleReader_locationPopup_div'>\n        <div id='kindleReader_locationPopup_labelDiv' class='ui-helper-clearfix ui-corner-all'></div>\n    </div>\n</div>";
return e});j.KindleReaderPageArrow=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id=\"kindleReader_sideMargin\">\n    <div id='kindleReader_pageTurnAreaLeft' class='kindleReader_pageTurnArea'>\n        <div class='kindleReader_arrowBtn' title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_pageArrow_prev",b):f.call(d,"str","k_R_pageArrow_prev",b)))+"'></div>\n    </div>\n    <div id='kindleReader_pageTurnAreaRight' class='kindleReader_pageTurnArea'>\n        <div class='kindleReader_arrowBtn' title='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_pageArrow_next",b):f.call(d,"str","k_R_pageArrow_next",b)))+"'></div>\n    </div>\n</div>";return e});j.KindleReaderSampleEnd=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'kindle_sample_end_message\'>\n    <p id="kindle_sample_end_title_text" class="kindle_dialog_title_text"></p>\n    <p id="kindle_sample_end_message_text" class="kindle_dialog_text"> </p>\n</div>'});j.KindleReaderSettingsDialog=h(function(e,d,c,b,g){this.compilerInfo=
[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_controlPanel'>\n    <div id='kindleReader_controlPanel_preview'></div>\n    <\!-- text size --\>\n    <div id='kindleReader_controlPanel_fontSize' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_label",b):f.call(d,"str","k_R_settings_fontSize_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id=\"kindleReader_controlPanel_xSmallFont\" class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_smallFont\"  class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_mediumFont\" class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_largeFont\"  class='kindleReader_controlPanel_5button'></div>\n            <div id=\"kindleReader_controlPanel_xLargeFont\" class='kindleReader_controlPanel_5button'></div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_xSmallFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_smallFontSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_mediumFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_largeFontSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_xLargeFontSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n        </div>\n    </div>\n\n    <\!-- margins --\>\n    <div id='kindleReader_controlPanel_margin' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_margins_label",b):f.call(d,"str","k_R_settings_margins_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_xSmallMargin' class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_smallMargin'  class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_mediumMargin' class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_largeMargin'  class='kindleReader_controlPanel_5button'></div>\n            <div id='kindleReader_controlPanel_xLargeMargin' class='kindleReader_controlPanel_5button'></div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_xSmallMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_smallMarginSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_mediumMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_largeMarginSelected'  class='kindleReader_controlPanel_5selectedDot'></div>\n            <div id='kindleReader_controlPanel_xLargeMarginSelected' class='kindleReader_controlPanel_5selectedDot'></div>\n        </div>\n    </div>\n    \n    <\!-- color mode --\>\n    <div id='kindleReader_controlPanel_colorMode' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_label",b):f.call(d,"str","k_R_settings_colorMode_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_colorWhite' class='kindleReader_controlPanel_3button'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_white",b):f.call(d,"str","k_R_settings_colorMode_white",b)))+"</div>\n            <div id='kindleReader_controlPanel_colorSepia' class='kindleReader_controlPanel_3button'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_sepia",b):f.call(d,"str","k_R_settings_colorMode_sepia",b)))+"</div>\n            <div id='kindleReader_controlPanel_colorBlack' class='kindleReader_controlPanel_3button'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_black",b):f.call(d,"str","k_R_settings_colorMode_black",b)))+"</div>\n        </div>\n        <div class=\"kindleReader_controlPanel_buttonIndicators\">\n            <div id='kindleReader_controlPanel_colorWhiteSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n            <div id='kindleReader_controlPanel_colorSepiaSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n            <div id='kindleReader_controlPanel_colorBlackSelected' class='kindleReader_controlPanel_3selectedDot'></div>\n        </div>\n    </div>\n\n    <\!-- multi-column mode --\>\n    <div id='kindleReader_controlPanel_multiColumn' class=\"kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_multiColumnMode_label",b):f.call(d,"str","k_R_settings_multiColumnMode_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_columnButton_on' class='kindleReader_controlPanel_switch'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_on_button",b):f.call(d,"str","k_R_settings_column_on_button",b)))+"</div>\n            <div id='kindleReader_controlPanel_columnButton_off' class='kindleReader_controlPanel_switch'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_off_button",b):f.call(d,"str","k_R_settings_column_off_button",b)))+"</div>\n        </div>\n        <div id='kindleReader_controlPanel_optionButtons_msg' class='kindleReader_controlPanel_optionButtons_msg'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_disabled_msg",b):f.call(d,"str","k_R_settings_column_disabled_msg",b)))+"</div>\n    </div>\n\n    <\!-- show reading location mode --\>\n    <div id='kindleReader_controlPanel_showLocation' class=\"kindleReader_settings_showLocation kindleReader_settings_section\">\n        <label class='kindleReader_controlPanel_fieldLabel'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_showLocation_label",b):f.call(d,"str","k_R_settings_showLocation_label",b)))+"</label>\n        <div class=\"kindleReader_controlPanel_optionButtons\">\n            <div id='kindleReader_controlPanel_showLocationButton_on' class='kindleReader_controlPanel_switch'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_on_button",b):f.call(d,"str","k_R_settings_column_on_button",b)))+"</div>\n            <div id='kindleReader_controlPanel_showLocationButton_off' class='kindleReader_controlPanel_switch'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_off_button",b):f.call(d,"str","k_R_settings_column_off_button",b)))+"</div>\n        </div>\n    </div>\n        \n</div>";return e});j.KindleReaderSimpleSpinner=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div class="spinner">\n    <div class="bar1"></div>\n    <div class="bar2"></div>\n    <div class="bar3"></div>\n    <div class="bar4"></div>\n    <div class="bar5"></div>\n    <div class="bar6"></div>\n    <div class="bar7"></div>\n    <div class="bar8"></div>  \n    <div class="bar9"></div>      \n    <div class="bar10"></div>         \n    <div class="bar11"></div>             \n    <div class="bar12"></div>                 \n</div>'});
j.KindleReaderSitbPane=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,b=c.helperMissing,f=this.escapeExpression;e+='<div id="kindleReader_sitb_pane">\n    <div id="kindleReader_sitb_pane_header">\n        <div id="kindleReader_sitb_pane_title"></div>\n        <div id="kindleReader_sitb_pane_close_btn" class="closeButtonDark"></div>\n    </div>\n    <div id="kindleReader_sitb_pane_scrollWrapper">\n        <div id="kindleReader_sitb_pane_container" tabindex="-1"></div>\n        \n        <div id="kindleReader_sitb_message">';
g={hash:{},data:g};e+=f((a=c.str,a?a.call(d,"k_R_dialog_sitb_message_indexing",g):b.call(d,"str","k_R_dialog_sitb_message_indexing",g)))+'</div>\n    </div>\n    <div id="kindleReader_sitb_pane_beak"></div>\n</div>';return e});j.KindleReaderSitbResult=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];var e="";e+='<div class="kindleReader_sitb_result_container">\n    <div class="kindleReader_sitb_result_context_body"></div>\n    <div class="kindleReader_sitb_context_footer">\n        \n        \n        \n        <span class="kindleReader_sitb_location"></span>\n    </div>\n</div>';
return e});j.KindleReaderSitbResultCurLocMarker=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_sitb_pane_cur_loc_marker" class="kindleReader_sitb_result_container marker">\n    <div class="kindleReader_sitb_result_cur_loc_marker"></div>\n</div>'});j.KindleReaderStatusMessage=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id=\'kindleReader_statusMessage_div\' class=\'ui-helper-clearfix ui-corner-all\'>\n    <div class="spinner">\n        <div class="bar1"></div>\n        <div class="bar2"></div>\n        <div class="bar3"></div>\n        <div class="bar4"></div>\n        <div class="bar5"></div>\n        <div class="bar6"></div>\n        <div class="bar7"></div>\n        <div class="bar8"></div>  \n        <div class="bar9"></div>      \n        <div class="bar10"></div>         \n        <div class="bar11"></div>             \n        <div class="bar12"></div>                 \n    </div>                                          \n    <span id=\'kindleReader_statusMessage_text\'></span>\n</div>'});
j.KindleReaderStorageViewer=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleReader_storage_viewer" class="kindleReader_storage_viewer">\n  <div id="kindleReader_storage_viewer_panel">\n\n    <form id="kindleReader_storage_viewer_header">\n        <select name="stores" id="kindleReader_storage_viewer_stores">\n            <option selected="selected">Display table\u2026</option>\n        </select>\n\n        <div id="kindleReader_storage_viewer_query">\n            <input type="search" autocomplete="on" form="queryForm" name="kindleReader_storage_viewer_query" id="q" size="75" placeholder="Query text" />\n            <select id="kindleReader_storage_viewer_queryDB" name="queryDB" onchange="SV.runQuery(this.options[this.selectedIndex].value)">\n                <option>on</option>\n            </select>\n        </div>\n\n        <div id="kindleReader_storage_viewer_clearStorageDiv">\n            <input type="button" id="kindleReader_storage_viewer_clearStorageButton" name="clearStorageDiv" value="Clear HTML5 storage">\n        </div>\n        <div id="kindleReader_storage_viewer_close_btn" class="closeButtonDark"></div>\n    </form>\n\n    <div id="kindleReader_storage_viewer_results_section">\n        <table id="kindleReader_storage_viewer_results">\n        </table>\n    </div>\n  </div>\n</div>'});
j.KindleReaderSyncPositionDialog=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_syncPosition'>\n    <label id='kindleReader_dialog_syncPosition_title' class='kindle_dialog_title_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_title",b):f.call(d,"str","k_R_syncPosition_title",b)))+'</label>\n    <p id=\'kindleReader_dialog_syncPosition_label\' class=\'kindle_dialog_text\'></p>\n    <div class=\'button-area\'>\n        <button id="kindleReader_dialog_syncPosition_sync_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n        \t<span class="ui-button-text">';
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_sync",b):f.call(d,"str","k_R_syncPosition_sync",b)))+'</span>\n        </button>\n        <button id="kindleReader_dialog_syncPosition_reset_btn" type="button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">\n        \t<span class="ui-button-text">';b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_syncPosition_reset",b):f.call(d,"str","k_R_syncPosition_reset",b)))+"</span>\n        </button>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderButtonOverlay"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div class='reader_button_overlay'>\n    <div class='reader_button_overlay_left'>\n        <div\n            id='reader_button_overlay_library'\n            class='overlay_button'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):f.call(d,"str","k_R_toolbar_library_button_tooltip",
b)))+"'\n            tabindex = 1;\n            data-action='reader_close'\n        ></div>\n    </div>\n    <div class='reader_button_overlay_right'>\n        <div\n            id='reader_button_overlay_bookmark'\n            class='overlay_button'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_bookmark_tooltip",b):f.call(d,"str","k_R_menuButton_bookmark_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_bookmark'\n        ></div>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderFooterBar"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_footer' class=\"immersive_slide_area\">\n    <div id='readerControlsLeft' class=\"readerControls\">\n         <div\n            id='kindleReader_button_note'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks",
b):f.call(d,"str","k_R_menuButton_notesAndMarks",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks_tooltip",b):f.call(d,"str","k_R_menuButton_notesAndMarks_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_notes'>\n                <div></div>\n                <span>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_notesAndMarks",b):f.call(d,"str","k_R_menuButton_notesAndMarks",b)))+"</span>\n         </div>\n         <div\n            id='kindleReader_button_controlPanel'\n            class='header_bar_icon'\n            btnLbl='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane",b):f.call(d,"str","k_R_menuButton_controlPane",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane_tooltip",b):f.call(d,"str","k_R_menuButton_controlPane_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_settings'>\n                <div></div>\n                <span>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_controlPane",b):f.call(d,
"str","k_R_menuButton_controlPane",b)))+"</span>\n        </div>\n        <div\n            id='kindleReader_button_back'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back",b):f.call(d,"str","k_R_menuButton_back",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back_tooltip",b):f.call(d,"str","k_R_menuButton_back_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_back'>\n                <div></div>\n                <span>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_back",b):f.call(d,"str","k_R_menuButton_back",b)))+"</span>\n        </div>\n    </div>\n    <div id='readerControlsMiddle' class=\"readerControls\">\n        <div id='kindleReader_progressbar_div'></div>\n        <div id='kindleReader_footer_message' class='kindleReader_footer_fading message'></div>\n        <div id='kindleReader_download_progress' class='kindleReader_footer_fading message'>\n            <span id=\"kindleReader_checkmark\"></span>\n            <span id=\"kindleReader_download_progress_message\"></span>\n        </div>\n    \n        <div id='kindleReader_locationPopup_div'>\n            <div id='kindleReader_locationPopup_labelDiv' class='ui-helper-clearfix ui-corner-all'></div>\n        </div>\n    </div>\n    <div id='readerControlsRight' class=\"readerControls\">\n        <div\n            id='kindleReader_button_goto'\n            class='header_bar_icon'\n            btnLbl='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto",b):f.call(d,"str","k_R_menuButton_goto",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto_tooltip",b):f.call(d,"str","k_R_menuButton_goto_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_show_goto'>\n                <div></div>\n                <span>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_goto",b):f.call(d,"str","k_R_menuButton_goto",b)))+
"</span>\n        </div>\n        <div\n            id='kindleReader_button_sync'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync",b):f.call(d,"str","k_R_menuButton_sync",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync_tooltip",b):f.call(d,"str","k_R_menuButton_sync_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_sync'>\n                <div></div>\n                <span>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_sync",b):f.call(d,"str","k_R_menuButton_sync",b)))+"</span>\n        </div>\n        <div\n            id='kindleReader_button_pin_start_metro'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro",b):f.call(d,"str","k_R_menuButton_pin_start_metro",b)))+"'\n            title='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro_tooltip",
b):f.call(d,"str","k_R_menuButton_pin_start_metro_tooltip",b)))+"'\n            tabindex = 1;\n            data-action='reader_pin_metro'>\n                <div></div>\n                <span>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_menuButton_pin_start_metro",b):f.call(d,"str","k_R_menuButton_pin_start_metro",b)))+"</span>\n        </div>\n    </div>\n</div>";return e});j["Metro/KindleMetroReaderHeaderBar"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=
g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_header' class='immersive_slide_area'>\n    <div id='kindleReader_header_left'>\n        <div id='readerControlsLeft' class='readerControls'>\n            <div\n                id='kindleReader_button_library'\n                class='header_bar_icon'\n                btnLbl='";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button",b):f.call(d,"str","k_R_toolbar_library_button",b)))+"'\n                title='";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_toolbar_library_button_tooltip",b):f.call(d,"str","k_R_toolbar_library_button_tooltip",b)))+"'\n                tabindex = 1;\n                data-action='reader_close_appbar'>\n                <div></div>\n            </div>      \n        </div>\n    </div>\n    <div id='kindleReader_header_middle'>\n        <div id='kindleReader_header_bar_title_author' class='kindleReader_header_bar_title_author'>\n            <div id='kindleReader_header_bar_title' class='kindleReader_header_bar_title'></div>\n            <div id='kindleReader_header_bar_author' class='kindleReader_header_bar_author'></div>\n        </div>  \n    </div>\n    <div id='kindleReader_header_right'>\n        <div id='readerControlsRight' class='readerControls'>\n           <div id='searchArea' class='disabled'>\n                <input id='kindleReader_search_field' type='text'/>\n                <div id='kindleReader_search_submit' class='header_bar_button' type='button' value='' data-action='reader_search'>\n                    <div></div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>";
return e});j["Metro/KindleMetroReaderViewSettings"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_viewSettings'>\n    <div id='kindleReader_viewSettings_title' class='kindleReader_settings_title_section'>\n        <label class='kindleReader_viewSettings_titleLabel'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_title_metro",b):f.call(d,"str","k_R_settings_title_metro",b)))+
"</label>\n    </div>\n\n    <\!-- Font Size --\>\n    <div id='kindleReader_viewSettings_fontSize' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_label_metro",b):f.call(d,"str","k_R_settings_fontSize_label_metro",b)))+"</label>\n        <div id=\"kindleReader_viewSettings_slider_tooltip_wrapper\">\n            <\!-- This wrapper div helps to align the tooltip to the bottom of the wrapper, otherwise it align to the top --\>\n            <span id='kindleReader_viewSettings_fontSize_slider_tooltip' class='kindleReader_viewSettings_slider_tooltip'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_fontSize_tooltip_metro",b):f.call(d,"str","k_R_settings_fontSize_tooltip_metro",b)))+"</span>\n        </div>\n        <input tabindex=10 id='kindleReader_viewSettings_fontSize_slider' class='kindleReader_viewSettings_slider' type='range' step='1' min='0' max='4'/>\n    </div>\n\n    <\!-- margins --\>\n    <div id='kindleReader_viewSettings_margin' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_margins_label_metro",b):f.call(d,"str","k_R_settings_margins_label_metro",b)))+"</label>\n        <input tabindex=20 id='kindleReader_viewSettings_margin_slider' class='kindleReader_viewSettings_slider' type='range' step='1' min='0' max='4'/>\n    </div>\n    \n    <\!-- color mode --\>\n    <div id='kindleReader_viewSettings_colorMode' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b=
{hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_label_metro",b):f.call(d,"str","k_R_settings_colorMode_label_metro",b)))+"</label>\n        <div class='kindleReader_viewSettings_controls'>\n            <div id=\"kindleReader_viewSettings_optionButtons\">\n                <div tabindex=30 id='kindleReader_viewSettings_colorWhite' class='kindleReader_viewSettings_3button'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_white",b):f.call(d,"str","k_R_settings_colorMode_white",
b)))+"</div>\n                <div tabindex=40 id='kindleReader_viewSettings_colorSepia' class='kindleReader_viewSettings_3button'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_sepia",b):f.call(d,"str","k_R_settings_colorMode_sepia",b)))+"</div>\n                <div tabindex=50 id='kindleReader_viewSettings_colorBlack' class='kindleReader_viewSettings_3button'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_colorMode_black",b):f.call(d,"str","k_R_settings_colorMode_black",
b)))+"</div>\n            </div>\n        </div>\n    </div>\n\n    <\!-- multi-column mode --\>\n    <div id='kindleReader_viewSettings_multiColumn' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_multiColumnMode_label_metro",b):f.call(d,"str","k_R_settings_multiColumnMode_label_metro",b)))+'</label>\n        <div class=\'kindleReader_viewSettings_controls\'>\n            <div id=\'kindleReader_viewSettings_column_toggle_wrapper\'>\n                <div id=\'kindleReader_viewSettings_column_toggle_label\' class=\'kindleReader_viewSettings_control_label\'></div>\n                <div class="onoffswitch">\n                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="kindleReader_viewSettings_column_toggle" checked>\n                    <label tabindex=60 id="kindleReader_viewSettings_column_toggle_switch" class="onoffswitch-label" for="kindleReader_viewSettings_column_toggle">\n                        <div class="onoffswitch-inner"></div>\n                        <div class="onoffswitch-switch"></div>\n                    </label>\n                </div>\n            </div>\n            <div id=\'kindleReader_viewSettings_optionButtons_msg\' class=\'kindleReader_controlPanel_optionButtons_msg\'>';
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_column_disabled_msg",b):f.call(d,"str","k_R_settings_column_disabled_msg",b)))+"</div>\n        </div>\n    </div>\n\n    <\!-- show reading location mode --\>\n    <div id='kindleReader_viewSettings_showLocation' class='kindleReader_settings_section'>\n        <label class='kindleReader_viewSettings_fieldLabel'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_settings_showLocation_label_metro",b):f.call(d,"str","k_R_settings_showLocation_label_metro",
b)))+'</label>\n        <div class=\'kindleReader_viewSettings_controls\'>\n            <div id=\'kindleReader_viewSettings_showLocation_toggle_wrapper\'>\n                <div id=\'kindleReader_viewSettings_showLocation_toggle_label\' class=\'kindleReader_viewSettings_control_label\'></div>\n                <div class="onoffswitch">\n                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="kindleReader_viewSettings_showLocation_toggle" checked>\n                    <label tabindex=60 id="kindleReader_viewSettings_showLocation_toggle_switch" class="onoffswitch-label" for="kindleReader_viewSettings_showLocation_toggle">\n                        <div class="onoffswitch-inner"></div>\n                        <div class="onoffswitch-switch"></div>\n                    </label>\n                </div>\n            </div>\n        </div>\n    </div>\n        \n\n</div>';
return e});j["Metro/KindleReaderGoToDialog"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto' xmlns=\"http://www.w3.org/1999/html\" xmlns=\"http://www.w3.org/1999/html\">\n    <div class=\"goto_titleDiv\">\n        <label id='kindleReader_dialog_gotoTitle' class='kindle_dialog_title_text'>";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_location_metro_title",
b):f.call(d,"str","k_R_goto_menu_goto_location_metro_title",b)))+"</label>\n    </div>\n    <br>\n    <div class=\"goto_from\">\n        <input type='text' name='name' id='kindleReader_dialog_gotoField'>\n        <button id=\"kindle_reader_goto_location_button\">";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_button",b):f.call(d,"str","k_R_goto_menu_goto_button",b)))+'</button>\n        <button id="kindle_reader_cancel_goto_location_button">';b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,
"k_common_cancel_button",b):f.call(d,"str","k_common_cancel_button",b)))+"</button>\n    </div>\n    <br>\n    <div class=\"dialogErrorText\" id=\"kindleReader_dialog_gotoError\">\n        <label id='kindleReader_dialog_gotoErrorText' class='kindle_dialog_title_text'></label>\n    </div>\n</div>";return e});j["Metro/KindleReaderGoToPageDialog"]=h(function(e,d,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||e.helpers,g=g||{},e="",a,f=c.helperMissing,k=this.escapeExpression;e+="<div id='kindleReader_dialog_goto_page' xmlns=\"http://www.w3.org/1999/html\" xmlns=\"http://www.w3.org/1999/html\">\n    <div class=\"goto_titleDiv\">\n        <label id='kindleReader_dialog_gotoPageTitle' class='kindle_dialog_title_text'>";
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_title_metro",b):f.call(d,"str","k_R_goto_menu_goto_page_title_metro",b)))+"</label>\n    </div>\n    <br>\n    <div class=\"goto_from\">\n        <input type='text' name='name' id='kindleReader_dialog_gotoPageField'>\n        <button id=\"kindle_reader_goto_page_button\">";b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_R_goto_menu_goto_page_button",b):f.call(d,"str","k_R_goto_menu_goto_page_button",b)))+'</button>\n        <button id="kindle_reader_cancel_goto_page_button">';
b={hash:{},data:g};e+=k((a=c.str,a?a.call(d,"k_common_cancel_button",b):f.call(d,"str","k_common_cancel_button",b)))+"</button>\n    </div>\n    <br>\n    <div class=\"dialogErrorText\" id=\"kindleReader_dialog_gotoPageError\">\n        <label id='kindleReader_dialog_gotoPageErrorText' class='kindle_dialog_title_text'></label>\n    </div>\n</div>";return e});j.ReaderImmersiveModeIcon=h(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return"<div class='immersive_icon_tap_target' data-action=\"immersive_icon\"><div id='immersive_icon'></div></div>"})})();
var BookChunk=function(){var h=Object.freeze?function(c){return Object.freeze(c)}:function(c){return c},j=["fragment","glyph","skeleton","resource","locationMap"],e={};j.forEach(function(c){e[c]={}});e.resource.huge=!0;var d={types:h(j),properties:h(e),getId:function(c){if(c.fragmentMetadata!==void 0)return c.fragmentMetadata.id;else if(c.skeletonMetadata!==void 0)return c.skeletonMetadata.id;else if(c.glyphFragmentMetadata!==void 0)return c.glyphFragmentMetadata.id;else if(c.metadata!==void 0)return c.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};j.forEach(function(c){d[c.toUpperCase()+"_TYPE"]=c});return h(d)}(),BookDownloadController=function(){return{create:function(h){function j(){function a(b){if(k[b].waiting)return k[b].waiting=!1,k[b].downloading=!0,k[b].start(),!0}var b=!1,c=!1,g=!1;BookChunk.types.forEach(function(a){b=b||k[a].downloading;g=g||k[a].waiting});l.forEach(function(a){b=b||k[a].downloading;c=c||k[a].waiting});g?BookChunk.types.some(a):!b&&
!c?(KindleDebug.log("done downloading"),f.resolve()):!b&&c&&l.some(a)}function e(a,b){var f=new $.Deferred;if(k[a].remaining<=0)return c(a),f.resolve();var e=h.downloaders[a];e.addEventListener("onProgress",d);e.addEventListener("onCompleted",function(a){c(a);f.resolve()});e.addEventListener("onFailed",function(a,b,c){k[a].waiting=!1;g(b,c);f.reject()});e.start(b,h.fast);k[a].remaining=e.getNumIds();m=m-b+e.getNumIds();return f.promise()}function d(a,b){if(b!==k[a].remaining){k[a].remaining=b;var c=
0;BookChunk.types.forEach(function(a){c+=k[a].remaining});l.forEach(function(a){c+=k[a].remaining});f.notify(c,m)}}function c(a){k[a].downloading=!1;k[a].waiting=!1;j()}function b(b){function c(){KindleDebug.log("Finished downloading sidecar: "+b);k[g].downloading=!1;d(g,0);j()}function f(a){KindleDebug.error("Error downloading sidecar '"+b+"': "+a);k[g].downloading=!1;d(g,0);j()}var g="SC:"+b;l.push(g);k[g]={downloading:!1,waiting:!0,remaining:a};k[g].start=function(){KindleDebug.log("Downloading sidecar: "+
b);h.sidecarManager.download(b).then(c,f)}}function g(a,b){a=a||Kindle.ERROR.CANCELLED;BookChunk.types.forEach(function(a){if(k[a].downloading)h.downloaders[a].cancel(),k[a].downloading=!1});f.reject(a,b)}var a=10,f=$.Deferred(),k={},m=0,l=[];BookChunk.types.forEach(function(a){k[a]={downloading:!1,waiting:!1,remaining:0}});return{startDownload:function(){var c=h.downloadingContentProvider;$.when(c.getBookinfo(),c.computeCacheQuota(),KindleModuleManager.getModule(Kindle.MODULE.SidecarManager)).done(function(c){var g=
c.context.cacheState||c.cacheState;if(g===Kindle.BookInfo.CachedState.CACHED||g===Kindle.BookInfo.CachedState.PINNED)f.resolve();else{var d={skeleton:(Number(c.fragmap.fragmentMetadata.numberOfSkeletons)||1)-1,fragment:Number(c.fragmap.fragmentMetadata.numberOfFragments)-1,glyph:(Number(c.metadata.numOfGlyphFragments)||0)-1,resource:c.manifest&&c.manifest.resourceManifest?Number(Math.max.apply(Math,Object.keys(c.manifest.resourceManifest))):-1,locationMap:c.metadata.locationsInfo&&c.metadata.locationsInfo.numOfLocations?
Math.floor((Number(c.metadata.locationsInfo.numOfLocations)-1)/Number(c.metadata.locationsInfo.mapSize)):-1};BookChunk.types.forEach(function(a){k[a].waiting=!0;k[a].remaining=d[a]+1;k[a].start=function(){e(a,d[a])};m+=d[a]});m+=Object.keys(h.sidecarManager.names).length*a;Object.keys(h.sidecarManager.names).forEach(b);j()}})},failDownload:g,cancelDownload:g,pauseDownload:function(){BookChunk.types.forEach(function(a){k[a].downloading&&h.downloaders[a].pause()})},resumeDownload:function(){BookChunk.types.forEach(function(a){k[a].downloading&&
h.downloaders[a].resume()})},whenDownloadComplete:function(){return f.promise()}}}}}();
function KindleBookDownloaderFactory(h){var j=5E3,e=0,d=1E3,c=$.Deferred().resolve(),b={};h.downloader=b;b.type=h.type;b.cache=h.cache;b.throttle=h.throttle;b.readAheadActive=!1;b.readAheadPauseCount=0;b.dbPutter=h.dbPutter;b.dbGetIdList=h.dbGetIdList;b.dbOosHandler=h.dbOosHandler;b.dbCheckCache=h.dbCheckCache;b.dbIsCached=h.dbIsCached;b.dbIsOos=h.dbIsOos;b.netGetter=h.netGetter;b.urlGetter=h.urlGetter;b.fileGetter=h.fileGetter;b.fileProgress=h.fileProgress;b.downloadError=h.downloadError;b.isIdRequired=
h.isIdRequired||function(){return!0};b.numIds=0;b.pauseReadAhead=function(){this.readAheadPauseCount++};b.resumeReadAhead=function(){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount)};b.setNextId=function(b){if(b!==void 0&&this.readAheadActive)this.nextReadAheadId=b};b.removeIdFromReadAhead=function(b){if(this.readAheadActive){var a;for(a=0;a<this.readAheadIds.length;a++)if(this.readAheadIds[a]===b){this.readAheadIds.splice(a,1);break}for(a=0;a<this.readAheadUrls.length;a++)if(this.readAheadUrls[a].id===
b){this.readAheadUrls.splice(a,1);break}}};b.readAheadOne=function(b){function a(){return!l.readAheadActive||l.readAheadGeneration!==b?!1:!0}function f(){a()&&(l.numReadAheadNetRequests--,l.readAheadUrls.length===0?l.numReadAheadNetRequests===0&&setTimeout(function(){l.getReadAheadUrls(b)},l.interReadWait):setTimeout(function(){l.readAheadOne(b)},l.interReadWait))}function d(b,c){if(a()){if(c==="timeout")l.numReadAhead>1&&l.numReadAhead--;else if(c==="error"&&KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()===
!1){l.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.OFFLINE);l.readAheadActive=!1;return}f()}}function e(b){function g(){a()&&(l.readAheadRemaining--,l.fileProgress(l.readAheadRemaining),f())}function d(b){function k(){l.readAheadActive&&(KindleHostDeviceDetector.isIE()||l.dbPutter(m,g,e),g());c.resolve()}function e(){if(l.readAheadActive)l.readAheadActive=!1,l.dbIsOos();c.reject()}a()&&(b=b||{},!(b.code===Kindle.DB.CONSTRAINT_ERR||b.message==="constraint failed")&&b.code===Kindle.DB.QUOTA_ERR?
c.state()==="pending"?c.then(k):(c=new $.Deferred,l.dbCheckCache(),l.dbOosHandler(k,e)):f())}if(a()){var k=BookChunk.getId(b),m=[];m[k]=b;$.when(c).then(function(){l.dbPutter(m,g,d)})}}var l=this;if(a())if(l.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){l.readAheadOne(b)},l.startReadWait);else if(l.readAheadUrls.length===0&&l.numReadAheadNetRequests===0)l.getReadAheadUrls(b);else for(;l.numReadAheadNetRequests<l.numReadAhead&&l.readAheadUrls.length>0;){l.numReadAheadNetRequests++;
var h=l.readAheadUrls.shift();l.fileGetter(h,e,d)}};b.getReadAheadUrls=function(b){function a(a){d.readAheadUrls=a;setTimeout(function(){d.readAheadActive&&d.readAheadOne(b)},d.interReadWait)}function c(){d.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.NO_URL)}var d=this;if(b===this.readAheadGeneration&&this.readAheadActive)if(d.dbCheckCache()){d.readAheadStillAlive++;for(var e=[],l=0;l<d.readAheadIds.length&&d.readAheadIds[l]<d.nextReadAheadId;)l++;l===d.readAheadIds.length&&(l=0);e=d.readAheadIds.splice(l,
d.numReadAheadUrls);e.length===0?d.refreshReadAheadList(b):(d.nextReadAheadId=l<d.readAheadIds.length?d.readAheadIds[l]:0,d.urlGetter(e,a,c))}else d.readAheadActive=!1};b.refreshReadAheadList=function(c){function a(a){function f(){d.readAheadActive&&d.getReadAheadUrls(c)}if(d.readAheadActive){var h=e.createSubTimer("success");d.readAheadStillAlive++;var n,r=[];for(n in a)r[a[n]]=!0;d.readAheadIds=[];for(n=0;n<=d.maxReadAheadId;n++)!r[n]&&b.isIdRequired(n)&&d.readAheadIds.push(n);h.addCount("needed",
d.readAheadIds.length);h.addCount("total",d.maxReadAheadId+1);h.endTimer();e.endTimer();e.log();if(d.readAheadIds.length>0){if(d.readAheadRemaining=d.readAheadIds.length,d.readAheadRemaining!==d.readAheadRemainingPrev)d.readAheadRemainingPrev=d.readAheadRemaining,setTimeout(f,d.startReadWait)}else d.readAheadActive=!1,d.dbIsCached()}}function f(){e.endTimer();d.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var d=this;if(c===this.readAheadGeneration){var e;this.readAheadActive&&(e=KindleMetricsProfiler("bookDownloader.getIdList"),
this.dbGetIdList(a,f))}};b.readAheadWatchdog=function(){var b=this;if(this.readAheadActive){if(this.readAheadStillAlive===0&&(this.readAheadPauseCount===0||this.readAheadGeneration===0))this.readAheadGeneration++,this.readAheadRemaining<this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=3E4,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?
(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){b.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};b.startReadAhead=function(c,a){var f=this,k=j;if(this.cache){this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=c;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.watchDogTimeout=3E4;
for(var m=this.numIds=0;m<=c;m++)b.isIdRequired(m)&&this.numIds++;this.readAheadRemaining=this.numIds+1;this.readAheadRemainingPrev=this.readAheadRemaining+1;this.generationReadAheadRemaining=this.numIds+2;a?(this.startReadWait=this.interReadWait=k=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=j,this.interReadWait=e,this.startReadWait=d,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);if(this.throttle)this.numReadAhead=1,this.numReadAheadUrls=5;this.debugCounter=
15;setTimeout(function(){f.readAheadWatchdog()},k)}else this.readAheadActive=!1};b.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};b.setReadAheadTimersForTestMode=function(){d=e=j=0};return b}
function KindleReaderBookInfoProviderFactory(){var h="book_context",j="book_metaData",e="book_manifest",d="book_key",c="book_fragmap",b="book_ok_to_download",g="book_skeleton_builder",a="book_resource_urls";return{BookInfo:function(f,k){function m(a,b){na&&na(b-a,b)}function l(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(J).then(function(b){C.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:J,coverData:b}).then(a.resolve,a.reject)},
a.reject);return a.promise()}function o(a){function b(){var c=C.getModuleSync(h);v.updateBookinfo({cacheState:a,context:c}).then(f.resolve,f.reject)}function c(){f.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.CACHED_STATE)}var f=new jQuery.Deferred;G().done(function(){var g;C.isModuleInitialized(h)?(g=C.getModuleSync(h),g.isSample?b():(g={asin:J,kindleSessionId:g.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},C.getModuleSync(C.SERVICE_CLIENT).setOfflineStatus(g).then(b,c))):f.reject()});
return f.promise()}function q(){fa&&(fa.endTimer(),fa.log(),fa=null);var a=Q!==ha&&Q!==Kindle.BookInfo.CachedState.PINNED?o(ha):!0;$.when(a).then(function(){l().then(ba.resolve,ba.resolve)},function(a){a===Kindle.ERROR.NETWORK?ba.reject(a,Kindle.ERROR_CODE.CACHED_STATE):ba.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});v.getBookStatistics().then(function(a){K&&(a.fragments!==void 0&&(E.increaseSubCounter(K,"fragmentCount",a.fragments.count),E.increaseSubCounter(K,"fragmentsSize",a.fragments.size)),a.glyphs!==
void 0&&(E.increaseSubCounter(K,"glyphCount",a.glyphs.count),E.increaseSubCounter(K,"glyphsSize",a.glyphs.size)),E.endMetrics(K))},function(){K&&E.endMetrics(K)})}function n(){function a(){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);q()}function b(a){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);ba.reject(a)}function c(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&
(a.stalled?D.downloadController.pauseDownload():D.downloadController.resumeDownload())}D.downloadController?(KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c),D.downloadController.startDownload(),D.downloadController.whenDownloadComplete().then(a,b,[m,ba.progress])):ia?b():ba.reject(Kindle.CACHING.DISABLED)}function r(){if(!C.isModuleRegistered(c)){E.startSubTimer(Z,"getFragMap");var a=B.getFragmap();a.done(function(){E.endSubTimer(Z,"getFragMap")});
C.registerModuleWithDeferred(c,a)}return C.getModule(c)}function s(a){var b;a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),Y=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,b,256),KindleCompression.lzAddNumbersToDictionary(b,256),W=KindleCompression.lzGetDecompressionDictionary(b))}function t(){function a(b){B.getMetadata().then(function(a){E.endSubTimer(Z,
"getMetadata");s(a);b.resolve(a)},b.reject)}C.isModuleRegistered(j)||(E.startSubTimer(Z,"getMetadata"),C.registerModuleWithInitializer(j,a));return C.getModule(j)}function u(){if(!C.isModuleRegistered(e)){E.startSubTimer(Z,"getManifest");var a=B.getManifest();a.done(function(){E.endSubTimer(Z,"getManifest")});C.registerModuleWithDeferred(e,a)}return C.getModule(e)}function z(){var a,b;b={resource:{isIdRequired:function(b){return b in a}}};var c={bookinfo:H,moduleManager:C,contentCache:v,kcrFree:f.kcrFree};
L=C.getModuleSync(Kindle.MODULE.SidecarManager).create(c);B=NetworkContentProvider.create({context:C.getModuleSync(h),asin:J});u().done(function(b){a=b.resourceManifest||{}});ia?(b={asin:J,source:B,cache:v,tweaks:b,readAheadAgressively:ma,sidecarManager:L},D=I=DownloadingContentProvider.create(b),window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(E.emit([{name:x.ENABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):
(D=B,window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(E.emit([{name:x.DISABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED)));w();y()}function w(){function a(b){C.getModuleList([j,e]).done(function(a){a=KindleBookSkeletonBuilderFactory(D[BookChunk.SKELETON_TYPE],D[BookChunk.RESOURCE_TYPE],a[e],Y);E.endSubTimer(Z,"getSkeletonBuilder");b.resolve(a)}).fail(b.fail)}C.isModuleRegistered(g)||(E.startSubTimer(Z,
"getSkeletonBuilder"),C.registerModuleWithInitializer(g,a))}function y(){function b(a){C.getModule(e).done(function(b){b=KindleBookResourceUrlTranslator(D[BookChunk.RESOURCE_TYPE],b);E.endSubTimer(Z,"getResourceUrlTranslator");a.resolve(b)}).fail(a.fail)}C.isModuleRegistered(a)||(E.startSubTimer(Z,"getResourceUrlTranslator"),C.registerModuleWithInitializer(a,b))}function G(){function a(b){var f=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){Q=b.cacheState;if(Q===Kindle.BookInfo.CachedState.PINNING)ha=
Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(Q)&&C.registerModule(d,!0)}b.context!==void 0&&C.registerModule(h,b.context);b.metadata!==void 0&&(s(b.metadata),C.registerModule(j,b.metadata));b.manifest!==void 0?C.registerModule(e,b.manifest):C.registerModule(e,{});b.fragmap!==void 0&&C.registerModule(c,b.fragmap);T.resolve(f)}function b(a){function c(){window.location.reload(!0)}a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&E.emit("App::DatabaseGoneOnGetBookInfo",
{breakdown:["Browser"]}).then(c,c);T.resolve()}if(!T){T=new jQuery.Deferred;if(f.contentProvider)v=f.contentProvider;else{var g=C.getModuleSync(C.DB_CLIENT);g.getBookDb()&&(g=g.getBookDb().BookInfoDB(J),v=DatabaseContentCache.create({bookinfoDb:g,asin:J}))}v?v.queryBookinfo().then(a,b):(ia=!1,b())}return T.promise()}function F(){K=E.startMetrics("BookDownload::Reading",{breakdown:["Browser"]});C.getModuleList([h,j,e,c,b]).done(function(a){var b=$.extend({},a[h]);delete b.kindleSessionId;a={metadata:a[j],
manifest:a[e],fragmap:a[c],context:b,cacheState:pa};ia?(I.putBookinfo(a),window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(E.emit([{name:x.ENABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):window.localStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(E.emit([{name:x.DISABLED,params:{breakdown:["Browser"]}}]),window.localStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED))})}
function A(k){function m(b){var f,k=new jQuery.Deferred,l=E.createTimer();if(b)Q=Kindle.BookInfo.CachedState.PARTIAL,f=Kindle.ERROR.FORCE_DELETE;else if(Q===Kindle.BookInfo.CachedState.PINNED)pa=Q=Kindle.BookInfo.CachedState.PINNING,ha=Kindle.BookInfo.CachedState.PINNED,f=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(Q===Kindle.BookInfo.CachedState.CACHED)Q=Kindle.BookInfo.CachedState.PARTIAL,f=Kindle.ERROR.CONTENT_UPGRADE;(v?v.deleteBooksData():$.Deferred().resolve()).fail(k.reject).done(function(){C.detachModule(d);
C.detachModule(c);C.detachModule(j);C.detachModule(e);C.detachModule(h);C.detachModule(g);C.detachModule(a);y=null;l.emit(b?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");k.resolve(f)});return k.promise()}function l(a){function g(){var k;if(a.downloadRestrictionReason)ea=a.downloadRestrictionReason.reasonCode,sa=a,M.reject(H);else{k=s.createSubTimer("finishStartReading");f.contentProvider&&f.contentProvider.initMetadata({version:a.contentVersion,acr:a.formatVersion});if(C.isModuleInitialized(h)){var m=
C.getModuleSync(h),l=!1;if(m.contentVersion===a.contentVersion&&m.lastPageReadData&&a.lastPageReadData&&m.lastPageReadData.position!==a.lastPageReadData.position)m.lastPageReadData=a.lastPageReadData,l=!0;if(m.isOwned===void 0)m.isOwned=a.isOwned!==void 0?a.isOwned:!0,l=!0;if(m.contentType===void 0)m.contentType=a.contentType||(m.isSample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK),l=!0;l&&v.updateBookinfo({context:m});m.kindleSessionId=a.kindleSessionId;sa=m}else sa=a,C.registerModule(h,a);
if(a.contentType===Kindle.CONTENT_TYPE.EBSP)!O&&!a.isOwned&&(ia=!1,v=null),C.isModuleInitialized(d)||C.registerModule(d,!0);else if(f.isSample){k.endTimer();s.endTimer();s.log();ea=Kindle.ERROR.UNKNOWN_ERR;M.reject(H);return}a.contentChecksum&&!C.isModuleInitialized(d)&&C.registerModule(d,a.contentChecksum);y||(z(),F());$.when(t(),u(),r()).done(function(){k.endTimer();k=s.createSubTimer("resolve");M.resolve(H);k.endTimer();s.endTimer();s.log()}).fail(function(){ea=Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
M.reject(H)});L.getPageNumbers().done(function(a){a&&(S=a,S.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(S))});C.getModuleList([h,j,e,c,b]).done(n).fail(ba.reject)}}ja=!0;A.endTimer();E.endSubTimer(Z,"StartReading");var k=y&&a.contentVersion&&a.contentVersion!==y.context.contentVersion,o=y&&a.formatVersion&&a.formatVersion!==y.context.formatVersion,q=a.downloadRestrictionReason&&a.downloadRestrictionReason.reasonCode,q=q===Kindle.ERROR.CONTENT_LOAN_ENDED||
q===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;N=k||o;k||o||q?m(q).then(g,function(a){ea=a;M.reject(H)}):g()}function o(a){ja=!1;E.endSubTimer(Z,"StartReading");y?(sa=y.context,M.resolve(H)):(ea=a,M.reject(H));Kindle.BookInfo.CachedState.isFullyDownloaded(Q)?(L.getPageNumbers().done(function(a){a&&(S=a,S.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(S))}),ba.resolve()):ba.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.START_READING)}function q(a){w.endTimer();
y=a;E.endSubTimer(Z,"CheckDB");E.startMetrics("Reader::StartReading");A=s.createSubTimer("startReading");a=$.extend({asin:J},f);if(y&&y.context&&Q===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=y.context.kindleSessionId;E.startSubTimer(Z,"StartReading");x=ra(a);y&&z();x.then(l,o)}var y,s,w,A,x;ba=new jQuery.Deferred;Z=k;s=KindleMetricsProfiler("bookInfo.startReading");w=s.createSubTimer("getInfoFromDB");E.startSubTimer(Z,"CheckDB");if(f.kcrFree==="only")f.isSample=!0;f.isSample&&!O?(ia=!1,
q(null)):G().done(q);return M.promise()}var x={DISABLED:"Book::Caching::Disabled",ENABLED:"Book::Caching::Enabled"},B=null,v=null,I=null,L=null,D=null,K,M=$.Deferred(),H,J=f.asin,O=f.cacheSample,C=k||KindleModuleManager,E=C.getModuleSync(C.METRICS_MANAGER),N,P=null,S=null,T=null,Q=null,Y=null,W=null,ia=!0,ba=null,na=null,ha=Kindle.BookInfo.CachedState.CACHED,ma=!1,pa=Kindle.BookInfo.CachedState.PARTIAL,fa=null,Z=null,ja,ea,sa,ra=function(a){var b=new jQuery.Deferred;C.getModuleSync(C.SERVICE_CLIENT).startReading(a).pipe(function(b){var c=
b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,f=[Kindle.ERROR.CONTENT_LOANED,Kindle.ERROR.CONTENT_LOAN_ENDED,Kindle.ERROR.CONTENT_LICENSE_EXCEEDED,Kindle.ERROR.CONTENT_RENTAL_EXPIRED,Kindle.ERROR.SESSION_LIMIT_EXCEEDED];return a.kcrFree&&b&&b.contentType!==Kindle.CONTENT_TYPE.EBSP&&f.indexOf(c)>=0?(a.isSample=!0,C.getModuleSync(C.SERVICE_CLIENT).startReading(a)):b}).pipe(function(c){if(f.basePath)c.basePath=f.basePath;if(f.useNewPath)c.useNewPath=f.useNewPath;if(f.useProdBucket)c.useProdBucket=
f.useProdBucket;var g=c.isSample||!1;if(c.isOwned===void 0)c.isOwned=!g;if(c.contentType===void 0)c.contentType=g?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK;if(a.kcrFree)c.kcrFree=!0;b.resolve(c)},function(){b.reject("timeout")});return b.promise()};return H={getBookInfoDfd:function(){return M.promise()},getAsin:function(){return J},getRefEmId:function(){var a=C.getModuleSync(j);return a.refEmId||a.referenceEmbeddedId||a.guid},isOpenedOnline:function(){return ja},getOpenError:function(){return ea},
getContext:function(){return sa},startReading:function(a,c){C.registerModuleWithDeferred(b,c);return A(a)},doneReading:function(){D.close()},getImageBaseUrl:function(){return C.getModuleSync(h).imageBaseUrl+"/"},getKindleSessionId:function(){return C.getModuleSync(h).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){C.getModule(c).then(a,b)},15)},getBookType:function(){return C.getModuleSync(c).fragmentMetadata.bookType},getBookSkeleton:function(a,b,c){C.getModule(g).then(function(f){f.buildSkeleton(c).then(a,
b)},b)},getBookFragments:function(a,b,c){D[BookChunk.FRAGMENT_TYPE].getChunks(c,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,Y);if(b.paraData!==void 0&&typeof b.paraData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.paraData,W,256);b.paraData=JSON.parse(c)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,c){D[BookChunk.GLYPH_TYPE].getChunks(c,
function(b){if(b.glyphFragmentMetadata.compression===1||typeof b.glyphData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,W,256);b.glyphData=JSON.parse(c);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return C.getModule(j).then(a,b)},getResourceUrls:function(b,c,f){C.getModule(a).then(function(a){a.getResourceUrls(f,b,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return C.getModuleSync(h).lastPageReadData||{}},getLocationConverter:function(){function a(b){var c=
jQuery.Deferred();D[BookChunk.LOCATIONMAP_TYPE].getChunks([b],c.resolve,c.reject);return c}if(P===null){var b={},f=C.getModuleSync(c),g=C.getModuleSync(j);b.locationsInfo=g.locationsInfo;b.minPosition=f.fragmentArray[0].cPos;b.maxPosition=f.fragmentArray[f.fragmentArray.length-1].ePos;b.mapGetter=a;P=KindleUserLocationConverter.getLocationConverter(f.fragmentMetadata.bookType,b)}return P},getPageNumberConverter:function(){return S},hasCover:function(a,b){var c=$.Deferred();C.getModuleSync(h).manifestUrl?
C.getModule(e).then(function(a){a=a.coverResource;c.resolve(a!==void 0&&a!==null)},c.reject):c.resolve(!1);return c.promise().then(a,b)},getCoverUrl:function(a,b){var c=$.Deferred();C.getModuleSync(h).manifestUrl?C.getModule(e).then(function(a){a=a.coverResource;a!==void 0&&a!==null&&D[BookChunk.RESOURCE_TYPE].getChunks(a,function(a){c.resolve(a.data)},c.reject)},c.reject):c.resolve(null);return c.promise().then(a,b)},getCachedAnnotations:function(){return!v?$.Deferred().reject():v.getAnnotations()},
cacheAnnotations:function(a){return!v?$.Deferred().reject():v.putAnnotations(a)},getCachedPageNumbers:function(){return!v?$.Deferred().reject():v.getPageNumbers()},cachePageNumbers:function(a){return!v?$.Deferred().reject():v.putPageNumbers(a)},getBookPositions:function(){var a=new jQuery.Deferred;C.getModule(j).then(function(b){var c=KindleModuleManager.getModuleSync(h);a.resolve({toc:b.positions.toc,srl:c.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},getSearchIndex:function(){return L.getSearchIndex()},
startDownloading:function(a,c){[Kindle.MODULE.SidecarManager,Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager].forEach(function(a){C.isModuleRegistered(a)||(KindleDebug.log("Copying registration of "+a),C.registerModule(a,KindleModuleManager.getModuleSync(a)))});KindleReaderAnnotationManager.clear();ha=Kindle.BookInfo.CachedState.PINNED;ma=!0;C.registerModuleWithDeferred(b,c);var f=A(a);ba.always(KindleReaderAnnotationManager.clear);return f},cancelDownloading:function(){D.downloadController&&
D.downloadController.failDownload(Kindle.ERROR.CANCELLED)},pauseDownloading:function(){I&&I.downloadController.pauseDownload()},resumeDownloading:function(){I&&I.downloadController.resumeDownload()},getDownloadComplete:function(a){na=a;return ba.promise()},isBookDownloaded:function(){return Q===Kindle.BookInfo.CachedState.CACHED||Q===Kindle.BookInfo.CachedState.PINNED},setCachedState:o,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(C.getModule(j),v.computeQuota()).then(function(b,c){a.resolve({bookSize:b.bookSize,
quota:c})},a.reject);return a.promise()},isUpdated:function(){return!!N}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookSkeletonBuilderFactory(h,j,e,d){function c(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,f){return(c=b[c||f])?'url("'+c+'")':c===null?"none":a}));return a}function b(a,b,c,g){a=a.includes;if(a!==void 0){for(var d,e=0;e<a.length;e++){var n=g[a[e]],h=b[n.metadata.id];if(h.type==="text/css")d=d||{},d[h.name]=n.data}if(d)c.skeletonData=c.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,c){return(b=d[b||c])?'<style type="text/css">'+b+"</style>":a})}}function g(a,g,d,e){if(d!==null){var h=a.resourceManifest,a=a.skeletonManifest[g.skeletonMetadata.id],q;for(q in d){var n=d[q],r=h[n.metadata.id].includes;if(r!==void 0){for(var s={},t=0;t<r.length;t++){var u=d[r[t]];s[h[r[t]].name]=u===void 0?null:u.data}n.data=c(n.data,s)}}b(a,h,g,d);d=a.depends;if(d!==void 0){q=[];for(a=0;a<d.length;a++)n=h[d[a]],n.resInfo!==void 0&&q.push(n.resInfo);g.resourceInfo=q}}e.resolve(g)}var a=
{};a.skeletonManager=h;a.resourceManger=j;a.manifest=e;a.dictionary=d;a.buildSkeleton=function(a){function b(a){a.data=c(a.data,a.resList);s[a.metadata.id]=a;q++;r!==null&&q>=h&&g(t,r,s,d)}var d=new jQuery.Deferred,e=this.dictionary,h=0,q=0,n=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[a]!==void 0&&this.manifest.skeletonManifest[a].depends!==null)n=this.manifest.skeletonManifest[a].depends.slice(),h=n.length;var r=null,s=null,t=this.manifest;this.skeletonManager.getChunks([a],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,e),delete a.skeletonMetadata.compression;q>=h?g(t,a,s,d):r=a},d.reject);h>0&&(s={},this.resourceManger.getChunks(n,b,d.reject));return d.promise()};return a}
var KindleCompression=function(){function h(a,c,f){var g,f=f>0?f:b;for(g in c)c[g]>=f&&(f=c[g]+1);g=f;for(var d in a)for(var f=a[d],e=2;e<=f.length;e++){var h=f.substr(0,e);c.hasOwnProperty(h)||(c[h]=g++)}return c}function j(c,e){var l,h=b;l="";for(var q=0;q<e.length;){var n=e.charAt(q);q++;n.charCodeAt(0)<=d?c.hasOwnProperty(l+n)?l+=n:(l.length>0&&h<g&&(c[l+n]=h,h++,h===a&&(h=f)),l=n):l=""}return c}function e(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=j({},defaultDictionaryString);
return defaultDictionary}var d=9983,c=d+1,b=c+100+1,g=65533,a=55295,f=57344;return{lzCompress:function(k){var e={},l=[],h,q=b,n,r,s;n=h="";for(var t=0;t<k.length;){var u=k.charAt(t);t++;if(u.charCodeAt(0)<=d){for(;n.length>0;){r=Math.min(100,n.length);s=n.substr(0,r);n=n.substr(r);l.push(c+r);for(r=0;r<s.length;r++)l.push(s.charCodeAt(r))}e.hasOwnProperty(h+u)?h+=u:(h.length>0&&(l.push(h.length===1?h.charCodeAt(0):e[h]),q<g&&(e[h+u]=q,q++,q===a&&(q=f))),h=u)}else h.length>0&&(l.push(h.length===1?
h.charCodeAt(0):e[h]),h=""),n+=u}for(h.length>0&&l.push(h.length===1?h.charCodeAt(0):e[h]);n.length>0;){r=Math.min(100,n.length);s=n.substr(0,r);n=n.substr(r);l.push(c+r);for(r=0;r<s.length;r++)l.push(s.charCodeAt(r))}for(i=0;i<l.length;i++)l[i]=String.fromCharCode(l[i]);return l.join("")},lzExpand:function(k){for(var e={},h=[],o,q=b,n="",r,s=0;s<k.length;){o=k.charCodeAt(s);s++;if(o<=d)o=String.fromCharCode(o);else if(o>=b)(o=e[o])||(o=n+r);else{n=o-c;h.push(k.substr(s,n));s+=n;n="";continue}h.push(o);
r=o.charAt(0);q<g&&n.length>0&&(e[q]=n+r,q++,q===a&&(q=f));n=o}return h.join("")},lzBuildDictionary:j,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:h,lzAddNumbersToDictionary:function(a,b){for(var c=[],f=100;f<1E3;f++)c.push(""+f);return h(c,a,b)},lzCompressWithStaticDictionary:function(a,b){if(b===void 0||b==={})b=e();var f=[],g,h,n,r;h=g="";for(var s=0;s<a.length;){var t=a.charAt(s);s++;if(t.charCodeAt(0)<=d){for(;h.length>0;){n=Math.min(100,
h.length);r=h.substr(0,n);h=h.substr(n);f.push(c+n);for(n=0;n<r.length;n++)f.push(r.charCodeAt(n))}b.hasOwnProperty(g+t)?g+=t:(g.length>0&&f.push(g.length===1?g.charCodeAt(0):b[g]),g=t)}else g.length>0&&(f.push(g.length===1?g.charCodeAt(0):b[g]),g=""),h+=t}for(g.length>0&&f.push(g.length===1?g.charCodeAt(0):b[g]);h.length>0;){n=Math.min(100,h.length);r=h.substr(0,n);h=h.substr(n);f.push(c+n);for(n=0;n<r.length;n++)f.push(r.charCodeAt(n))}for(i=0;i<f.length;i++)f[i]=String.fromCharCode(f[i]);return f.join("")},
lzExpandWithStaticDictionary:function(a,f,g){if(f===void 0||f===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){e();defaultDeDictionary=[];for(var h in defaultDictionary)defaultDeDictionary[defaultDictionary[h]]=h}f=defaultDeDictionary}h=d;var q=b;g!==void 0&&(h=g-1,q=g);for(var g=[],n=0;n<a.length;){var r=a.charCodeAt(n);n++;r<=h?g.push(String.fromCharCode(r)):r>=q?g.push(f[r]):(r-=c,g.push(a.substr(n,r)),n+=r)}return g.join("")}}}(),ContentMigration=function(){function h(c){function b(a){var b=
"get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"Ids";return c.source[b]().pipe(function(b){function f(){var k=b.splice(0,100);if(k.length===0)g.then(d.resolve,d.reject);else{var e="get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"s",k=c.source[e](k);$.when(k,g).then(function(b){var d={};b.forEach(function(a,b){d[b]=a});g=c.target("putChunksNonT",c.asin,a,d);setTimeout(f,100)},d.reject)}}var g=$.Deferred().resolve(),d=$.Deferred();f();return d.promise()})}function g(){var c=BookChunk.types[f++];c?
b(c).then(g,a.reject):a.resolve()}var a=$.Deferred(),f=0,d=c.timer.createSubTimer("chunks");g();a.done(function(){d.endTimer()});return a.promise()}function j(c){var b=$.Deferred(),g=c.timer.createSubTimer("annotations");c.source.getAnnotations().then(function(a){c.target("putAnnotations",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){g.endTimer()});return b.promise()}function e(c){var b=$.Deferred(),g=c.timer.createSubTimer("pageNumbers");c.source.getPageNumbers().then(function(a){c.target("putPageNumbers",
c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){g.endTimer()});return b.promise()}function d(c){var b=$.Deferred(),g=c.timer.createSubTimer("bookinfo");c.source.getBookInfo().then(function(a){c.target("putBookinfo",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){g.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,
b){return{moveBook:function(g){var a=$.Deferred(),f=c.getBookDb();if(!g)return a.reject("Need ASIN as param").promise();var k={timer:KindleMetricsProfiler("Migrate "+g),asin:g,target:b.contentProvider,source:f.BookInfoDB(g)},g=$.when(h(k),j(k),e(k),d(k));g.then(function(){k.timer.endTimer();k.timer.log()});g.then(a.resolve,a.reject);return a.promise()},notifyMigrationStatus:function(b){var a=$.Deferred();if(!b||!b.status)return a.reject("Need param.status as param").promise();b.status==="done"?c.getBookDb().dropTables().then(a.resolve,
a.reject):a.reject("this status is not handled");return a.promise()}}})}}}(),DatabaseContentCache=function(){return{create:function(h){var j=$.Deferred(),e=h.bookinfoDb,d={};BookChunk.types.forEach(function(c){var b=c.substr(0,1).toUpperCase()+c.substr(1);d[c]={getChunks:function(c,a,f){e["get"+b+"s"](c).then(a,f)},putChunks:function(c,a,f){e["put"+b+"s"](c).then(a,f)},getCachedIds:function(c,a){e["get"+b+"Ids"]().then(c,a)}}});d.queryBookinfo=function(){return e.getBookInfo().pipe(function(c){j.resolve(c);
return c})};d.getBookinfo=function(){return j.promise()};d.putBookinfo=function(c){j.resolve(c);return e.insertBookInfo(c)};d.updateBookinfo=e.updateBookInfo;d.getAnnotations=e.getAnnotations;d.putAnnotations=e.putAnnotations;d.getPageNumbers=e.getPageNumbers;d.putPageNumbers=e.putPageNumbers;d.getSearchIndex=e.getSearchIndex;d.putSearchIndex=e.putSearchIndex;d.computeQuota=function(){return e.computeCacheQuota()};d.getBookStatistics=e.getBookStatistics;d.checkCache=function(){var c=e.getCacheQuota();
return c.cachedSize<=c.cacheQuota};d.deleteOldestBook=function(c,b){e.deleteOldestBookData(h.asin).then(c,b)};d.deleteBooksData=function(){bookInfo=void 0;j.state()!=="pending"&&(j=$.Deferred());return e.deleteBooksData([h.asin])};return d}}}(),DownloadingContentProvider=function(){function h(e){function d(f,d,e){function h(b){var c;if(!a){for(c in b)d(b[c]),g.removeId(c);var f=[],e;for(e=0;e<t.length;e++)c=t[e],b[c]===void 0&&f.push(c);t=f;f.length>0?s(f):r()}}function o(){a||s(t)}function q(c){function f(){a||
d(c)}if(!a){var g=BookChunk.getId(c);if(b){var e=[];e[g]=c;b.putChunks(e,f,f);--u===0&&r()}else d(c)}}function n(b,f,g,d){var k;a||(Object.prototype.toString.call(d)==="[object Array]"?(k=d,d="list"):k=[d],w[d]=w[d]+1||1,w[d]<=2?c.getChunks(k,q,n):(e(b,f,g),--u===0&&r()))}function r(){g.setNextId(z);setTimeout(flowControl.resume,0)}function s(a){u=a.length;c.getChunks(a,q,n)}Object.prototype.toString.call(f)!=="[object Array]"&&(f=[f]);var t=f.slice(0),u=0,z=Math.max.apply(Math,t)+1,w=[];b?(flowControl.pause(),
b.getChunks(f,h,o)):s(f)}var c,b,g,a=!1;c=e.source;b=e.cache;g=e.downloader;flowControl=e.flowControl;return{getChunks:d,getPieces:function(a,b,c){return d(a,b,c)},close:function(){a=!0}}}function j(e,d){var c=KindleBookDownloaderFactory({type:d,cache:!0,throttle:BookChunk.properties[d].huge,netGetter:e.source[d].getChunks,urlGetter:e.source[d].getUrls,fileGetter:e.source[d].getChunkFromUrl,dbPutter:e.cache[d].putChunks,dbGetIdList:e.cache[d].getCachedIds,dbCheckCache:e.cache.checkCache,dbOosHandler:e.cache.deleteOldestBook,
fileProgress:function(c){b.callEventListeners("onProgress",d,c)},dbIsCached:function(){b.callEventListeners("onCompleted",d)},dbIsOos:function(){b.callEventListeners("onFailed",d,Kindle.ERROR.OUT_OF_SPACE)},downloadError:function(c,a){b.callEventListeners("onFailed",d,c,a)},isIdRequired:e.tweaks&&e.tweaks[d]&&e.tweaks[d].isIdRequired}),b=ListenerManager();return{start:function(b,a){c.startReadAhead(b,a)},cancel:function(){c.cancelReadAhead()},pause:function(){c.pauseReadAhead()},resume:function(){c.resumeReadAhead()},
setNextId:function(b){c.setNextId(b)},removeId:function(b){c.removeIdFromReadAhead(b)},getNumIds:function(){return c.numIds},addEventListener:function(c,a){b.addEventListener(c,a)}}}return{create:function(e){var d={},c={},b={},g={},a={pause:function(){g.pauseDownload()},resume:function(){g.resumeDownload()}};BookChunk.types.forEach(function(b){c[b]=j(e,b);d[b]=h({type:b,source:e.source[b],cache:e.cache[b],downloader:c[b],flowControl:a})});b={downloadingContentProvider:d,fast:e.readAheadAgressively,
downloaders:c,sidecarManager:e.sidecarManager};g=BookDownloadController.create(b);d.queryBookinfo=e.cache.queryBookinfo;d.getBookinfo=e.cache.getBookinfo;d.putBookinfo=e.cache.putBookinfo;d.computeCacheQuota=e.cache.computeQuota;d.downloadController={startDownload:g.startDownload,failDownload:g.failDownload,cancelDownload:g.failDownload,pauseDownload:g.pauseDownload,resumeDownload:g.resumeDownload,whenDownloadComplete:g.whenDownloadComplete};d.close=function(){e.source.close();g.failDownload();BookChunk.types.forEach(function(a){d[a].close()})};
return d}}}(),KindleO_Aaa=function(){function h(a){for(var b=[],f,g,d,k,e,h,m=0;m<a.length;)d=a.charCodeAt(m++)&255,f=a.charCodeAt(m++),k=f&255,g=a.charCodeAt(m++),e=g&255,h=d>>2,d=(d&3)<<4|k>>4,k=(k&15)<<2|e>>6,e&=63,isNaN(f)?k=e=64:isNaN(g)&&(e=64),b.push(c.charAt(h)+c.charAt(d)+c.charAt(k)+c.charAt(e));return b.join("")}function j(a){for(var c=[],f,g,d,k,e,h=0;h<a.length;)f=b[a.charCodeAt(h++)],g=b[a.charCodeAt(h++)],k=b[a.charCodeAt(h++)],e=b[a.charCodeAt(h++)],f=f<<2|g>>4,g=(g&15)<<4|k>>2,d=
(k&3)<<6|e,c.push(String.fromCharCode(f)),k!==64&&c.push(String.fromCharCode(g)),e!==64&&c.push(String.fromCharCode(d));return c.join("")}function e(a,b){var c=[];c.length=256;for(var f=0;f<256;f++)c[f]=f;for(var g=0,d,f=0;f<256;f++)g=g+c[f]+b[f%b.length]&255,d=c[f],c[f]=c[g],c[g]=d;for(var g=f=0,k=[],e=0;e<a.length;e++)f=f+1&255,g=g+c[f]&255,d=c[f],c[f]=c[g],c[g]=d,k.push(String.fromCharCode(a.charCodeAt(e)^c[c[f]+c[g]&255]));return k.join("")}function d(b,c){for(var g="",d=c?f:a,k=d.length,e=0;e<
b;e++)g+=d.charAt(Math.floor(Math.random()*k));return g}for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b=[],g=0;g<c.length;g+=1)b[c.charCodeAt(g)]=g;for(var a="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",f=a+"                                             ",k=[],m=0;m<10;m++)k[m]=d(15,!1);var l=["p","span","div","em","i","strong","b","a","big","small"],o=!1;return{iToStr:function(a,b,c){var f=new Image;f.onload=
function(){var a=KindleHostDeviceDetector.isIE(),c=f.height,g=f.width,d=document.createElement("canvas").getContext("2d");d.drawImage(f,0,0);for(var k,e,h,m,l,r="",o=0,q,j=0;j<c;){k=d.getImageData(0,j,g,1);o=0;for(q=k.data.length-4;o<q;){e=k.data[o++]&7;h=k.data[o++]&3;m=k.data[o++]&7;o++;l=e*32+h*8+m;if(a){var D=void 0,D=0;l>=65&&l<=90||l>=50&&l<=55||l===0?D=l:(D=e>=2?-1:1,D=(e+D+8)%8*32+(h+D+4)%4*8+(m+D+8)%8);D>=65&&D<=90||D>=50&&D<=55||(D=0);l=D}if(l===0)break;r+=String.fromCharCode(l)}if(l===
0)break;j++}b(r)};f.onerror=function(){c()};f.src=a},o_aaa:h,o_aag:j,o_aac:function(a,b){var c;c=a.replace(/\x0d\x0a/g,"\n");for(var f=[],d=0;d<c.length;d++){var k=c.charCodeAt(d);k<128?f.push(String.fromCharCode(k)):(k>127&&k<2048?f.push(String.fromCharCode(k>>6|192)):(f.push(String.fromCharCode(k>>12|224)),f.push(String.fromCharCode(k>>6&63|128))),f.push(String.fromCharCode(k&63|128)))}c=f.join("");f=b;f+="00000000000000000000000000000000".substring(0,32-f.length);d=[];for(g=0;g<f.length;g+=2)d.push(parseInt(f.substring(g,
g+2),16));return h(e(c,d))},o_aad:function(a,b){for(var c=j(a),f=[],g=0;g<b.length;g++)f.push(b.charCodeAt(g));for(var c=e(c,f),f=[],g=0,d,k,h;g<c.length;)d=c.charCodeAt(g),d<128?(f.push(String.fromCharCode(d)),g++):d>191&&d<224?(k=c.charCodeAt(g+1),f.push(String.fromCharCode((d&31)<<6|k&63)),g+=2):(k=c.charCodeAt(g+1),h=c.charCodeAt(g+2),f.push(String.fromCharCode((d&15)<<12|(k&63)<<6|h&63)),g+=3);return f.join("")},o_aae:function(a){var b;if(!o){for(b=0;b<10;b++)$(k[b]).addClass("noDisplay");o=
!0}var c=$(a).html(),f=!1,g="",e=0;for(b=0;b<c.length;b++)if(c[b]===">")f=!1;else if(c[b]==="<")f=!0;else if(b%60===7&&!f){g+=c.substring(e,b);var e=b,h=l[Math.floor(Math.random()*l.length)];g+="<"+h+' class="'+k[Math.floor(Math.random()*k.length)]+'">'+d(30,!0)+"</"+h+">"}g+=c.substring(e,c.length);$(a).html(g)},o_aaf:function(a){a:{for(var b=0;b<k.length;b++)if(k[b]===a){a=!0;break a}a=!1}return a}}}(),KindleReaderAnnotationManager=function(){function h(a,b){return a.start-b.start}function j(a){for(var b=
0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function e(a){function b(){d(a).then(f.resolve,f.reject)}function c(){q(a).then(b,f.reject)}var f=new jQuery.Deferred;f.then(function(){for(var b=0;b<a.length;b++)C.emit(g(a[b]))},function(){for(var b=0;b<a.length;b++)C.emit(g(a[b],"Fail"))});k(a);for(var e=0;e<a.length;e++){if(a[e].asin===void 0||a[e].refEmId===void 0||a[e].start===void 0||a[e].type===void 0)return C.emit(g(a[e],"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),
f.reject().promise();if(a[e].note)a[e].note=r(a[e].note)}N.acquire().done(function(){E=Date.now();O.saveToJournal(a).then(c,f.reject);f.then(N.release,N.release)});return f.promise()}function d(a){function b(){for(var g,d=!1,k,e=0;e<a.length;e++)k=a[e],g=c(k.type,k.start),k.action===F?g===-1&&(H.push(k),d=!0):k.action===A?g!==-1&&(H.splice(g,1),H.push(k),d=!0):k.action===x&&g!==-1&&H.splice(g,1);d&&H.sort(h);f.resolve();L.cacheAnnotations(H)}var f=new jQuery.Deferred;t().then(b,b);return f.promise()}
function c(a,b){for(var c in H){var f=H[c];if(f.type===a&&f.start===b)return c}return-1}function b(a,b){return H[c(a,Number(b))]||null}function g(a,b){var c="Reader::"+v[a.action]+v[a.type];b&&(c+=b);return c}function a(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=D,a[c].refEmId=K,a[c].action=F,a[c].modifiedTimestamp=b;return a}function f(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=x,a[c].modifiedTimestamp=b;return a}function k(a){for(var b=0;b<a.length;b++)a[b].positionType=
M;return a}function m(b){a(b);return e(b)}function l(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=A,a[c].modifiedTimestamp=b;return e(a)}function o(a){f(a);return e(a)}function q(a){function b(){function g(a){e.context=a;b()}for(var d,k,e;f<a.length&&!(a[f].action===F&&(a[f].type===w||a[f].type===G));)++f;if(f<a.length){e=a[f++];switch(e.type){case w:d=e.position;k=e.position+B;break;case G:d=e.start,k=e.end}n(d,k).then(g,b)}else c.resolve()}var c=new jQuery.Deferred,f=0;b();return c.promise()}
function n(a,b){P===null&&(P=KindleRenderer.createWordIterator());return P.getText(a,b)}function r(a){a.length>Kindle.opt.maxNoteChars&&(C.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function s(b,c,g,d){var k=KindleReaderAnnotationManager.getAnnotationsInRange(b,c,G),h=k.length,m={type:G,start:b,position:g,end:c},l=[];d&&l.push.apply(l,a([{type:y,start:c,position:g,end:c,note:d}]));if(k.length===1&&b>=k[0].start&&
c<=k[0].end){if(l.length===0)return(new jQuery.Deferred).resolve([k[0]])}else{if(h>0)m.start=Math.min(b,k[0].start),m.end=Math.max(c,k[h-1].end),l.push.apply(l,f(k));l.push.apply(l,a([m]))}return e(l)}function t(){var a=new jQuery.Deferred;L.getCachedAnnotations().then(function(b){b&&b.length!==void 0&&(H=b,j(H));a.resolve()},a.reject);return a.promise()}function u(){function a(){c.resolve()}function b(){c.resolve()}var c=new jQuery.Deferred;J.getAnnotations(D,K).then(function(c){H=c.annotations;
j(H);L.cacheAnnotations(H).then(a,b)},c.reject);return c.promise()}function z(){function a(){t().then(c.reject,c.reject)}function b(){u().then(c.resolve,a)}var c=new jQuery.Deferred;O.uploadJournal().then(b,b);return c.promise()}var w="kindle.bookmark",y="kindle.note",G="kindle.highlight",F="create",A="modify",x="delete",B=100,v={};v[w]="Bookmark";v[y]="Note";v[G]="Highlight";v[F]="Create";v[A]="Modify";v[x]="Delete";var I,L=null,D=null,K=null,M=null,H=null,J=null,O=null,C,E=Date.now(),N=Lock(),P=
null;return{BOOKMARK:w,NOTE:y,NOTE_ICON:"kindle.note.icon",HIGHLIGHT:G,POPULAR_HIGHLIGHT:"kindle.popular",getLastUpdateTime:function(){return E},deferredInitialize:function(a,b){function c(){I.resolve(g)}function f(a){J=a[b.SERVICE_CLIENT];O=a[b.JOURNAL_MANAGER];C=a[b.METRICS_MANAGER];z().then(c,c)}var g,d;I||(b=b||KindleModuleManager,I=$.Deferred(),g=this,d=[b.SERVICE_CLIENT,b.JOURNAL_MANAGER,b.METRICS_MANAGER],H=[],a.then(function(a){L=a;D=L.getAsin();K=L.getRefEmId();M=L.getBookType();L.getContext().isOwned?
b.getModuleList(d).then(f,I.reject):I.reject()},I.reject));return I.promise()},clear:function(){var a=I;I=null;H=[];D=K=M=null;a&&a.reject()},getAnnotation:b,getAllAnnotations:function(){return H.slice()},getAnnotationsInRange:function(a,b,c){var f=[],g;for(g in H){var d=H[g];(d.start<=b&&d.end>=a||d.start>=a&&d.start<=b)&&(!c||c===d.type)&&f.push(d)}return f},createBookmark:function(a){return m([{type:w,start:a,position:a,end:a,context:""}])},createNote:s,modifyNote:function(a,c,f){var g=new jQuery.Deferred;
(a=b(y,a))?(a.note=f,a.position=c,l([a]).then(g.resolve,g.reject)):g.reject();return g.promise()},createHighlight:function(a,b,c){return s(a,b,c,null)},deleteAnnotations:o,getContext:n,updateAnnotations:function(a){for(var b,c=[],f=[],g=[],d=[],k=0;k<a.length;k++)switch(b=a[k],b.action){case F:c.push(b);break;case A:g.push(b);break;case x:f.push(b)}c.length>0&&d.push(m(c));g.length>0&&d.push(l(g));f.length>0&&d.push(o(f));return $.when.apply($,d)}}}(),NetworkContentProvider=function(){var h=3E4;return{create:function(j){function e(a,
b){var c=new jQuery.Deferred;$.jsonp({url:a,callback:b,cache:!0,timeout:h,error:function(a,b){c.reject(a,b)},success:function(a){c.resolve(a)}});return c.promise()}function d(a,b,c){function g(a,b,c){var f,d;if(a&&a.length)for(f=0;f<a.length;f++)d=b+a[f].id,c(a[f].signedUrl,d,a[f].id)}g(a.skeletonUrls,"loadSkeleton",function(a,g,d){e(a,g).then(function(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.skeletonData,f);a.skeletonData=c;delete a.skeletonMetadata.encryption}b(a)},
function(a,b){c(null,b,null,d)})});g(a.fragmentUrls,"loadFragment",function(a,g,d){e(a,g).then(function(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.fragmentData,f);a.fragmentData=c;delete a.fragmentMetadata.encryption}b(a)},function(a,b){c(null,b,null,d)})});g(a.glyphUrls,"loadGlyphFragment",function(a,f,g){e(a,f).then(function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=g;b(a)},function(a,b){c(null,b,null,g)})});g(a.resourceUrls,
"loadResource",function(a,f,g){e(a,f).then(b,function(a,b){c(null,b,null,g)})});g(a.locationMapUrls,"loadMobiLocationMap",function(a,f,g){e(a,f).then(b,function(a,b){c(null,b,null,g)})})}function c(b,c){var f={asin:j.asin,contentVersion:a.contentVersion,formatVersion:a.formatVersion,isSample:a.isSample};if(a.kindleSessionId)f.kindleSessionId=a.kindleSessionId;if(a.basePath)f.basePath=a.basePath;if(a.useNewPath)f.useNewPath=a.useNewPath;if(a.useProdBucket)f.useProdBucket=a.useProdBucket;if(a.kcrFree)f.kcrFree=
!0;f[b+"Ids"]=c;return g.getFileUrl(f)}function b(a,b,f,g){Object.prototype.toString.call(b)!=="[object Array]"&&(b=[b]);c(a,b).then(function(a){k||d(a,f,g)},function(a,c,f){g(a,c,f,b)})}var g,a,f,k=!1;a=j.context;f=a.contentChecksum;g=KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT);var m={};BookChunk.types.forEach(function(a){m[a]={getChunks:function(c,f,g){b(a,c,f,g)},getUrls:function(b,f,g){c(a,b).then(function(b){f(b[a+"Urls"])},g)},getChunkFromUrl:function(b,c,f){var g={};g[a+
"Urls"]=[b];d(g,c,f)}}});m.getFragmap=function(){var b=$.Deferred();e(a.fragmentMapUrl,"loadFragmap").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getMetadata=function(){var b=$.Deferred();e(a.metadataUrl,"loadMetadata").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getManifest=function(){function b(a){f.resolve(a)}function c(){f.resolve({})}var f=$.Deferred();a.manifestUrl?e(a.manifestUrl,"loadManifest").then(b,c):f.resolve({});
return f.promise()};m.close=function(){k=!0};return m}}}(),RemoteContentCache=function(){return{create:function(h){function j(a){g=a;if(!e||e.state!=="pending")e=$.Deferred();e.resolve(g)}var e=$.Deferred(),d=h.asin,c=h.contentProvider,b=h.contentRemover,g,a={};BookChunk.types.forEach(function(b){a[b]={getChunks:function(a,g,e){c("getChunks",d,b,a).then(g,e)},putChunks:function(a,g,e){var h={};a.forEach(function(a,b){h[b]=a});c("putChunks",d,b,h).then(g,e)},getCachedIds:function(a,g){c("getChunkIds",
d,b).then(a,g)}}});a.queryBookinfo=function(){return c("getBookinfo",d).pipe(function(a){j(a);return a})};a.getBookinfo=function(){return e.promise()};a.putBookinfo=function(a){j(a);return c("putBookinfo",d,a)};a.updateBookinfo=function(a){if(!g)return $.Deferred().reject("bad state");$.extend(g,a);return c("updateBookinfo",d,a)};a.getAnnotations=function(){return c("getAnnotations",d)};a.putAnnotations=function(a){return c("putAnnotations",d,a)};a.getPageNumbers=function(){return c("getPageNumbers",
d)};a.putPageNumbers=function(a){return c("putPageNumbers",d,a)};a.computeQuota=function(){return $.Deferred().resolve(0)};a.getBookStatistics=function(){return $.Deferred().reject()};a.checkCache=function(){return!0};a.deleteOldestBook=function(a,b){b()};a.deleteBooksData=function(){g=void 0;e.state()!=="pending"&&(e=$.Deferred());return b({asin:d})};a.downloadSearchIndex=function(a){return c("getSearchIndexReader",d,a)};a.initMetadata=function(a){return c("initMetadata",d,a)};return a}}}();
function KindleBookResourceUrlTranslator(h,j){var e={};e.resourceManger=h;e.resourceManifest=j.resourceManifest;e.reverseLookup={};for(var d in e.resourceManifest)e.reverseLookup[e.resourceManifest[d].name]=d;e.getResourceUrls=function(c,b,g){function a(a){var c={};c[h[a.metadata.id].name]=a.data;b(c)}for(var f=[],d=0;d<c.length;d++){var e=this.reverseLookup[c[d]];e!==void 0&&f.push(e)}var h=this.resourceManifest;f.length!==c.length&&g();f.length>0?this.resourceManger.getChunks(f,a,g):b({})};return e}
(function(){function h(e){function d(){return KindleDebug.assert.apply(KindleDebug,arguments)}function c(){return KindleDebug.log.apply(KindleDebug,arguments)}function b(){return $.Deferred().reject.apply($,arguments)}function g(a){for(var a=new Uint8Array(e[a]),b=[],c=0;c<a.byteLength;c++)b.push(String.fromCharCode(a[c]));a=b.join("");return $.Deferred().resolve(a)}function a(a,c,f,g,k){a=a.cloneStream();a.seek(c);return a.readAsync(f).pipe(function(c){function f(){switch(g){case 1:return e.readByte()+
k;case 2:return e.readInt16()+k;case 3:return(e.readByte()<<16)+e.readUInt16()+k;case 4:return e.readInt32()+k;default:d("Got unexpected bytes-per-entity:"+g)}}try{for(var e=c,c=[];e.unconsumedBufferLength>0;)c.push(f());e.close();a.close();return c}catch(h){return a.close(),b(h)}},a.close)}function f(b,c){var f=b.directory.BytesPerEntity;return a(b.positionsStream,b.directory.Positions.offset+c.o*f,c.n*f,f,b.directory.MinimumTitleEntityValue)}var k={magicLength:4,magic:"AZSA",headerOffset:-28,directoryOffset:-24,
stringEntries:["Magic","WhereIndexed","IndexerHelperClassName"],wordsFilename:"index.words",positionsFilename:"index.positions",propertiesFilename:"index.properties"},h=$.Deferred();(function(a){var c,f,g,d=a.positionsStream,e=Math.min(d.size,Math.abs(k.headerOffset));d.seek(Math.max(0,d.size+k.headerOffset));return a.positionsStream.readAsync(e).pipe(function(c){try{var d=c.readInt32();f=c.readInt32();g=c.readInt32();c.close();if(d!==a.positionsStream.size)return b("bad header size");a.positionsStream.seek(f);
return a.positionsStream.readAsync(g)}catch(k){return b(k)}}).pipe(function(f){try{c={Magic:{offset:0,length:k.magicLength,isString:!0}};for(var g,d,e,h;f.unconsumedBufferLength>0;)if(g=f.readInt32(),d=f.readInt32(),e=f.readByte(),h=f.readString(e),c[h]={offset:g,length:d},k.stringEntries.indexOf(h)>=0)c[h].isString=!0;f.close();var m=c.SearchBoundaryPositions.offset;a.positionsStream.seek(0);return a.positionsStream.readAsync(m)}catch(n){return b(n)}}).pipe(function(f){function g(a){for(var b=Object.keys(c),
f=0;f<b.length;++f)if(c[b[f]].offset===a)return b[f]}try{for(var d,e=0;f.unconsumedBufferLength>0;){d=g(e);if(!d)return f.close(),b("Can't read directory entries");e+=c[d].length;if(c[d].isString)c[d]=f.readString(c[d].length);else if(c[d].length===1)c[d]=f.readByte();else if(c[d].length===4)c[d]=f.readInt32();else return f.close(),b("Bad size for numeric entry")}f.close();if(c.Magic!==k.magic)return b("bad magic");a.directory=c;return a}catch(h){return b(h)}})})({getPositionsForWord:function(a){var b=
$.Deferred(),g=this.wordList[a],d={word:a,searchBoundaryPositions:this.searchBoundaryPositions,positions:[]};g?f(this,g).pipe(function(f){c('Word "'+a+'" has '+f.length+" occurances");d.positions=f;b.resolve(d)},function(){b.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)}):b.resolve(d);return b.promise()},getProperty:function(a){return this.properties[a]},close:function(){this.positionsStream=null},positionsStream:new j(e.positions)}).pipe(function(a){return g("words").pipe(function(b){var c={};b.split("\n").forEach(function(a){a=
a.split(":");c[a[2]]={o:a[0],n:a[1]}});a.wordList=c;return a})}).pipe(function(a){return g("properties").pipe(function(b){var c={},f=/(.*?)=(.*)/;b.split("\n").forEach(function(a){a&&(a=f.exec(a),a.length===3&&(c[a[1]]=a[2]))});a.properties=c;return a})}).pipe(function(b){return a(b.positionsStream,b.directory.SearchBoundaryPositions.offset,b.directory.SearchBoundaryPositions.length,b.directory.BytesPerEntity,b.directory.MinimumTitleEntityValue).pipe(function(a){b.searchBoundaryPositions=a;return b})}).pipe(h.resolve,
function(){h.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)});return h.promise()}var j;KindleModuleManager.define("SearchIndexParser",["SearchIndexUtilities"],function(e){j=e.Stream;return{openSearchIndex:h}})})();
(function(){function h(a){function b(g){for(var d={},k,e=0;e<g.length;e++)if(k=g[e].filename,k.endsWith(l.words))d.words=g[e].data;else if(k.endsWith(l.properties))d.properties=g[e].data;else if(k.endsWith(l.positions))d.positions=g[e].data;d.asin=a.asin;f.endTimer();f.log();c.notify("finished");c.resolve(d)}var c=new $.Deferred,f=KindleMetricsProfiler("unzip search index");if(a.length>1)return KindleDebug.error("Cannot Unzip: We have too many array buffers"),c.reject("Index too large");KindleZip.unzip(a[0]).pipe(b,
b);return c.promise()}function j(a,b){for(var c=KindleMetricsProfiler("decrypt search index"),f=b.decryptionIV,g=b.decryptionKey,d=[],k,e=0;e<a.length;e++)k=KindleCrypto.decrypt(a[e],g,f),k=k.buffer,d.push(k);d.asin=b.asin;c.endTimer();c.log();return d}function e(a){function c(b){function g(){F.endTimer();D.push(x.response);I+=B;I<L?(v-=Date.now(),v<k?B*=2:v>m&&(B/=2),l()):(A.endTimer(),A.log(),K.resolve(D,q))}function d(a){a.lengthComputable?(a=Math.floor(100*a.loaded/a.total),a!==y&&(y=a)):KindleDebug.log("progress unknown")}
function e(){KindleDebug.error("An error occurred while transferring the file.");K.reject("failed")}function h(){KindleDebug.error("The transfer has been canceled by the user.");K.reject("cancelled")}function l(){v=Date.now();F=A.createSubTimer("@"+I);var a=Math.min(I+B-1,L);x=new XMLHttpRequest;x.open("GET",j);x.setRequestHeader("Range","bytes="+I+"-"+a);x.responseType="arraybuffer";x.addEventListener("progress",d,!1);x.addEventListener("load",g,!1);x.addEventListener("error",e,!1);x.addEventListener("abort",
h,!1);x.send(null)}var q=b;if(q.s3Url===null)return $.Deferred().reject(Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE);q.asin=a.asin;var y=-1,j=q.s3Url.replace(/http:\/\//,"https://"),F,A=KindleMetricsProfiler("download search index"),x,B=f,v,I=0,L=q.indexSize-1,D=[],K=$.Deferred();l();return K}return KindleHostDeviceDetector.isOnline()?b.getSearchIndexInfo(a).pipe(c,function(a){return a.status===0?$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE):$.Deferred().reject(Kindle.ERROR.SITB_COMMON_ERROR)}):$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE)}
function d(b){function c(a){return!b.contentCache?$.Deferred().resolve(a):b.contentCache.putSearchIndex(a)}if(!KindleDeviceCapabilities.searchInTheBook())return $.Deferred().reject("Unsupported OS");if(a[b.asin])return a[b.asin];a={};a[b.asin]=(!b.contentCache?$.Deferred().reject("no db"):b.contentCache.getSearchIndex()).pipe(null,function(){return e(b).pipe(j).pipe(h).pipe(c)}).pipe(g.openSearchIndex);return a[b.asin]}function c(a){return a.contentCache.downloadSearchIndex({asin:a.asin})}var b,g,
a={},f=16777216,k=1E4,m=2E4,l={words:".words",positions:".positions",properties:".properties"};KindleModuleManager.define(Kindle.MODULE.SearchIndexManager,[Kindle.MODULE.SERVICE_CLIENT,Kindle.MODULE.DB_CLIENT,"SearchIndexParser"],function(a,f,k){b=a;g=k;return{getSearchIndex:KindleHostDeviceDetector.isMetro()?c:d}})})();
(function(){function h(e){if(!(this instanceof h)){var d=Object.create(h.prototype);return h.apply(d,arguments)}this.bytes=new Uint8Array(e);this.position=0;this.size=this.bytes.length;return this}function j(e,d,c){if(!(this instanceof j)){var b=Object.create(j.prototype);return j.apply(b,arguments)}this.uBytes=e.bytes;this.bytes=new Int8Array(this.uBytes);this.base=d!==void 0?d:0;this.position=0;this.unconsumedBufferLength=this.size=c!==void 0?c:this.uBytes.length-this.base;return this}if(!Uint8Array.prototype.subarray)Uint8Array.prototype.subarray=
function(e,d){for(var e=e===void 0?0:e,d=d===void 0||d>copy.length?copy.length:d,c=new Uint8Array(d-e),b=0;b<c.length;b++)c[b]=this[b+e];return c};h.prototype.seek=function(e){this.position=Math.min(Math.max(e,0),this.size)};h.prototype.readAsync=function(e){return $.Deferred().resolve(new j(this,this.position,Math.min(e,this.size-this.position)))};h.prototype.cloneStream=function(){var e=new h(this.bytes);e.position=this.position;return e};h.prototype.close=function(){this.bytes=null};j.prototype.seek=
function(e){this.position=Math.min(Math.max(e,0),this.size);this.unconsumedBufferLength=this.size-this.position};j.prototype.getPosition=function(){return this.position};j.prototype.readByte=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.uBytes[this.base+this.position];this.position++;this.unconsumedBufferLength--;return e};j.prototype.readInt8=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var e=this.bytes[this.base+this.position];this.position++;
this.unconsumedBufferLength--;return e};j.prototype.readInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.bytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};j.prototype.readUInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var e=this.base+this.position,e=(this.uBytes[e]<<8)+this.uBytes[e+1];this.position+=2;this.unconsumedBufferLength-=2;return e};j.prototype.readInt32=
function(){return(this.readInt16()<<16)+this.readUInt16()};j.prototype.readUInt32=function(){return(this.readUInt16()<<16)+this.readUInt16()};j.prototype.readString=function(e){if(this.unconsumedBufferLength<e)throw Error("Out of data");var d=this.base+this.position,c;try{c=String.fromCharCode.apply(null,this.uBytes.subarray(d,d+e))}catch(b){c=[];for(var g=d;g<d+e;g++)c.push(String.fromCharCode(this.uBytes[g]));c=c.join("")}this.position+=e;this.unconsumedBufferLength-=e;return c};j.prototype.close=
function(){this.unconsumedBufferLength=0;this.uBytes=this.bytes=null};KindleModuleManager.define("SearchIndexUtilities",null,{Stream:h,Buffer:j})})();
(function(){function h(d){function c(){if(!a)if(r.seek(0),g=r.readInt16(),g!==1)KindleDebug.warn("Unsupported page numbering file format version "+g);else if(f=r.readInt16(),f===0)KindleDebug.log("PageNumbers File for this book is revoked by the service"),a=Kindle.ERROR.PN_REVOKED;else{k=[];for(var b=0;b<f;b++)k[b]=r.readUInt32();b=r.readUInt32();a=b>0?r.readString(b):"";h=[];q=[];l=[];o=[]}}function b(a){c();var b;a>=f||a<=-1?(KindleDebug.log("The requested page numbering edition at index "+a+" is out of bounds for the available count of editions "+
f),b=!1):b=!0;if(b&&!o[a])if(r.seek(k[a]),b=r.readInt16(),b!==1)KindleDebug.log("Unsupported edition pagination format "+b+" for edition "+a);else{b=r.readInt16();var g=r.readInt16(),d=r.readInt16();if(d>32)KindleDebug.log("Unsupported pagination format position width "+d+" for edition "+a);else{var e;b>0&&(e=r.readString(b));h[a]=parseInt(r.getPosition(),10);q[a]=g;l[a]=d;o[a]=e;return!0}}}var g,a,f,k,h,l,o,q,n=[],d=new e(d),r=new j(d,0,d.size);return{getHeaderMetadata:function(){c();return a},getEditionMetadata:function(a){return b(a)?
o[a]:!1},getOrdinalPagePositions:function(a){b(a);var c=q[a],f=l[a]/8;n.length=c+1;r.seek(h[a]);for(a=1;a<=c;a++){var g=f===2?r.readUInt16():f===4?r.readUInt32():0;n[a]=parseInt(g,10)}for(c=1;c<n.length;c++)n[c-1]>n[c]&&KindleDebug.log("Invalid position value at index "+c+": "+n[c]+", previous position: "+n[c-1]);return n},getEditionCount:function(){return f},getTotalPageCount:function(a){return q[a]}}}var j,e;KindleModuleManager.define("BinaryPageLabelSidecarReader",["SearchIndexUtilities"],function(d){j=
d.Buffer;e=d.Stream;return{openReader:h}})})();
var PageLabelIndexer=function(){return{create:function(h,j){function e(a){var c=0,f;for(f in b)b[f].getPageLabelType()===a&&b[f].getEndingOrdinalPageNumber()>c&&(c=b[f].getEndingOrdinalPageNumber());return c}function d(c){var f,d;c<1||c>a?d=void 0:(d=PageNumberUtilities.binarySearchPosition(g,c),d=b[g[d]]);d&&(c-=d.getStartingOrdinalPageNumber(),c=d.getStartingPageLabel()+c,f=d.getPageLabelAtSeriesIndex(c));return f}var c="",b,g,a;if(h==="")KindleDebug.log("pageLabelIndexString cannot be blank, pageLabelIndexString = "+c);
else if(j<0)KindleDebug.log("TotalPages cannot be less than 0, total pages = "+j);else{c=h.toString();a=j;var f=0,k=null;for(b={};f<c.length;){if(c.charAt(f)!=="("){KindleDebug.log("Each page number scheme must start with '('; was given: "+c.substring(f));return}var m=c.indexOf(")",f);if(m<0)break;f=c.substring(f+1,m);f=PageLabelSeq.create(f);k!==null&&k.setEndingOrdinalPageNumber(f.getStartingOrdinalPageNumber()-1);k=b[parseInt(f.getStartingOrdinalPageNumber(),10)]=f;f=m+1;f<c.length&&c.charAt(f)===
","&&f++}k.setEndingOrdinalPageNumber(j);g=[];var c=0,l;for(l in b)b.hasOwnProperty(l)&&(g[c]=b[l].getStartingOrdinalPageNumber(),c++);g.sort(function(a,b){return a-b});return{getLabelSequences:function(){return b},getOrdinalPageForPageLabelText:function(a){var c=null,f=0,g;for(g in b){var d=b[g];if(d.isLabeled()){d.getStartingOrdinalPageNumber()<=f&&(c=null);var k=d.getOrdinalPageForPageLabelText(a);k>=0&&(c=d,f=k)}}return c===null||f>j?0:f},getPageLabelTextForOrdinalPage:d,getHighestPageLabel:function(){var a=
e("a");a===0&&(a=e("r"));var b="";a>0&&(b=d(a));return b},getPageNumberRanges:function(){var a={},c;for(c in b){var f={},g=b[c];f.minPage=g.getStartingPageLabel();f.maxPage=g.getEndingPageLabel();g=PageLabelType[g.getPageLabelType()];a[g]=f}return a}}}}}}(),PageLabelSeq=function(){return{create:function(h){function j(){return c}function e(){return b}function d(){return b+f-c}var c,b,g,a,f,h=h.split(",");f=c=parseInt(h[0],10);g=h[1].charAt(0);if(g===null)console.error("Unknown Page Numbering scheme");
else return b=0,a=null,g==="c"?(a=h[2].split("|"),b=1):g!=="i"?b=parseInt(h[2],10):h[2]&&(b=parseInt(h[2],10)),{getStartingPageLabel:e,getStartingOrdinalPageNumber:j,getPageLabelType:function(){return g},getEndingPageLabel:d,getDisplayPageRange:function(){return[b,d()]},getEndingOrdinalPageNumber:function(){return f},setEndingOrdinalPageNumber:function(a){f<c&&console.error("ending ordinal page number must be >= than starting ordinal page number,endingOrdinalPageNumber  = "+f+", startingOrdinalPageNumber = "+
c);f=a},isLabeled:function(){return g!=="i"},getPageLabelAtSeriesIndex:function(b){var c;g==="a"?c=b.toString():g==="r"?c=PageNumberUtilities.toRomanNumeral(b).toString().toLowerCase():g==="i"?c="":g==="c"&&(b-=1,c=b<a.length?a[b]:"");return c},getOrdinalPageForPageLabelText:function(f){var d=0,e=!1;if(g==="a")try{d=parseInt(f,10),e=d>=b}catch(h){d=0,e=!1}g==="r"&&PageNumberUtilities.isValidRomanNumeral(f)&&(d=PageNumberUtilities.parseRomanNumeral(f),e=d>=b);g==="c"&&a!==null&&(a[f]&&(d=a[f]+1),d>
0&&(e=!0));return!e?-1:c+(d-b)}}}}}();
(function(){function h(b){function c(){d.endTimer();e.emit("Service::GetPageNumber");h.resolve(r.response)}function f(){KindleDebug.error("An error occurred while transferring the file.");h.reject(Kindle.ERROR.PN_DOWNLOAD_FAIL)}var d,e,h,r;return function(b){h=$.Deferred();r=new XMLHttpRequest;r.open("GET",b);r.responseType="arraybuffer";r.addEventListener("load",c,!1);r.addEventListener("error",f,!1);d=a.createSubTimer("download page numbers");e=g.createTimer();r.send(null);return h.promise()}(b)}
function j(a){var b=$.Deferred();a.getCachedPageNumbers().then(function(a){a?b.resolve(a):b.reject()},b.reject);return b.promise()}function e(a){var b=a.getContext().pageNumberUrl;return!b?(g.emit("PageNumber::Unavailable"),$.Deferred().resolve()):j(a).pipe(null,function(){return h(b).pipe(c).done(a.cachePageNumbers)}).pipe(function(a){g.emit("PageNumber::Success");return a},function(a){a===Kindle.ERROR.PN_DOWNLOAD_FAIL&&g.emit("PageNumber::DownloadFailure");g.emit("PageNumber::Fail")})}function d(b){var c=
b.getAsin();if(!f[c]){if(!KindleDeviceCapabilities.showPageNumbers())return $.Deferred().reject("Unsupported OS");a=KindleMetricsProfiler("get page numbers");f={};f[c]=e(b).pipe(function(b){var c;b&&(c=PageNumberProvider.create(b));a.endTimer();a.log();return c})}return f[c]}function c(c){function f(a){a===Kindle.ERROR.PN_REVOKED?g.emit("PageNumber::RevokedData"):g.emit("PageNumber::CorruptData");return $.Deferred().reject()}var d=g.createTimer(),e=a.createSubTimer("parse page number file"),c=b.openReader(c),
h=c.getHeaderMetadata();if(h){if(h===Kindle.ERROR.PN_REVOKED)return f(Kindle.ERROR.PN_REVOKED)}else return KindleDebug.log("Corrupt Header Data for Page Number."),f();if(!JSON.parse(h).fileRevisionId)return KindleDebug.log("Page number sidecar header doesn't contain appropriate metadata (missing fileRevisionId)."),f();if(c.getEditionCount()>0){h=c.getEditionMetadata(0);if(!h)return KindleDebug.log("Edition Header corrupted for Page Number."),f();h=JSON.parse(h);if(!h.pageMap)return KindleDebug.log("Page number sidecar edition doesn't contain appropriate metadata (missing pageMap)."),
f();c={oPNToPosition:c.getOrdinalPagePositions(0),pageMapString:h.pageMap,totalPages:c.getTotalPageCount(0)};d.emit("PageNumber::FileParse");e.endTimer();return c}else return f()}var b,g,a,f={};KindleModuleManager.define(Kindle.MODULE.PageNumberManager,[Kindle.MODULE.DB_CLIENT,Kindle.MODULE.METRICS_MANAGER,"BinaryPageLabelSidecarReader"],function(a,c,f){g=c;b=f;return{getPageNumbers:d}})})();
var PageNumberProvider=function(){return{create:function(h){var j=!1,e,d=[],c=-1,b=0;if(h){d=h.oPNToPosition;b=h.totalPages;e=PageLabelIndexer.create(h.pageMapString,b);var h=e.getLabelSequences(),g=b=null,a;for(a in h){if(h[a]===null){KindleDebug.log("Page number sidecar edition doesn't contain a valid page label index");return}b===null&&(b=h[a]);g=h[a]}j=!0;c=b.getStartingOrdinalPageNumber();g.getEndingOrdinalPageNumber()}return{arePageNumbersAvailable:function(){return j},pageNumberFromPosition:function(a){var b;
if(a>=d[c]){a=PageNumberUtilities.binarySearchPosition(d,a);a<c&&(a=c);var g;a>=1&&(g=e.getPageLabelTextForOrdinalPage(a));b=g}return b},positionFromPageNumber:function(a){var b=e.getOrdinalPageForPageLabelText(a);b<=0&&parseInt(a,10);if(b<=0)return-1;b>=d.length&&(b=d.length-1);return d[b]},getMaxPageNumberLabel:function(){return e.getHighestPageLabel()},getPageNumberRanges:function(){return e.getPageNumberRanges()}}}}}(),PageLabelType={r:"roman",a:"arabic",c:"custom",i:"insert"},PageNumberUtilities=
function(){var h={M:1E3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},j=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];return{toRomanNumeral:function(e){for(var d="",e=parseInt(e,10),c=0;c<j.length;c++)for(var b=j[c];e>=h[b];)d+=b,e-=h[b];return d},parseRomanNumeral:function(e){for(var e=e.toUpperCase(),d=0,c=0;c<e.length-1;)h[e.charAt(c)]<h[e.charAt(c+1)]?d-=h[e.charAt(c)]:d+=h[e.charAt(c)],c++;d+=h[e[c]];return d},binarySearchPosition:function(e,d){for(var c=0,
b=e.length-1,g;c<=b;)if(g=Math.floor((c+b)/2),e[g]<d)c=g+1;else if(e[g]>d)b=g-1;else return g;return b>=0?b:c},isValidRomanNumeral:function(e){return/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/.exec(e.toString().toUpperCase())?!0:!1}}}();
(function(){function h(b){function g(){return KindleReaderAnnotationManager.deferredInitialize(b.bookinfo.getBookInfoDfd(),b.moduleManager)}function a(){var a;return b.bookinfo.getBookInfoDfd().pipe(function(b){a=b;return a.getMetadata()}).pipe(function(c){var f=a.getContext(),g=a.getAsin();return c.headerMetadata&&(c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.COMIC||c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.CHILDREN)?$.Deferred().resolve():d.getSearchIndex({asin:g,
formatVersion:f.formatVersion,contentVersion:f.contentVersion,contentCache:b.contentCache,kcrFree:b.kcrFree})})}function f(){return b.bookinfo.getBookInfoDfd().pipe(c.getPageNumbers)}return{names:Object.freeze(e),getAnnotations:g,getSearchIndex:a,getPageNumbers:f,download:function(b){switch(b){case "annotations":return g();case "searchIndex":return a();case "pageNumbers":return f();default:return $.Deferred().reject("Unknown sidecar")}}}}var j={annotations:{},pageNumbers:{},searchIndex:{}},e={};Object.keys(j).forEach(function(b){j[b].name=
b;e[b]=b});var d,c;KindleModuleManager.define(Kindle.MODULE.SidecarManager,[Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager],function(b,g){d=b;c=g;return{create:h}})})();function AssertionError(h){Error.call(this,h)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleAuthor=function(){var h=["phd","md","sir"];return{getDisplayableString:function(j){for(var e="",d=j.length,c=0;c<d;c++){for(var b=j[c].split(","),g=[],a=[],f=0;f<b.length;f++){var k=$.trim(b[f]);h.indexOf(k.toLowerCase())>-1?g.push(k):a.unshift(k)}if(a.length===2){e+=a[0]+" "+a[1];for(b=0;b<g.length;b++)e+=", ",e+=g[b]}else e+=j[c];d>1&&(c===d-2?e+=" and ":c<d-2&&(e+=", "))}return e},getLegacyDisplayableString:function(h){for(var e="",d=h.length,c=0;c<d;c++)e+=h[c],c<d-1&&(e+="; ");return e}}}(),
KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function h(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:h,useCSSRegions:function(){return h()}}}(),KindleHostDeviceDetector=
function(){function h(){return navigator.platform.indexOf("iPad")!==-1}function j(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function e(){return h()||j()||b()}function d(){var a=-1;e()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function b(){return navigator.userAgent.indexOf("Cloud9")!==-1}function g(){return navigator.userAgent.indexOf("MSAppHost")!==
-1}function a(){return g()&&f()}function f(){return!!/arm/i.test(navigator.cpuClass)}function k(){return c()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function m(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function l(){return"standalone"in navigator&&navigator.standalone}function o(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function q(){return window.navigator.msMaxTouchPoints>=
1}return{isiOS:e,isiPad:h,isiPhone:j,isiOS_4x:function(){return(h()||j())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(h()||j())&&parseInt(d(),10)>=5},isiOS_7x:function(){return(h()||j())&&parseInt(d(),10)===7},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:c,hasHangingDbPrompt:function(){if(!c())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:function(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!b?!1:!a?!0:Number(b[1])>=Number(a)},isMetro:g,isMetroArm:a,isMetroSnappedView:function(){return g()&&window.outerWidth===320},isIE:m,isIE10:function(){return m()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return m()&&navigator.userAgent.indexOf("Trident/7.0")!==-1},isArm:f,isCloud9:b,isTablet:function(){return h()||g()},isOnline:k,isNetworkAvailable:function(){if(!k())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},
timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!k())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome},isiOSAppMode:l,isChromeApp:o,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return l()||o()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!==
"undefined"},isLocalStorageEnabled:function(){if(!window.localStorage)return!1;try{window.localStorage.setItem("testLocalStorage","1"),window.localStorage.removeItem("testLocalStorage")}catch(a){return!1}return!0},hasArrayLikeApply:function(){return!e()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:q,isTouchDevice:function(){return e()||
q()},getDevicePlatform:function(){return h()?"iPad":j()?"iPhone":b()?"otter":a()?"metroArm":g()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return h()&&KindleHostPadDetector.isPad1(l())||a()},getDeviceType:function(){return g()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return g()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:d,getOSMinorVersion:function(){var a=-1;e()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},
getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(h){if(window.localStorage.getItem("definitelyNotPad1"))return!1;var j=0,e=1E3,d=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>j?j=c:c<e&&(e=c),d+=c;j=d/3;if(j>=200&&h)return!0;if(j>=100&&!h)return!0;window.localStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function h(h,e){for(var d in e)if(e.hasOwnProperty(d)&&typeof h[d]!==typeof e[d])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},
removeBook:function(){}},IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:h,assertImplements:function(j,
e){h(j,e)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function h(a){var b=[],c;for(c in a){var g=a[c].entry;g.guid=g.guid||g.refEmId;delete g.refEmId;g&&b.push(g)}return b}function j(a){var f=[],g;for(g in a)f.push({entry:a[g]});return b.getAppDb().getTable(c).insertList(f)}function e(a){function c(){var o;e<a.length?(l=Math.min(e+100,a.length),o=Array.prototype.slice.call(a,e,l),e=l,g.updateAnnotations(h(o),KindleLocale.getLocalTimeOffset()).then(function(){b.getAppDb().deleteJournalEntries(o).then(c,
d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,e=0,l;c();return d.promise()}function d(){var a=new jQuery.Deferred;b.getAppDb().getTable(c).getRecord().then(function(b){b.length>0?e(b).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",b=null,g=null;return{initialize:function(){var a=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(d){g=d[KindleModuleManager.SERVICE_CLIENT];
b=d[KindleModuleManager.DB_CLIENT];a.resolve(c)},a.reject);return a.promise()},saveToJournal:function(a){var b=new jQuery.Deferred;j(a).then(function(){d().then(b.resolve,b.resolve)},b.reject);return b.promise()},uploadJournal:d}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return window.localStorage.getItem("kindleDeviceToken")},setDeviceToken:function(h){window.localStorage.setItem("kindleDeviceToken",
h)},clearDeviceTokenFromStorage:function(){window.localStorage.removeItem("kindleDeviceToken")}}}(),KindleLocale=function(){var h=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return h},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=function(h){function j(d){for(var c=0,b=0;b<d.length;b+=1)c+=d[b].end-d[b].start;return c}var e={};e.name=h;e.counters=null;e.subTimers=null;e.runs=[{start:(new Date).getTime(),end:null}];e.endTimer=function(){var d=this.runs[this.runs.length-
1];if(d.end===null)d.end=(new Date).getTime()};e.addCount=function(d,c){if(this.counters===null)this.counters={};this.counters[d]===void 0?this.counters[d]=c:this.counters[d]+=c};e.createSubTimer=function(d){if(this.subTimers===null)this.subTimers={};this.subTimers[d]===void 0?this.subTimers[d]=KindleMetricsProfiler(d):this.subTimers[d].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[d]};e.log=function(){this.logAsPercentageOfTime("",j(this.runs))};e.logAsPercentageOfTime=function(d,
c){var b=d+":"+this.name,g;j(this.runs);for(g in this.counters);for(g in this.subTimers)this.subTimers[g].logAsPercentageOfTime(b,c)};return e},KindleRemoteClient=function(){return{getStoreURL:function(){var h=new jQuery.Deferred;$.get("/remote/store").then(function(j){(j=j.url)?h.resolve(j):h.reject()},h.reject);return h.promise()},uploadFeedback:function(h){if(!h)return(new $.Deferred.reject).promise();var j=KindleLibrarySetting.getSettings(),j={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),
UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,AppCached:!!window.localStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:j.sortParam,LibraryView:j.viewState};return function(e){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(d){try{var c=
d.getAppDb(),b=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),g=c.getAllBooks();e.info.OfflineStorageEnabled=!!d.bookDbEnabled();return $.when(b,g)}catch(a){return $.Deferred.reject()}}).pipe(function(d,c){$.extend(e.info,{TotalBookCount:c.length,TotalBookDownloaded:d.length})}).pipe(function(){return e},function(){return $.Deferred().resolve(e)})}({version:KindleVersion.getVersionString(),message:h.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:j}).pipe(function(e){e=
{url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(e)};return $.ajax(e)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(h){return ResourceBundle.getLocalizedString(h)})}}}(),KindleUserAgentMetricsInfo=function(){function h(){function a(){var a=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(a)return a[1]}var b;if(!(b=function(){var a;if(["ipad","iphone"].indexOf(e)!==-1&&(e="ios",
(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var c;KindleHostDeviceDetector.isIE()&&(c=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");b=c||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return b}var j,e,d,c,b,g={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!j){e=GoogleUserAgent.browserName.toLowerCase();d=h();a:{if(d){var a=/^0*([0-9]+)/.exec(d);if(a&&a.length>=
2){c=parseInt(a[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+d)}c=void 0}b="undefined"===typeof c?"other":g[e]?[e,c].join("@"):"other";j=!0}return b}}}(),KindleVersion=function(){var h=null,j=null;return{getMetricsVersionString:function(){j||(j=parseInt("010600527".slice(0,2),10),j+=".",j+=parseInt("010600527".slice(2,4),10),j+=".",j+=parseInt("010600527".slice(4,6),10));return j},getVersionString:function(){h||(h=parseInt("010600527".slice(0,2),10),h+=".",h+=parseInt("010600527".slice(2,
4),10),h+=".",h+=parseInt("010600527".slice(4,6),10),h+=".",h+=parseInt("010600527".slice(6),10));return h},getVersionNumber:function(){return Number("010600527")},parseVersionString:function(e){return e&&(e=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(e))?Number(e[1])*1E7+Number(e[2])*1E5+Number(e[3])*1E3+Number(e[4]):NaN}}}(),KindleReaderArrhythmicHeartBeatHandler=function(){function h(){return o!==void 0}function j(){}function e(){}function d(){c();navigator.onLine&&(l=setTimeout(b,f))}function c(){clearTimeout(l);
clearTimeout(o)}function b(){var a=m();u&&(q?q:KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT)).stillReading({asin:n,position:a,positionType:r,localTimeOffset:w,countryCode:z,refEmId:s,kindleSessionId:t}).then(j,e);l=void 0;navigator.onLine&&(o=setTimeout(g,k))}function g(){o=void 0}function a(){clearTimeout(l);l=void 0;clearTimeout(o);r=s=n=o=void 0}var f=5E3,k=6E5,m,l,o,q,n,r,s,t,u,z="US",w=-(new Date).getTimezoneOffset();return{onReadingStart:function(c,f,g,k,e,l){if(c!==
n)return h()&&a(),n=c,r=l,s=f,t=g,m=k,u=e,b(),d},onReadingEnd:a,isStillReading:h,setNetworkModule:function(a){q=a},handleHeartBeat:d,cancelCurrentHeartBeat:c}}(),KindleReaderControls=function(){function h(c){return function(){var b=c.attr("data-action");b&&!c.hasClass(d)&&KindleEventBroker.fire(b)}}function j(c){return function(b){switch(b.keyCode||b.which){case 32:if(b.shiftKey||b.ctrlKey||b.metaKey)break;(b=c.attr("data-action"))&&!c.hasClass(d)&&KindleEventBroker.fire(b);break;case 13:(b=c.attr("data-action"))&&
!c.hasClass(d)&&KindleEventBroker.fire(b)}}}var e=[],d="disabled";return{DataActions:Object.freeze({Close:"reader_close",Back:"reader_back",ShowGoTo:"reader_show_goto",ShowSettings:"reader_show_settings",Bookmark:"reader_bookmark",ShowNotes:"reader_show_notes",Sync:"reader_sync",PinToStart:"reader_pin_metro",OpenFullKCR:"reader_open_full_kcr",BuyFullBook:"reader_buy_full_book",ImmersiveIcon:"immersive_icon"}),registerComponent:function(c){var b=c.find("[data-action]");c.attr("data-action")&&b.push(c);
for(var g=0;g<b.length;g++){var a=$(b[g]);a.tap(h(a));a.on("keyup",j(a))}e.push(c)},setDataActionEnabled:function(c,b){for(var g,a=0;a<e.length;a++)g=e[a].find("[data-action='"+c+"']"),g.toggleClass(d,!b)},setDataActionVisible:function(c,b){for(var g,a=0;a<e.length;a++)g=e[a].find("[data-action='"+c+"']"),g.toggle(b)},clickElementWithID:function(c){var c=$("#"+c),b=c.attr("data-action");c&&b&&KindleEventBroker.fire(b)}}}(),KindleReaderLPRManager=function(){function h(c){d.getAppDb().updateLastReadTime(j,
(new Date).getTime(),c,function(){})}var j,e,d;return{NEVER:-1,initialize:function(c){var b=new jQuery.Deferred,g=this;j=c;KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){d=a;d.getAppDb().getBook(j,function(a){e={lastPositionRead:a.lastPositionRead,lastTimeRead:a.lastTimeRead?a.lastTimeRead:-1,lastSyncTime:a.lastFPRSyncTime};b.resolve(g)})});return b.promise()},clear:function(){e=j=void 0},getLastPositionRead:function(){return e.lastPositionRead},onReadingStart:function(c,
b,g,a){$.when(g.locationFromPosition(b),g.locationFromPosition(c.position)).done(function(f,g){g>f&&e.lastTimeRead!==-1&&c.syncTime!==e.lastSyncTime&&a({currentLocation:f,currentPosition:b,fprPosition:c.position,fprLocation:g,fprDevice:c.deviceName,fprDateTime:c.syncTime});h(c.syncTime)})},onPageChange:function(c){e.lastPositionRead=c;e.lastTimeRead=(new Date).getTime();d.getAppDb().updateLastPositionRead(j,e.lastPositionRead,e.lastTimeRead,function(b){function c(){window.location.reload(!0)}b&&(b.code===
Kindle.DB.DATABASE_ERR||b.code===Kindle.DB.SYNTAX_ERR)&&b.message.indexOf("no such table")>=0&&_metricsManager.emitNow("App::DatabaseGoneOnUpdateLPR",{breakdown:["Browser"]}).then(c,c)})},onReadingEnd:function(){j=null;e=void 0},getStartReadingPosition:function(){return e},updateFprSyncTime:function(c){c.syncTime!==e.lastSyncTime&&d.getAppDb().updateLastFPRSyncTime(j,c.syncTime,function(){})}}}(),KindleReaderMetrics=function(){function h(a){if(a)switch(a.toLowerCase()){case "loadfailure":return Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
case "abort":case "timeout":case "error":return Kindle.ERROR.OPEN_BOOK_NETWORK_ERROR;case "contentloaned":case "contentloanended":case "contentlicenseexceeded":case "contentunsupported":case "formatunsupported":case "contentnotowned":case "contentrentalexpired":case "sessionlimitexceeded":return Kindle.ERROR.OPEN_BOOK_CONTENT_UNAVAILABLE;case "geolocationnotallowed":return Kindle.ERROR.GEOLOCATION_NOT_ALLOWED;default:return Kindle.ERROR.OPEN_BOOK_UNKNOWN}}function j(){t||(t=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));
return t}var e=!1,d,c,b,g,a,f,k,m,l,o="",q=1,n,r=null,s=null,t;return{NEXT_PAGE:0,PREV_PAGE:1,startBookOpenTimer:function(){c=j().createTimer();return b=j().startMetrics("Reader::Open")},reportBookOpenSuccess:function(a){var f={breakdown:["Browser"]},g=[{name:"Library::ReaderOpen"+(a.bookType==="topaz"?"Topaz":"Mobi"),params:f},{name:"Library::ReaderOpen::"+a.bookType,params:f}];a.publisherBookType&&g.push({name:"Library::ReaderOpen::"+a.bookType+"::"+a.publisherBookType,params:f});a.isOnline||g.push({name:"Library::ReaderOpenOffline",
params:f});a.screenOrientation&&g.push({name:"Library::ReaderOpen::Orientation::"+a.screenOrientation});g.push({name:"Library::ReaderOpen::ContentType::"+a.contentType,params:f});a.contentType===Kindle.CONTENT_TYPE.EBSP&&(a.isOwned?g.push({name:"Library::ReaderOpen::ContentType::"+a.contentType+"::Owned",params:f}):g.push({name:"Library::ReaderOpen::ContentType::"+a.contentType+"::NotOwned",params:f}));c.emit(g);j().endMetrics(b);j().uploadMetrics()},reportBookOpenFailure:function(a){var f=[],g=h(a.errorCode);
f.push({name:"Library::ReaderOpenFail"});g&&(f.push({name:"Library::ReaderOpenFail::"+g}),g===Kindle.ERROR.OPEN_BOOK_CONTENT_UNAVAILABLE&&(f.push({name:"Library::ReaderOpenFail::"+g+"::"+a.errorCode}),a&&a.contentType===Kindle.CONTENT_TYPE.EBSP&&j().emit("zzz::SampleTitleNotAvailable::"+a.asin)));c.emit(f);j().modifyMetricsMethod(b,"Reader::OpenFail");j().endMetrics(b);j().uploadMetrics()},setBookType:function(a){o=a},setColumnCount:function(a){q=Number(a)||1},startGoToMetrics:function(){g=j().createTimer()},
endGoToMetrics:function(){g&&(g.emit("Reader::GoToPosition::"+o,{breakdown:["Browser"]}),g=null)},startPageTurnTimer:function(b,c){e||(e=!0,n=c,b===0&&!a?(a=j().createTimer(),d=b):b===1&&!f&&(f=j().createTimer(),d=b))},endPageTurnTimer:function(){e&&(d===0&&a?(a.emit([{name:"Reader::NextPage::"+o,params:{breakdown:["Browser"],submetrics:[{name:"columnCount",value:q}]}},{name:"Reader::NextPage:Version",params:{breakdown:["Version"]}}]),a=null,n&&j().emit("Reader::NextPage::"+n)):d===1&&f&&(f.emit("Reader::PrevPage::"+
o,{breakdown:["Browser"],submetrics:[{name:"columnCount",value:q}]}),f=null,n&&j().emit("Reader::PrevPage::"+n)),e=!1)},startSpinnerTimer:function(){e&&(d===0&&!k?k=j().createTimer():d===1&&!m&&(m=j().createTimer()))},endSpinnerTimer:function(){e&&(d===0&&k?(k.emit("Reader::NextPageSpinner::"+o,{breakdown:["Browser"],submetrics:[{name:"columnCount",value:q}]}),k=null):d===1&&m&&(m.emit("Reader::PrevPageSpinner::"+o,{breakdown:["Browser"],submetrics:[{name:"columnCount",value:q}]}),m=null))},reportContentNotAvailableMetrics:function(){j().emit("Reader::ContentNotAvailableOffline")},
reportTimeOutMetrics:function(){j().emit("Reader::PageTurnTimeOut::"+o)},reportBackButtonUsage:function(){j().emit("Reader::BackButton")},reportGoToAnnotationUsage:function(){j().emit("Reader::AnnotationsPane::GoToLocation")},reportScrubberUsage:function(){j().emit("Reader::ScrubberBar::GoToLocation")},notifyAnnotationsReady:function(){l=j().createTimer()},reportAnnotationsPaneOpened:function(){j().emit("Reader::OpenAnnotationsPane");l&&(l.emit("Reader::OpenAnnotationsPane::Time"),l=null)},reportFirefoxPromptingDialogOpen:function(){j().emit("Reader::FirefoxPrompting::Open")},
reportFirefoxPromptingDialogClose:function(a){var b="Reader::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";j().emit(b)},reportOrientationChange:function(a){s!==null?(clearTimeout(s),s=null,r.emit("Reader::OrientationChange::Unintentional::"+a),r=null):(r=j().createTimer(),s=setTimeout(function(){s=r=null;j().emit("Reader::OrientationChange::Intentional::"+a)},6E4))}}}(),KindleReaderOverlayManager=function(){function h(b){b.oldValue&&c.callEventListeners(d,{type:d,overlay:{type:j,start:b.oldValue.start,
end:b.oldValue.end}});b.newValue&&c.callEventListeners(e,{type:e,overlay:{type:j,start:b.newValue.start,end:b.newValue.end}})}var j="kindle.selection",e="overlayAdded",d="overlayRemoved",c=new ListenerManager,b;return{OVERLAY_ADDED_EVENT:e,OVERLAY_REMOVED_EVENT:d,SELECTION:j,SEARCH_RESULT:"kindle.search",addSearchResult:function(b){c.callEventListeners(e,{type:e,overlay:{type:"kindle.search",start:b,end:b}})},removeSearchResult:function(b){c.callEventListeners(d,{type:d,overlay:{type:"kindle.search",
start:b,end:b}})},setSelectionManager:function(c){b=c;b.addEventListener(b.SELECTION_CHANGED_EVENT,h)},getOverlaysInRange:function(c,a){var f=[],d=KindleReaderAnnotationManager.getAnnotationsInRange(c,a,KindleReaderAnnotationManager.NOTE),e=KindleReaderAnnotationManager.getAnnotationsInRange(c,a,KindleReaderAnnotationManager.HIGHLIGHT),h=b.getSelection(),o=ReaderSitbHighlight.get();d&&Array.prototype.push.apply(f,d);e&&Array.prototype.push.apply(f,e);h&&c<=h.end&&h.start<=a&&f.push({type:j,start:h.start,
end:h.end});if(o&&o.length>0)for(d=0;d<o.length;d++)f.push({type:"kindle.search",start:o[d],end:o[d]});return f},addEventListener:c.addEventListener,removeEventListener:c.removeEventListener}}(),KindleReaderSelectionRenderer=function(){var h=null,j=null,e=null,d=KindleHostDeviceDetector.isTouchDevice();return{initialize:function(c){e=c;d&&(h=document.createElement("DIV"),$(h).addClass("amazon-grabHandleBegin"),$(h).hide(),$("body").append(h),j=document.createElement("DIV"),$(j).addClass("amazon-grabHandleEnd"),
$(j).hide(),$("body").append(j))},getGrabHandleBegin:function(){return h},getGrabHandleEnd:function(){return j},setSelection:function(c){if(c.touchSelected&&d){var b=KindleListUtilities.first(e.getBounds(c.start)),c=KindleListUtilities.last(e.getBounds(c.end)),g=$("#kindleReader_content");h.style.top=KindleHostDeviceDetector.isMSTouchEnabledDevice()?b.bottom+g.offset().top+"px":b.top+g.offset().top+"px";h.style.left=b.left+g.offset().left+"px";j.style.top=c.bottom+g.offset().top+"px";j.style.left=
c.right+g.offset().left+"px";$(h).show();$(j).show()}},clearSelection:function(){d&&($(h).hide(),$(j).hide())}}}(),KINDLE_READER_SETTINGS_COLOR_MODE={WHITE:{id:"#kindleReader_controlPanel_colorWhite",persistedValue:0},SEPIA:{id:"#kindleReader_controlPanel_colorSepia",persistedValue:1},BLACK:{id:"#kindleReader_controlPanel_colorBlack",persistedValue:2}},KINDLE_READER_SETTINGS_FONT_SIZE={XSMALL:{id:"#kindleReader_controlPanel_xSmallFont",size:14},SMALL:{id:"#kindleReader_controlPanel_smallFont",size:16},
MEDIUM:{id:"#kindleReader_controlPanel_mediumFont",size:20},LARGE:{id:"#kindleReader_controlPanel_largeFont",size:28},XLARGE:{id:"#kindleReader_controlPanel_xLargeFont",size:44}},KINDLE_READER_SETTINGS_GLYPH_SCALE={14:1,16:1.25,20:1.5,28:2,44:3},KINDLE_READER_SETTINGS_MARGIN={XSMALL:{id:"#kindleReader_controlPanel_xSmallMargin",size:0},SMALL:{id:"#kindleReader_controlPanel_smallMargin",size:10},MEDIUM:{id:"#kindleReader_controlPanel_mediumMargin",size:18},LARGE:{id:"#kindleReader_controlPanel_largeMargin",
size:20},XLARGE:{id:"#kindleReader_controlPanel_xLargeMargin",size:22}},KINDLE_READER_SETTINGS_COLUMN_MODE={OFF:{id:"#kindleReader_controlPanel_columnButton_off",persistedValue:"true"},ON:{id:"#kindleReader_controlPanel_columnButton_on",persistedValue:"false"}},KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE={OFF:{id:"#kindleReader_controlPanel_showLocationButton_off",persistedValue:"false"},ON:{id:"#kindleReader_controlPanel_showLocationButton_on",persistedValue:"true"}},KindleReaderSettings=function(){function h(){var J,
O,C,E,N,P,S,T,Q,Y,W,ia,ba;this.copy=function(a){J=a.getFontSize();O=a.getMargin();this.setColorMode(a.getColorMode());ia=a.getShowColumns();ba=a.getShowLocations()};this.reset=function(){J=j;O=d;this.setColorMode(c);ia=b;ba=g};this.getFontSize=function(){return J};this.getGlyphScale=function(){return KINDLE_READER_SETTINGS_GLYPH_SCALE[J]};this.setFontSize=function(a){J=a};this.getMargin=function(){return O};this.setMargin=function(a){O=a};this.getLineHeight=function(){return e};this.getBGColor=function(){return E};
this.getFGColor=function(){return N};this.getBodyColor=function(){return P};this.getTitleColor=function(){return S};this.getHighlightColor=function(){return T};this.getSearchBGColor=function(){return Q};this.getSearchBorderColor=function(){return Y};this.getSelectionColor=function(){return selectionColor};this.getColorMode=function(){return C};this.getInsertBGColor=function(){return W};this.setColorMode=function(b){b===KINDLE_READER_SETTINGS_COLOR_MODE.WHITE?(E=a,N=f,P=q,S=n,T=k,selectionColor=m,
W=r,Q=l,Y=o):b===KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA?(E=s,N=t,P=G,S=F,T=u,selectionColor=z,W=A,Q=w,Y=y):b===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK&&(E=x,N=B,P=K,S=M,T=v,selectionColor=I,W=H,Q=L,Y=D);C=b};this.getShowColumns=function(){return ia};this.setShowColumns=function(a){ia=a};this.getShowLocations=function(){return ba};this.setShowLocations=function(a){ba=a};this.save=function(){try{window.localStorage.setItem("KindleReaderSettings.fontSize",J),window.localStorage.setItem("KindleReaderSettings.margin",
O),window.localStorage.setItem("KindleReaderSettings.colorMode",C.persistedValue),window.localStorage.setItem("KindleReaderSettings.showColumns",ia),window.localStorage.setItem("KindleReaderSettings.showLocations",ba)}catch(a){}};this.load=function(){window.localStorage.getItem("KindleReaderSettings.fontSize")&&(J=parseInt(window.localStorage.getItem("KindleReaderSettings.fontSize"),10));window.localStorage.getItem("KindleReaderSettings.margin")&&(O=parseInt(window.localStorage.getItem("KindleReaderSettings.margin"),
10));if(window.localStorage.getItem("KindleReaderSettings.colorMode")){var a=parseInt(window.localStorage.getItem("KindleReaderSettings.colorMode"),10),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)KINDLE_READER_SETTINGS_COLOR_MODE[b].persistedValue===a&&this.setColorMode(KINDLE_READER_SETTINGS_COLOR_MODE[b])}window.localStorage.getItem("KindleReaderSettings.showColumns")&&(ia=window.localStorage.getItem("KindleReaderSettings.showColumns")==="false"?"false":"true");window.localStorage.getItem("KindleReaderSettings.showLocations")&&
(ba=window.localStorage.getItem("KindleReaderSettings.showLocations")==="false"?"false":"true")};this.equal=function(a){return a?a instanceof h?this.getFontSize()===a.getFontSize()&&this.getMargin()===a.getMargin()&&this.getColorMode()===a.getColorMode()&&this.getShowColumns()===a.getShowColumns()&&this.getShowLocations()===a.getShowLocations():!1:!1}}var j=KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,e=1.4,d=KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,c=KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,b=KINDLE_READER_SETTINGS_COLUMN_MODE.OFF.persistedValue,
g=KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE.ON.persistedValue,a="#ffffff",f="#111111",k="#fff5ad",m="#cdd0d4",l="#fffbde",o="#ccc9b2",q=a,n="#999999",r="#cccccc",s="#FBF0D9",t="#5F4B32",u="#fff5ad",z="#d7d0c0",w="#fef4b5",y="#cbc391",G=s,F="#84725B",A="#d8c69f",x="#000000",B="#FFFFFF",v="#60abeb",I="#6d6d6d",L="#1f384d",D="#366185",K=x,M="#999999",H="#333333";return h}(),KindleReaderZoomableManager=function(){function h(){b=KindleRenderer.getZoomableList();g=!!b;b&&b.length>0&&(a===d.PREV?(c=b.length-
1,b[c].activate()):a===d.NEXT&&(c=0,b[c].activate()),a=null)}function j(){g&&(b&&b.length>0&&b[c].deactivate(),c=null,g=!1)}function e(){b=null}var d={NEXT:"next",PREV:"prev"},c=null,b=null,g=!1,a=null;return{activateZoomableAtPosition:function(a,d){var e=KindleRenderer.getZoomableAt(a,d);j();if(e&&e.activate){b||(b=KindleRenderer.getZoomableList(),g=!!b);a:{for(var h=0;h<b.length;h++)if(b[h].isSame(e)){c=h;break a}c=void 0}b[c].activate();g=!0}},gotoNextZoomable:function(){function f(){e();if(KindleRenderer.hasNextScreen())a=
d.NEXT;KindleReaderUI.nextPage()&&h()}b&&(b.length===0?f():(b[c].deactivate(),c<b.length-1?b[++c].activate():f()))},gotoPreviousZoomable:function(){function f(){e();if(KindleRenderer.hasPreviousScreen())a=d.PREV,KindleReaderUI.prevPage()&&h()}b&&(b.length===0?f():(b[c].deactivate(),c>0?b[--c].activate():f()))},isZoomed:function(){return g},activateZoomableOnPageTurn:h,deactivateZoomable:j,clearZoomables:e}}(),KindleReaderClippingManager=function(){function h(j,e,d,c,b){for(var g=!0;g;){if(e<=0){b.resolve(c+
"...");return}g=j.getItem();if(g.pos>d){b.resolve(c);return}e--;c+=g.text;g=j.next()}j.getLoadingDfd().then(function(a){a?h(j,e,d,c,b):b.resolve(c)},b.reject)}return{getSelectedText:function(j){var e=KindleReaderUI.getSelection();if(!e)return(new jQuery.Deferred).reject().promise();var d=$.Deferred(),c=KindleRenderer.createWordIterator(),b,g=$.Deferred();j?(b=$.Deferred(),c.gotoPosition(e.start).then(function(){h(c,j,e.end,"",b)},b.reject),b.then(function(){var a=c.getItem().pos;g.resolve((a-e.start)/
KindleReaderUI.getMaxPosition()*100)},g.reject)):(b=c.getText(e.start,e.end),g.resolve((e.end-e.start)/KindleReaderUI.getMaxPosition()*100));$.when(b,g).then(function(a,b){d.resolve({text:a,percent:b})},d.reject);return d.promise()}}}(),KindleSelectionEvents=function(){function h(a){if(!a.pageX&&!a.pageY){var b=a.target.getBoundingClientRect();return{x:b.left+a.clientX,y:b.top+a.clientY}}return{x:a.pageX,y:a.pageY}}function j(a){if(!s&&!t&a.which!==3){var b=h(a),b=G(b.x,b.y,F);B=!1;b>=0&&(u=!0,y=
w=!1,z=b,A.setSelection(null),a.preventDefault())}}function e(a){if(u&&z&&a.which!==3){var b=h(a);u=!1;w&&A.getSelection()&&(b=G(b.x,b.y),A.setSelection({start:Math.min(z,b),end:Math.max(z,b)}),A.processSelection());a.stopPropagation()}w=!1}function d(a){w=!0;if(u&&z){var b=h(a),b=G(b.x,b.y);A.setSelection({start:Math.min(z,b),end:Math.max(z,b)});y=!0}else y=!1;a.stopPropagation()}function c(a){if(x)return!1;var b=h(a),b=G(b.x,b.y,F);b>=0&&(A.setSelection({start:b,end:b}),A.processSelection(),a.stopPropagation())}
function b(){y||(A.setSelection(null),B=!1)}function g(a){s=!0;t=!1;z=A.getSelection().end;a.stopPropagation();return!1}function a(a){s=!1;t=!0;z=A.getSelection().start;a.stopPropagation();return!1}function f(){!s&&!t&&A.setSelection(null)}function k(a){A.getSelection()&&(A.processSelection(),t=s=!1,z=null,a.stopPropagation())}function m(a){function b(){var c=A.getSelection(),f;a.originalEvent&&a.originalEvent.touches?f=G(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY):(f=h(a),
console.log("move:"+f.x+","+f.y),f=G(f.x,f.y));s?A.setSelection({start:Math.min(z,f),end:c.end,touchSelected:!0}):t&&A.setSelection({start:c.start,end:Math.max(z,f),touchSelected:!0},!0)}if(z&&(s||t))setTimeout(b,10),a.stopPropagation()}function l(a){var b=G(a.startX,a.startY,F);b>=0&&(A.setSelection({start:b,end:b,touchSelected:!0}),A.processSelection(),y=!0,a.stopPropagation&&a.stopPropagation())}function o(){if(!this.isTouchEvent||B)B=!1;else{var a=G(this.x,this.y,F);a>=0&&(A.setSelection({start:a,
end:a,touchSelected:!0}),A.processSelection(),B=y=!0)}}function q(a,b){for(var c=a.length,f=0;f<c;f+=1){var g=a[f],d=$(g).offset();if(d.top-10<b.y&&b.y<d.top+$(g).height()+10&&d.left-10<b.x&&b.x<d.left+$(g).width()+10)return!0}return!1}function n(a){return function(b){if(b.pointerType===b.MSPOINTER_TYPE_MOUSE||b.pointerType===b.MSPOINTER_TYPE_PEN)x=!1,a(b)}}function r(a){return function(b){b.pointerType===b.MSPOINTER_TYPE_TOUCH&&(x=!0,a(b))}}var s=!1,t=!1,u=!1,z,w=!1,y=!1,G,F=225,A,x=!1,B=!1;return{initialize:function(u){G=
u.getBookPositionAt;A=u.selectionStateManager;KindleHostDeviceDetector.isMSTouchEnabledDevice()?(u.mouseDownEventSource&&($(u.mouseClickOutsideEventSource).click(b),$(u.mouseDownEventSource).dblclick(c),u.mouseEventSource.addEventListener("MSPointerMove",n(d)),u.mouseEventSource.addEventListener("MSPointerDown",n(function(a){!q($(".ui-dialog:visible"),h(a))&&j(a)})),u.mouseEventSource.addEventListener("MSPointerUp",n(function(a){!q($(".ui-dialog:visible"),h(a))&&e(a)}))),u.touchEventSource&&(u.selectionHandleLeft.addEventListener("MSPointerDown",
r(g)),u.selectionHandleRight.addEventListener("MSPointerDown",r(a)),u.selectionHandleLeft.addEventListener("MSPointerUp",r(k)),u.selectionHandleRight.addEventListener("MSPointerUp",r(k)),u.touchEventSource.addEventListener("MSPointerMove",r(m)),u.touchEventSource.addEventListener("MSPointerUp",r(k)),u.touchEventSource.addEventListener("MSPointerDown",r(f)),$(u.touchEventSource).tap(o))):(u.mouseDownEventSource&&($(u.mouseDownEventSource).dblclick(c),$(u.mouseDownEventSource).mousedown(j),$(u.mouseEventSource).mousemove(d),
$(u.mouseEventSource).mouseup(e),$(u.mouseClickOutsideEventSource).click(b)),u.touchEventSource&&($(u.selectionHandleLeft).bind("touchstart",g),$(u.selectionHandleLeft).bind("touchmove",m),$(u.selectionHandleLeft).bind("touchend",k),$(u.selectionHandleRight).bind("touchstart",a),$(u.selectionHandleRight).bind("touchmove",m),$(u.selectionHandleRight).bind("touchend",k),KindleDebug.log("binding touchstart & tapHold..."),$(u.touchEventSource).bind("touchstart",f),$(u.touchEventSource).tapHold(l),KindleDebug.log("...bound")))},
resetTap:function(){B=!1}}}();KindleSelectionHelper=function(h){return{getBookPositionAt:function(j,e,d){var c=h(),d=d||Infinity,b=-1,g;for(g in c)for(var a=c[g],f=0;f<a.length;f++){var k;k=a[f];var m=void 0,l=void 0,m=j<k.left?k.left-j:j<k.right?0:j-k.right,l=e<k.top?k.top-e:e<k.bottom?0:e-k.bottom;k=m*m+l*l;if(k<d&&(d=k,b=g,k<=0))break}return+b},getBounds:function(j){return h()[j]||null}}};
var KindleSelectionStateManagerFactory=function(){function h(){return e?{start:e.start,end:e.end,touchSelected:e.touchSelected}:null}var j=ListenerManager(),e=null,d=0;j.setEventProperties("selectionChanged",{vetoable:!0});return{SELECTION_CHANGED_EVENT:"selectionChanged",PROCESS_SELECTION_EVENT:"processSelection",addEventListener:j.addEventListener,setSelection:function(c){if(!d&&(!c||c.start&&c.end)){if(c&&(c.start=Number(c.start),c.end=Number(c.end),c.start>c.end)){var b=c.start;c.start=c.end;
c.end=b}c===null&&e===null||c!==null&&e!==null&&c.start===e.start&&c.end===e.end||(b=h(),j.callEventListeners("selectionChanged",{type:"selectionChanged",oldValue:b,newValue:c})&&(e=c))}},processSelection:function(){d||e&&j.callEventListeners("processSelection",{type:"processSelection",selection:h()})},getSelection:h,enable:function(){d--;KindleAssert(d>=0,"Mismatched selection disable/enable")},disable:function(){d++;e=null}}},KindleUserLocationConverter;
KindleUserLocationConverter=function(){function h(){return{locationFromPosition:function(b){return $.Deferred().resolve(Math.floor(b*2/300+1))},positionFromLocation:function(b){b*=100;b<100&&(b=100);return $.Deferred().resolve(Math.floor((b-100)*3/2))},flavor:function(){return d}}}function j(){return{locationFromPosition:function(c){return $.Deferred().resolve(Math.floor((c*b+100)/100))},positionFromLocation:function(c){c*=100;c<100&&(ASSERT(0),c=100);return $.Deferred().resolve(Math.floor((c-100)/
b))},flavor:function(){return c}}}function e(b){function a(a){if(u[a])return u[a].deferred;var b,g,d;b=j(a);b.done(c);z++;u[a]={deferred:b,cacheEntrySeq:z};if(z>w){a=z;for(g in u)if(u[g].cacheEntrySeq<a)d=g,a=u[g].cacheEntrySeq;a!==z&&delete u[d]}return b}function c(a){var b=a.metadata.id;if(!t[b]||!t[b].firstPos){t[b]=t[b]||{};var f,g,d=a.metadata.id;try{$.isArray(a.locations)?(f=a.locations[0],g=a.locations[a.locations.length-1]):(f=a.locations[d*r+h],g=a.locations[Math.min((d+1)*r+h-1,n)])}catch(k){f=
Number.MAX_VALUE;g=-1;for(var e in a.locations)a.locations.hasOwnProperty(e)&&a.locations[e]&&(f=Math.min(a.locations[e],f),g=Math.max(a.locations[e],g))}a={firstPos:f,lastPos:g};if(!t[b].lastPos)t[b].lastPos=a.lastPos;if(!t[b].firstPos&&(t[b].firstPos=a.firstPos,b>0))t[b-1]=t[b-1]||{},t[b-1].lastPos=a.firstPos-1}}function d(a){var b,c,f=a.metadata.id;try{$.isArray(a.locations)?(b=0,c=a.locations.length-1,offset=f*r+h):(b=f*r+h,c=Math.min((f+1)*r+h-1,n),offset=0)}catch(g){b=Number.MAX_VALUE;c=-1;
for(var k in a.locations)a.locations.hasOwnProperty(k)&&a.locations[k]&&(b=Math.min(k,b),c=Math.max(k,c))}return{firstIx:b,lastIx:c,offset:offset}}function e(b){function c(f,g){if(f===g)a(f).then(k.resolve,k.reject);else{var d=Math.floor((f+g)/2);d===f&&g===f+1&&(d=g);a(d).done(function(a){var e=t[a.metadata.id];e.firstPos>b?c(f,d-1):e.lastPos>=b?k.resolve(a):c(d,g)}).fail(k.reject)}}var f,g,d;g=0;d=Math.floor((n-h)/r);for(f=0;f<t.length;f++)if(t[f])if(t[f].firstPos){if(t[f].firstPos<=b&&t[f].lastPos>=
b)return a(f);if(t[f].firstPos>b){d=f-1;break}else g=f}else if(t[f].lastPos){if(t[f].lastPos===b)return a(f);if(t[f].lastPos>b){d=f;break}else g=f+1}var k=new jQuery.Deferred;c(g,d);return k.promise()}var h=1,o=b.minPosition,q=b.maxPosition,n=b.locationsInfo.numOfLocations,r=b.locationsInfo.mapSize,j=b.mapGetter,t=[],u={},z=1,w=Math.max(5,Math.floor(2E4/r));return{locationFromPosition:function(a){var b=new jQuery.Deferred;e(a).done(function(c){function f(c,d,k){var e=Math.floor((c+d)/2);k[e]===a?
b.resolve(e+g.offset):k[e]>a?f(c,e-1,k):e===d||k[e+1]>a?b.resolve(e+g.offset):f(e+1,d,k)}var g=d(c);f(g.firstIx,g.lastIx,c.locations)}).fail(function(){a<=o?b.resolve(h):a>=q?b.resolve(n-1+h):b.resolve(Math.floor((a-o)/(q-o)*(n-h)+h))});return b},positionFromLocation:function(b){var c=new jQuery.Deferred;a(Math.floor((b-h)/r)).done(function(a){var f,g;try{$.isArray(a.locations)?(f=(b-h)%r,g=a.locations[f]):g=a.locations[b]}catch(d){g=1}c.resolve(g)}).fail(function(){b<=h?c.resolve(o):b>=n-1+h?c.resolve(q):
(p=(b-h)/n,c.resolve(Math.floor(p*(q-o)+o)))});return c.promise()}}}var d="mobi",c="topaz",b=3;return{MOBI_FLAVOR:d,TOPAZ_FLAVOR:c,mobiLocationConverter:h,topazLocationConverter:j,getLocationConverter:function(b,a){return b==="topaz"?j():b==="mobi8"?e(a):h()}}}();
var ReaderAnnotationsDisplay=function(){function h(b){KindleReaderAnnotationsPane.loadAnnotations(b,d,function(b){e.goToPosition(b.start);KindleReaderMetrics.reportGoToAnnotationUsage()},function(b){j.deleteAnnotations([b]).done(e.onAnnotationsUpdated)},function(b,a){b?j.modifyNote(a.start,a.position,b):j.deleteAnnotations([a]).done(e.onAnnotationsUpdated)})}var j,e,d,c=KindleHostDeviceDetector.isMetro();return{initialize:function(b){e=b.readerControls;d=b.pageLabelConverter;j=b.annotationManager},
show:function(b,g){KindleReaderMetrics.reportAnnotationsPaneOpened();var a=j.getAllAnnotations(),f=j.getLastUpdateTime();c?e.hostShowAnnotations({annotations:a,lastUpdateTime:f,position:b,filter:g}):(KindleReaderAnnotationsPane.open(),h(a),KindleReaderAnnotationsPane.scrollToPosition(b))}}}(),ReaderSitbHighlight=function(){function h(){var c;if(j){for(var b=0;b<j.length;b++)c=j[b],e.removeSearchResult(c);j=null}}var j=null,e=null,d;return{initialize:function(c){e=c},get:function(){return j},set:function(c){h();
j=c;d=!0},clear:h,render:function(){if(j&&d){for(var c=0;c<j.length;c++)pos=j[c],e.addSearchResult(pos);d=!1}}}}(),ReaderSitbManager=function(){function h(){d++;a=g=b=null}function j(e){function h(a,b){if(b===d)if(a>=o.length)KindleReaderSitbPane.setViewState(c.Complete,o.length>0?o.length-1:0);else{var f=o[a];f.isMarker?(KindleReaderSitbPane.addLocationMarker(f),h(a+1,b)):f.getContext("mark").then(function(a){b===d&&KindleReaderSitbPane.addItem({context:a.context,location:a.location,position:f.positions[0],
searchHighlights:f.positions,pageNumber:a.pageNumber})}).always(function(){h(a+1,b)})}}k.emit("SITB::Search");var o=e&&e.results||[];e&&e.isCached&&k.emit("SITB::SearchCached");o.length<=0&&f.emit("SITB::NoResults");KindleReaderSitbPane.setViewState(c.Searching);(function(){var c=0,f,d={isMarker:!0,position:b,location:g,pageNumber:a};if(o.length!==0){for(;c<o.length;){f=o[c].positions[0];if(b<=f){o.splice(c,0,d);return}c++}o.push(d)}})();h(0,++d)}$.Deferred();var e=null,d=0,c,b,g,a,f,k;return{initialize:function(a){c=
KindleReaderSitbPane.States;f=a},searchContent:function(d){function l(){e.search(d.queryText).then(j,KindleReaderSitbPane.showErrorMessage)}function o(a){var b=SearchContextProvider.getContextProvider({pageLabelConverter:d.pageLabelConverter,locationConverter:d.locationConverter}).getContext;e=SitbHelperFactory(SearchTermStemmer,b).create(a);e===Kindle.SITB.LANGUAGE_NOT_SUPPORTED?KindleReaderSitbPane.showErrorMessage(Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED):e===Kindle.SITB.LANGUAGE_UNDEFINED?(KindleReaderSitbPane.showErrorMessage(Kindle.ERROR.SITB_LANGUAGE_UNDEFINED),
f.emit("SITB::LanguageUnd")):l()}function q(a){a==="finished"&&r.emit("SITB::AwaitingIndex")}function n(a){a===Kindle.ERROR.SITB_OFFLINE?f.emit("SITB::NoIndexOffline"):a===Kindle.ERROR.SITB_COMMON_ERROR?f.emit("SITB::IndexFailure"):a===Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE&&f.emit("SITB::IndexNotAvailable");KindleReaderSitbPane.showErrorMessage(a)}k=f.createTimer();var r=f.createTimer();KindleReaderSitbPane.show(d.goToPosition).done(h);KindleReaderSitbPane.setViewState(c.Indexing);b=d.curPosition;
g=d.curLocation;a=d.curPageNumber;e?l():d.bookInfo.getSearchIndex(d.asin).done(o).progress(q).fail(n)}}}();
function ReaderOptions(h){if(!this instanceof ReaderOptions)return new ReaderOptions(h);Object.defineProperty(this,"PORTRAIT",{value:"portrait"});Object.defineProperty(this,"LANDSCAPE",{value:"landscape"});Object.defineProperty(this,"AUTO",{value:"auto"});var j=!0,e=!0,d=!0,c=!0,b=this.AUTO,g=!0,a=!0,f=KindleDeviceCapabilities.multiColumnMode()?2:1,k=!0,m=!0,l=KindleDeviceCapabilities.searchInTheBook(),o=!0;Object.defineProperty(this,"bookmarks",{get:function(){return j},set:function(a){j=!!a},enumerable:!0});
Object.defineProperty(this,"annotations",{get:function(){return e},set:function(a){e=!!a},enumerable:!0});Object.defineProperty(this,"selection",{get:function(){return d},set:function(a){d=!!a},enumerable:!0});Object.defineProperty(this,"trackLpr",{get:function(){return c},set:function(a){c=!!a},enumerable:!0});Object.defineProperty(this,"fontSize",{get:function(){return g},set:function(a){g=!!a},enumerable:!0});Object.defineProperty(this,"margins",{get:function(){return a},set:function(b){a=!!b},
enumerable:!0});Object.defineProperty(this,"colors",{get:function(){return k},set:function(a){k=!!a},enumerable:!0});Object.defineProperty(this,"orientation",{get:function(){return b},set:function(a){if(a===this.PORTRAIT||a===this.LANDSCAPE||a===this.AUTO)b=a},enumerable:!0});Object.defineProperty(this,"columns",{get:function(){return f},set:function(a){a=Math.round(a);a>0&&(f=a)},enumerable:!0});Object.defineProperty(this,"viewSettings",{get:function(){return m},set:function(a){m=!!a},enumerable:!0});
Object.defineProperty(this,"searchable",{get:function(){return l},set:function(a){l=!!a},enumerable:!0});Object.defineProperty(this,"showTitle",{get:function(){return o},set:function(a){o=!!a},enumerable:!0});var h=h||{},q;for(q in h)h.hasOwnProperty(q)&&this.hasOwnProperty(q)&&(this[q]=h[q])}
var SearchContextProvider=function(){return{getContextProvider:function(h){function j(f){function d(a){var b;b="";var f=c?1:a.text.length;for(b=KindleStringUtilities.escapeForHTML(a.text);q<o.length&&o[q]<a.pos;)q++;return b=q<o.length&&o[q]>=a.pos&&o[q]<a.pos+f?e+b+h:b}var e,h,o=f.highlightPositions,q=0,n=f;n.context="";f.tagName?(e="<"+f.tagName,f.className&&(e+=' class="'+f.className+'"'),e+=">",h="</"+f.tagName+">"):e=h="";if(c)f.firstPosition=Math.max(Math.min.apply(null,f.highlightPositions)-
b,0),f.lastPosition=Math.max.apply(null,f.highlightPositions)+b;return a.gotoPosition(f.firstPosition,f.firstPosition+250).pipe(function(){function b(){var d;do if(d=a.getItem(),d.pos<=f.firstPosition){c.resolve();return}while(a.previous());a.getLoadingDfd().then(function(a){a?b():c.resolve()},c.reject)}var c=$.Deferred();b();return c.promise()}).pipe(function(){function b(){var g;do{g=a.getItem();if(g.pos>f.lastPosition){c.resolve(n);return}n.context+=d(g)}while(a.next());a.getLoadingDfd().then(function(a){a?
b():c.resolve(n)},c.reject)}var c=$.Deferred();b();return c.promise()}).pipe(function(){return g(f.highlightPositions[0]).pipe(function(a){n.location=a.loc;n.pageNumber=a.pageNumber;return n})})}function e(a){function b(){a.length===0?g.resolve(c):j(a.shift()).then(function(a){c.push(a);b()},g.reject)}var c=[],g=$.Deferred();b();return g.promise()}var d=h.locationConverter,c=d.flavor&&d.flavor()===KindleUserLocationConverter.TOPAZ_FLAVOR,b=c?15:100,g=h.pageLabelConverter,a;return{getContext:function(b){a=
a||KindleRenderer.createWordIterator();return $.isArray(b)?e(b):j(b)}}}}}(),SitbHelperFactory=function(h,j){function e(c){this.positions=c}function d(c){return c.every(function(b){return b.length>0})}e.prototype.getContext=function(c,b){var g=Math.max(Math.min.apply(null,this.positions)-100,0),a=Math.max.apply(null,this.positions)+100;return j({firstPosition:g,lastPosition:a,highlightPositions:this.positions,tagName:c,className:b}).pipe(function(a){return{context:a.context,location:a.location,pageNumber:a.pageNumber}})};
return{create:function(c){function b(a){var b=[];a.split(/\s+/).forEach(function(a){Array.prototype.push.apply(b,m.stem(a))});return b}function g(a){return c.getPositionsForWord(a).pipe(function(a){return a.positions})}function a(a){var b={},c=[],f=[],d=!0;a.forEach(function(a,e){d=d&&k[a];f.push($.when(k[a]||g(a)).pipe(function(f){b[a]=f;c[e]=f.slice(0)}))});return $.when.apply($,f).pipe(function(){k=b;return{results:c,isCached:!!d}},function(){return Kindle.ERROR.SITB_COMMON_ERROR})}function f(c){c=
b(c);return c.length<=0?$.Deferred().resolve([]):a(c).pipe(function(a){function b(a){return a[0]}function c(a,b,f){return b===0||f[b-1]<a}function f(a){a.shift()}function g(a){a[0]===l&&a.shift()}for(var k=a&&a.results||[],h=k.length*20,m=[],l;d(k);){var o=k.map(b),j=o.every(c),A=Math.max.apply(null,o);l=Math.min.apply(null,o);j&&A-l<=h?(k.forEach(f),m.push(new e(o))):k.forEach(g)}return{results:m,isCached:!(!a||!a.isCached)}})}var k={},m,l=c.getProperty("LanguageId");if(l==="und")return Kindle.SITB.LANGUAGE_UNDEFINED;
l&&(l=l.split("-")[0].split("_")[0].toLowerCase());m=h.getStemmer(l);return!m?Kindle.SITB.LANGUAGE_NOT_SUPPORTED:{search:f}}}},KindleCrypto=function(){return{decrypt:function(h,j,e){j=CryptoJS.enc.Base64.parse(j);e=CryptoJS.enc.Base64.parse(e);h=new Uint8Array(h);h=CryptoJS.lib.WordArray.create(h);h=CryptoJS.lib.CipherParams.create({ciphertext:h,algorithm:CryptoJS.algo.AES,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.PKCS5});return function(d){for(var c=d.words,b=d.sigBytes,g=new Uint8Array(b),a=0;a<
b;a++)d=c[a>>>2]>>>24-a%4*8&255,g[a]=d;return g}(CryptoJS.AES.decrypt(h,j,{iv:e}))}}}(),KindleZip=function(){if(zip.workerScriptsPath==="")zip.workerScriptsPath="./js/Worker/";zip.useWebWorkers=KindleHostDeviceDetector.areWebWorkersSupported()&&!KindleHostDeviceDetector.isiOS();if(!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(h,j){for(var e=new Uint8Array(this),h=h===void 0?0:h,j=j===void 0?e.length:j,d=new ArrayBuffer(j-h),c=new Uint8Array(d),b=0;b<c.length;b++)c[b]=e[b+h];return d};
return{unzip:function(h){var j=$.Deferred(),e=[],h=new zip.ArrayBufferReader(h);zip.createReader(h,function(d){d.getEntries(function(c){function b(a){return function(b){g++;e.push({filename:c[a].filename,data:b});g===c.length&&d.close(function(){j.resolve(e)})}}for(var g=0,a=0;a<c.length;a++)c[a].getData(new zip.ArrayBufferWriter,b(a))})},function(d){KindleDebug.error("createReader failed when trying to unzip: "+d);j.reject(d)});return j.promise()}}}(),KindleEventUtil=function(){return{preventKeyScroll:function(h){var h=
h.originalEvent&&h.originalEvent.detail?h.originalEvent.detail:h,j=h.target&&h.target.tagName!=="INPUT",e=[32,33,34,35,36,37,38,39,40].indexOf(h.which)>-1;j&&e&&h.preventDefault()}}}(),SearchTermStemmer=function(){function h(c){return d[c]&&!!ResourceBundle.getLocalizedSearchStopWords(c)}function j(c){var b=d[c].name,g=ResourceBundle.getLocalizedSearchStopWords(c).map(function(a){return KindleStringUtilities.replaceAccentedChars(a).replace(/[^A-Za-z0-9 .@'\-]/g,"")}),a=new Snowball(b);return{stem:function(b){var c=
[],d=[],b=b.toLowerCase();b.length>0&&(b.split("@").forEach(function(a){c=c.concat(a.split("-"))}),c.forEach(function(b){if(!(b.length<1)){var c=KindleStringUtilities.replaceAccentedChars(b).replace(/[^A-Za-z0-9 .@'\-]/g,"");g.indexOf(c)>=0||(a.setCurrent(b),a.stem(),b=a.getCurrent(),c=KindleStringUtilities.replaceAccentedChars(b),d.push(c))}}));return d}}}var e,d={en:{getStemmer:function(){var c=ResourceBundle.getLocalizedSearchStopWords("en");return{stem:function(b){var d=[],a=[],b=KindleStringUtilities.replaceAccentedChars(b).replace(/[^A-Za-z0-9 .@'\-]/g,
"").toLowerCase();b.length>0&&(b=b.split("@"),b.forEach(function(b){a=a.concat(b.split("-"))}),a.forEach(function(a){var b=a.length;b>1&&a.indexOf("'s",b-2)!==-1&&(a=a.substring(0,b-2));a=a.replace(/'/g,"");a=a.replace(/\.(?!\d)/g,"");a.length>0&&c.indexOf(a)===-1&&(a=PorterStemmer.stemmer(a,!1),d.push(a))}));return d}}}},da:{name:"danish"},de:{name:"german"},es:{name:"spanish"},fi:{name:"finnish"},fr:{name:"french"},hu:{name:"hungarian"},it:{name:"italian"},nl:{name:"dutch"},no:{name:"norwegian"},
pt:{name:"portuguese"},ro:{name:"romanian"},sv:{name:"swedish"},tr:{name:"turkish"}};return{getStemmer:function(c){var b=null,c=c||"UNKNOWN";if(h(c))if(d[c].getStemmer)b=d[c].getStemmer();else try{b=j(c)}catch(g){}e||(e=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER]));b?(e.emit("SITB::Language::Supported"),e.emit("SITB::Language::"+c.toUpperCase())):(e.emit("SITB::Language::Unsupported"),e.emit("SITB::Language::Unsupported::"+c.toUpperCase()));return b},isLanguageSupported:h}}(),
KindleErrorMap=function(){var h,j;return{getErrorText:function(e){if(!h)h={},h[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='"+Kindle.ExternalLinks.HelpIncreaseOfflineStorage+"' target='_blank'>",linkEnd:"</a>"}},h[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"},h[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",text:"k_L_openBookLoadFailure_Text"},
h[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"},h[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"},h[Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED]={title:"k_bookextras_open_failed_Error_Title",text:"k_bookextras_open_failed_Error_Text"},h[Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR]={title:"k_bookextras_offline_cache_failed_Error_Title",text:"k_bookextras_offline_cache_failed_Error_Text"},h[Kindle.ERROR.CONTENT_LOANED]=
{title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"},h[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"},h[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]={title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"},h[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"},
h[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"},h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"},h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}},
h[Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED]={title:"k_L_openBookAsinNotSpecified_Title",text:"k_L_openBookAsinNotSpecified_Text"},h[Kindle.ERROR.GEOLOCATION_NOT_ALLOWED]={title:"k_L_openBookGeoLocationNotAllowed_Title",text:"k_L_openBookGeoLocationNotAllowed_Text"},h[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"},h[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"},
h[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"},h[Kindle.ERROR.REVOKE_FAILED]={title:"k_L_revokeFailed_Title",text:"k_L_revokeFailed_Text"},h[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"},h[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"},h[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",
text:"k_store_open_failed_offline_Error_Text"},h[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"},h[Kindle.ERROR.SYNC_FAILED_OFFLINE]={title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"},h[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"},h[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"},h[Kindle.ERROR.NETWORK]=
{title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"},h[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"},h[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}},h[Kindle.ERROR.SITB_OFFLINE]={title:"k_R_sitb_error_offline_title",text:"k_R_sitb_error_offline_message"},h[Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED]=
{title:"k_R_sitb_error_language_not_supported_title",text:"k_R_sitb_error_language_not_supported_message"},h[Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE]={title:"k_R_sitb_error_index_not_available_title",text:"k_R_sitb_error_index_not_available_message"},h[Kindle.ERROR.SITB_COMMON_ERROR]={title:"k_R_sitb_error_common_title",text:"k_R_sitb_error_common_message"},h[Kindle.ERROR.SITB_LANGUAGE_UNDEFINED]={title:"k_R_sitb_error_language_undefined_title",text:"k_R_sitb_error_language_undefined_message"},j={},
j[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO,j[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO;KindleHostDeviceDetector.isMetro()&&(e=j[e]||e);(e=h[e])||(e=h[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(e.title,e.titleParams),text:ResourceBundle.getLocalizedString(e.text,e.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(h){h.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(h,
j,e){if(!h.length)return 0;for(var d=h.length-1,c=0,b=0,g=null,a=0;c<=d;)if(b=Math.floor((c+d)/2),g=h[b],a=0,e===void 0?g>j?a=1:g<j&&(a=-1):a=e(j,g),a>0)d=b-1;else if(a<0)c=b+1;else return b;return b===0||a<0?b:b-1},first:function(h){return h[0]},last:function(h){return h[h.length-1]}}}(),KindleOffline=function(){function h(b){var a=new jQuery.Deferred;setTimeout(a.resolve,b);return a.promise()}function j(b,a,f){if(b.indexOf(c)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var d=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),
e=d.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(b){b?(d.increaseSubCounter(e,"Continue",1),d.endMetrics(e),d=null,a()):(d.increaseSubCounter(e,"Cancel",1),d.endMetrics(e),d=null,f())})}else a()}function e(b,a){if(a){var c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),d="BookDownload::Fail::"+a,e=d;switch(b){case Kindle.ERROR.CANCELLED:e+="::Cancelled";break;case Kindle.ERROR.OUT_OF_SPACE:e+="::DBFull";break;case Kindle.ERROR.UNKNOWN_DB_ERROR:e+=
"::UnknownDBError";break;case Kindle.ERROR.NETWORK:e+="::Network";break;case Kindle.ERROR.TIMEOUT:e+="::Timeout";break;default:e+="::Unknown"}c.emit([{name:d,params:{breakdown:["Browser"]}},{name:e,params:{breakdown:["Browser"]}}])}}function d(){return window.localStorage.getItem("haveRun")?!1:!0}var c="topaz",b=null;return{isFirstTime:d,isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var b=new jQuery.Deferred;
KindleFirstRunDialog.open({continueCB:function(){KindleHostDeviceDetector.isIE()||KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);window.localStorage.setItem(Kindle.App.HAVE_RUN,"true")},onDialogOpenCB:function(){KindleHostDeviceDetector.isIE()&&KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(function(){b.resolve();var a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();a&&d()&&
a.BookInfoDB().reserveStorage(10)},b.reject)}});return b.promise()},enableOfflineMessage:function(){var b=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);setTimeout(function(){b.isRejected()&&KindleEnableOfflineDialog.open()},500);return b.promise()},pinBook:function(b,a){function c(a){if(a.type===Kindle.ERROR.DB_LINGERING_WRITE)if(a.stalled)KindleFirefoxPromptingDialog.open(),r.getModuleSync(r.METRICS_MANAGER).emit("Pinning::FirefoxPrompting::Open");
else{KindleFirefoxPromptingDialog.close();var b="Pinning::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";r.getModuleSync(r.METRICS_MANAGER).emit(b)}}function d(){r.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);r.getModuleSync(r.METRICS_MANAGER).cancelMetrics(t);s.cancelDownloading();KindleLibraryProgressDialog.close();q.reject()}function m(){r.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);r.getModuleSync(r.METRICS_MANAGER).endMetrics(t);
KindleLibraryProgressDialog.updateValue(100);$.when(n,h(200)).then(function(){KindleLibraryProgressDialog.close();q.resolve()})}function l(b,d){r.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);r.getModuleSync(r.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.close();b&&b.getOpenError&&(b=b.getOpenError());b!==Kindle.ERROR.CANCELLED&&a(b,d);e(b,"Library");q.reject(b)}function o(){function a(b,c){KindleLibraryProgressDialog.updateValue(Math.round(100*
Math.min(b,c)/Math.max(1,c)))}s.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?l(Kindle.ERROR.OUT_OF_SPACE):s.getBookInfoDfd().then(function(){var b=s.getBookType();j(b,function(){r.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);u.resolve(!0);s.getDownloadComplete(a).then(m,l)},function(){u.reject();d()})})})}var q,n,r,s,t,u;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),
q.promise();r=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){r.registerModuleList(a);t=r.getModuleSync(r.METRICS_MANAGER).startMetrics("Pin");s=KindleReaderBookInfoProvider.BookInfo(b,r);n=h(1500);u=new jQuery.Deferred;KindleLibraryProgressDialog.open(d);s.startDownloading(t,u).then(o,l)});return q.promise()},downloadBook:function(c,a,f,d){function m(){r.getModuleSync(r.METRICS_MANAGER).endMetrics(j);$.when(n,h(200)).then(function(){q.resolve();f()})}function l(a){r.getModuleSync(r.METRICS_MANAGER).cancelMetrics(j);
a&&a.getOpenError&&(a=a.getOpenError());if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;var b=KindleErrorMap.getErrorText(a);b.code=a;d(b)}e(a,"Library");q.reject(a)}function o(){function c(b,f){a(Math.round(100*Math.min(b,f)/Math.max(1,f)))}b.getSizeInfo().then(function(a){a.quota>0&&a.bookSize*1.53>a.quota?l(Kindle.ERROR.OUT_OF_SPACE):(t.resolve(!0),b.getDownloadComplete(c).then(m,l))})}var q,n,r,
j,t;q=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return q.reject(),q.promise();r=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){r.registerModuleList(a);j=r.getModuleSync(r.METRICS_MANAGER).startMetrics("Pin");b=KindleReaderBookInfoProvider.BookInfo(c,r);n=h(1500);t=new jQuery.Deferred;b.startDownloading(j,t).then(o,l)});return q.promise()},removeBook:function(b,a,c){function d(a){q.endMetrics(n);
c(a)}function e(){q.endMetrics(n);a()}function h(a){a.cacheState!==Kindle.BookInfo.CachedState.PINNED||a.context.isSample?a=!0:KindleHostDeviceDetector.isOnline()?(a={asin:b.asin,kindleSessionId:a.context.kindleSessionId,isOffline:!1},a=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(a)):a=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return a}var o,q,n;q=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);n=q.startMetrics("Unpin");
o=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();o.getRecord("bookinfo",{asin:b.asin},{cacheState:!0,context:!0}).then(function(a){a&&a.length>0?$.when(h(a[0])).fail(d).done(function(){o.deleteBooksData([b.asin]).then(e,d)}):e()},d)},cancelBookDownload:function(){b.cancelDownloading()},sendDownloadFailMetric:e}}(),KindleStringUtilities=function(){var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},j=RegExp("["+Object.keys(h).join("")+"]","g"),
e={"\u2019":"'","\uff07":"'","'":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u0100":"a","\u0101":"a","\u0102":"a","\u0103":"a","\u0104":"a","\u0105":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u0112":"e","\u0113":"e","\u0114":"e","\u0115":"e","\u0116":"e","\u0117":"e","\u0118":"e","\u0119":"e","\u011a":"e","\u011b":"e",
"\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u0128":"i","\u0129":"i","\u012a":"i","\u012b":"i","\u012c":"i","\u012d":"i","\u012e":"i","\u012f":"i","\u0130":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00d2":"o","\u00d3":"o","\u00d4":"o","\u00d5":"o","\u00d6":"o","\u014c":"o","\u014d":"o","\u014e":"o","\u014f":"o","\u0150":"o","\u0151":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u","\u00da":"u",
"\u00db":"u","\u00dc":"u","\u0168":"u","\u0169":"u","\u016a":"u","\u016b":"u","\u016c":"u","\u016d":"u","\u016e":"u","\u016f":"u","\u0170":"u","\u0171":"u","\u0172":"u","\u0173":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0176":"y","\u0177":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u0106":"c","\u0107":"c","\u0108":"c","\u0109":"c","\u010a":"c","\u010b":"c","\u010c":"c","\u010d":"c","\u00d0":"d","\u010e":"d","\u010f":"d","\u00f0":"d","\u011c":"g","\u011d":"g","\u011e":"g","\u011f":"g","\u0120":"g",
"\u0121":"g","\u0122":"g","\u0123":"g","\u0124":"h","\u0125":"h","\u0134":"j","\u0135":"j","\u0136":"k","\u0137":"k","\u0139":"l","\u013a":"l","\u013b":"l","\u013c":"l","\u013d":"l","\u013e":"l","\u00f1":"n","\u00d1":"n","\u0143":"n","\u0144":"n","\u0145":"n","\u0146":"n","\u0147":"n","\u0148":"n","\u0154":"r","\u0155":"r","\u0156":"r","\u0157":"r","\u0158":"r","\u0159":"r","\u015a":"s","\u015b":"s","\u015c":"s","\u015d":"s","\u015e":"s","\u015f":"s","\u0160":"s","\u0161":"s","\u0162":"t","\u0163":"t",
"\u0164":"t","\u0165":"t","\u0174":"w","\u0175":"w","\u0179":"z","\u017a":"z","\u017b":"z","\u017c":"z","\u017d":"z","\u017e":"z","\u00df":"s","\u00e6":"a","\u00c6":"a","\u00de":"t","\u00fe":"t","\u00d8":"o","\u00f8":"o"};return{replaceAccentedChars:function(d){return d=d.replace(/[^A-Za-z0-9 ]/g,function(c){return e[c]||c})},escapeForHTML:function(d){return d.replace(j,function(c){return h[c]})}}}(),KindleTouchEventsToggler=function(){function h(a){if(g)for(var c=$(":hasTouchEvent"),d=0;d<c.length;d++){var e=
c[d];if((!a||!a(e))&&e._listeners)for(var h=e._listeners.slice(0),o=0;o<h.length;o++){var q=h[o][0];if(q==="touchstart"||q==="touchmove"||q==="touchend")q={element:e,type:q,func:h[o][1],useCapture:h[o][2]},b.push(q),e.removeEventListener(q.type,q.func,q.useCapture)}}}function j(){if(g){for(var a=0;a<b.length;a++){var c=b[a];c.element.addEventListener(c.type,c.func,c.useCapture)}b=[]}}var e=null,d=null,c=!1,b=[],g=!1;return{initialize:function(){if(!c)e=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=
function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);e.apply(this,arguments)},d=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(a,b){try{return typeof a==="function"&&typeof b==="function"?a===b:a.handleEvent===b.handleEvent}catch(c){}return!1}if(this._listeners)for(var b=0;b<this._listeners.length;++b)if(this._listeners[b][0]===arguments[0]&&a(this._listeners[b][1],arguments[1])){this._listeners.splice(b,1);break}d.apply(this,
arguments)},g=c=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var b=0;b<a._listeners.length;b++){var c=a._listeners[b][0];if(c==="touchstart"||c==="touchmove"||c==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(c){var a=0;$(":hasListeners").each(function(b,c){for(var d=c._listeners.slice(0),g=0;g<d.length;g++)c.removeEventListener(d[g][0],d[g][1]),a++});HTMLElement.prototype.addEventListener=e;HTMLElement.prototype.removeEventListener=
d;b=[];c=!1}},on:j,off:h,disallowTouchEvents:function(){g=!0;h();g=!1},allowTouchEvents:function(){g=!0;j()},isRequired:function(){return KindleHostDeviceDetector.isiOS()}}}();
(function(h){var j=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];h.each(j,function(e,d){h.fn[d]=function(c,b){b=b||{};return d==="tap"?KindleHostDeviceDetector.isTouchDevice()?c?gt(this).on(d,c,h.extend(b,{expire:700,moveThreshold:10})):this.trigger(d):c?this.click(c):this.trigger("click"):c?gt(this).on(d,c,b):this.trigger(d)};h.attrFn[d]=!0});h.each(j,function(e,d){var c="unbind"+d.slice(0,1).toUpperCase()+d.slice(1);h.fn[c]=function(b){return d==="tap"&&!KindleHostDeviceDetector.isTouchDevice()?
b?this.unbind("click",b):this.unbind("click"):gt(this).off(d,b)};h.attrFn[c]=!0})})(jQuery);
var KindleUXComponentManager=function(){function h(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function j(a,b,c){g(a,function(){var f;f=$(Handlebars.templates[a](c));k[a]={component:f};b(f)})}function e(a){a.stopPropagation()}function d(a,b,f,d){var g=k[a];g.callbacks=f;if(f.onInitializationDone)f.onInitializationDone(b);
if(f.getDialogSettings)g.dialogSettings=f.getDialogSettings();if(g.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=l;else if(KindleHostDeviceDetector.isMetro()){if(a=q,g.dialogSettings.dialogClass="wide-dialog",!d)g.dialogSettings.k4w_transparent_modal_overlay=!1}else a=o;g.dialogSettings.width=a}g.dialogSettings.modal&&b.keydown(e).keyup(e);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=g.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(g.dialogSettings);
g.component=b;if(!d&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var m=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",m)})}b.bind("dialogopen",function(){h(g)});b.bind("dialogclose",function(){if(g.callbacks.onDialogClose)g.callbacks.onDialogClose(g.component);g.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();g.dialogSettings.modal&&n&&n(!0);g.callbacks.beforeDialogClose&&
g.callbacks.beforeDialogClose(g.component)});c(g)}function c(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(m):$("body").removeClass(m),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&n&&n(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function b(a){k[a]&&k[a].component.dialog("isOpen")&&k[a].component.dialog("close")}function g(b,c){a(b).then(function(){f[b]||
c()},function(){KindleDebug.error("Template "+b+" is missing")})}function a(a){var b=$.Deferred();(a=Handlebars.templates[a])?b.resolve(a):b.reject();return b.promise()}function f(a){return!!Handlebars.templates[a]}var k=[],m="transparent_overlay",l=475,o=400,q="100%",n;return{initializeTemplate:g,hasTemplate:f,renderTemplate:function(a,b){if(!Handlebars.templates[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $(Handlebars.templates[a](b))},
initializeComponent:j,openDialog:function(a,b,f){var g=k[a];g?c(g):g!==null&&(k[a]=null,j(a,function(c){d(a,c,b)},f))},closeDialog:b,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(a){var b=k[a.componentName];b?(a.buttonID||KindlePopupMenu.updatePosition(a.componentName,a.position),a.enabledFlags&&KindlePopupMenu.updateMenu(b.component,a.enabledFlags,a.componentName),c(b)):(a.doneCallback=function(b,c){a.enabledFlags&&KindlePopupMenu.updateMenu(b,a.enabledFlags,
a.componentName);k[a.componentName]={component:b};d(a.componentName,b,c,!0)},KindlePopupMenu.initialize(a))},updateMenu:function(a,b){var c=k[a];c&&KindlePopupMenu.updateMenu(c.component,b,a)},hideMenu:b,registerKeyEventsEnabledCallback:function(a){n=a}}}(),KindleDialogOverlay=function(){return{showOverlay:function(h){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;");(function(){var j=h.component.dialog("option",
"position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){h.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});h.component.dialog("option","position",j)})})();(function(){h.callbacks.onOverlayClicked&&$(".ui-widget-overlay-kcr-ios-hack").tap(function(h){h.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),
KindleEnableOfflineDialog=function(){function h(){KindleUXComponentManager.closeDialog(j)}var j="KindleEnableOfflineDialog",e={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},d={DIALOG:"kindle_dialog_enableOffline",CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},c={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},b,g={getDialogSettings:function(){return{autoOpen:!1,
width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(a){b=a;var f,g;KindleHostDeviceDetector.isFirefox()&&(f=ResourceBundle.getLocalizedString(e.OFFLINE_TITLE),g=ResourceBundle.getLocalizedString(e.FIREFOX_MSG,{linkStart:"<a href='"+Kindle.ExternalLinks.HelpOfflineReading+"' target='_blank'>",linkEnd:"</a>"}));a={title:f,topInstruction:g,topInstructionClass:void 0};b.find("#"+c.TITLE).html(a.title);b.find("#"+c.TOP_MSG).html(a.topInstruction);
a.topInstructionClass&&b.find("#"+c.TOP_MSG).addClass(a.topInstructionClass);a=b.find("#"+d.BUTTON);a.html(ResourceBundle.getLocalizedString(e.BUTTON_TEXT));a.one("click",h)},onDialogOpen:function(){var a=$("#"+d.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};return{open:function(){KindleUXComponentManager.openDialog(j,g)},close:function(){KindleUXComponentManager.closeDialog(j)}}}(),KindleFirefoxPromptingDialog=
function(){function h(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.closeDialog(j)}var j="KindleFirefoxPromptingDialog",e={MESSAGE:"k_dialog_ffPrompting_Text"},d={DIALOG:"kindle_dialog_ffPrompting",IMAGE:"ffPrompting_img",MESSAGE:"kindle_dialog_ffPrompting_text"},c,b={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(b){var a={linkStart:"<a href='"+Kindle.ExternalLinks.HelpIncreaseOfflineStorage+
"' target='_blank'>",linkEnd:"</a>"};c=b;b=ResourceBundle.getLocalizedString(e.MESSAGE,a);c.find("#"+d.MESSAGE).html(b);c.dialog("option","buttons",{Close:h})}};return{open:function(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.openDialog(j,b)},close:h}}(),KindleFirstRunDialog=function(){function h(){KindleUXComponentManager.closeDialog(c);k&&k()}function j(a){return ResourceBundle.getLocalizedString(a)}function e(){var a,c,f,d;KindleHostDeviceDetector.isChromeApp()?(c=
j(b.CHROME_APP_TITLE),f=j(b.CHROME_APP_MSG)):KindleHostDeviceDetector.isChrome()?(d="continue",c=j(b.OFFLINE_TITLE),f=j(b.CHROME_MSG)):KindleHostDeviceDetector.isiOS()?(a="ipad_prompt",c=j(b.OFFLINE_TITLE),f=j(b.IOS_PROMPT_MSG)):KindleHostDeviceDetector.isFirefox()?(d="ff_prompt",c=j(b.OFFLINE_TITLE),f=j(b.FIREFOX_MSG)):KindleHostDeviceDetector.isIE()?(d=KindleHostDeviceDetector.isIE11()?"ie11_prompt":"ie10_prompt",c=j(b.OFFLINE_TITLE),f=j(b.IE_PROMPT_MSG)):(a="safari_prompt",c=j(b.OFFLINE_TITLE),
f=j(b.SAFARI_PROMPT_MSG));return{topImgClass:a,title:c,topInstruction:f,bottomImgClass:d,topInstructionClass:void 0}}function d(){KindleUXComponentManager.closeDialog(c)}var c="KindleFirstRunDialog",b={BUTTON_TEXT:"k_dialog_firstRun_button_text",BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",
OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg",IE_PROMPT_MSG:"k_dialog_firstRun_ie_prompt_msg"},g={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",
CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},a={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},f,k,m,l={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(c){function f(){KindleChromeInstaller.install();d()}m=c;c=e();m.find("#"+a.TITLE).html(c.title);m.find("#"+a.TOP_MSG).html(c.topInstruction);c.topImgClass&&m.find("#"+a.TOP_IMG).addClass(c.topImgClass);
c.bottomImgClass&&m.find("#"+a.BOTTOM_IMG).addClass(c.bottomImgClass);c.topInstructionClass&&m.find("#"+a.TOP_MSG).addClass(c.topInstructionClass);c=m.find("#"+g.BUTTON);c.html(ResourceBundle.getLocalizedString(b.BUTTON_TEXT));c.one("click",h);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(c.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(b.BUTTON_TEXT_CHROME)),c=m.find("#"+g.CRX_BUTTON),c.removeClass("disabled").html(ResourceBundle.getLocalizedString(b.CRX_BUTTON_TEXT)),
c.unbind("click"),c.one("click",f),c.show())},onDialogOpen:function(){var a=$("#"+g.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content");f&&f()},onDialogClose:function(){}};return{open:function(a){k=a&&a.continueCB;f=a&&a.onDialogOpenCB;KindleUXComponentManager.openDialog(c,l)},close:d}}(),KindleMessageDialog=function(){function h(a){if((a.keyCode||a.which)===27)return f(),a.stopImmediatePropagation(),!1}
var j={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},e={dismiss:"k_dialog_message_dismissButton_text"},d,c,b,g,a,f=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},k={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(d){function k(a){return function(){f();"function"===typeof a.callback&&a.callback()}}var m={};if(a)for(var n=0;n<a.length;n++){var r=
a[n];m[r.buttonText]=k(r)}else g=g?g:ResourceBundle.getLocalizedString(e.dismiss),m[g]=f;d.dialog("option","buttons",m);d.find("#"+j.TITLE_ID).empty().append(b);d.find("#"+j.TEXT_ID).empty().append(c);if(KindleHostDeviceDetector.isMetro())$(".ui-dialog").on("keydown",h)},beforeDialogClose:function(){KindleHostDeviceDetector.isMetro()&&$(".ui-dialog").off("keydown")},onDialogClose:function(){d&&d()}},m=function(f,e,h,m,j){b=f;c=e;d=h;g=m;a=j;KindleUXComponentManager.openDialog("KindleMessageDialog",
k)};return{open:m,close:f,showError:function(a,b,c,f){var d=a;if(a&&a.name)d=a.name;d=KindleErrorMap.getErrorText(d);a&&a.code&&(d.text+=" ["+a.code+"]");m(d.title,d.text,b,c,f)}}}(),KindleNotificationDialog=function(){function h(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");a.removeClass(k.SHOWN);setTimeout(function(){a.remove()},
n)}function j(b){function c(f){var d,g,e,h;if(d=a[f.optionProperty])if(typeof d==="string"?g=d:(g=d.id,e=d.localizationParams,h=d.htmlClass),d=ResourceBundle.getLocalizedString(g,e))f=$(f.tag).addClass(f.htmlClass).html(d),h&&f.addClass(h),b.find("."+k.CONTAINER).append(f)}b.find("."+k.CONTAINER).empty();c(k.PRETITLE);c(k.TITLE);c(k.BODY);c(k.LEGAL)}function e(a,b){var c=$("#kindleNotificationArrow"),f=$("#"+b.targetElementId),d=0,g=0;b.targetAlignment==="right"?(d=f.offset().left+f.outerWidth(),
d-=a.outerWidth()):(d=f.offset().left+f.outerWidth()/2,d-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();d+a.outerWidth()>b&&(d=b-a.outerWidth());d<0&&(d=0)})();(function(){var a=b.targetBeakOffset||0;g=f.offset().left-d+f.outerWidth()/2+a})();a.css("left",d+"px");c.css("left",g+"px")}function d(b){function c(){e(b,a);KindleHostDeviceDetector.isiOS()&&b.show();g=null}function f(){g?clearTimeout(g):KindleHostDeviceDetector.isiOS()&&b.hide();g=setTimeout(c,r)}function d(){u=!0;t&&z.increment();
h(b)}var g;$(window).bind("touchstart.notification mousedown.notification",function(b){(!b.srcElement||!b.srcElement.id||!a.clickIdsToIgnore||!a.clickIdsToIgnore[b.srcElement.id])&&setTimeout(d,q)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",f):$(window).bind("resize.notification",f);setTimeout(d,o)}function c(b){d(b);$("body").append(b);e(b,a);setTimeout(function(){u||(b.addClass(k.SHOWN),setTimeout(function(){t=!0},l))},m)}function b(a){j(a);
c(a)}function g(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);s.resolve(a)}var a={},f={},
k={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},m=2E3,l=1E3,o=2E4,q=250,n=3E3,r=100,s=null,t=!1,u=!1,z;return{show:function(c){a=$.extend({},f,c);z=
LocalStorageCounter("kcrNotifications."+a.notificationId);c=a.notificationCount|1;z.getValue()<c&&(s||(s=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",g)),s.done(b))},hide:function(){var a=$("#kindleNotification");h(a)}}}(),KindlePopupMenu=function(){function h(b){var c=KindleUXComponentManager.renderTemplate(f),d=c.find(m),g=y[b].menuItems,e=!0,k,h=q;if(y[b].isAppBarMenu){h+=" "+r;var l=y[b].title;if(l){var n=document.createElement("div"),l=document.createTextNode(l);
n.appendChild(l);n.setAttribute("class",s);d.append(n)}}for(var o in g)k=$(document.createElement("div")).addClass(h).addClass(t).text(g[o].content).attr("id",g[o].elementId),e&&(k.addClass(u),e=!1),k.tap(j(k,g[o].clickHandler)),KindleEventBroker.subscribe(g[o].elementId,g[o].clickHandler),d.append(k);k.addClass(z);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(b)});y[b].doneCallback(c,
a(b))}function j(a,b){return function(){a.hasClass(t)&&b()}}function e(a,b,c){var f=[];b?(b=$("#"+b),c==="down"?(c=b.offset(),b=c.top+b.outerHeight(),f[0]=KindleHostDeviceDetector.isMetro()?c.left+23:c.left,f[1]=KindleHostDeviceDetector.isMetro()?b+10:b):(f[0]="right",f[1]="bottom")):f=c;a.dialog("option","position",f)}function d(){F&&(F.removeClass(w),F=null)}function c(a,b,c){var a=a.find(m).children(),f=b;do{if(c==="next")f?(f=f.next(),f.length<=0&&(f=a.first())):f=a.first();else if(c==="prev")f?
(f=f.prev(),f.length<=0&&(f=a.last())):f=a.last();else break;if(f===b)break}while(!f.hasClass(t));return f}function b(a,b){e(a,y[b].buttonID,y[b].position);$(".ui-dialog").on("keydown",function(f){var g=f.keyCode||f.which;KindleEventUtil.preventKeyScroll(f);switch(g){case 38:F&&F.removeClass(w);F=c(a,F,"prev");F.addClass(w);f.stopPropagation();break;case 40:F&&F.removeClass(w);F=c(a,F,"next");F.addClass(w);f.stopPropagation();break;case 13:F&&(f.stopPropagation(),F.removeClass(w),f=F.attr("id"),KindleEventBroker.fire(f),
d());break;case 9:d();G&&KindleUXComponentManager.hideMenu(b);break;case 27:d(),KindleUXComponentManager.hideMenu(b),f.preventDefault(),f.stopPropagation()}});a.find(m).children().each(function(a,b){$(b).on("mouseover",function(a){a=$(a.currentTarget);a.hasClass(t)&&(F?F!==a&&(F.removeClass(w),F=a,a.addClass(w)):(F=a,F.addClass(w)))})})}function g(a){$(".ui-dialog").off("keydown");a.find(m).children().each(function(a,b){$(b).off("mouseover")})}function a(a){return{getDialogSettings:function(){var b=
y[a],c=k;b.isAppBarMenu&&(c+=" "+n);b.buttonID&&(c+=" "+(b.position==="down"?l:o));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){b(c,a)},beforeDialogClose:function(b){g(b,a)},onDialogOpen:function(){G=!0},onDialogClose:function(){G=!1},onOverlayClicked:function(){G&&KindleUXComponentManager.hideMenu(a);d()}}}var f="KindlePopupMenu",k="kindle_menu",m="#kindle_menu_border",l="down_menu",o=
"up_menu",q="kindle_menu_button",n="kindle_appbar_menu",r="appbar_menu_button",s="appbar_menu_title",t="button_enabled",u="ui-corner-top",z="ui-corner-bottom",w="selected",y={},G=!1,F=null;return{MENU_POSITION_CONSTANTS:{APPBAR_MENU_MARGIN_PX:5,APPBAR_HEIGHT_PX:102,APPBAR_HEIGHT_SNAPVIEW_PX:70},ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a){y[a.componentName]={menuItems:a.menuItems,doneCallback:a.doneCallback,buttonID:a.buttonID,position:a.position,title:a.title,isAppBarMenu:a.isAppBarMenu};
KindleUXComponentManager.hasTemplate(f)?h(a.componentName):KindleUXComponentManager.initializeTemplate(f,function(){h(a.componentName)})},updateMenu:function(a,b,c){for(var f,d,g=0;g<b.length;g++)b[g]!==2&&(f===void 0&&(f=g),d=g);var e=y[c].isAppBarMenu;a.find("."+q).each(function(a){var c=q;if(e||$(this).hasClass(r))c+=" "+r;$(this).attr("class",c);switch(b[a]){case 0:$(this).addClass(t);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===f&&$(this).addClass(u);
a===d&&$(this).addClass(z)})},updatePosition:function(a,b){y[a].position=b}}}(),KindlePromptDialog=function(){var h={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},j={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},e,d,c,b=function(){c="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},g=function(){c="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CANCEL_BUTTON_STRING_ID)]=
g;a[ResourceBundle.getLocalizedString(h.OK_BUTTON_STRING_ID)]=b;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(d);a.find("#"+j.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){e(c)}};return{open:function(b,g){e=g;c=!1;d=b;KindleUXComponentManager.openDialog("KindlePromptDialog",a)}}}(),KindleSigningOutDialog=function(){var h={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",h)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSpinner=function(){function h(){c||(c=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(e,j));return c.promise()}function j(b){d=b;c.resolve()}var e="KindleSpinner",d,c;return{show:function(){var b=h();$.when(b).then(function(){$("body").append(d);var b=window.innerWidth>
1?window.innerWidth:window.outerWidth,a=parseInt(d.css("width"),10),c=window.innerHeight>1?window.innerHeight:window.outerHeight,e=parseInt(d.css("height"),10);d.css("top",(c-e)/2+"px").css("left",(b-a)/2+"px")})},hide:function(){var b=h();$.when(b).then(function(){$("#loading_spinner").detach()})}}}(),KindleUnoptimizedFormatDialog=function(){var h={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",
STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},j={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},e,d,c,b=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},g=function(){d=!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CLOSE_BUTTON_STRING_ID)]=b;a[ResourceBundle.getLocalizedString(h.CONTINUE_BUTTON_STRING_ID)]=
g;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=KindleHostDeviceDetector.isMetro()?h.METRO_TEXT_LABEL_STRING_ID:h.TEXT_LABEL_STRING_ID,b=ResourceBundle.getLocalizedString(b,{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});a.find("#"+j.TEXT_LABEL_ID).empty().append(b);$(a[0].parentNode).find(".ui-button-text").first().text(c)},onDialogClose:function(){e(d)}};return{open:function(b){c=
ResourceBundle.getLocalizedString(h.CLOSE_BUTTON_STRING_ID);e=b;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",a)},openPinning:function(b){c=ResourceBundle.getLocalizedString(h.STOP_BUTTON_STRING_ID);e=b;d=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",a)}}}(),KindleReaderEmbeddedError=function(){var h={ErrorTextDiv:"kindleReader_embeddedError_text"},j={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,dialogClass:"embedded_error",
k4w_transparent_modal_overlay:!0}}};return{open:function(e){KindleUXComponentManager.openDialog("KindleReaderEmbeddedError",j);var d=$("#"+h.ErrorTextDiv),e=KindleErrorMap.getErrorText(e);d.text(e&&e.text||ResourceBundle.getLocalizedString("k_L_unknownError_Text"))}}}(),KindleAnnotationComponentFactory=function(){function h(a,b){return a.replace(".","_")+"_"+b}function j(a,b){a.find("."+n.CONTEXT).tap(function(){b(a)})}function e(a,b){var c=function(c){return function(){var f=b[q[c]];f&&f(a)}},f;
for(f in o){var d=a.find("."+o[f]);b[q[f]]||d.remove();d.tap(c(f))}}function d(a,b){b.length>s?a.find("."+n.CONTEXT).text(b.substring(0,s)+" ..."):a.find("."+n.CONTEXT).text(b)}var c=0,b=c++,g=c++,a=c++,f=c++,k=c++,m=c++,l=c++,o={TRASH_CAN:"kindleReader_annotation_pane_notes_trashcan",EDIT:"kindleReader_annotation_pane_notes_edit",GOTO:"kindleReader_annotation_pane_notes_goto",SAVE:"kindleReader_annotation_pane_notes_save",CANCEL:"kindleReader_annotation_pane_notes_cancel",YES:"kindleReader_annotation_pane_notes_yes",
NO:"kindleReader_annotation_pane_notes_no"},q={TRASH_CAN:g,EDIT:b,GOTO:a,SAVE:f,CANCEL:k,YES:m,NO:l},n={CONTEXT:"kindleReader_annotation_pane_notes_context"},r={TEXT_AREA:"kindleReader_annotation_pane_edit_textArea"},s=430,t=function(){return KindleUserLocationConverter},u=function(){return KindleUXComponentManager},z=function(){return KindleReaderAnnotationManager};return{EVENT_EDIT_CLICKED:b,EVENT_DELETE_CLICKED:g,EVENT_GOTO_CLICKED:a,EVENT_SAVE_CLICKED:f,EVENT_CANCEL_CLICKED:k,EVENT_YES_CLICKED:m,
EVENT_NO_CLICKED:l,MAX_NOTE_CONTEXT_LENGTH:s,initialize:function(a){var b=t(),c=u();b.mobiLocationConverter();c.initializeTemplate("KindleAnnotationComponentFactory",a)},createAnnotationComponent:function(a,c,g,t){var q=new jQuery.Deferred,o=u(),B=z(),v,I={context:a.note||a.context,start:a.start,pageLabel:"",id:h(a.type,a.start),maxContextLength:s};c(a.start).pipe(function(c){var h="",u=h="",z="";c.pageNumber&&(h=ResourceBundle.getLocalizedString("k_R_annotation_pane_notes_page",{page:c.pageNumber}));
c.loc&&(h&&(u=" \u25cf "),z=ResourceBundle.getLocalizedString("k_R_annotation_pane_notes_location",{location:c.loc}));I.pageLabel=h+u+z;switch(a.type){case B.BOOKMARK:v=o.renderTemplate("KindleAnnotationComponentFactory",I);v.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_bookmark");t[b]=null;t[f]=null;t[k]=null;t[m]=null;t[l]=null;break;case B.HIGHLIGHT:v=o.renderTemplate("KindleAnnotationComponentFactory",I);v.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_highlight");
t[b]=null;t[f]=null;t[k]=null;t[m]=null;t[l]=null;break;case B.NOTE:v=o.renderTemplate("KindleAnnotationComponentFactory",$.extend({},I,{maxNoteChars:Kindle.opt.maxNoteChars})),v.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_note"),KindleHostDeviceDetector.isIE11()&&v.find("#"+r.TEXT_AREA).attr("spellcheck","false"),KindleTouchEventsToggler.isRequired()&&(v.find("#"+r.TEXT_AREA).focus(function(){KindleTouchEventsToggler.off()}),v.find("#"+r.TEXT_AREA).blur(function(){KindleTouchEventsToggler.on()}))}if(I.context){if(d(v,
I.context),a.type===B.NOTE)c=v.find("."+n.CONTEXT)[0],c.innerHTML=c.innerHTML.replace(/\n/g,"<br />")}else v.find("."+n.CONTEXT).remove();j(v,g);e(v,t);q.resolve(v)});return q.promise()},setAnnotationContext:d,getAnnotationID:h,setUserLocationConverter:function(a){t=a},setUXComponentManager:function(a){u=a},setAnnotationManager:function(a){z=a}}}(),KindleImageViewer=function(h){function j(){d=e.find(".imageViewerImage");$("<img/>").attr("src",d.attr("src")).load(function(){var b=this.width/this.height,
c=h.parent.width()/h.parent.height();b>c?(d.css("height","auto"),d.css("width","100%")):(d.css("height","100%"),d.css("width","auto"));d.css("max-width",Math.min(this.width,$(window).width()));d.css("max-height",Math.min(this.height,$(window).height()))})}var e,d,c=new jQuery.Deferred;KindleUXComponentManager.initializeTemplate("KindleImageViewer",function(){var b=KindleUXComponentManager.renderTemplate("KindleImageViewer",{imageSource:h.imageSource});e=$(b).hide();j();$("body",Kindle.top.document).bind("orientationchange",
j);$(window).resize(j);$(d).bind("dragstart",function(){return!1});c.resolve({backdrop:e,image:d})});return c},KindleReaderAnnotationsPane=function(){function h(){x=A;A=Math.max(x-y,0);d();l("bottom")}function j(){A=x;x=Math.min(A+y,F.length);d();l(0)}function e(a){a.appendTo(m())}function d(){m().empty();M.remove();D.add(K).remove();for(var a=A;a<x;++a)b(F[a]).done(e);c();f()}function c(){var a=m();A>0&&D.unbind("click.goPrev").bind("click.goPrev",h).add(K).prependTo(a);x<F.length&&M.unbind("click.goNext").bind("click.goNext",
j).appendTo(a)}function b(d){function g(a){var k;jQuery.each(F,function(a,b){b.start===d.start&&b.end===d.end&&b.type===d.type&&(k=a)});a.remove();k!==-1&&(k<A||x<=k?F.splice(k,1):(F.splice(k,1),a=x-1,a<F.length&&F.length>0&&(M.remove(),D.add(K).remove(),b(F[a]).done(e),c())));F.length===0&&L.find("#"+z.EMPTY_MESSAGE).show();f()}m();var k=E(),h={};h[k.EVENT_DELETE_CLICKED]=function(a){d.type===KindleReaderAnnotationManager.NOTE?(a.find("."+w.DELETE_ICON).hide(),a.find("."+w.EDIT_ICON).hide(),a.find("."+
w.GOTO_ICON).hide(),a.find("."+w.CANCEL_BTN).hide(),a.find("."+w.SAVE_BTN).hide(),a.find("."+w.CONFIRMATION).show(),a.find("."+w.YES_BTN).show(),a.find("."+w.NO_BTN).show()):(g(a),B(d))};h[k.EVENT_EDIT_CLICKED]=function(b){b.find("."+w.CONTEXT).hide();b.find("."+w.EDIT_ICON).hide();b.find("."+w.GOTO_ICON).hide();b.find("."+w.DELETE_ICON).hide();b.find("#"+z.EDIT_NOTE).show();b.find("."+w.CANCEL_BTN).show();b.find("."+w.SAVE_BTN).show();N().isiOS()||b.find("#"+z.EDIT_NOTE).focus();a()};h[k.EVENT_GOTO_CLICKED]=
function(){o();I(d)};h[k.EVENT_SAVE_CLICKED]=function(a){var b=a.find("#"+z.EDIT_NOTE).val().trim();if(b){var c=a.find("."+w.CONTEXT);c.empty();KindleAnnotationComponentFactory.setAnnotationContext(a,b);c=c[0];c.innerHTML=c.innerHTML.replace(/\n/g,"<br />");r(a)}else g(a);v(b,d)};h[k.EVENT_CANCEL_CLICKED]=function(a){a.find("#"+z.EDIT_NOTE).val(d.note);r(a)};h[k.EVENT_NO_CLICKED]=function(a){a.find("."+w.DELETE_ICON).show();a.find("."+w.EDIT_ICON).show();a.find("."+w.GOTO_ICON).show();a.find("."+
w.CONFIRMATION).hide();a.find("."+w.YES_BTN).hide();a.find("."+w.NO_BTN).hide()};h[k.EVENT_YES_CLICKED]=function(a){g(a);B(d)};return k.createAnnotationComponent(d,_pageLabelConverter,function(b){var c=d;if(C){var f=KindleAnnotationComponentFactory.getAnnotationID(C.type,C.start),f=m().find("#"+f);KindleAnnotationComponentFactory.setAnnotationContext(f,C.note||C.context)}C=c;c=c.note||c.context;b.find("."+w.CONTEXT).text(c);b=b.find("."+w.CONTEXT)[0];b.innerHTML=b.innerHTML.replace(/\n/g,"<br />");
a()},h)}function g(a){a.stopPropagation()}function a(){if(J){var a=k();a.jScrollPane({showArrows:!0,verticalGutter:10});a.removeAttr("tabindex");$(".jspContainer").keypress(g).keyup(g).keydown(g)}else H&&(O?O.refresh():O=new iScroll(z.SCROLL_WRAPPER,{vScrollbar:!1}))}function f(){var b=k(),c=L.height();N().isiOS()?L.find("#"+z.SCROLL_WRAPPER).height(c):b.height(c-6);$(b).animate({opacity:1},100);a()}function k(){return L.find("#"+z.CONTAINER)}function m(){return J?k().data("jsp").getContentPane():
k()}function l(a){if(H)a==="bottom"&&(a=-9999),O.scrollTo(0,a);else if(J){var b=k().data("jsp");a==="bottom"?b.scrollToBottom():b.scrollToY(0)}else b=k(),a==="bottom"&&(a=b.height()),b.scrollTop(a)}function o(){s();KindleUXComponentManager.closeDialog(t)}function q(a){C=null;L=a;var b;$(window).resize(function(){clearTimeout(b);b=setTimeout(f,50)});J?(k().jScrollPane({showArrows:!0,verticalGutter:10}),$(".jspContainer").keypress(g).keyup(g).keydown(g)):H||k().addClass("ie_scrollable");k().hover(function(){document.onmousewheel=
function(){return!0}},function(){document.onmousewheel=function(){return!1}})}function n(a){var b=F.length;if(F.length===0)return-1;for(var c=0;c<b;c++)if(F[c].end>=a||F[c].start>=a)break;return c}function r(b){b.find("."+w.CONTEXT).show();b.find("."+w.EDIT_ICON).show();b.find("."+w.GOTO_ICON).show();b.find("."+w.DELETE_ICON).show();b.find("#"+z.EDIT_NOTE).hide();b.find("."+w.CANCEL_BTN).hide();b.find("."+w.SAVE_BTN).hide();a()}function s(){F=C=null;x=A=0;m().empty();a()}var t="KindleReaderAnnotationsPane",
u={CLOSE_BUTTON_STRING_ID:"k_common_close_button",CLICK_FOR_PREVIOUS:"k_R_annotation_pane_previous",CLICK_FOR_NEXT:"k_R_annotation_pane_next"},z={PANE:"kindleReader_annotations_pane",HEADER:"kindleReader_annotations_pane_header",CONTAINER:"kindleReader_annotations_pane_container",SCROLL_WRAPPER:"kindleReader_annotations_pane_scrollWrapper",EMPTY_MESSAGE:"kindleReader_annotations_pane_notes_empty",EDIT_NOTE:"kindleReader_annotation_pane_edit_textArea"},w={SELECTED:"kindleReader_annotation_pane_notes_selected",
CONTEXT:"kindleReader_annotation_pane_notes_context",EDIT_ICON:"kindleReader_annotation_pane_notes_edit",GOTO_ICON:"kindleReader_annotation_pane_notes_goto",CANCEL_BTN:"kindleReader_annotation_pane_notes_cancel",SAVE_BTN:"kindleReader_annotation_pane_notes_save",YES_BTN:"kindleReader_annotation_pane_notes_yes",NO_BTN:"kindleReader_annotation_pane_notes_no",CONFIRMATION:"kindleReader_annotation_notes_delete_confirm",DELETE_ICON:"kindleReader_annotation_pane_notes_trashcan"},y=100,G=1/3,F=[],A,x,B,
v,I,L,D,K,M,H=KindleHostDeviceDetector.isiOS(),J=!H&&!KindleHostDeviceDetector.isIE(),O,C,E=function(){return KindleAnnotationComponentFactory},N=function(){return KindleHostDeviceDetector},P={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(u.CLOSE_BUTTON_STRING_ID)]=o;var b={},c,b={autoOpen:!1,width:"90%",height:c,modal:!0,draggable:!1,resizable:!1,buttons:a};c=N().isiOS()?$("body",Kindle.top.document).height()-80:KindleHostDeviceDetector.isMetro()?window.outerHeight-250:
window.outerHeight-150;b.height=c;return b},onInitializationDone:q,onDialogOpen:function(){N().isiOS()&&($("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",Kindle.top.document).height()-212))}};return{open:function(){E().initialize(function(){KindleUXComponentManager.openDialog(t,P)})},scrollToPosition:function(a){if(F&&(a=Math.min(n(a),F.length-1),$("#"+z.PANE).offset(),L.parent().height(),a!==-1)){A<=
a&&a<x||(x=Math.min(Math.max(a-Math.floor(G*y),0)+y,F.length),A=Math.max(0,x-y),d());var b=F[a],a=0,b=KindleAnnotationComponentFactory.getAnnotationID(b.type,b.start),c=L.find("#"+b),a=a||0;H?O.scrollToElement("#"+b,a):J?k().data("jsp").scrollToElement(c,!0,!!a):k().scrollTop(c.offset().top)}},loadAnnotations:function(a,b,c,f,g){a.length===0?(s(),L.find("#"+z.EMPTY_MESSAGE).show()):(L.find("#"+z.EMPTY_MESSAGE).hide(),I=c,B=f,v=g,m(),F=a.slice(),_pageLabelConverter=b,C=null,D=$("<div/>",{"class":"kindleReader_annotation_pane_notes_prev",
text:ResourceBundle.getLocalizedString(u.CLICK_FOR_PREVIOUS)}),K=$("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_top"}),K=K.add($("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_bottom"})),M=$("<div/>",{"class":"kindleReader_annotation_pane_notes_next",text:ResourceBundle.getLocalizedString(u.CLICK_FOR_NEXT)}),A=0,x=Math.min(y,F.length),d())},setUXComponentManager:function(){},setAnnotationComponentFactory:function(a){E=a},setHostDeviceDetector:function(a){N=a},onInitializationDone:q}}(),
KindleReaderBookmarkOverlay=function(){function h(b){e=b;j();d(b)}function j(){c?e.addClass("preBookmark").addClass("hasBookmark").fadeIn(250):e.removeClass("hasBookmark").removeClass("preBookmark")}var e,d,c;return{initialize:function(b){d=b;KindleUXComponentManager.initializeComponent("KindleReaderBookmarkOverlay",h)},setIsBookmarked:function(b){c=b;e&&j()},setImmersiveMode:function(b){b?e.addClass("immersiveBookmark"):e.removeClass("immersiveBookmark")},setVisible:function(b){e.css("visibility",
b?"visible":"hidden")}}}(),ReaderImmersiveModeIcon=function(){function h(b){e=b;d(e);j()}function j(){switch(b){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:e.find(c).removeClass("black");e.find(c).removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:e.find(c).removeClass("sepia");e.find(c).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:e.find(c).removeClass("black"),e.find(c).addClass("sepia")}}var e,d,c="#immersive_icon",b;return{initialize:function(b){d=
b;KindleUXComponentManager.initializeComponent("ReaderImmersiveModeIcon",h)},setIconColor:function(c){b=c;e&&j()}}}(),KindleReaderContextMenu=function(){function h(a){a.dialog("option","position",n);a.parent().css("bottom","auto")}function j(){KindleUXComponentManager.isVisible(e)&&($(".ui-widget-overlay").show(),KindleUXComponentManager.closeDialog(e),t=Date.now())}var e="KindleReaderContextMenu",d="kindle_menu_button",c="button_enabled",b={};b[KindlePopupMenu.ITEM_ENABLED]=c;b[KindlePopupMenu.ITEM_DISABLED]=
"button_disabled";b[KindlePopupMenu.ITEM_HIDDEN]="button_hidden";var g=["k_R_context_createHighlight","k_R_context_deleteHighlight","k_R_context_createNote","k_R_context_editNote"],a=0,f=a++,k=a++,m=a++,l=a++,o=a++,q,n,r,s,t,u={onInitializationDone:function(a){function b(a){var f=ResourceBundle.getLocalizedString(g[a]),e=$("<div></div>").addClass(d).addClass(c).text(f);e.tap(function(){e.hasClass(c)&&(j(),r[a]())});return e}a=a.find("#kindle_menu_border");a.append(b(0));for(var f=1;f<g.length;f++)a.append('<div class="kindle_menu_separator"></div>'),
a.append(b(f));KindleReaderContextMenuDictionary.initialize()},beforeDialogOpen:function(a){var c=a.find("#kindle_menu_border"),f,g,e;c.find("."+d).each(function(a){var c=$(this);c.removeClass().addClass(d);c.addClass(b[q[a]])});c.children().each(function(){var a=$(this);a.hasClass(d)?a.hasClass("button_hidden")||(f||(f=a),g=a,e=null):a.hasClass("kindle_menu_separator")&&(!f||e?a.hide():(e=a,a.css("display","")))});f.addClass("ui-corner-left");g.addClass("ui-corner-right");e&&e.hide();q[o]===KindlePopupMenu.ITEM_ENABLED&&
$(window).width()!==320&&(KindleReaderContextMenuDictionary.updateMenuWithDefinition(a,s),n[0]-=180);KindleHostDeviceDetector.isIE()||h(a);$(window).bind("resize",j)},getDialogSettings:function(){return{autoOpen:!1,draggable:!1,modal:!0,resizable:!1,minHeight:0,width:"auto",dialogClass:"kindle_menu",k4w_transparent_modal_overlay:!0}},onDialogClose:function(){KindleReaderContextMenuDictionary.removeDefinition();$(window).unbind("resize",j)},onDialogOpen:function(a){var b=q[o]===KindlePopupMenu.ITEM_ENABLED,
c=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?60:30,f=a.parent();KindleHostDeviceDetector.isIE()&&h(a);if(b&&n[1]>320||!b&&$(window).height()-n[1]<100)f.css("top","auto"),f.css("bottom",$(window).height()-n[1]+c);n[0]+f.width()>$(window).width()&&f.css("left",$(window).width()-f.width()-25);a.css("height","auto")}};return{CREATE_HIGHLIGHT:f,CREATE_NOTE:m,EDIT_NOTE:l,DELETE_HIGHLIGHT:k,DEFINITION:o,show:function(a,b,c,f){q=a;n=b;r=c;s=f;KindleUXComponentManager.openDialog(e,
u);$(".ui-widget-overlay").hide()},hide:j,wasVisible:function(){return Date.now()-t<500}}}(),KindleReaderContextMenuDictionary=function(){function h(a){if(a.getPronunciationUrls()){var b,c;q===void 0&&(q=document.createElement("audio").canPlayType("audio/mpeg")!=="");c=q?a.getPronunciationUrls().mp3:a.getPronunciationUrls().wav;m.find("#dictionary_audio").tap(function(){b=b||new Audio(c);KindleHostDeviceDetector.isSafari()&&!KindleHostDeviceDetector.isiPad()&&b.load();b.play();l.emit("Reader::Dictionary::SoundPlayed")});
m.find(".view_full_link").click(function(){l.emit("Reader::Dictionary::ViewFull")})}}function j(f){if(!m.is(":hidden")){var d=f.getPronunciationUrls();c();m.addClass("dictionary_enabled");m.prepend(KindleUXComponentManager.renderTemplate(a,{entry:f.entry,pronunciation:g(f),audio_url_mp3:d?f.getPronunciationUrls().mp3:"",audio_url_wav:d?f.getPronunciationUrls().wav:"",definition:b(f),view_full:ResourceBundle.getLocalizedString("k_R_dictionary_view_full"),view_full_url:"http://app.dictionary.com/click/3mlh2s?clkdest=http://dictionary.reference.com/browse/"+
f.entry+"%3Fsplash=no"}));d||m.find("#dictionary_audio").hide();setTimeout(function(){m.find(".dictionary").addClass("expanded")},50)}}function e(){var a=Handlebars.templates.KindleReaderSimpleSpinner({});m.find(".dictionary_loading").append(a)}function d(a){var b="";c();m.addClass("dictionary_enabled");switch(a){case IDictionary.NOT_FOUND:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_found");o.emit("Reader::Dictionary::WordNotFound");break;case IDictionary.OFFLINE:b=ResourceBundle.getLocalizedString("k_R_dictionary_offline");
o.emit("Reader::Dictionary::Offline");break;case IDictionary.LOOKUP_FAILED:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_available");o.emit("Reader::Dictionary::LookupFailed");break;default:b=ResourceBundle.getLocalizedString("k_R_dictionary_not_available"),o.emit("Reader::Dictionary::LookupFailed")}m.prepend(k.replace("{{error}}",b))}function c(){m&&m.hasClass("dictionary_enabled")&&(m.find(".dictionary").remove(),m.find(".dictionary_loading").remove(),m.find(".dictionary_error").remove(),
m.removeClass("dictionary_enabled"))}function b(a,b){for(var c=0,d=[],g=a.getDefinitions(),b=b||f,e=0;e<g.length&&c<=b;e++){var k=g[e].definitions;g[e].partOfSpeech&&d.push('<span class="word_type">'+g[e].partOfSpeech+"</span>");d.push('<ol class="definitions_list">');for(var h=0;h<k.length&&c<=b;h++)d.push("<li>"+k[h]+"</li>"),c++;d.push("</ol>")}return d.join("").replace(/(<[\/]?a[^>]*>)/ig,"")}function g(a){return(a=a.getPronunciation())?"["+a+"]":""}var a="KindleReaderContextMenuDictionary",f=
5,k='<div class="dictionary_error">{{error}}</div>',m,l,o,q;return{updateMenuWithDefinition:function(a,b){o=l.createTimer();m=a;b.start===b.end&&(m.prepend('<div class="dictionary_loading"></div>'),m.addClass("dictionary_enabled"),$.when(KindleReaderAnnotationManager.getContext(b.start,b.end),dictionary.getDictionary()).done(function(a,b){a?(e(),b.lookup(a).then(function(a){j(a);h(a);o.emit("Reader::Dictionary::WordFound")},d)):c()}))},removeDefinition:c,initialize:function(){KindleUXComponentManager.hasTemplate(a)||
KindleUXComponentManager.initializeTemplate(a,function(){});l=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER])}}}(),KindleReaderEditNoteDialog=function(){function h(){return k.find("#kindleReader_dialog_editNote_title")}function j(){return k.find("#kindleReader_dialog_editNote_noteText")}function e(a){return k.dialog("widget").find('.ui-button:contains("'+a+'")')}function d(){r=!0;a();l&&l(m)}function c(){r=!0;a();o&&o()}function b(){r=!0;a();q&&q()}function g(){function a(){b&&
(b=!1,c.val("").removeClass("hint"))}j().val(m);var b=!0;if(!m&&KindleHostDeviceDetector.isMetro()){var c=j(),f=c.attr("placeholder");c.val(f).addClass("hint").on("click",a).on("keypress",a)}f=e(ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete"));o?(h().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_edit")),f.show()):(h().text(ResourceBundle.getLocalizedString("k_R_dialog_editNote_title_create")),f.hide());KindleHostDeviceDetector.isiOS()&&j().attr("tabindex","-1");
k.find("#kindleReader_dialog_editNote_noteText").off("keydown",s);k.find("#kindleReader_dialog_editNote_noteText").on("keydown",s)}function a(){KindleUXComponentManager.closeDialog(f)}var f="KindleReaderEditNoteDialog",k,m,l,o,q,n,r=!1,s=function(a){a.which===27&&b()},t={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_cancel")]=b;a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_delete")]=c;a[ResourceBundle.getLocalizedString("k_R_dialog_editNote_save")]=
d;n=KindleHostDeviceDetector.isiOS()?"70%":"40%";return{width:n,autoOpen:!1,buttons:a,draggable:!1,modal:!0,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:g,onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?(k.focus(),setTimeout(function(){var a=document.getElementById("kindleReader_dialog_editNote_noteText");a.focus();if(m){var b=document.createRange();b.selectNodeContents(a);b.collapse(!1);a=window.getSelection();
a.removeAllRanges();a.addRange(b)}},0)):j().focus())},onDialogClose:function(){!r&&q&&q();m=$.trim(j().val());if(KindleHostDeviceDetector.isMetro()){var a=j().parent(),b=a.html();j().detach();a.html(b)}},onInitializationDone:function(a){k=a;KindleTouchEventsToggler.isRequired()&&(j().focus(function(){KindleTouchEventsToggler.off()}),j().blur(function(){KindleTouchEventsToggler.on()}));g()}};return{open:function(a,b,c,d){m=a||"";l=b;o=c;q=d;r=!1;KindleUXComponentManager.openDialog(f,t,{maxNoteChars:Kindle.opt.maxNoteChars})},
close:a,isVisible:function(){return KindleUXComponentManager.isVisible(f)}}}(),KindleReaderGoToDialog=function(){function h(a){var b;/(^[0]*\d*$)/.exec(a)&&(b=parseInt(a,10));isNaN(b)&&(b=void 0);return b}var j=KindleHostDeviceDetector.isMetro()?"Metro/KindleReaderGoToDialog":"KindleReaderGoToDialog",e={DIALOG_TITLE_ID:"k_R_goto_menu_goto_location_title",DIALOG_TITLE_ID_METRO:"k_R_goto_menu_goto_location_metro_title",DIALOG_TEXT_ID:"k_R_goto_menu_goto_message",DIALOG_LOCATION_TEXT_ID:"k_R_goto_menu_goto_location",
DIALOG_OK_BTN_ID:"k_R_goto_menu_goto_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button",DIALOG_LOCATION_RANGE:"k_R_goto_dialog_location_range",DIALOG_LOCATION_ERROR:"k_R_goto_dialog_error",DIALOG_LOCATION_ERROR_SNAPVIEW:"k_R_goto_dialog_error_snapview"},d={DIALOG_DIV_ID:"kindleReader_dialog_goto",TITLE_LABEL_ID:"kindleReader_dialog_gotoTitle",TEXT_LABEL_ID:"kindleReader_dialog_gotoLabel",LOCATION_LABEL_ID:"kindleReader_dialog_gotoLocation",INPUT_FIELD_ID:"kindleReader_dialog_gotoField",OK_BUTTON_ID:"kindleReader_dialog_gotoGoButton",
ERROR_DIV_ID:"kindleReader_dialog_gotoError",ERROR_TEXT_ID:"kindleReader_dialog_gotoErrorText",GOTO_BUTTON_ID:"kindle_reader_goto_location_button",CANCEL_BUTTON_ID:"kindle_reader_cancel_goto_location_button",LOCATION_HINT_ID:"kindleReader_dialog_gotoLocationHint"},c=[8,9,13,27,37,39,46],b="hint",g,a,f,k,m,l=function(){var b=m.find("#"+d.INPUT_FIELD_ID),c=h(b.val());if(c===void 0||c<a.minLocation||c>a.maxLocation)if(KindleHostDeviceDetector.isMetro())document.getElementById(d.ERROR_TEXT_ID).innerText=
KindleHostDeviceDetector.isMetroSnappedView()?ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_ERROR_SNAPVIEW):ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_ERROR,{minLocation:a.minLocation,maxLocation:a.maxLocation}),document.getElementById(d.ERROR_DIV_ID).style.display="block",b.focus();else{var g=m.find("#"+d.INPUT_FIELD_ID);g.addClass("invalid_input");g.val("");KindleHostDeviceDetector.isiOS()||b.focus();setTimeout(function(){g.removeClass("invalid_input")},2E3)}else f=!0,k=c,KindleUXComponentManager.closeDialog(j)},
o=function(){KindleUXComponentManager.closeDialog(j)},q=function(b){if(b.which===27)o();else if(KindleHostDeviceDetector.isMetro()&&s(b)&&(b=h(document.getElementById(d.INPUT_FIELD_ID).value))&&b>=a.minLocation&&b<=a.maxLocation)document.getElementById(d.ERROR_DIV_ID).style.display="none"},n=function(a){s(a)?a.which===13&&(m.focus(),l(),a.preventDefault()):a.preventDefault()},r=function(){document.getElementById(d.DIALOG_DIV_ID).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>
window.outerWidth?((window.outerWidth-267)/2).toString()+"px":((window.outerWidth-530)/2).toString()+"px";document.getElementById(d.ERROR_DIV_ID).style.display="none"},s=function(a){return c.indexOf(a.keyCode)>=0||a.keyCode>=48&&a.keyCode<=57||a.keyCode>=96&&a.keyCode<=105},t={onInitializationDone:function(a){m=a;KindleTouchEventsToggler.isRequired()&&(m.find("#"+d.INPUT_FIELD_ID).focus(function(){KindleTouchEventsToggler.off()}),m.find("#"+d.INPUT_FIELD_ID).blur(function(){KindleTouchEventsToggler.on()}))},
getDialogSettings:function(){var a=null,b,c,f={autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0};if(!KindleHostDeviceDetector.isMetro())KindleHostDeviceDetector.isiPad()?(b=325,c=210):(b=275,c=155),a={},a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=o,a[ResourceBundle.getLocalizedString(e.DIALOG_OK_BTN_ID)]=l,f.width=b,f.height=c;f.buttons=a;return f},beforeDialogOpen:function(){function c(){g||(g=!0,k.val(""),k.removeClass(b))}var f,g=!1,k=m.find("#"+
d.INPUT_FIELD_ID);KindleHostDeviceDetector.isMetro()?(f=ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_RANGE,{minLocation:a.minLocation,maxLocation:a.maxLocation}),k.attr("placeholder",f),k.attr("size",15),k.attr("maxlength",15),k.addClass(b),k.val(f),k.on("click",c).on("keypress",c)):(f=ResourceBundle.getLocalizedString(e.DIALOG_TITLE_ID),m.find("#"+d.TITLE_LABEL_ID).empty().append(f),f=ResourceBundle.getLocalizedString(e.DIALOG_TEXT_ID),m.find("#"+d.TEXT_LABEL_ID).empty().append(f),f=ResourceBundle.getLocalizedString(e.DIALOG_LOCATION_TEXT_ID,
{lastLocation:a.maxLocation}),m.find("#"+d.LOCATION_LABEL_ID).empty().append(f),k.val(""));k.bind("keyup",q);KindleHostDeviceDetector.isiOS()&&k.attr("tabindex","-1")},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||m.find("#"+d.INPUT_FIELD_ID).focus();if(KindleHostDeviceDetector.isMetro())document.getElementById(d.DIALOG_DIV_ID).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?(window.outerWidth-267)/2+"px":(window.outerWidth-530)/2+"px",
document.getElementById(d.GOTO_BUTTON_ID).addEventListener("click",l,!1),document.getElementById(d.CANCEL_BUTTON_ID).addEventListener("click",o,!1),document.getElementById(d.ERROR_DIV_ID).style.display="none",window.addEventListener("resize",r,!1);if(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())m.focus(),setTimeout(function(){m.find("#"+d.INPUT_FIELD_ID).focus()},0);document.getElementById(d.INPUT_FIELD_ID).addEventListener("keydown",n,!1)},onDialogClose:function(){var a=m.find("#"+
d.INPUT_FIELD_ID);a.blur();a.unbind("keyup",q);g(f,k);if(KindleHostDeviceDetector.isMetro()){var b=a.parent(),c=b.html();a.detach();b.html(c);document.getElementById(d.GOTO_BUTTON_ID).removeEventListener("click",l,!1);document.getElementById(d.CANCEL_BUTTON_ID).removeEventListener("click",o,!1);window.removeEventListener("resize",r,!1)}document.getElementById(d.INPUT_FIELD_ID).removeEventListener("keydown",n,!1)}};return{open:function(b,c){g=c;a=b;f=!1;k=-1;KindleUXComponentManager.openDialog(j,t)},
parseLocationString:h}}(),KindleReaderGoToPageDialog=function(){function h(a){var b,c;/(^[0]*\d*$)/.exec(a)?(f.range.arabic&&(c=parseInt(a,10),c>=f.range.arabic.minPage&&c<=f.range.arabic.maxPage&&(b=a)),f.range.custom&&(c=parseInt(a,10),c>=f.range.custom.minPage&&c<=f.range.custom.maxPage&&(b=a))):PageNumberUtilities.isValidRomanNumeral(a)&&f.range.roman&&(c=PageNumberUtilities.parseRomanNumeral(a),c>=f.range.roman.minPage&&c<=f.range.roman.maxPage&&(b=a));return b}function j(){var a="",b,c,d;for(d in f.range)if(d===
"roman")b=PageNumberUtilities.toRomanNumeral(f.range[d].minPage),c=PageNumberUtilities.toRomanNumeral(f.range[d].maxPage),a+="("+b+" - "+c+")";else if(d==="arabic")b=f.range[d].minPage,c=f.range[d].maxPage,a+="("+b+" - "+c+")";return a}var e=KindleHostDeviceDetector.isMetro()?"Metro/KindleReaderGoToPageDialog":"KindleReaderGoToPageDialog",d={DialogTitle:"k_R_goto_menu_goto_page_title",DialogTitleMetro:"k_R_goto_menu_goto_page_title_metro",DialogText:"k_R_goto_menu_goto_page_message",DialogPageText:"k_R_goto_menu_goto_page",
DialogOkBtn:"k_R_goto_menu_goto_page_button",DialogCancelBtn:"k_common_cancel_button",DialogPageRange:"k_R_goto_dialog_page_range",DialogPageError:"k_R_goto_page_dialog_error",DialogPageErrorSnapview:"k_R_goto_page_dialog_error_snapview"},c={DialogDiv:"kindleReader_dialog_goto_page",TitleLabel:"kindleReader_dialog_gotoPageTitle",TextLabel:"kindleReader_dialog_gotoPageLabel",PageLabel:"kindleReader_dialog_gotoPage",InputField:"kindleReader_dialog_gotoPageField",OkButton:"kindleReader_dialog_gotoGoButton",
ErrorDiv:"kindleReader_dialog_gotoPageError",ErrorText:"kindleReader_dialog_gotoPageErrorText",GotoButton:"kindle_reader_goto_page_button",CancelButton:"kindle_reader_cancel_goto_page_button",PageHint:"kindleReader_dialog_gotoPageHint"},b=[8,9,13,27,37,39,46,67,68,73,76,77,86,88,99,100,105,108,109,118,120],g="hint",a,f,k,m,l,o=function(){var a=l.find("#"+c.InputField),b=h(a.val());if(b)k=!0,m=b,KindleUXComponentManager.closeDialog(e);else if(KindleHostDeviceDetector.isMetro()){b=document.getElementById(c.ErrorText);
if(KindleHostDeviceDetector.isMetroSnappedView())b.innerText=ResourceBundle.getLocalizedString(d.DialogPageErrorSnapview);else{var f=j();b.innerText=ResourceBundle.getLocalizedString(d.DialogPageError,{range:f})}document.getElementById(c.ErrorDiv).style.display="block";a.focus()}else{var g=l.find("#"+c.InputField);g.addClass("invalid_input");g.val("");KindleHostDeviceDetector.isiOS()||a.focus();setTimeout(function(){g.removeClass("invalid_input")},2E3)}},q=function(){KindleUXComponentManager.closeDialog(e)},
n=function(a){if(a.which===27)q();else if(KindleHostDeviceDetector.isMetro()&&t(a)&&h(document.getElementById(c.InputField).value))document.getElementById(c.ErrorDiv).style.display="none"},r=function(a){t(a)?a.which===13&&(l.focus(),o(),a.preventDefault()):a.preventDefault()},s=function(){document.getElementById(c.DialogDiv).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?((window.outerWidth-267)/2).toString()+"px":((window.outerWidth-530)/2).toString()+
"px";document.getElementById(c.ErrorDiv).style.display="none"},t=function(a){return b.indexOf(a.keyCode)>=0||a.keyCode>=48&&a.keyCode<=57||a.keyCode>=96&&a.keyCode<=105},u={onInitializationDone:function(a){l=a;KindleTouchEventsToggler.isRequired()&&(a=l.find("#"+c.InputField),a.focus(function(){KindleTouchEventsToggler.off()}),a.blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a=null,b,c,f={autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0};
if(!KindleHostDeviceDetector.isMetro())KindleHostDeviceDetector.isiPad()?(b=325,c=210):(b=275,c=155),a={},a[ResourceBundle.getLocalizedString(d.DialogCancelBtn)]=q,a[ResourceBundle.getLocalizedString(d.DialogOkBtn)]=o,f.width=b,f.height=c;f.buttons=a;return f},beforeDialogOpen:function(a){function b(){k||(k=!0,h.val(""),h.removeClass(g))}var e,k=!1,h=a.find("#"+c.InputField);KindleHostDeviceDetector.isMetro()?(a=j(),h.attr("placeholder",a),h.attr("size",15),h.attr("maxlength",15),h.addClass(g),h.val(a),
h.on("click",b).on("keypress",b)):(e=ResourceBundle.getLocalizedString(d.DialogTitle),a.find("#"+c.TitleLabel).empty().append(e),e=ResourceBundle.getLocalizedString(d.DialogText),a.find("#"+c.TextLabel).empty().append(e),e=ResourceBundle.getLocalizedString(d.DialogPageText,{lastPage:f.maxPage}),a.find("#"+c.PageLabel).empty().append(e),h.val(""));h.bind("keyup",n);KindleHostDeviceDetector.isiOS()&&h.attr("tabindex","-1")},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||l.find("#"+c.InputField).focus();
if(KindleHostDeviceDetector.isMetro())document.getElementById(c.DialogDiv).style.left=KindleHostDeviceDetector.isMetroSnappedView()?"7px":window.outerHeight>window.outerWidth?(window.outerWidth-267)/2+"px":(window.outerWidth-530)/2+"px",document.getElementById(c.GotoButton).addEventListener("click",o,!1),document.getElementById(c.CancelButton).addEventListener("click",q,!1),document.getElementById(c.ErrorDiv).style.display="none",window.addEventListener("resize",s,!1);if(KindleHostDeviceDetector.isMetro()||
KindleHostDeviceDetector.isIE())l.focus(),setTimeout(function(){l.find("#"+c.InputField).focus()},0);document.getElementById(c.InputField).addEventListener("keydown",r,!1)},onDialogClose:function(b){b=b.find("#"+c.InputField);b.blur();b.unbind("keyup",n);a(k,m);if(KindleHostDeviceDetector.isMetro()){var f=b.parent(),d=f.html();b.detach();f.html(d);document.getElementById(c.GotoButton).removeEventListener("click",o,!1);document.getElementById(c.CancelButton).removeEventListener("click",q,!1);window.removeEventListener("resize",
s,!1)}document.getElementById(c.InputField).removeEventListener("keydown",r,!1)}};return{open:function(b,c){a=c;f=b;k=!1;m=-1;KindleUXComponentManager.openDialog(e,u)}}}(),KindleReaderGoToMenu=function(){function h(){return KindleHostDeviceDetector.isMetroSnappedView()?f:a}function j(a,b){a&&r.gotoUserLocation(b)}function e(a,b){a&&r.gotoPage(b)}function d(){var a={},b=0,c;KindleHostDeviceDetector.isMetro()?c=KindleHostDeviceDetector.isMetroSnappedView()?[k.cover,k.beginning,k.page,k.location,k.toc]:
[k.cover,k.beginning,k.page,k.location,k.bookmark,k.toc]:(c=[k.cover,k.toc,k.beginning,k.page,k.location],KindleHostDeviceDetector.isIE()||c.push(k.extras));c.forEach(function(c){var f=c.name,d=ResourceBundle.getLocalizedString(c.resource);a[f]={elementId:c.id,content:d,clickHandler:c.handler};l[c.name]=b++});return a}function c(){return KindleHostDeviceDetector.isMetroSnappedView()?(q||(q=d()),q):(o||(o=d()),o)}function b(a){function b(a,c){a!==void 0&&(t[a]=c)}var f=KindlePopupMenu.ITEM_ENABLED,
d=KindlePopupMenu.ITEM_DISABLED;c();t=[];b(l.cover,f);b(l.beginning,d);b(l.location,f);b(l.toc,d);b(l.page,d);b(l.extras,d);b(l.bookmarks,d);n.cover=0;if(a!==void 0){if(a.cover!==void 0&&a.cover>=0)n.cover=a.cover;if(a.toc!==void 0&&a.toc>=0)n.toc=a.toc,b(l.toc,f);n.srp=a.srl!==void 0&&a.srl>=0?a.srl:n.cover;b(l.beginning,f)}KindleUXComponentManager.updateMenu(h(),t)}function g(){KindleUXComponentManager.hideMenu(h())}var a="KindleReaderGotoMenu",f="KindleReaderGotoMenuSnappedView",k={cover:{id:"kindleReader_goToMenuItem_goToCover",
resource:"k_R_cover_title",handler:function(){r.gotoPosition(n.cover);g();s.emit("Reader::GoToMenu::Cover")}},toc:{id:"kindleReader_goToMenuItem_goToTOC",resource:"k_R_table_of_contents_title",handler:function(){r.gotoPosition(n.toc);g();s.emit("Reader::GoToMenu::TableOfContents")}},beginning:{id:"kindleReader_goToMenuItem_goToBeginning",resource:"k_R_beginning_title",handler:function(){r.gotoPosition(n.srp);g();s.emit("Reader::GoToMenu::StartReadingPosition")}},page:{id:"kindleReader_goToMenuItem_goToPage",
resource:"k_R_goto_page_title",handler:function(){g();var a={range:r.getPageNumberRanges(),maxPage:r.getMaxPage()};KindleReaderGoToPageDialog.open(a,e);s.emit("Reader::GoToMenu::Page")}},location:{id:"kindleReader_goToMenuItem_goToLocation",resource:"k_R_goto_location_title",handler:function(){g();var a={minLocation:1,maxLocation:r.getMaxUserLocation()};KindleReaderGoToDialog.open(a,j);s.emit("Reader::GoToMenu::Location")}},bookmark:{id:"kindleReader_goToMenuItem_goToBookmark",resource:"k_R_goto_bookmark_title",
handler:function(){r.openBookmarks();g();s.emit("Reader::GoToMenu::Bookmarks")}},extras:{id:"kindleReader_goToMenuItem_bex",resource:"k_R_book_extras_title",handler:function(){r.openBookExtras();g();s.emit("Reader::GoToMenu::Bex")}}},m={};Object.keys(k).forEach(function(a){m[a]=k[a].name=a});var l={},o,q,n={},r,s,t;return{MenuItemNames:m,show:function(){if(t){var a="down",b="kindleReader_button_goto",f=!1;if(KindleHostDeviceDetector.isMetro()){var b=null,f=!0,d=KindlePopupMenu.MENU_POSITION_CONSTANTS.APPBAR_MENU_MARGIN_PX,
g,e=document.getElementById("kindleReader_footer");KindleHostDeviceDetector.isMetroSnappedView()?(a=d,g=273):(a=e.clientWidth-342-d,g=314);a=[a,e.offsetTop-g-d]}b={componentName:h(),menuItems:c(),buttonID:b,position:a,title:ResourceBundle.getLocalizedString("k_R_goto_menu_title"),isAppBarMenu:f,enabledFlags:t};KindleUXComponentManager.showMenu(b)}},hide:g,onResize:function(){KindleHostDeviceDetector.isMetro()&&(KindleUXComponentManager.hideMenu(a),KindleUXComponentManager.hideMenu(f))},bookIsReady:function(a,
c,f){r=a;s=f;c.getBookPositions().done(b)},disable:function(){t=void 0},updateGoToMenu:function(a){var b,c;if(t){for(b in a)c=l[b],c!==void 0&&(t[c]=a[b]);KindleUXComponentManager.updateMenu(h(),t)}},extractPositionsFromMetadata:b,interestingPositions:n}}(),KindleReaderHeaderBar=function(){function h(g){c=g;b&&c.find("#"+e.BUTTON_CLOSE).html(b);d(g)}var j,e={BUTTON_CLOSE:"kindleReader_button_close"},d,c,b;return{initialize:function(b,a){j=a?"Embedded/KindleReaderHeaderBar":KindleHostDeviceDetector.isMetro()?
"Metro/KindleMetroReaderHeaderBar":"KindleReaderHeaderBar";d=b;KindleUXComponentManager.initializeComponent(j,h)},setCloseButtonText:function(d){c?c.find("#"+e.BUTTON_CLOSE).html(d).attr("title",d):b=d}}}(),KindleMetroReaderAppBarOverlay=function(){function h(){$("#"+j).remove();d();return!1}var j="appBarOverlay",e=null,d=null;return{show:function(c){e||(d=c,e=$("<div id='"+j+"'></div>"),e.appendTo($("#kindleReader_book_container")).on("mousedown",h).tap(h),KindleHostDeviceDetector.isiOS()&&(e.swipeLeft(h),
e.swipeRight(h)))},remove:function(){e&&(e.remove(),e=null)}}}(),KindleMetroReaderButtonOverlay=function(){function h(c){e=c;j(c)}var j,e,d;return{initialize:function(c){j=c;KindleUXComponentManager.initializeComponent("Metro/KindleMetroReaderButtonOverlay",h)},refreshBookmarkImage:function(c){e.find("#reader_button_overlay_bookmark").toggleClass("bookmarked",c)},setVisibleBookmark:function(c){e.find("#reader_button_overlay_bookmark").css("visibility",c?"visible":"hidden")},setColor:function(c){d=
c;if(e)switch(d){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:e.removeClass("black").removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:e.removeClass("sepia").addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:e.removeClass("black").addClass("sepia")}}}}(),KindleMetroReaderViewSettings=function(){function h(){function a(){F&&clearTimeout(F);F=setTimeout(function(){$(x.FONT_SIZE_TOOLTIP).fadeOut()},1200);var b=B[this.value];w.setFontSize(b);j(b);n()}e();$(u.find(x.FONT_SIZE)).on("change",
a).on("keydown",function(a){a.shiftKey&&a.keyCode===9?(a.stopPropagation(),$(".ui-dialog").find(":tabbable").last().focus(1)):a.keyCode===27&&s()}).on("MSPointerDown",a)}function j(a){var b=$(x.FONT_SIZE_TOOLTIP);b.css("font-size",a);b.show();var a=$(x.FONT_SIZE),c=a.val()/(a.prop("max")-a.prop("min")),a=c===0?"0px":c===1?a.width()-b.outerWidth():a.width()*c-b.outerWidth()/2;b.css("left",a)}function e(){var a=$(u.find(x.FONT_SIZE)),b=B.indexOf(w.getFontSize());a.val(b)}function d(){b();var a=$(u.find(x.MARGIN));
a.on("change",function(){var b=a.val();w.setMargin(v[b]);var b=I[b],c=$(".margin_preview_overlay");c.length===0?($(document.body).append('<div id="margin_preview_left" class="margin_preview_overlay"/><div id="margin_preview_right" class="margin_preview_overlay"/>'),$(".margin_preview_overlay").css("width",b+"%").show()):c.css("width",b+"%").show();n()}).on("keydown",function(a){a.keyCode===27&&s()})}function c(){$(".margin_preview_overlay").hide()}function b(){var a=$(u.find(x.MARGIN)),b=v.indexOf(w.getMargin());
a.val(b)}function g(){function b(a,f){var d=w.getColorMode().persistedValue;a!==d&&(c.eq(d).removeClass("selected"),$(f).addClass("selected"),w.setColorMode(L[a]),n())}a();var c=$(u.find(x.COLOR_MODE)).children(),f=c.length,d;c.each(function(a,g){$(g).tap(function(){b(a,g)}).bind("keydown",function(e){e.keyCode===13||e.keyCode===32?b(a,g):e.keyCode===27?s():a===f-1&&!e.shiftKey&&e.keyCode===9?(e.stopPropagation(),e=$(".ui-dialog").find(":tabbable"),$(g).get(0)===e.last().get(0)&&e.first().focus(1)):
e.keyCode===37?a!==0&&(d=c.get(a-1),b(a-1,d),d.focus(1)):e.keyCode===39&&a!==f-1&&(d=c.get(a+1),b(a+1,d),d.focus(1))})})}function a(){var a=$(u.find(x.COLOR_MODE)).children(),b=w.getColorMode().persistedValue;a.each(function(a,c){a===b?$(c).addClass("selected"):$(c).removeClass("selected")})}function f(){function a(){var b=!f.attr("checked");w.setShowColumns(b.toString());b=b?A.ONE_COLUMN_OFF:A.ONE_COLUMN_ON;$(x.COLUMN_MODE_LABEL).text(ResourceBundle.getLocalizedString(b));n()}function b(c){switch(c.keyCode){case 37:f.attr("checked",
!1);a();break;case 39:f.attr("checked",!0);a();break;case 32:f.attr("checked",!f.is(":checked"));a();break;case 9:var g=$(".ui-dialog").find(":tabbable");!c.shiftKey&&$(d).get(0)===g.last().get(0)&&(c.stopPropagation(),g.first().focus(1));break;case 27:s()}}var c=$(u.find(x.COLUMN_MODE)),f=$(u.find(x.COLUMN_MODE_TOGGLE)),d=$(u.find(x.COLUMN_MODE_TOGGLE_LABEL)),g=$(u.find(x.COLUMN_MODE_MSG));z.columns&&z.columns!==1?(k(),d.on("keydown",b),f.on("change",a),c.show(),g.hide()):(c.hide(),g.show())}function k(){var a=
$(u.find(x.COLUMN_MODE_TOGGLE));w.getShowColumns()==="false"?(a.attr("checked",!0),$(u.find(x.COLUMN_MODE_LABEL)).text(ResourceBundle.getLocalizedString(A.ONE_COLUMN_ON))):(a.removeAttr("checked"),$(u.find(x.COLUMN_MODE_LABEL)).text(ResourceBundle.getLocalizedString(A.ONE_COLUMN_OFF)))}function m(){function a(){var c=b.prop("checked");w.setShowLocations(c.toString());c=c?A.ONE_COLUMN_ON:A.ONE_COLUMN_OFF;$(x.SHOW_LOCATION_MODE_LABEL).text(ResourceBundle.getLocalizedString(c));n()}$(u.find(x.SHOW_LOCATION_MODE));
var b=$(u.find(x.SHOW_LOCATION_MODE_TOGGLE)),c=$(u.find(x.SHOW_LOCATION_MODE_TOGGLE_LABEL));l();c.on("keydown",function(f){switch(f.keyCode){case 37:b.attr("checked",!1);a();break;case 39:b.attr("checked",!0);a();break;case 32:b.attr("checked",!b.is(":checked"));a();break;case 9:var d=$(".ui-dialog").find(":tabbable");!f.shiftKey&&$(c).get(0)===d.last().get(0)&&(f.stopPropagation(),d.first().focus(1));break;case 27:s()}});b.on("change",a)}function l(){var a=$(u.find(x.SHOW_LOCATION_MODE_TOGGLE));
w.getShowLocations()==="true"?(a.attr("checked",!0),$(u.find(x.SHOW_LOCATION_MODE_LABEL)).text(ResourceBundle.getLocalizedString(A.ONE_COLUMN_ON))):(a.removeAttr("checked"),$(u.find(x.SHOW_LOCATION_MODE_LABEL)).text(ResourceBundle.getLocalizedString(A.ONE_COLUMN_OFF)))}function o(){e();b();a();k();l()}function q(){G(w);r(!1);c()}function n(){y.equal(w)?r(!1):r(!0)}function r(a){a?$(x.APPLY_SETTINGS).removeAttr("disabled"):$(x.APPLY_SETTINGS).button("disable")}function s(){y.equal(w)||(w=y,o());KindleUXComponentManager.closeDialog(t);
c()}var t="Metro/KindleMetroReaderViewSettings",u,z,w,y,G,F,A={APPLY_BUTTON:"k_R_settings_apply_button",ONE_COLUMN_ON:"k_R_settings_column_on_button",ONE_COLUMN_OFF:"k_R_settings_column_off_button"},x={FONT_SIZE:"#kindleReader_viewSettings_fontSize_slider",FONT_SIZE_TOOLTIP:"#kindleReader_viewSettings_fontSize_slider_tooltip",MARGIN:"#kindleReader_viewSettings_margin_slider",COLOR_MODE:"#kindleReader_viewSettings_optionButtons",COLOR_WHITE:"#kindleReader_viewSettings_colorWhite",COLOR_SEPIA:"#kindleReader_viewSettings_colorSepia",
COLOR_BLACK:"#kindleReader_viewSettings_colorBlack",COLUMN_MODE:"#kindleReader_viewSettings_column_toggle_wrapper",COLUMN_MODE_TOGGLE:"#kindleReader_viewSettings_column_toggle",COLUMN_MODE_TOGGLE_LABEL:"#kindleReader_viewSettings_column_toggle_switch",COLUMN_MODE_LABEL:"#kindleReader_viewSettings_column_toggle_label",COLUMN_MODE_MSG:"#kindleReader_viewSettings_optionButtons_msg",SHOW_LOCATION_MODE:"#kindleReader_viewSettings_showLocation_toggle_wrapper",SHOW_LOCATION_MODE_TOGGLE:"#kindleReader_viewSettings_showLocation_toggle",
SHOW_LOCATION_MODE_TOGGLE_LABEL:"#kindleReader_viewSettings_showLocation_toggle_switch",SHOW_LOCATION_MODE_LABEL:"#kindleReader_viewSettings_showLocation_toggle_label",APPLY_SETTINGS:"#kindleReader_viewSettings_apply",MARGIN_PREVIEW:"#kindleReader_margin_preview"},B=[KINDLE_READER_SETTINGS_FONT_SIZE.XSMALL.size,KINDLE_READER_SETTINGS_FONT_SIZE.SMALL.size,KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,KINDLE_READER_SETTINGS_FONT_SIZE.LARGE.size,KINDLE_READER_SETTINGS_FONT_SIZE.XLARGE.size],v=[KINDLE_READER_SETTINGS_MARGIN.XLARGE.size,
KINDLE_READER_SETTINGS_MARGIN.LARGE.size,KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,KINDLE_READER_SETTINGS_MARGIN.SMALL.size,KINDLE_READER_SETTINGS_MARGIN.XSMALL.size],I=[8,10,12,20,30],L=[KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA,KINDLE_READER_SETTINGS_COLOR_MODE.BLACK],D={getDialogSettings:function(){return{autoOpen:!1,width:340,modal:!0,draggable:!1,resizable:!1,dialogClass:"settings_dialog",buttons:[{id:x.APPLY_SETTINGS.slice(1),text:ResourceBundle.getLocalizedString(A.APPLY_BUTTON),
click:q}],k4w_transparent_modal_overlay:!0}},onInitializationDone:function(a){u=a;h();d();g();f();m()},beforeDialogOpen:function(){o();r(!1);$(x.APPLY_SETTINGS).attr("tabindex",70).off("keydown").on("keydown",function(a){switch(a.keyCode){case 9:a.shiftKey||(a.stopPropagation(),$("#kindleReader_viewSettings_fontSize_slider").focus(1));break;case 13:$("#kindleReader_viewSettings_fontSize_slider").focus(1);break;case 27:s()}})},onOverlayClicked:s};return{open:function(a,b,c){y=a;w=new KindleReaderSettings;
w.copy(a);G=c;z=b;KindleUXComponentManager.openDialog(t,D);a=document.getElementById("kindleReader_footer");document.getElementsByClassName("settings_dialog")[0].style.bottom=a.clientHeight+5+"px"}}}(),KindleReaderImmersiveModeExit=function(){function h(c){j=c;j.tap(function(){d()});e(c)}var j,e,d;return{initialize:function(c,b){e=c;d=b;KindleUXComponentManager.initializeComponent("KindleReaderImmersiveModeExit",h)}}}(),KindleReaderSearchBox=function(){function h(b){function f(){n.removeClass(g)}
function d(a){a.stopPropagation()}function e(){r.val("");t.hide()}function h(){var a=$(b.inputWrapperSelector).width();r.css({width:a})}var n=$(b.searchDivSelector),r=$(b.inputElementSelector),s=$(b.searchButtonSelector);if(!a){var t=$(b.clearButtonSelector);t.on("click",e);t.hide()}n.off("focusin").off("focusout").on("focusin",function(){n.addClass(g);if(c&&c.onfocus)c.onfocus()}).on("focusout",f);r.attr("placeholder",ResourceBundle.getLocalizedString(b.placeholderStringId));r.on("click",function(){r.focus()}).on("keydown",
function(a){switch(a.keyCode){case 13:KindleEventBroker.fire("reader_search");a.stopPropagation();a.preventDefault();break;case 70:if(a[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"])a.preventDefault(),a.stopPropagation()}}).on("keyup",function(b){if(!a&&b.keyCode!==9){var c=r.val();c&&c.length?t.fadeIn(200):t.fadeOut(420)}b.stopPropagation()}).on("keypress",d);KindleTouchEventsToggler.isRequired()&&(r.focus(function(){KindleTouchEventsToggler.off()}),r.blur(function(){KindleTouchEventsToggler.on()}));
b.inputWrapperSelector&&($(b.inputWrapperSelector).on("resize",h),h());s.on("keydown",function(a){switch(a.keyCode){case 9:a.shiftKey||(f(),$("#kindleReader_sitb_pane").length>0&&(a.preventDefault(),a.stopPropagation(),KindleReaderSitbPane.selectFirstSitbResult()));break;case 13:a.stopPropagation();a.preventDefault();KindleEventBroker.fire("reader_search");break;case 70:if(a[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"])a.preventDefault(),a.stopPropagation();break;default:a.stopPropagation()}}).on("keyup",
d).on("keypress",d);j(b.enabled)}function j(a){var b=$(f.searchDivSelector);a?b.fadeIn():b.hide()}var e={searchDivSelector:"#kindleReader_sitb",searchButtonSelector:"#kindleReader_button_sitb",inputWrapperSelector:"#kindleReader_input_sitb",inputElementSelector:"#kindleReader_input_sitb_box",placeholderStringId:"k_R_menuInput_sitb_placeholder",clearButtonSelector:"#kindleReader_input_sitb_clear",enabled:!1},d={searchDivSelector:"#searchArea",searchButtonSelector:"#kindleReader_search_submit",inputElementSelector:"#kindleReader_search_field",
placeholderStringId:"k_R_search_placeholder",enabled:!0},c,b,g="active",a=KindleHostDeviceDetector.isMetro(),f=a?d:e;return{initialize:function(a){b=f.inputElementSelector;h(f);c=a},getSearchText:function(){return $(b).val()},setActive:function(a){a||a===void 0?$(b).focus():$(b).blur()},setEnabled:j}}(),KindleReaderSitbPane=function(){function h(){return w.find("#"+z.Container)}function j(){$("#"+z.Dialog).css("height",e());var a=w.find("#"+z.IndexingMsg),b=w.find("#"+z.ScrollWrapper).height();a.css("margin-top",
b/2-a.height()/2);KindleHostDeviceDetector.isiOS()||(a=$("#"+z.Search).offset().left-$("#"+z.Dialog).offset().left,a=$("#"+z.Search).width()-a+21,a<-13?$("#"+z.Beak).hide():$("#"+z.Beak).show().css({right:a+"px"}))}function e(){var a=document.getElementById("kindleReader_header"),b=document.getElementById("kindleReader_footer"),a=a.getBoundingClientRect().bottom+12;return b.getBoundingClientRect().top-12-a}function d(b){function c(){return $(document.createElement("div")).addClass(z.Overlay).click(a).dblclick(a)}
var f=[],d=b.getBoundingClientRect(),b=c();b.css({top:0,right:window.outerWidth-d.left});f.push(b);b=c();b.css({top:0,right:0,width:window.outerWidth-d.right});f.push(b);b=c();b.css({top:0,left:0,height:d.top});f.push(b);b=c();b.css({top:d.top+d.height,bottom:0,height:"auto",left:0});f.push(b);return f}function c(){J=KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()}function b(){j();g()}function g(){if(v)L?L.refresh():L=new iScroll(z.ScrollWrapper,{vScrollbar:!1});else if(I){var a=
$("#"+z.ScrollWrapper).height(),b=h();b.height(a);b.jScrollPane({showArrows:!0,verticalGutter:10});b.off("keydown").off("keyup").on("keydown",o).on("keyup",m)}}function a(){if(D){f();w.detach();for(var a=0;a<y.length;a++)y[a].detach();window.removeEventListener("resize",j);D.resolve();D=null}}function f(){k();var a=h();a&&(v?(a.empty(),L&&L.scrollTo(0,0,0,!1)):I?a.data("jsp")&&a.data("jsp").getContentPane()&&a.data("jsp").getContentPane().empty():a.empty())}function k(){B&&(B.removeClass(H),B=null)}
function m(a){a.stopPropagation()}function l(){if(I)h().data("jsp").scrollToElement(B);else if(!v){var a=B.get(0).offsetTop,b=B.get(0).offsetTop+B.get(0).clientHeight,c=h().scrollTop(),f=h().scrollTop()+h().height();a<c?h().scrollTop(a):b>f&&h().scrollTop(b-h().height())}}function o(b){var c=b.keyCode||b.which;b.stopPropagation();KindleEventUtil.preventKeyScroll(b);switch(c){case 36:n();break;case 35:var f;I?f=h().data("jsp").getContentPane().children().last():v||(f=h().children().last());v||(f.length>
0&&f.attr("id")===z.SpinnerContainer&&(f=f.prev()),f.length>0&&f.attr("id")!==z.SpinnerContainer&&(B&&B.removeClass(H),B=f,B.addClass(H),l(),h().focus()));break;case 38:B&&(b=B.prev(),b.length>0&&(B.removeClass(H),B=b,B.addClass(H),l()));break;case 40:B&&(b=B.next(),b.length>0&&b.attr("id")!==z.SpinnerContainer&&(B.removeClass(H),B=b,B.addClass(H),l()));break;case 13:B&&(B.tap(),h().focus());break;case 9:k();b.shiftKey||(b.preventDefault(),document.getElementById(z.SearchBox).focus());break;case 27:a()}}
function q(a){var a=$(a.currentTarget),b=J;J=!1;if(b)return!1;if(B)if(B===a)return;else B.removeClass(H),B=a,a.addClass(H);else B=a,B.addClass(H);h().focus()}function n(){var a;I?a=h().data("jsp").getContentPane().children().first():v||(a=h().children().first());!v&&a.length>0&&a.attr("id")!==z.SpinnerContainer&&(B&&B.removeClass(H),B=a,B.addClass(H),l(),h().focus())}function r(){var a=$("#"+z.CurLocMarker),b="";(b=$.data(a[0],"page"))?b=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_page_past",
{page:b}):(b=$.data(a[0],"location"),b=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_location_past",{location:b}));a.find("."+z.LocationMarker).text(b)}function s(){I?M.appendTo(h().data("jsp").getContentPane()):M.appendTo(h())}var t={Searching:"Searching",NotAvailable:"NotAvailable",Indexing:"Indexing",Complete:"Complete"},u={Indexing:"k_R_dialog_sitb_pane_title_indexing",Searching:"k_R_dialog_sitb_pane_title_searching",ResultsFound:"k_R_dialog_sitb_pane_title_resultsFound",OneResultFound:"k_R_dialog_sitb_pane_title_oneResultFound",
NotAvailable:"k_R_dialog_sitb_pane_title_notAvailable",Page:"k_R_dialog_sitb_result_page",Location:"k_R_dialog_sitb_result_location"},z={Dialog:"kindleReader_sitb_pane",Title:"kindleReader_sitb_pane_title",CloseButton:"kindleReader_sitb_pane_close_btn",Container:"kindleReader_sitb_pane_container",ScrollWrapper:"kindleReader_sitb_pane_scrollWrapper",Beak:"kindleReader_sitb_pane_beak",CurLocMarker:"kindleReader_sitb_pane_cur_loc_marker",SpinnerContainer:"kindleReader_sitb_spinner_container",Spinner:"kindleReader_sitb_spinner",
Search:"kindleReader_sitb",SearchBox:"kindleReader_input_sitb_box",IndexingMsg:"kindleReader_sitb_message",Overlay:"kindleReader_sitb_pane_overlay",ResultContainer:"kindleReader_sitb_result_container",ContextBody:"kindleReader_sitb_result_context_body",LocationMarker:"kindleReader_sitb_result_cur_loc_marker",ContextFooter:"kindleReader_sitb_context_footer",PageNumber:"kindleReader_sitb_pagenumber",Location:"kindleReader_sitb_location"},w=null,y=null,G=null,F=null,A=null,x=null,B=null,v=KindleHostDeviceDetector.isiOS(),
I=!v&&!KindleHostDeviceDetector.isIE(),L=null,D=null,K=KindleHostDeviceDetector.isiOS(),M=$("<div id='kindleReader_sitb_spinner_container'><div id='kindleReader_sitb_spinner'></div></div>"),H="selected",J=!1;return{States:t,show:function(g){if(D)return f(),s(),K&&h().focus(),D.promise();w||(w=$(Handlebars.templates.KindleReaderSitbPane()),w.find("#"+z.CloseButton).click(a));if(!y){var e=document.getElementById("kindleReader_sitb");y=d(e)}if(!G&&(G=$(Handlebars.templates.KindleReaderSitbResult()),
!K))G.on("mouseover",q);if(!A&&(A=$(Handlebars.templates.KindleReaderSitbResultCurLocMarker()),!K))A.on("mouseover",q);F||(F=$(Handlebars.templates.KindleReaderSimpleSpinner()),F.appendTo(M.find("#"+z.Spinner)));x||(x=g);(function(){var a=$("body");a.append(w);for(var b=0;b<y.length;b++)a.append(y[b])})();j();v?h().focus():(I?h().jScrollPane({showArrows:!0,verticalGutter:10}):h().addClass("ie_scrollable"),h().off("keydown").off("keyup").on("keydown",o).on("keyup",m).on("scroll",c));s();window.addEventListener("resize",
b,!1);D=$.Deferred();return D.promise()},close:a,selectFirstSitbResult:n,showErrorMessage:function(b){a();switch(b){case Kindle.ERROR.SITB_OFFLINE:case Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED:case Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE:case Kindle.ERROR.SITB_LANGUAGE_UNDEFINED:KindleMessageDialog.showError(b,null,"Close");break;default:KindleMessageDialog.showError(Kindle.ERROR.SITB_COMMON_ERROR,null,"Close")}},setViewState:function(a,b){var c;switch(a){case t.Searching:w.find("#"+z.IndexingMsg).hide();
c=ResourceBundle.getLocalizedString(u.Searching);w.find("#"+z.SpinnerContainer).show();break;case t.Indexing:w.find("#"+z.IndexingMsg).show();c=ResourceBundle.getLocalizedString(u.Indexing);break;case t.Complete:b=b?b:0,c=ResourceBundle.getLocalizedString(b!==1?u.ResultsFound:u.OneResultFound).replace("${numberResults}",b),w.find("#"+z.SpinnerContainer).hide(),g()}w.find("#"+z.Title).text(c)},addItem:function(a){var b=G.clone(!0),c="",f=c="",d="";b.find("."+z.ContextBody).html(a.context);a.pageNumber&&
(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_page",{page:a.pageNumber}));a.location&&(c!==""&&(f=" \u25cf "),d=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_location",{location:a.location}));b.find("."+z.Location).text(c+f+d);b.click(function(){x(a);r()});b.insertBefore(M);g()},addLocationMarker:function(a){var b=A.clone(!0),c="";a.pageNumber?(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_page",{page:a.pageNumber}),$.data(b[0],"page",a.pageNumber)):
(c=ResourceBundle.getLocalizedString("k_R_dialog_sitb_result_current_location",{location:a.location}),$.data(b[0],"location",a.location));b.find("."+z.LocationMarker).text(c);b.click(function(){x(a);r()});b.insertBefore(M);g()}}}(),KindleReaderLocationBar=function(){function h(a){var b=y.find("#"+t.PROGRESS_BAR_ID),c=y.find("#"+t.POPUP_LABEL_ID),f=y.find("#"+t.FooterReaderControlsLeft),d=c.outerWidth();$(window).width();b=b.width();f=f.width();a=(a-G)/(F-G)*b;a=a<0?0:a;a+=f;c.css("left",(d/2+5+f>
a?5+f:a+d/2>b+f-5?b+f-d:a-d/2)+"px")}function j(a,b){v=!0;KindleReaderUI.getPNLabelFromLocation(b.value).done(function(a){c(b.value,a);h(b.value,a)})}function e(a,b){v=!1;F>0&&w(b.value)}function d(){y&&F>0&&G>=0&&y.find("#"+t.PROGRESS_BAR_ID).slider("option","min",G).slider("option","max",F).slider("option","disabled",!1)}function c(a,b){var c;c=b?ResourceBundle.getLocalizedString("k_R_slider_pageNumber_popup",{page:b})+" \u00b7 "+ResourceBundle.getLocalizedString("k_R_slider_loc_popup",{location:a}):
ResourceBundle.getLocalizedString("k_R_slider_location_popup",{location:a});y.find("#"+t.POPUP_LABEL_ID).text(c);c=ResourceBundle.getLocalizedString("k_R_slider_percentage",{percent:Math.round(a/F*100)});var f=ResourceBundle.getLocalizedString("k_R_slider_location",{location:a,totalLocations:F}),d="";b&&b!==""&&A!==""&&(d=ResourceBundle.getLocalizedString("k_R_slider_pageNumber",{page:b,totalPages:A})+" \u00b7 ");K.text(c+" \u00b7 "+d+f)}function b(){if(y&&x>=0){var a=x;y.find("#"+t.PROGRESS_BAR_ID).slider("option",
"value",a);c(x,B)}}function g(a){v||a<0?clearTimeout(L):L=setTimeout(function(){o()},a)}function a(a){v||a<0?clearTimeout(I):I=setTimeout(function(){o()},a)}function f(){D?y.find("#"+t.PROGRESS_BAR_ID).addClass("black"):y.find("#"+t.PROGRESS_BAR_ID).removeClass("black")}function k(a){var a=a.originalEvent,b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c="mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var f=document.createEvent("MouseEvent");
f.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(f);a.preventDefault()}function m(a){y=a;K=y.find("#"+t.MESSAGE_LABEL_ID);M=y.find("#"+t.DOWNLOAD_PROGRESS_ID);H=y.find("#"+t.DOWNLOAD_PROGRESS_MESSAGE_ID);M.prepend(Handlebars.templates.KindleReaderSimpleSpinner({}));J=y.find(".spinner");J.attr("id",t.DOWNLOAD_PROGRESS_SPINNER_ID);var c=a.find("#"+t.PROGRESS_BAR_ID);c.slider({range:"min",value:1,max:100,min:1,step:1,animate:!KindleHostDeviceDetector.isMetro(),
disabled:!0,slide:j,stop:e});c.find("."+u.RANGE).addClass("ui-corner-left");c.find("."+u.HANDLE).removeAttr("href");c.find("."+u.HANDLE).attr("id",t.PROGRESS_BAR_HANDLE_ID);q();f();d();b();KindleHostDeviceDetector.isiPad()&&(y.bind("touchstart",k),y.bind("touchmove",k),y.bind("touchend",k),y.bind("touchmove",l),y.bind("touchend",o),y.bind("touchcancel",o));z(a)}function l(){var a=y.find("#"+t.PROGRESS_BAR_ID),b=y.find("#"+t.POPUP_ID);F>0&&(b.show(),h(a.slider("option","value")))}function o(){y&&y.find("#"+
t.POPUP_ID).hide()}function q(){function b(){F>0&&(a(-1),E&&r())}function c(){v&&y.mouseup();a(2E3)}!KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isMetro()&&(y.find("#"+t.PROGRESS_BAR_ID).find("."+u.HANDLE).hover(function(){F>0&&(g(-1),l())},function(){g(500)}),y.hover(b,c),a(2E3))}function n(a){function b(){y.removeClass("downloading").addClass("download_completed")}J.removeClass("spinner");a>0&&(a=ResourceBundle.getLocalizedString("k_R_downloaded",{percent:100}),M.addClass("finished"),
H.text(a));(KindleHostDeviceDetector.isiOS()?!N:H.is(":visible"))?b():E=b}function r(){setTimeout(function(){E&&(E(),E=null)},1E3)}var s=KindleHostDeviceDetector.isMetro()?"Metro/KindleMetroReaderFooterBar":"KindleReaderLocationBar",t={PROGRESS_BAR_ID:"kindleReader_progressbar_div",PROGRESS_BAR_HANDLE_ID:"kindleReader_progressbar_handle",MESSAGE_LABEL_ID:"kindleReader_footer_message",POPUP_ID:"kindleReader_locationPopup_div",POPUP_LABEL_ID:"kindleReader_locationPopup_labelDiv",DOWNLOAD_PROGRESS_ID:"kindleReader_download_progress",
DOWNLOAD_PROGRESS_MESSAGE_ID:"kindleReader_download_progress_message",DOWNLOAD_PROGRESS_SPINNER_ID:"kindleReader_download_spinner",FooterReaderControlsLeft:"kindleReader_footer_readerControls_left"},u={HANDLE:"ui-slider-handle",RANGE:"ui-slider-range"},z,w,y,G=-1,F=-1,A=-1,x=-1,B,v=!1,I,L,D,K,M,H,J,O={IN_PROGRESS:"in_progress",COMPLETED:"completed",DISK_ERROR:"disk_error",NETWORK_ERROR:"network_error"},C=-1,E,N=!1;return{DOWNLOAD_COMPLETED:O.COMPLETED,DOWNLOAD_IN_PROGRESS:O.IN_PROGRESS,DOWNLOAD_DISK_ERROR:O.DISK_ERROR,
DOWNLOAD_NETWORK_ERROR:O.NETWORK_ERROR,initialize:function(a,b){z=a;w=b;KindleUXComponentManager.initializeComponent(s,m)},setMinMaxLocation:function(a,b){F=b;G=a;d()},setMinMaxPageNumber:function(a,b){A=b},updateLocation:function(a){x=a;b()},updatePageLabel:function(a){B=a.pageNumber;x=a.loc;b()},setLocationBarBlack:function(a){D=a;y&&f()},hidePopup:o,updateDownloadProgress:function(a,b){K.is(":visible")||(M.hide(),J.removeClass("spinner"));switch(a){case O.COMPLETED:n(C);break;case O.IN_PROGRESS:C=
b;if(y&&b>=0&&b<=100){var c=ResourceBundle.getLocalizedString("k_R_downloading",{percent:b});y.addClass("downloading");H.text(c);J.addClass("spinner")}break;case O.DISK_ERROR:case O.NETWORK_ERROR:c=C>0?C+"% ":"";y.removeClass("downloading").addClass("download_error");if(a===O.DISK_ERROR){if(c=ResourceBundle.getLocalizedString("k_R_download_disk_error",{percent:c,url:Kindle.ExternalLinks.HelpIncreaseOfflineStorage}),KindleHostDeviceDetector.isMetro()){var c=$("<div>").html(c),f=c.children("#kindleReader_download_disk_error"),
d=$("<span>").attr("id",f.attr("id")).html(f.html());f.replaceWith(d);c=c.html()}}else c=ResourceBundle.getLocalizedString("k_R_download_network_error",{percent:c});H.html(c)}},setImmersiveMode:function(a){N=a;!N&&E&&r()}}}(),KindleReaderImmersiveFooter=function(){function h(){var c="",d="";if(b){switch(a){case "location":f&&(d=ResourceBundle.getLocalizedString("k_R_slider_location_popup",{location:f}));break;case "page":k&&(d=ResourceBundle.getLocalizedString("k_R_slider_pageNumber_popup",{page:k}));
break;case "noLabel":percentageLabel=d=""}d&&(c=d)}l.innerHTML=c}function j(){clearTimeout(m);do a=c[a].next;while(!c[a].enabled);h();m=setTimeout(function(){var b=a.charAt(0).toUpperCase()+a.slice(1);g.emit("Reader::Immersive::"+b);m=null},2E3)}function e(a){a==="true"?(b=!0,l.style.cursor="pointer",g.emit("Reader::Immersive::Enable")):(b=!1,l.style.cursor="default",g.emit("Reader::Immersive::Disable"));h()}var d={IMMERSIVE_LABEL:"kindleReader_immersiveFooter"},c={page:{next:"location"},location:{next:"timeLeftInChapter",
enabled:!0},timeLeftInChapter:{next:"timeLeftInBook"},timeLeftInBook:{next:"noLabel"},noLabel:{next:"page"}},b=!0,g,a="location",f,k,m,l;return{initialize:function(a,b){g=a;l=document.getElementById(d.IMMERSIVE_LABEL);l.addEventListener("click",j,!1);e(b)},updateLabel:function(a){k=a.pageNumber;f=a.loc;h()},setMaxLocation:function(){},enableLabelType:function(b){a=b;c[b].enabled=!0},enable:e}}(),KindleReaderPageArrow=function(){function h(c){f=c;f.find("#"+d.LEFT_AREA_ID).click(b);f.find("#"+d.RIGHT_AREA_ID).click(g);
f.find("#"+d.LEFT_AREA_ID).tap(b);f.find("#"+d.RIGHT_AREA_ID).tap(g);a(f);j();e()}function j(){k?f.find("#"+d.LEFT_AREA_ID).addClass("pageArrow"):f.find("#"+d.LEFT_AREA_ID).removeClass("pageArrow");m?f.find("#"+d.RIGHT_AREA_ID).addClass("pageArrow"):f.find("#"+d.RIGHT_AREA_ID).removeClass("pageArrow")}function e(){switch(l){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:f.find("."+c).removeClass("black");f.find("."+c).removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:f.find("."+
c).removeClass("sepia");f.find("."+c).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:f.find("."+c).removeClass("black"),f.find("."+c).addClass("sepia")}}var d={LEFT_AREA_ID:"kindleReader_pageTurnAreaLeft",RIGHT_AREA_ID:"kindleReader_pageTurnAreaRight"},c="kindleReader_pageTurnArea",b,g,a,f,k,m,l;return{initialize:function(c,f,d){a=c;b=f;g=d;KindleUXComponentManager.initializeComponent("KindleReaderPageArrow",h)},setArrowEnabled:function(a,b){k=a;m=b;f&&j()},setArrowColor:function(a){l=
a;f&&e()}}}(),KindleReaderSampleEnd=function(){var h={TITLE_LABEL_STRING_ID:"k_endOfSample_Title",TEXT_LABEL_STRING_ID:"k_endOfSample_Text",BUY_BUTTON_STRING_ID:"k_endOfSample_buy_button",CANCEL_BUTTON_STRING_ID:"k_endOfSample_cancel_button"},j={TITLE_LABEL_ID:"kindle_sample_end_title_text",TEXT_LABEL_ID:"kindle_sample_end_message_text"},e,d,c=function(){d="buy";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},b=function(){d="cancel";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},
g={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(h.CANCEL_BUTTON_STRING_ID)]=b;a[ResourceBundle.getLocalizedString(h.BUY_BUTTON_STRING_ID)]=c;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(h.TITLE_LABEL_STRING_ID),c=ResourceBundle.getLocalizedString(h.TEXT_LABEL_STRING_ID);a.find("#"+j.TITLE_LABEL_ID).empty().append(b);a.find("#"+j.TEXT_LABEL_ID).empty().append(c)},
onDialogClose:function(){e(d)}};return{open:function(a){e=a;d=!1;KindleUXComponentManager.openDialog("KindleReaderSampleEnd",g)}}}(),KindleReaderSettingsDialog=function(){function h(){var a=t.find(w.FONT_SIZE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_FONT_SIZE[a].size;n.getFontSize()!==b&&(n.setFontSize(b),o(),j(),r=!0)}},c;for(c in KINDLE_READER_SETTINGS_FONT_SIZE)a.find(KINDLE_READER_SETTINGS_FONT_SIZE[c].id).tap(b(c))}function j(){var a=n.getFontSize(),
b;for(b in KINDLE_READER_SETTINGS_FONT_SIZE)a===KINDLE_READER_SETTINGS_FONT_SIZE[b].size?t.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","visible"):t.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","hidden")}function e(){var a=t.find(w.MARGIN_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_MARGIN[a].size;n.getMargin()!==b&&(n.setMargin(b),d(),r=!0)}},c;for(c in KINDLE_READER_SETTINGS_MARGIN)a.find(KINDLE_READER_SETTINGS_MARGIN[c].id).tap(b(c))}
function d(){var a=n.getMargin(),b;for(b in KINDLE_READER_SETTINGS_MARGIN)a===KINDLE_READER_SETTINGS_MARGIN[b].size?t.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","visible"):t.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","hidden")}function c(){var a=t.find(w.COLUMN_MODE_PANEL_ID).buttonset(),c=function(a){return function(){var c=KINDLE_READER_SETTINGS_COLUMN_MODE[a].persistedValue;n.getShowColumns()!==c&&(n.setShowColumns(c),b(),r=!0)}},f;for(f in KINDLE_READER_SETTINGS_COLUMN_MODE)u.columns&&
u.columns!==1&&a.find(KINDLE_READER_SETTINGS_COLUMN_MODE[f].id).tap(c(f))}function b(){var a=n.getShowColumns(),b;for(b in KINDLE_READER_SETTINGS_COLUMN_MODE)a===KINDLE_READER_SETTINGS_COLUMN_MODE[b].persistedValue?t.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).addClass("on"):t.find(KINDLE_READER_SETTINGS_COLUMN_MODE[b].id).removeClass("on")}function g(){var b=t.find(w.SHOW_LOCATION_PANEL_ID).buttonset(),c=function(b){return function(){var c=KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].persistedValue;
n.getShowLocations()!==c&&(n.setShowLocations(c),a(),r=!0)}},f;for(f in KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE)b.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[f].id).tap(c(f))}function a(){var a=n.getShowLocations(),b;for(b in KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE)a===KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].persistedValue?t.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].id).addClass("on"):t.find(KINDLE_READER_SETTINGS_SHOW_LOCATION_MODE[b].id).removeClass("on")}function f(){var a=
t.find(w.COLOR_MODE_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_COLOR_MODE[a];n.getColorMode()!==b&&(n.setColorMode(b),o(),k(),r=!0)}},c;for(c in KINDLE_READER_SETTINGS_COLOR_MODE)a.find(KINDLE_READER_SETTINGS_COLOR_MODE[c].id).tap(b(c))}function k(){var a=n.getColorMode(),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)a===KINDLE_READER_SETTINGS_COLOR_MODE[b]?t.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","visible"):t.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+
"Selected").css("visibility","hidden");t.find(":not("+a.id+")").removeClass("selected");t.find(a.id).addClass("selected")}function m(){s=!0;KindleUXComponentManager.closeDialog(q)}function l(){KindleUXComponentManager.closeDialog(q)}function o(){var a=t.find(w.PREVIEW_ID);n.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK?a.css({"box-shadow":"inset 0 0 10px #444444","-moz-box-shadow":"inset 0 0 10px #444444","-webkit-box-shadow":"inset 0 0 10px #444444","border-color":"#AAAAAA"}):a.css({"box-shadow":"inset 0 0 10px #666666",
"-moz-box-shadow":"inset 0 0 10px #666666","-webkit-box-shadow":"inset 0 0 10px #666666","border-color":"#000000"});a.css({color:n.getFGColor(),"font-size":n.getFontSize()+"px",backgroundColor:n.getBGColor()})}var q="KindleReaderSettingsDialog",n,r,s,t,u,z={SAMPLE_STRING_ID:"k_R_settings_sampleText",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button",APPLY_BUTTON_STRING_ID:"k_R_settings_apply_button",COLUMN_MODE_ON_BUTTON_STRING_ID:"k_R_settings_column_on_button",COLUMN_MODE_OFF_BUTTON_STRING_ID:"k_R_settings_column_off_button"},
w={PREVIEW_ID:"#kindleReader_controlPanel_preview",FONT_SIZE_PANEL_ID:"#kindleReader_controlPanel_fontSize",COLOR_MODE_PANEL_ID:"#kindleReader_controlPanel_colorMode",MARGIN_PANEL_ID:"#kindleReader_controlPanel_margin",COLUMN_MODE_PANEL_ID:"#kindleReader_controlPanel_multiColumn",COLUMN_MODE_ON_ID:"#kindleReader_controlPanel_columnButton_on",COLUMN_MODE_OFF_ID:"#kindleReader_controlPanel_columnButton_off",COLUMN_MODE_MSG_ID:"#kindleReader_controlPanel_optionButtons_msg",SHOW_LOCATION_PANEL_ID:"#kindleReader_controlPanel_showLocation",
SHOW_LOCATION_ON_ID:"#kindleReader_controlPanel_showLocationButton_on",SHOW_LOCATION_OFF_ID:"#kindleReader_controlPanel_showLocationButton_off"},y,G={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(z.CANCEL_BUTTON_STRING_ID)]=l;a[ResourceBundle.getLocalizedString(z.APPLY_BUTTON_STRING_ID)]=m;return{autoOpen:!1,width:380,modal:!0,draggable:!1,resizable:!1,buttons:a,dialogClass:"settings_dialog"}},onInitializationDone:function(a){t=a;t.find(w.PREVIEW_ID).text(ResourceBundle.getLocalizedString(z.SAMPLE_STRING_ID));
h();e();f();c();g()},beforeDialogOpen:function(c){t=c;o();j();d();k();b();a()},onDialogClose:function(){s&&r&&y(n)}};return{open:function(a,b,c){!/iPod/.test(navigator.userAgent)&&!/iPhone/.test(navigator.userAgent)&&(n=new KindleReaderSettings,n.copy(a),r=!1,y=c,s=r=!1,u=b,KindleUXComponentManager.openDialog(q,G),KindleDeviceCapabilities.multiColumnMode()?b.columns&&b.columns!==1?$(w.COLUMN_MODE_MSG_ID).removeClass("show"):($(w.COLUMN_MODE_MSG_ID).addClass("show"),$(w.COLUMN_MODE_ON_ID).addClass("on"),
$(w.COLUMN_MODE_ON_ID).unbind("tap"),$(w.COLUMN_MODE_OFF_ID).toggle(!1),$(w.COLUMN_MODE_OFF_ID).removeClass("on")):$(w.COLUMN_MODE_PANEL_ID).hide())}}}(),KindleReaderSyncPositionDialog=function(){function h(b){var c=a.find("#"+e.SYNC_BUTTON_ID+" .ui-button-text"),f=a.find("#"+e.RESET_BUTTON_ID+" .ui-button-text");b==="page"?(c.text(ResourceBundle.getLocalizedString(j.SYNC_PAGE_BUTTON_STRING_ID)),f.text(ResourceBundle.getLocalizedString(j.RESET_PAGE_BUTTON_STRING_ID))):(c.text(ResourceBundle.getLocalizedString(j.SYNC_BUTTON_STRING_ID)),
f.text(ResourceBundle.getLocalizedString(j.RESET_BUTTON_STRING_ID)))}var j={TEXT_LABEL_STRING_ID:"k_R_syncPosition_labelText",TEXT_LABEL_PN_STRING_ID:"k_R_syncPosition_PN_labelText",TEXT_LABEL_STRING_ID_NO_DEVICE_NAME:"k_R_syncPosition_noDeviceName_labelText",TEXT_LABEL_PN_STRING_ID_NO_DEVICE_NAME:"k_R_syncPosition_noDeviceName_labelText",CANCEL_BUTTON_STRING_ID:"k_R_syncPosition_cancelText",SYNC_BUTTON_STRING_ID:"k_R_syncPosition_sync",RESET_BUTTON_STRING_ID:"k_R_syncPosition_reset",SYNC_PAGE_BUTTON_STRING_ID:"k_R_syncPosition_page_sync",
RESET_PAGE_BUTTON_STRING_ID:"k_R_syncPosition_page_reset"},e={TEXT_LABEL_ID:"kindleReader_dialog_syncPosition_label",CANCEL_BUTTON_ID:"kindleReader_syncPosition_cancel",RESET_BUTTON_ID:"kindleReader_dialog_syncPosition_reset_btn",SYNC_BUTTON_ID:"kindleReader_dialog_syncPosition_sync_btn"},d={CANCEL:0,SYNC:1,RESET:2},c,b,g,a,f=function(){g=d.SYNC;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},k=function(){g=d.RESET;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},
m=function(){g=d.CANCEL;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},l={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(j.CANCEL_BUTTON_STRING_ID)]=m;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(a){var c,f;if(b.fprDevice&&b.fprDevice!=="null"){f=new Date(b.fprDateTime);c=ResourceBundle.getLocalizedTime(f);var d=ResourceBundle.getLocalizedDate(f);b.currentPage?(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_PN_STRING_ID,
{currentPage:b.currentPage,page:b.fprPage,deviceName:b.fprDevice,time:c,date:d}),h("page")):(f=b.fprLocation,b.fprPage&&(f+=" (Page "+b.fprPage+")"),c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_STRING_ID,{currentLocation:b.currentLocation,location:f,deviceName:b.fprDevice,time:c,date:d}),h("location"))}else b.currentPage?(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_PN_STRING_ID_NO_DEVICE_NAME,{currentPage:b.currentPage,page:b.fprPage}),h("page")):(c=ResourceBundle.getLocalizedString(j.TEXT_LABEL_STRING_ID_NO_DEVICE_NAME,
{currentLocation:b.currentLocation,location:b.fprLocation}),h("location"));a.find("#"+e.TEXT_LABEL_ID).empty().append(c)},onDialogClose:function(){c(g)},onInitializationDone:function(b){a=b;a.find("#"+e.SYNC_BUTTON_ID).click(f);a.find("#"+e.RESET_BUTTON_ID).click(k)}};return{open:function(a,f){c=f;g=d.CANCEL;b=a;KindleUXComponentManager.openDialog("KindleReaderSyncPositionDialog",l)},USER_RESPONSES:d}}(),KindleReaderTutorial=function(){function h(e,d,c){function b(){e.image.fadeOut("slow",function(){e.backdrop.fadeOut("slow",
function(){e.backdrop.remove()})})}c.increment();e.image.click(b);e.backdrop.click(b);$(document).keyup(function(c){c.keyCode===13&&b();c.keyCode===27&&b()});e.backdrop.hide().appendTo(d);e.image.hide();e.backdrop.fadeIn("slow",function(){e.image.fadeIn("slow")})}var j={comic:1,children:1};return{show:function(e){var d=$("#kindleReader_book_container"),c=LocalStorageCounter("kcrNotifications.zTutorial."+e);if(c.getValue()===0&&!KindleHostDeviceDetector.isMetro()){var b,g=KindleHostDeviceDetector.isTouchDevice();
if(e===Kindle.BookInfo.PublisherMetadata.COMIC)b=g?"images/uncached/tutorial_zoomables_comics_tap.png":"images/uncached/tutorial_zoomables_comics.png";else if(e===Kindle.BookInfo.PublisherMetadata.CHILDREN)b=g?"images/uncached/tutorial_zoomables_childrens_tap.png":"images/uncached/tutorial_zoomables_childrens.png";else return;KindleHostDeviceDetector.isNetworkAvailable().done(function(){KindleImageViewer({imageSource:b,parent:d}).done(function(a){h(a,d,c)})})}},getMaxShowCount:function(e){return j[e]||
1}}}(),dictionary=function(){var h=null,j={en:!0};return{getDictionary:function(){return h=h||dictionaryDotComFactory()},isLanguageSupported:function(e){return!!j[e.substring(0,2)]}}}(),IDictionary=function(){var h={lookup:function(){throw Error("Failed to implement lookup");}};Object.defineProperty(h,"NOT_WORD",{value:"Not a word",enumerable:!0});Object.defineProperty(h,"NOT_FOUND",{value:"No definition found",enumerable:!0});Object.defineProperty(h,"LOOKUP_FAILED",{value:"Word lookup failed",enumberable:!0});
Object.defineProperty(h,"OFFLINE",{value:"Offline",enumberable:!0});return h}(),ILookup=function(){return{entry:"",getDefinitions:function(){throw Error("Failed to implement getDefinitions");},getPronunciation:function(){throw Error("Failed to implement pronunciation");},getPronunciationUrls:function(){throw Error("Failed to implement pronunciationUrl");}}}();
function dictionaryDotComFactory(){function h(b){return(b=j.exec(b))&&b.length===2?b[1]:""}var j=/^\W*(\w+(?:-\w+)*(?:'\w+)?)\W*$/,e="https://app.dictionary.com/dictaudio/{audio_file}.mp3",d="https://app.dictionary.com/dictaudio/lunawav/{audio_file}.wav",c=Object.create(IDictionary);c.lookup=function(b){function c(a){function b(a,c){function f(a){$.each(a.definitions,function(a,b){b.content&&g.push(b.content)})}function d(a,b){b&&(b.type==="group"?f(b):b.definition.content&&g.push(b.definition.content))}
var g=[];a&&c&&($.each(c,d),g.length&&n.push({partOfSpeech:a,definitions:g}))}a&&a.result&&typeof a.result==="string"&&(a=JSON.parse(a.result));if(!a||!a.entries||!a.entries.length)f.reject(IDictionary.NOT_FOUND);else{var g=a.entries[0],a=g.entry,h=g.pronunciation_spell,j;if(g.audio_file)j={},j.mp3=encodeURI(e.replace("{audio_file}",g.audio_file)),j.wav=encodeURI(d.replace("{audio_file}",g.audio_file));var n=[];g.definitions&&$.each(g.definitions,b);g=Object.create(ILookup);Object.defineProperty(g,
"entry",{value:a,enumerable:!0});g.getDefinitions=function(){return n};g.getPronunciation=function(){return h};g.getPronunciationUrls=function(){return j};f.resolve(g)}}function a(a){f.reject(a.status?IDictionary.LOOKUP_FAILED:IDictionary.OFFLINE)}var f=new jQuery.Deferred,b=KindleStringUtilities.replaceAccentedChars(b);word=h(b);(b=word.replace("'","%27"))?KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline(6E4)!==!1?KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).getWordDefinition(b).then(c,
a):f.reject(IDictionary.OFFLINE):f.reject(IDictionary.NOT_FOUND);return f.promise()};return(new jQuery.Deferred).resolve(c).promise()}
var KindleLibraryBookCover=function(){function h(){a||(a=KindleHostDeviceDetector.isiPad()?c:d);return a}function j(a){g||(g=e,g=g.replace("{width}",h().width),g=g.replace("{height}",h().height));var b=g;return b=b.replace("{asin}",a)}var e="/cover/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",d={width:255,height:255},c={width:255,height:255},b=null,g=null,a=null;return{getBookCoverUrl:function(a){b||(b="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",
b=b.replace("{width}",h().width),b=b.replace("{height}",h().height));var c=b;return c=c.replace("{asin}",a)},getOfflineCover:function(a){var a=j(a),b=$.Deferred(),c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=function(){var a=c.response,f,d;if(a){if(KindleHostDeviceDetector.hasArrayLikeApply())try{f=[],d=new Uint8Array(a),f.push(String.fromCharCode.apply(null,d))}catch(g){f=null}if(!f){f=[];d=new Uint8Array(a);for(a=0;a<d.length;a++)f.push(String.fromCharCode(d[a]))}f=
"data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(f.join(""));b.resolve(f)}else b.reject()};c.onerror=function(){b.reject(c)};c.send();return b.promise()}}}(),ResourceBundle;
function KindleReaderUIFactory(){function h(){var a=[{buttonText:ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_buy_btn"),callback:function(){jb();X.emit("Reader::Sample::Buy::"+(Ba?"Owned":"NotOwned")+"::FeatureUnavailable",{breakdown:["Partner"]})}},{buttonText:ResourceBundle.getLocalizedString("k_common_close_button"),callback:null}],b=ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_title"),c=ResourceBundle.getLocalizedString("k_R_feature_not_available_dialog_text");
KindleMessageDialog.open(b,c,null,null,a)}function j(){Wa||(R.pauseDownloading(),Wa=!0)}function e(){Wa&&(R.resumeDownloading(),Wa=!1)}function d(a){var b=s();KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(c){c.getAppDb().updateMaxPosition(R.getAsin(),b,a)})}function c(a){if(!aa.selection)return!1;KindleReaderSelectionRenderer.clearSelection();KindleReaderContextMenu.hide();ReaderSitbHighlight.clear();a.newValue!==null&&KindleReaderSelectionRenderer.setSelection(a.newValue)}
function b(){ka.setSelection(null);KindleSelectionEvents.resetTap();KindleReaderContextMenu.hide();KindleRenderer.clearSelection()}function g(){return kb.bookType||lb["book-type"]}function a(){return g()===Kindle.BookInfo.PublisherMetadata.COMIC}function f(){return g()===Kindle.BookInfo.PublisherMetadata.CHILDREN}function k(){m();J()}function m(){b();ReaderSitbHighlight.render();KindleReaderPageArrow.setArrowEnabled(KindleRenderer.hasPreviousScreen(),KindleRenderer.hasNextScreen()||Ca===Kindle.CONTENT_TYPE.EBSP);
ja();aa.trackLpr&&(KindleReaderLPRManager.onPageChange(A()),tb&&tb())}function l(){clearTimeout(qa);if(Xa.length>0){var a=A(),b=Xa.pop();r(a,b);KindleReaderMetrics.reportBackButtonUsage()}Xa.length===0&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,!1)}function o(a){clearTimeout(qa);ta.positionFromLocation(a).done(n)}function q(a){clearTimeout(qa);a=Pa.positionFromPageNumber(a);n(a)}function n(a){if(Ca===Kindle.CONTENT_TYPE.EBSP&&a>=s())z();else{var b=A();Xa.push(b);
Xa=Xa.slice(-8);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,!0);r(b,a)}}function r(a,b){KindleReaderMetrics.startGoToMetrics();KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();var c;try{KindleReaderZoomableManager.deactivateZoomable(),j(),c=KindleRenderer.gotoPosition(b)}catch(f){e()}m();c&&(J(),e())}function s(){var a=0;try{a=KindleRenderer.getMaximumPosition()}catch(b){e(),a=-1}return a}function t(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getBookExtras(R.getAsin(),
u)}function u(a){a=a[0];a===void 0?KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED):KindleHostDeviceDetector.isOnline()?a.isAvailable&&(a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED||a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE)&&U.openBookExtras(a.asin):a.isAvailable&&a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED?U.openBookExtras(a.asin):KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR)}function z(){KindleReaderSampleEnd.open(function(a){a==="buy"&&(jb(),
X.emit("Reader::Sample::Buy::"+(Ba?"Owned":"NotOwned"),{breakdown:["Partner"]}))});X.emit("Reader::Sample::End::"+(Ba?"Owned":"NotOwned"),{breakdown:["Partner"]})}function w(a){KindleHostDeviceDetector.isiOS()||ca(!0);ReaderSitbHighlight.clear();KindleReaderZoomableManager.isZoomed()?KindleReaderZoomableManager.gotoNextZoomable():G(a)}function y(a){KindleHostDeviceDetector.isiOS()||ca(!0);ReaderSitbHighlight.clear();KindleReaderZoomableManager.isZoomed()?KindleReaderZoomableManager.gotoPreviousZoomable():
F(a)}function G(a){function c(){KindleReaderMetrics.endPageTurnTimer();e()}if(Wa)return!1;KindleHostDeviceDetector.isiOS()&&ca(!0);if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&!ua)U.hideAppBar(),ca(!0),b();if(!Ya){KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.NEXT_PAGE,a);if(KindleRenderer.hasNextScreen())KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();else if(Ca===Kindle.CONTENT_TYPE.EBSP)return KindleReaderZoomableManager.deactivateZoomable(),
z(),!1;j();if(KindleRenderer.nextScreen())return setTimeout(c,0),m(),J(),KindleReaderZoomableManager.clearZoomables(),!0}return!1}function F(a){function c(){KindleReaderMetrics.endPageTurnTimer();e()}if(Wa)return!1;KindleHostDeviceDetector.isiOS()&&ca(!0);if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&!ua)U.hideAppBar(),ca(!0),b();return!Ya&&(KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.PREV_PAGE,a),KindleRenderer.hasPreviousScreen()&&KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat(),
j(),KindleRenderer.previousScreen())?(setTimeout(c,0),m(),J(),KindleReaderZoomableManager.clearZoomables(),e(),!0):!1}function A(){return KindleRenderer.getPagePositionRange().currentTopOfPage}function x(){function a(){b.resolve(0)}var b=new jQuery.Deferred;KindleModuleManager.getModuleList([da.BOOK_CONTEXT,da.BOOK_METADATA]).then(function(c){var f=c[da.BOOK_CONTEXT].srl||c[da.BOOK_METADATA].positions.srl;ga.position>=0?b.resolve(ga.position):ga.location>=0?ta.positionFromLocation(ga.location).done(b.resolve):
aa.trackLpr?KindleModuleManager.getModule(da.LPR_MANAGER).then(function(a){a=a.getStartReadingPosition();a.lastTimeRead!==KindleReaderLPRManager.NEVER?(f=a.lastPositionRead,b.resolve(f)):Za.done(function(){if(R.getFurthestPositionReadData().position!==R.UNKNOWN_FPR)f=R.getFurthestPositionReadData().position;b.resolve(f)})},a):b.resolve(f)},a);return b.promise()}function B(){KindleSpinner.hide();m();J();Ya=!1;KindleReaderZoomableManager.clearZoomables();KindleReaderZoomableManager.isZoomed()&&KindleReaderZoomableManager.activateZoomableOnPageTurn()}
function v(a){a=a[0];if(a===void 0||!a.isAvailable){var b=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb();$.ajax({url:Kindle.BOOKEXTRAS.BEX_URL+R.getAsin()+"/Check",type:"GET",dataType:"json",success:function(a){if(a.isAvailable===!0)a={},a[KindleReaderGoToMenu.MenuItemNames.extras]=KindlePopupMenu.ITEM_ENABLED,KindleReaderGoToMenu.updateGoToMenu(a),b.updateBookExtras(R.getAsin(),Kindle.BOOKEXTRAS.BEX_ISAVAILABLE,function(){})}})}else if(a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE||
a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED)a={},a[KindleReaderGoToMenu.MenuItemNames.extras]=KindlePopupMenu.ITEM_ENABLED,KindleReaderGoToMenu.updateGoToMenu(a)}function I(a){function b(){if(Ia.pageNumbers)return Pa.getMaxPageNumberLabel()}function c(){if(Ia.location)return e}function f(){if(Ia.pageNumbers)return Pa.getPageNumberRanges()}var e,k=KindleModuleManager.getModuleSync(da.BOOK_METADATA);ta=R.getLocationConverter();KindleModuleManager.registerModule(Kindle.MODULE.LOCATION_CONVERTER,ta);
KindleReaderMetrics.setBookType(a);if(Ia.location)k.locationsInfo&&k.locationsInfo.numOfLocations?(KindleReaderLocationBar.setMinMaxLocation(1,k.locationsInfo.numOfLocations),e=k.locationsInfo.numOfLocations,KindleReaderImmersiveFooter.setMaxLocation(e),ta.locationFromPosition(KindleRenderer.getMinimumPosition()).done(function(a){KindleReaderLocationBar.setMinMaxLocation(a,k.locationsInfo.numOfLocations)})):$.when(ta.locationFromPosition(KindleRenderer.getMinimumPosition()),ta.locationFromPosition(KindleRenderer.getMaximumPosition())).done(function(a,
b){KindleReaderLocationBar.setMinMaxLocation(a,b);e=b;KindleReaderImmersiveFooter.setMaxLocation(e)});(function(){KindleReaderGoToMenu.bookIsReady({gotoUserLocation:o,gotoPosition:n,gotoPage:q,getMaxPage:b,getPageNumberRanges:f,getMaxUserLocation:c,openBookExtras:t,openBookmarks:function(){ra(KindleReaderAnnotationManager.BOOKMARK)}},R,X)})();var h=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb();KindleReaderSearchBox.setEnabled(aa.searchable);h.getBookExtras(R.getAsin(),
v);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowGoTo,!0);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowSettings,aa.viewSettings);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Back,!1);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Bookmark,aa.bookmarks);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowNotes,aa.annotations);KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Sync,
!0);KindleHostDeviceDetector.isMetro()&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.PinToStart,!0);Ca===Kindle.CONTENT_TYPE.EBOK&&KindleModuleManager.getModule(da.ANNOTATION_MANAGER).done(Zb);if(aa.trackLpr){d(function(){});var m=KindleModuleManager.getModuleSync(da.LPR_MANAGER);Za.done(function(){m.onReadingStart(R.getFurthestPositionReadData(),A(),ta,pa);tb=KindleReaderArrhythmicHeartBeatHandler.onReadingStart(R.getAsin(),R.getRefEmId(),R.getKindleSessionId(),m.getLastPositionRead,
aa.trackLpr,R.getBookType())})}ja();B();U.onRendererLoaded(Ba);a={screenOrientation:$a,contentType:Ca,bookType:a,isOwned:Ba,publisherBookType:g(),isOnline:R.isOpenedOnline()};KindleReaderMetrics.reportBookOpenSuccess(a);ub.resolve(!0)}function L(){try{ta=R.getLocationConverter();var a={version:"2.0",containerId:"kindleReader_content",bookInfo:R,startingPositionDfd:x()},b=P();$.extend(b,S());$.extend(b,T());$.extend(b,Q());$.extend(b,Y());$.extend(b,W());$.extend(b,{});KindleRenderer.initialize(a,
b,{statusCallback:K,pageChangeCallback:k,annotationEventCallback:$b},KindleReaderOverlayManager)}catch(c){e()}}function D(){function a(){if(vb)wb=!0;else{wb=!1;var b=Fb,c=W();(!c.columns||!(c.columns.num===b.columns.num&&c.columns.gap===b.columns.gap))&&KindleRenderer.updateSettings(c);KindleRenderer.onWindowResize();ja()}}(mb.state()!=="pending"||!KindleHostDeviceDetector.isMetro())&&mb.done(a)}function K(a){if(a.status===KindleRenderer.STATUS_LOADING||a.status===KindleRenderer.STATUS_PAGINATING)Ya=
!0,b(),KindleSpinner.show(),KindleReaderMetrics.startSpinnerTimer();else if(a.status===KindleRenderer.STATUS_DONE)KindleDeviceCapabilities.useNativeSelection()&&!Gb&&!Ja&&(za(),Gb=!0),xa?(KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),B(),e()):($.when(R.getBookInfoDfd()).done(function(){I(R.getBookType())}),xa=!0,mb.resolve(),ja());else if(a.status===KindleRenderer.STATUS_ERROR)if(a.errorCode===KindleRenderer.ERROR_LOAD_FAILURE){var c=
Kindle.ERROR_CODE.RENDERER_UNKNOWN;if(a&&a.errorMsg.indexOf("Init")>=0)c=Kindle.ERROR_CODE.RENDERER_INIT;else if(a&&a.errorMsg.indexOf("Metadata")>=0)c=Kindle.ERROR_CODE.RENDERER_METADATA;Hb(R,{openError:Kindle.ERROR.LOAD_FAILURE,openSubError:c,asin:ga.asin})}else KindleSpinner.hide(),Ya=!1,KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),J(),U.isHostControlled()?KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_pageLoadError_Title"),
ResourceBundle.getLocalizedString("k_R_pageLoadError_Text"),gb):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_pageLoadError_Title"),ResourceBundle.getLocalizedString("k_R_pageLoadError_Text")),a.errorCode===KindleRenderer.ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT?KindleReaderMetrics.reportTimeOutMetrics():KindleReaderMetrics.reportContentNotAvailableMetrics()}function M(){if(!KindleHostDeviceDetector.isiOS()){var a=ac-V.getMargin();$(".kindleReader_pageTurnArea").css("width",a+"%");
$("#kindleReader_pageTurnAreaRight").css("left",100-a+"%");$("#kindleReader_center").css("left",a+"%");$("#kindleReader_center").css("right",a+"%");KindleHostDeviceDetector.isMetro()&&$("#kindleReader_center").css("width",100-2*a+"%")}}function H(){$("#kindleReader_pageTurnAreaLeft").css("backgroundColor",V.getBodyColor());$("#kindleReader_pageTurnAreaRight").css("backgroundColor",V.getBodyColor());$("#kindleReader_center").css("backgroundColor",V.getBGColor());$("#kindleReader_title").css("color",
V.getTitleColor());$("#kindleReader_immersiveFooter").css("color",V.getTitleColor());la.css("backgroundColor",V.getBGColor());la.css("color",V.getFGColor());var a=V.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK;KindleReaderLocationBar.setLocationBarBlack(a);a=V.getColorMode();KindleReaderPageArrow.setArrowColor(a);KindleMetroReaderButtonOverlay.setColor(a);ReaderImmersiveModeIcon.setIconColor(a)}function J(){if(!(s()<0)){var a=KindleRenderer.getPagePositionRange().currentTopOfPage;a<0&&
(a=0);Ka(a).done(function(a){KindleReaderLocationBar.updatePageLabel(a);KindleReaderImmersiveFooter.updateLabel(a)})}}function O(a){var b;if(xb){b=a.originalEvent.detail?a.originalEvent.detail:a;switch(b.which){case 70:if(b[KindleHostDeviceDetector.isMacintosh()?"metaKey":"ctrlKey"]&&aa.searchable)ca(!1),KindleReaderSearchBox.setActive(!0),KindleHostDeviceDetector.isMetro()&&setTimeout(KindleReaderSearchBox.setActive,200),a.preventDefault(),a.stopPropagation()}KindleEventUtil.preventKeyScroll(b)}}
function C(a){var b;if(xb){b=a.originalEvent.detail?a.originalEvent.detail:a;if(KindleHostDeviceDetector.isMetro()&&!ua)switch(b.which){case 90:KindleHostDeviceDetector.isMetro()&&nb&&oa();break;case 18:case 164:case 165:case 93:KindleHostDeviceDetector.isMetro()&&oa()}else switch(b.which){case 13:(b=document.activeElement)&&b.id&&!ua&&KindleReaderControls.clickElementWithID(b.id);break;case 32:a.shiftKey?y(va.KEY):w(va.KEY);break;case 37:case 38:case 33:y(va.KEY);break;case 39:case 40:case 34:w(va.KEY);
break;case 27:KindleReaderZoomableManager.deactivateZoomable();break;case 90:KindleHostDeviceDetector.isMetro()&&nb&&oa();break;case 18:case 164:case 165:case 93:KindleHostDeviceDetector.isMetro()&&oa()}a.stopPropagation();KindleReaderLocationBar.hidePopup();U.onUserAction()}}function E(a){function b(){w(va.WHEEL)}function c(){y(va.WHEEL)}var f=a.originalEvent.wheelDelta||-1*a.originalEvent.detail;yb&&clearTimeout(yb);yb=f<0?setTimeout(b,100):setTimeout(c,100);a.preventDefault()}function N(){var a=
KindleHostDeviceDetector.isMetro(),b=KindleHostDeviceDetector.isIE();KindleReaderPageArrow.initialize(function(a){$("#kindleReader_touchLayer").append(a);M()},function(c){if(!this.isTouchEvent||this.isTouchEvent&&!a&&!b)return y(va.ARROW),c&&c.stopImmediatePropagation&&c.stopImmediatePropagation(),!1},function(c){if(!this.isTouchEvent||this.isTouchEvent&&!a&&!b)return w(va.ARROW),c&&c.stopImmediatePropagation&&c.stopImmediatePropagation(),!1})}function P(){var a={},b=V.getFontSize();a.fontSizes=[b*
0.5,b*0.75,b,b*1.2,b*1.4,b*1.6,b*1.8];KindleHostDeviceDetector.isMetro()&&!Ja&&(a.fontSizes[0]=b,a.fontSizes[1]=b);a.fontSizeUnits="px";a.glyphScale=V.getGlyphScale();a.lineHeight=V.getLineHeight();return a}function S(){var a={};a.margin=V.getMargin();return a}function T(){var a={};a.backgroundColor=V.getBGColor();a.fontColor=V.getFGColor();a.highlightColor=V.getHighlightColor();a.selectionColor=V.getSelectionColor();a.insertBgColor=V.getInsertBGColor();return a}function Q(){var a={},b=V.getHighlightColor(),
c=V.getSearchBGColor(),f=V.getSearchBorderColor();KindleDeviceCapabilities.useCSSRegions()&&!Ja?(a[KindleReaderAnnotationManager.HIGHLIGHT]={htmlElementTag:"mark",className:"highlight",style:"color: inherit; background-color: "+b+";"},a[KindleReaderAnnotationManager.NOTE]={htmlElementTag:"mark",className:"note",style:"position: relative; display: inline-block; width: 0; height: 0; vertical-align: text-top;"},a[KindleReaderAnnotationManager.NOTE_ICON]={className:"note-icon",style:"position: absolute; left: 0; top: 0; width: 30px; height: 30px; background: url("+
Ib+") no-repeat;"},KindleHostDeviceDetector.isMetro()||(a[KindleReaderOverlayManager.SEARCH_RESULT]={htmlElementTag:"mark",className:"search-result",style:"margin-left: -3px; padding-left: 2px; padding-right: 2px; border-radius: 6px; color: inherit; background-color: "+c+"; border: 1px solid "+f+";"})):(a[KindleReaderAnnotationManager.NOTE]={className:"amazon-note",style:"position: absolute; width: 10px; height: 10px; background-image: url('"+Ib+"'); cursor: pointer; margin-top: 0px; margin-left:-2px;",
drawingType:KindleRendererAnnotationRenderer.DRAW_AFTER},a[KindleReaderAnnotationManager.HIGHLIGHT]={className:"amazon-highlight",style:"position: absolute; z-index: -10; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER},b=V.getSelectionColor(),a[KindleReaderOverlayManager.SELECTION]={className:"amazon-selection",style:"position: absolute; z-index: -9; background-color: "+b,drawingType:KindleRendererAnnotationRenderer.DRAW_OVER},a[KindleReaderOverlayManager.SEARCH_RESULT]=
{className:"amazon-search",style:"position: absolute; z-index: -9; border-radius: 6px; background-color: "+c+"; border: 1px solid "+f+"; margin-left: -2px; padding-right: 2px;",drawingType:KindleRendererAnnotationRenderer.DRAW_OVER});return{annotationStyles:a}}function Y(){var a={};a[KindleReaderAnnotationManager.NOTE]={clickable:!0};a[KindleReaderAnnotationManager.HIGHLIGHT]={clickable:!1};a[KindleReaderAnnotationManager.POPULAR_HIGHLIGHT]={clickable:!0};a[KindleReaderOverlayManager.SELECTION]={clickable:!1};
a[KindleReaderOverlayManager.SEARCH_RESULT]={clickable:!1};return{annotationClick:a}}function W(){var a={};if(aa.columns>1){var b=1,c=0;V.getShowColumns()==="true"?(KindleHostDeviceDetector.isTablet()?window.outerWidth>window.outerHeight&&(b=2):$("#kindleReader_content").width()>950&&(b=2),b=Math.min(b,aa.columns),b=Math.max(b,1)):V.getShowColumns()==="on"&&(b=Math.min(2,aa.columns));b>1&&(c=(22-V.getMargin())*0.666667+2,c=Math.round($("#kindleReader_content").width()*c/100));a.columns={num:b,gap:c};
KindleReaderMetrics.setColumnCount(b)}else a.columns={num:1,gap:0};return Fb=a}function ia(a){ba(a);V.save()}function ba(a){var b={},c=V.getFontSize()!==a.getFontSize(),f=V.getMargin()!==a.getMargin(),d=V.getColorMode()!==a.getColorMode(),g=V.getShowColumns()!==a.getShowColumns(),e=V.getShowLocations()!==a.getShowLocations();V.copy(a);c&&$.extend(b,P());f&&($.extend(b,S()),M());d&&($.extend(b,T()),$.extend(b,Q()),H());if(g){var k=V.getShowColumns()==="true";X.emit(k?"Reader::ColumnModeChanged::Auto":
"Reader::ColumnModeChanged::One")}e&&KindleReaderImmersiveFooter.enable(a.getShowLocations());(g||f)&&$.extend(b,W());if((KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE11())&&d&&!c&&!f&&!g)document.getElementById("kindleReader_center").style.visibility="hidden",setTimeout(function(){document.getElementById("kindleReader_center").style.visibility="visible"},0);KindleRenderer.updateSettings(b)}function na(){var a=X.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.open(function(b){b?
(X.increaseSubCounter(a,"Continue",1),X.endMetrics(a),hb.resolve(!0)):(X.increaseSubCounter(a,"Cancel",1),X.endMetrics(a),hb.resolve(!1),KindleRenderer.shutdown(),sb())})}function ha(a){return Ja=a.indexOf(bc)>=0}function ma(a){ha(a)&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()?na(a):hb.resolve(!0)}function pa(a){function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}KindleReaderSyncPositionDialog.open(a,function(c){switch(c){case KindleReaderSyncPositionDialog.USER_RESPONSES.SYNC:n(a.fprPosition);
X.emit("Reader::SyncLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.RESET:Qa.resetLPR({asin:R.getAsin(),kindleSessionId:R.getKindleSessionId(),position:a.currentPosition,positionType:R.getBookType(),localTimeOffset:KindleLocale.getLocalTimeOffset(),refEmId:R.getRefEmId()}).fail(b);X.emit("Reader::ResetLPR");break;case KindleReaderSyncPositionDialog.USER_RESPONSES.CANCEL:X.emit("Reader::SyncLPRCancel")}})}function fa(){function a(b){var c=b.lastPageReadData,f=A();$.when(Ka(f),Ka(c.position)).done(function(a,
b){b.loc>a.loc?(pa({currentLocation:a.loc,currentPage:a.pageNumber,currentPosition:f,fprPosition:c.position,fprLocation:b.loc,fprPage:b.pageNumber,fprDevice:c.deviceName,fprDateTime:c.syncTime}),KindleReaderLPRManager.updateFprSyncTime(c)):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_R_syncPosition_title"),ResourceBundle.getLocalizedString("k_R_syncPosition_alreadyFurthest_Text"))})}function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}clearTimeout(qa);xa&&Qa&&(KindleModuleManager.getModuleSync(da.BOOK_METADATA),
Qa.getLPR(R.getAsin(),R.getRefEmId()).then(a,b))}function Z(){KindleReaderBookmarkOverlay.initialize(function(a){la.append(a);KindleReaderControls.registerComponent(a)})}function ja(){if(xa&&KindleModuleManager.isModuleInitialized(da.ANNOTATION_MANAGER)){var a=KindleModuleManager.getModuleSync(da.ANNOTATION_MANAGER);La=!1;for(var b=KindleRenderer.getPagePositionRange(),b=a.getAnnotationsInRange(b.currentTopOfPage,b.currentBottomOfPage),c=0;c<b.length;c+=1)if(b[c].type===a.BOOKMARK){La=!0;break}sa()}}
function ea(){function a(){}clearTimeout(qa);if(aa.bookmarks&&xa&&KindleModuleManager.isModuleInitialized(da.ANNOTATION_MANAGER)){var b=KindleModuleManager.getModuleSync(da.ANNOTATION_MANAGER),c=KindleRenderer.getPagePositionRange();if(La)for(var c=b.getAnnotationsInRange(c.currentTopOfPage,c.currentBottomOfPage),f=0;f<c.length;f+=1)c[f].type===KindleReaderAnnotationManager.BOOKMARK&&b.deleteAnnotations([c[f]]).done(a);else b.createBookmark(c.currentTopOfPage).done(a);La=!La;sa()}}function sa(){La?
$("#kindleReader_bookmark").addClass("hasBookmark"):$("#kindleReader_bookmark").removeClass("hasBookmark");KindleHostDeviceDetector.isMetro()?KindleMetroReaderButtonOverlay.refreshBookmarkImage(La):KindleReaderBookmarkOverlay.setIsBookmarked(La)}function ra(a){xa&&KindleModuleManager.isModuleInitialized(da.ANNOTATION_MANAGER)&&(ca(!1),clearTimeout(qa),ReaderAnnotationsDisplay.show(A(),a))}function fb(){ReaderImmersiveModeIcon.initialize(function(a){la.append(a);KindleReaderControls.registerComponent(a);
KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ImmersiveIcon,!0)})}function ca(a){function b(){ca(!0)}qa&&(clearTimeout(qa),qa=null);a===ua||Ra===Kindle.AutoHideOption.Off||(ua=!!a,R&&(R.pauseDownloading()||1)&&setTimeout(R.resumeDownloading,2E3),la.hasClass("immersive_mode")!==ua&&la.toggleClass("immersive_mode",ua),KindleHostDeviceDetector.isiOS()&&(KindleReaderBookmarkOverlay.setImmersiveMode(ua),KindleReaderLocationBar.setImmersiveMode(ua)),ua?KindleMetroReaderAppBarOverlay.remove():
KindleMetroReaderAppBarOverlay.show(b),ua&&KindleReaderSearchBox.setActive(!1))}function oa(){ca(!ua)}function Ma(){function a(){ca(!1)}KindleReaderImmersiveModeExit.initialize(function(b){la.append(b);$(".immersive_exit").hover(a)},a)}function Na(){Ya||(ca(!1),clearTimeout(qa),KindleHostDeviceDetector.isMetro()?KindleMetroReaderViewSettings.open(V,aa,ia):KindleReaderSettingsDialog.open(V,aa,ia))}function Sa(){var a=$("#kindleReader_content");return function(b,c,f){return ib.getBookPositionAt(b-a.offset().left,
c-a.offset().top,f)}}function wa(){var a,b={};a=document.createElement("div");a.id="kindleReader_touchLayer";var c=$(a);la.append(a);b.getBookPositionAt=Sa();b.selectionStateManager=ka;KindleHostDeviceDetector.isIE11()&&c.css("background-color","rgba(255,255,255,0.005)");KindleHostDeviceDetector.isMetro()?c.bind("mousedown",qb):window.oncontextmenu=function(){return!1};if(!KindleHostDeviceDetector.isiOS())c.click(Ga),c.keyup(C),c.keydown(O),c.dblclick(Ha),c.bind("mousewheel",E),b.mouseDownEventSource=
a,b.mouseEventSource=a,b.mouseClickOutsideEventSource=document.getElementById("kindleReader_book_container");if(KindleHostDeviceDetector.isTouchDevice())c.swipeLeft(ya,{touchOnly:!0,distance:25}),c.swipeRight(db,{touchOnly:!0,distance:25}),c.tap(Va),KindleHostDeviceDetector.isiOS()&&(c.doubletap(Ua),c.bind("touchstart",Ta)),b.touchEventSource=a,b.selectionHandleLeft=KindleReaderSelectionRenderer.getGrabHandleBegin(),b.selectionHandleRight=KindleReaderSelectionRenderer.getGrabHandleEnd();KindleSelectionEvents.initialize(b)}
function Aa(){window.oncontextmenu=function(){return!1};var a=$(document.createElement("div"));a.attr("id","kindleReader_touchArea");a.swipeLeft(ya,{touchOnly:!0,distance:25});a.swipeRight(db,{touchOnly:!0,distance:25});var b=$(document.createElement("div"));b.attr("id","kindleReader_touchLayer");b.click(Ga);b.bind("dblclick",Ha);b.tap(Va);b.bind("mousewheel",E);b.bind("mousedown",qb);b.css("z-index",50);a.append(b);$("#kindleReader_center").appendTo(a);la.append(a)}function za(){for(var a=document.getElementsByTagName("iframe"),
b,c=0;c<a.length;c++)b=$(a[c]),b.click(Ga),b.bind("dblclick",Ha),b.bind("mousewheel",E),b.bind("mousedown",qb),a[c].addEventListener("select",eb,!1),a[c].contentWindow.document.addEventListener("selectionchange",Oa,!1)}function Oa(a){zb&&a.target.selection&&(a.target.selection.createRange().text.length!==0&&$(".kindle_menu").css("left","-1000px"),zb=!1)}function Fa(a){function c(){b();KindleRenderer.reloadAnnotations()}function f(){KindleReaderAnnotationManager.deleteAnnotations(m).done(c)}function d(){KindleReaderAnnotationManager.createHighlight(k.start,
k.end,A()).done(c)}function g(){KindleReaderEditNoteDialog.open(null,function(a){a&&KindleReaderAnnotationManager.createNote(k.start,k.end,A(),a).done(c)},null,function(){b()})}function e(){cb(l[0].start)}var k=ka.getSelection()||a.selection,m=k?KindleReaderAnnotationManager.getAnnotationsInRange(k.start,k.end,KindleReaderAnnotationManager.HIGHLIGHT):[],l=k?KindleReaderAnnotationManager.getAnnotationsInRange(k.start,k.end,KindleReaderAnnotationManager.NOTE):[];(function(){var b=KindlePopupMenu,c=
m.length===1&&m[0].start<=k.start&&m[0].end>=k.end,n=k&&!c?b.ITEM_ENABLED:b.ITEM_HIDDEN,c=c?b.ITEM_ENABLED:b.ITEM_HIDDEN,t=k&&l.length===0?b.ITEM_ENABLED:b.ITEM_HIDDEN,j=k&&l.length>0?b.ITEM_ENABLED:b.ITEM_HIDDEN,u=k.start===k.end?b.ITEM_ENABLED:b.ITEM_HIDDEN,b=[],q=[],o=Ca===Kindle.CONTENT_TYPE.EBSP;q[KindleReaderContextMenu.CREATE_HIGHLIGHT]=o?h:d;q[KindleReaderContextMenu.CREATE_NOTE]=o?h:g;q[KindleReaderContextMenu.EDIT_NOTE]=e;q[KindleReaderContextMenu.DELETE_HIGHLIGHT]=f;b[KindleReaderContextMenu.CREATE_HIGHLIGHT]=
n;b[KindleReaderContextMenu.CREATE_NOTE]=t;b[KindleReaderContextMenu.EDIT_NOTE]=j;b[KindleReaderContextMenu.DELETE_HIGHLIGHT]=c;b[KindleReaderContextMenu.DEFINITION]=function(){var a=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLanguage();return dictionary.isLanguageSupported(a)}()&&u;n=Ea(a);KindleReaderContextMenu.show(b,n,q,k)})();KindleHostDeviceDetector.isiOS()?la.bind("touchstart.contextMenu",function(){KindleReaderContextMenu.hide();la.unbind("touchstart.contextMenu")}):
la.bind("mousedown.contextMenu",function(){KindleReaderContextMenu.hide();la.unbind("mousedown.contextMenu")})}function Ea(a){var b=a.selection.lowerBounds||KindleListUtilities.first(ib.getBounds(a.selection.end)),a=a.selection.upperBounds||KindleListUtilities.last(ib.getBounds(a.selection.start)),c=$("#kindleReader_content").offset(),f=KindleHostDeviceDetector.isiOS()?80:0,d=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?25:0,g=KindleHostDeviceDetector.isiOS()||
KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?35:0,e;e=b.right+c.left;b=b.bottom+c.top+d;if($(window).height()-b>f)return[e,b];e=a.left+c.left-g;b=a.top+c.top-f-g;return b>0?[e,b]:"center"}function cb(a){function c(){b();KindleReaderAnnotationManager.deleteAnnotations([f]).done(KindleRenderer.reloadAnnotations);d.resolve("Delete")}var f=KindleReaderAnnotationManager.getAnnotation(KindleReaderAnnotationManager.NOTE,a),d=new jQuery.Deferred;KindleReaderEditNoteDialog.open(f.note,
function(a){a?(KindleReaderAnnotationManager.modifyNote(f.start,A(),a),d.resolve("Save")):c()},c,function(){b();d.resolve("Cancel")});return d.promise()}function ya(){ka.getSelection()||w(va.SWIPE);U.onUserAction()}function db(){ka.getSelection()||y(va.SWIPE);U.onUserAction()}function Ga(a){U.onUserAction();if(KindleHostDeviceDetector.isMetro()&&(U.hideAppBar(),!Ja))return;var b=a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;xa&&b>0&&a>0&&!ka.getSelection()&&
(ca(!0),rb(b,a))}function Ha(a){Da&&(clearTimeout(Da),Da=null);var b=a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;xa&&b>0&&a>0&&!ka.getSelection()&&KindleReaderZoomableManager.activateZoomableAtPosition(b,a);U.onUserAction()}function Ta(a){var b=a.originalEvent.touches[0].pageX-$("#kindleReader_content").offset().left,a=a.originalEvent.touches[0].pageY-$("#kindleReader_content").offset().top;if(!xa||!(b>0&&a>0&&!ka.getSelection())||!rb(b,a))U.onUserAction()}
function Ua(){var a=this.x-$("#kindleReader_content").offset().left,b=this.y-$("#kindleReader_content").offset().top;xa&&a>0&&b>0&&!ka.getSelection()&&KindleReaderZoomableManager.activateZoomableAtPosition(a,b);Da&&(clearTimeout(Da),Da=null);U.onUserAction()}function Va(){function a(){if(d<=0)return y(k),!0;else if(d>=e)return w(k),!0;return!1}function b(){Da=null;if(!xa||!(d>0&&g>0)||!rb(d,g))if(!ka.getSelection()&&(!(!KindleHostDeviceDetector.isMetroSnappedView()&&KindleHostDeviceDetector.isMetro()||
KindleHostDeviceDetector.isIE())||!Ja))if(d<e/4)y(k),KindleHostDeviceDetector.isMetro()&&U.hideAppBar();else if(d>e-e/4)w(k),KindleHostDeviceDetector.isMetro()&&U.hideAppBar();else if(!KindleReaderContextMenu.wasVisible()&&(oa(),KindleHostDeviceDetector.isMetro()))U.onReaderTapped()}if(!this.isTouchEvent||!(!KindleHostDeviceDetector.isMetroSnappedView()&&KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())||Ja){var c=document.activeElement.id.indexOf("frame")!==-1,f=$("#kindleReader_content"),
d=c?this.x:this.x-f.offset().left,g=c?this.y:this.y-f.offset().top,e=f.width(),k=this.isTouchEvent?va.TAP:va.ARROW;!Da&&(KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetroSnappedView())?Da=setTimeout(b,cc):this.isTouchEvent?b():a();U.onUserAction()}}function eb(){KindleReaderSitbPane.close();var a=KindleRenderer.getSelection(),b=KindleRenderer.getPagePositionRange();a.start=Math.max(a.start,b.currentTopOfPage);a.end=Math.min(a.end,b.currentBottomOfPage);KindleReaderContextMenu.hide();
Fa({selection:a});zb=!0}function qb(a){KindleHostDeviceDetector.isMetro()&&a.which===3&&(U.onReaderTapped(),oa());KindleReaderContextMenu.hide()}function rb(a,b){var c=!1;if(KindleDeviceCapabilities.useNativeSelection()&&!Ja)return!1;if(KindleHostDeviceDetector.isIE()){var f=$("#kindleReader_touchLayer");try{f.hide(),c=KindleRenderer.handleClick(a,b)}finally{f.show()}}else c=KindleRenderer.handleClick(a,b);return c}function Rb(){ca(!1);clearTimeout(qa);var a={};if(KindleModuleManager.isModuleInitialized(da.ANNOTATION_MANAGER)){var b=
KindleModuleManager.getModuleSync(da.ANNOTATION_MANAGER),b=b.getAnnotationsInRange(0,KindleRenderer.getMaximumPosition(),b.BOOKMARK);a[KindleReaderGoToMenu.MenuItemNames.bookmark]=b.length>0?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED}if(Ia.pageNumbers)a[KindleReaderGoToMenu.MenuItemNames.page]=KindlePopupMenu.ITEM_ENABLED;a&&KindleReaderGoToMenu.updateGoToMenu(a);KindleReaderGoToMenu.show()}function sb(a){X.emit("Reader::ClosedBy::"+(a||"Unknown"));Ba||ga.returnToLibrary?Jb():(jb(),
Ab=!0)}function Sb(){sb("Reader")}function Tb(){sb("AppBar")}function Ub(){clearTimeout(qa);U.pinBookToStart(R.getAsin())}function Vb(){KindleReaderHeaderBar.initialize(function(a){la.append(a);KindleReaderControls.registerComponent(a)},U.isEmbeddedInWebsite())}function Wb(){KindleMetroReaderButtonOverlay.initialize(function(a){la.append(a);KindleReaderControls.registerComponent(a)})}function Xb(){KindleReaderLocationBar.initialize(function(a){a.find("#kindleReader_progressbar_handle").mousedown(function(){clearTimeout(qa)});
la.append(a);KindleReaderControls.registerComponent(a)},function(a){o(a);KindleReaderMetrics.reportScrubberUsage()})}function Yb(){var a=$(Handlebars.templates.KindleReaderBuyButton()),b=KindleHostDeviceDetector.isiOS()?30:35,c=$("#kindleReader_footer_readerControls_right");c.show();c=c.width();$("#kindleReader_footer_readerControls_middle").css("padding-right",c+b+"px");$("#kindleReader_download_progress").css("right",c+b+"px");KindleReaderControls.registerComponent(a);la.append(a)}function dc(){function a(b){function c(){f?
(clearTimeout(f),f=null,c()):f=setTimeout(function(){nb=!1},200)}var f=null,b=b.originalEvent&&b.originalEvent.detail?b.originalEvent.detail:b;b.key==="Win"&&(b.type==="keydown"?nb=!0:b.type==="keyup"&&c())}KindleHostDeviceDetector.isMetro()?$(document).keyup(function(b){a(b);return C(b)}).keydown(function(b){a(b);return O(b)}):$(document).keydown(O).keyup(C);KindleUXComponentManager.registerKeyEventsEnabledCallback(function(a){xb=a})}function ec(){function a(b){clearTimeout(c);b?c=setTimeout(D,b):
D();KindleHostDeviceDetector.isMetro()||($("#kindleReader_annotations_pane").height($("body",Kindle.top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",Kindle.top.document).height()-212))}var c;if(KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window){var f=0;$("body",Kindle.top.document).bind("orientationchange",function(){f=Date.now();a(0)});$("#kindleReader_content").on("resize",function(){Date.now()-f>500&&a(0)})}else window.onresize=KindleHostDeviceDetector.isMetro()?
function(){if(!KindleHostDeviceDetector.isMetroSnappedView()){var c=Kb();$a&&$a!==c&&($a=c,KindleReaderMetrics.reportOrientationChange($a))}KindleReaderGoToMenu.onResize();b();a(0)}:function(){a(200)}}function $b(a,b){function c(){Bb=!1;ka.enable()}KindleHostDeviceDetector.isiOS()&&ca(!1);a===KindleReaderAnnotationManager.NOTE&&!Bb&&(Bb=!0,ka.disable(),cb(b).then(function(a){c();X.emit("Reader::Icon::"+a)},c))}function Lb(){Jb()}function gb(){U.closeReader(Mb)}function Jb(){KindleRenderer.shutdown();
X&&(Mb=X.startMetrics("App::CloseReader"),X.uploadMetrics(),ob&&(X.setMetricsUploadInterval(ob),ob=null));if(aa.trackLpr){KindleReaderArrhythmicHeartBeatHandler.onReadingEnd();if(KindleModuleManager.isModuleInitialized(da.LPR_MANAGER)&&KindleModuleManager.isModuleInitialized(KindleModuleManager.SERVICE_CLIENT)){var a=KindleModuleManager.getModuleSync(da.LPR_MANAGER).getLastPositionRead();Qa.doneReading({asin:R.getAsin(),kindleSessionId:R.getKindleSessionId(),position:a,positionType:R.getBookType(),
localTimeOffset:KindleLocale.getLocalTimeOffset(),countryCode:KindleLocale.getCountryCode(),refEmId:R.getRefEmId()})}R.doneReading()}gb()}function fc(a){a.queryText&&$("#kindleReader_search_field").val(a.queryText)}function gc(){KindleReaderSearchBox.initialize({onfocus:function(){clearTimeout(qa)}});ReaderSitbManager.initialize(X);ReaderSitbHighlight.initialize(KindleReaderOverlayManager)}function hc(){M();Z();KindleHostDeviceDetector.isMetro()?Wb():(Ma(),KindleHostDeviceDetector.isIE()&&fb());Vb();
Xb();KindleReaderImmersiveFooter.initialize(X,V.getShowLocations());gc();H();dc();ec();KindleHostDeviceDetector.isiOS()||$(window).focus(function(){Qa.checkTokenConsistency()})}function ic(){R.getDownloadComplete(function(a,b){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_IN_PROGRESS,Math.round(100*Math.min(a,b)/Math.max(1,b)))}).then(function(){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_COMPLETED);if(KindleHostDeviceDetector.isMetro())U.onBookDownloadComplete({asin:R.getAsin()})},
function(a){if(a)switch(a){case Kindle.ERROR.OUT_OF_SPACE:case Kindle.ERROR.UNKNOWN_DB_ERROR:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_DISK_ERROR);break;case Kindle.ERROR.NETWORK:case Kindle.ERROR.TIMEOUT:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_NETWORK_ERROR);break;case Kindle.CACHING.DISABLED:return}KindleOffline.sendDownloadFailMetric(a,"Reader")})}function Nb(a){Za.done(function(){if(R.isUpdated()){var b=ResourceBundle.getLocalizedString("k_L_openBookContentUpgrade_ButtonText");
KindleMessageDialog.showError(Kindle.ERROR.CONTENT_UPGRADE,a,b)}else a()})}function jc(b){function c(){ab||(ab=new KindleReaderSettings,ab.reset());a()||f()?ab.reset():ab.load();aa.showTitle||($("#kindleReader_title").hide(),$("#kindleReader_content").addClass("no_title"),$("#kindleReader_immersiveFooter").hide());Ra===Kindle.AutoHideOption.Timed&&(qa=setTimeout(function(){ca(!0)},5E3))}if(b&&b.asin)if(b.asin===Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED)U.isEmbeddedInWebsite()&&b.kcrFree?KindleReaderEmbeddedError.open(Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED):
KindleMessageDialog.showError(Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED,gb);else{ga=b;pb=KindleReaderMetrics.startBookOpenTimer();X.startSubTimer(pb,"initialize");KindleHostDeviceDetector.isMetro()&&($a=Kb());ga.readerClass&&!$("body").hasClass(ga.readerClass)&&$("body").addClass(ga.readerClass);ga.readerAppBar&&ga.readerAppBar==="hide"&&ca(!0);Ra=ga.autoHide;var d;switch(Ra){case Kindle.AutoHideOption.Auto:case Kindle.AutoHideOption.Off:break;case Kindle.AutoHideOption.Timed:if(U.isEmbeddedInWebsite())Ra=
Kindle.AutoHideOption.Auto;break;default:Ra=KindleHostDeviceDetector.isiOS()||KindleHostDeviceDetector.isMetro()||U.isEmbeddedInWebsite()?Kindle.AutoHideOption.Auto:Kindle.AutoHideOption.Timed,d="default"}d="Reader::Chrome::AutoHide::"+(d||Ra);X.emit(d,{breakdown:["Partner"]});ga.closeButton===Kindle.Reader.CloseButtonNone&&KindleReaderControls.setDataActionVisible(KindleReaderControls.DataActions.Close,!1);KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
Ob);Pb=ga.standAlone;ga.kcrFree&&Qa.getAuthenticationState()!==Kindle.Service.AuthOK&&KindleReaderControls.setDataActionVisible(KindleReaderControls.DataActions.Sync,!1);bb&&KindleSpinner.show();R=KindleReaderBookInfoProvider.BookInfo(ga,KindleModuleManager);X.endSubTimer(pb,"initialize");Za=R.startReading(pb,ub);Za.done(function(b){ob=X.setMetricsUploadInterval(ga.kcrFree?X.UploadInterval.Short:X.UploadInterval.Default);R.isBookDownloaded()||ic();kc();lc(ga.asin).done(function(){var d=b.getContext();
d.canOpen=!0;d.errorCode=null;d.isOnline=b.isOpenedOnline();d.asin=b.getAsin();d.bookType=g();d.tutorialMaxShowCount=KindleReaderTutorial.getMaxShowCount(d.bookType);d.metadata=KindleModuleManager.getModuleSync(da.BOOK_METADATA)||{};U.onStartReadingStatus(d);c();d.isSample&&!KindleHostDeviceDetector.isMetro()&&Yb();KindleHostDeviceDetector.hasCanvasPerformanceProblem()?(ma(R.getBookType()),hb.then(function(a){a&&Nb(L)})):Nb(L);(a()||f())&&setTimeout(function(){KindleReaderTutorial.show(g())},3E3);
ba(ab)})}).fail(Hb);KindleModuleManager.getModule(da.BOOK_METADATA).done(mc);setTimeout(window.focus,0);KindleTouchEventsToggler.isRequired()&&Cb.done(function(){KindleTouchEventsToggler.allowTouchEvents()})}}function mc(a){a.title&&($("#kindleReader_title").text(a.title),$("#kindleReader_header_bar_title").text(a.title));a.authorList&&a.authorList.length>0&&(a=KindleAuthor.getDisplayableString(a.authorList),$("#kindleReader_header_bar_author").text(a))}function lc(b){var c=new $.Deferred;lb={};kb=
{};aa=new ReaderOptions;$.when(KindleModuleManager.getModule(da.BOOK_CONTEXT),KindleModuleManager.getModule(da.BOOK_METADATA),R.getBookInfoDfd()).done(function(d,g){var e=R.getBookType(),k=["RegionMagnification","book-type","cover","fixed-layout","orientation-lock","original-resolution","zero-gutter","zero-margin"],h={},m,l,n;if(g.publisherMetadata&&g.publisherMetadata.length>=3&&g.publisherMetadata[0]==="metadata"&&(m=g.publisherMetadata[2])&&m.length>0)for(n=0;n<m.length;n++)if(m[n].length>=2&&
m[n][0]==="meta"&&(l=m[n][1],l.name&&$.inArray(l.name,k)>=0))h[l.name]=l.content;lb=h;g.headerMetadata&&$.extend(kb,g.headerMetadata);d.isSample&&!d.isOwned?aa.trackLpr=!1:KindleModuleManager.registerModuleWithDeferred(da.LPR_MANAGER,KindleReaderLPRManager.initialize(b));KindleDeviceCapabilities.useNativeSelection()&&!f()&&!a()&&!ha(e)?Aa():(wa(),$("#kindleReader_touchLayer").css("z-index",200));KindleHostDeviceDetector.isiOS()||N();if(ha(e)||kb.fixedLayout||lb["fixed-layout"]||!KindleDeviceCapabilities.multiColumnMode())aa.columns=
1;if(a()||f())aa.selection=!1,aa.annotations=!1,aa.bookmarks=!1,aa.viewSettings=!1,aa.searchable=!1,aa.showTitle=!1;aa.bookmarks||(KindleHostDeviceDetector.isMetro()?KindleMetroReaderButtonOverlay.setVisibleBookmark(!1):KindleReaderBookmarkOverlay.setVisible(!1));c.resolve()});return c.promise()}function nc(){function a(c){return function(){b();c.apply(this,arguments)}}var c=Ca===Kindle.CONTENT_TYPE.EBSP;KindleEventBroker.subscribe("reader_close",Sb);KindleEventBroker.subscribe("reader_close_appbar",
Tb);KindleEventBroker.subscribe("reader_back",l);KindleEventBroker.subscribe("reader_show_goto",a(Rb));KindleEventBroker.subscribe("reader_show_settings",a(Na));KindleEventBroker.subscribe("reader_bookmark",a(c?h:ea));KindleEventBroker.subscribe("reader_show_notes",a(c?h:ra));KindleEventBroker.subscribe("reader_sync",a(c?h:fa));KindleEventBroker.subscribe("reader_pin_metro",a(Ub));KindleEventBroker.subscribe("reader_search",oc);KindleEventBroker.subscribe("reader_open_full_kcr",function(){U.openFullKCR({asin:R.getAsin()});
X.emit("App::Launch::Logo",{breakdown:["Partner"]})});KindleEventBroker.subscribe("reader_buy_full_book",function(){U.openStore(R.getAsin());X.emit("Reader::Sample::Buy::"+(Ba?"Owned":"NotOwned")+"::BuyFullVersionButton",{breakdown:["Partner"]})});KindleEventBroker.subscribe("immersive_icon",function(){ca(!1)})}function kc(){KindleModuleManager.getModule(da.BOOK_CONTEXT).done(function(a){Ba=a.isOwned;Ca=a.contentType;a="";ga.closeButton===Kindle.Reader.CloseButtonAuto&&(a=Ba||ga.returnToLibrary?ResourceBundle.getLocalizedString("k_R_toolbar_library_button"):
ResourceBundle.getLocalizedString("k_R_toolbar_iOS_sample_close_button"),KindleReaderHeaderBar.setCloseButtonText(a));Ca===Kindle.CONTENT_TYPE.EBOK&&(KindleModuleManager.registerModuleWithDeferred(da.ANNOTATION_MANAGER,KindleReaderAnnotationManager.deferredInitialize(Za,KindleModuleManager)),KindleModuleManager.getModule(da.ANNOTATION_MANAGER).done(KindleReaderMetrics.notifyAnnotationsReady));nc()})}function Hb(a,b){function c(){var b=a.getContext();b.canOpen=!1;b.errorCode=g.errorCode;b.subErrorCode=
g.subErrorCode;b.isOnline=a.isOpenedOnline();b.asin=g.asin;U.onStartReadingStatus(b)}function f(){var a=g.errorCode;g.subErrorCode&&(a={name:g.errorCode,code:g.subErrorCode});return a}var b=b||{},d=a.getContext(),g={errorCode:b.openError||a.getOpenError(),subErrorCode:b.openSubError,asin:b.asin||a.getAsin(),contentType:d&&d.contentType};KindleReaderMetrics.reportBookOpenFailure(g);if(!Qb&&g.errorCode!==KindleModuleManager.ERROR_CODE_CANCEL)if(Qb=!0,Pb){if(g.errorCode===Kindle.ERROR.CONTENT_UNSUPPORTED&&
KindleHostDeviceDetector.isMetro())g.errorCode=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;d=f();U.isHostControlled()?KindleMessageDialog.showError(d,gb):U.isEmbeddedInWebsite()&&ga.kcrFree?KindleReaderEmbeddedError.open(g.errorCode):KindleMessageDialog.showError(d,c);KindleSpinner.hide()}else c()}function Ob(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&(a.stalled?(KindleFirefoxPromptingDialog.open(),KindleReaderMetrics.reportFirefoxPromptingDialogOpen()):(KindleFirefoxPromptingDialog.close(),KindleReaderMetrics.reportFirefoxPromptingDialogClose(a)))}
function Zb(){aa.bookmarks&&(KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.Bookmark,!0),ja());aa.annotations&&KindleReaderControls.setDataActionEnabled(KindleReaderControls.DataActions.ShowNotes,!0);KindleRenderer.reloadAnnotations();var a={readerControls:{goToPosition:n,onAnnotationsUpdated:function(){ja();KindleRenderer.reloadAnnotations()},hostShowAnnotations:U.showAnnotations},annotationManager:KindleModuleManager.getModuleSync(da.ANNOTATION_MANAGER),pageLabelConverter:Ka};
ReaderAnnotationsDisplay.initialize(a)}function pc(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.deInitialize();KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,Ob)}function qc(){vb=!0}function rc(){vb=!1;wb&&D()}function sc(a,b,c,f){return KindleOffline.downloadBook(a,b,c,f)}function tc(){KindleOffline.cancelBookDownload()}function uc(a,b,c){KindleOffline.removeBook(a,b,c)}function oc(){var a={},b=KindleReaderSearchBox.getSearchText();
if(b&&U.searchContent)a.queryText=b,a.curPosition=A(),a.asin=R.getAsin(),Ka(a.curPosition).then(function(b){a.curLocation=b.loc;a.curPageNumber=b.pageNumber;U.searchContent(a)});if(b&&!U.isHostControlled())a.goToPosition=function(a){a&&(a.searchHighlights&&ReaderSitbHighlight.set(a.searchHighlights),n(a.position),a.isMarker?X.emit("SITB::GotoCurrentLocation"):X.emit("SITB::GotoResult"))},a.bookInfo=R,a.pageLabelConverter=Ka,a.locationConverter=ta,ReaderSitbManager.searchContent(a)}function vc(a){Db||
(Db=SearchContextProvider.getContextProvider({pageLabelConverter:Ka,locationConverter:ta}));return Db.getContext(a)}function wc(a){function b(d){function g(a){var b=Ka(a);b.done(function(b){f.location[a]=b.loc;f.page[a]=b.pageNumber});return b}if(d>=a.positions.length)c.resolve(f);else{var e;do e=g(a.positions[d++]);while(d<a.positions.length&&e.state()!=="pending");e.done(function(){b(d)})}}var c=$.Deferred(),f={location:{},page:{}};b(0);return c.promise()}function xc(){bb.setReaderInterface({goToPosition:n,
goToLocation:o,goToPage:q,openBook:jc,unloadReader:pc,onStoreOpenStatus:yc,onBookExtrasOpenStatus:zc,pauseReader:qc,resumeReader:rc,setToolbarVisible:function(a){ca(!a)},toggleToolbar:oa,setFocus:function(){setTimeout(window.focus,0)},downloadBook:sc,cancelBookDownload:tc,removeBook:uc,getSelectedText:function(a){return KindleReaderClippingManager.getSelectedText(a)},hideContextMenu:function(){KindleReaderContextMenu.hide()},getSearchContext:vc,convertPositions:wc,updateAnnotations:function(a){a=
KindleReaderAnnotationManager.updateAnnotations(a);a.done(function(){KindleRenderer.reloadAnnotations();ja()});return a},updateReaderChrome:fc})}function yc(a){KindleSpinner.hide();a===Kindle.STORE.GENERIC_ERROR?Ab?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED,Lb):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED):a===Kindle.STORE.OFFLINE_ERROR&&(Ab?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED,Lb):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED))}
function zc(a){KindleSpinner.hide();a===Kindle.BOOKEXTRAS.GENERIC_ERROR&&KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED)}function jb(){KindleHostDeviceDetector.isMetro()||KindleSpinner.show();U.openStore(R.getAsin())}function Kb(){return KindleHostDeviceDetector.isMetroSnappedView()?Eb.LANDSCAPE:window.outerHeight>window.outerWidth?Eb.PORTRAIT:Eb.LANDSCAPE}function Ka(b){var c=$.Deferred(),d={};if(Ia.pageNumbers)d.pageNumber=Pa.pageNumberFromPosition(b);(function(){ta.locationFromPosition(b).done(function(b){(a()||
f())&&b++;d.loc=b;c.resolve(d)},function(){c.resolve(d)})})();return c.promise()}var ac=30,bc="topaz",hb,cc=300,Ib="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAASklEQVQYGWMUSd/dwMDAUA/E2EAjULDh9QwXBkagwv/YVCCJgRWzwARAupCBaMYeGBdsGzEmgjXgNBFmHMzkYWUiE9B3oAAlBBoBvxIeobfDoeQAAAAASUVORK5CYII=",ga={},V,ab,Fb,Cb,R,Za,aa,lb,kb,La=null,ta,Pa,Db,xa=!1,mb,ua=!1,qa=null,xb=!0,yb,pb,Mb,bb,U,X,ob,Qa,Ya=!0,Ab=!1,Pb=!1,Qb=!1,vb=!1,wb=!1,Xa=[],ka=null,ib=null,zb=!1,la=null,tb,Da=null,Gb=
!1,Ja=!1,Ca=null,Ba=!1,$a,nb,ub=null,da={ANNOTATION_MANAGER:"annotation_manager",LPR_MANAGER:"lpr_manager",BOOK_METADATA:"book_metaData",BOOK_CONTEXT:"book_context",SearchIndexManager:"SearchIndexManager"},va={KEY:"keyboard",ARROW:"arrow",TAP:"tap",SWIPE:"swipe",WHEEL:"wheel"},Eb={LANDSCAPE:"Landscape",PORTRAIT:"Portrait"},Ra,Wa=!1,Ia={location:!0,percentage:!0,pageNumbers:!1},Bb=!1;return{initialize:function(){Cb=new jQuery.Deferred;hb=new jQuery.Deferred;bb=window.parent.KindleApp;mb=new jQuery.Deferred;
ub=new jQuery.Deferred;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();bb&&(V=new KindleReaderSettings,V.reset(),V.load(),ka=KindleSelectionStateManagerFactory(),ka.addEventListener(ka.SELECTION_CHANGED_EVENT,c),ka.addEventListener(ka.PROCESS_SELECTION_EVENT,Fa),ib=KindleSelectionHelper(KindleRenderer.getPageSelectableItemBoundaries),KindleReaderSelectionRenderer.initialize(ib),KindleReaderOverlayManager.setSelectionManager(ka),la=$("#kindleReader_book_container"),$("body").bind("touchmove.elastic",
KindleIOSScrollStopper.stopScroll),KindleHostDeviceDetector.isMetro()&&($(la).addClass("immersive_mode"),$("body").addClass("metro")),KindleHostDeviceDetector.isiOS_7x()&&$("body").addClass("ios7"),U=bb.getAppInterfaceForReader(),KindleInterfaces.assertImplements(U,KindleInterfaces.IKindleAppForReader),bb.getSharedModules().done(function(a){Kindle=a[KindleModuleManager.CONSTANTS];ResourceBundle=a[KindleModuleManager.RESOURCE_BUNDLE];KindleTemplateManager.initialize();KindleModuleManager.registerModuleList(a);
X=a[KindleModuleManager.METRICS_MANAGER];Qa=a[KindleModuleManager.SERVICE_CLIENT];hc();xc();U.onReaderReady();a=KindleRenderer.PAGE_LOAD_INCOMPLETE_FLAG_NAME;window.localStorage.getItem(a)&&(X.emit("Reader::PageLoadIncomplete"),window.localStorage.removeItem(a))}),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents());Cb.resolve()},gotoPosition:n,openStoreDP:jb,setDesktopImmersiveMode:ca,leaveDesktopImmersiveMode:function(){ca(!1)},nextPage:G,prevPage:F,register:function(a,
b){return U.register(a,b)},deregister:function(a,b){return U.deregister(a,b)},closeReader:gb,getMaxPosition:s,getSelection:function(){return ka.getSelection()||KindleRenderer.getSelection()},initializePageNumbers:function(a){Ia.pageNumbers=!0;Pa=a;a=Pa.getMaxPageNumberLabel();KindleReaderLocationBar.setMinMaxPageNumber(1,a);KindleReaderImmersiveFooter.enableLabelType("page")},getPNLabelFromLocation:function(a){var b=$.Deferred();return Ia.pageNumbers?(ta.positionFromLocation(a).done(function(a){a=
Pa.pageNumberFromPosition(a);b.resolve(a)},function(){b.resolve()}),b.promise()):b.resolve()}}}
var KindleReaderUI=KindleReaderUIFactory(),KindleX=KindleReaderUI,KindleRendererAnnotationRenderer=function(){function h(){var a={};return function(b,c){if(a[b]!==void 0)return a[b];var f=c[b];if(!f)return a[b]=!1;if(f.tagName==="IMG")return a[b]=!0;for(;f.tagName!=="BODY";){var d=$(f);if(d){var g=d.css("background-color"),d=d.css("background-image");if(g&&g!=="rgba(0, 0, 0, 0)"&&g!=="transparent"||d&&d!=="none")return a[b]=!0;f=f.parentNode}}return a[b]=!1}}function j(a){var b={};$(a).find("[data-nid]").each(function(a,
c){b[c.getAttribute("data-nid")]=c});return b}function e(b,c,f,d){b.style.top=c.top+a;b.style.height=c.height+a;b.style.left=c.left+a;b.style.width=c.width+a;b.className=f?d+" "+g:d}function d(a,b){var c=a.tagName==="IMG",f=!1,f=b!==void 0?b.tagName==="IMG":!1;return c!==f}function c(a,b,c,f,g,k){var h=a.contentDocument,t=h.createElement("DIV"),j=!1,z=!1,w={isNewLine:!0,isImageBound:!1,lineBounds:{top:0,height:0,left:0,right:0,width:0}},y=!1,G=!0;c.sort(function(b,c){return a.writingMode.clientRectCompare(b.rect,
c.rect)});for(var F=c.length,A=0;A<F;A+=1){var x=c[A].dataNid;j||typeof x==="string"&&k(x,g)&&(j=!0);var G=c[A].rect,B=void 0,x=g[x],v=void 0,I=!1;if(A<F-1)B=c[A+1].rect,v=g[c[A+1].dataNid],z=k(c[A+1].dataNid,g);x&&v&&(I=x.tagName==="IMG"||j,y=d(x,v)||z!==j);if(G=a.writingMode.updateDivIfNewLineOrImageBound(w,G,B,I,y,h.width))e(t,w.lineBounds,j,f),b.appendChild(t),t=h.createElement("DIV"),G=j=!1}}function b(a,b){b!==void 0&&(b.clickable!==void 0&&a.setAttribute(f,b.clickable),b.feedbackAnimation!==
void 0&&a.setAttribute(k,b.feedbackAnimation))}var g="semiTransparentOverlay",a="px",f="data-annotationClickable",k="data-annotationClickFeedback";return{DRAW_AFTER:"after",DRAW_OVER:"over",ANNOTATION_CLICK_ATTRIBUTE:f,ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE:k,createAnnotationElements:function(f,d,g,e,k){var r=[];if(e!==null)for(var s=KindleRendererSettings.getSettings().annotationStyles,t=KindleRendererSettings.getSettings().annotationClick,u,z=u=null,w=null,y=j(f.contentDocument),G=h(),F=0;F<e.length;F+=
1)if(z=e[F],u=z.type,s[u]){var w=t?t[u]:void 0,A=s[z.type].className;if(z.additionalStyles)for(var x in z.additionalStyles)A+=" "+z.additionalStyles[x];if(s[u].drawingType==="over"){u=f;var B=k,v=d,I=z,L=w,w=y,z=G,D=u.contentDocument.createElement("DIV");D.setAttribute("annotationType",I.type);D.setAttribute("annotationStart",I.start);b(D,L);v=KindleRendererWordRectsHelper.createWordBoundaries(I,v,u.contentDocument,u.contentWindow,u.writingMode);c(u,D,v,A,w,z);B.appendChild(D);u=D}else if(s[u].drawingType===
"after"){u=f;var B=k,v=d,I=g,L=w,D=z.start,K=-1,w=void 0;for(I.addBoundsForPosition(u.contentDocument,v,D,u.writingMode);v[D]===void 0&&K<100;)D=z.start+K,I.addBoundsForPosition(u.contentDocument,v,D,u.writingMode),K+=1;if(v[D]!==void 0)w=u.contentDocument.createElement("DIV"),w.setAttribute("annotationType",z.type),w.setAttribute("annotationStart",z.start),b(w,L),I=w,v=v[D].rects[v[D].rects.length-1],z=u.contentDocument,D=z.createElement("DIV"),u.writingMode.positionDivAfterWord(D,v,a,z.width),D.className=
"note-annotation "+A,I.appendChild(D),B.appendChild(w);u=w}else u=null;u&&r.push(u)}return r},removeAnnotationElements:function(a,b){$(a).children('[annotationtype="'+b.type+'"][annotationstart="'+b.start+'"]').remove()}}}(),KindleRenderer=function(){function h(a,b,c){a={status:a};if(b!==void 0)a.errorCode=b;if(c!==void 0)a.errorMsg=c;L!==void 0&&L(a)}function j(a,b){h(n,a,b?b:"no msg")}function e(){I=v=!1;h(s)}function d(){D!==null&&(D.endTimer(),D.log(),D=null);v=!0;h(t)}function c(){I=!1}function b(){I=
!0;h(u)}function g(a){I=!1;j(G,a)}function a(a){v=!1;j(y,a)}function f(a){a=parseInt(a,10);isNaN(a)&&(a=0);return KindleRendererContentDisplay.gotoPosition(a,!0)}function k(){return setTimeout(function(){B||(x=!0,j(z,"Init timed out"))},A)}function m(a){clearTimeout(a);return k()}function l(l,n,t,u){D===null&&(D=KindleMetricsProfiler("Renderer-Load"));L=t.statusCallback;x=!1;if(l)if(l.bookInfo&&l.containerId)if(K=$(document.getElementById(l.containerId)),K.length===0)j(w,"Container not found");else{h(r);
KindleRendererDeviceSpecific.initialize();A=KindleRendererDeviceSpecific.rendererInitializationTimeout();var q=k();KindleRendererFragmentLoader.initialize(l.bookInfo).then(function(){x||(q=m(q),KindleRendererSettings.initialize(l.bookInfo).then(function(){if(!x){q=m(q);KindleRendererPositionLoadingCalculator.updateScreenDimensions(K.width(),K.height());var k={waitNotification:e,readyNotification:d,rectsWaitNofification:c,rectsReadyNotification:b,rectsErrorNotification:g,errorNotification:a,annotationTriggered:t.annotationEventCallback};
l.startingPositionDfd.done(function(a){x||(q=m(q),KindleRendererContentDisplay.initialize(K.get(0),k,l.bookInfo,u,a).then(function(){x||(KindleRendererSettings.updateSettings(n),KindleGlyphRenderer.updateSettings(n),KindleRendererContentDisplay.updateSettings(n),B=!0,f(a))},function(a){x||j(z,"Load Failure: "+a)}))})}},function(){x||j(z,"Load Failure: Metadata")}))},function(a){x||j(z,"Load Failure: "+a)})}else throw{name:"initializationError",message:"required parameters not present"};}function o(){if(!B)throw{name:"initializationError",
message:"Please call KindleRenderer.initialize function first"};}var q=0,n=q++,r=q++,s=q++,t=q++,u=q++,z=q++,w=q++,y=q++,G=q++,F=q++,q=q++,A=12E4,x=!1,B=!1,v=!1,I=!1,L=void 0,D=null,K=null;return{STATUS_ERROR:n,STATUS_LOADING:r,STATUS_PAGINATING:s,STATUS_PAGINATED:t,STATUS_DONE:u,ERROR_LOAD_FAILURE:z,ERROR_CONTAINER_NOT_FOUND:w,ERROR_UNABLE_TO_GET_BOOK_CONTENT:y,ERROR_UNABLE_TO_GET_WORD_RECTS:G,ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT:F,ERROR_UNKNOWN:q,PAGE_LOAD_INCOMPLETE_FLAG_NAME:"PageLoadIncomplete",
initialize:function(a,b,c,f){try{l(a,b,c,f)}catch(d){}},shutdown:function(){try{B&&(B=!1,KindleRendererContentDisplay.cleanup(),KindleGlyphRenderer.cleanup(),KindleRendererCanvasInsertion.cleanup())}catch(a){}},getMinimumPosition:function(){o();return KindleRendererFragmentLoader.getMinimumPosition()},getMaximumPosition:function(){o();return KindleRendererFragmentLoader.getMaximumPosition()},createWordIterator:function(){o();try{return KindleRendererWordIteratorFactory.build()}catch(a){}return null},
updateSettings:function(a){try{KindleRendererSettings.updateSettings(a),KindleGlyphRenderer.updateSettings(a),KindleRendererContentDisplay.updateSettings(a)}catch(b){return!1}},gotoPosition:function(a){o();try{return f(a)}catch(b){}return!1},nextScreen:function(){o();try{if(v)return KindleRendererContentDisplay.nextScreen()}catch(a){}return!1},previousScreen:function(){o();try{if(v)return KindleRendererContentDisplay.previousScreen()}catch(a){}return!1},hasNextScreen:function(){o();try{if(v)return KindleRendererContentDisplay.hasNextScreen()}catch(a){}return!1},
hasPreviousScreen:function(){o();try{if(v)return KindleRendererContentDisplay.hasPreviousScreen()}catch(a){}return!1},getPagePositionRange:function(){o();try{if(v)return KindleRendererContentDisplay.getPagePositionRange()}catch(a){}return{currentTopOfPage:0,currentBottomOfPage:0}},getPageSelectableItemBoundaries:function(){o();try{if(I)return KindleRendererContentDisplay.getSelectableItemBoundaries()}catch(a){}return null},getPageWordPositions:function(){o();try{if(I)return KindleRendererContentDisplay.getWordPositions()}catch(a){}return null},
onWindowResize:function(){if(B)try{KindleRendererPositionLoadingCalculator.updateScreenDimensions(K.width(),K.height()),KindleRendererContentDisplay.onWindowResize()}catch(a){}},handleClick:function(a,b){try{if(v)return KindleRendererContentDisplay.handleClick(a,b)}catch(c){}return null},reloadAnnotations:function(){try{v&&KindleRendererContentDisplay.reloadAnnotations()}catch(a){}},getContentRects:function(){o();try{if(v)return KindleRendererContentDisplay.getContentRects()}catch(a){}return null},
getZoomableAt:function(a,b){o();try{if(v)return KindleRendererContentDisplay.getZoomableAt(a,b)}catch(c){}return null},getZoomableList:function(){o();try{if(v)return KindleRendererContentDisplay.getZoomableList()}catch(a){}return null},clearSelection:function(){if(B)try{v&&KindleRendererContentDisplay.clearSelection()}catch(a){}},getSelection:function(){o();try{if(v)return KindleRendererContentDisplay.getSelection()}catch(a){}}}}(),KindleRendererWordIteratorFactory=function(){function h(a,b,c,d){for(var g=
!0;g;){g=a.getItem();if(g.pos>b){d.resolve(c);return}c+=g.text;g=a.next()}a.getLoadingDfd().then(function(g){g?h(a,b,c,d):d.resolve(c)},d.reject)}function j(a){a.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest=null};a.newRequest=function(a,b,c){this.cancelCurrentRequest();this.currentRequest={requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("word-iterator-load"),position:a,stopPosition:b,direction:c}};a.newRequestDfd=function(){this.currentRequestDfd=
new jQuery.Deferred;this.currentRequestReachedTerminal=!1};a.fragmentLoadedCallback=function(a){var b=this;b.loadedRange=a.contentRange;b.wordMapGenerator.createWordMap(a.fragmentRoot,a.positionData).then(function(a){b.createPositionInfo(a)},function(){b.currentRequestDfd.reject()})};a.calculateContinuePosition=function(a){return a===b?this.loadedRange.startPosition-1:this.loadedRange.endPosition+1};a.hasReachedStopPosition=function(a){if(this.currentRequest&&this.currentRequest.stopPosition!==void 0){var c=
this.currentRequest.direction,d=this.currentRequest.stopPosition,a=a?this.positions[this.currPositionIndex]:this.calculateContinuePosition(c);return c===b&&a<d||a>d}return!1};a.createPositionInfo=function(a){this.wordMap=a;a=this.currentRequest.direction;this.positions=[];for(var d in this.wordMap)this.positions.push(parseInt(d,10));this.positions.sort(function(a,b){return a-b});d=this.findPosition(this.currentRequest.position,a);this.hasReachedStopPosition(d)?this.currentRequestDfd.reject():d?(this.currentRequest=
null,this.currentRequestDfd.resolve(!this.currentRequestReachedTerminal)):a===b&&this.startPositionIsLoaded()||this.endPositionIsLoaded()?this.currentRequestReachedTerminal?this.currentRequestDfd.reject():(this.currentRequestReachedTerminal=a!==c,a=a===b?g:b,this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,a)):this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,a)};a.findPosition=function(a,c){this.currPositionIndex=KindleListUtilities.binarySearch(this.positions,
a);return c===b?a>=this.positions[0]:(this.positions[this.currPositionIndex]<a&&++this.currPositionIndex,this.currPositionIndex<this.positions.length)};a.beginLoad=function(a,c,d){var g=this;g.newRequest(a,c,d);a=KindleRendererFragmentLoader.getFragmentIdForPosition(a,d===b);KindleRendererFragmentLoader.getFragmentAtId(a,g.currentRequest).then(function(a,b){g.currentRequest&&g.currentRequest.requestId===a.requestId&&g.fragmentLoadedCallback(b)},function(){g.currentRequestDfd.reject()})};a.gotoPosition=
function(a,b){this.newRequestDfd();if(this.currentRequest===null&&this.loadedRange!==null&&a>=this.loadedRange.startPosition&&a<this.loadedRange.endPosition&&this.findPosition(a,c))return this.currentRequestDfd.resolve(!0),this.currentRequestDfd.promise();this.beginLoad(a,b,c);return this.currentRequestDfd.promise()};a.getItem=function(){if(this.currentRequest===null){var a=this.positions[this.currPositionIndex];return{pos:a,text:this.wordMap[a].text}}return null};a.previous=function(a){if(this.currPositionIndex===
null||this.currentRequest!==null)return!1;this.currPositionIndex--;return this.currPositionIndex<0?(this.startPositionIsLoaded()?(this.currPositionIndex=0,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.startPosition-1,a,b)),!1):!0};a.next=function(a){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex++;return this.currPositionIndex>=this.positions.length?(this.endPositionIsLoaded()?(this.currPositionIndex=
this.positions.length-1,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.endPosition+1,a,g)),!1):!0};a.getLoadingDfd=function(){return this.currentRequestDfd.promise()};a.startPositionIsLoaded=function(){return this.loadedRange.startPosition<=KindleRendererFragmentLoader.getMinimumPosition()};a.endPositionIsLoaded=function(){return this.loadedRange.endPosition>=KindleRendererFragmentLoader.getMaximumPosition()}}function e(a,b){a.getItem=
function(){return b.getItem()};a.previous=function(a){return b.previous(a)};a.next=function(a){return b.next(a)};a.getLoadingDfd=function(){return b.getLoadingDfd()};a.gotoPosition=function(a,c){var d=Math.max(a,KindleRendererFragmentLoader.getMinimumPosition()),d=Math.min(d,KindleRendererFragmentLoader.getMaximumPosition());return b.gotoPosition(d,c)};a.getText=function(a,b){var c=this,f=new jQuery.Deferred;c.gotoPosition(a).then(function(){h(c,b,"",f)},f.reject);return f.promise()};a.clear=function(){d(b)}}
function d(a){a.currentRequest=null;a.currentRequestDfd=null;a.currentRequestReachedTerminal=null;a.loadedRange=null;a.wordMap=null;a.positions=null;a.currPositionIndex=null}var c="goto",b="prev",g="next";return{build:function(){var a={};a.wordMapGenerator=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordText();d(a);j(a);var b={};e(b,a);return b}}}(),KindleRendererCanvasInsertion=function(){function h(b,a){for(var c=b;c<a.length;c++){a[c].innerHTML="";a[c].width=0;for(var d=a[c].attributes.length;--d>=
0;)a[c].removeAttribute(a[c].attributes[d].nodeName)}}function j(c,a,f,k){var m=a.getElementsByTagName("html")[0],l=a.getElementsByTagName("body")[0],j=Array.prototype.slice.call(l.getElementsByClassName("k4wc"));if(j.length>0){m.removeChild(l);var q=j.length,n=KindleRendererDeviceSpecific.maximumCanvases();d[c]=0;var r=null;e[c]||(e[c]=[]);var s=function(f){f=j[f];if(d[c]>=n)if(f.parentNode.removeChild(f),f=parseInt(f.id,10),k){if(r===null||f>r)r=f}else{if(r===null||f<r)r=f}else{var e=b(c,a);e.id=
f.id;e.setAttribute("height",f.getAttribute("height"));e.setAttribute("width",f.getAttribute("width"));e.setAttribute("data-nid",e.id);e.innerHTML=f.innerHTML;f.parentNode.replaceChild(e,f)}},t;if(k)for(t=q-1;t>=0;t--)s(t);else for(t=0;t<q;t++)s(t);if(r!==null){q=KindleMetricsProfiler("remove-extra-canvases");if(k){if($(l).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)<r}).remove(),f.startPosition<=r)f.startPosition=r+1}else if($(l).find("*").filter(function(){return parseInt(this.getAttribute("id"),
10)>r}).remove(),f.endPosition>=r)f.endPosition=r-1;q.endTimer();q.log()}h(d[c],e[c]);m.appendChild(l)}}var e=[],d=[],c=0,b=function(){return window.ActiveXObject&&window.XMLHttpRequest?function(b,a){return a.createElement("CANVAS")}:function(b,a){d[b]++;var f=d[b],k=e[b],h=null;f>k.length?(h=a.createElement("CANVAS"),c+=1,k[f-1]=h):h=k[f-1];return h}}();return{changeSpanToCanvas:function(b,a,c,d){j(b,a,c,d)},cleanup:function(){for(var b in e)for(var a=e[b],c=a.length,d=0;d<c;d+=1){var h=a[d],l=h.parentNode;
l!==null&&l!==void 0&&l.removeChild(h)}e=null}}}(),KindleGlyphRenderer=function(){function h(a,b,c,f,d,g,e,k){b=b[f.imgSrc];if(c.getContext&&b!==void 0){var h=new Image,m=f.o;m||(m=[0,0]);h.onload=function(){if(a===q){var b=m,f=c,h=f.getContext("2d"),n=b[0]*d/1440,b=b[1]*d/1440,l={x:n,y:b,w:this.width*g,h:this.height*g};e[f.id]||(e[f.id]=[]);f=e[f.id];f[f.length]=l;h.translate(n,b);h.scale(g,g);h.drawImage(this,0,0);h.scale(1/g,1/g);h.translate(-n,-b);c=null}setTimeout(k,25)};h.src=b;f=b=b=null}else setTimeout(k,
10)}function j(a,b,c,f){if(b.getContext){var d=c.o;d||(d=[0,0]);var g=b.getContext("2d");g.translate(d[0]*f/1440,d[1]*f/1440);g.fillStyle=e(b);for(var k,h,m,n,l,j=c.l.length,q=0;q<j;q++){a:{k=c.l[q][0];m=void 0;for(l=0;l<a.length;l+=1)if(m=a[l].glyphFragmentMetadata,k>=m.startingGlyph&&k<=m.endingGlyph){m=k-m.startingGlyph;k=a[l].glyphData[m];break a}k=null}if(k!==null){m=c.l[q][1]+c.p[0];n=c.l[q][2]+c.p[1];l=f/k.dpi;m=(m-c.p[0])*f/1440;n=(n-c.p[1])*f/1440;g.translate(m,n);g.scale(l,l);g.beginPath();
for(var o=k.c.length,r=0;r<o;r++){var M=k.c[r];g.moveTo(M[0],M[1]);h=M.length-6;for(var H=2;H<h;H+=6)g.bezierCurveTo(M[H],M[H+1],M[H+2],M[H+3],M[H+4],M[H+5]);h=M.length;g.bezierCurveTo(M[h-4],M[h-3],M[h-2],M[h-1],M[0],M[1])}g.closePath();g.fill();g.scale(1/l,1/l);g.translate(-m,-n)}}g.translate(-(d[0]*f/1440),-(d[1]*f/1440));if(b.parentNode.tagName==="A")g.strokeStyle=e(b),g.lineWidth=s.lineWidth,g.beginPath(),g.moveTo(0,b.height-1),g.lineTo(b.width,b.height-1),g.stroke(),g.closePath()}}function e(a){a=
a.parentNode;return a.tagName==="A"?s.linkColor:(a=a.getAttribute("class"))&&a.indexOf("fixedOverlap")>=0?o:s.textColor}function d(a){for(var a=a.getElementsByTagName("CANVAS"),b={},c=0;c<a.length;c+=1)b[a[c].id]=a[c];return b}function c(a,b,c,f,d,g){for(var e={},k=0;k<a.length;k+=1){var h=b[a[k].id];if(h)for(var m=0;m<h.length;m++){var n=d[h[m].id];if(n){var l=f,j=n.parentNode.getAttribute("class");if(j&&j.indexOf("fixed")>=0){var l=c,j=n,q=g;if(q[j.id])l=q[j.id];else{var o=j.getAttribute("height"),
r=j.getAttribute("width"),s=0,J=0,O=1;if(o&&!(o<=0||!r||r<=0))o>l.height&&(s=l.height/o),r>l.width&&(J=l.width/r),s>0&&J>0?O=s<J?s:J:s>0?O=s:J>0&&(O=J),q[j.id]=O;l=O}}if(l!==1&&!e[n.id])e[n.id]=1,n.width=Math.round(l*n.width),n.height=Math.round(l*n.height)}}}}function b(a,c,f,d,g,e,k,m,l,j,o){function r(){a===q?b(a,c,f+1,d,g,e,k,m,l,j,o):setTimeout(o,10)}for(var s=d.length;c<s;){var D=g[d[c].id];if(D)for(var K=D.length;f<K;){var M=D[f];if(M.imgSrc!==void 0){var H=m[M.id];if(H){s=l[H.id];s=s!==void 0?
s:e;h(a,k,H,M,s*n,s,j,r);return}}f+=1}c+=1;f=0}setTimeout(o,10)}function g(a,c,f,d,g,e,k,h,m){b(a,0,0,c,f,d,g,e,k,h,m)}function a(b,c,f,d,g,e,k,h,m,l,o){function r(){b===q?a(b,c,f+1,d,g,e,k,h,m,l,o):setTimeout(o,l.time)}var s=0,D=d.length;for(KindleRendererProcessTuning.startingOperation("GlyphRenderering");c<D;){var K=g[d[c].id];if(K)for(var M=K.length;f<M;){var H=K[f];if(H.l!==void 0&&H.l.length>0){var J=h[H.id];if(J){var O=m[J.id];j(k,J,H,(O!==void 0?O:e)*n);s+=1;if(s>=l.frequency){KindleRendererProcessTuning.endingOperation("GlyphRenderering",
s);setTimeout(r,l.time);return}}}f+=1}c+=1;f=0}KindleRendererProcessTuning.endingOperation("GlyphRenderering",s);setTimeout(o,l.time)}function f(b,c,f,d,g,e,k,h,m){a(b,0,0,c,f,d,g,e,k,h,m)}function k(a,b,e,k,h,m){var l={height:$(a).parent().height()*0.85,width:$(a).parent().width()*0.85},n=d(a.contentDocument),j=[],o=a.contentDocument.getElementsByTagName("html")[0],v=a.contentDocument.getElementsByTagName("body")[0],v=o.removeChild(v),I=$(v).find("p"),L={},D=h.createSubTimer("resizing-canvases");
c(I,e.paraData,l,s.glyphScale,n,L);D.endTimer();D=h.createSubTimer("rendering-all-images");g(b.requestId,I,e.paraData,s.glyphScale,e.imageData,n,L,j,function(){D.endTimer();if(!(q!==b.requestId||a.processingRequestId.id!==b.requestId)){D=h.createSubTimer("rendering-all-glyphs");var c={frequency:KindleRendererProcessTuning.drawYieldFrequency("GlyphRenderering"),time:KindleRendererProcessTuning.drawYieldUpdateTime("GlyphRenderering")};f(b.requestId,I,e.paraData,s.glyphScale,k,n,L,c,function(){D.endTimer();
q!==b.requestId||a.processingRequestId.id!==b.requestId||(o.appendChild(v),r[a.id]=j,n=L=null,setTimeout(m,c.time))})}})}function m(a,b,c,f){var d=new jQuery.Deferred;if(q===null||b.requestId>=q){q=b.requestId;var g=b.metrics.createSubTimer("glyph-rendering");k(a,b,c,f,g,function(){q===b.requestId&&a.processingRequestId.id===b.requestId&&(q=null,g.endTimer(),d.resolve())})}return d.promise()}function l(a){var b={r:parseInt(s.textColor.substring(1,3),16),g:parseInt(s.textColor.substring(3,5),16),b:parseInt(s.textColor.substring(5,
7),16)},c=r[a.id];$(a.contentDocument).find("canvas").each(function(){var a=this.parentNode;if(a.tagName!=="A"&&(a=a.getAttribute("class"),!a||a.indexOf("fixedOverlap")<0)){a=this.getContext("2d");try{var f=a.getImageData(0,0,this.width,this.height),d=this.width*this.height*4,g=c[this.id];if(g){for(var e=this.width,k=0,h=g.length,m=[];k<h;k+=1)for(var l=Math.floor(g[k].x),n=Math.floor(g[k].y),j=Math.ceil(g[k].w),t=Math.ceil(g[k].h),q=0;q<t;q+=1)for(var o=(e*(n+q)+l)*4,r=o+j*4;o<=r;o+=4)m[o]=1;for(var s=
f.data,C=b.r,E=b.g,N=b.b,g=0;g<d;g+=4)s[g+3]>0&&!m[g]&&(s[g]=C,s[g+1]=E,s[g+2]=N)}else{m=f.data;k=b.r;q=b.g;o=b.b;for(s=0;s<d;s+=4)m[s+3]>0&&(m[s]=k,m[s+1]=q,m[s+2]=o)}a.putImageData(f,0,0)}catch(P){}}})}var o="#000000",q=null,n=100,r=[],s={glyphScale:1,textColor:o,linkColor:"#0000ff",lineWidth:1};return{renderAllContent:function(a,b,c,f){return m(a,b,c,f)},updateTextColor:function(a){l(a)},updateSettings:function(a){if(a.glyphScale!==void 0&&(s.glyphScale=a.glyphScale,s.glyphScale<0.75||s.glyphScale>
3))s.glyphScale=Math.max(0.75,Math.min(3,s.glyphScale));if(a.fontColor!==void 0)s.textColor=a.fontColor},clearIframeData:function(a){r[a.id]=void 0},cleanup:function(){r=null}}}(),KindleRendererContentFragmentation=function(){function h(a){a=$.extend(!0,{},a);if(!isFinite(a.startPosition)||!isFinite(a.endPosition))a.startPosition=0,a.endPosition=1E4;if(a.startPosition<0)a.startPosition=0;if(a.endPosition<0)a.endPosition=1E4;return a}function j(a){return!a||!a.requestData||a.requestData.cancelled===
!0}function e(a,b){for(var c=Math.max(l[0].cPos,b.startPosition),f=Math.min(l[l.length-1].ePos,b.endPosition),d=[],g=Infinity,e=-Infinity,k=0;k<l.length;k+=1)if(l[k].sId===a){var h=k===0?l[k].cPos:Math.min(l[k].cPos,l[k-1].ePos+1),m=l[k].ePos;if(!(m<c)){if(h>f)break;h<g&&(g=h);m>e&&(e=m);d.push(k)}}d[0]===1&&l[0].cPos===l[0].ePos&&l[0].cPos===l[1].cPos&&d.push(0);return{fragmentList:d,startPosition:g,endPosition:e}}function d(c,f){if(f!==null)f.skeletonData=c.skeletonData,f.resourceInfo=c.resourceInfo,
b(c),f.fragmentLoadMetrics=f.overallLoadMetrics.createSubTimer("fragments"),o.getBookFragments(function(b){j(f)?(f=null,k(b)):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),f.requestData.type,function(){var c=f;if(c===null||c.loadedFragments===null)k(b);else{c.numFragmentsLoaded+=1;var d=b.fragmentMetadata.id,e=l[d];if(b.wordList)for(var h in b.wordList)b.wordList[h]+=e.cPos;c.loadedFragments[d]=b;if(!(c.numFragmentsLoaded<c.fragmentsToLoad.length)&&
(c.fragmentLoadMetrics.endTimer(),c!==null)){var m,e=c.loadedFragments,d={},n;for(n in e)if(h=e[n].imageRefs)for(var j in h)d[h[j]]=!0;n=[];for(m in d)n.push(m);m=KindleRendererImageRenderer.resolveCompositeResources(n);m.length>0?a(m,c):g(c)}}})},function(){if(f!==null){var a=f.requestData;f.fragmentLoadMetrics.addCount("Failure",1);f.fragmentLoadMetrics.endTimer();var b=f.deferredResult;f.loadedFragments=null;f=f.glyphData=null;b.reject("Error trying to download file fragments.",a)}},f.fragmentsToLoad)}
function c(a){if(a!==void 0&&a!==null&&a.length>0&&n>0){var b=[],c,f,d,g;q=[];f=Math.min(a.length,n);c=n-f;for(d=0;d<a.length&&d<f;++d)g=a[d].glyphFragmentMetadata.id,b[g]=a[d],delete q[g];if(c>0)for(d in q)if(b[d]=q[d],--c===0)break;q=b}}function b(a){if(a.skeletonMetadata){var b=a.skeletonMetadata.id;r[b]===void 0&&(r={},r[b]=a)}}function g(a){function b(c){j(a)&&(a=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),a&&a.requestData.type,function(){var b=
a;b===null||b.glyphData===null?(c.glyphData=null,c.glyphFragmentMetadata=null):(b.glyphChunkLoadCnt+=1,b.glyphData.push(c),b.glyphChunkLoadCnt<b.glyphChunksToDownload.length||(b.glyphLoadMetrics.endTimer(),f(b)))})}function c(){if(a!==null&&a.glyphData!==null){var b=a.requestData,f=a.deferredResult;a.glyphLoadMetrics.addCount("Failure",1);a.glyphLoadMetrics.endTimer();a=a.glyphData=null;f.reject("Error trying to download glyph chunks.",b)}}if(a!==null){var d,g=[],e=[],k;for(k in a.loadedFragments)if(d=
m(parseInt(k,10)),d.gCks)for(var h=0;h<d.gCks.length;h+=1)$.inArray(d.gCks[h],e)===-1&&e.push(d.gCks[h]);d=[];for(k=0;k<e.length;k+=1)h=e[k],q[h]===void 0?d.push(h):g.push(q[h]);a.glyphData=g;d.length>0?(g=a.overallLoadMetrics.createSubTimer("glyph-loading"),g.addCount("NumGlyphCunks",d.length),a.glyphChunkLoadCnt=0,a.glyphChunksToDownload=d,a.glyphLoadMetrics=g,o.getGlyphFragments(b,c,d,a)):f(a)}}function a(a,b){var c=b.overallLoadMetrics.createSubTimer("resources");b.fragmentResources={};b.fragmentResourceLoadCnt=
0;b.fragmentResourceToDownload=a;b.fragmentResourceLoadMetrics=c;o.getResourceUrls(function(a){j(b)&&(b=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),b&&b.requestData.type,function(){var c=b;c!==null&&(c.fragmentResourceLoadCnt+=1,jQuery.extend(c.fragmentResources,a),c.fragmentResourceLoadCnt<c.fragmentResourceToDownload.length||(c.fragmentResourceLoadMetrics.endTimer(),g(c)))})},function(){if(b!==null){var a=b.requestData,c=b.deferredResult;
b.fragmentResourceLoadMetrics.addCount("Failure",1);b.fragmentResourceLoadMetrics.endTimer();b=null;c.reject("Error trying to download fragment resources.",a)}},a)}function f(a){if(!(a===null||a.loadedFragments===null)){c(a.glyphData);var b,f;for(f in a.loadedFragments)if(a.loadedFragments[f].fragmentMetadata.lId===void 0)b=m(parseInt(f,10)),a.loadedFragments[f].fragmentMetadata.lId=b.lId,a.loadedFragments[f].fragmentMetadata.lt=b.lt,a.loadedFragments[f].fragmentMetadata.nOff=b.off;b=null;var d=a.deferredResult,
g=a.requestData,e={};e.skeletonData=a.skeletonData;e.resourceInfo=a.resourceInfo;e.glyphData=a.glyphData;e.fragmentResources=a.fragmentResources;e.contentRange={skeletonId:a.skeletonId,startPosition:a.fragmentsStartPosition,endPosition:a.fragmentsEndPosition};e.fragmentData=a.loadedFragments;var k=a.overallLoadMetrics;a.glyphData=null;a.fragmentResources=null;var a=a.loadedFragments=null,h=k.createSubTimer("(YIELD) finish-content-fetch");setTimeout(function(){h.endTimer();k.endTimer();d.resolve(g,
e);e=g=null},KindleRendererDeviceSpecific.drawYieldUpdateTime())}}function k(a){a.fragmentData=null;a.fragmentMetadata=null;a.paraData=null}function m(a){return l[a]}var l=null,o=null,q=[],n,r={};return{initialize:function(a){q=[];n=KindleRendererDeviceSpecific.glyphCacheMaxSize();r={};o=a;var b=new jQuery.Deferred;o.getFragmentMap(function(a){l=a.fragmentArray;o.getManifest?o.getManifest(function(c){KindleRendererImageRenderer.initialize(c);b.resolve(a,c)},function(){b.resolve(a,null)}):b.resolve(a)},
function(){b.reject()});return b.promise()},cleanup:function(){o=l=null;q=[];r={};KindleRendererImageRenderer.cleanup()},loadNextFragmentGroup:function(a,b,c){function f(a){j(B)?B=null:(q.endTimer(),d(a,B))}function k(){if(B!==null){var a=B.requestData;B.fragmentLoadMetrics.addCount("Failure",1);B.fragmentLoadMetrics.endTimer();B=null;n.reject("Error trying to download skeleton.",a)}}function m(){v.endTimer();j(B)?B=null:(q=B.overallLoadMetrics.createSubTimer("skeletons"),r[a]!==void 0?f(r[a]):o.getBookSkeleton(f,
k,a))}var n=new jQuery.Deferred,b=h(b),l=c.metrics.createSubTimer("content-fetch"),q,b=e(a,b),b=h(b),x=b.fragmentList.slice(),B={deferredResult:n,skeletonId:a,fragmentsStartPosition:b.startPosition,fragmentsEndPosition:b.endPosition,overallLoadMetrics:l,loadedFragments:{},fragmentsToLoad:x,numFragmentsLoaded:0,requestData:c},v=l.createSubTimer("(YIELD) begin-content-fetch");x.length===0?g(B):setTimeout(m,KindleRendererDeviceSpecific.drawYieldUpdateTime());return n.promise()},isContentRangeLoaded:function(a,
b,c,f){if(a===null||a===void 0||!b||c===null||c===void 0||!f)return!1;if(a!==c)return!1;b=h(b);f=h(f);a=e(a,b);c=e(c,f);if(c.fragmentList.length>a.fragmentList.length)return!1;for(f=0;f<c.fragmentList.length;++f)if(a.fragmentList.indexOf(c.fragmentList[f])===-1)return!1;return!0}}}(),KindleRendererFragmentLoader=function(){function h(a){for(var b=0;b<c.length;b++){var d=c[b];if(d.start<=a&&a<=d.end)return b}return 0}function j(a){g=a;var f=new jQuery.Deferred;KindleRendererContentFragmentation.initialize(g).then(function(a){var g=
[],e,h=a.fragmentArray;for(e=0;e<h.length;e+=1){var j=h[e].sId,n=e===0?h[e].cPos:Math.min(h[e].cPos,h[e-1].ePos+1),r=h[e].ePos,s=g[j];if(s===void 0)g[j]={start:n,end:r};else{if(n<s.start)s.start=n;if(r>s.end)s.end=r}}if(a.skeletonMap!==void 0)for(e=0;e<a.skeletonMap.length;++e)if(g[e])g[e].properties=a.skeletonMap[e].properties;c=g;d=a.fragmentArray;b=a.fragmentMetadata.bookType;f.resolve()},f.reject);return f.promise()}function e(a,b,c){g.getBookFragments(function(a){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),
b.type,function(){var g=a.fragmentMetadata.id,e=d[g],h,n;h=a.fragmentMetadata.lId===void 0||a.fragmentMetadata.lId===null?e.lId:a.fragmentMetadata.lId;n=a.fragmentMetadata.nOff===void 0||a.fragmentMetadata.nOff===null?e.off:a.fragmentMetadata.nOff;var j=document.createElement("DIV");j.id=h;j.setAttribute("data-nid",h);j.innerHTML=a.fragmentData;h=j.childNodes;for(var s=h.length,t=0;t<s;t+=1)h[t].ownChildIndex=n+t;c.resolve(b,{id:g,contentRange:{startPosition:e.cPos,endPosition:e.ePos},fragmentRoot:j,
positionData:{posMap:a.posMap}})})},function(){c.reject("Error trying to download file fragments ID : ",a)},[a])}var d=null,c=null,b=!1,g=null;return{initialize:function(a){return j(a)},cleanup:function(){KindleRendererContentFragmentation.cleanup();c=d=null;b=!1},loadFragments:function(a,b){var c=h(a.focus);return KindleRendererContentFragmentation.loadNextFragmentGroup(c,a,b)},getFragmentAtId:function(a,b){var c=new jQuery.Deferred;g?e(a,b,c):c.reject();return c.promise()},getFragmentIdForPosition:function(a,
b){var c;a:{for(var g=0;g<d.length-1;++g)if(c=b?d[g+1].cPos-1:d[g].ePos,a<=c){c=g;break a}c=d.length-1}return c},needToLoadFragments:function(a,b){var c;if(!a||!b)c=!0;else{c=h(a.startPosition);var d=h(b.focus);c=!KindleRendererContentFragmentation.isContentRangeLoaded(c,a,d,b)}return c},getMaximumPosition:function(){return d[d.length-1].ePos},getMinimumPosition:function(){return d[0].cPos},isPositionAtBeginningOfSkeletonOrDocument:function(a,b){return b<=d[0].cPos||b===c[a].start},isPositionAtEndOfSkeletonOrDocument:function(a,
b){return b>=d[d.length-1].ePos||b===c[a].end},getBookContentType:function(){return b},getSkeletonForPosition:function(a){return h(a)},getSkeletonRange:function(a){return{start:c[a].start,end:c[a].end}},getGroupInfo:function(a){if(c[a].properties&&c[a].properties.group)return c[a].properties.group;var b=a%2===0?a+1:a-1;return b<0||b>=this.getNumSkeletons()||c[b].properties&&c[b].properties.group?{start:a,length:1,spine:!0}:{start:Math.min(a,b),length:2,spine:!0}},isBlankPage:function(a){return!c[a].properties?
!1:c[a].properties.blank===!0},getNumSkeletons:function(){return c.length},getFragmentMap:function(){}}}(),KindleRendererPositionLoadingCalculator=function(){function h(){if(b>0)return b;var c,a;a=KindleRendererSettings.getSettings();if(KindleRendererFragmentLoader.getBookContentType()==="topaz")c=e.width/(25*a.glyphScale),a=e.height/(25*a.glyphScale);else{var f=a.fontSizes[j];c=e.width/(f*0.4);a=e.height/(f*a.lineSpacingMultiplier)}return Math.round(c*a)}var j=2,e={height:1,width:1},d=0,c=[],b=0;
return{updateScreenDimensions:function(c,a){e.width=c;e.height=a;b=_displayedScreenCount=_logSumPositionsDisplayed=0},updateDisplayedPositionRange:function(g){g>0&&(c[d]=g,d=(d+1)%10,b=0,b=Math.max.apply(Math,c))},calculateDesiredFragmentRangeForPageFlip:function(b,a){var c=KindleRendererFragmentLoader.getBookContentType()==="topaz",d=KindleRendererDeviceSpecific.fragmentBufferCapacityForPageFlip(c),e=h();d*=e;var l=Math.ceil(d*0.25),j=Math.ceil(d*0.75),d=KindleRendererFragmentLoader.getMinimumPosition(),
q=KindleRendererFragmentLoader.getMaximumPosition(),l=Math.max(d,b-l),j=Math.min(q,b+j),n=a.currentTopOfPage,r=a.currentBottomOfPage;c?(l=Math.min(l,Math.max(d,n-1)),j=Math.max(j,Math.min(q,r+1))):b<n&&n-b<3*e?j=Math.min(q,r+1):b>r&&b-r<3*e&&(l=Math.max(d,n-1));return{focus:b,startPosition:l,endPosition:j}},calculateDesiredFragmentRangeForGoTo:function(b){var a=h()*KindleRendererDeviceSpecific.fragmentBufferCapacityForGoTo(),c=Math.ceil(a*0.1),a=Math.ceil(a),d=KindleRendererFragmentLoader.getMinimumPosition(),
e=KindleRendererFragmentLoader.getMaximumPosition();return{focus:b,startPosition:Math.max(d,b-c),endPosition:Math.min(e,Math.max(d+a,b+a))}}}}(),KindleRendererRequestId=function(){var h=0;return{getUniqueRequestId:function(){h+=1;return h}}}(),KindleRendererIframeLoading=function(){function h(){window.focus()}function j(a){a.ctrlKey&&a.preventDefault();switch(a.which){case 219:case 221:a.shiftKey||a.preventDefault();break;case 37:case 38:case 33:case 39:case 40:case 34:case 32:case 8:a.preventDefault()}}
function e(a,b){var c=b.ownerDocument.createEvent("CustomEvent");c.initCustomEvent(a.type,!0,!0,a);b.dispatchEvent(c)}function d(a,b){var c=b.ownerDocument.createEvent("MSPointerEvent");c.initPointerEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null,a.offsetX,a.offsetY,a.width,a.height,a.pressure,a.rotation,a.tiltX,a.tiltY,a.pointerId,a.pointerType,a.hwTimestamp,a.isPrimary);b.dispatchEvent(c)}function c(a,b){var c;
a.type==="mousewheel"?(a.preventDefault(),c=b.ownerDocument.createEvent("WheelEvent"),c.initWheelEvent(a.type,!0,!0,window.parent,-1*a.wheelDelta,a.screenX,a.screenY,a.clientX,a.clientY,a.button,null,null,a.deltaX,a.deltaY,a.deltaZ,a.deltaMode)):(c=b.ownerDocument.createEvent("MouseEvent"),c.initMouseEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null));b.dispatchEvent(c)}function b(a){var b=a.contentDocument.getElementsByTagName("body")[0];
b.className+=" amzUserPref";var f=a.contentDocument.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(f,KindleRendererFragmentLoader.getBookContentType());KindleRendererSettings.addCSSRules(f);KindleRendererContentScripts.addInterfaceScripts(f);b.onmousewheel=function(b){c(b,a);return!1};a.contentWindow.onkeydown=function(b){j(b);e(b,a)};a.contentWindow.onkeyup=function(b){j(b);e(b,a)};a.contentWindow.onkeypress=function(b){j(b);e(b,a)};if(KindleRendererSettings.useNativeSelection()){if(window.navigator.msPointerEnabled)b.onmspointerdown=
function(b){d(b,a)},b.onmspointerup=function(b){d(b,a)},b.onmspointermove=function(b){d(b,a)},b.onmspointerout=function(b){d(b,a)},b.onmspointercancel=function(b){d(b,a)},b.onmspointerover=function(b){d(b,a)},b.onmspointerhover=function(b){d(b,a)},b.addEventListener("MSGestureHold",function(a){a.preventDefault()},!1);b.oncontextmenu=function(b){d(b,a);b.preventDefault()};b.onclick=function(b){c(b,a)};b.ondblclick=function(b){c(b,a)};b.onmousedown=function(b){c(b,a)};b.onmouseup=function(b){c(b,a)};
b.onmousemove=function(b){c(b,a)};b.onmouseover=function(b){c(b,a)};b.onmouseout=function(b){c(b,a)}}else a.contentWindow.onfocus=h,a.contentWindow.onclick=h,b.onselectstart=function(){return!1}}function g(a){if(a=a.getElementsByTagName("body")[0])for(;a.hasChildNodes();)a.removeChild(a.lastChild)}function a(b,c){if(b&&b.nodeType===Node.ELEMENT_NODE){var d=b.getAttribute("data-nid");d!==null&&(c[d]={linkNode:b,typeArray:[b.firstChild,b.nextSibling]});for(var d=b.childNodes,f=d.length,g=0;g<f;g+=1)a(d[g],
c)}}function f(b){var c={};try{if(window.ActiveXObject&&window.XMLHttpRequest)a(b.contentDocument.body,c);else for(var d=(new XPathEvaluator).evaluate("//*[@data-nid]",b.contentDocument,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),f=d.iterateNext();f;){var g=f.getAttribute("data-nid");c[g]={linkNode:f,typeArray:[f.firstChild,f.nextSibling]};f=d.iterateNext()}}catch(e){a(b.contentDocument.body,c)}return c}function k(a){var b=[],c;for(c in a)b.push(parseInt(c,10));b.sort(function(a,b){return a-
b});return b}function m(a,b,c,d){function f(){if(J!==null)H.insertBefore(J,O),J=null,K.lId=null,K.lt=-1}function g(){h=c.fragmentData[C[E]];m=h.fragmentMetadata;if(K.lId!==m.lId||K.lt!==m.lt){f();K.lId=m.lId;K.lt=m.lt;M=b[m.lId];if(M===void 0){var k=b,P=m.lId,S=a.contentDocument.getElementById(P);k[P]={linkNode:S,typeArray:[S.firstChild,S.nextSibling]};M=b[m.lId]}J=m.lt===0?M.linkNode:M.linkNode.parentNode;H=J.parentNode;O=J.nextSibling;J=H.removeChild(J)}D=a.contentDocument.createElement(J.tagName);
D.innerHTML=h.fragmentData;k=c.fragmentResources;P=h.resList===void 0?h.imageData:h.resList;if(k||P)for(var S=$(D).find("img"),T=0,Q=0;Q<S.length;Q+=1){T=S[Q].getAttribute("dataUrl");if(T===void 0||T===null)T=S[Q].getAttribute("src");KindleRendererImageRenderer.loadImage(S[Q],k,P,T)}for(k=m.nOff;D.hasChildNodes();){P=D.removeChild(D.firstChild);if(P.nodeType===Node.TEXT_NODE)P.ownChildIndex=k;J.insertBefore(P,M.typeArray[m.lt]);k+=1}if(h.posMap!==void 0){q=!0;for(var Y in h.posMap)l[Y]=h.posMap[Y]}h.wordList!==
void 0&&(o=!0,j=j.concat(h.wordList));if(h.paraIds!==void 0&&h.paraIds!==null){L=!0;for(Y=0;Y<h.paraIds.length;Y+=1)v[h.paraIds[Y]]=h.paraData[Y];for(var W in h.imageData)I[W]=h.imageData[W]}h.fragmentData=null;h.imageData=null;h.paraData=null;E+=1;if(E<C.length)E%50===49?setTimeout(g,0):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,g);else{f();O=J=H=h=null;W={positionData:{}};if(q)W.positionData.posMap=l;if(o)W.positionData.wordList=j;if(L)W.glyphData=
{paraData:v,imageData:I};e.resolve(W)}}var e=$.Deferred(),h,m,l={},j=[],q=!1,o=!1,v={},I={},L=!1,D=null,K={lId:null,lt:-1},M=null,H=null,J=null,O=null,C=k(c.fragmentData),E=0;KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,g);return e.promise()}function l(a,b,c){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeBeforeBulkWriteToIframe(),c.type,function(){b.open();b.write(a);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterBulkWriteToIframe(),
c.type,function(){b.close()})})}function o(a,c,d,f){if(a.processingRequestId.id===c.requestId){var e=a.contentDocument;a.screenManager=null;g(e);KindleGlyphRenderer.clearIframeData(a);a.onload=function(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),c.type,function(){if(a.processingRequestId.id===c.requestId){a.onload=null;var g=KindleRendererSettings.getSettings(),e=$(a).parent(),e={height:e.height(),width:e.width()},h=c.contentLoadMetrics.createSubTimer("css-style-sanitization");
KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,g,e);h.endTimer();b(a);a.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(a);a.writingMode.resetIframeDimensions(a);q(a,c,d,f)}})};l(d.skeletonData,e,c)}}function q(a,b,c,d){function g(a){d.reject(b,a)}var e=f(a),h=b.contentLoadMetrics.createSubTimer("fragment-loading"),k;try{k=m(a,e,c,b)}catch(l){g(l);return}k.then(function(c){h.endTimer();var f=KindleRendererSettings.getSettings(),e=$(a).parent(),e={height:e.height(),
width:e.width()},k=b.contentLoadMetrics.createSubTimer("node-style-sanitization");KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,f,e).then(function(){k.endTimer();d.resolve(b,c)},g)},g)}return{loadIframe:function(a,b,c){var d=new jQuery.Deferred;a.processingRequestId.id===b.requestId?o(a,b,c,d):d.reject();return d.promise()},copyIframeContents:function(a,c,d){function f(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),
a.type,function(){if(d.processingRequestId.id===a.requestId)b(d),KindleRendererContentStyleSanitization.copySanitizationData(c.contentDocument,d.contentDocument),KindlePaginator.copyIframe(c,d),d.onload=null,d.writingMode.prepareForPagination(d),e.resolve(a)})}var e=new jQuery.Deferred,h,k;d.processingRequestId.id===a.requestId?(k=c.contentDocument.getElementsByTagName("html")[0],g(d.contentDocument),d.writingMode.resetHeight(d),d.onload=f,h=k.outerHTML,h===void 0&&(h="<html>"+k.innerHTML+"</html>"),
l(h,d.contentDocument,a)):e.reject();return e.promise()},cleanupIframe:function(a){g(a.contentDocument)},updateSettingsInIframe:function(a){if(a&&a.contentDocument){var b=a.contentDocument.getElementsByTagName("head")[0];if(b){KindleRendererSettings.addCSSRules(b);var b=KindleRendererSettings.getSettings(),c={height:$(a).parent().height(),width:$(a).parent().width()},d=KindleMetricsProfiler("style-sanitization");KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,b,c);KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,
b,c);d.endTimer()}}}}}(),KindleRendererIframeManagerFactory=function(){function h(d){d.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};d.createNewRequest=function(a,b){this.cancelCurrentRequest();this.currentRequest={type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("iframe-load"),retryCount:0,initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};d.willRetryCurrentRequest=function(){this.currentRequest&&
this.currentRequest.retryCount++};d.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<a:!0};d.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};d.getCurrentProcessId=function(){return this.currentRequest.requestId};d.createIframe=function(a,b,c){var d=document.createElement("iframe");d.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(d);d.index=c;d.processingRequestId={};d.computingRectsId={};d.setAttribute("frameBorder",
"0");d.setAttribute("id",b+"_frame_"+c);d.setAttribute("name","book_iframe_"+c);d.setAttribute("scrolling","no");d.setAttribute("tabindex",-1);$(d).css({height:"100%",width:a+"px",position:"absolute",top:"0px",left:"0px",visibility:"hidden"});return d};d.setIframeVisibility=function(a,b){if(this.showContent||!b)b?($(a).css({visibility:"visible","z-index":0}),$(a.pageOverflowDiv).css({visibility:"visible","z-index":0})):($(a).css({visibility:"hidden","z-index":f}),$(a.pageOverflowDiv).css({visibility:"hidden",
"z-index":f}))};d.calculateIframePaginationData=function(a,b,c){var d=this,f=KindleRendererFragmentLoader.getBookContentType()==="topaz"?d.currentRequest.type===d.loadedType.PREVIOUS?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,d.currentRequest,b,c,f).then(function(b){if(a.processingRequestId.id===b.requestId&&d.currentRequest&&d.currentRequest.requestId===
b.requestId)a.processingRequestId.id=null,d.frameIsLoadedAndReady(a);d=null},function(a){d.currentRequest&&d.currentRequest.requestId===a.requestId&&d.currentRequestDfd.reject(g);d=null})};d.loadContentDataIntoIframe=function(a){var c=this;c.currentRequest.contentLoadMetrics=c.currentRequest.metrics.createSubTimer("content-load");var d=c.getIframeToLoad();if(d)c.contentRange[d.index]=a.contentRange,d.processingRequestId.id=c.currentRequest.requestId,d.computingRectsId.id=null,KindleRendererIframeLoading.loadIframe(d,
c.currentRequest,a).then(function(b,f){if(d.processingRequestId.id===b.requestId&&c.currentRequest&&c.currentRequest.requestId===b.requestId)c.positionData[d.index]=f.positionData,c.calculateIframePaginationData(d,a,f);c=null},function(a){c.currentRequest&&c.currentRequest.requestId===a.requestId&&c.currentRequestDfd.reject(b);c=null})};d.loadFragmentsForRange=function(a){var b=this;KindleRendererFragmentLoader.loadFragments(a,b.currentRequest).then(function(a,c){b.currentRequest&&b.currentRequest.requestId===
a.requestId&&b.loadContentDataIntoIframe(c);b=null},function(a,d){b.currentRequest&&b.currentRequest.requestId===d.requestId&&b.currentRequestDfd.reject(c);b=null})};d.resizeWithoutReload=function(a){var b=this,c=this.iframes[a];c.processingRequestId.id=this.currentRequest.requestId;b.setIframeVisibility(c,!1);b.currentRequest.contentLoadMetrics=b.currentRequest.metrics.createSubTimer("content-load");KindleRendererContentReflow.reflow(c,this.currentRequest,this.positionData[a]).then(function(){b.currentRequest&&
b.currentRequest.requestId===c.processingRequestId.id&&(b.frameIsLoadedAndReady(c),b.setIframeVisibility(c,c.index===b.visibleIframeIndex));b=null},function(){b.currentRequest&&b.currentRequest.requestId===c.processingRequestId.id&&(b.setIframeVisibility(c,c.index===b.visibleIframeIndex),b.currentRequestDfd.reject(g));b=null})};d.setCanPreloadNext=function(a){this.canPreloadNext=a};d.setCanPreloadPrevious=function(a){this.canPreloadPrevious=a};d.getIframeOrigin=function(a){a=$(this.iframes[a]);return{x:parseInt(a.css("left"),
10),y:parseInt(a.css("top"),10)}};d.getBoundsWithOffset=function(a,b){if(a.getBoundingClientRect){var c=a.getBoundingClientRect();if(c)return{top:c.top+b.y,right:c.right+b.x,bottom:c.bottom+b.y,left:c.left+b.x,width:c.width,height:c.height}}return null}}function j(a,b){a.gotoPosition=function(a,c){return b.gotoPosition(a,c)};a.nextScreen=function(){return b.nextScreen()};a.previousScreen=function(){return b.previousScreen()};a.copyIframeData=function(a){return b.copyIframeData(a.internal)};a.hasNextScreen=
function(){return b.hasNextScreen()};a.hasPreviousScreen=function(){return b.hasPreviousScreen()};a.getPagePositionRange=function(){return b.getPagePositionRange()};a.getCurrentPosition=function(){return b.getCurrentPosition()};a.getSelectableItemBoundaries=function(){return b.getSelectableItemBoundaries()};a.getWordPositions=function(){return b.getWordPositions()};a.reloadAnnotations=function(){b.reloadAnnotations()};a.updateGlyphColor=function(){b.updateGlyphColor()};a.handleClick=function(a,c){return b.handleClick(a,
c)};a.cleanup=function(){b.cleanup()};a.updateSettings=function(a){b.updateSettings(a)};a.reloadNotification=function(){b.reloadNotification()};a.resizeNotification=function(){b.resizeNotification()};a.setAnnotationEventCallback=function(a){b.setAnnotationEventCallback(a)};a.getCurrentProcessDfd=function(){return b.getCurrentProcessDfd()};a.getComputedRectsDfd=function(){return b.getComputedRectsDfd()};a.getCurrentProcessId=function(){return b.getCurrentProcessId()};a.show=function(){b.show()};a.hide=
function(){b.hide()};a.getContentRects=function(){return b.getContentRects()};a.getZoomableAt=function(a,c,d){return b.getZoomableAt(a,c,d)};a.getZoomableList=function(a){return b.getZoomableList(a)};a.setOverlayManager=function(a){b.setOverlayManager(a)};a.setCanPreloadPrevious=function(a){b.setCanPreloadPrevious(a)};a.setCanPreloadNext=function(a){b.setCanPreloadNext(a)};a.drawWordMap=function(){b.drawWordMap()};a.drawHeightMaps=function(){b.drawHeightMaps()};a.clearSelection=function(){b.clearSelection()};
a.getSelection=function(){return b.getSelection()}}function e(a){a.showContent=!0;a.canPreloadNext=!0;a.canPreloadPrevious=!0}var d=0,c=d++,b=d++,g=d++,a=5,f=-1E3;return{DATA_LOAD_ERROR:c,IFRAME_ERROR_LOADING:b,IFRAME_ERROR_PAGINATING:g,build:function(a){if(KindleRendererSettings.useCSSRegions()){var b={};e(b,a);h(b);KindleRegionIframeManager.build(b,a);a={internal:b}}else KindleRendererSettings.getSettings().fixedContent?(b={},e(b,a),h(b),KindleRendererIframeManagerFixedFactory.build(b,a),a={}):
(b={},e(b,a),h(b),KindleRendererIframeManagerReflowFactory.build(b,a),a={internal:b});j(a,b);return a}}}(),KindleRendererIframeManagerFixedFactory=function(){function h(e){e.findNextNonBlankPage=function(d,c){var b=this.findNextNonBlankPageInDirection(d,c);b===null&&(b=this.findNextNonBlankPageInDirection(d,!c));return b};e.findNextNonBlankPageInDirection=function(d,c){for(var b=d,g=KindleRendererFragmentLoader.getNumSkeletons();b>=0&&b<g;){if(KindleRendererFragmentLoader.isBlankPage(b)===!1)return b;
c?b+=1:b-=1}return null};e.getNeededSkeletonsFrom=function(d,c){for(var b=this.getSkeletonsToShowWith(d,c),g=0;g<b.length;g++)if(KindleRendererFragmentLoader.isBlankPage(b[g])===!1)return b;g=this.findNextNonBlankPage(c?Math.max.apply(Math,b)+1:Math.min.apply(Math,b)-1,c);return g===null?b:this.getSkeletonsToShowWith(g,c)};e.addSkeletonRangeToList=function(d,c,b){for(var g=0;g<b;g+=1)d.push(c+g)};e.getSkeletonsToShowWith=function(d,c){var b=KindleRendererFragmentLoader.getGroupInfo(d);if(b.length>
this.numberOfColumns){var g=[];this.addSkeletonRangeToList(g,d,Math.min(this.numberOfColumns,b.length-(d-b.start)));return g}return this.getGroupsToFillScreen(b,c)};e.getGroupsToFillScreen=function(d,c){var b=[];this.addSkeletonRangeToList(b,d.start,d.length);var g;g=c?d.start+d.length:d.start-1;for(var a=KindleRendererFragmentLoader.getNumSkeletons();b.length<this.numberOfColumns&&g>=0&&g<a;){var f=KindleRendererFragmentLoader.getGroupInfo(g);if(b.length+f.length<=this.numberOfColumns)this.addSkeletonRangeToList(b,
g,f.length);else break;c?g+=f.length:g-=f.length}return b};e.getNeededSkeletonsForGoTo=function(d){return this.getNeededSkeletonsFrom(KindleRendererFragmentLoader.getSkeletonForPosition(d),!0)};e.getNeededSkeletonsForPageFlip=function(d){var c=this.getCurrentlyVisibleSkeletons();return d>0?(d=Math.max.apply(Math,c),d=Math.min(d+1,KindleRendererFragmentLoader.getNumSkeletons()),this.getNeededSkeletonsFrom(d,!0)):(d=Math.min.apply(Math,c),d=Math.max(d-1,0),this.getNeededSkeletonsFrom(d,!1))};e.clearCacheReservations=
function(){for(var d=this.iframeStatus.length,c=0;c<d;c++)if(this.iframeStatus[c]===this.statusType.RESERVED)this.iframeStatus[c]=this.statusType.AVAILABLE};e.getLoadedSkeletons=function(){for(var d={},c=this.contentRange.length,b=0;b<c;b++)this.contentRange[b]&&this.iframes[b].processingRequestId.id===null&&(d[this.contentRange[b].skeletonId]=b);return d};e.reserveSkeletonsInCache=function(d){this.clearCacheReservations();for(var c=this.getLoadedSkeletons(),b=[],g=0;g<d.length;g++){var a=d[g],f=
c[a];if(f===void 0)b.push(a);else if(this.iframeStatus[f]===this.statusType.AVAILABLE)this.iframeStatus[f]=this.statusType.RESERVED}return b};e.getIndicesToShow=function(d){for(var c=this.getLoadedSkeletons(),b=[],g=0;g<d.length;g++)b.push(c[d[g]]);return b};e.shouldShowSpineAfterSkeleton=function(d){var d=this.contentRange[d].skeletonId,c=KindleRendererFragmentLoader.getGroupInfo(d),b=c.start+c.length-1;return c.spine||d===b?!0:!1};e.getSpineCountForIndicies=function(d){var c=0;for(i=0;i<d.length-
1;i++)this.shouldShowSpineAfterSkeleton(d[i])&&c++;return c};e.prepareSpine=function(){var d={position:"absolute",visibility:"visible","background-color":this.spineColor,"z-index":j},c=this.getAvailableSpine();$(c).css(d);return c};e.getAvailableSpine=function(){for(i=0;i<this.spines.length;i++)if(this.spines[i].status===this.statusType.AVAILABLE)return this.spines[i];var d=document.createElement("div");this.parent.appendChild(d);d.status=this.statusType.RESERVED;this.spines.push(d);return d};e.removeAllSpines=
function(){for(i=0;i<this.spines.length;i++)$(this.spines[i]).css("visibility","hidden"),this.spines[i].status=this.statusType.AVAILABLE};e.isRTLProgression=function(){var d=KindleRendererSettings.getSettings().pageProgressionDirection;return d?d.value===d.RTL:!1};e.prepareDisplayElements=function(d,c,b){for(var g,a=[],f=0;f<d.length;f++){g=this.iframes[d[f]];var e=KindleRendererElementFitting.resize(g.contentDocument.body,c),h=Math.round((c.height-e.height)*0.5)+"px";$(g).css({top:h,height:e.height+
"px",width:e.width+"px"});a.push(g);if(f!==d.length-1&&this.shouldShowSpineAfterSkeleton(d[f])){var l=this.prepareSpine();$(l).css({top:h,height:e.height+"px",width:this.columnGap+"px"});a.push(l)}this.iframeStatus[g.index]=this.statusType.VISIBLE;this.setIframeVisibility(g,!0);b[g.index]=!1}return a};e.placeElementsHorizontally=function(d,c){var b=0,g;for(g=0;g<d.length;g++)b+=$(d[g]).width();var a,f=Math.floor((c-b)*0.5);for(g=0;g<d.length;g++)b=d[g],a=$(b).width(),$(b).css({left:this.isRTLProgression()?
c-(f+a):f}),f+=a};e.showSkeletons=function(d){var d=this.getIndicesToShow(d.sort(function(a,b){return a-b})),c=this.getCurrentlyVisibleIndices(),b={},g;for(g=0;g<c.length;g++)b[c[g]]=!0;if(d.length>0){var a=$(this.parent).height(),c=$(this.parent).width(),a={width:Math.round((c-this.columnGap*this.getSpineCountForIndicies(d))/d.length),height:a};this.removeAllSpines();this.placeElementsHorizontally(this.prepareDisplayElements(d,a,b),c)}for(g in b)if(b[g])this.iframeStatus[g]=this.statusType.AVAILABLE,
this.setIframeVisibility(this.iframes[g],!1)};e.getCurrentlyVisibleIndices=function(){for(var d=[],c=this.iframeStatus.length,b=0;b<c;b++)this.iframeStatus[b]===this.statusType.VISIBLE&&d.push(b);return d};e.getSkeletonsFromIndices=function(d){for(var c=[],b=0;b<d.length;b++){var g=this.contentRange[d[b]];g&&c.push(g.skeletonId)}return c};e.getCurrentlyVisibleSkeletons=function(){return this.getSkeletonsFromIndices(this.getCurrentlyVisibleIndices())};e.getPrioritizedPreloadList=function(d){var c=
d.slice(0);if(d.length>0)for(var b=KindleRendererFragmentLoader.getNumSkeletons(),g=this.iframes.length,a=Math.min.apply(Math,d),d=Math.max.apply(Math,d);c.length<g&&(a>0||d<b-1);){var f;for(f=0;f<this.numberOfColumns&&d<b-1&&c.length<g;f++)d++,c.push(d);for(f=0;f<this.numberOfColumns&&a>0&&c.length<g;f++)a--,c.push(a)}return c};e.getLowestPriority=function(d){for(var c=this.iframes.length,b=0,g=-1,a=0;a<c;a++){var f=this.contentRange[a];if(!f)return{iframeIndex:a,priorityRating:-Infinity};if(this.iframeStatus[a]===
this.statusType.AVAILABLE)if(f=$.inArray(f.skeletonId,d),f===-1)return{iframeIndex:a,priorityRating:-Infinity};else f>g&&(g=f,b=a)}return{iframeIndex:b,priorityRating:c-g}};e.pickSkeletonToPreload=function(d){for(var c=this.getLoadedSkeletons(),b=0;b<d.length;b++)if(c[d[b]]===void 0)return{skeletonId:d[b],priorityRating:d.length-b};return null};e.considerLoadingMoreSkeletons=function(){if(!this.currentRequest){var d=this.getPrioritizedPreloadList(this.getCurrentlyVisibleSkeletons()),c=this.pickSkeletonToPreload(d);
if(c!==null&&this.getLowestPriority(d).priorityRating<c.priorityRating)this.createNewRequest(this.loadedType.PRELOAD,null),this.currentRequest.skeletons=[c.skeletonId],this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c.skeletonId))}};e.updateSettings=function(d){if(d.columns!==void 0){if(d.columns.num!==void 0)this.numberOfColumns=d.columns.num;if(d.columns.gap!==void 0)this.columnGap=d.columns.gap;if(d.columns.spineColor!==void 0)this.spineColor=d.columns.spineColor}};e.getIframeToLoad=
function(){return this.currentRequest?this.iframes[this.getLowestPriority(this.getPrioritizedPreloadList(this.currentRequest.type===this.loadedType.PRELOAD?this.getCurrentlyVisibleSkeletons():this.currentRequest.skeletons)).iframeIndex]:null};e.getDesiredRangeForSkeleton=function(d){d=KindleRendererFragmentLoader.getSkeletonRange(d);return{focus:d.start,startPosition:d.start,endPosition:d.end}};e.frameIsLoadedAndReady=function(){var d=this.currentRequest,c=this.reserveSkeletonsInCache(d.skeletons);
c.length>0?this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c[0])):(d.type===this.loadedType.PRELOAD&&this.clearCacheReservations(),d.initialPosition!==null&&this.showSkeletons(d.skeletons),d.metrics.endTimer(),d.metrics.log(),this.currentRequest=null,setTimeout(this.currentRequestDfd.resolve,10),d.type!==this.loadedType.PAGE_FLIP&&this.considerLoadingMoreSkeletons())};e.pageFlip=function(d){var d=this.getNeededSkeletonsForPageFlip(d),c=this.reserveSkeletonsInCache(d),b=Math.max.apply(Math,
d);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(b).start;if(c.length>0)return this.createNewRequest(this.loadedType.PAGE_FLIP,null),this.currentRequest.skeletons=d,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(c[0])),!1;this.showSkeletons(d);this.considerLoadingMoreSkeletons();return!0};e.nextScreen=function(){return this.pageFlip(1)};e.previousScreen=function(){return this.pageFlip(-1)};e.gotoPosition=function(d,c){var b=this.getNeededSkeletonsForGoTo(d),g=this.reserveSkeletonsInCache(b);
if(c){var a=Math.max.apply(Math,b);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(a).start}if(g.length>0)return this.createNewRequest(this.loadedType.GOTO,d),this.currentRequest.skeletons=b,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(g[0])),!1;this.clearCacheReservations();this.showSkeletons(b);return!0};e.getPagePositionRange=function(){var d=this.getCurrentlyVisibleIndices();if(d.length===0)return null;for(var c=Infinity,b=-Infinity,g=0;g<d.length;g++)var a=this.contentRange[d[g]],
c=Math.min(c,a.startPosition),b=Math.max(b,a.endPosition);return{currentTopOfPage:c,currentBottomOfPage:b}};e.getCurrentPosition=function(){return this.currentPosition};e.cleanup=function(){this.cancelCurrentRequest();for(var d=0;d<this.iframes.length;d++)KindleRendererIframeLoading.cleanupIframe(this.iframes[d]),KindlePaginator.cleanupIframe(this.iframes[d]),this.contentRange[d]=null,this.positionData[d]=null;this.iframes=null};e.hasNextScreen=function(){for(var d=this.getCurrentlyVisibleSkeletons(),
c=KindleRendererFragmentLoader.getNumSkeletons()-1,b=0;b<d.length;b++)if(d[b]===c)return!1;return!0};e.hasPreviousScreen=function(){for(var d=this.getCurrentlyVisibleSkeletons(),c=0;c<d.length;c++)if(d[c]===0)return!1;return!0};e.getSortedVisibleIndicies=function(){for(var d,c=[],b=this.getCurrentlyVisibleIndices(),g=0;g<b.length;g++){d=b[g];var a=this.contentRange[d].skeletonId;KindleRendererFragmentLoader.isBlankPage(a)||c.push([a,d])}c.sort(function(a,b){return a[0]-b[0]});d=[];for(g=0;g<c.length;g++)d.push(c[g][1]);
return d};e.getContentRects=function(){for(var d=this.getSortedVisibleIndicies(),c=[],b=0;b<d.length;b++){var g=d[b],a=this.iframes[g],g=this.getIframeOrigin(g);c.push(this.getBoundsWithOffset(a.contentDocument.body,g))}return c};e.getZoomableAt=function(d,c,b){for(var g=this.getCurrentlyVisibleIndices(),a=0;a<g.length;a++){var f=g[a],e=$(this.iframes[f]),e={x:d.x+parseInt(e.css("left"),10),y:d.y+parseInt(e.css("top"),10)};if(f=KindleRendererZoomablesFactory.buildFromCoord(this.iframes[f].contentDocument,
e,c,b))return f}return null};e.getZoomableList=function(d){for(var c=[],b=this.getSortedVisibleIndicies(),g=0;g<b.length;g++)var a=b[g],f=$(this.iframes[a]),f={x:d.x+parseInt(f.css("left"),10),y:d.y+parseInt(f.css("top"),10)},c=c.concat(KindleRendererZoomablesFactory.buildList(this.iframes[a].contentDocument,f));return c};e.getSelectableItemBoundaries=function(){return{}};e.getComputedRectsDfd=function(){return null};e.getWordPositions=function(){return null};e.show=function(){this.showContent=!0;
for(var d=this.getCurrentlyVisibleIndices(),c=0;c<d.length;c++)this.setIframeVisibility(this.iframes[d[c]],!0)};e.hide=function(){this.showContent=!1;for(var d=this.getCurrentlyVisibleIndices(),c=0;c<d.length;c++)this.setIframeVisibility(this.iframes[d[c]],!1)};e.handleClick=function(d,c){for(var b=this.getCurrentlyVisibleIndices(),g,a=0;a<b.length;a++){var f=this.iframes[b[a]],e=f.offsetLeft,h=f.offsetTop,l=f.offsetHeight,j=f.offsetWidth;if(d>=e&&d<=e+j&&c>=h&&c<=h+l){g=f;break}}return g?(d-=parseInt(g.offsetLeft,
10),c-=parseInt(g.offsetTop,10),b=KindleRendererUtils.elementFromPoint(g.contentDocument,d,c),KindleRendererEventHandler.handleClick(g.contentDocument,b,{x:d,y:c})):!1};e.resizeNotification=function(){this.reloadNotification()};e.reloadNotification=function(){this.showSkeletons(this.getCurrentlyVisibleSkeletons())};e.reloadAnnotations=function(){};e.updateGlyphColor=function(){};e.setAnnotationEventCallback=function(){};e.setOverlayManager=function(){};e.copyIframeData=function(){}}var j=-1;return{build:function(e,
d){e.loadedType={PRELOAD:0,GOTO:1,PAGE_FLIP:2};e.statusType={AVAILABLE:0,RESERVED:1,VISIBLE:2};e.iframes=[];e.iframeStatus=[];e.contentRange=[];e.positionData=[];e.parent=d;for(var c=0;c<6;c+=1)e.iframes[c]=e.createIframe($(d).width(),d.name,c),e.iframeStatus[c]=e.statusType.AVAILABLE,e.contentRange[c]=null,e.positionData[c]=null,d.appendChild(e.iframes[c]);e.currentPosition=0;e.showContent=!0;e.numberOfColumns=1;e.columnGap=20;e.spineColor="transparent";e.spines=[];h(e)}}}(),KindleRendererIframeManagerReflowFactory=
function(){function h(d){d.getIframeToLoad=function(){return this.iframes[this.hiddenIframeIndex]};d.annotationClickedHandler=function(c){if(this.annotationEventCallback!==void 0){var b=c.currentTarget.parentNode,c=b.getAttribute("annotationType"),b=b.getAttribute("annotationStart");this.annotationEventCallback(c,b)}};d.renderAnnotations=function(c,b){var d=c.contentDocument.getElementById(e);d!==null&&d.parentNode.removeChild(d);if(this.overlayManager&&(d=this.overlayManager.getOverlaysInRange(b.startPosition,
b.endPosition))&&d.length>0)this.createAnnotationElements(c,d),c.writingMode.forceRepaint(c)};d.frameIsLoadedAndReady=function(c){var b=this,d=b.currentRequest;b.iframeLoadStatus[c.index]=d.type;var a=b.contentRange[c.index];b.renderAnnotations(c,a);var f=this.isStartOfSkeletonLoaded(c.index);d.initialPosition!==null?KindlePaginator.scrollToPosition(c,d.initialPosition,f):KindlePaginator.scrollToTop(c,f);if(!KindlePaginator.isIframePaginationValid(c)){if(b.canRetryCurrentRequest()){b.willRetryCurrentRequest();
b.resizeWithoutReload(c.index);return}KindlePaginator.clearIframePaginationValidation(c)}if(!KindlePaginator.hasNextScreen(c)&&!KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(a.skeletonId,a.endPosition))if(a=a.endPosition-a.startPosition,a<0)b.currentRequestDfd.reject(DATA_LOAD_ERROR);else{KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a+1);var e=d.initialPosition;if(e===null)e=KindlePaginator.getCurrentPagePositionRange(c).currentTopOfPage;setTimeout(function(){b.reloadHiddenFrame(e)},
0)}else d.initialPosition!==null&&c===b.iframes[b.hiddenIframeIndex]&&(b.swapIframes(),this.updateDisplayedPositionsInPage()),d.metrics.endTimer(),d.metrics.log(),b.currentRequest=null,setTimeout(b.currentRequestDfd.resolve,10),c.computingRectsId.id=d.requestId,b.computedRectsDfd[c.index]=b.computeRectsInIframe(b.iframes[c.index],d.requestId),b.computedRectsDfd[c.index].then(function(){b.computedRectsDfd[c.index]=null;c.computingRectsId.id=null;!b.currentRequest&&d.type===b.loadedType.GOTO_POSITION&&
b.considerLoadingMoreFragments();b=null},function(){b=null})};d.reloadHiddenFrame=function(c){this.loadFragmentsForRange(KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(c))};d.gotoPosition=function(c){$(this.iframes[this.visibleIframeIndex].contentDocument.body).find("#"+j).empty();this.createNewRequest(this.loadedType.GOTO_POSITION,c);c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(c);KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],
c)?this.loadFragmentsForRange(c):this.resizeWithoutReload(this.visibleIframeIndex);return!1};d.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var c=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;
this.hiddenIframeIndex=c;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0);this.setIframeVisibility(this.iframes[this.hiddenIframeIndex],!1);this.iframes[this.hiddenIframeIndex].writingMode.resetHeight(this.iframes[this.hiddenIframeIndex])};d.getPagePositionRange=function(){var c=this.contentRange[this.visibleIframeIndex];if(c===null)return null;var b=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);if(b.currentTopOfPage===null||b.currentBottomOfPage===
null)b.currentTopOfPage=c.startPosition,b.currentBottomOfPage=c.endPosition;return b};d.getCurrentPosition=function(){var c=this.getPagePositionRange();return c?c.currentTopOfPage:null};d.getSelectableItemBoundaries=function(){return KindlePaginator.getSelectableItemBoundariesForCurrentScreen(this.iframes[this.visibleIframeIndex])};d.computeRectsInIframe=function(c,b){var d=KindleMetricsProfiler("rects-computation"),a=KindleRendererFragmentLoader.getBookContentType();return c.screenManager.wordMapGenerator.computeWordRects(c.contentDocument,
c.screenManager.wordMap,c.screenManager.wordMapKeys,c.writingMode,a,b,c.computingRectsId,d)};d.getComputedRectsDfd=function(){return this.computedRectsDfd[this.visibleIframeIndex]};d.getWordPositions=function(){return KindlePaginator.getWordPositionsForCurrentScreen(this.iframes[this.visibleIframeIndex])};d.causeReflowEventInBrowser=function(){var c=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("html")[0],b=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("body")[0];
c.removeChild(b);c.appendChild(b)};d.causeReflowEventInBrowserIfNeeded=function(){if(KindleRendererDeviceSpecific.needsReflowOnPageFlip()){var c=this;setTimeout(function(){c.causeReflowEventInBrowser()},KindleRendererDeviceSpecific.drawYieldUpdateTime())}};d.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&
this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};d.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var c=this.contentRange[this.visibleIframeIndex].endPosition+1,b=this.getPagePositionRange(),c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(c,b);this.createNewRequest(this.loadedType.NEXT,
null);this.loadFragmentsForRange(c)}};d.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.PREVIOUS)){var c=this.contentRange[this.visibleIframeIndex].startPosition-1,b=this.getPagePositionRange(),c=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(c,b);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(c)}};d.considerLoadingMoreFragments=
function(c){if(this.canPreloadNext){var b=c!==this.direction.PREVIOUS?4:2;if(KindlePaginator.getApproximateNumNextScreens(this.iframes[this.visibleIframeIndex])<b&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&(c=c===this.direction.PREVIOUS?4:2,KindlePaginator.getApproximateNumPreviousScreens(this.iframes[this.visibleIframeIndex])<c&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};d.handleClick=function(c,b){var d=KindleRendererUtils.elementFromPoint(this.iframes[this.visibleIframeIndex].contentDocument,
c,b);return KindleRendererEventHandler.handleClick(this.iframes[this.visibleIframeIndex].contentDocument,d,{x:c,y:b})};d.crossSkeletonBoundary=function(){var c=this.contentRange[this.visibleIframeIndex],b=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(c.skeletonId+1===b.skeletonId)return KindlePaginator.scrollToTop(this.iframes[this.hiddenIframeIndex],!0),this.swapIframes(),!0;else if(c.skeletonId!==b.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=
this.loadedType.EMPTY,!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(c.skeletonId-1===b.skeletonId)return c=this.hiddenIframeIndex,KindlePaginator.scrollToBottom(this.iframes[c],this.isStartOfSkeletonLoaded(c)),this.swapIframes(),!0;else if(c.skeletonId!==b.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};d.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);
KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=[null,null];this.positionData=[null,null];this.iframes=null};d.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};d.hasMorePreviousFragments=
function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};d.isAtEndOfDocumentOrSkeleton=function(){var c=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(c.skeletonId,c.endPosition)};d.isAtBeginningOfDocumentOrSkeleton=function(){var c=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(c.skeletonId,
c.startPosition)};d.isStartOfSkeletonLoaded=function(c){c=this.contentRange[c];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(c.skeletonId,c.startPosition)};d.needToWaitForLoadToShowNextPage=function(){return!KindlePaginator.isNextFullScreen(this.iframes[this.visibleIframeIndex])&&this.hasMoreNextFragments()};d.needToWaitForLoadToShowPreviousPage=function(){var c=this.visibleIframeIndex;return!KindlePaginator.isPreviousFullScreen(this.iframes[c],this.isStartOfSkeletonLoaded(c))&&
this.hasMorePreviousFragments()};d.hasNextScreen=function(){return KindlePaginator.hasNextScreen(this.iframes[this.visibleIframeIndex])||this.hasMoreNextFragments()};d.hasPreviousScreen=function(){return KindlePaginator.hasPreviousScreen(this.iframes[this.visibleIframeIndex])||this.hasMorePreviousFragments()};d.updateDisplayedPositionsInPage=function(){var c=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(c.currentBottomOfPage-
c.currentTopOfPage)};d.considerFlippingFrames=function(){var c=this.iframeLoadStatus[this.hiddenIframeIndex],b=this.currentRequest!==null&&this.currentRequest.type===c;if(c!==this.loadedType.EMPTY&&!b){var b=this.getPagePositionRange(),d=this.contentRange[this.hiddenIframeIndex],a=0,f=0;c===this.loadedType.NEXT?f=1:a=1;if(b.currentTopOfPage>=d.startPosition+a&&b.currentBottomOfPage<=d.endPosition-f)if(KindlePaginator.matchFrames(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex]),
c=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.hiddenIframeIndex]),c.currentTopOfPage===b.currentTopOfPage&&c.currentBottomOfPage===b.currentBottomOfPage)return this.swapIframes(),!0;else if(this.needToWaitForLoadToShowNextPage()||this.needToWaitForLoadToShowPreviousPage())throw"Pagination Error";}return!1};d.nextScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);
var c=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;if(c&&this.considerFlippingFrames()===void 0)return!0;var b=this.isAtEndOfDocumentOrSkeleton(),d=KindlePaginator.nextScreen(this.iframes[this.visibleIframeIndex],b);if(!d)if(this.hasMoreNextFragments())if(c&&b&&this.crossSkeletonBoundary())d=!0;else return c=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(this.contentRange[this.visibleIframeIndex].endPosition-c.currentBottomOfPage),
this.loadNextPages(),!1;else KindlePaginator.showEndOfDocument(this.iframes[this.visibleIframeIndex]),d=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return d};d.previousScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);var c=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS;
if(c&&this.considerFlippingFrames()===void 0)return!0;var b=this.visibleIframeIndex,d=this.isAtBeginningOfDocumentOrSkeleton(),b=KindlePaginator.previousScreen(this.iframes[b],d,this.isStartOfSkeletonLoaded(b));if(!b&&this.hasMorePreviousFragments())if(c&&d&&this.crossSkeletonBoundary())b=!0;else return c=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(c.currentTopOfPage-this.contentRange[this.visibleIframeIndex].startPosition),this.loadPreviousPages(),
!1;this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return b};d.cancelHiddenIframeLoading=function(){var c=this.iframes[this.hiddenIframeIndex];if(c.processingRequestId.id!==null)c.processingRequestId.id=null,this.cancelCurrentRequest();c.computingRectsId.id=null};d.doGuardedAsyncCopyOf=function(c,b,d){var a=this;b.processingRequestId.id=a.currentRequest.requestId;KindleRendererIframeLoading.copyIframeContents(a.currentRequest,
c,b).done(function(c){if(b.processingRequestId.id===c.requestId&&a.currentRequest&&a.currentRequest.requestId===c.requestId)a.addClickHandlers(b),b.processingRequestId.id=null,d()})};d.copyIframeDataOf=function(c){var b=this;b.cancelHiddenIframeLoading();b.createNewRequest(b.loadedType.GOTO_POSITION,null);b.doGuardedAsyncCopyOf(c.iframes[c.visibleIframeIndex],b.iframes[b.visibleIframeIndex],function(){b.contentRange[b.visibleIframeIndex]=jQuery.extend({},c.contentRange[c.visibleIframeIndex]);b.positionData[b.visibleIframeIndex]=
jQuery.extend({},c.positionData[c.visibleIframeIndex]);var d=b.iframes[b.hiddenIframeIndex],a=c.iframes[c.hiddenIframeIndex];c.iframeLoadStatus[c.hiddenIframeIndex]!==c.loadedType.EMPTY&&a.processingRequestId.id===null?b.doGuardedAsyncCopyOf(a,d,function(){b.contentRange[b.hiddenIframeIndex]=jQuery.extend({},c.contentRange[c.hiddenIframeIndex]);b.positionData[b.hiddenIframeIndex]=jQuery.extend({},c.positionData[c.hiddenIframeIndex]);b.iframeLoadStatus[b.visibleIframeIndex]=c.iframeLoadStatus[c.visibleIframeIndex];
b.iframeLoadStatus[b.hiddenIframeIndex]=c.iframeLoadStatus[c.hiddenIframeIndex];b.currentRequestDfd.resolve()}):(b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY],b.currentRequestDfd.resolve())});return b.currentRequestDfd.isResolved()};d.recreateFrame=function(c){var b=this.iframes[c],d=b.writingMode.width(b),a=b.parentNode,f=b.pageOverflowDiv;a.removeChild(b);b=this.createIframe(d,this.parentName,b.index);b.pageOverflowDiv=f;a.appendChild(b);a.appendChild(f);this.iframes[c]=b};d.copyIframeData=
function(c){if(!(this.contentRange[this.visibleIframeIndex]===null||c.contentRange[c.visibleIframeIndex]===null?this.contentRange[this.visibleIframeIndex]===c.contentRange[c.visibleIframeIndex]:this.contentRange[this.visibleIframeIndex].startPosition===c.contentRange[c.visibleIframeIndex].startPosition&&this.contentRange[this.visibleIframeIndex].endPosition===c.contentRange[c.visibleIframeIndex].endPosition))return KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&(this.recreateFrame(0),this.recreateFrame(1),
this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)),this.copyIframeDataOf(c);var b=this.iframes[this.visibleIframeIndex],c=c.iframes[c.visibleIframeIndex];b.currentTopOfScreen=c.currentTopOfScreen;b.currentBottomOfScreen=c.currentBottomOfScreen;return!0};d.updateSettingsInIframe=function(c){if(c&&c.contentDocument){var b=c.contentDocument.getElementById(j);b&&c.contentDocument.body.removeChild(b);KindleRendererIframeLoading.updateSettingsInIframe(c);b&&c.contentDocument.body.appendChild(b)}};
d.updateSettings=function(){var c=KindleRendererSettings.getSettings().backgroundColor;$(this.iframes[this.visibleIframeIndex].pageOverflowDiv).css({"background-color":c});$(this.iframes[this.hiddenIframeIndex].pageOverflowDiv).css({"background-color":c});this.updateSettingsInIframe(this.iframes[this.visibleIframeIndex]);this.updateSettingsInIframe(this.iframes[this.hiddenIframeIndex])};d.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.resizeNotification()};
d.resizeNotification=function(){this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY];var c=this.iframes[this.visibleIframeIndex];c.writingMode.resetIframeDimensions(c);c=this.iframes[this.hiddenIframeIndex];c.writingMode.resetIframeDimensions(c)};d.updateGlyphColorForFrameIndex=function(c){this.iframes[c].hasGlyphs&&this.iframes[c].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[c])};d.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);
this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};d.setAnnotationEventCallback=function(c){this.annotationEventCallback=c};d.getContentRects=function(){var c=this.iframes[this.visibleIframeIndex],b=this.getIframeOrigin(this.visibleIframeIndex),c={left:b.x,top:b.y,width:$(c).width(),height:$(c).height()};c.right=c.left+c.width;c.bottom=c.top+c.height;return[c]};d.getZoomableAt=function(c,b,d){var a=this.iframes[this.visibleIframeIndex];return!KindlePaginator.isPointOnVisiblePage(a,b-c.x,
d-c.y)?null:KindleRendererZoomablesFactory.buildFromCoord(a.contentDocument,c,b,d)};d.getZoomableList=function(c){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,c)};d.addClickHandlers=function(c){var b=this,c=c.contentDocument.getElementById(e),c=$(c).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();$(c).unbind("click");$(c).click(function(c){b.annotationClickedHandler(c)})};d.createAnnotationElements=
function(c,b){if(c.contentDocument.getElementsByTagName("body")[0]){var d=KindlePaginator.getWordMap(c),a=c.contentDocument.createDocumentFragment();KindleRendererAnnotationRenderer.createAnnotationElements(c,d,c.screenManager.wordMapGenerator,b,a);d=c.contentDocument.getElementById(e);if(!d){var f=c.contentDocument.getElementById(j),d=c.contentDocument.createElement("DIV");d.id=e;d.setAttribute("class","kindle-annotation-wrapper");f.appendChild(d)}d.appendChild(a);this.addClickHandlers(c)}};d.addAnnotation=
function(c,b,d){c&&b&&d&&b.startPosition<=d.end&&d.start<=b.endPosition&&(this.createAnnotationElements(c,[d]),c.writingMode.forceRepaint(c))};d.removeAnnotation=function(c,b){if(c&&b){var d=c.contentDocument.getElementById(e);d&&(KindleRendererAnnotationRenderer.removeAnnotationElements(d,b),c.writingMode.forceRepaint(c))}};d.onOverlayAdded=function(c){d.addAnnotation(d.iframes[0],d.contentRange[0],c.overlay);d.addAnnotation(d.iframes[1],d.contentRange[1],c.overlay)};d.onOverlayRemoved=function(c){d.removeAnnotation(d.iframes[0],
c.overlay);d.removeAnnotation(d.iframes[1],c.overlay)};d.setOverlayManager=function(c){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=c)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,
this.onOverlayRemoved)};d.show=function(){this.showContent=!0;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)};d.hide=function(){this.showContent=!1;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!1)};d.drawWordMap=function(){var c=this.iframes[this.visibleIframeIndex];drawWordMap(c,c.screenManager,c.contentDocument.body)};d.drawHeightMaps=function(){drawHeightMaps(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex])}}var j="content-overlays",
e="annotation-section";return{build:function(d,c){for(var b=[],g=0;g<2;g+=1){b[g]=d.createIframe($(c).width(),c.name,g);c.appendChild(b[g]);var a=b[g],f=c,e=g,m=document.createElement("div");m.setAttribute("id",f.name+"_page_overflow_"+e);$(m).css({position:"absolute",visibility:"hidden","z-index":1});f.appendChild(m);a.pageOverflowDiv=m}d.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};d.direction={NEXT:2,PREVIOUS:3};d.iframes=b;d.parentName=c.name;d.iframeLoadStatus=[d.loadedType.EMPTY,d.loadedType.EMPTY];
d.contentRange=[null,null];d.positionData=[null,null];d.computedRectsDfd=[null,null];d.visibleIframeIndex=0;d.hiddenIframeIndex=1;d.overlayManager=null;h(d)}}}(),KindleRendererIframePreparation=function(){function h(c,b,d,a){KindleRendererSettings.useCSSRegions()?a.resolve(b):KindleRendererContentReflow.reflow(c,b,d).then(function(){a.resolve(b)},function(){a.reject(b,"reflow took too long")})}function j(c,b,g,a,f,k){f!==d&&KindleRendererCanvasInsertion.changeSpanToCanvas(c.id,c.contentDocument,g.contentRange,
f===e);c.hasGlyphs=a.glyphData!==void 0&&g.glyphData!==void 0;c.hasGlyphs?KindleGlyphRenderer.renderAllContent(c,b,a.glyphData,g.glyphData).then(function(){h(c,b,a.positionData,k)},function(){k.reject(b,"glyph rendering took too long")}):(a.glyphData=null,h(c,b,a.positionData,k))}var e=-1,d=0;return{CANVAS_INSERTION_PREVIOUS:e,CANVAS_INSERTION_NONE:d,CANVAS_INSERTION_NEXT:1,prepareIframe:function(c,b,d,a,f){var e=new jQuery.Deferred;if(c.processingRequestId.id===b.requestId){var h=c.contentDocument.getElementById("content-overlays");
if(!h)h=c.contentDocument.createElement("DIV"),h.id="content-overlays",c.contentDocument.body.appendChild(h);j(c,b,d,a,f,e)}else e.reject();return e.promise()}}}(),KindleRendererColumnManager=function(){function h(){for(var a=0;a<x;a++)v[a].hide()}function j(a){if(D||K){if(a<=y)throw{name:"pagingError",message:"Repeating wait request"};y=a;w<0&&(z.waitNotification&&z.waitNotification(),x>=KindleRendererDeviceSpecific.minColumnsToHide()&&(K=!0,h()));w=a}}function e(a){if((D||K)&&w>=0&&w<=a){H=0;w=
-1;if(K||x>=KindleRendererDeviceSpecific.minColumnsToHide()){for(a=0;a<x;a++)v[a].show();D=!0;K=!1}z.readyNotification&&z.readyNotification()}}function d(){w===-1&&c(0)}function c(a){if(a<x){var b=v[a].getComputedRectsDfd();b?(z.rectsWaitNofification&&z.rectsWaitNofification(),b.then(function(){c(a+1)},function(a){z.rectsErrorNotification&&z.rectsErrorNotification(a)})):c(a+1)}else z.rectsReadyNotification&&z.rectsReadyNotification()}function b(a){return a>x*J?(z.errorNotification&&z.errorNotification("Irrecoverable Error"),
!0):!1}function g(a,b,c){w<=a&&(b!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&H<M?(++H,t(),n(c)):(z.errorNotification&&z.errorNotification(b),w=-1))}function a(c,f){try{if(b(f))return!1;if(v[c].copyIframeData(v[c===0?x-1:c-1])){var h=v[c].nextScreen(),k=c+1;if(h){if(k<x)return a(k,f+1);d();return!0}}var m=v[c].getCurrentProcessId();j(m);v[c].getCurrentProcessDfd().then(function(){a(c,f+1)&&(e(m),d())},function(a){g(m,a,f)})}catch(l){n(f)}return!1}function f(c,h){try{if(b(h))return!1;var m=
v[c===x-1?0:c+1];if(!m.hasPreviousScreen())return k(0,h),!1;if(v[c].copyIframeData(m)){var l=v[c].previousScreen(),m=c-1;if(l)return m>=0?f(m,h+1):a(1,h)}var q=v[c].getCurrentProcessId();j(q);v[c].getCurrentProcessDfd().then(function(){f(c,h+1)&&(e(q),d())},function(a){g(q,a,h)})}catch(o){n(h)}return!1}function k(b,c,f){var h;v[0].gotoPosition(b,f)?(h=KindleRendererRequestId.getUniqueRequestId(),j(h),e(h),d()):(h=v[0].getCurrentProcessId(),j(h),b=v[0].getCurrentProcessDfd(),x===1?b.then(function(){e(h);
d()},function(a){g(h,a,c)}):b.then(function(){a(1)&&(e(h),d())},function(a){g(h,a,c)}));return!1}function m(){try{if(x===1){var b=v[0].nextScreen();if(b)d();else{var c=v[0].getCurrentProcessId();j(c);v[0].getCurrentProcessDfd().then(function(){m();e(c);d()},function(a){g(c,a,0)})}return b}else return a(0,0)}catch(f){return n(0),!1}}function l(){try{if(x===1){var a=v[0].previousScreen();if(a)d();else{var b=v[0].getCurrentProcessId();j(b);v[0].getCurrentProcessDfd().then(function(){l();e(b);d()},function(a){g(b,
a,0)})}return a}else return f(x-1,0)}catch(c){return n(0),!1}}function o(a){for(;a<x;a++)v[a].reloadNotification()}function q(){var a=v[0].getCurrentPosition();a!==null&&(I=a)}function n(a){q();o(0);k(I,a)}function r(a){if(G&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");if(!b)b=document.createElement("div"),b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),G.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),
bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,bottom:0,left:0,right:0}}function s(){var a=KindleRendererSettings.getSettings().inlineBaseDirection,b=a&&a.value===a.VERTICAL,a=r(F),c,d;b?(a={top:a.left,right:a.bottom,bottom:a.right,left:a.top},c=$(G).height(),d=$(G).width()):(c=$(G).width(),d=$(G).height());return{margins:a,parentWidth:c,parentHeight:d,getStyle:function(a){return b?{top:a.left,left:a.top,width:a.height,height:a.width}:
a}}}function t(){x=Math.max(x,1);for(var a=s(),b=a.parentHeight,c=a.margins,d=A-(c.left+c.right),f=parseInt((a.parentWidth-d*(x-1))/x,10),g=c.top,b=b-c.top-c.bottom,c=0;c<x;c++){if(B[c]===void 0)B[c]=document.createElement("div"),B[c].name="column_"+c,$(B[c]).css("position","absolute"),G.appendChild(B[c]);var e=a.getStyle({top:g,left:c*(f+d),height:b,width:f});e.display="";$(B[c]).css(e);v[c]===void 0&&(v[c]=KindleRendererIframeManagerFactory.build(B[c]),v[c].setAnnotationEventCallback(z.annotationTriggered),
v[c].setOverlayManager(L));v[c].setCanPreloadPrevious(c===0);v[c].setCanPreloadNext(c===x-1)}for(c=x;c<B.length;c++)$(B[c]).hide();D||h()}function u(a){a=$(B[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}}var z={},w=-1,y=-1,G=null,F=0,A=20,x=0,B=[],v=[],I=0,L,D=!0,K=!1,M=3,H=0,J=20;return{initialize:function(a,b,c,d){G=a;z=b;L=c;d>0&&(I=d);t()},cleanup:function(){for(var a=0;a<v.length;a++)v[a].cleanup()},hide:function(){h();K=D=!1},show:function(){K=!0},updateSettings:function(a){if(a.columns!==
void 0)if(KindleRendererSettings.getSettings().fixedContent)x=1,A=0;else{if(a.columns.num!==void 0)x=a.columns.num;a.columns.gap!==void 0&&(A=parseInt(a.columns.gap,10))}if(a.margin!==void 0)F=a.margin;if(G!==null){t();for(var b=a.fontSizes!==void 0||a.lineSpacingMultiplier!==void 0||a.fontSizeUnits!==void 0||a.fontFamily!==void 0||a.margin!==void 0||a.columns!==void 0||a.textAlign!==void 0,c=0;c<x;c++)v[c].updateSettings(a),!b&&a.fontColor!==void 0&&v[0].updateGlyphColor();b&&(D?n(0):o(0))}},gotoPosition:function(a,
b){return k(a,0,b)},nextScreen:function(){return m()},previousScreen:function(){return l()},hasNextScreen:function(){return v[x-1].hasNextScreen()},hasPreviousScreen:function(){return v[0].hasPreviousScreen()},getPagePositionRange:function(){var a;a=v[0].getPagePositionRange();if(x!==1){var b=v[x-1].getPagePositionRange();a={currentTopOfPage:a.currentTopOfPage,currentBottomOfPage:b.currentBottomOfPage}}return a},getSelectableItemBoundaries:function(){for(var a={},b=0;b<x;b++){var c=$(B[b]),d=parseFloat(c.css("top")),
c=parseFloat(c.css("left")),f=v[b].getSelectableItemBoundaries(),g;for(g in f){a[g]=[];for(var e=f[g],h=0;h<e.length;h++)a[g].push({top:e[h].top+d,bottom:e[h].bottom+d,left:e[h].left+c,right:e[h].right+c})}}return a},getWordPositions:function(){for(var a=[],b=0;b<x;b++){var c=v[b].getWordPositions();c&&(a=a.concat(c))}return a.length?a:null},onWindowResize:function(){t();q();v[0].resizeNotification();o(1);k(I,0)},handleClick:function(a,b){for(var c=0;c<x;c++){var d=$(B[c]),f=a-parseInt(d.css("left"),
10),d=b-parseInt(d.css("top"),10);if(v[c].handleClick(f,d))return!0}return!1},reloadAnnotations:function(){for(var a=0;a<x;a++)v[a].reloadAnnotations()},getContentRects:function(){for(var a=[],b=0;b<x;b++){for(var c=v[b].getContentRects(),d=u(b),f=0;f<c.length;f++)c[f].left+=d.x,c[f].right+=d.x,c[f].top+=d.y,c[f].bottom+=d.y;a=a.concat(c)}return a},getZoomableAt:function(a,b){for(var c=0;c<x;c++){var d=u(c);if(d=v[c].getZoomableAt(d,a,b))return d}return null},getZoomableList:function(){for(var a=
[],b=0;b<x;b++)var c=u(b),c=v[b].getZoomableList(c),a=a.concat(c);return a}}}(),KindleRendererContentDisplay=function(){function h(a){b=document.createElement("DIV");$(b).css({position:"absolute",top:0,left:0});a.appendChild(b);g=document.createElement("DIV");var c=$(g);c.css({position:"absolute",top:0,left:0});KindleRendererSettings.useCSSRegions()&&c.css({height:"100%",width:"100%"});a.appendChild(g);j()}function j(){if(!KindleRendererSettings.useCSSRegions()){if(b){var a=$(b.parentNode);$(b).css({width:a.width(),
height:a.height()})}g&&(jContentDivParentNode=$(g.parentNode),$(g).css({width:jContentDivParentNode.width(),height:jContentDivParentNode.height()}))}}function e(a){c!==a&&(c.hide(),c=a,c.show())}var d=null,c,b=null,g=null,a=!1;return{initialize:function(f,e,m,l,j){var q=new jQuery.Deferred;c=d=KindleRendererSettings.useCSSRegions()?KindleRegionContentManager:KindleRendererColumnManager;h(f);KindleRendererCover.initialize(b,e,m);d.initialize(g,e,l,j);KindleRendererContentReflow.initialize();m.hasCover(function(b){a=
b;q.resolve()},q.resolve);return q.promise()},cleanup:function(){KindleRendererCover.cleanup();d.cleanup();g=b=c=null},updateSettings:function(a){d&&(j(),d.updateSettings(a))},gotoPosition:function(b,c){b=parseInt(b,10);b=Math.max(b,0);a&&b===0?(e(KindleRendererCover),KindleRendererCover.showCover()):(e(d),b=Math.min(b,KindleRendererFragmentLoader.getMaximumPosition()));return d.gotoPosition(b,c)},nextScreen:function(){if(c===KindleRendererCover)return e(d),d.gotoPosition(0);else if(c.hasNextScreen())return c.nextScreen();
return!0},previousScreen:function(){if(c===d)if(c.hasPreviousScreen())return c.previousScreen();else a&&(e(KindleRendererCover),KindleRendererCover.showCover());return!0},hasNextScreen:function(){return c.hasNextScreen()},hasPreviousScreen:function(){return a?c!==KindleRendererCover:c.hasPreviousScreen()},getPagePositionRange:function(){return c.getPagePositionRange()},getSelectableItemBoundaries:function(){return c.getSelectableItemBoundaries()},getWordPositions:function(){return c.getWordPositions()},
onWindowResize:function(){j();KindleRendererCover.onWindowResize();d.onWindowResize()},handleClick:function(a,b){return c.handleClick(a,b)},reloadAnnotations:function(){c.reloadAnnotations()},getContentRects:function(){return c.getContentRects()},getZoomableAt:function(a,b){return c.getZoomableAt(a,b)},getZoomableList:function(){return c.getZoomableList()},clearSelection:function(){d.clearSelection&&d.clearSelection()},getSelection:function(){if(d.getSelection)return d.getSelection()}}}(),KindleRendererCover=
function(){function h(a){function d(){++r;r===h&&(j(b),e(b))}var f=a.split("resources")[0],g=KindleRendererImageRenderer.getCoverImageSlices();if(k=g!==void 0&&g!==null){b=c.ownerDocument.createElement("DIV");for(var a=$(b),h=g.length,r=0,s=0,t=0,u=0;u<h;u++)s=c.ownerDocument.createElement("IMG"),$(s).width(g[u].width),$(s).height(g[u].height),s.onload=d,s.src=f+g[u].name,$(s).appendTo(a),t+=g[u].height;s=g[0].width;$(b).width(s);$(b).height(t);$(b).css("visibility","hidden")}else b=c.ownerDocument.createElement("IMG"),
b.src=a,$(b).css("visibility","hidden"),b.onload=function(){j(this);e(this)};c.appendChild(b)}function j(a){if(!(a===null||a===void 0)){var b=$(a),d=$(b.parent()),f=d.width(),g=d.height();b.css("visiblity","hidden");var e=1,d=a.offsetWidth,h=a.offsetHeight;d>0&&h>0?(b.attr("nativeWidth")===void 0&&b.attr("nativeWidth",d),b.attr("nativeHeight")===void 0&&b.attr("nativeHeight",h)):(d=b.attr("nativeWidth")||f,h=b.attr("nativeHeight")||g);e=Math.min(f/d,g/h);d*=e;e*=h;f=Math.round((f-d)*0.5);g=Math.round((g-
e)*0.5);k?(b=c.ownerDocument.createElement("IMG"),$(b).css({width:d+"px",height:e+"px",position:"absolute",left:f+"px",top:g+"px"}),KindleRendererImageRenderer.scaleImageSlices(b,a,!1),$(b).remove()):b.css({height:e+"px",width:d+"px",position:"absolute",left:f+"px",top:g+"px"});$(a).css("visibility","visible")}}function e(){f=!0;g.readyNotification&&g.readyNotification();g.rectsReadyNotification&&g.rectsReadyNotification()}function d(a){g.errorNotification&&g.errorNotification(a)}var c=null,b=null,
g=null,a=null,f=!1,k=!1;return{initialize:function(b,d,f){c=b;g=d;a=f},cleanup:function(){a=g=b=c=null;k=f=!1},hide:function(){$(c).hide()},show:function(){$(c).show()},showCover:function(){f?(g.readyNotification&&g.readyNotification(),g.rectsReadyNotification&&g.rectsReadyNotification()):(g.waitNotification&&g.waitNotification(),a.getCoverUrl(h,d))},nextScreen:function(){return!0},previousScreen:function(){return!0},hasNextScreen:function(){return!0},hasPreviousScreen:function(){return!1},getPagePositionRange:function(){return{currentTopOfPage:0,
currentBottomOfPage:0}},getSelectableItemBoundaries:function(){var a={};if(b&&b.getBoundingClientRect){var c=b.getBoundingClientRect();c&&(a[0]=[{left:c.left,top:c.top,right:c.right,bottom:c.bottom}])}return a},getWordPositions:function(){return null},onWindowResize:function(){j(b)},handleClick:function(){return!1},reloadAnnotations:function(){},getContentRects:function(){var a=$(b),a={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10),width:a.width(),height:a.height()};a.right=a.left+
a.width;a.bottom=a.top+a.height;return[a]},getZoomableAt:function(){return b?KindleRendererZoomableReflowableContentFactory.buildFromElement(b,{x:0,y:0}):null},getZoomableList:function(){return[]}}}(),KindleRendererElementFitting=function(){function h(a){return(a.getAttribute("style")||"")+";"}function j(a,b,c,d){var f=0,g=f=0;a>c&&(f=c/a);b>d&&(g=d/b);f=f>0&&g>0?f<g?f:g:f>0?f:g;f!==0&&(a=f*parseInt(a,10),b=f*parseInt(b,10),b=Math.max(1,b),a=Math.max(1,a));return{height:a,width:b,scale:f}}function e(a){var b=
a.getAttribute("data-isGaiji");if(b)return b==="true";var b=parseInt($(a).css("width"),10),c=parseInt($(a).css("height"),10),d=parseInt($(a).css("font-size"),10);if(Math.abs(b-d)<=1&&Math.abs(c-d)<=1)return a.setAttribute("data-isGaiji","true"),!0;a.setAttribute("data-isGaiji","false");return!1}function d(a,b){for(var c={neededCount:0,downloadedCount:0},d=function(){c.downloadedCount+=1;c.downloadedCount===c.neededCount&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())},f=0;f<a.length;f+=
1)if(a[f].src!==""&&(a[f].complete!==void 0&&a[f].complete===!1||a[f].naturalHeight===0&&a[f].naturalWidth===0))c.neededCount+=1,a[f].onerror=d,a[f].onload=d,a[f].onabort=d;c.neededCount===0&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())}function c(a,b){var c=a.getElementsByTagName("IMG");c.length>0?d(c,b):b()}function b(b,d,o,q){var n=new jQuery.Deferred,r,s,t=function(){r=q.createSubTimer("element-fitting");if($(b).css("position")==="absolute")KindleRendererImageRenderer.scaleCompositeInlineImages(b),
n.resolve();else{var c=b.getElementsByTagName("IMG");if(c.length>0){var t;for(t=0;t<c.length;t+=1){var w=c[t],y=w,G=$(y),s=G.css("max-height"),G=G.css("max-width"),s=s!=="auto"&&s!=="none",G=G!=="auto"&&G!=="none";if(s||G){var A=h(y);s&&(A+="max-height: none; ");G&&(A+="max-width: none; ");y.setAttribute("style",A)}y=w;y.getAttribute("data-nativeHeight")||y.setAttribute("data-nativeHeight",y.height);y.getAttribute("data-nativeWidth")||y.setAttribute("data-nativeWidth",y.width);y.getAttribute("data-nativeLeftOffset")||
y.setAttribute("data-nativeLeftOffset",y.offsetLeft);y.getAttribute("data-nativeTopOffset")||y.setAttribute("data-nativeTopOffset",y.offsetTop);y=w;if(y.className.indexOf("unsupsvg")>=0&&(y.src=f,y.height=y.getAttribute("data-nativeHeight"),y.width=y.getAttribute("data-nativeWidth"),y.height===0||y.width===0))y.height=k,y.width=k,y.setAttribute("data-nativeHeight",y.height),y.setAttribute("data-nativeWidth",y.width);y=w;A=d.getAvailableSizeForImage(y,o,g);G=parseInt(y.getAttribute("data-nativeWidth"),
10)||y.naturalWidth;s=parseInt(y.getAttribute("data-nativeHeight"),10)||y.naturalHeight;if(!G||!s)KindleDebug.warn("Defaulting image width/height. It'll be scaled down to fit."),s=G=1E3;var G=j(s,G,A.height,A.width),s=G.height,G=G.width,x=y,B=s,v=G,I=A.height,L=A.width,A={},D=0,K=parseInt($(x).css("padding-top"),10),M=parseInt($(x).css("padding-bottom"),10),H=K+M;if(H+B>I)D=B+H-I,B=Math.ceil(K/H*D),D-=B,A.top=K-B,A.bottom=M-D;K=parseInt($(x).css("padding-left"),10);x=parseInt($(x).css("padding-right"),
10);M=K+x;if(M+v>L)D=v+M-L,v=Math.ceil(K/M*D),L=D-v,A.left=K-v,A.right=x-L;v=h(y);v+="height: "+s+"px; width: "+G+"px; ";v+=(A.top!==void 0?"padding-top: "+A.top+"px; ":"")+(A.bottom!==void 0?"padding-bottom: "+A.bottom+"px; ":"")+(A.left!==void 0?"padding-left: "+A.left+"px; ":"")+(A.right!==void 0?"padding-right: "+A.right+"px; ":"");y.setAttribute("style",v);e(w)||d.padImageIfNeeded(w)}w=d.calculateOverlappingImageSets(c,e);for(y=a;y>0&&w.length>0;){for(t=0;t<w.length;t+=1)if(G=w[t],s=G.imgs,G=
j(G.height,G.width,o.height*g,o.width*g).scale,G!==0)for(D=0;D<s.length;D+=1)A=s[D],v=A.height*G,L=A.width*G,v<1||L<1||(x=h(A),x+="height: "+v+"px; width: "+L+"px;",A.setAttribute("style",x));--y;w=d.calculateOverlappingImageSets(c,e)}}if(d.getWritingMode()!=="vertical"){c=b.getElementsByTagName("TABLE");for(t=0;t<c.length;t++){w=c[t];A=o;s=y=0;G=parseInt(w.getAttribute("data-nativeWidth"),10);A=A.parentWidth||A.width;G||(G=$(w).width(),w.setAttribute("data-nativeWidth",G));v=Math.min(parseInt(w.getAttribute("data-nativeLeftOffset"),
10),w.offsetLeft);if(!v)v=w.offsetLeft,w.setAttribute("data-nativeLeftOffset",v);L=$(w.offsetParent).width()||A;L=Math.min(L-v,A*g);G>L&&(s=L/G);s>0&&(y=s);y!==0&&(s="scale("+y+")",y=h(w),y+=" -moz-transform: "+s+"; -webkit-transform:"+s+"; -o-transform:"+s+"; -ms-transform:"+s+"; ms-transform:"+s+"; transform:"+s+"; ",s=$(w).css("float"),G="top ",G+=s==="right"?"right":"left",y+=" -moz-transform-origin: "+G+"; -webkit-transform-origin: "+G+"; -o-transform-origin: "+G+"; -ms-transform-origin "+G+
"; ms-transform-origin "+G+"; transform-origin "+G+"; ",w.setAttribute("style",y))}}setTimeout(n.resolve,10)}};window.ActiveXObject&&window.XMLHttpRequest?$(b.ownerDocument).ready(t):(s=q.createSubTimer("(WAIT) image-loading"),c(b,function(){s.endTimer();t()}));return n.promise().then(function(){r.endTimer()})}var g=0.95,a=3,f="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' viewBox='0 0 100 100'><g><rect x='1%' y='1%' rx='20' ry='20' width='98%' height='98%' style='fill:white; stroke:gray;stroke-width:2;'></rect><text x='50%' y='50%' fill='black' font-size='8px' style='text-anchor: middle; dominant-baseline: central;'>Image Not Supported</text></g></svg>",
k=200;return{fitToViewport:function(a,c,d,f){return b(a,c,d,f)},resize:function(a,b){var c;if($(a).css("position")==="absolute")if(b.width>0&&b.height>0){c=a.offsetWidth>0&&a.offsetHeight>0?Math.min(b.width/a.offsetWidth,b.height/a.offsetHeight):1;var d="scale("+c+")";$(a).css({"-moz-transform":d,"-moz-transform-origin":"left top","-webkit-transform":d,"-webkit-transform-origin":"left top","-o-transform":d,"-o-transform-origin":"left top","ms-transform":d,"ms-transform-origin":"left top","-ms-transform":d,
"-ms-transform-origin":"left top",transform:d,"transform-origin":"left top"});c={width:$(a).width()*c,height:$(a).height()*c}}else c=void 0;return c}}}(),KindleRendererImageRenderer=function(){function h(a){function b(a,c){return parseInt(a.name.match(q),10)-parseInt(c.name.match(q),10)}for(var c in a){var d=a[c].parent;if(l[d]===void 0||l[d]===null)l[d]=[];l[d].push({name:a[c].name,width:a[c].width,height:a[c].height})}for(c in l)l[c].sort(b)}function j(a,b,c,d){if(b&&b[d])a.src=b[d];else if(c&&
c[d])a.src=c[d]}function e(a){a=a.split("url(")[1].split(")")[0].split("resources");bgImgFilepath=a[0];bgImgResourceName="resources"+a[a.length-1];return{bgImgFilepath:bgImgFilepath,bgImgResourceName:bgImgResourceName}}function d(a,b,c){var d=0;a.substring(a.length-1,a.length)==="%"?d=b!==0?parseFloat(a)/100*c/b:1:a.substring(a.length-2,a.length)==="px"?(c=parseFloat(a),d=b!==0?c/b:1):d=1;return d}function c(a,b,c,f){var g=b.css("background-size").split(",")[0].trim().split(" "),e,h=!1,k=!1;g[0]===
"auto"?g=e="100%":g[0]==="cover"?(h=!0,g=e="100%"):g[0]==="contain"?(k=!0,g=e="100%"):g.length===1?(e=g[0],g="100%"):(e=g[0],g=g[1]);a.w=d(e,c,b.width());a.h=d(g,f,b.height());if(h)b=a.w>a.h?a.w:a.h,a.w=b,a.h=b;else if(k)b=a.w<a.h?a.w:a.h,a.w=b,a.h=b}function b(a,b,c,d,f,g,e){for(var h=[],k=[],j=0,m=0,l=0,j=0;j<f;j++)h[j]=g*c[j],k[j]=e*d[j],a[j]=Math.round(h[j]),m+=k[j],b[j]=Math.round(m-l),l+=b[j]}function g(a,b){if(a==="top"||a==="left")a="0%";a==="center"&&(a="50%");if(a==="bottom"||a==="right")a=
"100%";var c=0,c=a.substring(a.length-1,a.length)==="%"?parseFloat(a)/100*b:a.substring(a.length-2,a.length)==="px"?parseFloat(a):0;return Math.round(c)}function a(a,b){var c=b.css("background-position").split(",")[0].trim().split(" "),d;c.length===1?(d=c[0],c="50%"):(d=c[0],c=c[1]);a.x=g(d,b.width());a.y=g(c,b.height())}function f(d){function f(){B++;B===q&&g.css("background-image",x)}var g=$(d),h=g.css("background-image");if(!(h==="none"||h==="inherit")){var h=e(h),k=h.bgImgFilepath,j=l[h.bgImgResourceName];
if(j!==void 0&&j!==null){var h=0,q=j.length;g.addClass(m);for(var o=[],G=[],F=0,A=0,x="",F=[],h=0;h<q;h++)F[h]="url("+k+j[h].name+")",o[h]=j[h].width,G[h]=j[h].height,A+=G[h],x+=F[h],h!==q-1&&(x+=",");for(var F=o[0],B=0,h=0;h<q;h++)jqImgSlicedNode=$("<img/>"),jqImgSlicedNode[0].onload=f,jqImgSlicedNode[0].src=k+j[h].name;h={w:1,h:1};c(h,g,F,A);A=[];k=[];b(A,k,o,G,q,h.w,h.h);o="";for(h=0;h<q;h++)o=o+A[h]+"px "+k[h]+"px",h!==q-1&&(o+=",");d.setAttribute("style",(d.style||"")+("; background-size: "+
o+" !important;"));o={x:0,y:0};a(o,g);for(var G=[],A=[],j=0,v=F="",h=0;h<q;h++)G[h]=o.x,A[h]=o.y+j,F=F+G[h]+"px "+A[h]+"px",v+="no-repeat",j+=k[h],h!==q-1&&(F+=",",v+=",");d.setAttribute("style",(d.style||"")+("; background-position: "+F+" !important;"));g.css("background-repeat",v)}}}function k(a,c,d){for(var f=[],g=[],e=[],h=[],k=0,j=0,m=$(c).children(),j=j=0;j<m.length;j++)f[j]=m[j].width,g[j]=m[j].height,k+=g[j];j=f[0];if(!(k===0||j===0)){$(a).css("display","block");var l=parseInt($(a).css("height"),
10),q=parseInt($(a).css("width"),10);q===0&&l===0?(q=j,l=k):l===0?l=Math.round(k/j*q):q===0&&(q=Math.round(j/k*l));$(a).width(q);$(a).height(l);b(e,h,f,g,m.length,q/j,l/k);for(j=0;j<m.length;j++)$(m[j]).width(e[j]),$(m[j]).height(h[j]),$(m[j]).css("top","0px"),$(m[j]).css("left","0px"),$(m[j]).css("position","relative"),$(m[j]).css("border","none"),$(m[j]).css("display","block"),d&&$(m[j]).css("margin-bottom","-1px");$(c).css("line-height",0);$(c).css("display","inline-block");$(c).css("position",
$(a).css("position"));$(c).css("width",$(a).css("width"));$(c).css("height",$(a).css("height"));$(c).css("top",$(a).css("top"));$(c).css("left",$(a).css("left"));$(c).css("bottom",$(a).css("bottom"));$(c).css("right",$(a).css("right"));$(c).css("float",$(a).css("float"));$(c).css("padding",$(a).css("padding"));$(c).css("border",$(a).css("border"))}}var m="amzn-sliced-bgimg-ori",l={},o=null,q=RegExp(/\d+$/);return{initialize:function(a){if(a.coverResource!==null&&a.coverResource!==void 0)o=a.resourceManifest[a.coverResource].name;
a=a.compositeResourceManifest;a!==void 0&&a!==null?h(a):l={}},cleanup:function(){l={}},getCompositeData:function(){return l},getCoverImageSlices:function(){return l[o]},resolveCompositeResources:function(a){if(!$.isEmptyObject(l)){for(var b=[],c=0;c<a.length;c++){var d=[],f=d,g=a[c];if(l[g]!==void 0&&l[g]!==null)for(var e=l[g].length,h=0;h<e;h++)f.push(l[g][h].name);b=d.length>0?b.concat(d):b.concat(a[c])}a=b}return a},loadImage:function(a,b,c,d){var f=l[d];if(f!==void 0&&f!==null){$(a).addClass("amzn-sliced-inimg-ori");
(d=a.getAttribute("alt"))&&a.setAttribute("data-alt-text",d);a.removeAttribute("alt");$(a).css("display","none");d=$("<div/>",{"class":"amzn-sliced-inimg-div"});d.insertBefore($(a));d.attr("data-nid",a.getAttribute("data-nid"));for(var g=f.length,e=0;e<g;e++)a=$("<img/>",{"class":"amzn-sliced-inimg-imgslice"}),a.width(f[e].width),a.height(f[e].height),j(a[0],b,c,f[e].name),a.appendTo(d)}else j(a,b,c,d)},scaleCompositeInlineImages:function(a){if(!$.isEmptyObject(l)){for(var b=a.getElementsByClassName("amzn-sliced-inimg-ori"),
a=a.getElementsByClassName("amzn-sliced-inimg-div"),c=b.length,d=0,d=0;d<c;d++){k(b[d],a[d],!0);var f=$(a[d]).children()[0],g=b[d].getAttribute("data-alt-text");g&&f.setAttribute("alt",g)}$(b).remove()}},scaleCompositeBackgroundImages:function(a){if(!$.isEmptyObject(l))for(var a=$(a).find("*"),b=0;b<a.length;b++)f(a[b])},scaleImageSlices:k}}(),KindleRendererWritingModeFactory=function(){function h(c,b,g,a,f){var e=d*Math.min(g,a),h=Math.abs(g-a);return(c<b?c+g-b:b+a-c)>e&&(!f||h<e)}function j(){var c=
KindleRendererDeviceSpecific.usesDocRelativeVerticalCoordinates(),b=0,d=!1;return{getWritingMode:function(){return"vertical"},resetHeight:function(a){$(a).css("width",$(a.parentNode).width()+"px")},resetWidth:function(a){$(a).css("height",$(a.parentNode).height()+"px")},resetIframeDimensions:function(a){$(a).css({width:$(a.parentNode).width()+"px",height:$(a.parentNode).height()+"px"})},padImageIfNeeded:function(a){var b=$(a).css("margin-left");parseInt(b,10)<=1&&$(a).css("margin-left","2px")},getAvailableSizeForImage:function(a,
b,c){var d=Math.min(a.getAttribute("data-nativeTopOffset"),a.offsetTop),g=$(a.offsetParent).outerHeight()||b.height,e=$(a.offsetParent).outerWidth()||b.width,g=Math.min(g-d,b.height*c),e=Math.min(e,b.width*c);$(a).css("float")!=="none"&&(c=$(a).parent(),a=parseInt($(c).css("line-height"),10),c=parseInt($(c).css("font-size"),10),e=Math.min(e,b.width-(a+c)));return{width:e,height:g}},calculateOverlappingImageSets:function(a,b){function c(a,b){return a.offsetLeft-b.offsetLeft}var d=[];if(a.length>1){for(var a=
Array.prototype.slice.call(a).sort(c),g=null,e=a[0],h=e.offsetLeft+e.width,j,r,s=1;s<a.length;++s)if(j=a[s],!b(j)){r=j.offsetLeft+j.width;if(j.offsetLeft<=h){g||(g={left:e.offsetLeft,right:h,imgs:[e]});if(r>g.right)g.right=r;g.imgs.push(j)}else g&&(d.push({height:0,width:g.right-g.left,imgs:g.imgs}),g=null);e=j;h=g?g.right:r}g&&d.push({height:0,width:g.right-g.left,imgs:g.imgs})}return d},forceRepaint:function(a){if(a.contentDocument)a.contentDocument.body.style.top=0,setTimeout(function(){a.contentDocument.body.style.top=
""},1)},setHeight:function(a,b){$(a).css("width",b)},setWidth:function(a,b){$(a).css("height",b)},fitToBottomOfFrame:function(a,b,c){$(b).css({height:"100%",width:$(a).width()-c+1,top:0,left:$(a).position().left-1})},height:function(a){return $(a).width()},width:function(a){return $(a).height()},prepareForPagination:function(a){b=$(a).width();this.scrollToTopOfDocument(a);d=$(a.contentDocument).find("table").length>0},getBorderMap:function(a,c){var d,g,e,h;for(d=0;d<a.length;d++){e=a[d];g=e.getBoundingClientRect();
if((h=$(e).css("border-right-style"))&&h!=="none")if(h=parseInt($(e).css("border-right-width"),10))h={borderStart:b-g.right-h,borderEnd:b-g.right},c.top.push(h);if((h=$(e).css("border-left-style"))&&h!=="none")if(e=parseInt($(e).css("border-left-width"),10))h={borderStart:b-g.left,borderEnd:b-g.left+e},c.bottom.push(h)}},getTransformedClientRects:function(a,c,e){var h=a.length,j=[],o=c&&c.deltaX||0,e=c&&c.fontSize||e&&parseInt(e.fontSize,10)||void 0,q=0;for(a.length>1&&(a[0].height<=1&&++q,a[a.length-
1].height<=1&&--h);q<h;q++){var n=a[q],r=n.right+o-(c&&parseInt(c.ownerDocument.body.style.left,10)||0),s=e&&c.tagName!=="IMG"?e:n.width,n={top:n.top,bottom:n.bottom,height:n.height,left:b-(r-s),right:b-r,width:s},s=c,r=n;if(d){var t=$(s).closest("TBODY")[0];if(t){var u=0,u=$(t).parent(),z=$(u).width(),u=z,w=$(s).closest("TD")[0];w&&(u-=$(w).width());t=z-$(t).width();u+=t;r.left+=u;r.right+=u}}s&&s.getAttribute&&s.getAttribute("data-isTextCombineBlock")&&(t=parseInt($(s).css("font-size"),10),s=r.height-
t,t=r.width-t,s>0&&(u=Math.ceil(s/2),r.top+=u,r.bottom-=u,r.height-=s),t<0&&(s=Math.ceil(t/2),r.left-=s,r.right+=s,r.width-=t));j.push(n)}return j},getRectsAdjustedForAnnotationMarks:function(a,b){for(var c=a.length,d=[],g=Math.ceil(b/2)+1,e=0;e<c;e++){var h=a[e];d.push({top:h.top,bottom:h.bottom,height:h.height,left:h.left,right:h.right-g,width:h.width+g})}return d},unionRect:function(a){for(var b=a[0],b={left:b.top,right:b.bottom,bottom:b.left,top:b.right},c=1;c<a.length;++c)b.top=Math.min(b.top,
a[c].right),b.bottom=Math.max(b.bottom,a[c].left),b.right=Math.max(b.right,a[c].bottom),b.left=Math.min(b.left,a[c].top);return b},clientRectTop:function(a){return a.right},clientRectBottom:function(a){return a.left},clientRectLeft:function(a){return a.top},clientRectRight:function(a){return a.bottom},clientRectWidth:function(a){return a.height},clientRectHeight:function(a){return a.width},clientRectCompare:function(a,b){return h(a.right,b.right,a.width,b.width,!1)?a.top-b.top:a.right-b.right},checkIfRectsOnSameLine:function(a,
b){return h(a.right,b.right,a.width,b.width,!1)},scrollToTopOfDocument:function(a){var d=0;c&&(d=a.contentDocument.width-b);$(a.contentWindow).scrollLeft(d);a.contentDocument.body.style.top=0;a.contentDocument.body.style.left=0},scrollTop:function(a,b){a.contentDocument.body.style.left=b},getRectBoundariesForScreen:function(a,c){for(var d=[],g=a.length,e=0;e<g;e++)d.push({left:b-(a[e].left-c),top:a[e].top,right:b-(a[e].right-c),bottom:a[e].bottom});return d},isPointOnVisiblePage:function(a,b,c){return c>
b},checkIfNewLine:function(a,b,c){return b===void 0||!h(a.right,b.right,a.width,b.width,c)},updateLineBounds:function(a,b,c,d,g){a.left=g-c.left;a.right=g-c.right;a.height=b&&d?d.top-a.top:c.bottom-a.top;a.width=a.right-a.left},updateLineHeightOfBounds:function(a,b){a.left=a.left>=b.left?a.left:b.left;a.right=a.right<=b.right?a.right:b.right;a.top=b.top;a.bottom=b.bottom},updateDivIfNewLineOrImageBound:function(a,b,c,d,g,e){var h=!1;if(a.isNewLine||a.isImageBound)a.lineBounds={top:a.isNewLine?b.top:
a.lineBounds.top+a.lineBounds.height,height:b.height,left:b.left,right:b.right,width:b.width};a.isImageBound=g;a.isNewLine=this.checkIfNewLine(a.lineBounds,c,!0);(h=a.isNewLine||a.isImageBound)&&this.updateLineBounds(a.lineBounds,!a.isNewLine&&!(d||c===void 0),b,c,e);return h},positionDivAfterWord:function(a,b,c,d){a.style.top=b.top+c;a.style.left=d-b.left+b.width+c},getDeltaX:function(a,b){var f;var c,d=0;if(KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),
10)<6){if(a.tagName==="RUBY"){var g=b.createRange();g.selectNodeContents(a);var g=g.getClientRects(),e=a.getClientRects();e&&g&&e.length&&g.length&&(d=e[0].left-g[0].left)}if(a.parentNode&&a.parentNode.parentNode){g=a.nodeType===Node.TEXT_NODE?a.parentNode:a;e=a.nodeType!==Node.TEXT_NODE&&a.tagName!=="RUBY"&&$(g).css("display")==="inline";c=$(g).css("display")==="inline-block";var h=$(g.parentNode).css("display")==="inline";if((e||c)&&h){d+=-g.getBoundingClientRect().right;e=g;do c=e,e=e.parentNode;
while(e&&$(e).css("display")!=="block");c={containingBlock:e,furthestNonBlockParent:c};if(e=c.containingBlock){f=h=c.furthestNonBlockParent,c=f;do c=c.nextElementSibling;while(c&&$(c).css("display")!=="block");do h=h.previousElementSibling;while(h&&$(h).css("display")!=="block");h=h?h.getBoundingClientRect().left-parseInt($(h).css("margin-left"),10):e.getBoundingClientRect().right;e=c?c.getBoundingClientRect().right+parseInt($(c).css("margin-right"),10):e.getBoundingClientRect().left;g=h-(g.getBoundingClientRect().left-
e)}else g=g.getBoundingClientRect().right;d+=g}}}return d},floatToTopOfIframe:function(a,c){var d=a.document.body,g=d.getBoundingClientRect(),d=a.getComputedStyle(d);$(c).css({position:"absolute",top:parseInt(d.top,10)-g.top,left:parseInt(d.left,10)-(g.left+a.document.width-b)})}}}function e(){return{getWritingMode:function(){return"horizontal"},resetHeight:function(c){$(c).css("height",$(c.parentNode).height()+"px")},resetWidth:function(c){$(c).css("width",$(c.parentNode).width()+"px")},resetIframeDimensions:function(c){$(c).css({height:$(c.parentNode).height()+
"px",width:$(c.parentNode).width()+"px"})},padImageIfNeeded:function(c){var b=$(c).css("margin-bottom");parseInt(b,10)<=1&&$(c).css("margin-bottom","2px")},getAvailableSizeForImage:function(c,b,d){var a=Math.min(c.getAttribute("data-nativeLeftOffset"),c.offsetLeft),f=$(c.offsetParent).outerHeight()||b.height,e=$(c.offsetParent).outerWidth()||b.width,f=Math.min(f,b.height*d),e=Math.min(e-a,b.width*d);$(c).css("float")!=="none"&&(d=$(c).parent(),c=parseInt($(d).css("line-height"),10),d=parseInt($(d).css("font-size"),
10),f=Math.min(f,b.height-(c+d)));return{width:e,height:f}},calculateOverlappingImageSets:function(c,b){function d(a,b){return a.offsetTop-b.offsetTop}var a=[];if(c.length>1){for(var c=Array.prototype.slice.call(c).sort(d),f=null,e=c[0],h=e.offsetTop+e.height,j,o,q=1;q<c.length;++q)if(j=c[q],!b(j)){o=j.offsetTop+j.height;if(j.offsetTop<=h){f||(f={top:e.offsetTop,bottom:h,imgs:[e]});if(o>f.bottom)f.bottom=o;f.imgs.push(j)}else f&&(a.push({height:f.bottom-f.top,width:0,imgs:f.imgs}),f=null);e=j;h=f?
f.bottom:o}f&&a.push({height:f.bottom-f.top,width:0,imgs:f.imgs})}return a},forceRepaint:function(){},setHeight:function(c,b){$(c).css("height",b)},setWidth:function(c,b){$(c).css("width",b)},fitToBottomOfFrame:function(c,b,d){d=$(c).height()-d+1;c=$(c).position().top+$(c).height()-d+1;$(b).css({height:d,width:"100%",top:c,left:0})},height:function(c){return $(c).height()},width:function(c){return $(c).width()},prepareForPagination:function(c){this.scrollToTopOfDocument(c)},getBorderMap:function(c,
b){var d,a,f,e;for(d=0;d<c.length;d++){f=c[d];a=f.getBoundingClientRect();if((e=$(f).css("border-top-style"))&&e!=="none")if(e=parseInt($(f).css("border-top-width"),10))e={borderStart:a.top-e,borderEnd:a.top},b.top.push(e);if((e=$(f).css("border-bottom-style"))&&e!=="none")if(f=parseInt($(f).css("border-bottom-width"),10))e={borderStart:a.bottom,borderEnd:a.bottom+f},b.bottom.push(e)}},getTransformedClientRects:function(c,b){c.length>1&&(c[0].width<=1&&(c=Array.prototype.slice.call(c,1)),c[c.length-
1].width<=1&&(c=Array.prototype.slice.call(c,0,-1)));if(b){var d=[],a=parseInt(b.ownerDocument.body.style.top,10);if(a!==0){for(var f=0;f<c.length;++f){var e=c[f];d.push({top:e.top-a,bottom:e.bottom-a,height:e.height,left:e.left,right:e.right,width:e.width})}c=d}}return c},getRectsAdjustedForAnnotationMarks:function(c,b){for(var d=c.length,a=[],f=Math.ceil(b/2)+1,e=0;e<d;e++){var h=c[e];a.push({top:h.top-f,bottom:h.bottom,height:h.height+f,left:h.left,right:h.right,width:h.width})}return a},unionRect:function(c){for(var b=
c[0],b={top:b.top,bottom:b.bottom,left:b.left,right:b.right},d=1;d<c.length;++d)b.top=Math.min(b.top,c[d].top),b.right=Math.max(b.right,c[d].right),b.bottom=Math.max(b.bottom,c[d].bottom),b.left=Math.min(b.left,c[d].left);return b},clientRectTop:function(c){return c.top},clientRectBottom:function(c){return c.bottom},clientRectLeft:function(c){return c.left},clientRectRight:function(c){return c.right},clientRectWidth:function(c){return c.width},clientRectHeight:function(c){return c.height},clientRectCompare:function(c,
b){return h(c.top,b.top,c.height,b.height,!1)?c.left-b.left:c.top-b.top},checkIfRectsOnSameLine:function(c,b){return h(c.top,b.top,c.height,b.height,!1)},scrollToTopOfDocument:function(c){$(c.contentWindow).scrollTop(0);c.contentDocument.body.style.top=0;c.contentDocument.body.style.left=0},scrollTop:function(c,b){c.contentDocument.body.style.top=-b},getRectBoundariesForScreen:function(c,b){for(var d=[],a=c.length,f=0;f<a;f++)d.push({left:c[f].left,top:c[f].top-b,right:c[f].right,bottom:c[f].bottom-
b});return d},isPointOnVisiblePage:function(c,b,d,a){return a<c-b},checkIfNewLine:function(c,b,d){return b===void 0||!h(c.top,b.top,c.height,b.height,d)},updateLineBounds:function(c,b,d,a){c.top=d.top;c.bottom=d.bottom;c.height=c.bottom-c.top;c.width=b&&a?a.left-c.left:d.right-c.left},updateLineHeightOfBounds:function(c,b){c.top=c.top?c.top<=b.top?c.top:b.top:b.top;c.bottom=c.bottom?c.bottom>=b.bottom?c.bottom:b.bottom:b.bottom;c.left=b.left;c.right=b.right},updateDivIfNewLineOrImageBound:function(c,
b,d,a,f){var e=!1;if(c.isNewLine||c.isImageBound)c.lineBounds={top:b.top,height:b.height,left:c.isNewLine?b.left:c.lineBounds.left+c.lineBounds.width,right:b.right,width:b.width};c.isImageBound=f;c.isNewLine=this.checkIfNewLine(c.lineBounds,d,!0);(e=c.isNewLine||c.isImageBound)&&this.updateLineBounds(c.lineBounds,!c.isNewLine&&!(a||d===void 0),b,d);return e},positionDivAfterWord:function(c,b,d){c.style.top=b.top+d;c.style.left=b.left+b.width+d},getDeltaX:function(){return 0},floatToTopOfIframe:function(c,
b){var d=c.document.body,a=d.getBoundingClientRect(),d=c.getComputedStyle(d);$(b).css({position:"absolute",top:parseInt(d.top,10)-a.top,left:parseInt(d.left,10)-a.left})}}}var d=0.25;return{buildIFrameWritingMode:function(c){if(!c.contentDocument)return e();if(KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()){var b=c.contentDocument,d=b.documentElement,b=b.body;if($(d).css("-webkit-writing-mode")==="vertical-rl"){var a=d.getAttribute("style"),f=b.getAttribute("style"),f=f?f+";":"";d.setAttribute("style",
(a?a+";":"")+"-webkit-writing-mode: vertical-rl !important;");b.setAttribute("style",f+"-webkit-writing-mode: vertical-rl !important;")}}return(c=$(c.contentDocument.body).css("-webkit-writing-mode"))&&c.match(/^vertical/)!==null?j():e()},buildHorizontalWritingMode:e,buildVerticalWritingMode:j}}(),KindleRendererContentReflow=function(){function h(a){a=a.contentDocument.getElementsByTagName("body")[0];return $(a).css("position")==="absolute"}function j(a,b){KindleRendererLanguageOptions.getNeedsPageRefresh()&&
!h(a)?(a.contentDocument.body.style.display="none",setTimeout(function(){a.contentDocument.body.style.display="block";b()},1)):b()}function e(b,c,d,g,e,n){f===null&&(f=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordBounds());var r=e.createSubTimer("preparation");KindleRendererContentCorrection.applyDocumentWideCorrections(b.contentWindow,b.contentDocument,b.writingMode,r);j(b,function(){b.writingMode.prepareForPagination(b);var s=b.contentDocument.getElementById(a);b.writingMode.floatToTopOfIframe(b.contentWindow,
s);r.endTimer();var t=e.createSubTimer("word-map");f.createWordMap(b.contentDocument,b.contentWindow,c,b.writingMode,d,b.processingRequestId,t).then(function(a,c,d){function g(a){m.endTimer();n(a)}t.endTimer();KindleRendererContentCorrection.cleanup(b.contentDocument.body);var m=e.createSubTimer("height-map");h(b)?KindlePaginatorFixedContent(b.contentDocument,a,$(b).parent().height(),g):KindlePaginatorScreenFragmentation(b.contentDocument,a,c,d,f,b.writingMode.height($(b).parent()),b.writingMode,
g);j(b,function(){})},g.reject)})}function d(a,b,d,f){if(a.processingRequestId.id===b.requestId){a.writingMode.scrollToTopOfDocument(a);a.writingMode.resetHeight(a);var g={height:$(a).parent().height(),width:$(a).parent().width()},e=a.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var h=parseInt($(e).css("margin-top"),10),j=parseInt($(e).css("margin-bottom"),10);e.style.height=parseInt(g.height,10)-h-j+"px"}h=e.getElementsByClassName("k4w-margin");
for(j=0;j<h.length;j+=1){var t=parseInt(h[j].getAttribute("vertical"),10);if(t>0)h[j].style.marginTop=Math.round(t*0.01*g.height)+"px"}KindleRendererElementFitting.fitToViewport(e,a.writingMode,g,b.contentLoadMetrics).then(function(){a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):c(a,b,d,f)},f.reject)}}function c(a,b,c,d){b.contentLoadMetrics.endTimer();var f=b.metrics.createSubTimer("pagination");e(a,c,b.requestId,d,f,function(c){f.endTimer();
a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):(a.screenManager=c,b.contentLoadMetrics.endTimer(),d.resolve(b))})}function b(a,b){var c=KindleRendererDeviceSpecific.reflowTimeout();c>0&&setTimeout(function(){!b.isRejected()&&!b.isResolved()&&(a.contentLoadMetrics.addCount("Timeout",1),a.contentLoadMetrics.endTimer(),b.reject())},c)}function g(a,c,f){var g=new jQuery.Deferred;b(c,g);var e=c.contentLoadMetrics.createSubTimer("(YIELD) begin-element-fitting");
setTimeout(function(){e.endTimer();d(a,c,f,g)},KindleRendererDeviceSpecific.drawYieldUpdateTime());return g.promise()}var a="content-overlays",f=null;return{initialize:function(){KindleRendererContentCorrection.initialize()},reflow:function(a,b,c){return g(a,b,c)}}}(),KindlePaginatorFixedContent=function(h,j,e,d){h={minDocTop:0,maxDocTop:0,docBottom:e,wordMap:j};(function(c){c.minPosition=Infinity;c.maxPosition=-Infinity;for(var b in j){var d=parseInt(b,10);if(d>c.maxPosition)c.maxPosition=d;if(d<
c.minPosition)c.minPosition=d}})(h);(function(c){c.hasNextScreen=function(b){return b===0};c.hasPreviousScreen=function(b){return b===e};c.getFirstReadingPositionAtHeight=function(){return null};c.getFirstEmptySpaceBeforeHeight=function(){return 0};c.getTopOfNodeAtPosition=function(){return 0};c.findNextScreen=function(b){return!c.hasNextScreen(b)?null:{topOfScreen:0,bottomOfScreen:e}};c.findPreviousScreen=function(b){return!this.hasPreviousScreen(b)?null:{topOfScreen:0,bottomOfScreen:e}}})(h);d(h)},
KindlePaginatorHeightMapGenerator=function(){function h(a,b,c,d,g,e){c<0&&(c=0);d<0&&(d=0);if(b.previousTop===c&&b.previousBottom===d&&b.previousFontSize===e)return!1;b.previousTop=c;b.previousBottom=d;b.previousFontSize=e;if(c<a.minDocTop)a.minDocTop=c;if(c>a.maxDocTop)a.maxDocTop=c;b=d;if(b>a.docBottom)a.docBottom=b;d-=c;e===void 0&&(e=d);d=c+Math.floor((d-e)/2);e=d+e;a=a.nodeHeightRanges;for(c+=1;c<d;)a[c]>=0||(a[c]=-g),++c;for(;c<e;)a[c]>=0||(a[c]=g),++c;for(;c<b;)a[c]===void 0&&(a[c]=-g),++c;
return!0}function j(a){for(var a=a.nodeHeightRanges,b=a.length,c=0,d,g,e,h,j;c<b;){for(;a[c]<0;)a[c]=-a[c],++c;if(a[c]>=0){for(++c;a[c]>=0;)++c;if(a[c]<0){d=c;h=a[d-1];for(++c;a[c]<0;)++c;g=c-1;j=a[c];if(j>=0){e=Math.floor((d+g)/2);for(delete a[e];d<e;++d)a[d]=h;for(d=e+1;d<=g;++d)a[d]=j}else for(;d<=g;++d)a[d]=h}}++c}}function e(a,b,c,d,g,q,n){function r(){e(a+1,b,c,d,g,q,n)}var s=0;for(KindleRendererProcessTuning.startingOperation("HeightMap");a<b.length;){var t=b[a],u=t.position,z=t.rect,w=d.clientRectTop(z),
z=d.clientRectBottom(z);if(w>0||z>0){var y=Math.round(w);h(c,g,y,y+Math.round(z-w+1),u,t.fontSize)&&s++}if(s>n.count){KindleRendererProcessTuning.endingOperation("HeightMap",s);setTimeout(r,n.interval);return}a++}KindleRendererProcessTuning.endingOperation("HeightMap",s);j(c);setTimeout(q.resolve,n.interval)}function d(a){var b={},a=a.body;b.bodyDimensions={height:a.offsetHeight,width:a.offsetWidth};if(a=a.lastElementChild){var c=$(a),a=c.offset(),d=c.width(),c=c.height();b.lastElementPos={top:a.top,
left:a.left,width:d,height:c}}return b}function c(a,b,c,d,g,h,j,r){if(c){var s=new jQuery.Deferred,t={count:KindleRendererProcessTuning.drawYieldFrequency("HeightMap"),interval:KindleRendererProcessTuning.drawYieldUpdateTime("HeightMap")};e(0,c,d,b,{},s,t);s.promise().then(function(){var c=Array.prototype.slice.call(a.getElementsByTagName("hr")),d,e=[];for(d=0;d<c.length;++d)e.push(c[d].getBoundingClientRect());e=b.getTransformedClientRects(e);for(d=0;d<e.length;++d)h.push(e[d]);c=$(a.body).find("[data-hasCssBorder='true']");
b.getBorderMap(c,j);c=[];c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("page-break")));c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("pagebreak")));d=[];for(e=0;e<c.length;++e)d.push(c[e].getBoundingClientRect());d=b.getTransformedClientRects(d);for(e=0;e<d.length;++e)g.push(Math.round(b.clientRectTop(d[e])));r()},function(){})}}function b(b,c){var d=function(){if(j<b.minDocTop)b.minDocTop=j;if(j>b.maxDocTop)b.maxDocTop=j;if(n>b.docBottom)b.docBottom=n;for(var a=
j;a<n;a++)b.nodeHeightRanges[a]===void 0&&(b.nodeHeightRanges[a]=g)},e,h;e=c.top;h=c.bottom;var j,n,r,s,t;for(r=0;r<e.length;r++){j=Math.round(e[r].borderStart);n=Math.round(e[r].borderEnd);d();t=0;for(s=n;s<b.docBottom;s++)if(b.nodeHeightRanges[s]===void 0&&t<=a)b.nodeHeightRanges[s]=g,t++;else break}for(r=0;r<h.length;r++){j=Math.round(h[r].borderStart);n=Math.round(h[r].borderEnd);d();t=0;for(s=j;s>b.minDocTop;s--)if(b.nodeHeightRanges[s]===void 0&&t<=a)b.nodeHeightRanges[s]=g,t++;else break}}
var g="border-height",a=2;return{getHeightMapTags:function(){return{HARD_PAGE_BREAK:"page-break",HORIZONTAL_RULE:"horizontal-rule",BORDER_HEIGHT:g}},createHeightMap:function(a,g,e,h){var j={nodeHeightRanges:[],minPosition:Infinity,maxPosition:0,minDocTop:Infinity,maxDocTop:0,docBottom:0};j.validationData=d(a);var q=[],n=[],r={top:[],bottom:[]};c(a,g,e,j,q,n,r,function(){for(var a=q,c=0;c<a.length;c++){var d=a[c],f=j.nodeHeightRanges[d];if(f===void 0)j.nodeHeightRanges[d]="page-break";else if(f!==
"page-break")for(var e=1;e<20;e++){if(j.nodeHeightRanges[d-e]!==f){j.nodeHeightRanges[d-e]="page-break";break}if(j.nodeHeightRanges[d+e]!==f){j.nodeHeightRanges[d+e]="page-break";break}}}for(a=0;a<n.length;a++)if(d=Math.round(g.clientRectTop(n[a])),c=Math.round(g.clientRectBottom(n[a])),c>d){if(d<j.minDocTop)j.minDocTop=d;if(d>j.maxDocTop)j.maxDocTop=d;if(c>j.docBottom)j.docBottom=c;for(;d<c;d++)j.nodeHeightRanges[d]===void 0&&(j.nodeHeightRanges[d]="horizontal-rule")}b(j,r,g);q=null;h(j)})}}}(),
KindlePaginator=function(){function h(d,c){if(c!==null)d.currentTopOfScreen=c.topOfScreen,d.currentBottomOfScreen=c.bottomOfScreen,e(d)}function j(d,c){if(c!==null)d.currentTopOfScreen=c.topOfScreen,d.currentBottomOfScreen=c.bottomOfScreen,e(d)}function e(d){var c=KindleRendererDeviceSpecific.animatePageFlip(),b=$(d);c&&(b.removeClass("pageTurnEnd"),b.addClass("pageTurnStart"));d.writingMode.scrollTop(d,d.currentTopOfScreen);d.writingMode.fitToBottomOfFrame(d,d.pageOverflowDiv,d.currentBottomOfScreen-
d.currentTopOfScreen);c&&(b.removeClass("pageTurnStart"),b.addClass("pageTurnEnd"))}return{scrollToTop:function(d,c){var b=d.screenManager.findNextScreen(c||d.screenManager.minDocTop<=1?0:d.screenManager.minDocTop-1);h(d,b)},scrollToBottom:function(d,c){var b=d.screenManager.findPreviousScreen(d.screenManager.docBottom,c);j(d,b)},scrollToPosition:function(d,c,b){c=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,c);c=d.screenManager.getFirstEmptySpaceBeforeHeight(c);b=d.screenManager.findNextScreen(b&&
c<=d.screenManager.minDocTop?0:c);h(d,b)},matchFrames:function(d,c){var b=d.screenManager.getFirstReadingPositionAtHeight(d.currentTopOfScreen),g=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,b)-d.currentTopOfScreen,a=d.currentBottomOfScreen-d.currentTopOfScreen,b=c.screenManager.getTopOfNodeAtPosition(c.contentDocument,b);c.currentTopOfScreen=b-g;c.currentBottomOfScreen=c.currentTopOfScreen+a;e(c)},getApproximateNumPreviousScreens:function(d){var c=d.writingMode.height($(d).parent());
return(d.currentTopOfScreen-d.screenManager.minDocTop)/c},getApproximateNumNextScreens:function(d){var c=d.writingMode.height($(d).parent());return(d.screenManager.maxDocTop-d.currentBottomOfScreen)/c},getCurrentPagePositionRange:function(d){var c=d.screenManager.getFirstReadingPositionAtHeight(d.currentTopOfScreen),d=d.screenManager.getFirstReadingPositionAtHeight(d.currentBottomOfScreen)-1;return{currentTopOfPage:c,currentBottomOfPage:d}},hasPreviousScreen:function(d){return d.screenManager.hasPreviousScreen(d.currentTopOfScreen)},
hasNextScreen:function(d){return d.screenManager.hasNextScreen(d.currentBottomOfScreen)},isPreviousFullScreen:function(d,c){var b=d.screenManager.findPreviousScreen(d.currentTopOfScreen,c);return b!==null?d.screenManager.hasPreviousScreen(b.topOfScreen):!1},isNextFullScreen:function(d){var c=d.screenManager.findNextScreen(d.currentBottomOfScreen);return c!==null?d.screenManager.hasNextScreen(c.bottomOfScreen):!1},nextScreen:function(d,c){var b=d.screenManager.findNextScreen(d.currentBottomOfScreen);
return b!==null&&(c||d.screenManager.hasNextScreen(b.bottomOfScreen))?(h(d,b),!0):!1},previousScreen:function(d,c,b){b=d.screenManager.findPreviousScreen(d.currentTopOfScreen,b);return b!==null&&(c||d.screenManager.hasPreviousScreen(b.topOfScreen))?(j(d,b),!0):!1},getWordMap:function(d){return d.screenManager.wordMap},copyIframe:function(d,c){c.screenManager=d.screenManager;c.writingMode=d.writingMode;c.currentTopOfScreen=d.currentTopOfScreen;c.currentBottomOfScreen=d.currentBottomOfScreen;c.writingMode.resetIframeDimensions(c)},
getSelectableItemBoundariesForCurrentScreen:function(d){for(var c=KindlePaginator.getCurrentPagePositionRange(d),b=d.screenManager.wordMap,g=c.currentBottomOfPage,a={},c=c.currentTopOfPage;c<=g;++c){var f=b[c]&&b[c].rects;if(f!==void 0){var e=b[c].selectableRects;e!==void 0&&(f=e);a[c]=d.writingMode.getRectBoundariesForScreen(f,d.currentTopOfScreen)}}return a},getWordPositionsForCurrentScreen:function(d){var c=KindlePaginator.getCurrentPagePositionRange(d),d=d.screenManager.wordPositions,b=c.currentTopOfPage,
g=c.currentBottomOfPage,c=null;if(d&&d.length>0){var a=KindleListUtilities.binarySearch(d,b),g=KindleListUtilities.binarySearch(d,g,void 0,a);d[a]<b&&++a;c=[];for(b=a;b<=g;++b)c.push(d[b])}return c},isPointOnVisiblePage:function(d,c,b){var g=d.writingMode.height(d),a=d.writingMode.height(d.pageOverflowDiv);return d.writingMode.isPointOnVisiblePage(g,a,c,b)},showEndOfDocument:function(d){d.currentTopOfScreen=d.currentBottomOfScreen;e(d)},isIframePaginationValid:function(d){var c=d.screenManager.validationData;
if(c){var b=d.contentDocument.body,g=c.bodyDimensions,d=$(d).parent(),a=window.navigator.userAgent.indexOf("MSIE")!==-1;if(b.offsetHeight===g.height&&b.offsetWidth===g.width||b.offsetHeight<=d.height()&&b.offsetWidth<=d.width())return!0;else if(a&&(g=Math.abs(b.offsetHeight-g.height),b.offsetWidth===b.offsetWidth&&g<80))return!0;b=b.lastElementChild;return(c=c.lastElementPos)&&b?(d=$(b),b=d.offset(),g=d.width(),d=d.height(),b.top===c.top&&b.left===c.left&&g===c.width&&d===c.height):!1}return!0},clearIframePaginationValidation:function(d){d.screenManager.validationData=
null},cleanupIframe:function(d){d.screenManager=null}}}(),KindlePaginatorScreenFragmentation=function(h,j,e,d,c,b,g,a){function f(a){c.addBoundsForPosition(h,j,a,g)}function k(a){a.hasNextScreen=function(a){return this.maxDocTop>=a};a.hasPreviousScreen=function(a){return a>this.minDocTop};a.getFirstReadingPositionAtHeight=function(a){if(this.nodeHeightRanges.length===0)return null;var b;a:{for(var c=this.nodeHeightRanges,d=a;d<c.length;d+=1)if(b=c[d],b!==void 0&&b!==l&&b!==o&&b!==q){b=Math.abs(b);
break a}b=this.maxPosition+1}f(b);if(this.wordMap[b]===void 0)return b;c=g.unionRect(this.wordMap[b].rects);for(d=b;d>=this.minPosition;d--)if(f(d),this.wordMap[d]!==void 0){var e=g.unionRect(this.wordMap[d].rects);if(g.checkIfRectsOnSameLine(e,c)||e.top>=a)b=d;else break}return b};a.getFirstEmptySpaceBeforeHeight=function(a){for(var b,c=a;c>=0;c-=1)if(b=this.nodeHeightRanges[c],b===void 0||b===l)return c;return a};a.getTopOfNodeAtPosition=function(a,b){if(b<this.minPosition)return this.minDocTop;
if(b>this.maxPosition)return this.maxDocTop;for(;b<=this.maxPosition;){f(b);var c=this.wordMap[b];if(c){for(var c=c.rects,d=Infinity,e=0;e<c.length;e++){var h=g.clientRectTop(c[e]);h<d&&(d=h)}return Math.round(d)}b+=1}return this.minDocTop};a.findBestPaginationNearBottom=function(a,b){var c=this.nodeHeightRanges[b];return c!==void 0&&(f(c),c=this.wordMap[c]&&this.wordMap[c].rects,c!==void 0&&(c=Math.floor(g.clientRectTop(c[0])+1),a<=c&&c<b))?c:b-1};a.findBestPaginationNearTop=function(a,b){var c=
this.nodeHeightRanges[a];return c!==void 0&&(c<0&&(c=-c),f(c),c=this.wordMap[c]&&this.wordMap[c].rects,c!==void 0&&(c=Math.floor(g.clientRectBottom(c[c.length-1])),a<c&&c<=b))?c:a+1};a.findNextScreen=function(a){if(this.nodeHeightRanges.length===0||!this.hasNextScreen(a))return null;var c=this.nodeHeightRanges.length;if(a!==0&&this.nodeHeightRanges[a]!==l)for(var d=a+1;d<=c&&this.nodeHeightRanges[d]===void 0;)a=d++;for(var f=a,g=d=0,e=!1,h=!1,k,g=a;g<=c;g+=1)if(d+=1,k=this.nodeHeightRanges[g],k===
void 0?(f=g,h=e):k!==l&&(e=!0),k===l&&g>a){d=g-a;h=e;break}else if(d>=b){f===a&&(f=this.findBestPaginationNearBottom(a+1,a+b-1),h=e);d=f-a;break}f={topOfScreen:a,bottomOfScreen:0};g<c?f.bottomOfScreen=a+d:(f.bottomOfScreen=g,h=e);return!h?g<c?this.findNextScreen(f.bottomOfScreen):null:f};a.findPreviousScreen=function(a,c){if(this.nodeHeightRanges.length===0||!this.hasPreviousScreen(a))return null;for(var d=a,f=0,g=0,e,h=!1,k=!1,j=a,m=a,q=0,g=a;g>=0;g-=1)if(f+=1,e=this.nodeHeightRanges[g],e===void 0?
(d=g,k=h,m=j,h||++q):e!==l&&(h=!0,j=g),e===l&&g<a){if(h)return this.findNextScreen(g);q=f=0;m=j=d=a=g}else if(f>=b){d===a&&(m=this.findBestPaginationNearTop(a-b,a-1),k=h);break}d=m-1;if(d<=this.minDocTop)if(d=this.findNextScreen(c||this.minDocTop<=1?0:this.minDocTop-1),d.bottomOfScreen>=a-q)return d;else d=d.bottomOfScreen;result={topOfScreen:d,bottomOfScreen:a};return!k?g>0?this.findPreviousScreen(result.topOfScreen,c):null:result}}var m=KindlePaginatorHeightMapGenerator.getHeightMapTags(),l=m.HARD_PAGE_BREAK,
o=m.HORIZONTAL_RULE,q=m.BORDER_HEIGHT,n=function(a){var b=[],c;for(c in a){var d=parseInt(c,10);b.push(d)}b.sort(function(a,b){return a-b});return b}(j);if(d&&d.length)rects=d;else{rects=[];for(m=0;m<n.length;++m){var r=n[m],s=j[r].rects,t=j[r].fontSize,u;for(u in s)rects.push({position:r,rect:s[u],fontSize:t})}}KindlePaginatorHeightMapGenerator.createHeightMap(h,g,rects,function(b){b.wordMap=j;b.lineRects=d;b.wordPositions=e;b.wordMapKeys=n;b.wordMapGenerator=c;if(n.length>0)b.minPosition=n[0],b.maxPosition=
n[n.length-1];k(b);a(b)})},KindleRendererWordMapGeneratorFactory=function(){function h(a,b){if(a&&a.getComputedStyle)return a.getComputedStyle(b)}function j(a,b){for(var c=[],d=0;d<a.length;++d){var f=a[d];b.clientRectWidth(f)>1&&c.push(f)}return c}function e(a,b,c,d){b&&c>=0&&a.push({rect:b,position:c,fontSize:d})}function d(a){if(a<128)return 1;else if(a<2048)return 2;else if(a>=55296&&a<=57343)return 2;return 3}function c(a,b){a.fontSize=b&&parseInt(b.fontSize,10)||0;a.hasTextEmphasis=b?b.webkitTextEmphasisStyle&&
b.webkitTextEmphasisStyle!=="none":!1;if(a.domChildIndex===void 0)for(var c=a.parentNode.firstChild,d=0;c;){if(c.nodeType===Node.TEXT_NODE)c.domChildIndex=d;c=c.nextSibling;++d}}function b(a,c){if(KindleRendererSettings.getSettings().fixedContent){var d=a.className;if(d&&d.match(s))return}if(!(a.tagName==="RT"||a.tagName==="RP"))if(a.nodeType===Node.TEXT_NODE||a.tagName==="IMG")c.push(a);else for(var d=a.childNodes,f=d.length,g=0;g<f;g+=1)b(d[g],c)}function g(a){var c=[];b(a,c);return c}function a(a){if(window.ActiveXObject&&
window.XMLHttpRequest)return g(a.body);else try{var b=(new XPathEvaluator).evaluate("/html/body//text()[not(ancestor::ruby)] | //img[not(ancestor::ruby)] | //ruby",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),c;if(b.invalidIteratorState)c=g(a.body);else{for(var d=[],f=b.iterateNext();f;)d.push(f),f=b.iterateNext();c=d}return c}catch(e){return g(a.body)}}function f(a){a.addElementsToWordMap=function(a,b,c,d,f,g,e){function h(){k.addElementsToWordMap(a,b,c+1,d,f,g,e)}var k=this;KindleRendererProcessTuning.startingOperation("ScreenManager");
for(var j=0;c<b.length;){var m=b[c],l=m.id,m=k.getValueForNode(a,m,g);m!==null&&(f[l]=m);j+=1;if(j>=d.interval){KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(h,d.time);return}c+=1}KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(function(){e.resolve(f,[],null,0)},d.time)};a.getPositionDataForNode=function(a,b,c){a=a[b+"_"+c];return a===void 0||a.length===0?null:a};a.getNodeId=function(a){var b=a.parentNode,c=b.getAttribute(r),d=0;if(a.ownChildIndex===
void 0)for(;b.childNodes[d]!==a;)d+=1;else d=a.ownChildIndex;return{parentId:c,index:d}};a.getAllBaseNodesInRuby=function(a){a=(new XPathEvaluator).evaluate(".//text()[not(ancestor::rt or ancestor::rp)] | .//img[not(ancestor::rt or ancestor::rp)]",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(!a.invalidIteratorState){for(var b=[],c=a.iterateNext();c;)c.nodeType===Node.TEXT_NODE&&c.nodeValue.trim().length===0||b.push(c),c=a.iterateNext();return b}};a.addRubyNodeToWordMap=function(a,b,d,f,
g,k,j,m){for(var l=this.getAllBaseNodesInRuby(a),q,n=[],o,r=0;r<l.length;++r)o=l[r],o.deltaX=a.deltaX,o.isRuby=!0,o.nodeType===Node.TEXT_NODE?(q=h(d,o.parentNode),c(o,q),(q=this.addTextNodeToWordMap(this.getNodeId(o),o,b,d,f,g,j))&&this.addTextNodeToLineRects(o,k,g,q,j,m)):(q=h(d,o),o.fontSize=q?parseInt(q.fontSize,10):0,(q=this.addImageNodeToWordMap(o,f,g,j))&&e(k,g[q[0]].rects[0],q[0])),q&&q.length>0&&(n=n.concat(q));return n}}function k(a){a.addTextNodeToWordMap=function(a,b,c,d,f,g,e){var h=b.nodeValue;
if(h&&h.trim().length>0&&(f=this.getPositionDataForNode(f,a.parentId,a.index))){var k=f.length-1,j,m=0,l;a:{l=b;for(var q=0;q<2;q++)if(l.parentNode)if(l.parentNode.getAttribute("data-isTextCombineBlock"))break a;else l=l.parentNode;l=null}if(l){if(l.deltaX===void 0)l.deltaX=e.getDeltaX(l,c);l.parentNode.deltaX=l.deltaX;if(j=this.getValueForNode(d,l.parentNode,e))return m=f[0][1],g[m]=j,[m]}d=0;l=d<k?f[d+1][0]:Infinity;for(var n=m=q=0,o=h.length,r=[],t=0;t<=o;t++)if(j=h.charCodeAt(t),j<128?q+=1:j<
2048?q+=2:j>=55296&&j<=57343?(n+=1,q+=2):q+=3,j=j<=32||j===45,t<o){if(!j){if(n===0)j=this.getValueForWord(c,b,t,t+1,j,a.parentId,e);else if(n===1)continue;else n=0,j=this.getValueForWord(c,b,t-1,t+1,j,a.parentId,e);if(j!==null){for(;m>=l;)d++,l=d<k?f[d+1][0]:Infinity;m=f[d][1]+(m-f[d][0]);g[m]=j;r.push(m)}}m=q}return r}}}function m(a){a.addTextNodeToWordMap=function(a,b,c,d,f,g,e){if((d=b.nodeValue)&&d.trim().length>0)if(f=this.getPositionDataForNode(f,a.parentId,a.index)){for(var h=f.length-1,k=
0,j=k<h?f[k+1][0]:Infinity,m=0,l=0,q=0,m=0,n=d.length,o=[],r=0;r<=n;r++){var t=d.charCodeAt(r);l+=t<128?1:t<2048?2:t>=55296&&t<=57343?2:3;t=t<=32||t===45||t===8212;if(r===n||t){q=this.getValueForWord(c,b,q,r,t,a.parentId,e);if(q!==null){for(;m>=j;)k++,j=k<h?f[k+1][0]:Infinity;m=f[k][1]+(m-f[k][0]);g[m]=q;o.push(m)}q=r+1;m=l}}return o}}}function l(b){b.getValueForWord=function(a,b,c,d,f,g){return d>c?{startOffset:c,endOffset:d,childIndex:b.domChildIndex,fontSize:b.fontSize,dataNid:g}:null};b.getValueForNode=
function(a,b,c){var d=b.getClientRects();if(KindleRendererDeviceSpecific.clientRectsExpire()){for(var f=[],g=0;g<d.length;++g)f.push({top:d[g].top,left:d[g].left,bottom:d[g].bottom,right:d[g].right,width:d[g].width,height:d[g].height});d=f}if(d&&d.length>0){c={rects:c.getTransformedClientRects(d,b)};if(b.tagName==="span")a=h(a,b),c.fontSize=a?parseInt(a.fontSize,10):void 0;c.dataNid=b.getAttribute(r);return c}return null};b.getValueForImage=function(a,b){if(a.getClientRects){var c=a.getClientRects();
if(c&&c.length>0)return c=this.getBoundingAndSelectableRects(a,c,b),{selectableRects:c.selectableRects,rects:c.boundingRects,dataNid:a.getAttribute(r)}}return null};b.getValueForWhitespace=function(a,b,c){b=b.createRange();b.setStart(a,0);b.setEnd(a,a.length);return b.getClientRects?(b=b.getClientRects(),this.getBoundingAndSelectableRects(a,b,c).boundingRects):null};b.getBoundingAndSelectableRects=function(a,b,c){var d=void 0,b=c.getTransformedClientRects(b,a),d=a.hasTextEmphasis||a.isRuby?c.getRectsAdjustedForAnnotationMarks(b,
a.fontSize):b;return{boundingRects:d,selectableRects:b}};b.addBoundsForPosition=function(a,b,c,d,f){var g=b[c];if(g&&g.rects===void 0)f=f||$("["+r+'="'+g.dataNid+'"]',a).contents()[g.childIndex],a=a.createRange(),a.setStart(f,g.startOffset),a.setEnd(f,g.endOffset),(a=a.getClientRects())&&a.length>0?(a=this.getBoundingAndSelectableRects(f,a,d),g.selectableRects=a.selectableRects,g.rects=a.boundingRects):delete b[c]};b.getNextValidPositionIndexInNode=function(a,b,c,d,f,g){for(var e;e===void 0&&c<b.length;)e=
b[c],this.addBoundsForPosition(f,d,e,g,a),e=d[e],++c;return e===void 0?-1:--c};b.addTextNodeToLineRects=function(a,b,c,d,f){if(d.length!==0){var g=a.ownerDocument,h=g.createRange();h.selectNode(a);var k=this.getBoundingAndSelectableRects(a,j(h.getClientRects(),f),f).boundingRects,m=k.length,l=a.fontSize,q=0.25*l;if(m===1)e(b,k[0],d[0],l);else if(m>1){var n;if(d.length===1)for(n=0;n<m;n++)e(b,k[n],d[0],l);else{var o=a.nodeValue.length,r=0;for(n=0;n<m;++n)r+=f.clientRectWidth(k[n]);var o=r/o,t=r=!1,
s=this.getNextValidPositionIndexInNode(a,d,0,c,g,f);if(!(s<0)){var J=s,O=d[J],C=c[O],E=C.endOffset-C.startOffset,O=C.rects.length,N=0;for(n=0;n<m;++n)if(N<O-1)Math.abs(f.clientRectTop(C.rects[N])-f.clientRectTop(k[n]))<q&&(e(b,k[n],d[s],l),++N);else if(N=Math.min(N,O-1),Math.abs(f.clientRectTop(C.rects[N])-f.clientRectTop(k[n]))<q){var P=f.clientRectWidth(k[n]),P=Math.round(P/o);f.clientRectLeft(C.rects[N]);for(f.clientRectLeft(k[n]);J<d.length-1&&E<P;)++J,C=c[d[J]],E+=C.endOffset-C.startOffset;if(s===
J&&(++J,J>=d.length)){e(b,k[n],d[s],l);break}for(h.setStart(a,c[d[s]].startOffset);;)if(h.setEnd(a,c[d[J]].endOffset),C=j(h.getClientRects(),f),C.length>O){if(J<=0)break;--J;if(t)break;r=!0}else if(C.length===O){if(r||J>=d.length-1)break;++J;t=!0}else break;e(b,k[n],d[s],l);if(J>=d.length-1)break;r=t=!1;s=this.getNextValidPositionIndexInNode(a,d,J+1,c,g,f);if(s<0)break;J=s;O=d[J];C=c[O];E=C.endOffset-C.startOffset;O=C.rects.length;N=0;Math.abs(f.clientRectTop(C.rects[0])-f.clientRectTop(k[n]))<q&&
++N}}}}}};b.createBoundsWordMap=function(b,c,d,f,g,e,h){var k=new jQuery.Deferred,j={};d.posMap===void 0||$.isEmptyObject(d.posMap)?this.createWordMapFromElements(b,c,j,f,k):d.posMap!==null?(g={interval:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),metrics:h||KindleMetricsProfiler("wordMap"),requestId:g,processingRequest:e},this.createWordMapFromNodeList(0,a(b),b,c,d,j,[],f,g,k)):k.resolve(j,[],[],0);return k.promise()};
b.computeAllWordRects=function(a,b,c,d,f,g){function e(){if(f.requestId===f.computingRectsId.id){KindleRendererProcessTuning.startingOperation("WordMapGen");for(var n=0;m<c.length;++m){if((j=b[c[m]])&&j.rects===void 0){if(j.dataNid!==k.dataNid||j.childIndex!==k.childIndex)h=$("["+r+'="'+j.dataNid+'"]',a).contents()[j.childIndex];k=j;l.setStart(h,j.startOffset);l.setEnd(h,j.endOffset);var o=l.getClientRects();o&&o.length>0?(o=q.getBoundingAndSelectableRects(h,o,d),j.selectableRects=o.selectableRects,
j.rects=o.boundingRects):delete b[c[m]];++n}if(n>=f.frequency){KindleRendererProcessTuning.endingOperation("WordMapGen",n);setTimeout(e,f.time);return}}KindleRendererProcessTuning.endingOperation("WordMapGen",n)}g.resolve()}var h,k={},j,m=0,l=a.createRange(),q=this;l.getClientRects?e():g.resolve()};b.addImageNodeToWordMap=function(a,b,c,d){d=this.getValueForImage(a,d);if(d!==null&&(a=a.getAttribute(r),a!==null))return b=b[a],c[b[0][1]]=d,[b[0][1]]};b.createWordMapFromElements=function(a,b,c,d,f){var g=
[],g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("IMG"))),g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("CANVAS"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4w"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4wc"))),a={interval:KindleRendererProcessTuning.drawYieldFrequency("ScreenManager"),time:KindleRendererProcessTuning.drawYieldUpdateTime("ScreenManager")};this.addElementsToWordMap(b,g,0,a,c,d,f)};b.createWordMapFromNodeList=
function(a,b,d,f,g,k,j,m,l,q){function n(){l.requestId===l.processingRequest.id&&o.createWordMapFromNodeList(a+1,b,d,f,g,k,j,m,l,q)}var o=this;KindleRendererProcessTuning.startingOperation("WordMapGen");var r=0,t=b.length,s=null,H=l.numPositionsAdded||0,J=g.wordList&&g.wordList.length;if(J&&!g.imageList)g.imageList=[];for(var O=g.imageList,C,E=l.metrics.createSubTimer("text counters (timeless)");a<t;){var N=b[a],P=k;N.deltaX=m.getDeltaX(N,d);if(N.nodeType===Node.TEXT_NODE)(C=h(f,N.parentNode))&&C.display===
"none"||(c(N,C),s=o.getNodeId(N),s=o.addTextNodeToWordMap(s,N,d,f,g.posMap,k,m),s===void 0?(s=[],P=[{rects:o.getValueForWhitespace(N,d,m)}]):this.addTextNodeToLineRects(N,j,k,s,m,E));else if(N.tagName==="IMG"){if(C=h(f,N),N.fontSize=C?parseInt(C.fontSize,10):0,s=o.addImageNodeToWordMap(N,g.posMap,k,m))e(j,k[s[0]].rects[0],s[0]),J&&O.push(s[0])}else s=o.addRubyNodeToWordMap(N,d,f,g.posMap,k,j,m,E);s&&s.length&&(H+=s.length,KindleRendererContentCorrection.applyNodeLocalCorrections(N,s,P,f,m,l.metrics));
++r;if(r>=l.interval){l.numPositionsAdded=H;KindleRendererProcessTuning.endingOperation("WordMapGen",r);setTimeout(n,l.time);return}++a}t=J?KindleListUtilities.sortedMerge(g.wordList,O):[];delete g.imageList;KindleRendererProcessTuning.endingOperation("WordMapGen",r);q.resolve(k,t,j,H)}}function o(a){a.getValueForWord=function(a,b,c,d,f){return d>c?(a=b.nodeValue,c={text:a.substr(c,f?d-c+1:d-c)},d===a.length&&(c.text+=this.WORD_DELIMITER),c):null};a.findSibling=function(a){return a&&a.nodeType!==
Node.DOCUMENT_NODE?a.nextSibling?a.nextSibling:this.findSibling(a.parentNode):null};a.getValueForNode=function(a,b){if(b.tagName!=="IMG"){var c=b.textContent;if(!/\s/.test(c[c.length-1])){var d=this.findSibling(b);d&&d.className!=="k4w"&&(c+=" ")}return{text:c}}return null};a.getValueForImage=function(){return null};a.WORD_DELIMITER=KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?" ":"";a.createTextWordMap=function(a,b){var c=new jQuery.Deferred,d={},f,e,h,k,j;if(b.posMap===void 0){k=
$(a).find("CANVAS,.k4w,.k4wc");k=$.makeArray(k);j=k.length;for(f=0;f<j;f++)h=k[f],e=h.id,h=this.getValueForNode(null,h),h!==null&&(d[e]=h)}else if(b.posMap!==null){k=g(a);j=k.length;for(f=0;f<j;f++)h=k[f],h.nodeType===Node.TEXT_NODE&&(e=this.getNodeId(h),this.addTextNodeToWordMap(e,h,null,null,b.posMap,d))}c.resolve(d);return c.promise()}}function q(a,b){a.createWordMap=function(a,c,d,f,g,e,h){return b.createBoundsWordMap(a,c,d,f,g,e,h)};a.addBoundsForPosition=function(a,c,d,f,g){b.addBoundsForPosition(a,
c,d,f,g)};a.computeWordRects=function(a,c,d,f,g,e,h,k){var j=new jQuery.Deferred;g==="mobi8"&&d&&d.length>0?(g={frequency:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),requestId:e,computingRectsId:h},b.computeAllWordRects(a,c,d,f,g,j,k)):j.resolve();return j.promise()}}function n(a,b){a.createWordMap=function(a,c){return b.createTextWordMap(a,c)}}var r="data-nid",s=/(?=.*target)(?=.*mag)/i;return{buildWordMapGeneratorForWordBounds:function(){var a=
{},b={};f(a);l(a);q(b,a);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?m(a):k(a);return b},buildWordMapGeneratorForWordText:function(){var a={},b={};f(a);o(a);n(b,a);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?m(a):k(a);return b},countUTF8Bytes:function(a){return d(a)}}}(),KindleRegionAnnotationRenderer=function(){function h(c,b){return c.contentDocument.querySelectorAll("mark[annotationType"+(b?'="'+b.type+'"':"")+"][annotationStart"+(b?'="'+b.start+'"':"")+"]")}
function j(c,b,d){var a,f;if(!c||!b||parseInt(c.id,10)>parseInt(b.id,10)||c.tagName==="MARK"||b.tagName==="MARK")throw"Insertion of <mark> tags failed.";if(c.parentNode===b.parentNode){d=d();a=b.nextSibling;f=c.parentNode;var e=c;do c=e,e=c.nextSibling,f.removeChild(c),d.appendChild(c);while(c!==b);f.insertBefore(d,a)}else KindleRendererUtils.treeDepth(c)>KindleRendererUtils.treeDepth(b)?c.previousElementSibling||KindleRendererUtils.isBlock(c.parentNode)?(a=KindleRendererUtils.previousPositionedNode(c.parentNode),
f=KindleRendererUtils.nextPositionedNode(KindleRendererUtils.followingNode(c.parentNode)),j(c,a,d),j(f,b,d)):j(c.parentNode,b,d):b.nextElementSibling||KindleRendererUtils.isBlock(b.parentNode)?(a=KindleRendererUtils.previousPositionedNode(KindleRendererUtils.precedingNode(b.parentNode)),f=KindleRendererUtils.nextPositionedNode(b.parentNode),j(c,a,d),j(f,b,d)):j(c,b.parentNode,d)}function e(c,b,d){var a=c.contentDocument,c=KindleRendererUtils.findElementAtOrAfterPosition(a,b.start),f=KindleRendererUtils.findElementAtOrBeforePosition(a,
b.end);try{j(c,f,function(){var c=a.createElement("mark");c.className=d;c.setAttribute("annotationType",b.type);c.setAttribute("annotationStart",b.start);return c})}catch(e){}}function d(c,b){for(var d=Array.prototype.slice.call(b),a=0;a<d.length;a++){var f=d[a],e=f.getAttribute("annotationType");if(e==="kindle.highlight"||e==="kindle.search"){for(var e=c.createDocumentFragment(),h=f.firstChild,j;h;)j=h.nextSibling,f.removeChild(h),e.appendChild(h),h=j;h=f.parentNode;j=f.nextSibling;h.removeChild(f);
h.insertBefore(e,j)}else f.parentNode.removeChild(f)}}return{createAnnotationElements:function(c,b){var d;for(d=0;d<b.length;d++){var a=b[d];if(a.type==="kindle.highlight")e(c,a,"highlight");else if(a.type==="kindle.note"){var f=c.contentDocument,k=f.createElement("div");k.className="note-icon";var j=f.createElement("mark");j.className="note";j.setAttribute("annotationType",a.type);j.setAttribute("annotationStart",a.start);j.setAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE,
"true");j.appendChild(k);a=KindleRendererUtils.findElementAtOrBeforePosition(f,a.start);a.parentNode.insertBefore(j,a.nextSibling)}else a.type==="kindle.search"&&(j=c,h(j,a).length>0||e(j,a,"search-result"))}},removeAnnotationElements:function(c,b){d(c.contentDocument,h(c,b))},removeAllAnnotationElements:function(c){d(c.contentDocument,h(c))}}}(),KindleRegionContentManager=function(){function h(b){if(n||r){if(b<=k)throw{name:"pagingError",message:"Repeating wait request"};k=b;f<0&&a.waitNotification&&
a.waitNotification();f=b}}function j(b){if((n||r)&&f>=0&&f<=b)t=0,f=-1,r&&(n=!0,r=!1),a.readyNotification&&a.readyNotification(),a.rectsReadyNotification&&a.rectsReadyNotification()}function e(b,c,d){f<=b&&(c!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&t<s?(++t,g(d)):(a.errorNotification&&a.errorNotification(c),f=-1))}function d(a){a=l.gotoPosition(a);if(!a){var b=l.getCurrentProcessId();h(b);l.getCurrentProcessDfd().then(function(){j(b)},function(a){e(b,a)})}return a}function c(){try{var a=
l.nextScreen();if(!a){var b=l.getCurrentProcessId();h(b);l.getCurrentProcessDfd().then(function(){c();j(b)},function(a){e(b,a,0)})}return a}catch(d){return KindleDebug.breakPt(),g(),!1}}function b(){try{var a=l.previousScreen();if(!a){var c=l.getCurrentProcessId();h(c);l.getCurrentProcessDfd().then(function(){b();j(c)},function(a){e(c,a,0)})}return a}catch(d){return KindleDebug.breakPt(),g(),!1}}function g(){var a=l.getPagePositionRange();if(a!==null)o=a.currentTopOfPage;l.reloadNotification();d(o)}
var a={},f=-1,k=-1,m=null,l=null,o=0,q,n=!0,r=!1,s=3,t=0;return{initialize:function(b,c,d){m=b;a=c;q=d;o=void 0;l=KindleRendererIframeManagerFactory.build(m);l.setOverlayManager(q);l.setAnnotationEventCallback(a.annotationTriggered)},cleanup:function(){},hide:function(){r=n=!1},show:function(){r=!0},updateSettings:function(a){l.updateSettings(a)},gotoPosition:function(a){return d(a,0)},nextScreen:function(){return c()},previousScreen:function(){return b()},hasNextScreen:function(){return l.hasNextScreen()},
hasPreviousScreen:function(){return l.hasPreviousScreen()},getPagePositionRange:function(){return l.getPagePositionRange()},getSelectableItemBoundaries:function(){return null},getWordPositions:function(){return null},onWindowResize:function(){l.resizeNotification()},handleClick:function(){},reloadAnnotations:function(){l&&l.reloadAnnotations()},getZoomableAt:function(){return null},getZoomableList:function(){return[]},clearSelection:function(){l.clearSelection()},getSelection:function(){return l.getSelection()}}}(),
KindleRegionIframeManager=function(){function h(g){g.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};g.createNewRequest=function(a,b){this.cancelCurrentRequest();this.currentRequest={type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("renderer-iframe-load"),retryCount:0,initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};g.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};
g.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<b:!0};g.calculateIframePaginationData=function(a,b,d){var g=this,e=KindleRendererFragmentLoader.getBookContentType()==="topaz"?g.currentRequest.type?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,g.currentRequest,b,d,e).then(function(b){if(a.processingRequestId.id===
b.requestId&&g.currentRequest&&g.currentRequest.requestId===b.requestId)a.processingRequestId.id=null,g.frameIsLoadedAndReady(a);g=null},function(a){g.currentRequest&&a&&g.currentRequest.requestId===a.requestId&&g.currentRequestDfd.reject(c);g=null})};g.loadContentDataIntoIframe=function(a){var b=this;b.currentRequest.contentLoadMetrics=b.currentRequest.metrics.createSubTimer("content-load");b.contentRange[this.hiddenIframeIndex]=a.contentRange;var c=this.iframes[this.hiddenIframeIndex];c.processingRequestId.id=
b.currentRequest.requestId;KindleRendererIframeLoading.loadIframe(c,b.currentRequest,a).then(function(g,e){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),g.type,function(){if(c.processingRequestId.id===g.requestId&&b.currentRequest&&b.currentRequest.requestId===g.requestId){b.positionData[b.hiddenIframeIndex]=e.positionData;var h=b.getViewportDimensions(c);b.regionManagers[b.hiddenIframeIndex].computeFilledRegionNodes();b.ensureElementsWillFit(c,
h,b.currentRequest.contentLoadMetrics).then(function(){b.currentRequest.contentLoadMetrics.endTimer();b.calculateIframePaginationData(c,a,e);(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&b.addSelectionListener(c);b=null},function(){b.currentRequest&&b.currentRequestDfd.reject(d);b=null})}else b=null})},function(){b.currentRequest&&b.currentRequestDfd.reject(d)})};g.ensureElementsWillFit=function(a,b,c){a.writingMode.scrollToTopOfDocument(a);a.writingMode.resetHeight(a);var d=
a.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var g=parseInt($(d).css("margin-top"),10),e=parseInt($(d).css("margin-bottom"),10);d.style.height=parseInt(b.height,10)-g-e+"px"}g=d.getElementsByClassName("k4w-margin");for(e=0;e<g.length;e+=1){var h=parseInt(g[e].getAttribute("vertical"),10);if(h>0)g[e].style.marginTop=Math.round(h*0.01*b.height)+"px"}return KindleRendererElementFitting.fitToViewport(d,a.writingMode,b,c)};
g.annotationClickedHandler=function(a){if(this.annotationEventCallback!==void 0){var b=a.currentTarget.parentNode,a=b.getAttribute("annotationType"),b=b.getAttribute("annotationStart");this.annotationEventCallback(a,b)}};g.renderAnnotations=function(a,b){a&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(a);if(this.overlayManager){var c=this.overlayManager.getOverlaysInRange(b.startPosition,b.endPosition);c&&c.length>0&&this.createAnnotationElements(a,c)}};g.frameIsLoadedAndReady=function(a){var b=
this.currentRequest;this.iframeLoadStatus[a.index]=b.type;this.renderAnnotations(a,this.contentRange[a.index]);b&&b.initialPosition!==null&&(this.regionManagers[a.index].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:b.initialPosition}),a===this.iframes[this.hiddenIframeIndex]&&(this.swapIframes(),this.updateDisplayedPositionsInPage()));b.metrics.addCount("Success",1);b.metrics.endTimer();b.metrics.log();this.currentRequest=null;setTimeout(this.currentRequestDfd.resolve,
10);b.type===this.loadedType.GOTO_POSITION&&this.considerLoadingMoreFragments()};g.loadFragmentsForRange=function(a){var b=this;KindleRendererFragmentLoader.loadFragments(a,b.currentRequest).then(function(a,c){b.currentRequest&&b.currentRequest.requestId===a.requestId&&b.loadContentDataIntoIframe(c);b=null},function(a,c){b.currentRequest&&b.currentRequest.requestId===c.requestId&&b.currentRequestDfd.reject(e);b=null})};g.gotoPosition=function(a){var b=this.iframes[this.visibleIframeIndex];b&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(b);
this.createNewRequest(this.loadedType.GOTO_POSITION,a);a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(a);if(KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],a))return this.loadFragmentsForRange(a),!1;else this.frameIsLoadedAndReady(this.iframes[this.visibleIframeIndex]);return!0};g.setIframeVisibility=function(a,b){b?this.regionManagers[a].show():this.regionManagers[a].hide()};g.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=
this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var a=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;this.hiddenIframeIndex=a;this.setIframeVisibility(this.visibleIframeIndex,!0);this.setIframeVisibility(this.hiddenIframeIndex,!1)};g.getPagePositionRange=
function(){return this.regionManagers[this.visibleIframeIndex].getPagePositionRange()};g.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};g.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==
this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var a=this.contentRange[this.visibleIframeIndex].endPosition+1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,b);this.createNewRequest(this.loadedType.NEXT,null);this.loadFragmentsForRange(a)}};g.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==
this.loadedType.PREVIOUS)){var a=this.contentRange[this.visibleIframeIndex].startPosition-1,b=this.getPagePositionRange(),a=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(a,b);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(a)}};g.considerLoadingMoreFragments=function(a){if(this.canPreloadNext){var b=a!==this.direction.PREVIOUS?4:2;if(this.getApproximateNumNextScreens()<b&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&
(a=a===this.direction.PREVIOUS?4:2,this.getApproximateNumPrevScreens()<a&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};g.crossSkeletonBoundary=function(){var a=this.contentRange[this.visibleIframeIndex],b=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(a.skeletonId+1===b.skeletonId)return this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY,
!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(a.skeletonId-1===b.skeletonId)return this.swapIframes(),!0;else if(a.skeletonId!==b.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};g.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=
[null,null];this.positionData=[null,null];this.iframes=null};g.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};g.hasMorePreviousFragments=function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};g.isAtEndOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(a.skeletonId,
a.endPosition)};g.isAtBeginningOfDocumentOrSkeleton=function(){var a=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(a.skeletonId,a.startPosition)};g.getApproximateNumNextScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumNextScreens(this.isAtEndOfDocumentOrSkeleton())};g.getApproximateNumPrevScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumPrevScreens(this.isAtBeginningOfDocumentOrSkeleton())};
g.hasNextScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasNextScreen(this.isAtEndOfDocumentOrSkeleton())||this.hasMoreNextFragments()};g.hasPreviousScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasPreviousScreen(this.isAtBeginningOfDocumentOrSkeleton())||this.hasMorePreviousFragments()};g.updateDisplayedPositionsInPage=function(){var a=this.getPagePositionRange();KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentBottomOfPage-
a.currentTopOfPage)};g.considerFlippingFrames=function(){var a=this.iframeLoadStatus[this.hiddenIframeIndex];if(a!==this.loadedType.EMPTY){var b=this.getPagePositionRange(),c=this.contentRange[this.hiddenIframeIndex],d=0,g=0;a===this.loadedType.NEXT?g=1:d=1;if(b.currentTopOfPage>=c.startPosition+d&&b.currentBottomOfPage<=c.endPosition-g){b=this.regionManagers[this.hiddenIframeIndex];c=this.regionManagers[this.visibleIframeIndex].getPagePositionRange();if(a===this.loadedType.NEXT){if(a={position:c.currentBottomOfPage,
allowPartialScreen:this.isAtEndOfDocumentOrSkeleton()},a=b.updateView(KindleRegionManagerFactory.VIEW_REQUEST.NEXT_PAGE,a),!a)return this.requestMoreNextPages(),!1}else if(a={position:c.currentTopOfPage,allowPartialScreen:this.isAtBeginningOfDocumentOrSkeleton()},a=b.updateView(KindleRegionManagerFactory.VIEW_REQUEST.PREVIOUS_PAGE,a),!a)return this.requestMorePreviousPages(),!1;this.swapIframes();return!0}}return!1};g.nextScreen=function(){var a=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;
if(a&&this.considerFlippingFrames())return!0;var b=this.isAtEndOfDocumentOrSkeleton(),c=this.regionManagers[this.visibleIframeIndex].nextScreen(b);if(!c)if(this.hasMoreNextFragments())if(a&&b&&this.crossSkeletonBoundary())c=!0;else return this.requestMoreNextPages(),!1;else c=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.updateDisplayedPositionsInPage();KindleDebug.log("Next Screen Success:"+c);return c};g.requestMoreNextPages=function(){var a=this.getPagePositionRange(),b=this.contentRange[this.visibleIframeIndex];
a.currentBottomOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(b.endPosition-a.currentBottomOfPage);this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;this.loadNextPages()};g.requestMorePreviousPages=function(){var a=this.getPagePositionRange(),b=this.contentRange[this.visibleIframeIndex];a.currentTopOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.currentTopOfPage-b.startPosition);this.iframeLoadStatus[this.hiddenIframeIndex]=
this.loadedType.EMPTY;this.loadPreviousPages()};g.previousScreen=function(){KindleDebug.log("****Prev screen****");if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS&&this.considerFlippingFrames())return!0;var a=this.isAtBeginningOfDocumentOrSkeleton(),b=this.regionManagers[this.visibleIframeIndex].previousScreen(a);if(!b&&this.hasMorePreviousFragments())if(a&&this.crossSkeletonBoundary())b=!0;else return this.requestMorePreviousPages(),!1;else!b&&!this.hasMorePreviousFragments()&&
KindleDebug.error("PreviousScreen: Was not able to go to previous screen, and there is no more previous fragments.");this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.updateDisplayedPositionsInPage();return b};g.cancelHiddenIframeLoading=function(){var a=this.iframes[this.hiddenIframeIndex];if(a.processingRequestId.id!==null)a.processingRequestId.id=null,this.cancelCurrentRequest()};g.scaleElementsInIframe=function(a){var b=this.getViewportDimensions(a);if(a&&a.contentDocument&&a.contentDocument.body){a.writingMode=
KindleRendererWritingModeFactory.buildIFrameWritingMode(a);a.writingMode.resetIframeDimensions(a);var c;c=this.currentRequest&&this.currentRequest.contentLoadMetrics?this.currentRequest.contentLoadMetrics:KindleMetricsProfiler("content-load");this.ensureElementsWillFit(a,b,c).then(function(){c.endTimer()})}};g.getViewportDimensions=function(a){var b=$(this.parent).width(),c=this.numColumns-1,d=this.getMargins(this.margin),c=parseInt((b-(this.columnGap-(d.left+d.right))*c)/this.numColumns,10);return{height:$(a).parent().height(),
width:c,parentWidth:b}};g.updateSettings=function(a){var b=this.visibleIframeIndex,c=this.hiddenIframeIndex,d=this.getPagePositionRange().currentTopOfPage;if(a.columns!==void 0){if(a.columns.num!==void 0){this.numColumns=a.columns.num;this.regionManagers[b].computeFilledRegionNodes();this.scaleElementsInIframe(this.iframes[b]);var g=this;setTimeout(function(){g.regionManagers[c].computeFilledRegionNodes();g.scaleElementsInIframe(g.iframes[c]);g=null},0)}if(a.columns.gap!==void 0)this.columnGap=parseInt(a.columns.gap,
10)}if(a.margin!==void 0)this.margin=a.margin;KindleRendererIframeLoading.updateSettingsInIframe(this.iframes[b]);var e=this;setTimeout(function(){KindleRendererIframeLoading.updateSettingsInIframe(e.iframes[c]);e=null},0);d&&(this.regionManagers[b].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:d}),this.updateDisplayedPositionsInPage())};g.getMargins=function(a){if(this.parent&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");if(!b)b=document.createElement("div"),
b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),this.parent.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,bottom:0,left:0,right:0}};g.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY]};
g.resizeNotification=function(){var a=this.getPagePositionRange();this.regionManagers[this.visibleIframeIndex].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:a.currentTopOfPage});this.updateDisplayedPositionsInPage()};g.updateGlyphColorForFrameIndex=function(a){this.iframes[a].hasGlyphs&&this.iframes[a].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[a])};g.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};
g.setAnnotationEventCallback=function(a){this.annotationEventCallback=a};g.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};g.getCurrentProcessId=function(){return this.currentRequest.requestId};g.getZoomableAt=function(a,b,c){return KindleRendererZoomablesFactory.buildFromCoord(this.iframes[this.visibleIframeIndex].contentDocument,a,b,c)};g.getZoomableList=function(a){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,a)};
g.addClickHandlers=function(a){var b=this,a=$("mark["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']",a.contentDocument).children();$(a).unbind("click");$(a).click(function(a){b.annotationClickedHandler(a)})};g.createAnnotationElements=function(a,b){KindleRegionAnnotationRenderer.createAnnotationElements(a,b);this.addClickHandlers(a)};g.addAnnotation=function(a,b,c){a&&b&&c&&b.startPosition<=c.end&&c.start<=b.endPosition&&this.createAnnotationElements(a,[c])};g.removeAnnotation=
function(a,b){a&&b&&KindleRegionAnnotationRenderer.removeAnnotationElements(a,b)};g.onOverlayAdded=function(a){g.addAnnotation(g.iframes[0],g.contentRange[0],a.overlay);g.addAnnotation(g.iframes[1],g.contentRange[1],a.overlay)};g.onOverlayRemoved=function(a){g.removeAnnotation(g.iframes[0],a.overlay);g.removeAnnotation(g.iframes[1],a.overlay)};g.setOverlayManager=function(a){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),
this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=a)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved)};g.setCanPreloadNext=function(a){this.canPreloadNext=a};g.setCanPreloadPrevious=function(a){this.canPreloadPrevious=a};g.clearSelection=function(){var a=this.iframes[this.visibleIframeIndex].contentWindow;
if(this.selection)this.selection.select(),this.selection=null;a.window.getSelection&&(a.window.getSelection().empty?a.window.getSelection.empty():a.window.getSelection().removeAllRanges&&a.window.getSelection().removeAllRanges());a.document.selection&&a.document.selection.empty&&a.document.selection.empty()};g.getSelection=function(){var a=this.iframes[this.visibleIframeIndex].contentWindow,b=null,b=KindleHostDeviceDetector.getDevicePlatform(),c=null,d=this.selection;d&&d.select();if((b==="metro"||
b==="metroArm"||KindleHostDeviceDetector.isIE())&&a.document.selection)b=a.document.selection,c=this.createSelectionForIE(b);return c};g.createSelectionForIE=function(a){var b=KindleRendererDeviceSpecific.resolutionScale(),c=this.regionManagers[this.visibleIframeIndex].getOffsetTop()*b,a=a.createRange(),d=a.getClientRects(),g=d[d.length-1].width?d[d.length-1]:d[d.length-2],d=d[0],e={},h=null;a.text.indexOf(" ")!==0&&a.expand("word");e.context=a.text;h=document.createElement("div");h.innerHTML=a.htmlText;
h=this.getSelectionBoundaries(h);e.start=parseInt(h.start,10);e.end=parseInt(h.end,10);e.lowerBounds={};e.lowerBounds.right=g.right/b;e.lowerBounds.bottom=(g.bottom-c)/b;e.lowerBounds.left=g.left/b;e.lowerBounds.top=(g.top-c)/b;e.lowerBounds.width=g.width/b;e.lowerBounds.height=g.height/b;e.upperBounds={};e.upperBounds.left=d.left/b;e.upperBounds.top=(d.top-c)/b;e.upperBounds.right=d.right/b;e.upperBounds.bottom=(d.bottom-c)/b;e.upperBounds.width=d.width/b;e.upperBounds.height=d.height/b;return e};
g.getSelectionBoundaries=function(a){var b=[],c={},b=a.getElementsByTagName("canvas");if(b.length!==0)c.start=b[0].id,c.end=b[b.length-1].id;else if(b=a.getElementsByTagName("span"),b.length!==0){for(a=0;isNaN(b[a].id);)a++;c.start=b[a].id;for(a=1;isNaN(b[b.length-a].id);)a++;c.end=b[b.length-a].id}return c};g.addSelectionListener=function(a){function b(c){if(c.type==="MSPointerDown")g.addPointer(c.pointerId);else if(c.type==="MSGestureTap"&&a.contentWindow.document.selection.type==="Text")d.selection=
null}var c=a.contentDocument.getElementsByTagName("body")[0],d=this;c.onselect=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="Text"){if(c=c.createRange(),!d.selection||!c.isEqual(d.selection))d.selection=c,c=a.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(b.type,!0,!0,b),a.dispatchEvent(c)}else d.selection=null};a.contentDocument.onselectionchange=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="Text"&&(c=c.createRange(),d.selection&&!c.isEqual(d.selection)))d.selection=
null,c=a.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(b.type,!0,!0,b),a.dispatchEvent(c)};c.onselectstart=function(b){var c=a.contentWindow.document.selection;if(c&&c.type==="None"&&d.selection)d.selection=null,b.preventDefault()};c.ondblclick=function(b){d.selection=null;var c=a.ownerDocument.createEvent("MouseEvent");c.initMouseEvent(b.type,!0,!0,window.parent,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,null);a.dispatchEvent(c)};
if(window.MSGesture){var g=new MSGesture;g.target=c;c.addEventListener("MSGestureTap",b,!1);c.addEventListener("MSPointerDown",b,!1)}}}var j=0,e=j++,d=j++,c=j++,b=5;return{DATA_LOAD_ERROR:e,IFRAME_ERROR_LOADING:d,IFRAME_ERROR_PAGINATING:c,build:function(b,a){for(var c=[],d=[],e=0;e<2;e+=1){var j,o=e,q=a;j=document.createElement("iframe");var n="flow_"+o;j.index=o;j.processingRequestId={};j.setAttribute("frameBorder","0");j.setAttribute("id","frame_"+o);j.setAttribute("name","book_iframe_"+o);j.setAttribute("scrolling",
"no");j.style.msFlowInto=n;$(j).css({msFlowInto:n,position:"absolute",top:"0px",left:"0px",display:"none"});o=KindleRegionManagerFactory.build(j,n,q);j={iframe:j,regionManager:o};c[e]=j.iframe;d[e]=j.regionManager;a.appendChild(c[e])}b.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};b.direction={NEXT:2,PREVIOUS:3};b.iframes=c;b.regionManagers=d;b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY];b.contentRange=[null,null];b.positionData=[null,null];b.visibleIframeIndex=0;b.hiddenIframeIndex=
1;b.overlayManager=null;b.numColumns=1;b.columnGap=20;b.margin=0;b.parent=a;b.selection=null;h(b)}}}();
function KindleRegionNodeFactory(h){var j=null,e=null,d=null,c=null;return{show:function(){h.style.left="0px"},hide:function(){h.style.left="-9999px"},setPagePositionRange:function(b,c){j=b;e=c},getPagePositionRange:function(){return{topOfPagePosition:j,bottomOfPagePosition:e}},setNumPageBreaks:function(b){d=b},getNumPageBreaks:function(){return d},getRegionContent:function(){return h.msGetRegionContent()},getRegionOverflow:function(){return c=h.msRegionOverflow},getCachedRegionOverflow:function(){return c},
getHeight:function(){return h.clientHeight}}}
function KindleRegionPageBreakPivot(h){var j,e;return{insert:function(d){if(!j){var c=h.contentDocument.createElement("div");c.className="renderer-page-break";for(var b=h.contentWindow.document.getElementById(d);!b.previousSibling&&!KindleRendererUtils.isBlock(b)&&b.parentNode.tagName!=="BODY";)b=b.parentNode;h.contentWindow.document.body.firstElementChild!==b&&(b.parentNode.insertBefore(c,b),e=d,j=c)}},clear:function(){var d=h.contentDocument.getElementsByClassName("renderer-page-break");d&&d.length>
0&&d[0].parentNode.removeChild(d[0]);e=j=null},getPosition:function(){return e}}}
var KindleRegionManagerFactory=function(){function h(b){b.updateView=function(b,a){var c,d=!1,h=a.position,j=a.allowPartialScreen;switch(b){case e.NEXT_PAGE:c=this.findPositionAfter(h);break;case e.PREVIOUS_PAGE:c=this.findPositionBefore(h);if(KindleRendererUtils.isNumeric(c))return this.showPreviousPage(c,j);break;case e.GO_TO_POSITION:this.computeFilledRegionNodes(),c=this.findPositionForGoTo(h)}KindleRendererUtils.isNumeric(c)&&(d=this.showPositionAtStart(c));return d};b.createDocumentFragmentWithRegions=
function(b){for(var a=document.createDocumentFragment(),c=0;c<b;c++){var d=document.createElement("div");$(d).css({msFlowFrom:this.flowName,position:"absolute",top:"0px",left:"-9999px",width:"100%",height:"100%","z-index":"100"});a.appendChild(d)}return a};b.computeFilledRegionNodes=function(){function b(a){for(var c=[],d=0;d<a.length;d++)c.push(KindleRegionNodeFactory(a[d]));return c}var a=this.regions,c;this.regionCount===-1&&(a=this.createDocumentFragmentWithRegions(KindleRendererDeviceSpecific.defaultNumRegions()),
this.container.appendChild(a),a=b(this.container.children),a=Array.prototype.slice.call(a));for(c=a[a.length-1].getRegionOverflow();c==="overflow"||c==="fit";)a=this.createDocumentFragmentWithRegions(a.length/4),this.container.appendChild(a),a=b(this.container.children),a=Array.prototype.slice.call(a),c=a[a.length-1].getRegionOverflow();for(var d=0;d<a.length;d++)if(c=a[d].getRegionOverflow(),c==="empty"){this.regionCount=d;break}this.regions=a};b.getRegionWithPosition=function(b){for(var a=this.regions,
c,d=0;d<this.regionCount;d++)if(c=a[d].getPagePositionRange(),b>=c.topOfPagePosition&&b<=c.bottomOfPagePosition)return d;return null};b.showRegionWithPosition=function(b){var a=this.indexVisible,b=this.getRegionWithPosition(b);return b!==null?(this.hideRegion(a),this.showRegion(b),!0):!1};b.showRegion=function(b){var a=this.regions;return b!==null&&b>=0&&b<this.regionCount?(a[b].show(),this.indexVisible=b,!0):!1};b.hideRegion=function(b){var a=this.regions;return b!==null&&b>=0&&b<a.length?(a[b].hide(),
!0):!1};b.findPositionBefore=function(b){return this.findNearestPosition(b,this.DIRECTION.PREV)};b.findPositionAfter=function(b){return this.findNearestPosition(b,this.DIRECTION.NEXT)};b.findNearestPosition=function(b,a){function c(){for(var f=e.iframe.contentWindow.document.querySelectorAll(d),h=null,j=Infinity,n=0;n<f.length;n++){var m=parseInt(f[n].id,10)-b;!(a===e.DIRECTION.PREV&&m>0)&&!(a===e.DIRECTION.NEXT&&m<0)&&(m=Math.abs(m),m>0&&m<j&&(j=m,h=f[n]))}return h}var e=this,h=null,h=(h=this.iframe.contentWindow.document.getElementById(b))?
a===this.DIRECTION.PREV?KindleRendererUtils.previousPositionedNode(h):a===this.DIRECTION.NEXT?KindleRendererUtils.nextPositionedNode(h):KindleRendererUtils.nextPositionedNode(h)||KindleRendererUtils.previousPositionedNode(h):c(),e=null;return h?parseInt(h.id,10):null};b.showPositionAtStart=function(b){return(b=this.iframe.contentWindow.document.getElementById(b))?(this.pageBreakPivot.clear(),this.pageBreakPivot.insert(b.id),this.computeFilledRegionNodes(),this.computePaginationData(),this.showRegionWithPosition(b.id)):
!1};b.fixPaginationDataHack=function(b,a){if(a>1){var c,d;for(c=0;c<a-1;c++){var e=b[c].getPagePositionRange();if(e.topOfPagePosition!==null)for(d=c+1;d<a;d++){var h=b[d].getPagePositionRange();if(h.topOfPagePosition!==null&&h.bottomOfPagePosition!==null){d=e.topOfPagePosition===h.topOfPagePosition?e.topOfPagePosition:h.topOfPagePosition-1;b[c].setPagePositionRange(e.topOfPagePosition,d);break}}}c=0;for(e=1;e<a;e++)c+=b[e].getNumPageBreaks();b[0].setNumPageBreaks(b[0].getNumPageBreaks()-c)}};b.computePaginationData=
function(){for(var b=this.regions,a=this.regionCount,f=0;f<a;f++){for(var e=b[f],h=e.getRegionContent(),j=[],o=[],q=[],n,r=null,s=null,t=0;t<h.length;t++)q[t]=h[t].cloneContents().querySelectorAll(d),j=j.concat(Array.prototype.slice.call(q[t])),n=h[t].cloneContents().querySelectorAll(c),o=o.concat(Array.prototype.slice.call(n));j.length&&(r=parseInt(j[0].id,10),s=parseInt(j[j.length-1].id,10));e.setPagePositionRange(r,s);e.setNumPageBreaks(o.length)}this.fixPaginationDataHack(b,a)};b.cleanUp=function(){$(this.container).empty();
this.regions=[]};b.getPagePositionRange=function(){var b={},a=this.regions,c=this.indexVisible;a&&c!==null&&(b=a[c].getPagePositionRange(),b={currentTopOfPage:b.topOfPagePosition?b.topOfPagePosition:0,currentBottomOfPage:b.bottomOfPagePosition?b.bottomOfPagePosition:0});return b};b.findNextScreen=function(b,a){for(var c=(KindleRendererUtils.isNumeric(a)?a:this.indexVisible)+1;c<this.regionCount;){var d=this.regions[c].getPagePositionRange();if(d.topOfPagePosition!==null||d.bottomOfPagePosition!==
null){if(b)return c;if(this.findPositionAfter(d.bottomOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.bottomOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.nextSibling;){if(d.nextSibling.nodeName==="DIV"&&d.nextSibling.id!=="content-overlays")return null;d=d.nextSibling}}return c}c++}return null};b.findPreviousScreen=function(b,a){for(var c=(KindleRendererUtils.isNumeric(a)?a:this.indexVisible)-1;c>=0;){var d=this.regions[c].getPagePositionRange();
if(d.topOfPagePosition!==null||d.bottomOfPagePosition!==null){if(b)return c;if(this.findPositionBefore(d.topOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.topOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.previousSibling;){if(d.previousSibling.nodeName==="DIV"&&d.previousSibling.id!=="content-overlays")return null;d=d.previousSibling}}return c}c--}return null};b.hasNextScreen=function(b){return this.findNextScreen(b)!==null};b.hasPreviousScreen=
function(b){return this.findPreviousScreen(b)!==null};b.nextScreen=function(b){var a=!0,a=this.regions,c=this.indexVisible,d=this.findNextScreen(b);this.hideRegion(c);d===null||a[d].getCachedRegionOverflow()!=="overflow"&&!b?(a=!1,KindleDebug.log("NextScreen: No more next screens to show.")):a=this.showRegion(d);return a};b.previousScreen=function(b){var a=!0,c=this.regions,d=this.indexVisible,e=this.findPreviousScreen(b);this.hideRegion(d);if(e===null||c[e].getCachedRegionOverflow()!=="overflow"&&
!b)a=!1,KindleDebug.log("PreviousScreen: No more previous screens to show.");else{if((c=this.pageBreakPivot.getPosition())&&this.getRegionWithPosition(c)-1===e)if(c=this.findPositionBefore(this.getPagePositionRange().currentTopOfPage),KindleRendererUtils.isNumeric(c))return this.showPreviousPage(c,b);else if(b&&e===0)return KindleDebug.log("PreviousScreen: Could not find a position before to show. Assuming it is a cover."),this.pageBreakPivot.clear(),this.computeFilledRegionNodes(),this.computePaginationData(),
this.showRegion(e);wasAbleToGoToNextScreen=this.showRegion(e)}return a};b.getNumColumns=function(){return parseInt(this.iframe.contentWindow.document.body.currentStyle.columnCount,10)};b.showPreviousPage=function(b,a){this.pageBreakPivot.clear();this.computeFilledRegionNodes();this.computePaginationData();var f=this.getRegionWithPosition(b),e=this.regions[f],h=this.getBoundingClientRect(this.iframe.contentWindow.document.getElementById(b)),j=this.container.getBoundingClientRect();if(e.getNumPageBreaks()>
0||e.getPagePositionRange().bottomOfPagePosition===b)return this.showRegionWithPosition(b),!0;var o=this.getNumColumns(),e=h.bottom,q=j.width/o,n=null;if(e-j.top<h.height)return!0;if(o>1)for(j=1;j<=o;j++)if(h.left<q*j){n={start:q*(j-1),end:q*j};break}o=this.findPreviousScreen(a,f);if(o===null)a&&this.showRegionWithPosition(b);else{f=this.regions[o].getRegionContent();if(f.length>0){f=f[0].cloneContents().querySelectorAll(d+","+c);h=null;for(q=j=0;q!==this.regions[o].getNumPageBreaks();){var r=$(f[j]);
(r.hasClass("page-break")||r.hasClass("pagebreak"))&&q++;j++}for(;j<f.length;j++)if(o=this.iframe.contentWindow.document.getElementById(f[j].id),q=this.getBoundingClientRect(o),r=n?q.left>n.start&&q.left<n.end:!0,q.top>e&&r){h=o;break}h&&(this.pageBreakPivot.insert(h.id),this.computeFilledRegionNodes(),this.computePaginationData())}this.showRegionWithPosition(b);return!0}return!1};b.getBoundingClientRect=function(b){var b=b.getBoundingClientRect(),a=KindleRendererDeviceSpecific.resolutionScale();
return{height:b.height/a,width:b.width/a,left:b.left/a,right:b.right/a,top:(b.top%this.container.clientHeight+this.container.getBoundingClientRect().top)/a,bottom:(b.bottom%this.container.clientHeight+this.container.getBoundingClientRect().top)/a}};b.show=function(){this.container.style.left="0px"};b.hide=function(){this.container.style.left="-9999px"};b.getApproximateNumNextScreens=function(b){for(var a=0,c=this.findNextScreen(b,this.indexVisible);c!==null&&c<this.regionCount;)c=this.findNextScreen(b,
c+1),a++;KindleDebug.log("getApproximateNumNextScreens: # of next screens left:"+a);return a};b.getApproximateNumPrevScreens=function(b){for(var a=0,c=this.findPreviousScreen(b,this.indexVisible);c!==null&&c>0;)c=this.findPreviousScreen(b,c-1),a++;KindleDebug.log("getApproximateNumPrevScreens: # of prev screens left:"+a);return a};b.getOffsetTop=function(){return this.regions[this.indexVisible].getHeight()*this.indexVisible};b.findPositionForGoTo=function(b){function a(a){for(var b=a,c=parseInt(b.id,
10),a=a.getClientRects()[0].top;b;)if((b=KindleRendererUtils.previousPositionedNode(b))&&b.getClientRects()[0].top===a)c=parseInt(b.id,10);else break;return c}var c=this.iframe,d=c.contentDocument.getElementById(b);if(!d){var e=this.findPositionAfter(b)||this.findPositionBefore(b);e&&(d=c.contentWindow.document.getElementById(e))}return d?a(d):b}}function j(b){b.nextScreen=function(b){return this.internal.nextScreen(b)};b.previousScreen=function(b){return this.internal.previousScreen(b)};b.hasNextScreen=
function(b){return this.internal.hasNextScreen(b)};b.hasPreviousScreen=function(b){return this.internal.hasPreviousScreen(b)};b.getPagePositionRange=function(){return this.internal.getPagePositionRange()};b.cleanup=function(){this.internal.cleanup()};b.show=function(){this.internal.show()};b.hide=function(){this.internal.hide()};b.updateView=function(b,a){return this.internal.updateView(b,a)};b.getApproximateNumNextScreens=function(b){return this.internal.getApproximateNumNextScreens(b)};b.getApproximateNumPrevScreens=
function(b){return this.internal.getApproximateNumPrevScreens(b)};b.getOffsetTop=function(){return this.internal.getOffsetTop()};b.computeFilledRegionNodes=function(){this.internal.computeFilledRegionNodes()}}var e={GO_TO_POSITION:1,NEXT_PAGE:2,PREVIOUS_PAGE:3},d="span.k4w, canvas.k4wc, img",c=".page-break, .pagebreak";return{VIEW_REQUEST:e,build:function(b,c,a){var d={internal:{}};d.internal.DIRECTION={NEXT:"next",PREV:"prev"};var e=d.internal,m=document.createElement("div");m.id="container_"+c;
$(m).css({position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%"});a.appendChild(m);e.iframe=b;e.flowName=c;e.parent=a;e.container=m;e.regions=[];e.regionCount=-1;e.indexVisible=null;e.pageBreakPivot=KindleRegionPageBreakPivot(b);h(d.internal);j(d);return d}}}(),KindleRendererDeviceSpecific=function(){var h={};return{initialize:function(){var j=KindleHostDeviceDetector.getDevicePlatform();if(j==="desktop"){h.fragmentBufferCapacityForGoTo=2;h.fragmentBufferCapacityForPageFlip=10;h.fragmentBufferCapacityForPageFlipGlyphs=
3;h.drawYieldUpdateTime=25;h.drawYieldScreenManagerFrequency=5E3;h.drawYieldGlyphRendereringFrequency=1E3;h.drawYieldWordMapGenFrequency=5E3;h.drawYieldWordMapGenUpdateTime=25;h.drawYieldHeightMapFrequency=5E3;h.drawYieldHeightMapUpdateTime=25;h.drawYieldSanitizeNodesFrequency=2500;h.drawYieldSanitizeNodesTime=0;h.reflowTimeout=-1;h.minColumnsToHide=2;h.maximumCanvases=4900;h.clientRectsExpire=KindleHostDeviceDetector.isIE();h.rendererInitializationTimeout=6E4;h.glyphCacheMaxSize=15;if(KindleHostDeviceDetector.hasCanvasPerformanceProblem())h.maximumCanvases=
1750,h.drawYieldGlyphRendereringFrequency=200;if(j!=="metro"&&KindleHostDeviceDetector.isIE())h.fragmentBufferCapacityForPageFlip=6,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=
0,h.yieldTimeLoadNextFragment=0,h.maximumCanvases=1750,h.clientRectsExpire=!0,h.mightUseCSSRegions=!0,h.defaultNumRegions=25,h.mightUseNativeSelection=!0}else j==="lassen"?(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=7,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldGlyphRendereringFrequency=200,h.reflowTimeout=2E4,h.maximumCanvases=1750,h.minColumnsToHide=1,h.rendererInitializationTimeout=2E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,
KindleHostDeviceDetector.isiPhone()?(h.drawYieldWordMapGenFrequency=20,h.drawYieldWordMapGenUpdateTime=10,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=10,h.drawYieldScreenManagerFrequency=250,h.drawYieldUpdateTime=50):(h.drawYieldWordMapGenFrequency=300,h.drawYieldWordMapGenUpdateTime=50,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=20,h.drawYieldScreenManagerFrequency=250,h.drawYieldUpdateTime=10)):j==="metro"?(h.fragmentBufferCapacityForGoTo=2,h.fragmentBufferCapacityForPageFlip=
6,h.fragmentBufferCapacityForPageFlipGlyphs=3,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=0,h.yieldTimeLoadNextFragment=0,h.reflowTimeout=-1,h.minColumnsToHide=2,h.maximumCanvases=
1750,h.clientRectsExpire=!0,h.rendererInitializationTimeout=6E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,h.glyphCacheMaxSize=15,h.clientRectsExpire=!0,h.mightUseCSSRegions=!0,h.defaultNumRegions=25,h.mightUseNativeSelection=!0):j==="metroArm"?(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=5,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldUpdateTime=0,h.drawYieldScreenManagerFrequency=500,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=
500,h.drawYieldWordMapGenUpdateTime=0,h.drawYieldHeightMapFrequency=500,h.drawYieldHeightMapUpdateTime=0,h.yieldTimeOnContentReceived=0,h.yieldTimeAfterBulkWriteToIframe=0,h.yieldTimeBeforeBulkWriteToIframe=0,h.yieldTimeAfterIframeLoaded=0,h.yieldTimeLoadNextFragment=0,h.reflowTimeout=-1,h.minColumnsToHide=2,h.maximumCanvases=1750,h.clientRectsExpire=!0,h.rendererInitializationTimeout=9E4,h.drawYieldSanitizeNodesFrequency=2500,h.drawYieldSanitizeNodesTime=0,h.glyphCacheMaxSize=15,h.clientRectsExpire=
!0,h.animatePageFlip=!1,h.mightUseCSSRegions=!0,h.defaultNumRegions=15,h.mightUseNativeSelection=!0):(h.fragmentBufferCapacityForGoTo=1.2,h.fragmentBufferCapacityForPageFlip=7,h.fragmentBufferCapacityForPageFlipGlyphs=2,h.drawYieldUpdateTime=50,h.drawYieldScreenManagerFrequency=250,h.drawYieldGlyphRendereringFrequency=200,h.drawYieldWordMapGenFrequency=300,h.drawYieldWordMapGenUpdateTime=50,h.drawYieldHeightMapFrequency=5E3,h.drawYieldHeightMapUpdateTime=50,h.drawYieldSanitizeNodesFrequency=2500,
h.drawYieldSanitizeNodesTime=0,h.reflowTimeout=1E4,h.minColumnsToHide=2,h.maximumCanvases=1750,h.rendererInitializationTimeout=9E4,h.animatePageFlip=KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_4x());if(j==="metro")h.minColumnsToHide=1,h.clientRectsExpire=!0;h.needsReflowOnPageFlip=KindleHostDeviceDetector.isiOS_4x()||KindleHostDeviceDetector.isChrome&&KindleHostDeviceDetector.isChrome()&&navigator.userAgent.indexOf("Chrome/18.")>=0;h.usesDocRelativeVerticalCoordinates=KindleHostDeviceDetector.isiOS();
h.needsWritingModeSpecifiedOnBody=KindleHostDeviceDetector.isiOS();h.verticalParagraphsScaleSeparately=KindleHostDeviceDetector.isiPhone();h.needsLanguageSpecificItalicsCheck=KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)===7;h.shouldRotateECJKChar=KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion&&KindleHostDeviceDetector.getOSMinorVersion&&(parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)<6||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),
10)===6&&parseInt(KindleHostDeviceDetector.getOSMinorVersion(),10)===0)},fragmentBufferCapacityForGoTo:function(){return h.fragmentBufferCapacityForGoTo},fragmentBufferCapacityForPageFlip:function(j){return j?h.fragmentBufferCapacityForPageFlipGlyphs:h.fragmentBufferCapacityForPageFlip},drawYieldUpdateTime:function(){return h.drawYieldUpdateTime},glyphCacheMaxSize:function(){return h.glyphCacheMaxSize||0},drawYieldWordMapGenUpdateTime:function(){return h.drawYieldWordMapGenUpdateTime},drawYieldHeightMapUpdateTime:function(){return h.drawYieldHeightMapUpdateTime},
drawYieldScreenManagerFrequency:function(){return h.drawYieldScreenManagerFrequency},drawYieldGlyphRendereringFrequency:function(){return h.drawYieldGlyphRendereringFrequency},drawYieldWordMapGenFrequency:function(){return h.drawYieldWordMapGenFrequency},drawYieldHeightMapFrequency:function(){return h.drawYieldHeightMapFrequency},drawYieldSanitizeNodesFrequency:function(){return h.drawYieldSanitizeNodesFrequency},yieldTimeOnContentReceived:function(){return h.yieldTimeOnContentReceived},yieldTimeAfterBulkWriteToIframe:function(){return h.yieldTimeAfterBulkWriteToIframe},
yieldTimeBeforeBulkWriteToIframe:function(){return h.yieldTimeBeforeBulkWriteToIframe},yieldTimeAfterIframeLoaded:function(){return h.yieldTimeAfterIframeLoaded},yieldTimeLoadNextFragment:function(){return h.yieldTimeLoadNextFragment},needsReflowOnPageFlip:function(){return h.needsReflowOnPageFlip},shouldRotateECJKChar:function(){return h.shouldRotateECJKChar},needsLanguageSpecificItalicsCheck:function(){return h.needsLanguageSpecificItalicsCheck},usesDocRelativeVerticalCoordinates:function(){return h.usesDocRelativeVerticalCoordinates},
needsWritingModeSpecifiedOnBody:function(){return h.needsWritingModeSpecifiedOnBody},verticalParagraphsScaleSeparately:function(){return h.verticalParagraphsScaleSeparately},reflowTimeout:function(){return h.reflowTimeout},maximumCanvases:function(){return h.maximumCanvases},animatePageFlip:function(){return h.animatePageFlip},clientRectsExpire:function(){return h.clientRectsExpire},minColumnsToHide:function(){return h.minColumnsToHide},rendererInitializationTimeout:function(){return h.rendererInitializationTimeout},
drawYieldSanitizeNodesTime:function(){return h.drawYieldSanitizeNodesTime||0},mightUseCSSRegions:function(){return h.mightUseCSSRegions},mightUseNativeSelection:function(){return h.mightUseNativeSelection},defaultNumRegions:function(){return h.defaultNumRegions||0},resolutionScale:function(){var h=1;screen.deviceXDPI&&(h=screen.deviceXDPI/96);return h}}}(),KindleRendererLanguageOptions=function(){function h(h){var h=h&&h.split("-")[0].toLowerCase()||"en",o={};h==="ja"?(o={fontFamilyRegex:j,sansFont:d,
serifFont:e,defaultFont:e},m={hasWhitespaceDelimitedWords:!1,language:h,lineHeight:"1.75",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,needsFontSanitization:!0,needsDeviceSpecificItalicsCheck:!0,fontOptions:o}):h==="zh"?(o={fontFamilyRegex:c,sansFont:g,serifFont:b,defaultFont:b},m={hasWhitespaceDelimitedWords:!1,language:h,lineHeight:"1.4",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,needsFontSanitization:!0,
needsDeviceSpecificItalicsCheck:!1,fontOptions:o}):(o={fontFamilyRegex:a,sansFont:k,serifFont:f,defaultFont:f},m={hasWhitespaceDelimitedWords:!0,language:h,lineHeight:"1.4",allowsVerticalLayout:!1,allowsNegativeTextIndent:!1,allowsClearStyle:!0,needsPageRefresh:!1,needsFontSanitization:!1,needsDeviceSpecificItalicsCheck:!1,fontOptions:o})}var j=/(Hiragino)|(HiraKaku)/,e="'Hiragino Mincho ProN'",d="HiraKakuProN-W3",c=/(Songti)|(Heiti)/,b="'Songti SC'",g="'Heiti SC'",a=/(serif)|(sans-serif)|(gothic)/i,
f="Georgia, serif",k="sans-serif",m={};h("en");return{initialize:h,getHasWhitespaceDelimitedWords:function(){return m.hasWhitespaceDelimitedWords},getLanguage:function(){return m.language},getLineHeight:function(){return m.lineHeight},getAllowsVerticalLayout:function(){return m.allowsVerticalLayout},getAllowsNegativeTextIndent:function(){return m.allowsNegativeTextIndent},getAllowsClearStyle:function(){return m.allowsClearStyle},getNeedsPageRefresh:function(){return m.needsPageRefresh},getNeedsFontSanitization:function(){return m.needsFontSanitization},
getAcceptedFontFamiliesRegex:function(){return m.fontOptions.fontFamilyRegex},getSansFont:function(){return m.fontOptions.sansFont},getSerifFont:function(){return m.fontOptions.serifFont},getDefaultFont:function(){return m.fontOptions.defaultFont},getAllowsItalicFont:function(){return!(m.needsDeviceSpecificItalicsCheck&&KindleRendererDeviceSpecific.needsLanguageSpecificItalicsCheck())}}}(),KindleRendererSettings=function(){function h(b,a,c){try{b.styleSheet&&b.styleSheet.addRule?b.styleSheet.addRule(a,
c):b.sheet&&b.sheet.insertRule&&b.sheet.insertRule(a+"{"+c+"}",0)}catch(d){}}function j(d){var a=new jQuery.Deferred;d.getMetadata(function(d){if(d.hasFixedContent!==void 0)c.fixedContent=d.hasFixedContent;if(d.publisherMetadata!==void 0){var g=d.publisherMetadata;if(g[0]==="metadata"&&(g=g[2],g!==void 0))for(var e=g.length,h=0;h<e;++h){var j=g[h][1];if(j!==void 0)if(j.name==="fixed-layout")c.fixedContent=j.content==="true";else if(j.name==="original-resolution"&&(j=j.content.match(/(\d+)[Xx](\d+)/)))c.originalResolution=
{width:parseInt(j[1],10),height:parseInt(j[2],10)}}}if(d.headerMetadata!==void 0){g=d.headerMetadata;if(g.fixedLayout)c.fixedContent=g.fixedLayout==="true";if(g.originalResolution&&(e=g.originalResolution.match(/(\d+)[Xx](\d+)/)))c.originalResolution={width:parseInt(e[1],10),height:parseInt(e[2],10)};c.pageProgressionDirection={RTL:0,LTR:1};c.inlineBaseDirection={VERTICAL:0,HORIZONTAL:1};if(g.app_PrimaryWritingMode)c.pageProgressionDirection.value=g.app_PrimaryWritingMode==="vertical-rl"||g.app_PrimaryWritingMode===
"horizontal-rl"?c.pageProgressionDirection.RTL:c.pageProgressionDirection.LTR,c.inlineBaseDirection.value=g.app_PrimaryWritingMode.match(/^vertical/)!==null?c.inlineBaseDirection.VERTICAL:c.inlineBaseDirection.HORIZONTAL;d=d.headerMetadata.app_contentLanguageTag}else d="en";KindleRendererLanguageOptions.initialize(d);if(KindleRendererDeviceSpecific.verticalParagraphsScaleSeparately()&&KindleRendererLanguageOptions.getAllowsVerticalLayout()&&!c.fixedContent)c.initialExpandedBodyHeight=b;c.lineSpacingMultiplier=
1;a.resolve()},function(){a.reject()});return a.promise()}function e(){return!c.fixedContent&&KindleRendererDeviceSpecific.mightUseCSSRegions()&&KindleRendererFragmentLoader.getBookContentType()!=="topaz"}function d(){return!c.fixedContent&&KindleRendererDeviceSpecific.mightUseNativeSelection()&&KindleRendererFragmentLoader.getBookContentType()!=="topaz"}var c={},b="500%";return{initialize:function(b){return j(b)},cleanup:function(){c={}},getSettings:function(){return c},updateSettings:function(b){for(var a in b)c[a]=
b[a]},addCSSRules:function(b){var a=c,f=document.getElementById("kindleRendererOptionsStylesheet");f!==void 0&&f!==null&&f.parentNode.removeChild(f);f=document.createElement("style");f.type="text/css";f.id="kindleRendererOptionsStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{if(b.appendChild(f),a.fixedContent)h(f,"body","position : absolute; margin: 0;"),a.originalResolution&&h(f,"body.amzUserPref","background-size: contain !important; width: "+
a.originalResolution.width+"px; height: "+a.originalResolution.height+"px");else{var j;if(a.fontSizes!==void 0){h(f,"body.amzUserPref","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");h(f,"font","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");for(j=0;j<a.fontSizes.length;j+=1)h(f,".font-size-"+(j+1),"font-size : "+a.fontSizes[j]+a.fontSizeUnits+" !important")}if(a.lineSpacingMultiplier!==void 0){var m=KindleRendererLanguageOptions.getLineHeight()*a.lineSpacingMultiplier;h(f,
"body.amzUserPref","line-height: "+m+"  !important")}a.fontColor!==void 0&&h(f,"body.amzUserPref","color : "+a.fontColor+" !important");a.fontFamily!==void 0&&h(f,"body.amzUserPref","font-family : "+a.fontFamily+" !important");a.backgroundColor!==void 0&&h(f,"body.amzUserPref","background-color : "+a.backgroundColor+" !important");a.textAlign!==void 0&&h(f,"body.amzUserPref","text-align : "+a.textAlign+" !important");a.margin!==void 0&&h(f,"body.amzUserPref","margin : "+a.margin+" !important");a.selectionColor!==
void 0&&h(f,"div.amazon-selection","background-color : "+a.selectionColor);a.insertBgColor!==void 0&&h(f,".insert","background-color : "+a.insertBgColor);if(a.annotationStyles!==void 0)for(var l in a.annotationStyles){var o=a.annotationStyles[l],q=o.htmlElementTag?o.htmlElementTag+"."+o.className:"div."+o.className;h(f,q,o.style);if(o.additionalStyles)for(var n in o.additionalStyles){var r=o.additionalStyles[n];h(f,q+"."+r.className,r.style)}}a.clickableElementFeedbackStyles!==void 0&&h(f,"."+a.clickableElementFeedbackStyles.className,
a.clickableElementFeedbackStyles.classStyle);if(a.keyframes!==void 0){var s=a.keyframes,t;for(t in s)h(f,t,s[t])}e()&&a.columns!==void 0&&(h(f,"body","column-count : "+a.columns.num),h(f,"body","column-gap : "+a.columns.gap),h(f,"body","column-fill: auto"),f.styleSheet.cssText+="@media screen and (max-width:320px) { body { column-count: 1 } }");d()&&h(f,"::selection","background-color : "+a.selectionColor);if(a.additionalRules!==void 0&&a.additionalRules.length!==void 0)for(j=0;j<a.additionalRules.length;j+=
1)h(f,a.additionalRules[j].selector,a.additionalRules[j].style)}}catch(u){}},useCSSRegions:e,useNativeSelection:d}}(),KindleRendererContentCorrection=function(){function h(a,b,c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-ECJK");for(b=0;b<a.length;b++)c=a[b].firstChild.nodeValue.charCodeAt(0),(c>=65307&&c<=65308||c===65310||c===65293)&&(c="rotate(90deg) translateX("+(c===65293?t:"0.5")+"em)",$(a[b]).css({display:"inline-block","-webkit-transform":c,width:"1em",height:"1em","text-indent":"0px",
"vertical-align":"text-top"}))}}function j(a,b){var c=a.getComputedStyle(b.body).fontFamily,c=KindleRendererFontHelper.sanitizeFontFamily(c);b.body.setAttribute("style",(b.body.getAttribute("style")||"")+("; font-family: "+c))}function e(a,b){for(var c=$(b.body).find(".azn-UNB"),d=0;d<c.length;++d){var g=c[d].firstChild.nodeValue.charCodeAt(0);if(g===8213||g===8212||g===9472){if(g!==9472)g=String.fromCharCode(9472),c[d].innerHTML=g+g;$(c[d]).css("-webkit-transform","scaleY(.9)")}}}function d(a,b,
c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-NTE");for(b=0;b<a.length;b++){c=a[b].firstChild.nodeValue.charCodeAt(0);switch(c){case 8220:c=12317;break;case 8221:c=12319}a[b].firstChild.nodeValue=String.fromCharCode(c)}}}function c(a,b,c){if(c.getWritingMode()==="vertical"){a=$("img",b.body).filter(function(){return $(this).css("float")!=="none"&&$(this).parent().css("display")!=="block"});for(b=0;b<a.length;b++)$(a[b]).parent().css("display","block")}}function b(a,b,c){if(c.getWritingMode()===
"horizontal"){a=$('img[data-isGaiji="true"]',b.body);for(b=0;b<a.length;b++)$(a[b]).css("vertical-align","text-top")}}function g(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left+1,borderLeft:"1px solid "+c}):$.extend(d,{top:a.top-1,left:a.left,borderBottom:"1px solid "+c});return d}function a(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left-1,borderRight:"1px solid "+c}):$.extend(d,{top:a.top+1,
left:a.left,borderTop:"1px solid "+c});return d}function f(a,b,c){var d={position:"absolute",top:a.top,left:a.left};b?$.extend(d,{height:a.height,width:Math.floor(a.width/2),borderRight:"1px solid "+c}):$.extend(d,{height:Math.floor(a.height/2),width:a.width,borderBottom:"1px solid "+c});return d}function k(a,b){for(var c,d=$('span:not([class*="azn-"])',b.body),g=0;g<d.length;++g)if(currNode=d[g],c=a.getComputedStyle(currNode),c.webkitTextCombine==="horizontal"&&c.webkitWritingMode==="vertical-rl"&&
currNode.textContent.length>1&&currNode.textContent.length<5){currNode.setAttribute("data-isTextCombineBlock","true");var f=currNode;c=parseInt(c.fontSize,10);$(f).css("-webkit-text-combine","none");var e=f.getClientRects();if(e.length>0){var h=e[0].height,e=-Math.floor((h-c)/2)+"px";c=h>c?" scaleY("+c/h+")":"";$(f).css({"-webkit-transform":"rotate(270deg)"+c,margin:e+" 0px"})}}}function m(a,b){var c=function(a,b){var c=$(a).css("border-"+b+"-style");return c&&c!=="none"},d=$('a, span:not([class*="azn-"])',
b.body),g,f,e,h,j;for(g=0;g<d.length;g++)currNode=d[g],f=c(currNode,"top"),e=c(currNode,"bottom"),h=c(currNode,"left"),j=c(currNode,"right"),(f||e||h||j)&&currNode.setAttribute("data-hasCssBorder","true")}function l(a,b){for(var c=$("rt",b.body),d=0;d<c.length;d++)$(c[d]).css("font-size","")}function o(b,c,d,e,h,j){if(b.nodeType===Node.TEXT_NODE)b=b.parentNode;if(c.webkitWritingMode.match(j.getWritingMode())!==null){var k=h.document,q=k.getElementById(r),l;a:{var m=b;l=c;var o;o=(o=$(m).attr("class"))&&
o.match(/azn-/)?3:2;for(var t=0;t<=o;++t){if(!m)break;l=m.getAttribute(s)||l.textDecoration;if(!l||l==="none")m=m.parentElement,l=h.getComputedStyle(m);else{l={node:m,decoration:l};break a}}l=void 0}m={underline:g,overline:a,"line-through":f};if(!l||!m[l.decoration])q&&q.lastChild&&$(q.lastChild).removeData(s);else{if(!q){o=k.getElementById(n);if(!o)return;q=k.createElement("DIV");q.id=r;q.style.position="relative";q.style.zIndex="-8";o.appendChild(q)}m=m[l.decoration];l.node.setAttribute(s,l.decoration);
if(b.tagName==="IMG")e=e[d[0]].rects;else{b={};b.start=d[0];b.end=d[d.length-1];d=KindleRendererWordRectsHelper.createWordBoundaries(b,e,k,h,j);e=[];for(h=0;h<d.length;h++)e.push(d[h].rect);e=e.sort(j.clientRectCompare)}d=k.createDocumentFragment();h=q.lastChild;l=l.node;b=c.webkitWritingMode==="vertical-rl";o=k.createElement("DIV");var t=!0,u=null,w=null,z;if(h&&e.length>0){var C=$(h).data(s);if(C){var E=l===C.node,N=j.checkIfNewLine(C.line,e[0],!1),E=E&&!N;$(h).removeData(s);if(E)t=!1,u=C.line,
o=h,z=C.maxHeight}}for(h=0;h<e.length;h+=1)C=e[h],t&&(u={top:C.top,height:C.height,left:C.left,right:C.right,width:C.width},z={top:Infinity,right:Infinity,bottom:-Infinity,left:-Infinity}),w=$.extend({},u),t=j.checkIfNewLine(u,e[h+1],!1),j.updateLineHeightOfBounds(z,C),t&&(j.updateLineBounds(u,!1,z,e[h+1],k.width),$(o).css(m(u,b,c.color)),d.appendChild(o),o=k.createElement("DIV"));c={line:w,maxHeight:z,node:l};$(d.lastChild).data(s,c);q.appendChild(d)}}}function q(a){for(var a=a.querySelectorAll("["+
s+"]"),b=0;b<a.length;++b){var c=$(a[b]);c.attr("style",c.attr("style")+"; text-decoration: none !important")}}var n="content-overlays",r="text-decoration-correction",s="data-cjktextdecoration",t=".425",u=[],z=[],w=[];return{initialize:function(){var a=KindleRendererLanguageOptions.getLanguage();a==="ja"?(u.push(e),u.push(d),u.push(c),u.push(b),u.push(k),u.push(m),u.push(l),KindleRendererDeviceSpecific.shouldRotateECJKChar()&&u.push(h),z.push(o),w.push(q)):a==="zh"&&(u.push(b),u.push(l));KindleRendererLanguageOptions.getNeedsFontSanitization()&&
u.push(j)},applyDocumentWideCorrections:function(a,b,c,d){for(var d=d.createSubTimer("correction"),g=0;g<u.length;++g)u[g](a,b,c);d.endTimer()},applyNodeLocalCorrections:function(a,b,c,d,g,f){if(!(z.length===0||!b||b.length===0)){var f=f.createSubTimer("correction"),e=d.getComputedStyle(a);e||(e=d.getComputedStyle(a.parentNode));for(var h=0;h<z.length;++h)z[h](a,e,b,c,d,g);f.endTimer()}},cleanup:function(a){for(var b=0;b<w.length;++b)w[b](a)}}}(),KindleRendererDefaults=function(){function h(h,e,d){h.styleSheet&&
h.styleSheet.addRule?h.styleSheet.addRule(e,d):h.sheet&&h.sheet.insertRule&&h.sheet.insertRule(e+"{"+d+"}",h.sheet.cssRules?h.sheet.cssRules.length:h.sheet.rules.length)}return{addCSSRules:function(j,e){if(e==="mobi8"){var d=document.createElement("style");d.type="text/css";d.id="kindleReaderStylesheetDefaults";try{j.insertBefore(d,j.firstChild);h(d,"html","font-size: 15px;");h(d,"table","color: inherit; font-size: inherit; line-height: inherit; font-weight: inherit; font-variant:inherit; font-style:inherit; white-space: inherit; word-wrap: inherit;");
KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()&&h(d,"body","-webkit-writing-mode: horizontal-tb");KindleRendererLanguageOptions.getDefaultFont()&&h(d,"body","font-family: "+KindleRendererLanguageOptions.getDefaultFont()+";");KindleRendererLanguageOptions.getLineHeight()&&h(d,"body","line-height: "+KindleRendererLanguageOptions.getLineHeight()+";");var c=KindleRendererSettings.getSettings().initialExpandedBodyHeight;c!==void 0&&h(stylesheet,"body","height: "+c+";")}catch(b){}}d=document.createElement("style");
d.type="text/css";d.id="kindleReaderStylesheetOverrides";try{j.appendChild(d),e==="mobi7"&&(h(d,"body","font-family: Georgia, serif; word-wrap: break-word;"),h(d,"p","margin-top: 0px; margin-bottom: 0px; text-indent:2em"),h(d,".was-a-p","margin-top: 0px; margin-bottom: 0px; text-indent:2em;"),h(d,"hr","margin-top: 15px; margin-bottom: 15px;"),h(d,"center,dd,div,dl,dt,li,ol,pre,table,ul,hr,h1,h2,h3,h4,h5,h6","margin-top: 0px; margin-bottom: 0px;"),h(d,"blockquote","text-indent: 0px; margin-top: 0px; margin-bottom: 0px;"),
h(d,"ul","list-style-type: disc;"),h(d,"ol, ul, li .was-a-p","text-indent: 0;"),h(d,"table.amazon-table-style-0","border-collapse:collapse; font-size: inherit;"),h(d,"table.amazon-table-style-0 tr td","border:none; padding:1px;"),h(d,"table.amazon-table-style-0 tr th","border:none; padding:1px; text-align:justify"),h(d,"table.amazon-table-style-1","border-collapse:collapse; font-size: inherit;"),h(d,"table.amazon-table-style-1 tr td","border:1px solid black; padding:1px;"),h(d,"table.amazon-table-style-1 tr th",
"border:1px solid black; padding:1px; text-align:justify")),e==="mobi8"&&(h(d,"body","word-wrap: break-word; padding: 0px !important;"),h(d,".azn-FWURG","-webkit-text-orientation: upright;"),h(d,".azn-NTE","-webkit-text-emphasis: none !important"),h(d,".azn-UNB","letter-spacing: 0em !important; display: inline-block; text-indent: 0px !important; -webkit-text-orientation: vertical-right !important;"),h(d,".azn-JPLB","display:inline-block; text-indent: 0px !important;")),h(d,".semiTransparentOverlay",
"z-index: 10 !important; opacity: 0.5"),h(d,"svg img","display: none;"),h(d,".page-break","display:block; padding:1px"),h(d,".pagebreak","display:block; padding:1px"),h(d,".defaultHighlight","background-color:#ffff9b"),h(d,".noDisplay","display:none"),h(d,"body","cursor: default; position: relative;"),KindleRendererSettings.getSettings().fixedContent||(h(d,"body","background: none !important; background-color: transparent !important;"),h(d,"html, body","width: auto; height: auto;")),KindleRendererSettings.useCSSRegions()&&
(h(d,".was-a-p","orphans:0; widows:0"),h(d,".page-break","break-before:column"),h(d,".pagebreak","break-before:column"),h(d,".renderer-page-break","width:0px; height:0px; break-before:always")),KindleRendererSettings.useNativeSelection()?h(d,"body","-webkit-user-select:text; -moz-user-select:text; -ms-user-select:text; unselectable: off;"):h(d,"body","-webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; unselectable: on;"),h(d,".kindle-annotation-wrapper, .kindle-annotation-wrapper *",
"margin: auto; padding: 0"),h(d,"div#content-overlays","margin: 0px; padding: 0px;")}catch(g){}}}}(),KindleRendererContentStyleSanitization=function(){function h(a,b){var c=a[b];if(c===void 0){var d=k.exec(b);d!==null&&d.length>=3&&(b=d[1]+d[2].substring(0,1).toUpperCase()+d[2].substring(1),c=a[b])}return c}function j(a,b,c){if(b==="float")return c.hasFloat=!0;if(b==="position")return a=h(a,b),!(a==="inherit"||a==="static")?c.isPositioned=!0:!1;if(b==="width"){a=h(a,b);if(a!==void 0){if(!c.widths)c.widths=
{percent:[],fixed:[]};a.indexOf("%")>=0?c.widths.percent.push(a):c.widths.fixed.push(a);return!0}return!1}if(b==="height"){a=h(a,b);if(a!==void 0){if(!c.heights)c.heights={percent:[],fixed:[]};a.indexOf("%")>=0?c.heights.percent.push(a):c.heights.fixed.push(a);return!0}return!1}if(b==="max-width"||b==="max-height"){a=h(a,b);if(a!==void 0&&a.indexOf("%")>=0){if(!c.prcntMaxDimension)c.prcntMaxDimension=[];c.prcntMaxDimension.push(a);return!0}return!1}if(b==="font-size")return a=h(a,b),a!==void 0&&!m.test(a)?
(l.test(a)?c.remFontValue=a.trim():c.absFontValue=a.trim(),!0):!1;if(b==="line-height")return a=h(a,b),a!==void 0?(c.lineHeight=a,!0):!1;if(b==="background-color")return a=h(a,b),a!==void 0?(c.backgroundColorRgb=KindleRendererColorHelper.toRgbArray(a.trim()),!0):!1;if(b==="text-indent")return!KindleRendererLanguageOptions.getAllowsNegativeTextIndent()&&(a=h(a,b),a!==void 0)?(c.textIndent=a,!0):!1;if(b==="color")return c.hasTextColor=!0;if(b==="clear")return!KindleRendererLanguageOptions.getAllowsClearStyle()?
c.hasClearStyle=!0:!1;if(b==="-webkit-text-combine")return c.textCombine=h(a,b),!0;if(b==="font-family"&&KindleRendererLanguageOptions.getNeedsFontSanitization())return c.langFontFamily=h(a,b),!0;if(b==="font-style")return c.fontStyle=h(a,b),!0;if(b==="display")c.display=h(a,b);return!1}function e(a){try{for(var b={},c=a.style.length,d=!1,g=0;g<c;g++)d|=j(a.style,a.style[g],b);if(d)return b}catch(f){}return null}function d(a,b){var c=KindleRendererScaleHelper.convertLength(a,"px");return c?(c=parseFloat(c),
c=Math.floor(c),c=Math.min(c,b),c+"px"):a}function c(a,b,c,g,f,e,h,j){var k="",l=0;if(a.widths){for(var m=a.widths.percent,A=a.widths.fixed,x=0.95*j.width,l=0;l<m.length;l++)k+="width: auto; ",a.display==="inline-block"&&parseInt(m[l],10)>95&&(k+="display: block; ");for(l=0;l<A.length;l++)m=d(A[l],x),k+=parseInt(m,10)<1?"width: auto; ":"width: "+m+"; "}if(a.heights){m=a.heights.percent;A=a.heights.fixed;x=0.95*j.height;for(l=0;l<m.length;l++)k+="height: auto; ",a.display==="inline-block"&&parseInt(m[l],
10)>95&&(k+="display: block; ");for(l=0;l<A.length;l++)m=d(A[l],x),k+=parseInt(m,10)<1?"height: auto; ":"height: "+m+"; "}a.lineHeight&&(l=parseFloat(a.lineHeight),k+=a.lineHeight.indexOf("%")>0&&l>=f*100?"line-height : "+l*e+"%; ":/^\d*(\.\d+)?$/.test(a.lineHeight.trim())&&l>=f?"line-height : "+l*e+"; ":"line-height : "+f*e+"; ");if(a.prcntMaxDimension)for(l=0;l<a.prcntMaxDimension.length;l++)k+=a.prcntMaxDimension[l]+": none; ";a.hasFloat&&(k+="line-height : "+(f+o)+"; ");a.isPositioned&&(k+="position: inherit; ");
a.backgroundColorRgb&&!a.hasTextColor&&b&&(b=KindleRendererColorHelper.calculateTextColorForBackground(b,a.backgroundColorRgb))&&(k+="color : rgb("+b[0]+", "+b[1]+", "+b[2]+"); ");a.absFontValue&&(b=KindleRendererScaleHelper.scaleFont(a.absFontValue,c,g)||a.absFontValue,k+="font-size: "+b+"; ");a.remFontValue&&(h=Math.round(parseFloat(a.remFontValue)*parseInt(h,10))+"px",c=KindleRendererScaleHelper.scaleFont(h,c,g)||a.absFontValue,k+="font-size: "+c+"; ");a.textIndent&&parseInt(a.textIndent,10)<0&&
(j=0.9*j.width,c=a.textIndent.replace(/-/g,""),c.indexOf("%")>0?(c=parseFloat(c,10)/100,c*=j,c=Math.min(c,j),c=Math.floor(c),c=Math.max(c,1),j=c+"px"):j=d(c,j),c=j,k+="text-indent: -"+c+"; padding-left: "+c+"; ");a.hasClearStyle&&(k+="clear:none");a.textCombine&&(k+="-webkit-text-combine: "+a.textCombine+"; display: inline-block; text-indent: 0px; height: auto;");a.langFontFamily&&(j=KindleRendererFontHelper.sanitizeFontFamily(a.langFontFamily),k+="font-family: "+j+";");a.fontStyle&&a.fontStyle===
"italic"&&!KindleRendererLanguageOptions.getAllowsItalicFont()&&(k+="font-style: normal;");a.styleString&&(k+=a.styleString);return k}function b(a){var b=a.styleSheets,a=$(a).find('link[rel*="stylesheet"][href], style');if(b.length<a.length)for(var a=a.filter("link"),b=$.makeArray(b),c=$.map(b,function(a){return a.ownerNode}),d=0;d<a.length;++d){var g=a[d],f=g.sheet||g.styleSheet;f&&(f.rules?f.rules:f.cssRules)&&c.indexOf(g)<0&&b.push(f)}return b}function g(a){function b(){var a,h,j=0;f++;for(KindleRendererProcessTuning.startingOperation("SanitizeNodes");g.length&&
j<e;)if(a=g.pop(),j++,a&&a.nodeType===Node.ELEMENT_NODE){(h=a.getAttribute("style"))&&h.length>0&&a.tagName!=="IMG"&&d.push(a);a=a.childNodes;for(h=0;h<a.length;h++)g.push(a[h])}KindleRendererProcessTuning.endingOperation("SanitizeNodes",j);g.length?setTimeout(b,processTimeout):c.resolve(d,f)}var c=$.Deferred(),d=[],g=[],f=0,e=KindleRendererProcessTuning.drawYieldFrequency("SanitizeNodes");processTimeout=KindleRendererProcessTuning.drawYieldUpdateTime("SanitizeNodes");g.push(a);b();return c.promise()}
function a(a){var b=[];if(window.ActiveXObject&&window.XMLHttpRequest)return a=a.querySelectorAll("[style]:not(IMG)"),$.Deferred().resolve(a);else try{for(var c=(new XPathEvaluator).evaluate("/html/body//*[@style]",a,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),d=c.iterateNext();d;)d.style.length>0&&d.tagName!=="IMG"&&b.push(d),d=c.iterateNext()}catch(f){return g(a.body)}return $.Deferred().resolve(b)}function f(a){var b=$(a).attr("style");b&&$(a).attr("style",b.replace(/!\s*important/g,""))}
var k=/^(\w*)-(\w*)(-value)?$/,m=/%|[^r]em|smaller|larger/,l=/rem/,o=0.2;return{sanitizeCSS:function(a,d,g){for(var f=$('link[type="text/css"][title]',a.head),h=0;h<f.length;++h)f[h].removeAttribute("title");if(!d.fixedContent){h=!1;f=a.getElementById("kindleReaderSanitizationStylesheet");if(!f){f=a.createElement("style");f.id="kindleReaderSanitizationStylesheet";f.type="text/css";for(var h=f,j=b(a),k=[],l=j.length,m=0;m<l;m++)for(var o=j[m],F=k,A=(o=o.rules?o.rules:o.cssRules)&&o.length||0,x=0;x<
A;x++){var B=e(o[x]);if(B)B.selectorText=o[x].selectorText,F.push(B);B=o[x];if(B.selectorText!==void 0&&B.selectorText==="span")B.selectorText='span:not([class*="azn-"])';for(var B=[],v=0;v<B.length;++v)F.push(B[v])}h.sanitizationRules=k;h=!0}if(f.sanitizationRules.length>0){j=f.sanitizationRules;k=d.fontColor?KindleRendererColorHelper.toRgbArray(d.fontColor):null;l=d.fontSizes;m=d.fontSizeUnits;F=KindleRendererLanguageOptions.getLineHeight();d=d.lineSpacingMultiplier;o=getComputedStyle(a.documentElement).fontSize;
A="";x=j.length;for(B=0;B<x;B++)A+=j[B].selectorText+" { ",A+=c(j[B],k,l,m,F,d,o,g),A+=" } ";f.innerHTML=A}h&&a.head.appendChild(f)}},sanitizeContent:function(b,d,g){var h=$.Deferred();if(d.fixedContent)return h.resolve();f(b.body);a(b).done(function(a){for(var f=d.fontColor?KindleRendererColorHelper.toRgbArray(d.fontColor):null,j=d.fontSizes,k=d.fontSizeUnits,l=KindleRendererLanguageOptions.getLineHeight(),m=d.lineSpacingMultiplier,o=getComputedStyle(b.documentElement).fontSize,A=a.length,x=0;x<
A;x++){var B=a[x],v=B,I=v.getAttribute("data-origStyle");I?v.setAttribute("style",I):v.setAttribute("data-origStyle",v.getAttribute("style"));if(v=e(a[x]))I=B.getAttribute("style")||"",I+="; ",I+=c(v,f,j,k,l,m,o,g),B.setAttribute("style",I)}h.resolve()});return h.promise()},copySanitizationData:function(a,b){var c=a.getElementById("kindleReaderSanitizationStylesheet"),d=b.getElementById("kindleReaderSanitizationStylesheet");if(c&&d)d.sanitizationRules=c.sanitizationRules}}}(),KindleRendererColorHelper=
function(){function h(b){if(b.charAt(0)==="#")return b.length===4?[parseInt(b.charAt(1)+b.charAt(1),16),parseInt(b.charAt(2)+b.charAt(2),16),parseInt(b.charAt(3)+b.charAt(3),16)]:b.length===7?[parseInt(b.charAt(1)+b.charAt(2),16),parseInt(b.charAt(3)+b.charAt(4),16),parseInt(b.charAt(5)+b.charAt(6),16)]:null;var b=b.toUpperCase(),c=d[b];if(c)return c;b=e.exec(b);return b!==null&&b.length===4?[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)]:null}function j(b){return c[0]*b[0]+c[1]*b[1]+c[2]*
b[2]}var e=/RGB\s*\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/,d={ALICEBLUE:[240,248,255],ANTIQUEWHITE:[250,235,215],AQUA:[0,255,255],AQUAMARINE:[127,255,212],AZURE:[240,255,255],BEIGE:[245,245,220],BISQUE:[255,228,196],BLACK:[0,0,0],BLANCHEDALMOND:[255,235,205],BLUE:[0,0,255],BLUEVIOLET:[138,43,226],BROWN:[165,42,42],BURLYWOOD:[222,184,135],CADETBLUE:[95,158,160],CHARTREUSE:[127,255,0],CHOCOLATE:[210,105,30],CORAL:[255,127,80],CORNFLOWERBLUE:[100,149,237],CORNSILK:[255,248,220],CRIMSON:[220,20,60],CYAN:[0,
255,255],DARKBLUE:[0,0,139],DARKCYAN:[0,139,139],DARKGOLDENROD:[184,134,11],DARKGRAY:[169,169,169],DARKGREY:[169,169,169],DARKGREEN:[0,100,0],DARKKHAKI:[189,183,107],DARKMAGENTA:[139,0,139],DARKOLIVEGREEN:[85,107,47],DARKORANGE:[255,140,0],DARKORCHID:[153,50,204],DARKRED:[139,0,0],DARKSALMON:[233,150,122],DARKSEAGREEN:[143,188,143],DARKSLATEBLUE:[72,61,139],DARKSLATEGRAY:[47,79,79],DARKSLATEGREY:[47,79,79],DARKTURQUOISE:[0,206,209],DARKVIOLET:[148,0,211],DEEPPINK:[255,20,147],DEEPSKYBLUE:[0,191,255],
DIMGRAY:[105,105,105],DIMGREY:[105,105,105],DODGERBLUE:[30,144,255],FIREBRICK:[178,34,34],FLORALWHITE:[255,250,240],FORESTGREEN:[34,139,34],FUCHSIA:[255,0,255],GAINSBORO:[220,220,220],GHOSTWHITE:[248,248,255],GOLD:[255,215,0],GOLDENROD:[218,165,32],GRAY:[128,128,128],GREY:[128,128,128],GREEN:[0,128,0],GREENYELLOW:[173,255,47],HONEYDEW:[240,255,240],HOTPINK:[255,105,180],INDIANRED:[205,92,92],INDIGO:[75,0,130],IVORY:[255,255,240],KHAKI:[240,230,140],LAVENDER:[230,230,250],LAVENDERBLUSH:[255,240,245],
LAWNGREEN:[124,252,0],LEMONCHIFFON:[255,250,205],LIGHTBLUE:[173,216,230],LIGHTCORAL:[240,128,128],LIGHTCYAN:[224,255,255],LIGHTGOLDENRODYELLOW:[250,250,210],LIGHTGRAY:[211,211,211],LIGHTGREY:[211,211,211],LIGHTGREEN:[144,238,144],LIGHTPINK:[255,182,193],LIGHTSALMON:[255,160,122],LIGHTSEAGREEN:[32,178,170],LIGHTSKYBLUE:[135,206,250],LIGHTSLATEGRAY:[119,136,153],LIGHTSLATEGREY:[119,136,153],LIGHTSTEELBLUE:[176,196,222],LIGHTYELLOW:[255,255,224],LIME:[0,255,0],LIMEGREEN:[50,205,50],LINEN:[250,240,230],
MAGENTA:[255,0,255],MAROON:[128,0,0],MEDIUMAQUAMARINE:[102,205,170],MEDIUMBLUE:[0,0,205],MEDIUMORCHID:[186,85,211],MEDIUMPURPLE:[147,112,216],MEDIUMSEAGREEN:[60,179,113],MEDIUMSLATEBLUE:[123,104,238],MEDIUMSPRINGGREEN:[0,250,154],MEDIUMTURQUOISE:[72,209,204],MEDIUMVIOLETRED:[199,21,133],MIDNIGHTBLUE:[25,25,112],MINTCREAM:[245,255,250],MISTYROSE:[255,228,225],MOCCASIN:[255,228,181],NAVAJOWHITE:[255,222,173],NAVY:[0,0,128],OLDLACE:[253,245,230],OLIVE:[128,128,0],OLIVEDRAB:[107,142,35],ORANGE:[255,165,
0],ORANGERED:[255,69,0],ORCHID:[218,112,214],PALEGOLDENROD:[238,232,170],PALEGREEN:[152,251,152],PALETURQUOISE:[175,238,238],PALEVIOLETRED:[216,112,147],PAPAYAWHIP:[255,239,213],PEACHPUFF:[255,218,185],PERU:[205,133,63],PINK:[255,192,203],PLUM:[221,160,221],POWDERBLUE:[176,224,230],PURPLE:[128,0,128],RED:[255,0,0],ROSYBROWN:[188,143,143],ROYALBLUE:[65,105,225],SADDLEBROWN:[139,69,19],SALMON:[250,128,114],SANDYBROWN:[244,164,96],SEAGREEN:[46,139,87],SEASHELL:[255,245,238],SIENNA:[160,82,45],SILVER:[192,
192,192],SKYBLUE:[135,206,235],SLATEBLUE:[106,90,205],SLATEGRAY:[112,128,144],SLATEGREY:[112,128,144],SNOW:[255,250,250],SPRINGGREEN:[0,255,127],STEELBLUE:[70,130,180],TAN:[210,180,140],TEAL:[0,128,128],THISTLE:[216,191,216],TOMATO:[255,99,71],TURQUOISE:[64,224,208],VIOLET:[238,130,238],WHEAT:[245,222,179],WHITE:[255,255,255],WHITESMOKE:[245,245,245],YELLOW:[255,255,0],YELLOWGREEN:[154,205,50]},c=[0.2126/255,0.7152/255,0.0722/255];return{toRgbArray:function(b){return h(b)},calculateTextColorForBackground:function(b,
c){var a=Math.abs(j(c)-j(b));if(a<0.3)var d=j(c),e=j(b),d=d<0.5?e<d?160:80:e>d?-160:-80,d=[Math.max(0,Math.min(255,b[0]+d)),Math.max(0,Math.min(255,b[1]+d)),Math.max(0,Math.min(255,b[2]+d))],a=Math.abs(j(d)-j(c))>a?d:null;else a=null;return a}}}(),KindleRendererContentScripts=function(){return{addInterfaceScripts:function(h){var j=document.createElement("script");j.language="Javascript";j.type="text/javascript";j.id="kindleContentInterface";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&
navigator.platform==="Win32"))try{h.appendChild(j),h="var KindleContentInterface = function() { return { ",h+=" gotoPosition : function(frm, pos) {parent.KindleReaderUI.gotoPosition(pos); return false;}, ",h+=" buyNow : function() {parent.KindleReaderUI.openStoreDP();return false;}, ",h+=" showDetails : function() {parent.KindleReaderUI.openStoreDP();  return false;} ",h+=" };}();",j.text=h}catch(e){}}}}(),KindleRendererEventHandler=function(){function h(e){var d=KindleRendererSettings.getSettings().clickableElementFeedbackStyles;
if(d!==void 0){var c=d.className,e=$(e),d=function(){var b=$(this);b.unbind("animationend");b.unbind("webkitAnimationEnd");b.removeClass(c)};e.bind("animationend",d);e.bind("webkitAnimationEnd",d);e.addClass(c)}}function j(e){var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0);e.dispatchEvent(d)}return{handleClick:function(e,d,c){var b,g;if(g=d)a:{for(g=d;g!==null;){if(g.getAttribute!==void 0){var a=g.getAttribute("onclick")||g.getAttribute("href");if(a!==null&&a.length>0){g=!0;break a}}g=
g.parentNode}g=!1}g&&(h(d),j(d),b=!0);if(!(d=b)){e=e.getElementById("annotation-section");e=$(e).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();d=null;b=-Infinity;g=e.length;for(a=0;a<g;a+=1){var f=e[a],k=$(f).offset();k.top-10<c.y&&c.y<k.top+$(f).height()+10&&k.left-10<c.x&&c.x<k.left+$(f).width()+10&&(k=parseInt($(f).css("z-index"),10),isNaN(k)&&(k=0),k>b&&(b=k,d=f))}if(c=d){if((e=c.parentNode)&&e.getAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE)!==
"false"){e=e.childNodes;for(d=0;d<e.length;d++)h(e[d])}j(c);d=!0}else d=!1}return d}}}(),KindleRendererFontHelper=function(){var h=/(sans)|(gothic)/i,j=/serif/i;return{sanitizeFontFamily:function(e){var d=e.split(",");if(KindleRendererLanguageOptions.getNeedsFontSanitization()&&!e.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())){for(var e="",c=0;c<d.length;++c){var b=d[c];e+=b.match(h)?KindleRendererLanguageOptions.getSansFont()+", "+b:b.match(j)?KindleRendererLanguageOptions.getSerifFont()+
", "+b:b;c<d.length-1&&(e+=",")}e.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())||(e+=","+KindleRendererLanguageOptions.getDefaultFont());e+=" !important"}return e}}}(),KindleListUtilities=function(){return{binarySearch:function(h,j,e,d,c){if(!h.length)return 0;var b=h.length-1,g=0,a=0,f=null,k=0;d>g&&d<=b&&(g=d);for(c>=g&&c<b&&(b=c);g<=b;)if(a=Math.floor((g+b)/2),f=h[a],k=0,e===void 0?f>j?k=1:f<j&&(k=-1):k=e(j,f),k>0)b=a-1;else if(k<0)g=a+1;else return a;return a===0||k<0?a:
a-1},sortedMerge:function(h,j){var e=[],d=h.length,c=j.length,b=0,g=0;if(d){if(!c)return h}else return j;for(var a,f;b<d&&g<c;)a=h[b],f=j[g],a<f?(e.push(a),++b):(e.push(f),++g);for(;b<d;)e.push(h[b++]);for(;g<c;)e.push(j[g++]);return e},first:function(h){return h[0]},last:function(h){return h[h.length-1]}}}(),KindleRendererProcessTuning=function(){function h(e){var d,c=j[e];if(c){if(!c.unitTime)return c.frequency;e=c.frequency*c.unitTime;if(e>100){if(d=Math.floor(Math.max(100/c.unitTime,c.minimumFrequency)),
d<c.frequency)c.frequency=d}else if(e<50){if(d=Math.ceil(Math.max(50/c.unitTime,c.minimumFrequency)),d>c.frequency)c.frequency=d}else d=c.frequency}else d=KindleRendererDeviceSpecific["drawYield"+e+"Frequency"]?KindleRendererDeviceSpecific["drawYield"+e+"Frequency"]():100,c=KindleRendererDeviceSpecific["drawYield"+e+"UpdateTime"]?KindleRendererDeviceSpecific["drawYield"+e+"UpdateTime"]():KindleRendererDeviceSpecific.drawYieldUpdateTime(),j[e]={frequency:d,minimumFrequency:d/4,yieldTime:c};return d}
var j={};return{runAfterYield:function(e,d,c){d>=2&&e>=0?(d=KindleMetricsProfiler("(YIELD)"),setTimeout(c,e),d.endTimer()):c()},startingOperation:function(e){var d=j[e];d||(h(e),d=j[e]);d.startTime=Date.now()},endingOperation:function(e,d){var c,b=j[e];b||(h(e),b=j[e]);if(b.startTime){var g=Date.now()-b.startTime;if(!(d<1)){var a=j[e];g/=d;if(a.unitTime){var f=0.1*d/a.frequency;a.unitTime=f*g+(1-f)*a.unitTime}else a.unitTime=g}b.startTime=0}else c=void 0;return c},drawYieldFrequency:function(e){return h(e)},
drawYieldUpdateTime:function(e){var d=j[e];d||(h(time),d=j[e]);return d.yieldTime}}}(),KindleRendererScaleHelper=function(){function h(c,a){if(!b[a])return null;var f=c.match(d);return f?(f=b[f[1]],parseFloat(c,10)*f/b[a]):null}function j(b,a,d){if((b=b.match(e))&&a.length>0){var b=c[b[1]],h=Math.floor((a.length-1)/2),j=parseFloat(a[0],10),h=parseFloat(a[h],10),a=parseFloat(a[a.length-1],10);return Math.min(a,Math.max(j,b*h))+d}return null}var e=/(xx-small|x-small|small|medium|large|x-large|xx-large)/,
d=/(mm|cm|in|pt|pc|px)/,c={"xx-small":0.6,"x-small":0.75,small:0.889,medium:1,large:1.2,"x-large":1.5,"xx-large":2},b={mm:2.835,cm:28.346,"in":72,pt:1,pc:6,px:1.25};return{scaleFont:function(b,a,f){if(f=f.match(d)){var f=f[1],e;if(!(e=j(b,a,f)))e=(b=h(b,"pt"))?j(b<=c["xx-small"]*25?"xx-small":b<=c["x-small"]*25?"x-small":b<=c.small*25?"small":b<=c.medium*25?"medium":b<=c.large*25?"large":b<=c["x-large"]*25?"x-large":"xx-large",a,f):null;a=e}else a=b;return a},convertLength:function(b,a){var c=h(b,
a);return c?c+a:null}}}(),KindleRendererUtils=function(){function h(b){if(b)if(b.firstChild)return b.firstChild;else if(b.nextSibling)return b.nextSibling;else{do b=b.parentNode;while(b&&!b.nextSibling);return b&&b.nextSibling}else return null}function j(b){if(b)if(b.lastChild)return b.lastChild;else if(b.previousSibling)return b.previousSibling;else{do b=b.parentNode;while(b&&!b.previousSibling);return b&&b.previousSibling}else return null}function e(b){return b?/^(SPAN|CANVAS|IMG)$/i.test(b.tagName)&&
isFinite(b.id):!1}var d=/metro/i,c=/desktop/i,b={};return{nextPositionedNode:function(b){for(b=h(b);b;){if(e(b))return b;b=h(b)}return null},previousPositionedNode:function(b){for(b=j(b);b;){if(e(b))return b;b=j(b)}return null},followingNode:function(b){var a;if(b){for(a=b.nextSibling;b&&!a;)b=b.parentNode,a=b.nextSibling;return a}else return null},precedingNode:function(b){var a;if(b){for(a=b.previousSibling;b&&!a;)b=b.parentNode,a=b.previousSibling;return a}else return null},isBlock:function(b){return b?
/^(ADDRESS|ARTICLE|ASIDE|AUDIO|BLOCKQUOTE|DD|DIV|DL|FIELDSET|FIGCAPTION|FIGURE|FOOTER|FORM|H[1-6]|HEADER|HGROUP|HR|NOSCRIPT|OL|OUTPUT|P|PRE|SECTION|TABLE|TFOOT|UL|VIDEO)$/i.test(b.tagName):!1},findElementAtOrAfterPosition:function(b,a){for(var c=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=0;c[d];){if(parseInt(c[d].id,10)>=a)return c[d];d++}return null},findElementAtOrBeforePosition:function(b,a){for(var c=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=null,e=0;c[e]&&parseInt(c[e].id,10)<=
a;)d=c[e],e++;return d},treeDepth:function(b){for(var a=0;b.parentNode;)a++,b=b.parentNode;return a},elementFromPoint:function(b,a,f){var e=KindleHostDeviceDetector.getDevicePlatform(),h=e&&e.match(d),e=e&&e.match(c)&&KindleHostDeviceDetector.isIE();return h||e?b.msElementsFromPoint(a,f)[0]:b.elementFromPoint(a,f)},isNumeric:function(b){return!isNaN(parseFloat(b))&&isFinite(b)},count:function(c,a,d){if(c){var e=b[c]||0;d||b[c]===void 0?b[c]=a:a&&(b[c]+=a);return e}}}}(),KindleRendererWordRectsHelper=
function(){function h(h,e,d){if(e)for(var c=e.length,b=0;b<c;b++)h.push({rect:e[b],dataNid:d})}return{createWordBoundaries:function(j,e,d,c,b){var g=[],a={},f=!1,k,m;for(m=j.start;m<=j.end;m+=1)if(e[m])if(e[m].rects)h(g,e[m].selectableRects||e[m].rects,e[m].dataNid),f=!0;else{var l=e[m];if(f||a[k]===void 0||a[k].dataNid!==l.dataNid||a[k].childIndex!==l.childIndex)a[m]={startOffset:l.startOffset,endOffset:l.endOffset,dataNid:l.dataNid,childIndex:l.childIndex},k=m;else{f=a[k].startOffset;if(f===void 0||
f>l.startOffset)a[k].startOffset=l.startOffset;f=a[k].endOffset;if(f===void 0||f<l.endOffset)a[k].endOffset=l.endOffset}f=!1}for(m in a){var f=j=a[m],o=d,e=c;k=b;l=o.querySelector("[data-nid='"+f.dataNid+"']").childNodes[f.childIndex];o=o.createRange();o.setStart(l,f.startOffset);o.setEnd(l,f.endOffset);f=o.getClientRects();o=void 0;e&&e.getComputedStyle&&(o=e.getComputedStyle(l.parentNode));e=k.getTransformedClientRects(f,l,o);h(g,e,j.dataNid)}return g}}}(),KindleRendererZoomableFixedContentFactory=
function(){function h(b,a){return b.data&&a.data?b.data.ordinal!==void 0&&a.data.ordinal!==void 0?b.data.ordinal-a.data.ordinal:b.data.ordinal===void 0&&a.data.ordinal===void 0?0:b.data.ordinal!==void 0?-1:1:!b.data&&!a.data?0:b.data?-1:1}function j(b,a){if(b.getBoundingClientRect){var c=b.getBoundingClientRect();if(c)return{top:c.top+a.y,right:c.right+a.x,bottom:c.bottom+a.y,left:c.left+a.x,width:c.width,height:c.height}}return null}function e(b){b.setActive=function(a){if(this.sourceElement){var b=
this.sourceElement.ownerDocument;if(b&&this.data.targetId){var c=$(b).find("#"+this.data.targetId),d=null;a?(this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),c.html().trim().length===0&&(a=d.clone(),a.css({visibility:"visible",color:"black"}),$(c).append(a)),d.hide()),c.show()):(c.hide(),this.data.sourceId&&(d=$(b).find("#"+this.data.sourceId),d.show()))}}};b.isSame=function(a){return a.internalComparison(this.sourceElement)};b.internalComparison=function(a){return this.sourceElement===a};
b.getBounds=function(){if(this.sourceElement){var a=this.sourceElement.ownerDocument;if(a&&this.data.targetId&&(a=$(a).find("#"+this.data.targetId),a.is(":visible"))){var b=a.children(".target-mag"),a=b.length===1?b:a;return j(a.get(0),this.origin)}return j(this.sourceElement,this.origin)}return null}}function d(b,a){b.activate=function(){return a.setActive(!0)};b.deactivate=function(){return a.setActive(!1)};b.isSame=function(b){return a.isSame(b)};b.getBounds=function(){return a.getBounds()};b.internalComparison=
function(b){return a.internalComparison(b)}}function c(c,a,d){c.origin=a;c.sourceElement=d;a=d.getAttribute(b);c.data=jQuery.parseJSON(a)}var b="data-app-amzn-magnify";return{buildList:function(b,a){for(var f=[],j=$(b).find(".app-amzn-magnify").get(),m=0;m<j.length;m++)try{var l={};c(l,a,j[m]);e(l);f.push(l)}catch(o){}f.sort(h);j=[];for(m=0;m<f.length;m++)l={},d(l,f[m]),j.push(l);return j},buildFromCoord:function(b,a,f,h){a:{for(b=KindleRendererUtils.elementFromPoint(b,f-a.x,h-a.y);b;){if($(b).hasClass("app-amzn-magnify")){f=
b;break a}b=b.parentNode}f=null}if(f)try{return b={},c(b,a,f),e(b),a={},d(a,b),a}catch(j){}return null}}}(),KindleRendererZoomableReflowableContentFactory=function(){function h(d){for(;d;){if(d.tagName==="IMG")return d;d=d.parentNode}return null}function j(d){d.clone=function(){if(this.sourceElement)return $(this.sourceElement).clone().get(0)};d.getBounds=function(){var c;if(this.sourceElement){var b=this.sourceElement;c=this.origin;c=b.getBoundingClientRect&&(b=b.getBoundingClientRect())?{top:b.top+
c.y,right:b.right+c.x,bottom:b.bottom+c.y,left:b.left+c.x,width:b.width,height:b.height}:null}else c=null;return c}}function e(d,c){d.clone=function(){return c.clone()};d.getBounds=function(){return c.getBounds()}}return{buildFromCoord:function(d,c,b,g){b-=c.x;g-=c.y;var a=KindleRendererUtils.elementFromPoint(d,b,g);if(a&&a.className.match(/amazon-highlight/)){var f=a;f.style.display="none";a=KindleRendererUtils.elementFromPoint(d,b,g);f.style.display="block"}if(b=h(a))try{return d={},d.origin=c,
d.sourceElement=b,j(d),c={},e(c,d),c}catch(k){}return null},buildFromElement:function(d,c){var b=h(d);if(b)try{var g={};g.origin=c;g.sourceElement=b;j(g);b={};e(b,g);return b}catch(a){}return null}}}(),KindleRendererZoomablesFactory=function(){return{buildList:function(h,j){return $(h.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildList(h,j):[]},buildFromCoord:function(h,j,e,d){return $(h.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildFromCoord(h,
j,e,d):KindleRendererZoomableReflowableContentFactory.buildFromCoord(h,j,e,d)}}}();_KReW_build_id="dc2ed0952f4a30e635629f24c5fe96ccb8270b05";
