function UsageMetrics(g,k,m,n,p,q){function l(a){if(navigator.onLine){var d=0,c=0,k;for(k in b){var g=parseInt(k);d++;g>c&&(c=g)}0<d?e(d,c,a):a&&a()}else a&&a()}function e(a,d,e){function l(a,k){if(a){b=[];d>c&&(c=d);var f=Persistent.get("uploaded");f||(f={});f[h.userId]=a.uploaded;Persistent.set("uploaded",f);var f=Persistent.get("savedAuthInfo"),g=Persistent.get("shownNearQuotaUpsell");f&&f.userInfo&&f.userInfo[h.userId]&&f.userInfo[h.userId].monthEnd&&f.userInfo[h.userId].monthEnd<new Date&&(f.userInfo[h.userId].monthEnd+=
2592E6,g||(g={}),delete g[h.userId],Persistent.set("shownNearQuotaUpsell",g));Persistent.set("savedAuthInfo",f);f=Persistent.get("userLastUpdated")||0;a.userLastUpdated>f&&(Persistent.set("userLastUpdated",a.userLastUpdated),q())}e&&e()}function s(){r.client.NoteStore.getSyncStateWithMetrics(l,h.authenticationToken,{sessions:a})}var h,r;k(function(a){(h=a)&&h.authenticationToken?(r=new JsonRpc(null,["NoteStore.getSyncStateWithMetrics"],g,m,n,p),r.initWithAuthToken(h.authenticationToken,s)):(log.warn("Tried to send UsageMetrics, but not logged in."),
e&&e())})}var c=0,b={};this.recordActivity=function(a){var d;d=new Date;var e=15*Math.floor(d.getMinutes()/15);d.setMinutes(e);d.setSeconds(0);d.setMilliseconds(0);d=Math.round(d.getTime()/1E3);c>=d?a&&a():(b[d]=!0,l(a))};this.send=l;this.getJson=function(){var a={};a.lastSent=c;a.activityBlocks={};for(var d in b)a.activityBlocks[d]=b[d];return a};this.importFromJson=function(a){try{c=a.lastSent,b=a.activityBlocks}catch(d){c=0,b={},log.warn("Failed to import saved UsageMetrics from JSON object.")}};
Object.preventExtensions(this)}Object.preventExtensions(UsageMetrics);
function UsageMetricsManager(g,k,m,n,p,q){function l(){var c={},b;for(b in e)c[b]=e[b].getJson();Persistent.set("usageMetrics",c)}var e={};(function(){try{var c=Persistent.get("usageMetrics"),b;for(b in c)e[b]=new UsageMetrics(g,k,m,n,p,q),e[b].importFromJson(c[b])}catch(a){log.warn("Failure restoring usage metrics. Setting blank."),e={}}})();this.recordActivity=function(){var c="";k(function(b){b&&(c=b.username);c&&(b=e[c],b||(b=new UsageMetrics(g,k,m,n,p,q),e[c]=b),b.recordActivity(l))})};Object.preventExtensions(this)}
Object.preventExtensions(UsageMetricsManager);
