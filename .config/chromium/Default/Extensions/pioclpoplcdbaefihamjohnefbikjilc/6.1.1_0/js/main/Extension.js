function Extension(){var L,F;function Z(a){a?$||($=!0,Persistent.get("localStoragePurged")||(Persistent.set("localStoragePurged",!0),delete localStorage.savedAuthInfo,delete localStorage.userCache),m=new BootstrapInfo(options.get("overrideServiceURL")),g=new Auth(options.get("overrideServiceURL"),options.get("secureProto")),!z&&g&&(z=new UsageMetricsManager(options.get("secureProto")+m.get("serviceHost"),g.isAuthenticated,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"),
g.updateUserStatus)),aa(),/^5\./.test(versionDetect.getLastVersion())&&/^6\./.test(versionDetect.getSourceVersion())&&g.logoutAll(),firstTime.startUp(),M(),sa(),firstTime.msgHandlerOnInit(function(){M()}),G({startup:!0}),Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32)),ta()):log.warn("Version out of date!")}function aa(){SAFARI||N||(N=!0,chrome.contextMenus.removeAll(function(){ua()}))}function C(){alert(Browser.i18n.getMessage("contextMenuPleaseLogin"))}function va(a){var b=
safari.application.activeBrowserWindow.activeTab,c=a.userInfo;switch(a.command){case r.clipPage:ba(b);break;case r.clipScreenshot:ca(b);break;case r.clipSelection:da(c,b);break;case r.clipImage:ea(c,b);break;case r.clipPDF:O(b);break;case r.clipUrl:fa(b)}}function wa(a){var b=a.userInfo;if(!b||!b.url||b.url.match(/^https?/i)&&!b.url.match(/^https?:\/\/extensions.apple.com/i))a.contextMenu.appendContextMenuItem(r.clipPage,Browser.i18n.getMessage("safariContextClipPage"),r.clipPage),a.contextMenu.appendContextMenuItem(r.clipScreenshot,
Browser.i18n.getMessage("safariContextClipScreenshot"),r.clipScreenshot),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(r.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),r.clipSelection),a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(r.clipImage,Browser.i18n.getMessage("safariContextClipImage"),r.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(r.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),
r.clipPDF),a.contextMenu.appendContextMenuItem(r.clipUrl,Browser.i18n.getMessage("safariContextClipUrl"),r.clipUrl)}function y(a){return a.bizAuthenticationToken?"business":a.premium?"premium":"free"}function ba(a){z.recordActivity(g.isAuthenticated);D(a.url)||g.isAuthenticated(function(b){b?Browser.sendToTab(a,{name:"clipFullPage",userId:b.userId,userType:y(b)}):C()})}function ca(a){z.recordActivity(g.isAuthenticated);D(a.url)||g.isAuthenticated(function(b){b?ga({contextMenu:!0},{tab:a}):C()})}function da(a,
b){z.recordActivity(g.isAuthenticated);D(b.url)||g.isAuthenticated(function(c){if(c)if(OPERA&&P(b.url)){var d=UUID.generateGuid();H({noteFilingInfo:{title:b.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:Q(b.url)},pendingNoteKey:d,userId:c.userId,userType:y(c)},{tab:b});I({clipType:"selection",html:a.selectionText,pendingNoteKey:d,userId:c.userId,userType:y(c)},{tab:b})}else Browser.sendToTab(b,{name:"clipSelection",selectionText:a.selectionText,userId:c.userId,userType:y(c)});
else C()})}function ea(a,b){z.recordActivity(g.isAuthenticated);D(b.url)||g.isAuthenticated(function(c){c?Browser.sendToTab(b,{name:"clipImage",imageUrl:a.srcUrl,userId:c.userId,userType:y(c)}):C()})}function O(a){z.recordActivity(g.isAuthenticated);D(a.url)||g.isAuthenticated(function(b){if(b)if(OPERA&&P(a.url)){var c=UUID.generateGuid(),d=Q(a.url);H({noteFilingInfo:{title:a.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:d},pendingNoteKey:c,userId:b.userId,userType:y(b)},
{tab:a});I({clipType:"pdf",html:'<embed src="'+d+'" type="application/pdf"></embed>',pendingNoteKey:c,userId:b.userId,userType:y(b)},{tab:a})}else Browser.sendToTab(a,{name:"clipPdf",userId:b.userId,userType:y(b)});else C()})}function fa(a){z.recordActivity(g.isAuthenticated);D(a.url)||g.isAuthenticated(function(b){if(b)if(OPERA&&P(a.url)){var c=UUID.generateGuid(),d=Q(a.url);H({noteFilingInfo:{title:a.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:d},pendingNoteKey:c,userId:b.userId,
userType:y(b)},{tab:a});I({clipType:"url",html:GlobalUtils.createTitleAndLinkPortionOfUrlClipContent(a.title,d).content.outerHTML,pendingNoteKey:c,userId:b.userId,userType:y(b)},{tab:a})}else Browser.sendToTab(a,{name:"clipUrl",userId:b.userId,userType:y(b)});else C()})}function ua(){N=!1;var a=["http://*/*","https://*/*"],b=["http://*/*","https://*/*","chrome-extension://encfpfilknmenlmjemepncnlbbjlabkc/*","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/*"];chrome.contextMenus.create({id:"fullPage",
title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image","selection"],documentUrlPatterns:a});chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image","selection"],documentUrlPatterns:a});chrome.contextMenus.create({id:"selection",title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:b});chrome.contextMenus.create({id:"image",title:Browser.i18n.getMessage("contextMenuClipImage"),
contexts:["image"],targetUrlPatterns:a});chrome.contextMenus.create({id:"pdf",title:Browser.i18n.getMessage("contextMenuClipPDF"),contexts:["all"],documentUrlPatterns:b});chrome.contextMenus.create({id:"url",title:Browser.i18n.getMessage("contextMenuClipUrl"),contexts:["all"],documentUrlPatterns:b});chrome.contextMenus.onClicked.addListener(function(a,b){switch(a.menuItemId){case "fullPage":ba(b);break;case "screenshot":ca(b);break;case "selection":da(a,b);break;case "image":ea(a,b);break;case "pdf":O(b);
break;case "url":fa(b)}})}function M(){if(SAFARI){var a=function(a,c){if(a&&"clipper"==a.identifier){c&&!/login\.html/.test(a.contentWindow.location.href)&&(a.contentWindow.location.href=R);var d=a.contentWindow.location.href;/login\.html/.test(d)?(1<ha()?a.height=365:a.height=336,a.width=313):/registration\.html/.test(d)?(a.width=589,a.height=440):/two_factor\.html/.test(d)&&(a.width=313,a.height=325)}};safari.application.removeEventListener("validate",function(b){a(b.target.popover)});safari.application.addEventListener("validate",
function(b){a(b.target.popover)});safari.application.removeEventListener("popover",function(b){a(b.target,!0)});safari.application.addEventListener("popover",function(b){a(b.target,!0)})}firstTime.needToShowIntro()?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){firstTime.msgHandlerOnAction(function(){M();G()})})):g.isAuthenticated(function(a){a?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){g.isAuthenticated(function(b){b?ia(a)?(b=S("marketingUrl")+
"/webclipper/guide",Browser.closeTab(a),J=K=null,ja(b,function(a){xa(a,function(a){E(null,{tab:a})})})):E(null,{tab:a}):log.warn("logged out while toggling coordinator")})})):(Browser.removeBrowserActionClickHandler(),Browser.setPopup(R))})}function xa(a,b){L=a.id;F=b}function sa(){function a(a){SAFARI?(G(),a.target.browserWindow?Browser.sendToTab(a.target,{name:"isExtensionOpen"}):a.target.activeTab&&Browser.sendToTab(a.target.activeTab,{name:"isExtensionOpen"})):(G(),Browser.sendToTab({id:a.tabId},
{name:"isExtensionOpen"}))}SAFARI?safari.application.addEventListener("activate",a,!0):(chrome.tabs.onActivated.addListener(a),chrome.windows.onFocusChanged.addListener(function(b){chrome.tabs.query({active:!0,windowId:b},function(b){b&&0<b.length?a({tabId:b[0].id}):log.warn("chrome tabs query did not return a result while changing window focus")})}))}function ia(a){return"undefined"===typeof K||"undefined"===typeof J?!1:a.id===K&&a.url===J}function E(a,b,c){g.isAuthenticated(function(a){if(a){var c=
{pers:a.authenticationToken};a.bizAuthenticationToken&&(c.biz=a.bizAuthenticationToken);Browser.sendToTab(b.tab,{name:"insertSerializationScripts"});Browser.sendToTab(b.tab,{name:"setFavIconUrl",favIconUrl:b.tab.favIconUrl?b.tab.favIconUrl:"http://www.google.com/s2/favicons?domain="+encodeURIComponent(b.tab.url)});Browser.sendToTab(b.tab,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+m.get("serviceHost"),userId:a.userId,username:a.username,authTokens:c,premium:a.premium,fullName:a.fullName,
alwaysTags:options.get("alwaysTagWith")?options.get("alwaysTags"):null},function(){chrome&&chrome.runtime&&chrome.runtime.lastError&&alert(Browser.i18n.getMessage("popup_couldntStart"))})}else log.error("logged out while toggling clipper.")})}function ka(a,b,c,d,f){var g=[],e=Math.max(3-a.length,2),l=[],g=[];a||(a=[]);c||(c=[]);for(var k=0;k<c.length&&!(l.length>=e&&g.length>=e);k++)c[k].inBusinessNotebook=!0,f[c[k].notebookGuid].joined?l.push(c[k]):(c[k].notebookName=f[c[k].notebookGuid].name,c[k].contact=
c[k].attributes.lastEditedBy||c[k].attributes.author||f[c[k].notebookGuid].contact,g.push(c[k]));k=Math.min(e,l.length);k=Math.max(e-k,1);c=Math.min(k,g.length);e=l.slice(0,e-c);for(k=0;k<c;k++)e.push(g[k]);g=a.slice(0,3-e.length);for(k=0;k<e.length;k++)g.push(e[k]);for(k=0;k<g.length;k++)g[k].shardId=g[k].inBusinessNotebook?d:b;return g}function T(){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated"));Browser.setIcon("images/wc6-update")}function U(){firstTime.isUpgraded()?T():(Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),
Browser.setIcon("images/web-clipper"))}function la(){firstTime.isUpgraded()?T():(Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),Browser.setIcon("images/web-clipper-sign-in"))}function G(a,b,c){firstTime.isUpgraded()?T():g.isAuthenticated(function(b){b?a&&a.startup||U():la()})}function P(a){return/^chrome-extension:\/\/(encfpfilknmenlmjemepncnlbbjlabkc|oemmndcbldboiebfnladdacbdfmadadm)\//.test(a)}function Q(a){return/^chrome-extension:\/\/(encfpfilknmenlmjemepncnlbbjlabkc|oemmndcbldboiebfnladdacbdfmadadm)\/(.+)/.exec(a)[2]}
function D(a){a=(a+"").toLowerCase();a=a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)?!0:!1;return a?(alert(Browser.i18n.getMessage("illegalUrlClipFailure")),!0):!1}function ma(a,b,c){log.log("Got restart message...");Browser.removeMessageHandlers();window.location.reload()}function na(a,b,c){function d(c){if("simSearch"==a.type)Browser.sendToTab(b.tab,{name:"simSearch_isAuthenticated",auth:c});else if("clipResult"==a.type)Browser.sendToTab(b.tab,{name:"clipResult_isAuthenticated",
auth:c});else if("options"==a.type)Browser.sendToTab(b.tab,{name:"options_isAuthenticated",auth:c,option:a.option});else if("pdfTooltip"==a.type){var d=Persistent.get(c.userId+"_pdfTooltipShown");Persistent.set(c.userId+"_pdfTooltipShown",!0);Browser.sendToTab(b.tab,{name:"pdfTooltip_isAuthenticated",auth:c,pdfTooltipShown:d})}else if("tooltip"==a.type){c={name:"tooltip_isAuthenticated",auth:c};if(a.bootstrapInfo)for(d in c.bootstrapInfo={},a.bootstrapInfo)c.bootstrapInfo[d]=m.get(d);Browser.sendToTab(b.tab,
c)}}b&&b.tab?g.isAuthenticated(d):g.isAuthenticated(c)}function ta(){var a=Persistent.get("lastActiveTimes");a||(a={});var b=g.getCurrentUser(),b=b?b:"unauthed";a[b]||(a[b]={time:(new Date).getTime(),count:0});a.unauthed||(a.unauthed={time:(new Date).getTime(),count:0});Persistent.set("lastActiveTimes",a)}function V(a,b,c){g.logoutAll(a.authExpired);Browser.sendToTab(b.tab,{name:"logoutCallback"});Browser.removeBrowserActionClickHandler();Browser.setPopup(R)}function S(a){return m?m.get(a):""}function ha(){return m?
m.getLength():0}function oa(a,b,c){ja(a.url);c&&c()}function ja(a,b){if(SAFARI){var c=safari.application.activeBrowserWindow.openTab();c.url=a;b&&b(c)}else chrome.tabs.create({url:a,selected:!0},b)}function pa(a,b,c){var d=600,f=600;b="";a.width&&(d=a.width);a.height&&(f=a.height);a.url&&(b=a.url);b&&(a={url:b,width:d,height:f,type:a.type},SAFARI?safari.application.openBrowserWindow().activeTab.url=b:chrome.windows.create(a));c&&c()}function qa(a,b,c){try{z.recordActivity()}catch(d){log.error("Failed to record user activity: "+
d.trace||d.stack||JSON.stringify(d))}c&&c()}function ga(a,b,c){Browser.sendToTab(b.tab,{name:"hideScrollbar"});a.contextMenu?Browser.sendToTab(b.tab,{name:"toggleCoordinator",for:"screenshot",contextMenu:!0}):Browser.sendToTab(b.tab,{name:"hideCoordinator",for:"screenshot",tool:a.tool,showSubtools:a.showSubtools})}function W(a,b,c){b=document.getElementById("temp-textarea");b||(b=document.createElement("textarea"),b.id="temp-textarea",document.body.appendChild(b));b.value=a.text;b.select();document.execCommand("copy",
!1,null)}function I(a,b,c){e[a.pendingNoteKey]||(e[a.pendingNoteKey]=new PendingNote);a.error?(e[a.pendingNoteKey].filingInfo?delete e[a.pendingNoteKey]:e[a.pendingNoteKey].error=!0,log.error((b&&b.tab?b.tab.url+"\n\n":"")+a.error),Browser.sendToTab(b.tab,{name:"handleFailure"}),b&&b.tab&&b.tab.url&&Analytics.trackEvent("0","Errors","Serializer",b.tab.url)):("skitch"==a.clipType?c=a.content:(c='<br/><div style="position: relative;',a.width&&parseInt(a.width)&&(c+=" max-width: "+a.width+";"),c+='">'+
a.html+"</div><br/>",c=GlobalUtils.removeControlCharacters(c)),e[a.pendingNoteKey].content=c,e[a.pendingNoteKey].resources=a.resources,e[a.pendingNoteKey].share=a.share,e[a.pendingNoteKey].updateGuid=a.updateGuid,e[a.pendingNoteKey].previousToken=a.previousToken,e[a.pendingNoteKey].recommendationText=a.recommendationText,e[a.pendingNoteKey].notDualLink=Boolean(a.hasTextHighlights)||-1<["clearly","email","pdf","skitch"].indexOf(a.clipType),"clearly"==a.clipType&&(a.contentClass="Clearly"),Analytics.trackEvent(a.userId,
"Clip Type",a.clipType,a.userType),e[a.pendingNoteKey].filingInfo?(e[a.pendingNoteKey].filingInfo.contentClass=a.contentClass,X(a.pendingNoteKey,b.tab||b.sender.tab)):e[a.pendingNoteKey].tempContentClass=a.contentClass)}function H(a,b,c){e[a.pendingNoteKey]||(e[a.pendingNoteKey]=new PendingNote);e[a.pendingNoteKey].error?delete e[a.pendingNoteKey]:(e[a.pendingNoteKey].relatedNotes=a.noteFilingInfo.relatedNotes,delete a.noteFilingInfo.relatedNotes,a.noteFilingInfo.title=GlobalUtils.removeControlCharacters(a.noteFilingInfo.title).slice(0,
EDAM_NOTE_TITLE_LEN_MAX),e[a.pendingNoteKey].filingInfo=a.noteFilingInfo,e[a.pendingNoteKey].filingInfo.contentClass=e[a.pendingNoteKey].tempContentClass,delete e[a.pendingNoteKey].tempContentClass,e[a.pendingNoteKey].originatingTab=b.tab||b.sender.tab,Analytics.trackEvent(a.userId,"Comments",a.noteFilingInfo.comment?"added comments":"did not add comments",a.userType,a.noteFilingInfo.comment?a.noteFilingInfo.comment.length:null),Analytics.trackEvent(a.userId,"Tags",a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?
"added tags":"did not add tags",a.userType,a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?a.noteFilingInfo.tagNames.length:null),ya({pendingNoteKey:a.pendingNoteKey},b),e[a.pendingNoteKey].content&&X(a.pendingNoteKey,b.tab||b.sender.tab))}function X(a,b){var c=options.get("secureProto")+m.get("serviceHost");g.isAuthenticated(function(d){var f;"pers"==e[a].filingInfo.type?f=d.authenticationToken:"linked"==e[a].filingInfo.type?f=e[a].filingInfo.auth:"biz"==e[a].filingInfo.type&&(f=d.bizAuthenticationToken);
(new Submitter({submit:f,pers:d.authenticationToken,previous:e[a].previousToken},g.getUserInfo().premium,e[a].updateGuid,c,b,g.getCurrentUser(),function(c){c&&(e[a].share?(za({auth:f,guid:c.guid,noteSize:c.noteSize,shardId:c.shardId,source:e[a].notDualLink?null:e[a].filingInfo.url},{tab:b}),e[a].updateGuid?Analytics.trackEvent(g.getCurrentUser(),"share and save","share (update)",y(d)):Analytics.trackEvent(g.getCurrentUser(),"share and save","share (first time)",y(d))):e[a].updateGuid?Analytics.trackEvent(g.getCurrentUser(),
"share and save","save (after share)",y(d)):Analytics.trackEvent(g.getCurrentUser(),"share and save","save (no share)",y(d)));delete e[a]})).createNoteWithThrift(e[a].filingInfo,e[a].content,e[a].resources)},!0)}function ya(a,b,c){if(e[a.pendingNoteKey]){var d={name:"receiveClipResultInfo"};d.title=e[a.pendingNoteKey].filingInfo.title;d.type=e[a.pendingNoteKey].filingInfo.type;d.notebookName=e[a.pendingNoteKey].filingInfo.notebookName;d.tagNames=e[a.pendingNoteKey].filingInfo.tagNames;d.baseUrl=options.get("secureProto")+
m.get("serviceHost");d.locale=m.getName();d.userId=g.getCurrentUser();d.url=e[a.pendingNoteKey].filingInfo.url;d.premium=g.getUserInfo().premium;d.updateGuid=e[a.pendingNoteKey].updateGuid;g.getAuthTokens(function(c){c&&("linked"==d.type&&(c.linked=e[a.pendingNoteKey].filingInfo.auth),d.auth=c,Browser.sendToTab(b.tab||b.sender.tab,d))})}}function za(a,b,c){function d(c,d){if(c){var f=options.get("secureProto")+m.get("serviceHost")+"/shard/"+a.shardId+"/sh/"+a.guid+"/"+c;Browser.sendToTab(b.tab,{name:"doneSharing",
guid:a.guid,noteSize:a.noteSize,savedAuthInfo:Persistent.get("savedAuthInfo"),shownNearQuotaUpsell:Persistent.get("shownNearQuotaUpsell"),source:a.source,token:a.auth,uploaded:Persistent.get("uploaded"),url:f});a.source?W({text:a.source}):W({text:f})}else w(d,b.tab)}var f;f=new JsonRpc(null,["NoteStore.shareNote"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.shareNote(d,a.auth,a.guid)})}function w(a,
b){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken/.test(a.trace)?(V({authExpired:!0},{tab:b}),b&&Browser.sendToTab(b,{name:"tellUserToLogin"})):log.error(a.trace||a.message||a.stack||a)}var R="content/auth_tools/login.html",N=!1,ra=!0,e={},m,K,J;F=L=null;var $=!1,g,z;window.addEventListener("offline",function(a){log.log("Went offline.")});window.addEventListener("online",function(a){log.log("Went online.");0<Object.keys(e)&&log.log("processing offline clips");
for(var b in e)X(b,e[b].originatingTab)});var r={clipPage:"EN_safariContextClipPage",clipScreenshot:"EN_safariContextClipScreenshot",clipSelection:"EN_safariContextClipSelection",clipImage:"EN_safariContextClipImage",clipPDF:"EN_safariContextClipPDF",clipUrl:"EN_safariContextClipUrl"};SAFARI&&(safari.application.addEventListener("contextmenu",wa,!1),safari.application.addEventListener("command",va,!1));Browser.addMessageHandlers({LOGOUT:V,main_isAuthenticated:na,main_getTextResource:function(a,b,
c){function d(){if(this.readyState==this.DONE){var a={name:"content_textResource",href:this.href};200==this.status&&(a.responseText=this.responseText);Browser.sendToTab(b.tab,a)}}a&&a.href&&(c=new XMLHttpRequest,c.href=a.href,c.open("GET",a.href),c.onreadystatechange=d,c.send())},main_performNoteSearch:function(a,b,c){function d(a,c){a.name="sameSiteNotes";Browser.sendToTab(b.tab,a)}function f(a){h=a;(n.bizAuthenticationToken&&t||!n.bizAuthenticationToken)&&d(u())}function e(a){t=a;h&&d(u())}function u(){for(var a=
0;a<h.notes.list.length;a++)h.notes.list[a].shardId=q.shardId;if(n.bizAuthenticationToken){for(var a=h.notes.list.slice(0),b=0;b<t.notes.list.length;b++)t.notes.list[b].inBusinessNotebook=!0,t.notes.list[b].shardId=s.shardId,a.push(t.notes.list[b]);a.sort(function(a,b){return b.updated-a.updated});a=a.slice(0,v);h.notesSize=Math.min(h.notesSize+t.notesSize,v);h.totalNotes+=t.totalNotes;h.notes.list=a}return h}function l(){q.client.NoteStoreExtra.findNotesWithSnippet(f,n.authenticationToken,A,0,v,
k);n.bizAuthenticationToken&&s.client.NoteStoreExtra.findNotesWithSnippet(e,n.bizAuthenticationToken,A,0,v,k)}var k=a.resultSpec,A=a.noteFilter,n,q,s,h,t,v=10;a.maxNotes&&(v=a.maxNotes);g.isAuthenticated(function(a){if((n=a)&&n.authenticationToken){var b=options.get("secureProto")+m.get("serviceHost");q=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],b,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));q.initWithAuthToken(n.authenticationToken,function(){n.bizAuthenticationToken?
(s=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],b,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),s.initWithAuthToken(n.bizAuthenticationToken,l)):l()})}else d(null)});c&&c()},simSearch_getNotesRelatedToSearchQuery:function(a,b,c){Browser.sendToTab(b.tab,{name:"getInfo"})},simSearch_receivePageInfo:function(a,b,c){function d(){var c;if("Google"!==a.info.searchEngine&&p.bizAuthenticationToken){var d=Math.max(3-s.length,2),f=[];c=[];for(var e=0;e<h.length&&
!(f.length>=d&&c.length>=d);e++)h[e].inBusinessNotebook=!0,h[e].shardId=q.shardId,v[h[e].notebookGuid].joined?f.push(h[e]):(h[e].notebookName=v[h[e].notebookGuid].name,h[e].contact=h[e].attributes.lastEditedBy||h[e].attributes.author||v[h[e].notebookGuid].contact,c.push(h[e]));for(var e=Math.min(d,f.length),e=Math.max(d-e,1),g=Math.min(e,c.length),d=f.slice(0,d-g),e=0;e<g;e++)d.push(c[e]);c=s.slice(0,3-d.length);for(e=0;e<d.length;e++)c.push(d[e]);0<t.length&&(c[Math.max(0,c.length-1)]=t[0]);c=0<
c.length?c:null;Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c,type:"all",tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+"_noSimsearchResultsShown")})}else{if(p.bizAuthenticationToken){d=[];c=[];for(f=0;f<h.length&&!(3<=d.length&&3<=c.length);)h[f].inBusinessNotebook=!0,h[f].shardId=q.shardId,v[h[f].notebookGuid].joined?d.push(h[f]):(h[f].notebookName=v[h[f].notebookGuid].name,h[f].contact=h[f].attributes.lastEditedBy||
h[f].attributes.author||v[h[f].notebookGuid].contact,c.push(h[f])),f++;f=Math.max(3-d.length,1);f=Math.min(f,c.length);h=d.slice(0,3-f);for(d=0;d<f;d++)h.push(c[d]);0<t.length&&(h[Math.max(0,h.length-1)]=t[0]);c=[];0<s.length&&(c[0]=s);0<h.length&&(c[1]=h)}else c=0<s.length?[s]:[];Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c[0],type:"account",isBizUser:Boolean(p.bizAuthenticationToken),tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+
"_noSimsearchResultsShown")});p.bizAuthenticationToken&&Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c[1],type:"library",tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+"_noSimsearchResultsShown")})}}function f(a,c){a?(s=a.relatedNotes?a.relatedNotes.list:[],(p.bizAuthenticationToken&&h&&t||!p.bizAuthenticationToken)&&d()):w(c,b.tab)}function e(a,c){if(a){if(a.relatedNotes){for(var f=0;f<a.containingNotebooks.list.length;f++){var g=
a.containingNotebooks.list[f];v[g.guid]={joined:g.hasSharedNotebook,name:g.notebookDisplayName,contact:g.contactName}}h=a.relatedNotes.list}else h=[];s&&t&&d()}else w(c,b.tab)}function u(a,c){t=[];a?a.experts&&a.experts.list&&0<a.experts.list.length&&t.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):w(c,b.tab);s&&h&&d()}function l(){return{url:a.info.url,text:a.info.recommendationText,query:a.info.query,
relatedNotesResultSpec:{includeTitle:!0,includeUpdated:!0,includeAttributes:!0,includeLargestResourceSize:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0}}}function k(){JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:p.userId,type:"pers"},n.client.NoteStoreExtra.getFilingRecommendations,f,p.authenticationToken,l())}function A(){JsonQueue.handleExpensiveOpRequest({shardId:q.shardId,userId:p.userId,type:"biz"},q.client.NoteStoreExtra.getFilingRecommendations,e,p.bizAuthenticationToken,
l());q.client.NoteStore.findRelated(u,p.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}var n,q,s,h,t,v={},p,B;g.isAuthenticated(function(a){p=a;B=options.get("secureProto")+m.get("serviceHost");n=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.listLinkedNotebooks"],B,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));n.initWithAuthToken(p.authenticationToken,k);p.bizAuthenticationToken&&(q=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations",
"NoteStore.findRelated"],B,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),q.initWithAuthToken(p.bizAuthenticationToken,A))})},togglePDFContextMenuOption:function(a,b,c){SAFARI||a.show==ra||((ra=a.show)?aa():chrome.contextMenus.remove("pdf"))},getNotebooks:function(a,b,c){function d(){t.client.NoteStore.listNotebooks(f,a.authTokens.pers);t.client.NoteStore.listLinkedNotebooks(e,a.authTokens.pers)}function f(a,c){if(a){if(a.list&&0<a.list.length){for(var d=[],f={},
e=0;e<a.list.length;e++)a.list[e].stack?(f[a.list[e].stack]||(f[a.list[e].stack]=[]),f[a.list[e].stack].push({defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name,stack:a.list[e].stack,sharedToOthers:0<Math.max(a.list[e].sharedNotebooksSize,a.list[e].sharedNotebookIdsSize)||a.list[e].published})):d.push({class:"notebook",defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name,sharedToOthers:0<Math.max(a.list[e].sharedNotebooksSize,a.list[e].sharedNotebookIdsSize)||
a.list[e].published});for(var h in f)d.push({class:"stack",name:h,notebooks:f[h]});Browser.sendToTab(b.tab,{name:"receivePersNotebooks",notebooks:d,recentNotebooks:Persistent.get("recentNotebooks")})}}else p==g.getCurrentUser()&&w(c,b.tab)}function e(c,d){if(c){var f;a.authTokens.biz&&(f=g.getUserInfo(p).businessId);s=c.list.length;for(var Y=0;Y<c.list.length;Y++){var l=c.list[Y];l.shareKey=l.shareKey||l.sharedNotebookGlobalId;f&&f==l.businessId?k[l.shareKey]={shareName:l.shareName,stack:l.stack}:
A[l.shareKey]={shareName:l.shareName,stack:l.stack};q[l.shardId]||(q[l.shardId]=new JsonRpc(l.shardId,["NoteStore.authenticateToSharedNotebook","NoteStore.getSharedNotebookByAuth","NoteStore.getNotebook"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),q[l.shardId].initWithAuthToken(a.authTokens.pers));var B=q[l.shardId];(function(){var c=l;if(c.shareKey)B.client.NoteStore.authenticateToSharedNotebook(function(a,b){a&&(a.shardId=c.shardId);u(a,b)},c.shareKey,
a.authTokens.pers);else if(h++,s==h){for(var d in x)n.push({class:"stack",name:d,notebooks:x[d]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}})()}}else p==g.getCurrentUser()&&w(d,b.tab)}function u(a,c){if(a){var d=q[a.shardId];r[a.authenticationToken]=setTimeout(function(){h++;if(s==h){for(var a in x)n.push({class:"stack",name:a,notebooks:x[a]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}},
1E4);d.client.NoteStore.getSharedNotebookByAuth(function(b,c){b&&(b.authenticationToken=a.authenticationToken,b.username=a.user?a.user.username:a.publicUserInfo.username,b.shardId=a.shardId);clearTimeout(r[a.authenticationToken]);l(b,c)},a.authenticationToken)}else if(p==g.getCurrentUser()&&(h++,w(c,b.tab),s==h)){for(d in x)n.push({class:"stack",name:d,notebooks:x[d]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}}function l(c,
d){h++;c?c.notebookModifiable&&(c.shareKey=c.shareKey||c.globalId,k[c.shareKey]?(h--,v.client.NoteStore.getNotebook(function(a,d){a&&(a.name=k[c.shareKey].shareName,a.stack=k[c.shareKey].stack);h++;if(a){var f={guid:a.guid,name:a.name,type:"biz"};a.contact.username!=B&&(f.bizUsername=a.contact.name);a.restrictions&&(f.noShare=a.restrictions.noShareNotes);a.stack?(x[a.stack]||(x[a.stack]=[]),x[a.stack].push(f)):(f.class="notebook",n.push(f))}else p==g.getCurrentUser()&&w(d,b.tab);if(s==h){for(var e in x)n.push({class:"stack",
name:e,notebooks:x[e]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}},a.authTokens.biz,c.notebookGuid)):A[c.shareKey]?(h--,q[c.shardId].client.NoteStore.getNotebook(function(a,d){a&&(a.authenticationToken=c.authenticationToken,a.shareName=A[c.shareKey].shareName,a.stack=A[c.shareKey].stack,a.username=c.username);h++;if(a){var f={auth:a.authenticationToken,guid:a.guid,name:a.shareName,linkedUsername:a.username,type:"linked"};
a.restrictions&&(f.noShare=a.restrictions.noShareNotes);a.stack?(x[a.stack]||(x[a.stack]=[]),x[a.stack].push(f)):(f.class="notebook",n.push(f))}else p==g.getCurrentUser()&&w(d,b.tab);if(s==h){for(var e in x)n.push({class:"stack",name:e,notebooks:x[e]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}},c.authenticationToken,c.notebookGuid)):log.warn("received unknown shared notebook"+JSON.stringify(c))):p==g.getCurrentUser()&&w(d,
b.tab);if(s==h){for(var f in x)n.push({class:"stack",name:f,notebooks:x[f]});Browser.sendToTab(b.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}}var k={},A={},n=[],q={},s=0,h=0,t,v,p=a.userId,B=a.username,x={},r={};(function(){t=new JsonRpc(null,["NoteStore.listNotebooks","NoteStore.listLinkedNotebooks"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));t.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?
(v=new JsonRpc(null,["NoteStore.getNotebook"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),v.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getTags:function(a,b,c){function d(){u.client.NoteStore.listTags(e,a.authTokens.pers);a.authTokens.biz&&l.client.NoteStore.listTags(f,a.authTokens.biz)}function f(a,c){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);Browser.sendToTab(b.tab,{name:"receiveBizTags",tags:d})}}else k==
g.getCurrentUser()&&w(c,b.tab)}function e(a,c){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);Browser.sendToTab(b.tab,{name:"receivePersTags",tags:d})}}else k==g.getCurrentUser()&&w(c,b.tab)}var u,l,k=a.userId;(function(){u=new JsonRpc(null,["NoteStore.listTags"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));u.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?(l=new JsonRpc(null,["NoteStore.listTags"],
null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),l.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getSmartFilingInfo:function(a,b,c){function d(){var b;n&&(b=JSON.parse(JSON.stringify(n)));var c;q&&(c=JSON.parse(JSON.stringify(q)));var d={},f;f=ka(b&&b.relatedNotes?b.relatedNotes.list:[],s.shardId,c&&c.relatedNotes?c.relatedNotes.list:[],h?h.shardId:null,r);0<f.length&&(d.relatedNotes={list:f});"smartFiling"==options.get("notebookSelection")&&(b&&b.notebook&&
(d.notebook=b.notebook),a.authTokens.biz&&options.get("bizSmartFilingEnabled")&&c&&c.notebook&&!c.notebook.restrictions.noCreateNotes&&(d.notebook=c.notebook,d.notebook.biz=!0));options.get("smartFilingTags")&&(b&&b.tags&&(d.tags=b.tags),a.authTokens.biz&&c&&c.tags&&d.notebook&&d.notebook.biz&&(d.tags=c.tags));return d}function f(){s=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));s.initWithAuthToken(a.authTokens.pers,
function(){a.authTokens.biz?(h=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),h.initWithAuthToken(a.authTokens.biz,function(){e()})):e()})}function e(){var c={query:a.query,relatedNotesResultSpec:p,text:a.recText,url:b.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:s.shardId,userId:k,type:"pers"},s.client.NoteStoreExtra.getFilingRecommendations,l,a.authTokens.pers,c);a.authTokens.biz&&(c.relatedNotesResultSpec.maxResults=
10,JsonQueue.handleExpensiveOpRequest({shardId:h.shardId,userId:k,type:"biz"},h.client.NoteStoreExtra.getFilingRecommendations,u,a.authTokens.biz,c))}function u(a,c){v=!0;if(a){if(a.relatedNotes){r={};for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];r[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}q=a}else k==g.getCurrentUser()&&w(c,b.tab);t&&Browser.sendToTab(b.tab,{name:"receiveSmartFilingInfo",filingInfo:d()})}function l(c,
f){t=!0;c?n=c:k==g.getCurrentUser()&&w(f,b.tab);(a.authTokens.biz&&v||!a.authTokens.biz)&&Browser.sendToTab(b.tab,{name:"receiveSmartFilingInfo",filingInfo:d()})}var k=a.userId,r,n,q,s,h,t,v,p={includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0};(a.recText&&a.recText.trim()||a.query&&a.query.trim())&&f()},getKeyboardShortcuts:function(a,b,c){if(b&&b.tab){c={};for(var d=0;d<a.shortcuts.length;d++)c[a.shortcuts[d]]=options.get(a.shortcuts[d]);
Browser.sendToTab(b.tab,{name:"receiveKeyboardShortcuts",keys:c,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}},main_setOption:function(a,b,c){for(var d in a.options)options.set(d,a.options[d]);c&&c()},main_clearOptions:function(a,b,c){options.clear(a.options);c={};for(var d in a.options)c[a.options[d]]=options.get(a.options[d]);Browser.sendToTab(b.tab,{name:"optionsCleared",options:c})},main_getConfig:function(a,b,c){if(b&&b.tab){var d={name:"config"};a.returnName&&(d.name=a.returnName);
if(a.options){d.options={};for(var f in a.options)d.options[f]=options.get(f)}if(a.bootstrapInfo)for(f in d.bootstrapInfo={},a.bootstrapInfo)m&&(d.bootstrapInfo[f]=m.get(f));Browser.sendToTab(b.tab,d);c&&c(d)}},main_openTab:oa,main_openWindow:pa,main_restart:ma,main_recordActivity:qa,main_getL10n:function(a,b,c){Browser.sendToTab(b.tab,{name:"l10nData",data:Browser.i18n._getL10nData()});c&&c()},bounce:function(a,b,c){b.tab&&Browser.sendToTab(b.tab,a.message)},bounceToAll:function(a,b,c){Browser.getAllTabs(function(b){for(var c=
0;c<b.length;c++)Browser.sendToTab(b[c],a.message)})},insertCSS:function(a,b,c){Browser.insertCSS(a.filename)},getPersistentFlag:function(a,b,c){Browser.sendToTab(b.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)});a.set&&Persistent.set(a.key,a.setValue)},captureScreenshot:function(a,b,c){setTimeout(function(){a.contextMenu?Browser.captureVisibleTab(a,b,function(a){g.isAuthenticated(function(c){if(c){var e=UUID.generateGuid();Browser.sendToTab(b.tab,{name:"showClipResult",
pendingNoteKey:e,userId:c.userId,userType:y(c)});for(var g=atob(a.split(",")[1]),l=new Uint8Array(g.length),k=0;k<g.length;k++)l[k]=g.charCodeAt(k);I({clipType:"skitch",content:'<img src="resource:0"></img>',contentClass:"evernote.skitch",pendingNoteKey:e,resources:[{bytes:l,mime:"image/png"}],userId:c.userId,userType:y(c)},b);Browser.sendToTab(b.tab,{name:"finishContextMenuScreenshot"})}else log.error("logged out while taking screenshot from context menu")})}):Browser.captureVisibleTab(a,b)},300)},
prepareScreenshot:ga,copyText:W,getOption:function(a,b,c){a.name="receiveOption";"defaultClipAction"==a.option?(a.key="clipAction","lastUsed"==options.get("defaultClipAction")?(c=Persistent.get("lastUsedAction"),a.value=c?c:"ARTICLE"):a.value=options.get("clipAction")):(a.key=a.option,a.value=options.get(a.key));delete a.option;Browser.sendToTab(b.tab,a)},receiveNoteContent:I,receiveNoteFilingInfo:H,getRelatedNotes:function(a,b,c){function d(){Browser.sendToTab(b.tab,{name:"relatedNotes",relatedNotes:ka(l?
l:[],n.shardId,k?k:[],q?q.shardId:null,r)})}function f(){var c={relatedNotesResultSpec:{includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:e[a.pendingNoteKey].recommendationText,url:b.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:a.userId,type:"pers"},n.client.NoteStoreExtra.getFilingRecommendations,u,a.tokens.authenticationToken,c);a.tokens.bizAuthenticationToken&&JsonQueue.handleExpensiveOpRequest({shardId:q.shardId,
userId:a.userId,type:"biz"},q.client.NoteStoreExtra.getFilingRecommendations,g,a.tokens.bizAuthenticationToken,c)}function g(a,c){if(a)if(a.relatedNotes&&a.relatedNotes.list){k=a.relatedNotes.list;for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];r[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}else k=[];else k=[],w(c,b.tab);l&&d()}function u(c,f){c?l=c.relatedNotes&&c.relatedNotes.list?c.relatedNotes.list:[]:(l=[],w(f,
b.tab));(!a.tokens.bizAuthenticationToken||a.tokens.bizAuthenticationToken&&k)&&d()}var l,k,r={},n,q;e[a.pendingNoteKey]?e[a.pendingNoteKey].relatedNotes?Browser.sendToTab(b.tab,{name:"relatedNotes",relatedNotes:e[a.pendingNoteKey].relatedNotes}):e[a.pendingNoteKey].recommendationText&&e[a.pendingNoteKey].recommendationText.trim()?(n=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),n.initWithAuthToken(a.tokens.authenticationToken,
function(){a.tokens.bizAuthenticationToken?(q=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),q.initWithAuthToken(a.tokens.bizAuthenticationToken,f)):f()})):Browser.sendToTab(b.tab,{name:"relatedNotes",relatedNotes:[]}):Browser.sendToTab(b.tab,{name:"relatedNotes",relatedNotes:[]})},toggleClipper:E,trackEvent:function(a,b,c){Analytics.trackEvent(a.userId,a.category,a.action,a.label,a.value)},emailNote:function(a,
b,c){function d(c,d){Browser.sendToTab(b.tab,{name:"emailResult",numEmailed:a.recipients.length,error:d});d&&w(d,b.tab)}var f;f=new JsonRpc(null,["NoteStore.emailNote","NoteStoreExtra.emailNotesSharedWorkaround"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){a.sharedAuth?f.client.NoteStoreExtra.emailNotesSharedWorkaround(d,a.sharedAuth,a.persAuth,{javaClass:"java.util.ArrayList",list:a.recipients},{javaClass:"java.util.ArrayList",
list:[a.noteGuid]},a.message):f.client.NoteStore.emailNote(d,a.auth,{guid:a.noteGuid,toAddresses:{javaClass:"java.util.ArrayList",list:a.recipients},message:a.message})})},findContacts:function(a,b,c){function d(a,c){a&&a.list?Browser.sendToTab(b.tab,{name:"receiveContacts",contacts:a.list}):w(c,b.tab)}var f;f=new JsonRpc(null,["NoteStore.findContacts"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.findContacts(d,
a.auth,{maxEntries:5,prefix:a.prefix})})},showOpenState:function(){Browser.setIcon("images/close-ext")},showLoggedInState:U,showLoggedInOrOutState:G,setReminder:function(a,b,c){function d(a,c){c&&w(c,b.tab)}var f;f=new JsonRpc(null,["NoteStore.updateNote"],null,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){var b={source:"web.clip",sourceURL:a.sourceURL,reminderOrder:a.reminderOrder};a.reminderTime&&(b.reminderTime=a.reminderTime);
f.client.NoteStore.updateNote(d,a.auth,{guid:a.noteGuid,title:a.title,attributes:b})})},clipResultShown:function(a,b,c){H({noteFilingInfo:{title:b.tab.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:b.tab.url},pendingNoteKey:a.pendingNoteKey,userId:a.userId,userType:a.userType},b)},getPersistentValue:function(a,b,c){b&&b.tab&&Browser.sendToTab(b.tab,{name:"receivePersistentValue",key:a.key,value:Persistent.get(a.key)})},setPersistentValue:function(a,b,c){Persistent.set(a.key,
a.value)},downloadThumbnail:function(a,b,c){c=new XMLHttpRequest;c.guid=a.guid;c.open("POST",a.url,!0);c.responseType="arraybuffer";c.onreadystatechange=function(){if(200==this.status&&4==this.readyState){for(var a="",c=new Uint8Array(this.response),e=0;e<c.length;e++)a+=String.fromCharCode(c[e]);Browser.sendToTab(b.tab,{name:"receiveThumbnail",guid:this.guid,datauri:"data:"+this.getResponseHeader("Content-type")+";base64,"+btoa(a)})}};a.biz?a.size?c.send("auth="+a.tokens.biz+"&size="+a.size):c.send("auth="+
a.tokens.biz):c.send("auth="+a.tokens.pers+"&size="+a.size)},cropImage:function(a,b,c){var d=new Image;d.onload=function(){var c=document.createElement("canvas");c.width=Math.min(150,a.width);c.height=Math.min(150,a.height);c.getContext("2d").drawImage(d,Math.max(0,(a.width-150)/2),Math.max(0,(a.height-150)/2),c.width,c.height,0,0,c.width,c.height);Browser.sendToTab(b.tab,{name:"receiveCroppedImage",datauri:c.toDataURL(),url:a.url})};d.src=a.url},tourLoaded:function(a,b,c){K=b.tab.id;J=b.tab.url;
a=b.tab;Browser.sendToTab(a,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+m.get("serviceHost"),userId:"fake",username:Browser.i18n.getMessage("fleFakeUser"),authTokens:{},premium:!1,fullName:Browser.i18n.getMessage("fleFakeUser"),dontStartPreview:!0});Browser.sendToTab(a,{name:"startTour"});c&&c()},finishTour:function(a,b,c){J=K=null},isTouring:function(a,b,c){a=ia(b.tab);Browser.sendToTab(b.tab,{name:"isTouring",data:a});c&&c()},loadXMLHttpRequest:function(a,b,c){var d=new XMLHttpRequest;
d.onreadystatechange=function(){4===d.readyState&&Browser.sendToTab(b.tab,{name:"receiveXMLHttpRequest",response:d.responseText})};d.open("GET",a.url);d.send()},tabLoaded:function(a,b,c){b&&b.tab&&(a=b.tab,console.log("Autorun"),a.id===L&&F&&(b=F,L=F=null,console.log("Executed"),b(a)))},sendAppFeedback:function(a,b,c){g.isAuthenticated(function(b){if(b){var c=options.get("secureProto")+m.get("serviceHost"),c=new Thrift.BinaryHttpTransport(c+"/shard/"+b.shardId+"/utility"),c=new Thrift.BinaryProtocol(c),
c=new UtilityClient(c),e=new AppFeedback,u=new SupportTicket;u.applicationVersion=Browser.EVERNOTE_VERSION;u.contactEmail=g.getUserInfo(b.userId).email;u.osInfo=a.os;u.deviceInfo=a.browser;u.subject=a.title;u.issueDescription="User agent: "+navigator.userAgent+"\nLanguage: "+navigator.language+"\n\n"+a.details;e.rating=a.rating;e.feedback=u;c.sendAppFeedback(b.authenticationToken,e,function(a){console.log(a)},function(a){log.error("problem sending app feedback: Error code "+a.errorCode+"\n"+a)})}else log.error("logged out while filing a support ticket")})},
fileSupportTicket:function(a,b,c){g.isAuthenticated(function(a){if(a)var b=new LogReader(function(){b.startExportLogs(function(b){var c=options.get("secureProto")+m.get("serviceHost"),c=new Thrift.BinaryHttpTransport(c+"/shard/"+a.shardId+"/utility"),c=new Thrift.BinaryProtocol(c),c=new UtilityClient(c),e=new SupportTicket;e.applicationVersion=Browser.EVERNOTE_VERSION;e.contactEmail=g.getUserInfo(a.userId).email;var f=GlobalUtils.generateSystemInfo();e.osInfo=f.os;e.deviceInfo=f.browser;e.logFile=
new Data;e.logFile.body=b;e.subject="Clipping Error in Web Clipper";e.issueDescription="(This was automatically created by the Clipper when the user encountered an error during clipping. Please forward to the development team.)";c.fileSupportTicket(a.authenticationToken,e,function(){},function(a){log.error("problem filing support ticket: Error code "+a.errorCode+"\n"+a)})},"arraybuffer")});else log.error("was not logged in when trying to file a support ticket")})},generateSecret:function(a,b,c){b&&
b.tab&&Browser.sendToTab(b.tab,{name:"receiveSecret",secret:UUID.generateGuid(),for:a.for})},clipPdfFromTooltip:function(a,b,c){O(b.tab)},showAlert:function(a,b,c){alert(a.msg)},determineSalesforcePromoEligibility:function(a,b,c){a=g.getCurrentUser();c=g.getUserInfo();if(a&&!/china/i.test(m.getName())&&!c.bizAuthenticationToken){var d=a%10;if(1<=d&&4>=d){var e=Persistent.get("promo_salesforce");e||(e={});e[a]||(e[a]=0);11>e[a]&&(0==e[a]%5?(Persistent.set("promo_salesforce",e),Browser.sendToTab(b.tab,
{name:"isEligibleForSalesforcePromo",design:2>=d?"A":"B",userType:c.premium?"premium":"free"})):(e[a]++,Persistent.set("promo_salesforce",e)))}}},addToSalesforceCounter:function(a,b,c){if(b=g.getCurrentUser())c=Persistent.get("promo_salesforce"),c[b]+=a.inc,Persistent.set("promo_salesforce",c)},checkInactivityPeriod:function(a,b,c){a=(a=g.getCurrentUser())?a:"unauthed";(c=Persistent.get("lastActiveTimes"))&&c[a]&&5>c[a].count&&c[a].time+216E7<=new Date&&Browser.sendToTab(b.tab,{name:"nudgeInactiveUser",
locale:S("name"),authed:"unauthed"===a?!1:!0})},updateLastActiveTime:function(a,b,c){a=Persistent.get("lastActiveTimes");b=(b=g.getCurrentUser())?b:"unauthed";a[b].time=(new Date).getTime();a.unauthed.time=a[b].time;a[b].count++;Persistent.set("lastActiveTimes",a)}});this.setOption=function(a,b){options.set(a,b)};this.getOption=function(a){return options.get(a)};this.getBootstrapInfo=S;this.getBootstrapInfoLength=ha;this.start=function(){(new Bootstrapper(options.get("simulateSimplifiedChinese"),
options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(Z)};this.startUp=Z;this.bootstrap=function(a){(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(function(){try{m=new BootstrapInfo(options.get("overrideServiceURL")),a&&a()}catch(b){log.error(b)}})};this.showLoggedInState=U;this.showLoggedOutState=la;this.msgHandlerIsAuthenticated=na;this.msgHandlerLogin=
function(a,b,c){g.login(a.username,a.password,function(a){a.error||(a.bizAuthenticationToken&&!Persistent.get(a.userId+"_turnedOffSearchHelper")&&options.set("useSearchHelper",!0),a.username&&(Browser.setBrowserActionClickHandler(function(a){E(null,{tab:a})}),Browser.setPopup("")));Browser.getCurrentTab(function(b){a.currentTab=b;c(a)})})};this.msgHandlerSubmitTwoStepCode=function(a,b,c){g.completeTwoFactorAuthentication(a.auth,a.code,function(a){a.error||(Browser.setBrowserActionClickHandler(function(a){E(null,
{tab:a})}),Browser.setPopup(""));Browser.getCurrentTab(function(b){a.currentTab=b;c(a)})})};this.msgHandlerGetRegistrationLinks=function(a,b,c){a="clipper_chr";SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX&&(a="clipper_yan");b=new FormData;b.append("code",a);var d=new XMLHttpRequest;d.open("POST",options.get("secureProto")+m.get("serviceHost")+"/CreateUserJSON.action?",!0);d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var a=JSON.parse(d.response);c({captcha:a.captcha,submit:a.submit})}else 0==
d.status?(log.error("couldn't get registration form links because of network error"),c({error:"NETWORK"})):4==d.readyState&&log.error("couldn't get registration form links because of error: "+d.status)};d.send(b)};this.switchService=function(a,b,c){1<m.getLength()&&(a=m.getIndex(),m.setIndex((a+1)%2),c())};this.msgHandlerLogout=V;this.msgHandlerOpenTab=oa;this.msgHandlerOpenWindow=pa;this.msgHandlerRestart=ma;this.msgHandlerRecordActivity=qa;this.toggleClipper=E;Object.preventExtensions(this)}Object.preventExtensions(Extension);
var extension=new Extension;extension.start();
